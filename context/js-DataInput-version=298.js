/* Minification failed. Returning unminified contents.
(6390,94-95): run-time error JS1195: Expected expression: >
(6393,71-72): run-time error JS1195: Expected expression: >
(6400,58-59): run-time error JS1195: Expected expression: >
(6473,46-47): run-time error JS1195: Expected expression: )
(6474,43-47): run-time error JS1100: Expected ',': else
(6481,33-34): run-time error JS1002: Syntax error: }
(6488,29-30): run-time error JS1002: Syntax error: }
(6496,17-18): run-time error JS1002: Syntax error: }
(6499,66-67): run-time error JS1195: Expected expression: )
(6499,68-69): run-time error JS1004: Expected ';': {
(6502,86-87): run-time error JS1195: Expected expression: >
(6505,63-64): run-time error JS1195: Expected expression: >
(6514,50-51): run-time error JS1195: Expected expression: >
(6534,38-39): run-time error JS1195: Expected expression: )
(6541,26-27): run-time error JS1195: Expected expression: )
(6546,18-19): run-time error JS1195: Expected expression: )
(6547,14-15): run-time error JS1195: Expected expression: )
(6549,75-76): run-time error JS1195: Expected expression: )
(6549,77-78): run-time error JS1004: Expected ';': {
(6550,86-87): run-time error JS1195: Expected expression: >
(6553,63-64): run-time error JS1195: Expected expression: >
(6553,65-66): run-time error JS1197: Too many errors. The file might not be a JavaScript file: {
 */
/* Simple JavaScript Inheritance
 * By John Resig http://ejohn.org/
 * MIT Licensed.
 */
// Inspired by base2 and Prototype
(function(){
	var initializing = false;

	// The base JQClass implementation (does nothing)
	window.JQClass = function(){};

	// Collection of derived classes
	JQClass.classes = {};
 
	// Create a new JQClass that inherits from this class
	JQClass.extend = function extender(prop) {
		var base = this.prototype;

		// Instantiate a base class (but only create the instance,
		// don't run the init constructor)
		initializing = true;
		var prototype = new this();
		initializing = false;

		// Copy the properties over onto the new prototype
		for (var name in prop) {
			// Check if we're overwriting an existing function
			prototype[name] = typeof prop[name] == 'function' &&
				typeof base[name] == 'function' ?
				(function(name, fn){
					return function() {
						var __super = this._super;

						// Add a new ._super() method that is the same method
						// but on the super-class
						this._super = function(args) {
							return base[name].apply(this, args || []);
						};

						var ret = fn.apply(this, arguments);				

						// The method only need to be bound temporarily, so we
						// remove it when we're done executing
						this._super = __super;

						return ret;
					};
				})(name, prop[name]) :
				prop[name];
		}

		// The dummy class constructor
		function JQClass() {
			// All construction is actually done in the init method
			if (!initializing && this._init) {
				this._init.apply(this, arguments);
			}
		}

		// Populate our constructed prototype object
		JQClass.prototype = prototype;

		// Enforce the constructor to be what we expect
		JQClass.prototype.constructor = JQClass;

		// And make this class extendable
		JQClass.extend = extender;

		return JQClass;
	};
})();

(function($) { // Ensure $, encapsulate

	/** Abstract base class for collection plugins v1.0.1.
		Written by Keith Wood (kbwood{at}iinet.com.au) December 2013.
		Licensed under the MIT (https://github.com/jquery/jquery/blob/master/MIT-LICENSE.txt) license.
		@module $.JQPlugin
		@abstract */
	JQClass.classes.JQPlugin = JQClass.extend({

		/** Name to identify this plugin.
			@example name: 'tabs' */
		name: 'plugin',

		/** Default options for instances of this plugin (default: {}).
			@example defaultOptions: {
 	selectedClass: 'selected',
 	triggers: 'click'
 } */
		defaultOptions: {},
		
		/** Options dependent on the locale.
			Indexed by language and (optional) country code, with '' denoting the default language (English/US).
			@example regionalOptions: {
	'': {
		greeting: 'Hi'
	}
 } */
		regionalOptions: {},
		
		/** Names of getter methods - those that can't be chained (default: []).
			@example _getters: ['activeTab'] */
		_getters: [],

		/** Retrieve a marker class for affected elements.
			@private
			@return {string} The marker class. */
		_getMarker: function() {
			return 'is-' + this.name;
		},
		
		/** Initialise the plugin.
			Create the jQuery bridge - plugin name <code>xyz</code>
			produces <code>$.xyz</code> and <code>$.fn.xyz</code>. */
		_init: function() {
			// Apply default localisations
			$.extend(this.defaultOptions, (this.regionalOptions && this.regionalOptions['']) || {});
			// Camel-case the name
			var jqName = camelCase(this.name);
			// Expose jQuery singleton manager
			$[jqName] = this;
			// Expose jQuery collection plugin
			$.fn[jqName] = function(options) {
				var otherArgs = Array.prototype.slice.call(arguments, 1);
				if ($[jqName]._isNotChained(options, otherArgs)) {
					return $[jqName][options].apply($[jqName], [this[0]].concat(otherArgs));
				}
				return this.each(function() {
					if (typeof options === 'string') {
						if (options[0] === '_' || !$[jqName][options]) {
							throw 'Unknown method: ' + options;
						}
						$[jqName][options].apply($[jqName], [this].concat(otherArgs));
					}
					else {
						$[jqName]._attach(this, options);
					}
				});
			};
		},

		/** Set default values for all subsequent instances.
			@param options {object} The new default options.
			@example $.plugin.setDefauls({name: value}) */
		setDefaults: function(options) {
			$.extend(this.defaultOptions, options || {});
		},
		
		/** Determine whether a method is a getter and doesn't permit chaining.
			@private
			@param name {string} The method name.
			@param otherArgs {any[]} Any other arguments for the method.
			@return {boolean} True if this method is a getter, false otherwise. */
		_isNotChained: function(name, otherArgs) {
			if (name === 'option' && (otherArgs.length === 0 ||
					(otherArgs.length === 1 && typeof otherArgs[0] === 'string'))) {
				return true;
			}
			return $.inArray(name, this._getters) > -1;
		},
		
		/** Initialise an element. Called internally only.
			Adds an instance object as data named for the plugin.
			@param elem {Element} The element to enhance.
			@param options {object} Overriding settings. */
		_attach: function(elem, options) {
			elem = $(elem);
			if (elem.hasClass(this._getMarker())) {
				return;
			}
			elem.addClass(this._getMarker());
			options = $.extend({}, this.defaultOptions, this._getMetadata(elem), options || {});
			var inst = $.extend({name: this.name, elem: elem, options: options},
				this._instSettings(elem, options));
			elem.data(this.name, inst); // Save instance against element
			this._postAttach(elem, inst);
			this.option(elem, options);
		},

		/** Retrieve additional instance settings.
			Override this in a sub-class to provide extra settings.
			@param elem {jQuery} The current jQuery element.
			@param options {object} The instance options.
			@return {object} Any extra instance values.
			@example _instSettings: function(elem, options) {
 	return {nav: elem.find(options.navSelector)};
 } */
		_instSettings: function(elem, options) {
			return {};
		},

		/** Plugin specific post initialisation.
			Override this in a sub-class to perform extra activities.
			@param elem {jQuery} The current jQuery element.
			@param inst {object} The instance settings.
			@example _postAttach: function(elem, inst) {
 	elem.on('click.' + this.name, function() {
 		...
 	});
 } */
		_postAttach: function(elem, inst) {
		},

		/** Retrieve metadata configuration from the element.
			Metadata is specified as an attribute:
			<code>data-&lt;plugin name>="&lt;setting name>: '&lt;value>', ..."</code>.
			Dates should be specified as strings in this format: 'new Date(y, m-1, d)'.
			@private
			@param elem {jQuery} The source element.
			@return {object} The inline configuration or {}. */
		_getMetadata: function(elem) {
			try {
				var data = elem.data(this.name.toLowerCase()) || '';
				data = data.replace(/'/g, '"');
				data = data.replace(/([a-zA-Z0-9]+):/g, function(match, group, i) { 
					var count = data.substring(0, i).match(/"/g); // Handle embedded ':'
					return (!count || count.length % 2 === 0 ? '"' + group + '":' : group + ':');
				});
				data = $.parseJSON('{' + data + '}');
				for (var name in data) { // Convert dates
					var value = data[name];
					if (typeof value === 'string' && value.match(/^new Date\((.*)\)$/)) {
						data[name] = eval(value);
					}
				}
				return data;
			}
			catch (e) {
				return {};
			}
		},

		/** Retrieve the instance data for element.
			@param elem {Element} The source element.
			@return {object} The instance data or {}. */
		_getInst: function(elem) {
			return $(elem).data(this.name) || {};
		},
		
		/** Retrieve or reconfigure the settings for a plugin.
			@param elem {Element} The source element.
			@param name {object|string} The collection of new option values or the name of a single option.
			@param [value] {any} The value for a single named option.
			@return {any|object} If retrieving a single value or all options.
			@example $(selector).plugin('option', 'name', value)
 $(selector).plugin('option', {name: value, ...})
 var value = $(selector).plugin('option', 'name')
 var options = $(selector).plugin('option') */
		option: function(elem, name, value) {
			elem = $(elem);
			var inst = elem.data(this.name);
			if  (!name || (typeof name === 'string' && value == null)) {
				var options = (inst || {}).options;
				return (options && name ? options[name] : options);
			}
			if (!elem.hasClass(this._getMarker())) {
				return;
			}
			var options = name || {};
			if (typeof name === 'string') {
				options = {};
				options[name] = value;
			}
			this._optionsChanged(elem, inst, options);
			$.extend(inst.options, options);
		},
		
		/** Plugin specific options processing.
			Old value available in <code>inst.options[name]</code>, new value in <code>options[name]</code>.
			Override this in a sub-class to perform extra activities.
			@param elem {jQuery} The current jQuery element.
			@param inst {object} The instance settings.
			@param options {object} The new options.
			@example _optionsChanged: function(elem, inst, options) {
 	if (options.name != inst.options.name) {
 		elem.removeClass(inst.options.name).addClass(options.name);
 	}
 } */
		_optionsChanged: function(elem, inst, options) {
		},
		
		/** Remove all trace of the plugin.
			Override <code>_preDestroy</code> for plugin-specific processing.
			@param elem {Element} The source element.
			@example $(selector).plugin('destroy') */
		destroy: function(elem) {
			elem = $(elem);
			if (!elem.hasClass(this._getMarker())) {
				return;
			}
			this._preDestroy(elem, this._getInst(elem));
			elem.removeData(this.name).removeClass(this._getMarker());
		},

		/** Plugin specific pre destruction.
			Override this in a sub-class to perform extra activities and undo everything that was
			done in the <code>_postAttach</code> or <code>_optionsChanged</code> functions.
			@param elem {jQuery} The current jQuery element.
			@param inst {object} The instance settings.
			@example _preDestroy: function(elem, inst) {
 	elem.off('.' + this.name);
 } */
		_preDestroy: function(elem, inst) {
		}
	});
	
	/** Convert names from hyphenated to camel-case.
		@private
		@param value {string} The original hyphenated name.
		@return {string} The camel-case version. */
	function camelCase(name) {
		return name.replace(/-([a-z])/g, function(match, group) {
			return group.toUpperCase();
		});
	}
	
	/** Expose the plugin base.
		@namespace "$.JQPlugin" */
	$.JQPlugin = {
	
		/** Create a new collection plugin.
			@memberof "$.JQPlugin"
			@param [superClass='JQPlugin'] {string} The name of the parent class to inherit from.
			@param overrides {object} The property/function overrides for the new class.
			@example $.JQPlugin.createPlugin({
 	name: 'tabs',
 	defaultOptions: {selectedClass: 'selected'},
 	_initSettings: function(elem, options) { return {...}; },
 	_postAttach: function(elem, inst) { ... }
 }); */
		createPlugin: function(superClass, overrides) {
			if (typeof superClass === 'object') {
				overrides = superClass;
				superClass = 'JQPlugin';
			}
			superClass = camelCase(superClass);
			var className = camelCase(overrides.name);
			JQClass.classes[className] = JQClass.classes[superClass].extend(overrides);
			new JQClass.classes[className]();
		}
	};

})(jQuery);;
/* http://keith-wood.name/calculator.html
   Calculator field entry extension for jQuery v2.0.1.
   Written by Keith Wood (kbwood{at}iinet.com.au) October 2008.
   Licensed under the MIT (https://github.com/jquery/jquery/blob/master/MIT-LICENSE.txt) licence. 
   Please attribute the author if you use it. */

(function ($) { // hide the namespace

    var pluginName = 'calculator';

    var layoutStandard = ['  BSCECA', '_1_2_3_+@X', '_4_5_6_-@U', '_7_8_9_*@E', '_0_._=_/'];

    var digit = 'd';
    var binary = 'b';
    var unary = 'u';
    var control = 'c';
    var space = 's';

    /** Create the calculator plugin.
		<p>Sets an input field to popup a calculator for arithmetic computations.</p>
		<p>Expects HTML like:</p>
		<pre>&lt;input type="text"></pre>
		<p>Provide inline configuration like:</p>
		<pre>&lt;input type="text" data-calculator="name: 'value'"/></pre>
	 	@module Calculator
		@augments JQPlugin
		@example $(selector).calculator() */
    $.JQPlugin.createPlugin({

        /** The name of the plugin. */
        name: pluginName,

        /** Calculator is operator callback.
			Triggered when determining which keystrokes popup the calculator.
			@callback isOperatorCallback
			@param ch {string} The character just type.
			@param event {Event} The keystroke event.
			@param value {string} The current field value.
			@param base {number} The number base currently in use.
			@param decimalChar {string} The character used to denote the decimal point.
			@return {boolean} <code>true</code> if this character is an operator, <code>false</code> if not.
			@example isOperator: function(ch, event, value, base, decimalChar) {
	return '+-/*'.indexOf(ch) > -1;
} */

        /** Calculator open callback.
			Triggered when the popup calculator opens.
			@callback openCallback
			@param value {string} The current field value.
			@param inst {object} The current instance settings. */

        /** Calculator button callback.
			Triggered when a button in the calculator is clicked.
			@callback buttonCallback
			@param label {string} The label from the clicked button.
			@param value {string} The current field value.
			@param inst {object} The current instance settings. */

        /** Calculator close callback.
			Triggered when the popup calculator closes.
			@callback closeCallback
			@param value {string} The current field value.
			@param inst {object} The current instance settings. */

        /** Calculator math callback.
			Triggered when a button is clicked to activate the underlying maths.
			@callback mathCallback
			@param inst {object} The current instance settings.
			@param label {string} The button label.
			@example function add(inst) {
	inst.curValue = inst.prevValue + inst.curValue;
} */

        /** Default settings for the plugin.
			@property [showOn='focus'] {string} When to display the calculator:
					'focus' for popup on focus, 'button' for trigger button,
					'both' for either, 'operator' for non-numeric character entered,
					'opbutton' for operator/button combination.
			@property [buttonImage=''] {string} The URL for the trigger button image.
			@property [buttonImageOnly=false] {boolean} <code>true</code> if the image appears alone, <code>false</code> if it appears on a button.
			@property [isOperator=$.calculator.isOperator] {operatorCallback} Call back function to determine if a keystroke opens the calculator.
			@property [showAnim='show'] {string} The name of jQuery animation for popup.
			@property [showOptions={}] {object} Any options for enhanced animations.
			@property [duration='normal'] {string|number} The duration of display/closure (ms).
			@property [appendText=''] {string} Any display text following the input box, e.g. showing the format.
			@property [useThemeRoller=false] {boolean} <code>true</code> to add ThemeRoller classes.
			@property [calculatorClass=''] {string} Any additional CSS class for the calculator for an instance.
			@property [showFormula=false] {boolean} <code>true</code> to display formula as it's entered, <code>false</code> to hide it.
			@property [prompt=''] {string} Text across the top of the calculator.
			@property [layout=['  BSCECA', '_1_2_3_+@X', '_4_5_6_-@U', '_7_8_9_*@E', '_0_._=_/']] {string[]} The layout of keys by row.
			@property [value=0] {number} The initial value for inline calculators.
			@property [base=10] {number} The numeric base for calculations.
			@property [precision=10] {number} The number of digits of precision to use in rounding for display.
			@property [memoryAsCookie=false] {boolean} <code>true</code> to save memory into cookie, <code>false</code> for memory only.
			@property [cookieName='calculatorMemory'] {string} The name of cookie for memory.
			@property [cookieExpires=24 * 60 * 60] {Date|number} The time that the memory cookie expires as a Date or number of seconds.
			@property [cookiePath=''] {string} The path for the memory cookie.
			@property [useDegrees=false] {boolean} <code>true</code> to use degress for trigonometric functions, <code>false</code> for radians.
			@property [constrainInput=true] {boolean} <code>true</code> to restrict typed characters to numerics, <code>false</code> to allow anything.
			@property [onOpen=null] {openCallback} Define a callback function before the panel is opened.
			@property [onButton=null] {buttonCallback} Define a callback function when a button is activated.
			@property [onClose=null] {closeCallback} Define a callback function when the panel is closed. */
        defaultOptions: {
            showOn: 'focus',
            buttonImage: '',
            buttonImageOnly: false,
            isOperator: null,
            showAnim: 'show',
            showOptions: {},
            duration: 'normal',
            appendText: '',
            useThemeRoller: false,
            calculatorClass: '',
            showFormula: false,
            prompt: '',
            layout: layoutStandard,
            value: 0,
            base: 10,
            precision: 10,
            memoryAsCookie: false,
            cookieName: 'calculatorMemory',
            cookieExpires: 24 * 60 * 60,
            cookiePath: '',
            useDegrees: false,
            constrainInput: true,
            onOpen: null,
            onButton: null,
            onClose: null,
            customDecimalPlaces: 2,
            triggerInputChange: 0
        },

        /** Localisations for the plugin.
			Entries are objects indexed by the language code ('' being the default US/English).
			Each object has the following attributes.
			@property [decimalChar='.'] {string} Character for the decimal point.
			@property [buttonText='...'] {string} Display text for trigger button.
			@property [buttonStatus='Open the calculator'] {string} Status text for trigger button.
			@property [closeText='Close'] {string} Display text for close link.
			@property [closeStatus='Close the calculator'] {string} Status text for close link.
			@property [useText='Use'] {string} Display text for use link.
			@property [useStatus='Use the current value'] {string} Status text for use link.
			@property [eraseText='Erase'] {string} Display text for erase link.
			@property [eraseStatus='Erase the value from the field'] {string} Status text for erase link.
			@property [backspaceText='BS'] {string} Display text for backspace link.
			@property [backspaceStatus='Erase the last digit'] {string} Status text for backspace link.
			@property [clearErrorText='CE'] {string} Display text for clear error link.
			@property [clearErrorStatus='Erase the last number'] {string} Status text for clear error link.
			@property [clearText='CA'] {string} Display text for clear link.
			@property [clearStatus='Reset the calculator'] {string} Status text for clear link.
			@property [memClearText='MC'] {string} Display text for memory clear link.
			@property [memClearStatus='Clear the memory'] {string} Status text for memory clear link.
			@property [memRecallText='MR'] {string} Display text for memory recall link.
			@property [memRecallStatus='Recall the value from memory'] {string} Status text for memory recall link.
			@property [memStoreText='MS'] {string} Display text for memory store link.
			@property [memStoreStatus='Store the value in memory'] {string} Status text for memory store link.
			@property [memAddText='M+'] {string} Display text for memory add link.
			@property [memAddStatus='Add to memory'] {string} Status text for memory add link.
			@property [memSubtractText='M-'] {string} Display text for memory subtract link.
			@property [memSubtractStatus='Subtract from memory'] {string} Status text for memory subtract link.
			@property [base2Text='Bin'] {string} Display text for base 2 link.
			@property [base2Status='Switch to binary'] {string} Status text for base 2 link.
			@property [base8Text='Oct'] {string} Display text for base 8 link.
			@property [base8Status='Switch to octal'] {string} Status text for base 8 link.
			@property [base10Text='Dec'] {string} Display text for base 10 link.
			@property [base10Status='Switch to decimal'] {string} Status text for base 10 link.
			@property [base16Text='Hex'] {string} Display text for base 16 link.
			@property [base16Status='Switch to hexadecimal'] {string} Status text for base 16 link.
			@property [degreesText='Deg'] {string} Display text for degrees link.
			@property [degreesStatus='Switch to degrees'] {string} Status text for degrees link.
			@property [radiansText='Rad'] {string} Display text for radians link.
			@property [radiansStatus='Switch to radians'] {string} Status text for radians link.
			@property [isRTL=false] {boolean} <code>true</code> if right-to-left language, <code>false</code> if left-to-right. */
        regionalOptions: { // Available regional settings, indexed by language/country code
            '': { // Default regional settings - English/US
                decimalChar: '.',
                buttonText: '...',
                buttonStatus: 'Open the calculator',
                closeText: 'Close',
                closeStatus: 'Close the calculator',
                useText: 'Use',
                useStatus: 'Use the current value',
                eraseText: 'Erase',
                eraseStatus: 'Erase the value from the field',
                backspaceText: 'BS',
                backspaceStatus: 'Erase the last digit',
                clearErrorText: 'CE',
                clearErrorStatus: 'Erase the last number',
                clearText: 'CA',
                clearStatus: 'Reset the calculator',
                memClearText: 'MC',
                memClearStatus: 'Clear the memory',
                memRecallText: 'MR',
                memRecallStatus: 'Recall the value from memory',
                memStoreText: 'MS',
                memStoreStatus: 'Store the value in memory',
                memAddText: 'M+',
                memAddStatus: 'Add to memory',
                memSubtractText: 'M-',
                memSubtractStatus: 'Subtract from memory',
                base2Text: 'Bin',
                base2Status: 'Switch to binary',
                base8Text: 'Oct',
                base8Status: 'Switch to octal',
                base10Text: 'Dec',
                base10Status: 'Switch to decimal',
                base16Text: 'Hex',
                base16Status: 'Switch to hexadecimal',
                degreesText: 'Deg',
                degreesStatus: 'Switch to degrees',
                radiansText: 'Rad',
                radiansStatus: 'Switch to radians',
                isRTL: false
            }
        },

        /** Names of getter methods - those that can't be chained. */
        _getters: ['isDisabled'],

        _curInst: null, // The current instance in use
        _disabledFields: [], // List of calculator inputs that have been disabled
        _showingCalculator: false, // True if the popup panel is showing , false if not
        _showingKeystrokes: false, // True if showing keystrokes for calculator buttons

        /* The definitions of the buttons that may appear on the calculator.
           Key is ID. Fields are display text, button type, function,
           class(es), field name, keystroke, keystroke name. */
        _keyDefs: {},

        /** Indicator of a digit key.
			For use with <code>addKeyDef</code>. */
        digit: digit,
        /** Indicator of a binary operation key.
			For use with <code>addKeyDef</code>. */
        binary: binary,
        /** Indicator of a unary operation key.
			For use with <code>addKeyDef</code>. */
        unary: unary,
        /** Indicator of a control key.
			For use with <code>addKeyDef</code>. */
        control: control,
        /** Indicator of a space.
			For use with <code>addKeyDef</code>. */
        space: space,

        _mainDivClass: pluginName + '-popup', // The name of the main calculator division marker class
        _inlineClass: pluginName + '-inline', // The name of the inline marker class
        _appendClass: pluginName + '-append', // The name of the appended text marker class
        _triggerClass: pluginName + '-trigger', // The name of the trigger marker class
        _disableClass: pluginName + '-disabled', // The name of the disabled covering marker class
        _inlineEntryClass: pluginName + '-keyentry', // The name of the inline entry marker class
        _promptClass: pluginName + '-prompt', // The name of the prompt marker class
        _formulaClass: pluginName + '-formula', // The name of the formula marker class
        _resultClass: pluginName + '-result', // The name of the calculator result marker class
        _focussedClass: pluginName + '-focussed', // The name of the focussed marker class
        _keystrokeClass: pluginName + '-keystroke', // The name of the keystroke marker class
        _rtlClass: pluginName + '-rtl', // The name of the right-to-left marker class
        _rowClass: pluginName + '-row', // The name of the row marker class
        _ctrlClass: pluginName + '-ctrl', // The name of the control key marker class
        _baseActiveClass: pluginName + '-base-active', // The name of the active base marker class
        _angleActiveClass: pluginName + '-angle-active', // The name of the active angle marker class
        _digitClass: pluginName + '-digit', // The name of the digit key marker class
        _operatorClass: pluginName + '-oper', // The name of the operator key marker class
        _memEmptyClass: pluginName + '-mem-empty', // The name of the memory empty marker class
        _keyNameClass: pluginName + '-keyname', // The name of the key name marker class
        _keyDownClass: pluginName + '-key-down', // The name of the key down marker class
        _keyStrokeClass: pluginName + '-keystroke', // The name of the key stroke marker class

        /** The standard calculator layout with simple operations. */
        standardLayout: layoutStandard,
        /** The extended calculator layout with common scientific operations. */
        scientificLayout: ['@X@U@E  BSCECA', 'DGRD    _ MC_ _7_8_9_+', 'SNASSRLG_ MR_ _4_5_6_-',
			'CSACSQLN_ MS_ _1_2_3_*', 'TNATXYEX_ M+_ _0_.+-_/', 'PIRN1X  _ M-_   _%_='],

        /** Add a new key definition.
			@param code {string} The two-character code for this key.
			@param label {string} The display label for this key. If the label starts with '#' the corresponding
					<code>regionalOptions</code> 'xxxText' is used instead to allow for localisation.
			@param type {boolean|string} <code>true</code> if this is a binary operator, <code>false</code> if a unary operator,
					or key type - use constants (<code>$.calculator.</code>) <code>digit</code>,
					<code>binary</code>, <code>unary</code>, <code>space</code>, <code>control</code>.
			@param func {mathCallback} The function that applies this key -
					it is expected to take a parameter of the current instance.
			@param [style] {string} Any additional CSS styles for this key.
			@param [constant] {string} The name of a constant to create for this key.
			@param keystroke {string|number} The character or key code of the keystroke for this key.
			@param keyName {string} The name of the keystroke for this key.
			@return {object} The calculator object for chaining further calls.
			@example $.calculator.addKeyDef('BO', '#base8', $.calculator.control, $.calculator._base8, 'base base8', 'BASE_8', 'C'); */
        addKeyDef: function (code, label, type, func, style, constant, keystroke, keyName) {
            this._keyDefs[code] = [label, (typeof type === 'boolean' ? (type ? this.binary : this.unary) : type),
				func, style, constant, keystroke, keyName];
            if (constant) {
                this[constant] = code;
            }
            if (keystroke) {
                if (typeof keystroke === 'number') {
                    this._keyCodes[keystroke] = code;
                }
                else {
                    this._keyChars[keystroke] = code;
                }
            }
            return this;
        },

        /** Additional setup for the calculator.
			Create popup div. */
        _init: function () {
            this.mainDiv = $('<div class="' + this._mainDivClass + '" style="display: none;"></div>').
				on('click.' + pluginName, this._focusEntry);
            this._keyCodes = {};
            this._keyChars = {};
            this._super();
        },

        _instSettings: function (elem, options) {
            var inline = elem[0].nodeName.toLowerCase() !== 'input';
            var keyEntry = (!inline ? elem :
			$('<input type="text" class="' + this._inlineEntryClass + '"/>'));
            return {
                _input: keyEntry, _inline: inline, memory: 0,
                _mainDiv: (inline ? $('<div class="' + this._inlineClass + '"></div>') : this.mainDiv)
            };
        },

        _postAttach: function (elem, inst) {
            if (inst.options.memoryAsCookie) {
                var memory = this._getMemoryCookie(inst);
                if (memory && !isNaN(memory)) {
                    inst.memory = memory;
                }
            }
            if (!inst._inline && elem.is(':disabled')) {
                this.disable(elem[0]);
            }
        },

        _optionsChanged: function (elem, inst, options) {
            $.extend(inst.options, options);
            if (this._curInst === inst) {
                this.hide();
            }
            elem.empty().off('.' + inst.name).
				siblings('.' + this._appendClass).remove().end().
				siblings('.' + this._triggerClass).remove().end().
				prev('.' + this._inlineEntryClass).remove();
            if (inst.options.appendText) {
                elem[inst.options.isRTL ? 'before' : 'after'](
					'<span class="' + this._appendClass + '">' + inst.options.appendText + '</span>');
            }
            if (!inst._inline) {
                if (inst.options.showOn === 'focus' || inst.options.showOn === 'both') {
                    // pop-up calculator when in the marked field
                    elem.on('focus.' + inst.name, this.show);
                }
                if (inst.options.showOn === 'button' || inst.options.showOn === 'both' ||
						inst.options.showOn === 'opbutton') {
                    // pop-up calculator when button clicked
                    var trigger = $(inst.options.buttonImageOnly ?
						$('<img/>').attr({
						    src: inst.options.buttonImage,
						    alt: inst.options.buttonStatus, title: inst.options.buttonStatus
						}) :
						$('<button type="button" title="' + inst.options.buttonStatus + '"></button>').
							html(inst.options.buttonImage === '' ? inst.options.buttonText :
							$('<img/>').attr({ src: inst.options.buttonImage })));
                    elem[inst.options.isRTL ? 'before' : 'after'](trigger);
                    trigger.addClass(this._triggerClass).on('click.' + inst.name, function () {
                        if (plugin._showingCalculator && plugin._lastInput === elem[0]) {
                            plugin.hide();
                        }
                        else {
                            plugin.show(elem[0]);
                        }
                        return false;
                    });
                }
            }
            inst._input.on('keydown.' + inst.name, this._doKeyDown).
				on('keyup.' + inst.name, this._doKeyUp).
				on('keypress.' + inst.name, this._doKeyPress);
            if (inst._inline) {
                elem.append(inst._input).append(inst._mainDiv).
					on('click.' + inst.name, function () { inst._input.focus(); });
                this._reset(inst, '0');
                this._setValue(inst);
                this._updateCalculator(inst);
                inst._mainDiv.on('keydown.' + inst.name, this._doKeyDown).
					on('keyup.' + inst.name, this._doKeyUp).
					on('keypress.' + inst.name, this._doKeyPress);
                inst._input.on('focus.' + inst.name, function () {
                    if (!plugin.isDisabled(elem[0])) {
                        inst._focussed = true;
                        $('.' + plugin._resultClass, inst._mainDiv).
							addClass(plugin._focussedClass);
                    }
                }).on('blur.' + inst.name, function () {
                    inst._focussed = false;
                    $('.' + plugin._resultClass, inst._mainDiv).
						removeClass(plugin._focussedClass);
                });
            }
            elem.addClass(this._getMarker()).
				on('setData.' + inst.name, function (event, key, value) {
				    inst.options[key] = value;
				}).
				on('getData.' + inst.name, function (event, key) {
				    return inst.options[key];
				}).
				data(inst.name, inst);
            inst._input.data(inst.name, inst);
            if (inst._inline) {
                this._setValue(inst);
            }
            this._updateCalculator(inst);
        },

        _preDestroy: function (elem, inst) {
            inst._input.off('.' + inst.name).removeData(inst.name);
            elem.empty().off('.' + inst.name).
			siblings('.' + this._appendClass).remove().end().
			siblings('.' + this._triggerClass).remove().end().
			prev('.' + this._inlineEntryClass).remove();
        },

        /** Enable the calculator for a jQuery selection.
			@param elem {Element} The target input field or division/span.
			@example $(selector).calculator('enable'); */
        enable: function (elem) {
            elem = $(elem);
            if (!elem.hasClass(this._getMarker())) {
                return;
            }
            var nodeName = elem[0].nodeName.toLowerCase();
            if (nodeName === 'input') {
                elem.prop('disabled', false).siblings('button.' + this._triggerClass).prop('disabled', false).end().
					siblings('img.' + this._triggerClass).css({ opacity: '1.0', cursor: '' });
            }
            else if (nodeName === 'div' || nodeName === 'span') {
                elem.find('.' + this._inlineEntryClass + ',button').prop('disabled', false).end().
					children('.' + this._disableClass).remove();
            }
            this._disabledFields = $.map(this._disabledFields,
				function (value) { return (value === elem[0] ? null : value); }); // delete entry
        },

        /** Disable the calculator for a jQuery selection.
			@param elem {Element} The target input field or division/span.
			@example $(selector).calculator('disable'); */
        disable: function (elem) {
            elem = $(elem);
            if (!elem.hasClass(this._getMarker())) {
                return;
            }
            var nodeName = elem[0].nodeName.toLowerCase();
            if (nodeName === 'input') {
                elem.prop('disabled', true).siblings('button.' + this._triggerClass).prop('disabled', true).end().
					siblings('img.' + this._triggerClass).css({ opacity: '0.5', cursor: 'default' });
            }
            else if (nodeName === 'div' || nodeName === 'span') {
                var inline = elem.children('.' + this._inlineClass);
                var offset = inline.offset();
                var relOffset = { left: 0, top: 0 };
                inline.parents().each(function () {
                    if ($(this).css('position') === 'relative') {
                        relOffset = $(this).offset();
                        return false;
                    }
                });
                elem.find('.' + this._inlineEntryClass + ',button').prop('disabled', true);
                if (elem.find('.' + this._disableClass).length === 0) {
                    elem.prepend('<div class="' + this._disableClass + '" style="width: ' +
						inline.outerWidth() + 'px; height: ' + inline.outerHeight() +
						'px; left: ' + (offset.left - relOffset.left) +
						'px; top: ' + (offset.top - relOffset.top) + 'px;"></div>');
                }
            }
            this._disabledFields = $.map(this._disabledFields,
				function (value) { return (value === elem[0] ? null : value); }); // delete entry
            this._disabledFields[this._disabledFields.length] = elem[0];
        },

        /** Is the input field or division/span disabled as a calculator?
			@param elem {Element} the target control.
			@return {boolean} <code>true</code> if disabled, <code>false</code> if enabled.
			@example if ($(selector).calculator('isDisabled')) {...} */
        isDisabled: function (elem) {
            return (elem && $.inArray(elem, this._disabledFields) > -1);
        },

        /** Pop-up the calculator for a given input field or division/span.
			@param input {Element|Event} The control attached to the calculator or the triggering event.
			@example $(selector).calculator('show'); */
        show: function (input) {
            input = input.target || input;
            if (plugin.isDisabled(input) || plugin._lastInput === input) { // already here
                return;
            }
            var inst = plugin._getInst(input);
            plugin.hide(null, '');
            plugin._lastInput = input;
            plugin._pos = plugin._findPos(input);
            plugin._pos[1] += input.offsetHeight; // add the height
            var isFixed = false;
            $(input).parents().each(function () {
                isFixed |= $(this).css('position') === 'fixed';
                return !isFixed;
            });
            var offset = { left: plugin._pos[0], top: plugin._pos[1] };
            plugin._pos = null;
            // determine sizing offscreen
            inst._mainDiv.css({ position: 'absolute', display: 'block', top: '-1000px', width: 'auto' });
            // callback before calculator opening		
            if ($.isFunction(inst.options.onOpen)) {
                inst.options.onOpen.apply((inst._input ? inst._input[0] : null),  // trigger custom callback
					[(inst._inline ? inst.curValue : inst._input.val()), inst]);
            }
            plugin._reset(inst, inst._input.val().replace(/\,/g, ''));
            plugin._updateCalculator(inst);
            // and adjust position before showing
            offset = plugin._checkOffset(inst, offset, isFixed);
            inst._mainDiv.css({
                position: (isFixed ? 'fixed' : 'absolute'), display: 'none',
                left: offset.left + 'px', top: offset.top + 'px'
            });
            var duration = inst.options.duration;
            duration = (duration == 'normal' && $.ui &&
				parseInt($.ui.version.substring(2)) >= 8 ? '_default' : duration);
            var postProcess = function () {
                plugin._showingCalculator = true;
            };
            if ($.effects && ($.effects[inst.options.showAnim] ||
					($.effects.effect && $.effects.effect[inst.options.showAnim]))) {
                var data = inst._mainDiv.data(); // Update old effects data
                for (var key in data) {
                    if (key.match(/^ec\.storage\./)) {
                        data[key] = inst._mainDiv.css(key.replace(/ec\.storage\./, ''));
                    }
                }
                inst._mainDiv.data(data).show(inst.options.showAnim,
					inst.options.showOptions, duration, postProcess);
            }
            else {
                inst._mainDiv[inst.options.showAnim || 'show']((inst.options.showAnim ? duration : null), postProcess);
            }
            if (!inst.options.showAnim) {
                postProcess();
            }
            if (inst._input[0].type !== 'hidden') {
                inst._input[0].focus();
            }
            plugin._curInst = inst;
        },

        /** Reinitialise the calculator.
			@private
			@param inst {object} The instance settings.
			@param value {number} The starting value. */
        _reset: function (inst, value) {
            value = '' + (value || 0);
            value = (inst.options.decimalChar !== '.' ?
				value.replace(new RegExp(inst.options.decimalChar), '.') : value);
            inst.curValue = (inst.options.base === 10 ? parseFloat(value) : parseInt(value, inst.options.base)) || 0;
            inst.dispValue = this._setDisplay(inst);
            inst.prevValue = inst._savedValue = 0;
            inst._pendingOp = inst._savedOp = this._noOp;
            inst._formula = '';
            inst._newValue = true;
        },

        /** Retrieve the memory value from a cookie, if any.
			@private
			@param inst {object} The instance settings.
			@return {number} The memory cookie value or NaN/null if unavailable. */
        _getMemoryCookie: function (inst) {
            var re = new RegExp('^.*' + inst.options.cookieName + '=([^;]*).*$');
            return parseFloat(document.cookie.replace(re, '$1'));
        },

        /** Save the memory value as a cookie.
			@private
			@param inst {object} The instance settings. */
        _setMemoryCookie: function (inst) {
            if (!inst.options.memoryAsCookie) {
                return;
            }
            var expires = inst.options.cookieExpires;
            if (typeof expires === 'number') {
                var time = new Date();
                time.setTime(time.getTime() + expires * 1000);
                expires = time.toUTCString();
            }
            else if (expires.constructor === Date) {
                expires = time.toUTCString();
            }
            else {
                expires = '';
            }
            document.cookie = inst.options.cookieName + '=' + inst.memory +
				'; expires=' + expires + '; path=' + inst.options.cookiePath;
        },

        /** Set the initial value for display.
			@private
			@param inst {object} The instance settings. */
        _setValue: function (inst) {
            inst.curValue = inst.options.value || 0;
            inst.dispValue = this._setDisplay(inst);
        },

        /** Generate the calculator content.
			@private
			@param inst {object} The instance settings. */
        _updateCalculator: function (inst) {
            var borders = this._getBorders(inst._mainDiv);
            inst._mainDiv.html(this._generateHTML(inst)).removeClass().
				addClass(inst.options.calculatorClass +
					(inst.options.useThemeRoller ? ' ui-widget ui-widget-content' : '') +
					(inst.options.isRTL ? ' ' + plugin._rtlClass : '') + ' ' +
					(inst._inline ? this._inlineClass : this._mainDivClass));
            if (this.isDisabled(inst.elem[0])) {
                this.disable(inst.elem[0]);
            }
            if (this._curInst === inst) {
                inst._input.focus();
            }
        },

        /** Retrieve the size of left and top borders for an element.
			@private
			@param elem {jQuery} The element of interest.
			@return {number[]} The left and top borders. */
        _getBorders: function (elem) {
            var convert = function (value) {
                return { thin: 1, medium: 3, thick: 5 }[value] || value;
            };
            return [parseFloat(convert(elem.css('border-left-width'))),
				parseFloat(convert(elem.css('border-top-width')))];
        },

        /** Check positioning to remain on screen.
			@private
			@param inst {object} The instance settings.
			@param offset {object} The current offset.
			@param isFixed {boolean} <code>true</code> if the input field is fixed in position.
			@return {object} The updated offset. */
        _checkOffset: function (inst, offset, isFixed) {
            var pos = inst._input ? this._findPos(inst._input[0]) : null;
            var browserWidth = window.innerWidth || document.documentElement.clientWidth;
            var browserHeight = window.innerHeight || document.documentElement.clientHeight;
            var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
            var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
            // reposition calculator panel horizontally if outside the browser window
            if (inst.options.isRTL || (offset.left + inst._mainDiv.outerWidth() - scrollX) > browserWidth) {
                offset.left = Math.max((isFixed ? 0 : scrollX),
					pos[0] + (inst._input ? inst._input.outerWidth() : 0) -
					(isFixed ? scrollX : 0) - inst._mainDiv.outerWidth());
            }
            else {
                offset.left = Math.max((isFixed ? 0 : scrollX), offset.left - (isFixed ? scrollX : 0));
            }
            // reposition calculator panel vertically if outside the browser window
            if ((offset.top + inst._mainDiv.outerHeight() - scrollY) > browserHeight) {
                offset.top = Math.max((isFixed ? 0 : scrollY),
					pos[1] - (isFixed ? scrollY : 0) - inst._mainDiv.outerHeight());
            }
            else {
                offset.top = Math.max((isFixed ? 0 : scrollY), offset.top - (isFixed ? scrollY : 0));
            }
            return offset;
        },

        /** Find an object's position on the screen.
			@private
			@param obj {Element} The element to find the position for.
			@return {number[]} The element's position. */
        _findPos: function (obj) {
            while (obj && (obj.type === 'hidden' || obj.nodeType !== 1)) {
                obj = obj.nextSibling;
            }
            var position = $(obj).offset();
            return [position.left, position.top];
        },

        /** Hide the calculator from view.
			@param input {Element} The control attached to the calculator.
			@param duration {string} The duration over which to close the calculator.
			@example $(selector).calculator('hide'); */
        hide: function (input, duration) {
            var inst = this._curInst;
            if (!inst || (input && inst !== plugin._getInst(input))) {
                return;
            }
            if (this._showingCalculator) {
                duration = (duration != null ? duration : inst.options.duration);
                duration = (duration === 'normal' && $.ui &&
					parseInt($.ui.version.substring(2)) >= 8 ? '_default' : duration);
                if ($.effects && ($.effects[inst.options.showAnim] ||
						($.effects.effect && $.effects.effect[inst.options.showAnim]))) {
                    inst._mainDiv.hide(inst.options.showAnim, inst.options.showOptions, duration);
                }
                else {
                    inst._mainDiv[(inst.options.showAnim === 'slideDown' ? 'slideUp' :
						(inst.options.showAnim === 'fadeIn' ? 'fadeOut' : 'hide'))](
							inst.options.showAnim ? duration : null);
                }
            }
            if ($.isFunction(inst.options.onClose)) {
                inst.options.onClose.apply((inst._input ? inst._input[0] : null),  // trigger custom callback
					[(inst._inline ? inst.curValue : inst._input.val()), inst]);
            }
            if (this._showingCalculator) {
                this._showingCalculator = false;
                this._lastInput = null;
            }
            this._curInst = null;
        },

        /** Close calculator if clicked elsewhere.
			@private
			@param event {Event} The mouseclick details. */
        _checkExternalClick: function (event) {
            if (!plugin._curInst) {
                return;
            }
            var target = $(event.target);
            if (!target.parents().andSelf().hasClass(plugin._mainDivClass) && !target.hasClass(plugin._getMarker()) &&
					!target.parents().andSelf().hasClass(plugin._triggerClass) && plugin._showingCalculator) {
                plugin.hide();
            }
        },

        _highlightText: function (event) {
            if (event.target.type == "text" && !(event.target.classList.contains("readonlyTxt"))) {
                $(event.target)[0].setSelectionRange(0, $(event.target).val().length);
            }
        },

        /** Focus back onto the input field.
			@private */
        _focusEntry: function () {
            if (plugin._curInst && plugin._curInst._input) {
                plugin._curInst._input.focus();
            }
        },

        /** Handle keystrokes.
			@private
			@param e {Event} The key event. */
        _doKeyDown: function (e) {

            if ($(e.target).is('[readonly]')) {                
                e.preventDefault();
                e.stopPropagation();

                return false;
            }

            var key = e.keyCode || e.which;
            var handled = false;
            var inst = plugin._getInst(e.target);
            var div = (inst && inst._inline ? $(e.target).parent()[0] : null);

            if (key == 110) { // . sign
                if ($(e.target)[0].value.length != 0 && $(e.target)[0].selectionStart == 0 && $(e.target)[0].selectionEnd == $(e.target)[0].value.length) {
                    $(e.target).val(".");
                    $(e.target)[0].setSelectionRange(1, 1);
                }
            }

            if (key == 109 || key == 189) { // - sign
                if ($(e.target)[0].value.length != 0 && $(e.target)[0].selectionStart == 0 && $(e.target)[0].selectionEnd == $(e.target)[0].value.length) {
                    $(e.target).val("-");
                    $(e.target)[0].setSelectionRange(1, 1);
                }
            }

            if ((key >= 96 && key <= 105) || (key >= 48 && key <= 57)) { // for all numbers
                if ($(e.target)[0].value.length != 0 && $(e.target)[0].selectionStart == 0 && $(e.target)[0].selectionEnd == $(e.target)[0].value.length) {
                    $(e.target).val("");
                    $(e.target)[0].setSelectionRange(1, 1);
                }
            }

            if (key === 9) { // tab
                plugin.mainDiv.stop(true, true);
                plugin.hide();
                if (inst && inst._inline) {
                    inst._input.blur();
                }
            }
            else if (plugin._showingCalculator || (div && !plugin.isDisabled(div))) {
                if (key === 18) { // alt - show keystrokes
                    if (!plugin._showingKeystrokes) {
                        inst._mainDiv.find('.' + plugin._keystrokeClass).show();
                        plugin._showingKeystrokes = true;
                    }
                    handled = true;
                }
                else {
                    var code = plugin._keyCodes[key];
                    if (code) {
                        $('button[data-keystroke="' + code + '"]', inst._mainDiv).not(':disabled').click();
                        handled = true;
                    }
                }
            }
            else if (key === 36 && e.ctrlKey && inst && !inst._inline) {
                plugin.show(this); // display the date picker on ctrl+home
            }
            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
            return !handled;
        },

        /** Hide keystrokes, if showing.
			@private
			@param e {Event} The key event. */
        _doKeyUp: function (e) {
            if (plugin._showingKeystrokes) {
                var inst = plugin._getInst(e.target);
                inst._mainDiv.find('.' + plugin._keystrokeClass).hide();
                plugin._showingKeystrokes = false;
            }

            var inst = plugin._getInst(e.target);
            plugin._AddZeroBeforeDecimal(inst._input);
        },

        /** Convert characters into button clicks.
			@private
			@param e {Event} The key event.
			@return {boolean} <code>true</code> if keystroke allowed, <code>false</code> if not. */
        _doKeyPress: function (e) {
            var pos = plugin._getCursorPosition(e.target);
            var inst = plugin._getInst(e.target);
            if (!inst) {
                return true;
            }

            if (plugin._hideCalcOnMinus(inst._input)) {
                return true;
            }

            var div = (inst && inst._inline ? $(e.target).parent()[0] : null);
            var ch = String.fromCharCode(e.charCode === undefined ? e.keyCode || e.which : e.charCode);
            var isOperator = inst.options.isOperator || plugin.isOperator;

            if (!plugin._showingCalculator && !div &&
					(inst.options.showOn === 'operator' || inst.options.showOn === 'opbutton') &&
					isOperator.apply(inst._input,
						[ch, e, inst._input.val(), inst.options.base, inst.options.decimalChar])) {
                plugin.show(this); // display the date picker on operator usage
                plugin._showingCalculator = true;
            }
            if (plugin._showingCalculator || (div && !plugin.isDisabled(div))) {
                var code = plugin._keyChars[ch === inst.options.decimalChar ? '.' : ch];
                if (code) {
                    $('button[data-keystroke="' + code + '"]', inst._mainDiv).not(':disabled').click();
                }
                return false;
            }
            if (ch >= ' ' && inst.options.constrainInput) {
                var pattern = new RegExp('^-?' +
					(inst.options.base === 10 ? '[0-9]*(\\' + inst.options.decimalChar + '[0-9]*)?' :
					'[' + '0123456789abcdef'.substring(0, inst.options.base) + ']*') + '$');
                //added by Himanshu to handle "-" sign in between the number
                //if(ch == '-')
                //return ((inst._input.val().substring(0, pos) + ch + inst._input.val().substring(pos, inst._input.val().length)).replace(/\,/g, '')).toLowerCase().match(pattern) != null;
                var inputVal = inst._input.val().slice(0, inst._input[0].selectionStart) + inst._input.val().slice(inst._input[0].selectionEnd);
                return ((inputVal.substring(0, pos) + ch + inputVal.substring(pos, inputVal.length)).replace(/\,/g, '')).toLowerCase().match(pattern) != null;
                //else 
                    //return (inst._input.val().replace(/\,/g, '') + ch).toLowerCase().match(pattern) != null;
            }
            return true;
        },

        /** Determine whether or not a keystroke is a trigger for opening the calculator.
			@param ch {string} The current character.
			@param event {KeyEvent} The entire key event.
			@param value {string} The current input value.
			@param base {number} The current number base.
			@param decimalChar {string} The current decimal character.
			@return {boolean} <code>true</code> if a trigger, <code>false</code> if not. */
        isOperator: function (ch, event, value, base, decimalChar) {
            //return ch > ' ' && !(ch === '-' && value === '') &&
			//	('0123456789abcdef'.substr(0, base) + '.' + decimalChar).indexOf(ch.toLowerCase()) === -1;
            return ch > ' ' && ch === '=' &&
              ('0123456789abcdef'.substr(0, base) + '.' + decimalChar).indexOf(ch.toLowerCase()) === -1;
        },

        // added by ankit
        _hideCalcOnMinus: function (input) {
            //var obj = document.getElementById($(input).attr('id'));
            var obj = $(input);
            if (typeof obj.selectionStart == "number") {
                return (obj.selectionStart == 0 && obj.selectionEnd == obj.value.length) || (obj.selectionStart == 0 && obj.selectionStart == obj.selectionEnd)
            } else if (typeof document.selection != "undefined") {
                obj.focus();
                //return document.selection.createRange().text == obj.value;
                return false;
            }
        },

        _AddZeroBeforeDecimal: function (input) {
            var currstr = $(input).val();
            if (currstr.length > 0 && currstr.substring(0, 1) == ".") {
                $(input).val("0" + currstr);
            }
        },

        _getCursorPosition: function (element) {
            var pos = 0;
            var el = $(element).get(0);
            // IE Support
            if (document.selection) {
                el.focus();
                var Sel = document.selection.createRange();
                var SelLength = document.selection.createRange().text.length;
                Sel.moveStart('character', -el.value.length);
                pos = Sel.text.length - SelLength;
            }
                // Firefox support
            else if (el.selectionStart || el.selectionStart == '0')
                pos = el.selectionStart;
            return pos;
        },

        /** Generate the HTML for the current state of the calculator.
			@private
			@param inst {object} The instance settings.
			@return {string} The HTML for this calculator. */
        _generateHTML: function (inst) {
            var html = (!inst.options.prompt ? '' : '<div class="' + this._promptClass +
				(inst.options.useThemeRoller ? ' ui-widget-header ui-corner-all' : '') + '">' +
				inst.options.prompt + '</div>') + '<div class="' + this._resultClass +
				(inst.options.useThemeRoller ? ' ui-widget-header' : '') +
				(inst._focussed ? ' ' + this._focussedClass : '') + '">' +
				(inst.options.showFormula ?
				'<span class="' + this._formulaClass + '">' + inst._formula + '</span>' : '') +
				'<span>' + inst.dispValue + '</span></div>';
            for (var i = 0; i < inst.options.layout.length; i++) {
                html += '<div class="' + this._rowClass + '">';
                for (var j = 0; j < inst.options.layout[i].length; j += 2) {
                    var code = inst.options.layout[i].substr(j, 2);
                    var def = this._keyDefs[code] || this._keyDefs['??'];
                    var label = (def[0].charAt(0) === '#' ? inst.options[def[0].substr(1) + 'Text'] : def[0]);
                    var status = (def[0].charAt(0) === '#' ? inst.options[def[0].substr(1) + 'Status'] : '');
                    var styles = (def[3] ? def[3].split(' ') : []);
                    for (var k = 0; k < styles.length; k++) {
                        styles[k] = inst.name + '-' + styles[k];
                    }
                    styles = styles.join(' ');
                    var uiActive = (inst.options.useThemeRoller ? ' ui-state-active' : '');
                    var uiHighlight = (inst.options.useThemeRoller ? ' ui-state-highlight' : '');
                    html += (def[1] === this.space ? '<span class="' + inst.name + '-' + def[3] + '"></span>' :
						(inst._inline && (def[2] === '._close' || def[2] === '._erase') ? '' :
						'<button type="button" data-keystroke="' + code + '"' +
						// Control buttons
						(def[1] === this.control ? ' class="' + this._ctrlClass +
						(def[0].match(/^#base/) ? (def[0].replace(/^#base/, '') === inst.options.base ?
						uiActive || ' ' + this._baseActiveClass : uiHighlight) :
						(def[0] === '#degrees' ? (inst.options.useDegrees ?
						uiActive || ' ' + this._angleActiveClass : uiHighlight) :
						(def[0] === '#radians' ? (!inst.options.useDegrees ?
						uiActive || ' ' + this._angleActiveClass : uiHighlight) : uiHighlight))) :
						// Digits
						(def[1] === this.digit ? (parseInt(def[0], 16) >= inst.options.base ||
						(inst.options.base !== 10 && def[0] === '.') ?
						' disabled="disabled"' : '') + ' class="' + this._digitClass :
						// Binary operations
						(def[1] === this.binary ? ' class="' + this._operatorClass :
						// Unary operations
						' class="' + this._operatorClass +
						(def[0].match(/^#mem(Clear|Recall)$/) && !inst.memory ?
						' ' + this._memEmptyClass : '')))) +
						// Common
						(inst.options.useThemeRoller ? ' ui-state-default' : '') +
						(styles ? ' ' + styles : '') + '" ' +
						(status ? 'title="' + status + '"' : '') + '>' +
						(code === '_.' ? inst.options.decimalChar : label) +
						// Keystrokes
						(def[5] && def[5] !== def[0] ? '<span class="' + this._keystrokeClass +
						(inst.options.useThemeRoller ? ' ui-state-error' : '') +
						(def[6] ? ' ' + this._keyNameClass : '') + '">' + (def[6] || def[5]) + '</span>' : '') +
						'</button>'));
                }
                html += '</div>';
            }
            html += '<div style="clear: both;"></div>';
            html = $(html);
            html.find('button').on('mouseover.' + inst.name, function () {
                plugin._saveClasses = this.className;
            }).
				on('mousedown.' + inst.name, function () {
				    $(this).addClass(this._keyDownClass + (inst.options.useThemeRoller ? ' ui-state-active' : ''));
				}).
				on('mouseup.' + inst.name, function () {
				    $(this).removeClass().addClass(plugin._saveClasses);
				}).
				on('mouseout.' + inst.name, function () {
				    $(this).removeClass().addClass(plugin._saveClasses);
				}).
				on('click.' + inst.name, function () {
				    plugin._handleButton(inst, $(this));
				});
            return html;
        },

        /** Generate the display value.
			Tidy the result to avoid JavaScript rounding errors.
			@private
			@param  inst   (object) the instance settings
			@return  (string) the rounded and formatted display value */
        _setDisplay: function (inst) {
            var fixed = new Number(inst.curValue).toFixed(inst.options.precision).valueOf(); // Round to specified precision
            var exp = fixed.replace(/^.+(e.+)$/, '$1').replace(/^[^e].*$/, ''); // Extract exponent
            if (exp) {
                fixed = new Number(fixed.replace(/e.+$/, '')).toFixed(inst.options.precision).valueOf(); // Round mantissa
            }
            return parseFloat(fixed.replace(/0+$/, '') + exp). // Recombine
				toString(inst.options.base).toUpperCase().replace(/\./, inst.options.decimalChar);
        },

        /** Send notification of a button activation.
			@private
			@param inst {object} The instance settings.
			@param label {string} The label from the button. */
        _sendButton: function (inst, label) {
            if ($.isFunction(inst.options.onButton)) {
                inst.options.onButton.apply((inst._input ? inst._input[0] : null),
					[label, inst.dispValue, inst]);  // trigger custom callback
            }
        },

        /** Handle a button press.
			@private
			@param inst {object} The current instance settings.
			@param button {jQuery} The button pressed. */
        _handleButton: function (inst, button) {
            var keyDef = this._keyDefs[button.data('keystroke')];
            if (!keyDef) {
                return;
            }
            var label = button.text().substr(0, button.text().length -
				button.children('.' + this._keyStrokeClass).text().length);
            switch (keyDef[1]) {
                case this.control:
                    keyDef[2].apply(this, [inst, label]); break;
                case this.digit:
                    this._digit(inst, label); break;
                case this.binary:
                    this._binaryOp(inst, keyDef[2], label); break;
                case this.unary:
                    this._unaryOp(inst, keyDef[2], label); break;
            }
            if (plugin._showingCalculator || inst._inline) {
                inst._input.focus();
            }
        },

        /** Do nothing.
			@private */
        _noOp: function (inst) {
        },

        /** Add a digit to the number in the calculator.
			@private
			@param inst {object} The instance settings.
			@param digit {string} The digit to append. */
        _digit: function (inst, digit) {
            inst.dispValue = (inst._newValue ? '' : inst.dispValue);
            if (digit === inst.options.decimalChar && inst.dispValue.indexOf(digit) > -1) {
                return;
            }
            inst.dispValue = (inst.dispValue + digit).replace(/^0(\d)/, '$1').
				replace(new RegExp('^(-?)([\\.' + inst.options.decimalChar + '])'), '$10$2');
            inst._formula += digit;
            if (inst.options.decimalChar !== '.') {
                inst.dispValue = inst.dispValue.replace(new RegExp('^' + inst.options.decimalChar), '0.');
            }
            var value = (inst.options.decimalChar !== '.' ?
				inst.dispValue.replace(new RegExp(inst.options.decimalChar), '.') : inst.dispValue);
            inst.curValue = (inst.options.base === 10 ? parseFloat(value) : parseInt(value, inst.options.base));
            inst._newValue = false;
            this._sendButton(inst, digit);
            this._updateCalculator(inst);
        },

        /** Save a binary operation for later use.
			@private
			@param inst {object} The instance settings.
			@param op {function} The binary function.
			@param label {string} The button label. */
        _binaryOp: function (inst, op, label) {
            if (!inst._newValue && inst._pendingOp) {
                inst._pendingOp(inst);
                inst.curValue = (inst.options.base === 10 ? inst.curValue : Math.floor(inst.curValue));
                inst.dispValue = this._setDisplay(inst);
            }
            inst.prevValue = inst.curValue;
            inst._newValue = true;
            inst._pendingOp = op;
            inst._formula = inst._formula.replace(/\D$/, '') + label;
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        _add: function (inst) {
            inst.curValue = inst.prevValue + inst.curValue;
        },

        _subtract: function (inst) {
            inst.curValue = inst.prevValue - inst.curValue;
        },

        _multiply: function (inst) {
            inst.curValue = inst.prevValue * inst.curValue;
        },

        _divide: function (inst) {
            inst.curValue = inst.prevValue / inst.curValue;
        },

        _power: function (inst) {
            inst.curValue = Math.pow(inst.prevValue, inst.curValue);
        },

        /** Apply a unary operation to the calculator.
			@private
			@param inst {object} The instance settings.
			@param op {function} The unary function.
			@param label {string} The button label. */
        _unaryOp: function (inst, op, label) {
            inst._newValue = true;
            op.apply(this, [inst]);
            inst.curValue = (inst.options.base === 10 ? inst.curValue : Math.floor(inst.curValue));
            inst.dispValue = this._setDisplay(inst);
            inst._formula += (label === '=' ? '' : ' ' + label + ' ');
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        _plusMinus: function (inst) {
            inst.curValue = -1 * inst.curValue;
            inst.dispValue = this._setDisplay(inst);
            inst._newValue = false;
        },

        _pi: function (inst) {
            inst.curValue = Math.PI;
        },

        /** Perform a percentage calculation.
			@private
			@param inst {object} The instance settings. */
        _percent: function (inst) {
            if (inst._pendingOp === this._add) {
                inst.curValue = inst.prevValue * (1 + inst.curValue / 100);
            }
            else if (inst._pendingOp === this._subtract) {
                inst.curValue = inst.prevValue * (1 - inst.curValue / 100);
            }
            else if (inst._pendingOp === this._multiply) {
                inst.curValue = inst.prevValue * inst.curValue / 100;
            }
            else if (inst._pendingOp === this._divide) {
                inst.curValue = inst.prevValue / inst.curValue * 100;
            }
            inst._savedOp = inst._pendingOp;
            inst._pendingOp = this._noOp;
        },

        /** Apply a pending binary operation.
			@private
			@param inst {object} The instance settings. */
        _equals: function (inst) {
            if (inst._pendingOp === this._noOp) {
                if (inst._savedOp !== this._noOp) {
                    // Following x op y =: =, z =
                    inst.prevValue = inst.curValue;
                    inst.curValue = inst._savedValue;
                    inst._savedOp(inst);
                }
            }
            else {
                // Normal: x op y =
                inst._savedOp = inst._pendingOp;
                inst._savedValue = inst.curValue;
                inst._pendingOp(inst);
                inst._pendingOp = this._noOp;
            }
            inst._formula = '';
        },

        _memAdd: function (inst) {
            inst.memory += inst.curValue;
            this._setMemoryCookie(inst);
        },

        _memSubtract: function (inst) {
            inst.memory -= inst.curValue;
            this._setMemoryCookie(inst);
        },

        _memStore: function (inst) {
            inst.memory = inst.curValue;
            this._setMemoryCookie(inst);
        },

        _memRecall: function (inst) {
            inst.curValue = inst.memory;
        },

        _memClear: function (inst) {
            inst.memory = 0;
            this._setMemoryCookie(inst);
        },

        _sin: function (inst) {
            this._trig(inst, Math.sin);
        },

        _cos: function (inst) {
            this._trig(inst, Math.cos);
        },

        _tan: function (inst) {
            this._trig(inst, Math.tan);
        },

        _trig: function (inst, op, label) {
            inst.curValue = op(inst.curValue * (inst.options.useDegrees ? Math.PI / 180 : 1));
        },

        _asin: function (inst) {
            this._atrig(inst, Math.asin);
        },

        _acos: function (inst) {
            this._atrig(inst, Math.acos);
        },

        _atan: function (inst) {
            this._atrig(inst, Math.atan);
        },

        _atrig: function (inst, op, label) {
            inst.curValue = op(inst.curValue);
            if (inst.options.useDegrees) {
                inst.curValue = inst.curValue / Math.PI * 180;
            }
        },

        _inverse: function (inst) {
            inst.curValue = 1 / inst.curValue;
        },

        _log: function (inst) {
            inst.curValue = Math.log(inst.curValue) / Math.log(10);
        },

        _ln: function (inst) {
            inst.curValue = Math.log(inst.curValue);
        },

        _exp: function (inst) {
            inst.curValue = Math.exp(inst.curValue);
        },

        _sqr: function (inst) {
            inst.curValue *= inst.curValue;
        },

        _sqrt: function (inst) {
            inst.curValue = Math.sqrt(inst.curValue);
        },

        _random: function (inst) {
            inst.curValue = Math.random();
        },

        _base2: function (inst, label) {
            this._changeBase(inst, label, 2);
        },

        _base8: function (inst, label) {
            this._changeBase(inst, label, 8);
        },

        _base10: function (inst, label) {
            this._changeBase(inst, label, 10);
        },

        _base16: function (inst, label) {
            this._changeBase(inst, label, 16);
        },

        /** Change the number base for the calculator.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label.
			@param newBase {number} The new number base. */
        _changeBase: function (inst, label, newBase) {
            inst.options.base = newBase;
            inst.curValue = (newBase === 10 ? inst.curValue : Math.floor(inst.curValue));
            inst.dispValue = this._setDisplay(inst);
            inst._newValue = true;
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        _degrees: function (inst, label) {
            this._degreesRadians(inst, label, true);
        },

        _radians: function (inst, label) {
            this._degreesRadians(inst, label, false);
        },

        /** Swap between degrees and radians for trigonometric functions.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label.
			@param useDegrees {boolean} <code>true</code> to use degrees, <code>false</code> for radians. */
        _degreesRadians: function (inst, label, useDegrees) {
            inst.options.useDegrees = useDegrees;
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        /** Erase the last digit entered.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label. */
        _undo: function (inst, label) {
            inst.dispValue = inst.dispValue.substr(0, inst.dispValue.length - 1) || '0';
            inst.curValue = (inst.options.base === 10 ?
				parseFloat(inst.dispValue) : parseInt(inst.dispValue, inst.options.base));
            inst._formula = inst._formula.replace(/[\.\d]$/, '');
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        /** Erase the last number entered.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label. */
        _clearError: function (inst, label) {
            inst.dispValue = '0';
            inst.curValue = 0;
            inst._formula = inst._formula.replace(/[\.\d]+$/, '');
            inst._newValue = true;
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        /** Reset the calculator.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label. */
        _clear: function (inst, label) {
            this._reset(inst, 0);
            this._sendButton(inst, label);
            this._updateCalculator(inst);
        },

        /** Close the calculator without changing the value.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label. */
        _close: function (inst, label) {
            this._finished(inst, label, inst._input.val().replace(/\,/g, ''));
        },

        /** Copy the current value and close the calculator.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label. */
        _use: function (inst, label) {
            if (inst._pendingOp !== this._noOp) {
                this._unaryOp(inst, this._equals, label);
            }
            this._finished(inst, label, inst.dispValue);
        },

        /** Erase the field and close the calculator.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label. */
        _erase: function (inst, label) {
            this._reset(inst, 0);
            this._updateCalculator(inst);
            this._finished(inst, label, '');
        },

        /** Finish with the calculator.
			@private
			@param inst {object} The instance settings.
			@param label {string} The button label.
			@param value {string} The new field value. */
        _finished: function (inst, label, value) {
            if (inst._inline) {
                this._curInst = inst;
            }
            else {
                inst._input.val(Math.round(value * Math.pow(10, inst.options.customDecimalPlaces)) / Math.pow(10, inst.options.customDecimalPlaces));
                //BD-815 | himanshu | to trigger amortized-period on input function so that the periods textboxes are enabled/disabled accordingly
                if (inst._input[0].classList.contains('amortize-period')) {
                    inst._input.trigger("input");
                }
                if (inst.options.triggerInputChange == 1) {
                    inst._input.trigger("change");
                }
            }
            this._sendButton(inst, label);
            this.hide(inst._input[0]);
        }
    });

    var plugin = $.calculator;

    /* The definitions of the buttons that may appear on the calculator.
	   Fields are ID, display text, button type, function,
	   class(es), field name, keystroke, keystroke name. */
    var defaultKeys = [
		['_0', '0', plugin.digit, null, '', '0', '0'],
		['_1', '1', plugin.digit, null, '', '1', '1'],
		['_2', '2', plugin.digit, null, '', '2', '2'],
		['_3', '3', plugin.digit, null, '', '3', '3'],
		['_4', '4', plugin.digit, null, '', '4', '4'],
		['_5', '5', plugin.digit, null, '', '5', '5'],
		['_6', '6', plugin.digit, null, '', '6', '6'],
		['_7', '7', plugin.digit, null, '', '7', '7'],
		['_8', '8', plugin.digit, null, '', '8', '8'],
		['_9', '9', plugin.digit, null, '', '9', '9'],
		['_A', 'A', plugin.digit, null, 'hex-digit', 'A', 'a'],
		['_B', 'B', plugin.digit, null, 'hex-digit', 'B', 'b'],
		['_C', 'C', plugin.digit, null, 'hex-digit', 'C', 'c'],
		['_D', 'D', plugin.digit, null, 'hex-digit', 'D', 'd'],
		['_E', 'E', plugin.digit, null, 'hex-digit', 'E', 'e'],
		['_F', 'F', plugin.digit, null, 'hex-digit', 'F', 'f'],
		['_.', '.', plugin.digit, null, 'decimal', 'DECIMAL', '.'],
		['_+', '+', plugin.binary, plugin._add, 'arith add', 'ADD', '+'],
		['_-', '-', plugin.binary, plugin._subtract, 'arith subtract', 'SUBTRACT', '-'],
		['_*', '*', plugin.binary, plugin._multiply, 'arith multiply', 'MULTIPLY', '*'],
		['_/', '/', plugin.binary, plugin._divide, 'arith divide', 'DIVIDE', '/'],
		['_%', '%', plugin.unary, plugin._percent, 'arith percent', 'PERCENT', '%'],
		['_=', '=', plugin.unary, plugin._equals, 'arith equals', 'EQUALS', '='],
		['+-', '', plugin.unary, plugin._plusMinus, 'arith plus-minus', 'PLUS_MINUS', '#'],
		['PI', '', plugin.unary, plugin._pi, 'pi', 'PI', 'p'],
		['1X', '1/x', plugin.unary, plugin._inverse, 'fn inverse', 'INV', 'i'],
		['LG', 'log', plugin.unary, plugin._log, 'fn log', 'LOG', 'l'],
		['LN', 'ln', plugin.unary, plugin._ln, 'fn ln', 'LN', 'n'],
		['EX', 'e', plugin.unary, plugin._exp, 'fn exp', 'EXP', 'E'],
		['SQ', 'x', plugin.unary, plugin._sqr, 'fn sqr', 'SQR', '@'],
		['SR', '', plugin.unary, plugin._sqrt, 'fn sqrt', 'SQRT', '!'],
		['XY', 'x^y', plugin.binary, plugin._power, 'fn power', 'POWER', '^'],
		['RN', 'rnd', plugin.unary, plugin._random, 'random', 'RANDOM', '?'],
		['SN', 'sin', plugin.unary, plugin._sin, 'trig sin', 'SIN', 's'],
		['CS', 'cos', plugin.unary, plugin._cos, 'trig cos', 'COS', 'o'],
		['TN', 'tan', plugin.unary, plugin._tan, 'trig tan', 'TAN', 't'],
		['AS', 'asin', plugin.unary, plugin._asin, 'trig asin', 'ASIN', 'S'],
		['AC', 'acos', plugin.unary, plugin._acos, 'trig acos', 'ACOS', 'O'],
		['AT', 'atan', plugin.unary, plugin._atan, 'trig atan', 'ATAN', 'T'],
		['MC', '#memClear', plugin.unary, plugin._memClear, 'memory mem-clear', 'MEM_CLEAR', 'x'],
		['MR', '#memRecall', plugin.unary, plugin._memRecall, 'memory mem-recall', 'MEM_RECALL', 'r'],
		['MS', '#memStore', plugin.unary, plugin._memStore, 'memory mem-store', 'MEM_STORE', 'm'],
		['M+', '#memAdd', plugin.unary, plugin._memAdd, 'memory mem-add', 'MEM_ADD', '>'],
		['M-', '#memSubtract', plugin.unary, plugin._memSubtract, 'memory mem-subtract', 'MEM_SUBTRACT', '<'],
		['BB', '#base2', plugin.control, plugin._base2, 'base base2', 'BASE_2', 'B'],
		['BO', '#base8', plugin.control, plugin._base8, 'base base8', 'BASE_8', 'C'],
		['BD', '#base10', plugin.control, plugin._base10, 'base base10', 'BASE_10', 'D'],
		['BH', '#base16', plugin.control, plugin._base16, 'base base16', 'BASE_16', 'H'],
		['DG', '#degrees', plugin.control, plugin._degrees, 'angle degrees', 'DEGREES', 'G'],
		['RD', '#radians', plugin.control, plugin._radians, 'angle radians', 'RADIANS', 'R'],
		['BS', '#backspace', plugin.control, plugin._undo, 'undo', 'UNDO', 8, 'BSp'], // backspace
		['CE', '#clearError', plugin.control, plugin._clearError, 'clear-error', 'CLEAR_ERROR', 36, 'Hom'], // home
		['CA', '#clear', plugin.control, plugin._clear, 'clear', 'CLEAR', 35, 'End'], // end
		['@X', '#close', plugin.control, plugin._close, 'close', 'CLOSE', 27, 'Esc'], // escape
		['@U', '#use', plugin.control, plugin._use, 'use', 'USE', 13, 'Ent'], // enter
		['@E', '#erase', plugin.control, plugin._erase, 'erase', 'ERASE', 46, 'Del'], // delete
		['  ', '', plugin.space, null, 'space', 'SPACE'],
		['_ ', '', plugin.space, null, 'half-space', 'HALF_SPACE'],
		['??', '??', plugin.unary, plugin._noOp]
    ];

    // Initialise the key definitions
    $.each(defaultKeys, function (i, keyDef) {
        plugin.addKeyDef.apply(plugin, keyDef);
    });

    // Add the calculator division and external click check
    $(function () {
        $('body').append(plugin.mainDiv).on('mousedown.' + pluginName, plugin._checkExternalClick);

        $('body').on('focus', '[type=text]', plugin._highlightText);

        $(document).on('keydown', 'table.table.budgets-table tr td input, table.table.empPayroll-table tr td input, table.table.empFormulaGrowthPercent tr td input, table.table.empPayrollHeadcount-table tr td input', function (e) {
            var $input = $(this);

            if (e.which == 39 && !(e.ctrlKey || e.metaKey)) {   
                //BD-954|saurabh|fixed navigation via right arrow key
                //$input = $(this).closest('td').nextAll('td').has('[type=text]:eq(0)').find('input');
                $input = $(this).closest('td').nextAll('td').has('[type=text]').eq(0).find('input');
                $($input).focus(10, function () {
                    plugin._highlightText;
                });
            }
            else if (e.which == 37) {
                //BD-954|saurabh|fixed navigation via left arrow key
                //$input = $(this).closest('td').prevAll('td').has('[type=text]:eq(0)').find('input');
                $input = $(this).closest('td').prevAll('td').has('[type=text]').eq(0).find('input');
                $($input).focus(10, function () {
                    plugin._highlightText;
                });
            }
            else if (e.which == 40) {
                var i = $(this).closest('tr').find('td').index($(this).closest('td'));

                if ($input.closest('table.table.empPayroll-table').length != 0) {
                    $input = $(this).closest('tr').next().find('td:eq(' + i + ')').find('input').not('.readonlyTxt');
                }
                else {
                    $input = $(this).closest('tr').next().find('td:eq(' + i + ')').find('input');
                }

                $($input).focus(10, function () {
                    plugin._highlightText;
                });
            }
            else if (e.which == 38) {
                var i = $(this).closest('tr').find('td').index($(this).closest('td'));

                if ($input.closest('table.table.empPayroll-table').length != 0) {
                    $input = $(this).closest('tr').prev().find('td:eq(' + i + ')').find('input').not('.readonlyTxt');
                }
                else {
                    $input = $(this).closest('tr').prev().find('td:eq(' + i + ')').find('input');
                }

                $($input).focus(10, function () {
                    plugin._highlightText;
                });
            }
            //BD-1160|saurabh|to spread value of active cell via 'Ctrl + Right Arrow'
            else if ((e.keyCode == 39 && (e.ctrlKey || e.metaKey)) && document.activeElement.hasAttribute('data-period') && document.activeElement.dataset.period != 'P12' && $('.page-content-wrapper.data-page').length == 0) {
                var activeElement = document.activeElement;
                var value = document.activeElement.value;
                var activeMonth = activeElement.dataset.period.substring(1);

                //make a string of periods on which the value won't be copied/duplicated
                var periods = '';
                for (let i = 1; i < parseInt(activeMonth); i++) {
                    if (i < 10) periods += '.P0' + i;
                    else periods += '.P' + i;
                }
                var elementsToTraverse = 'td';
                var parentTr = 'tr';

                var tdClasses = $(activeElement).closest('td').attr('class');
                if (tdClasses != undefined) {
                    tdClasses = tdClasses.replace(/\s+/g, '.');
                    elementsToTraverse += '.' + tdClasses;
                }
                var trClasses = $(activeElement).closest('tr').attr('class');
                if (trClasses != undefined) {
                    trClasses = trClasses.replace(/\s+/g, '.');
                    parentTr += '.' + trClasses;
                }
                if (parentTr.slice(-1) == ".") parentTr = parentTr.slice(0, -1);
                if (elementsToTraverse.slice(-1) == ".") elementsToTraverse = elementsToTraverse.slice(0, -1);

                $(activeElement).parents(parentTr).find(elementsToTraverse).not('td.total').not('td.growth-data-row').each(function () {
                    // copying value to the textboxes which are not Average or total and are behind the active textbox.
                    var tempPeriod = $(this).find('input[type=text]').attr('data-period');
                    if (!periods.includes(tempPeriod)) $(this).find('input[type=text]:not(input[title=Total])').not('.disabledByHire').not('.disableByTransaction').val(value).trigger("change");
                });
                return false;
            }
        });

    });

})(jQuery);

;
/*
 * 
 * Tabelizer 1.0.3 - multi level grouping indicators for tables
 * Version 1.0.3
 * @requires jQuery v1.6+ and jQuery.ui core
 * 
 * Copyright (c) 2014 Rafael Huisman
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 */

/**
 * 
 * @description Create a table with multi level grouping indicators.
 * @demo http://powerconsulting.co/Samples/Tabelizer
 * @example $('#table1').tabelize();
 * @desc Create a simple tabelized interface.
 */

(function ($) {
    var self = {};

    self.isFunction = function (func) {
        return func && {}.toString.call(func) === '[object Function]';
    }

    self.rowClicker = function (evt) {

        if (typeof self.conf.onBeforeRowClick != 'undefined' && self.isFunction(self.conf.onBeforeRowClick))
            self.conf.onBeforeRowClick.apply(self.getPublicObj(), [evt]);

        var $elm = $(evt.currentTarget);

        if (!$elm.is('tr'))
            $elm = $elm.parentsUntil('tr').parent()

        $row = $elm;

        var id = $row.attr('id');
        var initialRowlevel = $row.attr('data-level');

        //Simple toggle for contract/expand logic
        if ($row.hasClass('contracted')) {
            $row.removeClass('contracted').addClass('expanded');
            $row.find('.showCol').addClass('hideCol').removeClass('showCol');
            if (!$row.find('.edit').is(':visible')) {
                $row.find('.edit').show();
                $row.find('.submitForApproval').show();
                $row.find('.submit-approve-directly').show();
                $row.find('.submit-reject-directly').show();
                $row.find('.copy').show();
                $row.find('.comment').show();
                //$row.find('.edit').parent().removeClass('hideCol');



            }
            if ($row.find('.action-items .show a').is(':visible')) {
                $row.addClass('show-action-btns');
            }

            $('#DataInputTable tbody tr').each(function () {
                // to make the other rows blur                
                //if (!$(this).hasClass('highlightExcelRow')) {
                $(this).removeClass('highlight').addClass('blurView');
                //}
            });

            $row.removeClass('blurView');

            var level = $row.data('level');
            $row.nextUntil('.l' + level).each(function () {
                $(this).addClass('highlight').removeClass('blurView');
            });


            //$row.find('.action-btn').find('.distributeTotalEven').hide();
            //$row.find('.action-btn').find('.growthRate').hide();
            //$row.find('.action-btn').find('.distributeTotalPercent').hide();


            var level = $row.attr('data-level');

            var length = $row.nextAll('.l' + parseInt(parseInt(level) + 1)).length;

            if (length > 0) {
                //if ($row.next('tr').hasClass('showyear')) {

                $row.next('tr').removeClass('showyear').addClass('hideyear');
                $row.next('tr').next('tr').removeClass('showyear').addClass('hideyear');
                $(this).find('.collapseYear').addClass('expandYear').removeClass('collapseYear');
                $row.nextUntil('.l' + level).each(function () {
                    if ($(this).hasClass('totals')) {
                        if ($('[name=groupedcategory]').val().split('|')[1] == "-1") {
                            $(this).find('.expandYear').addClass('collapseYear').removeClass('expandYear');
                            $(this).next('tr').addClass('showyear').removeClass('hideyear');
                            $(this).next('tr').next('tr').addClass('showyear').removeClass('hideyear');
                        }
                    }

                    if ($(this).hasClass('showyear') && $(this).not('.netsales')) {
                        var link = $(this).find('#hdnEditLink').html();
                        if (link != "0" && link != "") {
                            $(this).find('.formulaType').show();
                            $(this).find('.formulaType div').removeClass('hideCol');
                        }
                    }

                });

            }

            var isFOA = $row.find('#hdnIsFOA').html();
            if (isFOA == "True") {
                $row.find('.formulaType').show();
                $row.find('.formulaType div').removeClass('hideCol');
            }

            $row.find('.sort-vendor').show();
            $row.find('.sort-description').show();


            //// Hide the historical data incase it is open when expanding bottom level category
            //if ($row.next('tr').next('tr').next('tr').hasClass('bottomLevel')) {
            //    $row.next('tr').addClass('hideyear')
            //    $row.next('tr').next('tr').addClass('hideyear')
            //    $row.find('.collapseYear').removeClass('collapseYear').addClass('expandYear');
            //}


            //Show netsales data open by default
            $($row.nextAll('.netsales')[0]).find('.expandYear').removeClass('expandYear').addClass('collapseYear');
            $($row.nextAll('.netsales')[0]).next('tr').removeClass('hideyear').addClass('showyear');
            $($row.nextAll('.netsales')[0]).next('tr').next('tr').removeClass('hideyear').addClass('showyear');


            $row.find('td:first').find('.expander').attr('title', 'Collapse');
            self.toggleChildren(id, true, initialRowlevel);
        } else {

            $row.find('.sort-vendor').hide();
            $row.find('.sort-description').hide();

            var level = $row.data('level');
            var flag = 0;
            $row.nextUntil('tr[data-level=' + level + ']').each(function () {
                if ($(this).hasClass('show-action-btns')) {
                    $(this).find('.hideCol').addClass('showCol').removeClass('hideCol');
                }
                if ($(this).find('.save').is(':visible')) {
                    flag = 1;
                    return false;
                }
                $(this).find('.sort-vendor').hide();
                $(this).find('.sort-description').hide();
            });

            $row.nextUntil('tr.level' + level, '.historicaldata').each(function () {
                $(this).removeClass('showyear').addClass('hideyear');
            });



            $row.nextUntil('tr.level' + level).each(function () {
                $(this).find('.collapseYear').removeClass('collapseYear').addClass('expandYear');


            });

            $row.find('.collapseYear').removeClass('collapseYear').addClass('expandYear');


            // If the row is bottomlevel and in editable mode show alert on collapsing
            if ($row.next('tr').next('tr').next('tr').hasClass('bottomLevel')) {
                if ($row.find('.save').is(':visible'))
                    flag = 1;
            }

            if (flag == 1) {

                var confirmClick = function () {

                    $row.find('.undo').trigger('click');

                    $('.inEditMode').removeClass('inEditMode');

                    $row.find('.sort-vendor').hide();
                    $row.find('.sort-description').hide();

                    $row.find('.copyValues').hide();

                    $row.removeClass('expanded').addClass('contracted');
                    $row.find('.hideCol').addClass('showCol').removeClass('hideCol');

                    $row.find('.edit').hide();
                    $row.find('.copy').hide();
                    $row.find('.submitForApproval').hide();
                    $row.find('.submit-approve-directly').hide();
                    $row.find('.submit-reject-directly').hide();
                    $row.find('.comment').hide();

                    //$row.nextUntil('tr[data-level=1]').not('.historicaldata').not('.netsales').find('.edit').each(function () {
                    //    $(this).hide();

                    //});

                    //$row.nextUntil('tr[data-level=1]').not('.historicaldata').not('.netsales').find('.checkAllToDelete').each(function () {
                    //    $(this).addClass('hideCol');

                    //});

                    //$row.nextUntil('tr[data-level=1]').not('.historicaldata').not('.netsales').find('.show').each(function () {
                    //    $(this).addClass('hideCol');
                    //});

                    $row.find('.checkAllToDelete').addClass('hideCol');

                    self.toggleChildren(id, false, initialRowlevel);
                    $row.removeClass('show-action-btns');
                    $row.find('td:first').find('.expander').attr('title', 'Expand');
                    // If level is contracted then all its child elements collapseyear class is removed to show contracted state.
                    var level = $row.data('level');
                    // Bringing the original state when collapsing the rows //hiding edit and save mode
                    $row.nextUntil('tr[data-level=' + level + ']').each(function () {
                        $(this).find('.collapseYear').removeClass('collapseYear').addClass('expandYear');
                        $(this).find('.edit').hide();
                        $(this).find('.checkAllToDelete').addClass('hideCol');
                        $(this).find('.show').addClass('hideCol');
                        $(this).find('.submitForApproval').hide();
                        $(this).find('.submit-approve-directly').hide();
                        $(this).find('.submit-reject-directly').hide();
                        $(this).find('.comment').hide();
                    });
                }

                var cancelClick = function () {
                    return false;
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Any unsaved changes will be lost");

                //if (confirm("Any unsaved changes will be lost")) {

                //}
                //else {
                return false;
                //}
            }
            else {

                $row.removeClass('expanded').addClass('contracted');
                $row.find('.hideCol').addClass('showCol').removeClass('hideCol');

                $row.find('.edit').hide();
                $row.find('.submitForApproval').hide();
                $row.find('.submit-approve-directly').hide();
                $row.find('.submit-reject-directly').hide();
                $row.find('.copy').hide();
                $row.find('.comment').hide();
                var level = $row.data('level');
                $row.nextUntil('tr[data-level=' + level + ']').not('.historicaldata').not('.netsales').find('.edit').each(function () {
                    $(this).hide();

                });

                $row.nextUntil('tr[data-level=' + level + ']').not('.historicaldata').not('.netsales').find('.formulaType').each(function () {
                    $(this).hide();

                });

                $row.nextUntil('tr[data-level=' + level + ']').not('.historicaldata').not('.netsales').find('.copy').each(function () {
                    $(this).hide();

                });

                $row.nextUntil('tr[data-level=' + level + ']').not('.historicaldata').not('.netsales').find('.comment').hide();

                $row.nextUntil('tr[data-level=' + level + ']').not('.historicaldata').not('.netsales').find('.checkAllToDelete').each(function () {
                    $(this).addClass('hideCol');

                });

                //$row.nextUntil('tr[data-level=1]').not('.historicaldata').not('.netsales').find('.show').each(function () {
                //    $(this).addClass('hideCol');
                //});

                $row.find('.checkAllToDelete').addClass('hideCol');

                self.toggleChildren(id, false, initialRowlevel);
                $row.removeClass('show-action-btns');
                $row.find('td:first').find('.expander').attr('title', 'Expand');
                // If level is contracted then all its child elements collapseyear class is removed to show contracted state.
                var level = $row.data('level');
                // Bringing the original state when collapsing the rows //hiding edit and save mode
                $row.nextUntil('tr[data-level=' + level + ']').not('.contracted').each(function () {
                    $(this).find('.collapseYear').removeClass('collapseYear').addClass('expandYear');
                    $(this).find('.edit').hide();
                    $(this).find('.checkAllToDelete').addClass('hideCol');
                    $(this).find('.show').addClass('hideCol');
                    $(this).find('.submitForApproval').hide();
                    $(this).find('.submit-approve-directly').hide();
                    $(this).find('.submit-reject-directly').hide();
                    $(this).find('.comment').hide();
                });

            }
            //  $('.collapseYear').removeClass('collapseYear').addClass('expandYear');
        }

        // Check implemented to hide and show vendor columns and action columns only when alteast 1 bottomlevel is open otherwise hide
        if ($('.bottomLevel.hidden').length + $('.bottomLevel.hiding').length == $('.bottomLevel').not('.historicaldata').length) {
            $('.displayVendor').addClass('hide');
        }
        else {
            $('.displayVendor:not(.hideColumn)').removeClass('hide');
        }
        //  $row.nextUntil('.doNotExpand').not('.historicaldata').find('.action-btn').addClass('hideCol')
        $row.nextUntil('.doNotExpand').not('.historicaldata').find('.action-btn .distributeTotalEven').hide();
        $row.nextUntil('.doNotExpand').not('.historicaldata').find('.action-btn .growthRate').hide();
        $row.nextUntil('.doNotExpand').not('.historicaldata').find('.action-btn .distributeTotalPercent').hide();

        //if ($(document).find('#hdnUserInApproveBudget').val() == "True") {
        //    $row.nextUntil('.doNotExpand').not('.historicaldata', '.unapproved-row').find('.selectRowToDelete').addClass('hideCol');
        //}
        //else {
        $row.nextUntil('.doNotExpand').not('.historicaldata').find('.selectRowToDelete').addClass('hideCol');
        //}
        //After any contraction or expansion we need to resetup the lines since they will likely change.
        self.updateLines();

        if (typeof self.conf.onAfterRowClick != 'undefined' && self.isFunction(self.conf.onAfterRowClick))
            self.conf.onAfterRowClick.apply(self.getPublicObj(), [evt]);

        return self.getPublicObj();
    }

    self.updateLines = function () {
        //console.log('update lines' + self.maxLevel)
        var currentLevel = '';
        var prevLevel = '';
        $prevRow = null;
        //We only want to apply the lines to the non hidden children.
        self.caller.find('tr:not(.hidden):not(.hiding)').each(function () {
            $row = $(this);
            //header rows do not get included in the grouping
            if (!$row.hasClass('header')) {
                currentLevel = $row.data('level');

                //Remove all existing first and last classes for all available levels to ensure we have a clean slate
                for (var x = self.maxLevel; x > 0; x--)
                    $row.removeClass('l' + x + '-first').removeClass('l' + x + '-last')

                var rowClass = '';
                //We only add the grouping lines if the level has changed, this is true for the first and last lines. 
                if (currentLevel != prevLevel) {
                    //if the previous level is bigger than the current level then we know that we went back in the tree and the previous item is a last one, we want to mark is as the last for any level up to the current
                    if (prevLevel != '' && prevLevel > currentLevel) {
                        for (var x = (prevLevel) ; x >= currentLevel; x--) {
                            $prevRow.addClass(' l' + (parseInt(x)) + '-last')
                        }
                        //If the previous level had a sibling right before it, the previous row is also a first for the previous level
                    } else if (prevLevel != '' && prevLevel < currentLevel) {
                        $prevRow.addClass(' l' + (prevLevel) + '-first')
                    }
                }

                $row.addClass(rowClass)

                prevLevel = currentLevel;
                $prevRow = $row;
            }
        });

        //We need to check if the last item in the grid needs a X-last class.
        if ($prevRow != null && prevLevel != '' && prevLevel > 1) {
            for (var x = (prevLevel - 1) ; x > 0; x--) {
                $prevRow.addClass(' l' + (parseInt(x)) + '-last')
            }
        }

        return self.getPublicObj();
    }

    //this method toggles the children on or off, including a sliding motion
    self.toggleChildren = function (id, display, intialRowLevel, onSlideComplete) {
        var startAction = false;
        var stopAction = false;
        var prevRowLevel = null;
        var startLevel = 0;
        self.caller.find('tr').each(function () {
            var $row = $(this);
            var rowId = $row.attr('id');
            var rowLevel = $row.data('level');
            var skipAction = false;

            if (rowLevel == undefined) {
                if (display == false && prevRowLevel != intialRowLevel && $(this).hasClass("showyear")) {
                    //if (prevRowLevel != intialRowLevel)
                    //$(this).removeClass("showyear").addClass("hideyear"); //commented by Himanshu as this was hiding LY and LLY of the complete datasheet if user collapes data level other than 1
                }
            }
            else {

                if (!startAction && rowId == id) {
                    startAction = true;
                    startLevel = rowLevel;
                }
                else if (startAction && !stopAction && prevRowLevel != null && rowLevel == (startLevel)) {
                    //console.log('1')
                    stopAction = true;
                } else if (display && (startAction && !stopAction && prevRowLevel != null && rowLevel != (startLevel + 1))) {
                    skipAction = true;
                } else if (!display && (startAction && !stopAction && prevRowLevel != null && rowLevel < (startLevel))) {
                    //console.log('cold turkey')
                    stopAction = true;
                    skipAction = true;
                }
                //console.log('rowId: ' + rowId + ' perform: ' + ((!skipAction && startAction && !stopAction &&  rowId != id)) + ' skip: ' + skipAction + ' level: ' + rowLevel + ' -> ' + (startLevel))

                if (!skipAction && startAction && !stopAction && rowId != id) {
                    if (display) {
                        $row.removeClass('hidden');

                        //$row.find('td').wrapInner('<div style="display: none;" />').parent().find('td > div').slideDown(100, function () {
                        //    var $set = $(this);
                        //    $set.replaceWith($set.contents());
                        //});
                    }
                    else {
                        //if (!$row.prev('tr').find('td').hasClass('collapseYear')) {
                        //    if (!$row.prev('tr').prev('tr').find('td').hasClass('collapseYear')) {
                        $row.addClass('hiding');
                        //$row.find('td').wrapInner('<div style="" />').parent().find('td > div').slideUp(100, function () {
                        //    var $set = $(this);
                        //    $set.replaceWith($set.contents());
                        //    $row.addClass('hidden');
                        //    $row.removeClass('hiding');
                        //});

                        $row.addClass('hidden');
                        $row.removeClass('hiding');

                        $row.removeClass('expanded')
                        $row.addClass('contracted');
                        if (rowLevel != intialRowLevel)
                            $row.find(".expandYear").removeClass("collapseYear").addClass("expandYear");                            
                        //    }
                        //}                   
                    }


                }
                prevRowLevel = rowLevel;
            }
        });

        return self.getPublicObj();
    }

    self.updateData = function () {
        self.caller.data('tabelizer', self);
    }

    self.maxLevel = 0;
    self.init = function () {

        var currentLevel = '';
        var prevLevel = '';
        $prevRow = null;
        //we want to find all rows of the caller table to apply the base classes to them and make them expandable
        self.caller.find('tr').each(function () {
            $row = $(this);
            //don't apply any logic tot the header row
            if (!$row.hasClass('header') && !$row.hasClass('expanded') && !$row.hasClass('contracted') && !$row.hasClass('hideyear')) {
                currentLevel = $row.data('level');

                var rowClass = 'l' + currentLevel + ' contracted ';

                $ParentRow = $row.prevAll('tr[data-level=' + (currentLevel - 1).toString() + ']');

                if (!$ParentRow.hasClass('expanded')) {
                    rowClass = rowClass + (currentLevel > 1 ? ' hidden' : '');
                }


                //keep track of the highest level, this is used for the grouping lines
                if (currentLevel > self.maxLevel)
                    self.maxLevel = parseInt(currentLevel);

                $row.addClass(rowClass)

                //apply labels around the first column text, so that we can add in the controls and expander image
                $firstCol = $($row.children('td')[0])
                var firstColVal = '<div class="label">' + $firstCol.html() + '</div>';
                var parentLevels = 0;

                //add in the line control div, add it in for every level up until your current level, this is to ensure we can show all the needed lines.
                var levelLines = '<div class="control"> ';
                for (var x = 0; x <= (currentLevel - 1) ; x++) {
                    levelLines += ' <div class="line level' + (x + 1) + '"><div class="vert"></div><div class="horz"></div></div> ';
                }
                levelLines += '</div>'
                //Add the expanded class, which through css adds in the arrow image
                if ($(firstColVal).html() != "")
                    $firstCol.html(levelLines + ' <div class="expander"></div> ' + firstColVal);
                //apply the method to be called on each row click, if fullRowClickable is set to false, then only the expander is clickable
                if (self.conf.fullRowClickable)
                    $row.on('click', self.conf.onRowClick);
                else
                    $row.find('.expander').on('click', self.conf.onRowClick);
                prevLevel = currentLevel;
                $prevRow = $row;
            }
        });

        self.updateLines();

        if (typeof self.conf.onReady != 'undefined' && self.isFunction(self.conf.onReady))
            self.conf.onReady.apply(self.getPublicObj(), []);




        return self.getPublicObj();
    }

    self.getPublicObj = function () {
        return {
            options: self.conf,
            toggleChildren: self.toggleChildren,
            updateLines: self.updateLines,
            rowClicker: self.rowClicker,
            maxLevel: self.maxLevel,
            updateData: self.updateData
        }
    };

    self.conf = {
        onRowClick: self.rowClicker,
        fullRowClickable: true,//must be set before init
        onBeforeRowClick: null,
        onAfterRowClick: null,
        onReady: null
    };

    $.fn.tabelize = function (confProp) {

        var existingSelf = this.data('tabelizer');
        //if (typeof existingSelf == 'undefined'){
        $.extend(self.conf, confProp);
        self.caller = this;
        self.init();

        //}else{
        //	self = existingSelf;
        //	$.extend(self.conf, confProp);
        //}
        //Store copy of self in data for repeat calls, update it after any repeating call
        self.updateData();

        //if ($('.bottomLevel').not('.historicaldata').not('.hidden').length == $('.bottomLevel').not('.historicaldata').length) {
        //    $('.displayVendor').css('display','none');
        //}
        //else {
        //    $('.displayVendor').css('display', 'block');
        //}

        return self.getPublicObj()
    };
})(jQuery);;
/*
== malihu jquery custom scrollbar plugin == 
Version: 3.0.9 
Plugin URI: http://manos.malihu.gr/jquery-custom-content-scroller 
Author: malihu
Author URI: http://manos.malihu.gr
License: MIT License (MIT)
*/

/*
Copyright 2010 Manos Malihutsakis (email: manos@malihu.gr)

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/

/*
The code below is fairly long, fully commented and should be normally used in development. 
For production, use either the minified jquery.mCustomScrollbar.min.js script or 
the production-ready jquery.mCustomScrollbar.concat.min.js which contains the plugin 
and dependencies (minified). 
*/

(function(factory){
	if(typeof module!=="undefined" && module.exports){
		module.exports=factory;
	}else{
		factory(jQuery,window,document);
	}
}(function($){
(function(init){
	var _rjs=typeof define==="function" && define.amd, /* RequireJS */
		_njs=typeof module !== "undefined" && module.exports, /* NodeJS */
		_dlp=("https:"==document.location.protocol) ? "https:" : "http:", /* location protocol */
		_url="cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.12/jquery.mousewheel.min.js";
	if(!_rjs){
		if(_njs){
			require("jquery-mousewheel")($);
		}else{
			/* load jquery-mousewheel plugin (via CDN) if it's not present or not loaded via RequireJS 
			(works when mCustomScrollbar fn is called on window load) */
			$.event.special.mousewheel || $("head").append(decodeURI("%3Cscript src="+_dlp+"//"+_url+"%3E%3C/script%3E"));
		}
	}
	init();
}(function(){
	
	/* 
	----------------------------------------
	PLUGIN NAMESPACE, PREFIX, DEFAULT SELECTOR(S) 
	----------------------------------------
	*/
	
	var pluginNS="mCustomScrollbar",
		pluginPfx="mCS",
		defaultSelector=".mCustomScrollbar",
	
	
		
	
	
	/* 
	----------------------------------------
	DEFAULT OPTIONS 
	----------------------------------------
	*/
	
		defaults={
			/*
			set element/content width/height programmatically 
			values: boolean, pixels, percentage 
				option						default
				-------------------------------------
				setWidth					false
				setHeight					false
			*/
			/*
			set the initial css top property of content  
			values: string (e.g. "-100px", "10%" etc.)
			*/
			setTop:0,
			/*
			set the initial css left property of content  
			values: string (e.g. "-100px", "10%" etc.)
			*/
			setLeft:0,
			/* 
			scrollbar axis (vertical and/or horizontal scrollbars) 
			values (string): "y", "x", "yx"
			*/
			axis:"y",
			/*
			position of scrollbar relative to content  
			values (string): "inside", "outside" ("outside" requires elements with position:relative)
			*/
			scrollbarPosition:"inside",
			/*
			scrolling inertia
			values: integer (milliseconds)
			*/
			scrollInertia:950,
			/* 
			auto-adjust scrollbar dragger length
			values: boolean
			*/
			autoDraggerLength:true,
			/*
			auto-hide scrollbar when idle 
			values: boolean
				option						default
				-------------------------------------
				autoHideScrollbar			false
			*/
			/*
			auto-expands scrollbar on mouse-over and dragging
			values: boolean
				option						default
				-------------------------------------
				autoExpandScrollbar			false
			*/
			/*
			always show scrollbar, even when there's nothing to scroll 
			values: integer (0=disable, 1=always show dragger rail and buttons, 2=always show dragger rail, dragger and buttons), boolean
			*/
			alwaysShowScrollbar:0,
			/*
			scrolling always snaps to a multiple of this number in pixels
			values: integer
				option						default
				-------------------------------------
				snapAmount					null
			*/
			/*
			when snapping, snap with this number in pixels as an offset 
			values: integer
			*/
			snapOffset:0,
			/* 
			mouse-wheel scrolling
			*/
			mouseWheel:{
				/* 
				enable mouse-wheel scrolling
				values: boolean
				*/
				enable:true,
				/* 
				scrolling amount in pixels
				values: "auto", integer 
				*/
				scrollAmount:"auto",
				/* 
				mouse-wheel scrolling axis 
				the default scrolling direction when both vertical and horizontal scrollbars are present 
				values (string): "y", "x" 
				*/
				axis:"y",
				/* 
				prevent the default behaviour which automatically scrolls the parent element(s) when end of scrolling is reached 
				values: boolean
					option						default
					-------------------------------------
					preventDefault				null
				*/
				/*
				the reported mouse-wheel delta value. The number of lines (translated to pixels) one wheel notch scrolls.  
				values: "auto", integer 
				"auto" uses the default OS/browser value 
				*/
				deltaFactor:"auto",
				/*
				normalize mouse-wheel delta to -1 or 1 (disables mouse-wheel acceleration) 
				values: boolean
					option						default
					-------------------------------------
					normalizeDelta				null
				*/
				/*
				invert mouse-wheel scrolling direction 
				values: boolean
					option						default
					-------------------------------------
					invert						null
				*/
				/*
				the tags that disable mouse-wheel when cursor is over them
				*/
				disableOver:["select","option","keygen","datalist","textarea"]
			},
			/* 
			scrollbar buttons
			*/
			scrollButtons:{ 
				/*
				enable scrollbar buttons
				values: boolean
					option						default
					-------------------------------------
					enable						null
				*/
				/*
				scrollbar buttons scrolling type 
				values (string): "stepless", "stepped"
				*/
				scrollType:"stepless",
				/*
				scrolling amount in pixels
				values: "auto", integer 
				*/
				scrollAmount:"auto"
				/*
				tabindex of the scrollbar buttons
				values: false, integer
					option						default
					-------------------------------------
					tabindex					null
				*/
			},
			/* 
			keyboard scrolling
			*/
			keyboard:{ 
				/*
				enable scrolling via keyboard
				values: boolean
				*/
				enable:true,
				/*
				keyboard scrolling type 
				values (string): "stepless", "stepped"
				*/
				scrollType:"stepless",
				/*
				scrolling amount in pixels
				values: "auto", integer 
				*/
				scrollAmount:"auto"
			},
			/*
			enable content touch-swipe scrolling 
			values: boolean, integer, string (number)
			integer values define the axis-specific minimum amount required for scrolling momentum
			*/
			contentTouchScroll:25,
			/*
			advanced option parameters
			*/
			advanced:{
				/*
				auto-expand content horizontally (for "x" or "yx" axis) 
				values: boolean
					option						default
					-------------------------------------
					autoExpandHorizontalScroll	null
				*/
				/*
				auto-scroll to elements with focus
				*/
				autoScrollOnFocus:"input,textarea,select,button,datalist,keygen,a[tabindex],area,object,[contenteditable='true']",
				/*
				auto-update scrollbars on content, element or viewport resize 
				should be true for fluid layouts/elements, adding/removing content dynamically, hiding/showing elements, content with images etc. 
				values: boolean
				*/
				updateOnContentResize:true,
				/*
				auto-update scrollbars each time each image inside the element is fully loaded 
				values: boolean
				*/
				updateOnImageLoad:true,
				/*
				auto-update scrollbars based on the amount and size changes of specific selectors 
				useful when you need to update the scrollbar(s) automatically, each time a type of element is added, removed or changes its size 
				values: boolean, string (e.g. "ul li" will auto-update scrollbars each time list-items inside the element are changed) 
				a value of true (boolean) will auto-update scrollbars each time any element is changed
					option						default
					-------------------------------------
					updateOnSelectorChange		null
				*/
				/*
				extra selectors that'll release scrollbar dragging upon mouseup, pointerup, touchend etc. (e.g. "selector-1, selector-2")
					option						default
					-------------------------------------
					releaseDraggableSelectors	null
				*/
				/*
				auto-update timeout 
				values: integer (milliseconds)
				*/
				autoUpdateTimeout:60
			},
			/* 
			scrollbar theme 
			values: string (see CSS/plugin URI for a list of ready-to-use themes)
			*/
			theme:"light",
			/*
			user defined callback functions
			*/
			callbacks:{
				/*
				Available callbacks: 
					callback					default
					-------------------------------------
					onInit						null
					onScrollStart				null
					onScroll					null
					onTotalScroll				null
					onTotalScrollBack			null
					whileScrolling				null
					onOverflowY					null
					onOverflowX					null
					onOverflowYNone				null
					onOverflowXNone				null
					onImageLoad					null
					onSelectorChange			null
					onUpdate					null
				*/
				onTotalScrollOffset:0,
				onTotalScrollBackOffset:0,
				alwaysTriggerOffsets:true
			}
			/*
			add scrollbar(s) on all elements matching the current selector, now and in the future 
			values: boolean, string 
			string values: "on" (enable), "once" (disable after first invocation), "off" (disable)
			liveSelector values: string (selector)
				option						default
				-------------------------------------
				live						false
				liveSelector				null
			*/
		},
	
	
	
	
	
	/* 
	----------------------------------------
	VARS, CONSTANTS 
	----------------------------------------
	*/
	
		totalInstances=0, /* plugin instances amount */
		liveTimers={}, /* live option timers */
		oldIE=(window.attachEvent && !window.addEventListener) ? 1 : 0, /* detect IE < 9 */
		touchActive=false,touchable, /* global touch vars (for touch and pointer events) */
		/* general plugin classes */
		classes=[
			"mCSB_dragger_onDrag","mCSB_scrollTools_onDrag","mCS_img_loaded","mCS_disabled","mCS_destroyed","mCS_no_scrollbar",
			"mCS-autoHide","mCS-dir-rtl","mCS_no_scrollbar_y","mCS_no_scrollbar_x","mCS_y_hidden","mCS_x_hidden","mCSB_draggerContainer",
			"mCSB_buttonUp","mCSB_buttonDown","mCSB_buttonLeft","mCSB_buttonRight"
		],
		
	
	
	
	
	/* 
	----------------------------------------
	METHODS 
	----------------------------------------
	*/
	
		methods={
			
			/* 
			plugin initialization method 
			creates the scrollbar(s), plugin data object and options
			----------------------------------------
			*/
			
			init:function(options){
				
				var options=$.extend(true,{},defaults,options),
					selector=_selector.call(this); /* validate selector */
				
				/* 
				if live option is enabled, monitor for elements matching the current selector and 
				apply scrollbar(s) when found (now and in the future) 
				*/
				if(options.live){
					var liveSelector=options.liveSelector || this.selector || defaultSelector, /* live selector(s) */
						$liveSelector=$(liveSelector); /* live selector(s) as jquery object */
					if(options.live==="off"){
						/* 
						disable live if requested 
						usage: $(selector).mCustomScrollbar({live:"off"}); 
						*/
						removeLiveTimers(liveSelector);
						return;
					}
					liveTimers[liveSelector]=setTimeout(function(){
						/* call mCustomScrollbar fn on live selector(s) every half-second */
						$liveSelector.mCustomScrollbar(options);
						if(options.live==="once" && $liveSelector.length){
							/* disable live after first invocation */
							removeLiveTimers(liveSelector);
						}
					},500);
				}else{
					removeLiveTimers(liveSelector);
				}
				
				/* options backward compatibility (for versions < 3.0.0) and normalization */
				options.setWidth=(options.set_width) ? options.set_width : options.setWidth;
				options.setHeight=(options.set_height) ? options.set_height : options.setHeight;
				options.axis=(options.horizontalScroll) ? "x" : _findAxis(options.axis);
				options.scrollInertia=options.scrollInertia>0 && options.scrollInertia<17 ? 17 : options.scrollInertia;
				if(typeof options.mouseWheel!=="object" &&  options.mouseWheel==true){ /* old school mouseWheel option (non-object) */
					options.mouseWheel={enable:true,scrollAmount:"auto",axis:"y",preventDefault:false,deltaFactor:"auto",normalizeDelta:false,invert:false}
				}
				options.mouseWheel.scrollAmount=!options.mouseWheelPixels ? options.mouseWheel.scrollAmount : options.mouseWheelPixels;
				options.mouseWheel.normalizeDelta=!options.advanced.normalizeMouseWheelDelta ? options.mouseWheel.normalizeDelta : options.advanced.normalizeMouseWheelDelta;
				options.scrollButtons.scrollType=_findScrollButtonsType(options.scrollButtons.scrollType); 
				
				_theme(options); /* theme-specific options */
				
				/* plugin constructor */
				return $(selector).each(function(){
					
					var $this=$(this);
					
					if(!$this.data(pluginPfx)){ /* prevent multiple instantiations */
					
						/* store options and create objects in jquery data */
						$this.data(pluginPfx,{
							idx:++totalInstances, /* instance index */
							opt:options, /* options */
							scrollRatio:{y:null,x:null}, /* scrollbar to content ratio */
							overflowed:null, /* overflowed axis */
							contentReset:{y:null,x:null}, /* object to check when content resets */
							bindEvents:false, /* object to check if events are bound */
							tweenRunning:false, /* object to check if tween is running */
							sequential:{}, /* sequential scrolling object */
							langDir:$this.css("direction"), /* detect/store direction (ltr or rtl) */
							cbOffsets:null, /* object to check whether callback offsets always trigger */
							/* 
							object to check how scrolling events where last triggered 
							"internal" (default - triggered by this script), "external" (triggered by other scripts, e.g. via scrollTo method) 
							usage: object.data("mCS").trigger
							*/
							trigger:null
						});
						
						var d=$this.data(pluginPfx),o=d.opt,
							/* HTML data attributes */
							htmlDataAxis=$this.data("mcs-axis"),htmlDataSbPos=$this.data("mcs-scrollbar-position"),htmlDataTheme=$this.data("mcs-theme");
						 
						if(htmlDataAxis){o.axis=htmlDataAxis;} /* usage example: data-mcs-axis="y" */
						if(htmlDataSbPos){o.scrollbarPosition=htmlDataSbPos;} /* usage example: data-mcs-scrollbar-position="outside" */
						if(htmlDataTheme){ /* usage example: data-mcs-theme="minimal" */
							o.theme=htmlDataTheme;
							_theme(o); /* theme-specific options */
						}
						
						_pluginMarkup.call(this); /* add plugin markup */
						
						$("#mCSB_"+d.idx+"_container img:not(."+classes[2]+")").addClass(classes[2]); /* flag loaded images */
						
						methods.update.call(null,$this); /* call the update method */
					
					}
					
				});
				
			},
			/* ---------------------------------------- */
			
			
			
			/* 
			plugin update method 
			updates content and scrollbar(s) values, events and status 
			----------------------------------------
			usage: $(selector).mCustomScrollbar("update");
			*/
			
			update:function(el,cb){
				
				var selector=el || _selector.call(this); /* validate selector */
				
				return $(selector).each(function(){
					
					var $this=$(this);
					
					if($this.data(pluginPfx)){ /* check if plugin has initialized */
						
						var d=$this.data(pluginPfx),o=d.opt,
							mCSB_container=$("#mCSB_"+d.idx+"_container"),
							mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")];
						
						if(!mCSB_container.length){return;}
						
						if(d.tweenRunning){_stop($this);} /* stop any running tweens while updating */
						
						/* if element was disabled or destroyed, remove class(es) */
						if($this.hasClass(classes[3])){$this.removeClass(classes[3]);}
						if($this.hasClass(classes[4])){$this.removeClass(classes[4]);}
						
						_maxHeight.call(this); /* detect/set css max-height value */
						
						_expandContentHorizontally.call(this); /* expand content horizontally */
						
						if(o.axis!=="y" && !o.advanced.autoExpandHorizontalScroll){
							mCSB_container.css("width",_contentWidth(mCSB_container.children()));
						}
						
						d.overflowed=_overflowed.call(this); /* determine if scrolling is required */
						
						_scrollbarVisibility.call(this); /* show/hide scrollbar(s) */
						
						/* auto-adjust scrollbar dragger length analogous to content */
						if(o.autoDraggerLength){_setDraggerLength.call(this);}
						
						_scrollRatio.call(this); /* calculate and store scrollbar to content ratio */
						
						_bindEvents.call(this); /* bind scrollbar events */
						
						/* reset scrolling position and/or events */
						var to=[Math.abs(mCSB_container[0].offsetTop),Math.abs(mCSB_container[0].offsetLeft)];
						if(o.axis!=="x"){ /* y/yx axis */
							if(!d.overflowed[0]){ /* y scrolling is not required */
								_resetContentPosition.call(this); /* reset content position */
								if(o.axis==="y"){
									_unbindEvents.call(this);
								}else if(o.axis==="yx" && d.overflowed[1]){
									_scrollTo($this,to[1].toString(),{dir:"x",dur:0,overwrite:"none"});
								}
							}else if(mCSB_dragger[0].height()>mCSB_dragger[0].parent().height()){
								_resetContentPosition.call(this); /* reset content position */
							}else{ /* y scrolling is required */
								_scrollTo($this,to[0].toString(),{dir:"y",dur:0,overwrite:"none"});
								d.contentReset.y=null;
							}
						}
						if(o.axis!=="y"){ /* x/yx axis */
							if(!d.overflowed[1]){ /* x scrolling is not required */
								_resetContentPosition.call(this); /* reset content position */
								if(o.axis==="x"){
									_unbindEvents.call(this);
								}else if(o.axis==="yx" && d.overflowed[0]){
									_scrollTo($this,to[0].toString(),{dir:"y",dur:0,overwrite:"none"});
								}
							}else if(mCSB_dragger[1].width()>mCSB_dragger[1].parent().width()){
								_resetContentPosition.call(this); /* reset content position */
							}else{ /* x scrolling is required */
								_scrollTo($this,to[1].toString(),{dir:"x",dur:0,overwrite:"none"});
								d.contentReset.x=null;
							}
						}
						
						/* callbacks: onImageLoad, onSelectorChange, onUpdate */
						if(cb && d){
							if(cb===2 && o.callbacks.onImageLoad && typeof o.callbacks.onImageLoad==="function"){
								o.callbacks.onImageLoad.call(this);
							}else if(cb===3 && o.callbacks.onSelectorChange && typeof o.callbacks.onSelectorChange==="function"){
								o.callbacks.onSelectorChange.call(this);
							}else if(o.callbacks.onUpdate && typeof o.callbacks.onUpdate==="function"){
								o.callbacks.onUpdate.call(this);
							}
						}
						
						_autoUpdate.call(this); /* initialize automatic updating (for dynamic content, fluid layouts etc.) */
						
					}
					
				});
				
			},
			/* ---------------------------------------- */
			
			
			
			/* 
			plugin scrollTo method 
			triggers a scrolling event to a specific value
			----------------------------------------
			usage: $(selector).mCustomScrollbar("scrollTo",value,options);
			*/
		
			scrollTo:function(val,options){
				
				/* prevent silly things like $(selector).mCustomScrollbar("scrollTo",undefined); */
				if(typeof val=="undefined" || val==null){return;}
				
				var selector=_selector.call(this); /* validate selector */
				
				return $(selector).each(function(){
					
					var $this=$(this);
					
					if($this.data(pluginPfx)){ /* check if plugin has initialized */
					
						var d=$this.data(pluginPfx),o=d.opt,
							/* method default options */
							methodDefaults={
								trigger:"external", /* method is by default triggered externally (e.g. from other scripts) */
								scrollInertia:o.scrollInertia, /* scrolling inertia (animation duration) */
								scrollEasing:"mcsEaseInOut", /* animation easing */
								moveDragger:false, /* move dragger instead of content */
								timeout:60, /* scroll-to delay */
								callbacks:true, /* enable/disable callbacks */
								onStart:true,
								onUpdate:true,
								onComplete:true
							},
							methodOptions=$.extend(true,{},methodDefaults,options),
							to=_arr.call(this,val),dur=methodOptions.scrollInertia>0 && methodOptions.scrollInertia<17 ? 17 : methodOptions.scrollInertia;
						
						/* translate yx values to actual scroll-to positions */
						to[0]=_to.call(this,to[0],"y");
						to[1]=_to.call(this,to[1],"x");
						
						/* 
						check if scroll-to value moves the dragger instead of content. 
						Only pixel values apply on dragger (e.g. 100, "100px", "-=100" etc.) 
						*/
						if(methodOptions.moveDragger){
							to[0]*=d.scrollRatio.y;
							to[1]*=d.scrollRatio.x;
						}
						
						methodOptions.dur=dur;
						
						setTimeout(function(){ 
							/* do the scrolling */
							if(to[0]!==null && typeof to[0]!=="undefined" && o.axis!=="x" && d.overflowed[0]){ /* scroll y */
								methodOptions.dir="y";
								methodOptions.overwrite="all";
								_scrollTo($this,to[0].toString(),methodOptions);
							}
							if(to[1]!==null && typeof to[1]!=="undefined" && o.axis!=="y" && d.overflowed[1]){ /* scroll x */
								methodOptions.dir="x";
								methodOptions.overwrite="none";
								_scrollTo($this,to[1].toString(),methodOptions);
							}
						},methodOptions.timeout);
						
					}
					
				});
				
			},
			/* ---------------------------------------- */
			
			
			
			/*
			plugin stop method 
			stops scrolling animation
			----------------------------------------
			usage: $(selector).mCustomScrollbar("stop");
			*/
			stop:function(){
				
				var selector=_selector.call(this); /* validate selector */
				
				return $(selector).each(function(){
					
					var $this=$(this);
					
					if($this.data(pluginPfx)){ /* check if plugin has initialized */
										
						_stop($this);
					
					}
					
				});
				
			},
			/* ---------------------------------------- */
			
			
			
			/*
			plugin disable method 
			temporarily disables the scrollbar(s) 
			----------------------------------------
			usage: $(selector).mCustomScrollbar("disable",reset); 
			reset (boolean): resets content position to 0 
			*/
			disable:function(r){
				
				var selector=_selector.call(this); /* validate selector */
				
				return $(selector).each(function(){
					
					var $this=$(this);
					
					if($this.data(pluginPfx)){ /* check if plugin has initialized */
						
						var d=$this.data(pluginPfx);
						
						_autoUpdate.call(this,"remove"); /* remove automatic updating */
						
						_unbindEvents.call(this); /* unbind events */
						
						if(r){_resetContentPosition.call(this);} /* reset content position */
						
						_scrollbarVisibility.call(this,true); /* show/hide scrollbar(s) */
						
						$this.addClass(classes[3]); /* add disable class */
					
					}
					
				});
				
			},
			/* ---------------------------------------- */
			
			
			
			/*
			plugin destroy method 
			completely removes the scrollbar(s) and returns the element to its original state
			----------------------------------------
			usage: $(selector).mCustomScrollbar("destroy"); 
			*/
			destroy:function(){
				
				var selector=_selector.call(this); /* validate selector */
				
				return $(selector).each(function(){
					
					var $this=$(this);
					
					if($this.data(pluginPfx)){ /* check if plugin has initialized */
					
						var d=$this.data(pluginPfx),o=d.opt,
							mCustomScrollBox=$("#mCSB_"+d.idx),
							mCSB_container=$("#mCSB_"+d.idx+"_container"),
							scrollbar=$(".mCSB_"+d.idx+"_scrollbar");
					
						if(o.live){removeLiveTimers(o.liveSelector || $(selector).selector);} /* remove live timers */
						
						_autoUpdate.call(this,"remove"); /* remove automatic updating */
						
						_unbindEvents.call(this); /* unbind events */
						
						_resetContentPosition.call(this); /* reset content position */
						
						$this.removeData(pluginPfx); /* remove plugin data object */
						
						_delete(this,"mcs"); /* delete callbacks object */
						
						/* remove plugin markup */
						scrollbar.remove(); /* remove scrollbar(s) first (those can be either inside or outside plugin's inner wrapper) */
						mCSB_container.find("img."+classes[2]).removeClass(classes[2]); /* remove loaded images flag */
						mCustomScrollBox.replaceWith(mCSB_container.contents()); /* replace plugin's inner wrapper with the original content */
						/* remove plugin classes from the element and add destroy class */
						$this.removeClass(pluginNS+" _"+pluginPfx+"_"+d.idx+" "+classes[6]+" "+classes[7]+" "+classes[5]+" "+classes[3]).addClass(classes[4]);
					
					}
					
				});
				
			}
			/* ---------------------------------------- */
			
		},
	
	
	
	
		
	/* 
	----------------------------------------
	FUNCTIONS
	----------------------------------------
	*/
	
		/* validates selector (if selector is invalid or undefined uses the default one) */
		_selector=function(){
			return (typeof $(this)!=="object" || $(this).length<1) ? defaultSelector : this;
		},
		/* -------------------- */
		
		
		/* changes options according to theme */
		_theme=function(obj){
			var fixedSizeScrollbarThemes=["rounded","rounded-dark","rounded-dots","rounded-dots-dark"],
				nonExpandedScrollbarThemes=["rounded-dots","rounded-dots-dark","3d","3d-dark","3d-thick","3d-thick-dark","inset","inset-dark","inset-2","inset-2-dark","inset-3","inset-3-dark"],
				disabledScrollButtonsThemes=["minimal","minimal-dark"],
				enabledAutoHideScrollbarThemes=["minimal","minimal-dark"],
				scrollbarPositionOutsideThemes=["minimal","minimal-dark"];
			obj.autoDraggerLength=$.inArray(obj.theme,fixedSizeScrollbarThemes) > -1 ? false : obj.autoDraggerLength;
			obj.autoExpandScrollbar=$.inArray(obj.theme,nonExpandedScrollbarThemes) > -1 ? false : obj.autoExpandScrollbar;
			obj.scrollButtons.enable=$.inArray(obj.theme,disabledScrollButtonsThemes) > -1 ? false : obj.scrollButtons.enable;
			obj.autoHideScrollbar=$.inArray(obj.theme,enabledAutoHideScrollbarThemes) > -1 ? true : obj.autoHideScrollbar;
			obj.scrollbarPosition=$.inArray(obj.theme,scrollbarPositionOutsideThemes) > -1 ? "outside" : obj.scrollbarPosition;
		},
		/* -------------------- */
		
		
		/* live option timers removal */
		removeLiveTimers=function(selector){
			if(liveTimers[selector]){
				clearTimeout(liveTimers[selector]);
				_delete(liveTimers,selector);
			}
		},
		/* -------------------- */
		
		
		/* normalizes axis option to valid values: "y", "x", "yx" */
		_findAxis=function(val){
			return (val==="yx" || val==="xy" || val==="auto") ? "yx" : (val==="x" || val==="horizontal") ? "x" : "y";
		},
		/* -------------------- */
		
		
		/* normalizes scrollButtons.scrollType option to valid values: "stepless", "stepped" */
		_findScrollButtonsType=function(val){
			return (val==="stepped" || val==="pixels" || val==="step" || val==="click") ? "stepped" : "stepless";
		},
		/* -------------------- */
		
		
		/* generates plugin markup */
		_pluginMarkup=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				expandClass=o.autoExpandScrollbar ? " "+classes[1]+"_expand" : "",
				scrollbar=["<div id='mCSB_"+d.idx+"_scrollbar_vertical' class='mCSB_scrollTools mCSB_"+d.idx+"_scrollbar mCS-"+o.theme+" mCSB_scrollTools_vertical"+expandClass+"'><div class='"+classes[12]+"'><div id='mCSB_"+d.idx+"_dragger_vertical' class='mCSB_dragger' style='position:absolute;' oncontextmenu='return false;'><div class='mCSB_dragger_bar' /></div><div class='mCSB_draggerRail' /></div></div>","<div id='mCSB_"+d.idx+"_scrollbar_horizontal' class='mCSB_scrollTools mCSB_"+d.idx+"_scrollbar mCS-"+o.theme+" mCSB_scrollTools_horizontal"+expandClass+"'><div class='"+classes[12]+"'><div id='mCSB_"+d.idx+"_dragger_horizontal' class='mCSB_dragger' style='position:absolute;' oncontextmenu='return false;'><div class='mCSB_dragger_bar' /></div><div class='mCSB_draggerRail' /></div></div>"],
				wrapperClass=o.axis==="yx" ? "mCSB_vertical_horizontal" : o.axis==="x" ? "mCSB_horizontal" : "mCSB_vertical",
				scrollbars=o.axis==="yx" ? scrollbar[0]+scrollbar[1] : o.axis==="x" ? scrollbar[1] : scrollbar[0],
				contentWrapper=o.axis==="yx" ? "<div id='mCSB_"+d.idx+"_container_wrapper' class='mCSB_container_wrapper' />" : "",
				autoHideClass=o.autoHideScrollbar ? " "+classes[6] : "",
				scrollbarDirClass=(o.axis!=="x" && d.langDir==="rtl") ? " "+classes[7] : "";
			if(o.setWidth){$this.css("width",o.setWidth);} /* set element width */
			if(o.setHeight){$this.css("height",o.setHeight);} /* set element height */
			o.setLeft=(o.axis!=="y" && d.langDir==="rtl") ? "989999px" : o.setLeft; /* adjust left position for rtl direction */
			$this.addClass(pluginNS+" _"+pluginPfx+"_"+d.idx+autoHideClass+scrollbarDirClass).wrapInner("<div id='mCSB_"+d.idx+"' class='mCustomScrollBox mCS-"+o.theme+" "+wrapperClass+"'><div id='mCSB_"+d.idx+"_container' class='mCSB_container' style='position:relative; top:"+o.setTop+"; left:"+o.setLeft+";' dir="+d.langDir+" /></div>");
			var mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container");
			if(o.axis!=="y" && !o.advanced.autoExpandHorizontalScroll){
				mCSB_container.css("width",_contentWidth(mCSB_container.children()));
			}
			if(o.scrollbarPosition==="outside"){
				if($this.css("position")==="static"){ /* requires elements with non-static position */
					$this.css("position","relative");
				}
				$this.css("overflow","visible");
				mCustomScrollBox.addClass("mCSB_outside").after(scrollbars);
			}else{
				mCustomScrollBox.addClass("mCSB_inside").append(scrollbars);
				mCSB_container.wrap(contentWrapper);
			}
			_scrollButtons.call(this); /* add scrollbar buttons */
			/* minimum dragger length */
			var mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")];
			mCSB_dragger[0].css("min-height",mCSB_dragger[0].height());
			mCSB_dragger[1].css("min-width",mCSB_dragger[1].width());
		},
		/* -------------------- */
		
		
		/* calculates content width */
		_contentWidth=function(el){
			return Math.max.apply(Math,el.map(function(){return $(this).outerWidth(true);}).get());
		},
		/* -------------------- */
		
		
		/* expands content horizontally */
		_expandContentHorizontally=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				mCSB_container=$("#mCSB_"+d.idx+"_container");
			if(o.advanced.autoExpandHorizontalScroll && o.axis!=="y"){
				/* 
				wrap content with an infinite width div and set its position to absolute and width to auto. 
				Setting width to auto before calculating the actual width is important! 
				We must let the browser set the width as browser zoom values are impossible to calculate.
				*/
				mCSB_container.css({"position":"absolute","width":"auto"})
					.wrap("<div class='mCSB_h_wrapper' style='position:relative; left:0; width:999999px;' />")
					.css({ /* set actual width, original position and un-wrap */
						/* 
						get the exact width (with decimals) and then round-up. 
						Using jquery outerWidth() will round the width value which will mess up with inner elements that have non-integer width
						*/
						"width":(Math.ceil(mCSB_container[0].getBoundingClientRect().right+0.4)-Math.floor(mCSB_container[0].getBoundingClientRect().left)),
						"position":"relative"
					}).unwrap();
			}
		},
		/* -------------------- */
		
		
		/* adds scrollbar buttons */
		_scrollButtons=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				mCSB_scrollTools=$(".mCSB_"+d.idx+"_scrollbar:first"),
				tabindex=!_isNumeric(o.scrollButtons.tabindex) ? "" : "tabindex='"+o.scrollButtons.tabindex+"'",
				btnHTML=[
					"<a href='#' class='"+classes[13]+"' oncontextmenu='return false;' "+tabindex+" />",
					"<a href='#' class='"+classes[14]+"' oncontextmenu='return false;' "+tabindex+" />",
					"<a href='#' class='"+classes[15]+"' oncontextmenu='return false;' "+tabindex+" />",
					"<a href='#' class='"+classes[16]+"' oncontextmenu='return false;' "+tabindex+" />"
				],
				btn=[(o.axis==="x" ? btnHTML[2] : btnHTML[0]),(o.axis==="x" ? btnHTML[3] : btnHTML[1]),btnHTML[2],btnHTML[3]];
			if(o.scrollButtons.enable){
				mCSB_scrollTools.prepend(btn[0]).append(btn[1]).next(".mCSB_scrollTools").prepend(btn[2]).append(btn[3]);
			}
		},
		/* -------------------- */
		
		
		/* detects/sets css max-height value */
		_maxHeight=function(){
			var $this=$(this),d=$this.data(pluginPfx),
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mh=$this.css("max-height") || "none",pct=mh.indexOf("%")!==-1,
				bs=$this.css("box-sizing");
			if(mh!=="none"){
				var val=pct ? $this.parent().height()*parseInt(mh)/100 : parseInt(mh);
				/* if element's css box-sizing is "border-box", subtract any paddings and/or borders from max-height value */
				if(bs==="border-box"){val-=(($this.innerHeight()-$this.height())+($this.outerHeight()-$this.innerHeight()));}
				mCustomScrollBox.css("max-height",Math.round(val));
			}
		},
		/* -------------------- */
		
		
		/* auto-adjusts scrollbar dragger length */
		_setDraggerLength=function(){
			var $this=$(this),d=$this.data(pluginPfx),
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")],
				ratio=[mCustomScrollBox.height()/mCSB_container.outerHeight(false),mCustomScrollBox.width()/mCSB_container.outerWidth(false)],
				l=[
					parseInt(mCSB_dragger[0].css("min-height")),Math.round(ratio[0]*mCSB_dragger[0].parent().height()),
					parseInt(mCSB_dragger[1].css("min-width")),Math.round(ratio[1]*mCSB_dragger[1].parent().width())
				],
				h=oldIE && (l[1]<l[0]) ? l[0] : l[1],w=oldIE && (l[3]<l[2]) ? l[2] : l[3];
			mCSB_dragger[0].css({
				"height":h,"max-height":(mCSB_dragger[0].parent().height()-10)
			}).find(".mCSB_dragger_bar").css({"line-height":l[0]+"px"});
			mCSB_dragger[1].css({
				"width":w,"max-width":(mCSB_dragger[1].parent().width()-10)
			});
		},
		/* -------------------- */
		
		
		/* calculates scrollbar to content ratio */
		_scrollRatio=function(){
			var $this=$(this),d=$this.data(pluginPfx),
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")],
				scrollAmount=[mCSB_container.outerHeight(false)-mCustomScrollBox.height(),mCSB_container.outerWidth(false)-mCustomScrollBox.width()],
				ratio=[
					scrollAmount[0]/(mCSB_dragger[0].parent().height()-mCSB_dragger[0].height()),
					scrollAmount[1]/(mCSB_dragger[1].parent().width()-mCSB_dragger[1].width())
				];
			d.scrollRatio={y:ratio[0],x:ratio[1]};
		},
		/* -------------------- */
		
		
		/* toggles scrolling classes */
		_onDragClasses=function(el,action,xpnd){
			var expandClass=xpnd ? classes[0]+"_expanded" : "",
				scrollbar=el.closest(".mCSB_scrollTools");
			if(action==="active"){
				el.toggleClass(classes[0]+" "+expandClass); scrollbar.toggleClass(classes[1]); 
				el[0]._draggable=el[0]._draggable ? 0 : 1;
			}else{
				if(!el[0]._draggable){
					if(action==="hide"){
						el.removeClass(classes[0]); scrollbar.removeClass(classes[1]);
					}else{
						el.addClass(classes[0]); scrollbar.addClass(classes[1]);
					}
				}
			}
		},
		/* -------------------- */
		
		
		/* checks if content overflows its container to determine if scrolling is required */
		_overflowed=function(){
			var $this=$(this),d=$this.data(pluginPfx),
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				contentHeight=d.overflowed==null ? mCSB_container.height() : mCSB_container.outerHeight(false),
				contentWidth=d.overflowed==null ? mCSB_container.width() : mCSB_container.outerWidth(false);
			return [contentHeight>mCustomScrollBox.height(),contentWidth>mCustomScrollBox.width()];
		},
		/* -------------------- */
		
		
		/* resets content position to 0 */
		_resetContentPosition=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")];
			_stop($this); /* stop any current scrolling before resetting */
			if((o.axis!=="x" && !d.overflowed[0]) || (o.axis==="y" && d.overflowed[0])){ /* reset y */
				mCSB_dragger[0].add(mCSB_container).css("top",0);
				_scrollTo($this,"_resetY");
			}
			if((o.axis!=="y" && !d.overflowed[1]) || (o.axis==="x" && d.overflowed[1])){ /* reset x */
				var cx=dx=0;
				if(d.langDir==="rtl"){ /* adjust left position for rtl direction */
					cx=mCustomScrollBox.width()-mCSB_container.outerWidth(false);
					dx=Math.abs(cx/d.scrollRatio.x);
				}
				mCSB_container.css("left",cx);
				mCSB_dragger[1].css("left",dx);
				_scrollTo($this,"_resetX");
			}
		},
		/* -------------------- */
		
		
		/* binds scrollbar events */
		_bindEvents=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt;
			if(!d.bindEvents){ /* check if events are already bound */
				_draggable.call(this);
				if(o.contentTouchScroll){_contentDraggable.call(this);}
				_selectable.call(this);
				if(o.mouseWheel.enable){ /* bind mousewheel fn when plugin is available */
					function _mwt(){
						mousewheelTimeout=setTimeout(function(){
							if(!$.event.special.mousewheel){
								_mwt();
							}else{
								clearTimeout(mousewheelTimeout);
								_mousewheel.call($this[0]);
							}
						},100);
					}
					var mousewheelTimeout;
					_mwt();
				}
				_draggerRail.call(this);
				_wrapperScroll.call(this);
				if(o.advanced.autoScrollOnFocus){_focus.call(this);}
				if(o.scrollButtons.enable){_buttons.call(this);}
				if(o.keyboard.enable){_keyboard.call(this);}
				d.bindEvents=true;
			}
		},
		/* -------------------- */
		
		
		/* unbinds scrollbar events */
		_unbindEvents=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				namespace=pluginPfx+"_"+d.idx,
				sb=".mCSB_"+d.idx+"_scrollbar",
				sel=$("#mCSB_"+d.idx+",#mCSB_"+d.idx+"_container,#mCSB_"+d.idx+"_container_wrapper,"+sb+" ."+classes[12]+",#mCSB_"+d.idx+"_dragger_vertical,#mCSB_"+d.idx+"_dragger_horizontal,"+sb+">a"),
				mCSB_container=$("#mCSB_"+d.idx+"_container");
			if(o.advanced.releaseDraggableSelectors){sel.add($(o.advanced.releaseDraggableSelectors));}
			if(d.bindEvents){ /* check if events are bound */
				/* unbind namespaced events from document/selectors */
				$(document).unbind("."+namespace);
				sel.each(function(){
					$(this).unbind("."+namespace);
				});
				/* clear and delete timeouts/objects */
				clearTimeout($this[0]._focusTimeout); _delete($this[0],"_focusTimeout");
				clearTimeout(d.sequential.step); _delete(d.sequential,"step");
				clearTimeout(mCSB_container[0].onCompleteTimeout); _delete(mCSB_container[0],"onCompleteTimeout");
				d.bindEvents=false;
			}
		},
		/* -------------------- */
		
		
		/* toggles scrollbar visibility */
		_scrollbarVisibility=function(disabled){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				contentWrapper=$("#mCSB_"+d.idx+"_container_wrapper"),
				content=contentWrapper.length ? contentWrapper : $("#mCSB_"+d.idx+"_container"),
				scrollbar=[$("#mCSB_"+d.idx+"_scrollbar_vertical"),$("#mCSB_"+d.idx+"_scrollbar_horizontal")],
				mCSB_dragger=[scrollbar[0].find(".mCSB_dragger"),scrollbar[1].find(".mCSB_dragger")];
			if(o.axis!=="x"){
				if(d.overflowed[0] && !disabled){
					scrollbar[0].add(mCSB_dragger[0]).add(scrollbar[0].children("a")).css("display","block");
					content.removeClass(classes[8]+" "+classes[10]);
				}else{
					if(o.alwaysShowScrollbar){
						if(o.alwaysShowScrollbar!==2){mCSB_dragger[0].css("display","none");}
						content.removeClass(classes[10]);
					}else{
						scrollbar[0].css("display","none");
						content.addClass(classes[10]);
					}
					content.addClass(classes[8]);
				}
			}
			if(o.axis!=="y"){
				if(d.overflowed[1] && !disabled){
					scrollbar[1].add(mCSB_dragger[1]).add(scrollbar[1].children("a")).css("display","block");
					content.removeClass(classes[9]+" "+classes[11]);
				}else{
					if(o.alwaysShowScrollbar){
						if(o.alwaysShowScrollbar!==2){mCSB_dragger[1].css("display","none");}
						content.removeClass(classes[11]);
					}else{
						scrollbar[1].css("display","none");
						content.addClass(classes[11]);
					}
					content.addClass(classes[9]);
				}
			}
			if(!d.overflowed[0] && !d.overflowed[1]){
				$this.addClass(classes[5]);
			}else{
				$this.removeClass(classes[5]);
			}
		},
		/* -------------------- */
		
		
		/* returns input coordinates of pointer, touch and mouse events (relative to document) */
		_coordinates=function(e){
			var t=e.type;
			switch(t){
				case "pointerdown": case "MSPointerDown": case "pointermove": case "MSPointerMove": case "pointerup": case "MSPointerUp":
					return e.target.ownerDocument!==document ? [e.originalEvent.screenY,e.originalEvent.screenX,false] : [e.originalEvent.pageY,e.originalEvent.pageX,false];
					break;
				case "touchstart": case "touchmove": case "touchend":
					var touch=e.originalEvent.touches[0] || e.originalEvent.changedTouches[0],
						touches=e.originalEvent.touches.length || e.originalEvent.changedTouches.length;
					return e.target.ownerDocument!==document ? [touch.screenY,touch.screenX,touches>1] : [touch.pageY,touch.pageX,touches>1];
					break;
				default:
					return [e.pageY,e.pageX,false];
			}
		},
		/* -------------------- */
		
		
		/* 
		SCROLLBAR DRAG EVENTS
		scrolls content via scrollbar dragging 
		*/
		_draggable=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				namespace=pluginPfx+"_"+d.idx,
				draggerId=["mCSB_"+d.idx+"_dragger_vertical","mCSB_"+d.idx+"_dragger_horizontal"],
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				mCSB_dragger=$("#"+draggerId[0]+",#"+draggerId[1]),
				draggable,dragY,dragX,
				rds=o.advanced.releaseDraggableSelectors ? mCSB_dragger.add($(o.advanced.releaseDraggableSelectors)) : mCSB_dragger;
			mCSB_dragger.bind("mousedown."+namespace+" touchstart."+namespace+" pointerdown."+namespace+" MSPointerDown."+namespace,function(e){
				e.stopImmediatePropagation();
				e.preventDefault();
				if(!_mouseBtnLeft(e)){return;} /* left mouse button only */
				touchActive=true;
				if(oldIE){document.onselectstart=function(){return false;}} /* disable text selection for IE < 9 */
				_iframe(false); /* enable scrollbar dragging over iframes by disabling their events */
				_stop($this);
				draggable=$(this);
				var offset=draggable.offset(),y=_coordinates(e)[0]-offset.top,x=_coordinates(e)[1]-offset.left,
					h=draggable.height()+offset.top,w=draggable.width()+offset.left;
				if(y<h && y>0 && x<w && x>0){
					dragY=y; 
					dragX=x;
				}
				_onDragClasses(draggable,"active",o.autoExpandScrollbar); 
			}).bind("touchmove."+namespace,function(e){
				e.stopImmediatePropagation();
				e.preventDefault();
				var offset=draggable.offset(),y=_coordinates(e)[0]-offset.top,x=_coordinates(e)[1]-offset.left;
				_drag(dragY,dragX,y,x);
			});
			$(document).bind("mousemove."+namespace+" pointermove."+namespace+" MSPointerMove."+namespace,function(e){
				if(draggable){
					var offset=draggable.offset(),y=_coordinates(e)[0]-offset.top,x=_coordinates(e)[1]-offset.left;
					if(dragY===y){return;} /* has it really moved? */
					_drag(dragY,dragX,y,x);
				}
			}).add(rds).bind("mouseup."+namespace+" touchend."+namespace+" pointerup."+namespace+" MSPointerUp."+namespace,function(e){
				if(draggable){
					_onDragClasses(draggable,"active",o.autoExpandScrollbar); 
					draggable=null;
				}
				touchActive=false;
				if(oldIE){document.onselectstart=null;} /* enable text selection for IE < 9 */
				_iframe(true); /* enable iframes events */
			});
			function _iframe(evt){
				var el=mCSB_container.find("iframe");
				if(!el.length){return;} /* check if content contains iframes */
				var val=!evt ? "none" : "auto";
				el.css("pointer-events",val); /* for IE11, iframe's display property should not be "block" */
			}
			function _drag(dragY,dragX,y,x){
				mCSB_container[0].idleTimer=o.scrollInertia<233 ? 250 : 0;
				if(draggable.attr("id")===draggerId[1]){
					var dir="x",to=((draggable[0].offsetLeft-dragX)+x)*d.scrollRatio.x;
				}else{
					var dir="y",to=((draggable[0].offsetTop-dragY)+y)*d.scrollRatio.y;
				}
				_scrollTo($this,to.toString(),{dir:dir,drag:true});
			}
		},
		/* -------------------- */
		
		
		/* 
		TOUCH SWIPE EVENTS
		scrolls content via touch swipe 
		Emulates the native touch-swipe scrolling with momentum found in iOS, Android and WP devices 
		*/
		_contentDraggable=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				namespace=pluginPfx+"_"+d.idx,
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")],
				dragY,dragX,touchStartY,touchStartX,touchMoveY=[],touchMoveX=[],startTime,runningTime,endTime,distance,speed,amount,
				durA=0,durB,overwrite=o.axis==="yx" ? "none" : "all",touchIntent=[],touchDrag,docDrag,
				iframe=mCSB_container.find("iframe"),
				events=[
					"touchstart."+namespace+" pointerdown."+namespace+" MSPointerDown."+namespace, //start
					"touchmove."+namespace+" pointermove."+namespace+" MSPointerMove."+namespace, //move
					"touchend."+namespace+" pointerup."+namespace+" MSPointerUp."+namespace //end
				];
			mCSB_container.bind(events[0],function(e){
				_onTouchstart(e);
			}).bind(events[1],function(e){
				_onTouchmove(e);
			});
			mCustomScrollBox.bind(events[0],function(e){
				_onTouchstart2(e);
			}).bind(events[2],function(e){
				_onTouchend(e);
			});
			if(iframe.length){
				iframe.each(function(){
					$(this).load(function(){
						/* bind events on accessible iframes */
						if(_canAccessIFrame(this)){
							$(this.contentDocument || this.contentWindow.document).bind(events[0],function(e){
								_onTouchstart(e);
								_onTouchstart2(e);
							}).bind(events[1],function(e){
								_onTouchmove(e);
							}).bind(events[2],function(e){
								_onTouchend(e);
							});
						}
					});
				});
			}
			function _onTouchstart(e){
				if(!_pointerTouch(e) || touchActive || _coordinates(e)[2]){touchable=0; return;}
				touchable=1; touchDrag=0; docDrag=0;
				$this.removeClass("mCS_touch_action");
				var offset=mCSB_container.offset();
				dragY=_coordinates(e)[0]-offset.top;
				dragX=_coordinates(e)[1]-offset.left;
				touchIntent=[_coordinates(e)[0],_coordinates(e)[1]];
			}
			function _onTouchmove(e){
				if(!_pointerTouch(e) || touchActive || _coordinates(e)[2]){return;}
				e.stopImmediatePropagation();
				if(docDrag && !touchDrag){return;}
				runningTime=_getTime();
				var offset=mCustomScrollBox.offset(),y=_coordinates(e)[0]-offset.top,x=_coordinates(e)[1]-offset.left,
					easing="mcsLinearOut";
				touchMoveY.push(y);
				touchMoveX.push(x);
				touchIntent[2]=Math.abs(_coordinates(e)[0]-touchIntent[0]); touchIntent[3]=Math.abs(_coordinates(e)[1]-touchIntent[1]);
				if(d.overflowed[0]){
					var limit=mCSB_dragger[0].parent().height()-mCSB_dragger[0].height(),
						prevent=((dragY-y)>0 && (y-dragY)>-(limit*d.scrollRatio.y) && (touchIntent[3]*2<touchIntent[2] || o.axis==="yx"));
				}
				if(d.overflowed[1]){
					var limitX=mCSB_dragger[1].parent().width()-mCSB_dragger[1].width(),
						preventX=((dragX-x)>0 && (x-dragX)>-(limitX*d.scrollRatio.x) && (touchIntent[2]*2<touchIntent[3] || o.axis==="yx"));
				}
				if(prevent || preventX){ /* prevent native document scrolling */
					e.preventDefault(); 
					touchDrag=1;
				}else{
					docDrag=1;
					$this.addClass("mCS_touch_action");
				}
				amount=o.axis==="yx" ? [(dragY-y),(dragX-x)] : o.axis==="x" ? [null,(dragX-x)] : [(dragY-y),null];
				mCSB_container[0].idleTimer=250;
				if(d.overflowed[0]){_drag(amount[0],durA,easing,"y","all",true);}
				if(d.overflowed[1]){_drag(amount[1],durA,easing,"x",overwrite,true);}
			}
			function _onTouchstart2(e){
				if(!_pointerTouch(e) || touchActive || _coordinates(e)[2]){touchable=0; return;}
				touchable=1;
				e.stopImmediatePropagation();
				_stop($this);
				startTime=_getTime();
				var offset=mCustomScrollBox.offset();
				touchStartY=_coordinates(e)[0]-offset.top;
				touchStartX=_coordinates(e)[1]-offset.left;
				touchMoveY=[]; touchMoveX=[];
			}
			function _onTouchend(e){
				if(!_pointerTouch(e) || touchActive || _coordinates(e)[2]){return;}
				e.stopImmediatePropagation();
				touchDrag=0; docDrag=0;
				endTime=_getTime();
				var offset=mCustomScrollBox.offset(),y=_coordinates(e)[0]-offset.top,x=_coordinates(e)[1]-offset.left;
				if((endTime-runningTime)>30){return;}
				speed=1000/(endTime-startTime);
				var easing="mcsEaseOut",slow=speed<2.5,
					diff=slow ? [touchMoveY[touchMoveY.length-2],touchMoveX[touchMoveX.length-2]] : [0,0];
				distance=slow ? [(y-diff[0]),(x-diff[1])] : [y-touchStartY,x-touchStartX];
				var absDistance=[Math.abs(distance[0]),Math.abs(distance[1])];
				speed=slow ? [Math.abs(distance[0]/4),Math.abs(distance[1]/4)] : [speed,speed];
				var a=[
					Math.abs(mCSB_container[0].offsetTop)-(distance[0]*_m((absDistance[0]/speed[0]),speed[0])),
					Math.abs(mCSB_container[0].offsetLeft)-(distance[1]*_m((absDistance[1]/speed[1]),speed[1]))
				];
				amount=o.axis==="yx" ? [a[0],a[1]] : o.axis==="x" ? [null,a[1]] : [a[0],null];
				durB=[(absDistance[0]*4)+o.scrollInertia,(absDistance[1]*4)+o.scrollInertia];
				var md=parseInt(o.contentTouchScroll) || 0; /* absolute minimum distance required */
				amount[0]=absDistance[0]>md ? amount[0] : 0;
				amount[1]=absDistance[1]>md ? amount[1] : 0;
				if(d.overflowed[0]){_drag(amount[0],durB[0],easing,"y",overwrite,false);}
				if(d.overflowed[1]){_drag(amount[1],durB[1],easing,"x",overwrite,false);}
			}
			function _m(ds,s){
				var r=[s*1.5,s*2,s/1.5,s/2];
				if(ds>90){
					return s>4 ? r[0] : r[3];
				}else if(ds>60){
					return s>3 ? r[3] : r[2];
				}else if(ds>30){
					return s>8 ? r[1] : s>6 ? r[0] : s>4 ? s : r[2];
				}else{
					return s>8 ? s : r[3];
				}
			}
			function _drag(amount,dur,easing,dir,overwrite,drag){
				if(!amount){return;}
				_scrollTo($this,amount.toString(),{dur:dur,scrollEasing:easing,dir:dir,overwrite:overwrite,drag:drag});
			}
		},
		/* -------------------- */
		
		
		/* 
		SELECT TEXT EVENTS 
		scrolls content when text is selected 
		*/
		_selectable=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,seq=d.sequential,
				namespace=pluginPfx+"_"+d.idx,
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				wrapper=mCSB_container.parent(),
				action;
			mCSB_container.bind("mousedown."+namespace,function(e){
				if(touchable){return;}
				if(!action){action=1; touchActive=true;}
			}).add(document).bind("mousemove."+namespace,function(e){
				if(!touchable && action && _sel()){
					var offset=mCSB_container.offset(),
						y=_coordinates(e)[0]-offset.top+mCSB_container[0].offsetTop,x=_coordinates(e)[1]-offset.left+mCSB_container[0].offsetLeft;
					if(y>0 && y<wrapper.height() && x>0 && x<wrapper.width()){
						if(seq.step){_seq("off",null,"stepped");}
					}else{
						if(o.axis!=="x" && d.overflowed[0]){
							if(y<0){
								_seq("on",38);
							}else if(y>wrapper.height()){
								_seq("on",40);
							}
						}
						if(o.axis!=="y" && d.overflowed[1]){
							if(x<0){
								_seq("on",37);
							}else if(x>wrapper.width()){
								_seq("on",39);
							}
						}
					}
				}
			}).bind("mouseup."+namespace,function(e){
				if(touchable){return;}
				if(action){action=0; _seq("off",null);}
				touchActive=false;
			});
			function _sel(){
				return 	window.getSelection ? window.getSelection().toString() : 
						document.selection && document.selection.type!="Control" ? document.selection.createRange().text : 0;
			}
			function _seq(a,c,s){
				seq.type=s && action ? "stepped" : "stepless";
				seq.scrollAmount=10;
				_sequentialScroll($this,a,c,"mcsLinearOut",s ? 60 : null);
			}
		},
		/* -------------------- */
		
		
		/* 
		MOUSE WHEEL EVENT
		scrolls content via mouse-wheel 
		via mouse-wheel plugin (https://github.com/brandonaaron/jquery-mousewheel)
		*/
		_mousewheel=function(){
			if(!$(this).data(pluginPfx)){return;} /* Check if the scrollbar is ready to use mousewheel events (issue: #185) */
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				namespace=pluginPfx+"_"+d.idx,
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_dragger=[$("#mCSB_"+d.idx+"_dragger_vertical"),$("#mCSB_"+d.idx+"_dragger_horizontal")],
				iframe=$("#mCSB_"+d.idx+"_container").find("iframe");
			if(iframe.length){
				iframe.each(function(){
					$(this).load(function(){
						/* bind events on accessible iframes */
						if(_canAccessIFrame(this)){
							$(this.contentDocument || this.contentWindow.document).bind("mousewheel."+namespace,function(e,delta){
								_onMousewheel(e,delta);
							});
						}
					});
				});
			}
			mCustomScrollBox.bind("mousewheel."+namespace,function(e,delta){
				_onMousewheel(e,delta);
			});
			function _onMousewheel(e,delta){
				_stop($this);
				if(_disableMousewheel($this,e.target)){return;} /* disables mouse-wheel when hovering specific elements */
				var deltaFactor=o.mouseWheel.deltaFactor!=="auto" ? parseInt(o.mouseWheel.deltaFactor) : (oldIE && e.deltaFactor<100) ? 100 : e.deltaFactor || 100;
				if(o.axis==="x" || o.mouseWheel.axis==="x"){
					var dir="x",
						px=[Math.round(deltaFactor*d.scrollRatio.x),parseInt(o.mouseWheel.scrollAmount)],
						amount=o.mouseWheel.scrollAmount!=="auto" ? px[1] : px[0]>=mCustomScrollBox.width() ? mCustomScrollBox.width()*0.9 : px[0],
						contentPos=Math.abs($("#mCSB_"+d.idx+"_container")[0].offsetLeft),
						draggerPos=mCSB_dragger[1][0].offsetLeft,
						limit=mCSB_dragger[1].parent().width()-mCSB_dragger[1].width(),
						dlt=e.deltaX || e.deltaY || delta;
				}else{
					var dir="y",
						px=[Math.round(deltaFactor*d.scrollRatio.y),parseInt(o.mouseWheel.scrollAmount)],
						amount=o.mouseWheel.scrollAmount!=="auto" ? px[1] : px[0]>=mCustomScrollBox.height() ? mCustomScrollBox.height()*0.9 : px[0],
						contentPos=Math.abs($("#mCSB_"+d.idx+"_container")[0].offsetTop),
						draggerPos=mCSB_dragger[0][0].offsetTop,
						limit=mCSB_dragger[0].parent().height()-mCSB_dragger[0].height(),
						dlt=e.deltaY || delta;
				}
				if((dir==="y" && !d.overflowed[0]) || (dir==="x" && !d.overflowed[1])){return;}
				if(o.mouseWheel.invert || e.webkitDirectionInvertedFromDevice){dlt=-dlt;}
				if(o.mouseWheel.normalizeDelta){dlt=dlt<0 ? -1 : 1;}
				if((dlt>0 && draggerPos!==0) || (dlt<0 && draggerPos!==limit) || o.mouseWheel.preventDefault){
					e.stopImmediatePropagation();
					e.preventDefault();
				}
				_scrollTo($this,(contentPos-(dlt*amount)).toString(),{dir:dir});
			}
		},
		/* -------------------- */
		
		
		/* checks if iframe can be accessed */
		_canAccessIFrame=function(iframe){
			var html=null;
			try{
				var doc=iframe.contentDocument || iframe.contentWindow.document;
				html=doc.body.innerHTML;
			}catch(err){/* do nothing */}
			return(html!==null);
		},
		/* -------------------- */
		
		
		/* disables mouse-wheel when hovering specific elements like select, datalist etc. */
		_disableMousewheel=function(el,target){
			var tag=target.nodeName.toLowerCase(),
				tags=el.data(pluginPfx).opt.mouseWheel.disableOver,
				/* elements that require focus */
				focusTags=["select","textarea"];
			return $.inArray(tag,tags) > -1 && !($.inArray(tag,focusTags) > -1 && !$(target).is(":focus"));
		},
		/* -------------------- */
		
		
		/* 
		DRAGGER RAIL CLICK EVENT
		scrolls content via dragger rail 
		*/
		_draggerRail=function(){
			var $this=$(this),d=$this.data(pluginPfx),
				namespace=pluginPfx+"_"+d.idx,
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				wrapper=mCSB_container.parent(),
				mCSB_draggerContainer=$(".mCSB_"+d.idx+"_scrollbar ."+classes[12]);
			mCSB_draggerContainer.bind("touchstart."+namespace+" pointerdown."+namespace+" MSPointerDown."+namespace,function(e){
				touchActive=true;
			}).bind("touchend."+namespace+" pointerup."+namespace+" MSPointerUp."+namespace,function(e){
				touchActive=false;
			}).bind("click."+namespace,function(e){
				if($(e.target).hasClass(classes[12]) || $(e.target).hasClass("mCSB_draggerRail")){
					_stop($this);
					var el=$(this),mCSB_dragger=el.find(".mCSB_dragger");
					if(el.parent(".mCSB_scrollTools_horizontal").length>0){
						if(!d.overflowed[1]){return;}
						var dir="x",
							clickDir=e.pageX>mCSB_dragger.offset().left ? -1 : 1,
							to=Math.abs(mCSB_container[0].offsetLeft)-(clickDir*(wrapper.width()*0.9));
					}else{
						if(!d.overflowed[0]){return;}
						var dir="y",
							clickDir=e.pageY>mCSB_dragger.offset().top ? -1 : 1,
							to=Math.abs(mCSB_container[0].offsetTop)-(clickDir*(wrapper.height()*0.9));
					}
					_scrollTo($this,to.toString(),{dir:dir,scrollEasing:"mcsEaseInOut"});
				}
			});
		},
		/* -------------------- */
		
		
		/* 
		FOCUS EVENT
		scrolls content via element focus (e.g. clicking an input, pressing TAB key etc.)
		*/
		_focus=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				namespace=pluginPfx+"_"+d.idx,
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				wrapper=mCSB_container.parent();
			mCSB_container.bind("focusin."+namespace,function(e){
				var el=$(document.activeElement),
					nested=mCSB_container.find(".mCustomScrollBox").length,
					dur=0;
				if(!el.is(o.advanced.autoScrollOnFocus)){return;}
				_stop($this);
				clearTimeout($this[0]._focusTimeout);
				$this[0]._focusTimer=nested ? (dur+17)*nested : 0;
				$this[0]._focusTimeout=setTimeout(function(){
					var	to=[_childPos(el)[0],_childPos(el)[1]],
						contentPos=[mCSB_container[0].offsetTop,mCSB_container[0].offsetLeft],
						isVisible=[
							(contentPos[0]+to[0]>=0 && contentPos[0]+to[0]<wrapper.height()-el.outerHeight(false)),
							(contentPos[1]+to[1]>=0 && contentPos[0]+to[1]<wrapper.width()-el.outerWidth(false))
						],
						overwrite=(o.axis==="yx" && !isVisible[0] && !isVisible[1]) ? "none" : "all";
					if(o.axis!=="x" && !isVisible[0]){
						_scrollTo($this,to[0].toString(),{dir:"y",scrollEasing:"mcsEaseInOut",overwrite:overwrite,dur:dur});
					}
					if(o.axis!=="y" && !isVisible[1]){
						_scrollTo($this,to[1].toString(),{dir:"x",scrollEasing:"mcsEaseInOut",overwrite:overwrite,dur:dur});
					}
				},$this[0]._focusTimer);
			});
		},
		/* -------------------- */
		
		
		/* sets content wrapper scrollTop/scrollLeft always to 0 */
		_wrapperScroll=function(){
			var $this=$(this),d=$this.data(pluginPfx),
				namespace=pluginPfx+"_"+d.idx,
				wrapper=$("#mCSB_"+d.idx+"_container").parent();
			wrapper.bind("scroll."+namespace,function(e){
				if(wrapper.scrollTop()!==0 || wrapper.scrollLeft()!==0){
					$(".mCSB_"+d.idx+"_scrollbar").css("visibility","hidden"); /* hide scrollbar(s) */
				}
			});
		},
		/* -------------------- */
		
		
		/* 
		BUTTONS EVENTS
		scrolls content via up, down, left and right buttons 
		*/
		_buttons=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,seq=d.sequential,
				namespace=pluginPfx+"_"+d.idx,
				sel=".mCSB_"+d.idx+"_scrollbar",
				btn=$(sel+">a");
			btn.bind("mousedown."+namespace+" touchstart."+namespace+" pointerdown."+namespace+" MSPointerDown."+namespace+" mouseup."+namespace+" touchend."+namespace+" pointerup."+namespace+" MSPointerUp."+namespace+" mouseout."+namespace+" pointerout."+namespace+" MSPointerOut."+namespace+" click."+namespace,function(e){
				e.preventDefault();
				if(!_mouseBtnLeft(e)){return;} /* left mouse button only */
				var btnClass=$(this).attr("class");
				seq.type=o.scrollButtons.scrollType;
				switch(e.type){
					case "mousedown": case "touchstart": case "pointerdown": case "MSPointerDown":
						if(seq.type==="stepped"){return;}
						touchActive=true;
						d.tweenRunning=false;
						_seq("on",btnClass);
						break;
					case "mouseup": case "touchend": case "pointerup": case "MSPointerUp":
					case "mouseout": case "pointerout": case "MSPointerOut":
						if(seq.type==="stepped"){return;}
						touchActive=false;
						if(seq.dir){_seq("off",btnClass);}
						break;
					case "click":
						if(seq.type!=="stepped" || d.tweenRunning){return;}
						_seq("on",btnClass);
						break;
				}
				function _seq(a,c){
					seq.scrollAmount=o.snapAmount || o.scrollButtons.scrollAmount;
					_sequentialScroll($this,a,c);
				}
			});
		},
		/* -------------------- */
		
		
		/* 
		KEYBOARD EVENTS
		scrolls content via keyboard 
		Keys: up arrow, down arrow, left arrow, right arrow, PgUp, PgDn, Home, End
		*/
		_keyboard=function(){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,seq=d.sequential,
				namespace=pluginPfx+"_"+d.idx,
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				wrapper=mCSB_container.parent(),
				editables="input,textarea,select,datalist,keygen,[contenteditable='true']",
				iframe=mCSB_container.find("iframe"),
				events=["blur."+namespace+" keydown."+namespace+" keyup."+namespace];
			if(iframe.length){
				iframe.each(function(){
					$(this).load(function(){
						/* bind events on accessible iframes */
						if(_canAccessIFrame(this)){
							$(this.contentDocument || this.contentWindow.document).bind(events[0],function(e){
								_onKeyboard(e);
							});
						}
					});
				});
			}
			mCustomScrollBox.attr("tabindex","0").bind(events[0],function(e){
				_onKeyboard(e);
			});
			function _onKeyboard(e){
				switch(e.type){
					case "blur":
						if(d.tweenRunning && seq.dir){_seq("off",null);}
						break;
					case "keydown": case "keyup":
						var code=e.keyCode ? e.keyCode : e.which,action="on";
						if((o.axis!=="x" && (code===38 || code===40)) || (o.axis!=="y" && (code===37 || code===39))){
							/* up (38), down (40), left (37), right (39) arrows */
							if(((code===38 || code===40) && !d.overflowed[0]) || ((code===37 || code===39) && !d.overflowed[1])){return;}
							if(e.type==="keyup"){action="off";}
							if(!$(document.activeElement).is(editables)){
								e.preventDefault();
								e.stopImmediatePropagation();
								_seq(action,code);
							}
						}else if(code===33 || code===34){
							/* PgUp (33), PgDn (34) */
							if(d.overflowed[0] || d.overflowed[1]){
								e.preventDefault();
								e.stopImmediatePropagation();
							}
							if(e.type==="keyup"){
								_stop($this);
								var keyboardDir=code===34 ? -1 : 1;
								if(o.axis==="x" || (o.axis==="yx" && d.overflowed[1] && !d.overflowed[0])){
									var dir="x",to=Math.abs(mCSB_container[0].offsetLeft)-(keyboardDir*(wrapper.width()*0.9));
								}else{
									var dir="y",to=Math.abs(mCSB_container[0].offsetTop)-(keyboardDir*(wrapper.height()*0.9));
								}
								_scrollTo($this,to.toString(),{dir:dir,scrollEasing:"mcsEaseInOut"});
							}
						}else if(code===35 || code===36){
							/* End (35), Home (36) */
							if(!$(document.activeElement).is(editables)){
								if(d.overflowed[0] || d.overflowed[1]){
									e.preventDefault();
									e.stopImmediatePropagation();
								}
								if(e.type==="keyup"){
									if(o.axis==="x" || (o.axis==="yx" && d.overflowed[1] && !d.overflowed[0])){
										var dir="x",to=code===35 ? Math.abs(wrapper.width()-mCSB_container.outerWidth(false)) : 0;
									}else{
										var dir="y",to=code===35 ? Math.abs(wrapper.height()-mCSB_container.outerHeight(false)) : 0;
									}
									_scrollTo($this,to.toString(),{dir:dir,scrollEasing:"mcsEaseInOut"});
								}
							}
						}
						break;
				}
				function _seq(a,c){
					seq.type=o.keyboard.scrollType;
					seq.scrollAmount=o.snapAmount || o.keyboard.scrollAmount;
					if(seq.type==="stepped" && d.tweenRunning){return;}
					_sequentialScroll($this,a,c);
				}
			}
		},
		/* -------------------- */
		
		
		/* scrolls content sequentially (used when scrolling via buttons, keyboard arrows etc.) */
		_sequentialScroll=function(el,action,trigger,e,s){
			var d=el.data(pluginPfx),o=d.opt,seq=d.sequential,
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				once=seq.type==="stepped" ? true : false,
				steplessSpeed=o.scrollInertia < 26 ? 26 : o.scrollInertia, /* 26/1.5=17 */
				steppedSpeed=o.scrollInertia < 1 ? 17 : o.scrollInertia;
			switch(action){
				case "on":
					seq.dir=[
						(trigger===classes[16] || trigger===classes[15] || trigger===39 || trigger===37 ? "x" : "y"),
						(trigger===classes[13] || trigger===classes[15] || trigger===38 || trigger===37 ? -1 : 1)
					];
					_stop(el);
					if(_isNumeric(trigger) && seq.type==="stepped"){return;}
					_on(once);
					break;
				case "off":
					_off();
					if(once || (d.tweenRunning && seq.dir)){
						_on(true);
					}
					break;
			}
			/* starts sequence */
			function _on(once){
				var c=seq.type!=="stepped", /* continuous scrolling */
					t=s ? s : !once ? 1000/60 : c ? steplessSpeed/1.5 : steppedSpeed, /* timer */
					m=!once ? 2.5 : c ? 7.5 : 40, /* multiplier */
					contentPos=[Math.abs(mCSB_container[0].offsetTop),Math.abs(mCSB_container[0].offsetLeft)],
					ratio=[d.scrollRatio.y>10 ? 10 : d.scrollRatio.y,d.scrollRatio.x>10 ? 10 : d.scrollRatio.x],
					amount=seq.dir[0]==="x" ? contentPos[1]+(seq.dir[1]*(ratio[1]*m)) : contentPos[0]+(seq.dir[1]*(ratio[0]*m)),
					px=seq.dir[0]==="x" ? contentPos[1]+(seq.dir[1]*parseInt(seq.scrollAmount)) : contentPos[0]+(seq.dir[1]*parseInt(seq.scrollAmount)),
					to=seq.scrollAmount!=="auto" ? px : amount,
					easing=e ? e : !once ? "mcsLinear" : c ? "mcsLinearOut" : "mcsEaseInOut",
					onComplete=!once ? false : true;
				if(once && t<17){
					to=seq.dir[0]==="x" ? contentPos[1] : contentPos[0];
				}
				_scrollTo(el,to.toString(),{dir:seq.dir[0],scrollEasing:easing,dur:t,onComplete:onComplete});
				if(once){
					seq.dir=false;
					return;
				}
				clearTimeout(seq.step);
				seq.step=setTimeout(function(){
					_on();
				},t);
			}
			/* stops sequence */
			function _off(){
				clearTimeout(seq.step);
				_delete(seq,"step");
				_stop(el);
			}
		},
		/* -------------------- */
		
		
		/* returns a yx array from value */
		_arr=function(val){
			var o=$(this).data(pluginPfx).opt,vals=[];
			if(typeof val==="function"){val=val();} /* check if the value is a single anonymous function */
			/* check if value is object or array, its length and create an array with yx values */
			if(!(val instanceof Array)){ /* object value (e.g. {y:"100",x:"100"}, 100 etc.) */
				vals[0]=val.y ? val.y : val.x || o.axis==="x" ? null : val;
				vals[1]=val.x ? val.x : val.y || o.axis==="y" ? null : val;
			}else{ /* array value (e.g. [100,100]) */
				vals=val.length>1 ? [val[0],val[1]] : o.axis==="x" ? [null,val[0]] : [val[0],null];
			}
			/* check if array values are anonymous functions */
			if(typeof vals[0]==="function"){vals[0]=vals[0]();}
			if(typeof vals[1]==="function"){vals[1]=vals[1]();}
			return vals;
		},
		/* -------------------- */
		
		
		/* translates values (e.g. "top", 100, "100px", "#id") to actual scroll-to positions */
		_to=function(val,dir){
			if(val==null || typeof val=="undefined"){return;}
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				wrapper=mCSB_container.parent(),
				t=typeof val;
			if(!dir){dir=o.axis==="x" ? "x" : "y";}
			var contentLength=dir==="x" ? mCSB_container.outerWidth(false) : mCSB_container.outerHeight(false),
				contentPos=dir==="x" ? mCSB_container[0].offsetLeft : mCSB_container[0].offsetTop,
				cssProp=dir==="x" ? "left" : "top";
			switch(t){
				case "function": /* this currently is not used. Consider removing it */
					return val();
					break;
				case "object": /* js/jquery object */
					var obj=val.jquery ? val : $(val);
					if(!obj.length){return;}
					return dir==="x" ? _childPos(obj)[1] : _childPos(obj)[0];
					break;
				case "string": case "number":
					if(_isNumeric(val)){ /* numeric value */
						return Math.abs(val);
					}else if(val.indexOf("%")!==-1){ /* percentage value */
						return Math.abs(contentLength*parseInt(val)/100);
					}else if(val.indexOf("-=")!==-1){ /* decrease value */
						return Math.abs(contentPos-parseInt(val.split("-=")[1]));
					}else if(val.indexOf("+=")!==-1){ /* inrease value */
						var p=(contentPos+parseInt(val.split("+=")[1]));
						return p>=0 ? 0 : Math.abs(p);
					}else if(val.indexOf("px")!==-1 && _isNumeric(val.split("px")[0])){ /* pixels string value (e.g. "100px") */
						return Math.abs(val.split("px")[0]);
					}else{
						if(val==="top" || val==="left"){ /* special strings */
							return 0;
						}else if(val==="bottom"){
							return Math.abs(wrapper.height()-mCSB_container.outerHeight(false));
						}else if(val==="right"){
							return Math.abs(wrapper.width()-mCSB_container.outerWidth(false));
						}else if(val==="first" || val==="last"){
							var obj=mCSB_container.find(":"+val);
							return dir==="x" ? _childPos(obj)[1] : _childPos(obj)[0];
						}else{
							if($(val).length){ /* jquery selector */
								return dir==="x" ? _childPos($(val))[1] : _childPos($(val))[0];
							}else{ /* other values (e.g. "100em") */
								mCSB_container.css(cssProp,val);
								methods.update.call(null,$this[0]);
								return;
							}
						}
					}
					break;
			}
		},
		/* -------------------- */
		
		
		/* calls the update method automatically */
		_autoUpdate=function(rem){
			var $this=$(this),d=$this.data(pluginPfx),o=d.opt,
				mCSB_container=$("#mCSB_"+d.idx+"_container");
			if(rem){
				/* 
				removes autoUpdate timer 
				usage: _autoUpdate.call(this,"remove");
				*/
				clearTimeout(mCSB_container[0].autoUpdate);
				_delete(mCSB_container[0],"autoUpdate");
				return;
			}
			var	wrapper=mCSB_container.parent(),
				scrollbar=[$("#mCSB_"+d.idx+"_scrollbar_vertical"),$("#mCSB_"+d.idx+"_scrollbar_horizontal")],
				scrollbarSize=function(){return [
					scrollbar[0].is(":visible") ? scrollbar[0].outerHeight(true) : 0, /* returns y-scrollbar height */
					scrollbar[1].is(":visible") ? scrollbar[1].outerWidth(true) : 0 /* returns x-scrollbar width */
				]},
				oldSelSize=sizesSum(),newSelSize,
				os=[mCSB_container.outerHeight(false),mCSB_container.outerWidth(false),wrapper.height(),wrapper.width(),scrollbarSize()[0],scrollbarSize()[1]],ns,
				oldImgsLen=imgSum(),newImgsLen;
			upd();
			function upd(){
				clearTimeout(mCSB_container[0].autoUpdate);
				if($this.parents("html").length===0){
					/* check element in dom tree */
					$this=null;
					return;
				}
				mCSB_container[0].autoUpdate=setTimeout(function(){
					/* update on specific selector(s) length and size change */
					if(o.advanced.updateOnSelectorChange){
						newSelSize=sizesSum();
						if(newSelSize!==oldSelSize){
							doUpd(3);
							oldSelSize=newSelSize;
							return;
						}
					}
					/* update on main element and scrollbar size changes */
					if(o.advanced.updateOnContentResize){
						ns=[mCSB_container.outerHeight(false),mCSB_container.outerWidth(false),wrapper.height(),wrapper.width(),scrollbarSize()[0],scrollbarSize()[1]];
						if(ns[0]!==os[0] || ns[1]!==os[1] || ns[2]!==os[2] || ns[3]!==os[3] || ns[4]!==os[4] || ns[5]!==os[5]){
							doUpd(ns[0]!==os[0] || ns[1]!==os[1]);
							os=ns;
						}
					}
					/* update on image load */
					if(o.advanced.updateOnImageLoad){
						newImgsLen=imgSum();
						if(newImgsLen!==oldImgsLen){
							mCSB_container.find("img").each(function(){
								imgLoader(this);
							});
							oldImgsLen=newImgsLen;
						}
					}
					if(o.advanced.updateOnSelectorChange || o.advanced.updateOnContentResize || o.advanced.updateOnImageLoad){upd();}
				},o.advanced.autoUpdateTimeout);
			}
			/* returns images amount */
			function imgSum(){
				var total=0
				if(o.advanced.updateOnImageLoad){total=mCSB_container.find("img").length;}
				return total;
			}
			/* a tiny image loader */
			function imgLoader(el){
				if($(el).hasClass(classes[2])){doUpd(); return;}
				var img=new Image();
				function createDelegate(contextObject,delegateMethod){
					return function(){return delegateMethod.apply(contextObject,arguments);}
				}
				function imgOnLoad(){
					this.onload=null;
					$(el).addClass(classes[2]);
					doUpd(2);
				}
				img.onload=createDelegate(img,imgOnLoad);
				img.src=el.src;
			}
			/* returns the total height and width sum of all elements matching the selector */
			function sizesSum(){
				if(o.advanced.updateOnSelectorChange===true){o.advanced.updateOnSelectorChange="*";}
				var total=0,sel=mCSB_container.find(o.advanced.updateOnSelectorChange);
				if(o.advanced.updateOnSelectorChange && sel.length>0){sel.each(function(){total+=$(this).height()+$(this).width();});}
				return total;
			}
			/* calls the update method */
			function doUpd(cb){
				clearTimeout(mCSB_container[0].autoUpdate); 
				methods.update.call(null,$this[0],cb);
			}
		},
		/* -------------------- */
		
		
		/* snaps scrolling to a multiple of a pixels number */
		_snapAmount=function(to,amount,offset){
			return (Math.round(to/amount)*amount-offset); 
		},
		/* -------------------- */
		
		
		/* stops content and scrollbar animations */
		_stop=function(el){
			var d=el.data(pluginPfx),
				sel=$("#mCSB_"+d.idx+"_container,#mCSB_"+d.idx+"_container_wrapper,#mCSB_"+d.idx+"_dragger_vertical,#mCSB_"+d.idx+"_dragger_horizontal");
			sel.each(function(){
				_stopTween.call(this);
			});
		},
		/* -------------------- */
		
		
		/* 
		ANIMATES CONTENT 
		This is where the actual scrolling happens
		*/
		_scrollTo=function(el,to,options){
			var d=el.data(pluginPfx),o=d.opt,
				defaults={
					trigger:"internal",
					dir:"y",
					scrollEasing:"mcsEaseOut",
					drag:false,
					dur:o.scrollInertia,
					overwrite:"all",
					callbacks:true,
					onStart:true,
					onUpdate:true,
					onComplete:true
				},
				options=$.extend(defaults,options),
				dur=[options.dur,(options.drag ? 0 : options.dur)],
				mCustomScrollBox=$("#mCSB_"+d.idx),
				mCSB_container=$("#mCSB_"+d.idx+"_container"),
				wrapper=mCSB_container.parent(),
				totalScrollOffsets=o.callbacks.onTotalScrollOffset ? _arr.call(el,o.callbacks.onTotalScrollOffset) : [0,0],
				totalScrollBackOffsets=o.callbacks.onTotalScrollBackOffset ? _arr.call(el,o.callbacks.onTotalScrollBackOffset) : [0,0];
			d.trigger=options.trigger;
			if(wrapper.scrollTop()!==0 || wrapper.scrollLeft()!==0){ /* always reset scrollTop/Left */
				$(".mCSB_"+d.idx+"_scrollbar").css("visibility","visible");
				wrapper.scrollTop(0).scrollLeft(0);
			}
			if(to==="_resetY" && !d.contentReset.y){
				/* callbacks: onOverflowYNone */
				if(_cb("onOverflowYNone")){o.callbacks.onOverflowYNone.call(el[0]);}
				d.contentReset.y=1;
			}
			if(to==="_resetX" && !d.contentReset.x){
				/* callbacks: onOverflowXNone */
				if(_cb("onOverflowXNone")){o.callbacks.onOverflowXNone.call(el[0]);}
				d.contentReset.x=1;
			}
			if(to==="_resetY" || to==="_resetX"){return;}
			if((d.contentReset.y || !el[0].mcs) && d.overflowed[0]){
				/* callbacks: onOverflowY */
				if(_cb("onOverflowY")){o.callbacks.onOverflowY.call(el[0]);}
				d.contentReset.x=null;
			}
			if((d.contentReset.x || !el[0].mcs) && d.overflowed[1]){
				/* callbacks: onOverflowX */
				if(_cb("onOverflowX")){o.callbacks.onOverflowX.call(el[0]);}
				d.contentReset.x=null;
			}
			if(o.snapAmount){to=_snapAmount(to,o.snapAmount,o.snapOffset);} /* scrolling snapping */
			switch(options.dir){
				case "x":
					var mCSB_dragger=$("#mCSB_"+d.idx+"_dragger_horizontal"),
						property="left",
						contentPos=mCSB_container[0].offsetLeft,
						limit=[
							mCustomScrollBox.width()-mCSB_container.outerWidth(false),
							mCSB_dragger.parent().width()-mCSB_dragger.width()
						],
						scrollTo=[to,to===0 ? 0 : (to/d.scrollRatio.x)],
						tso=totalScrollOffsets[1],
						tsbo=totalScrollBackOffsets[1],
						totalScrollOffset=tso>0 ? tso/d.scrollRatio.x : 0,
						totalScrollBackOffset=tsbo>0 ? tsbo/d.scrollRatio.x : 0;
					break;
				case "y":
					var mCSB_dragger=$("#mCSB_"+d.idx+"_dragger_vertical"),
						property="top",
						contentPos=mCSB_container[0].offsetTop,
						limit=[
							mCustomScrollBox.height()-mCSB_container.outerHeight(false),
							mCSB_dragger.parent().height()-mCSB_dragger.height()
						],
						scrollTo=[to,to===0 ? 0 : (to/d.scrollRatio.y)],
						tso=totalScrollOffsets[0],
						tsbo=totalScrollBackOffsets[0],
						totalScrollOffset=tso>0 ? tso/d.scrollRatio.y : 0,
						totalScrollBackOffset=tsbo>0 ? tsbo/d.scrollRatio.y : 0;
					break;
			}
			if(scrollTo[1]<0 || (scrollTo[0]===0 && scrollTo[1]===0)){
				scrollTo=[0,0];
			}else if(scrollTo[1]>=limit[1]){
				scrollTo=[limit[0],limit[1]];
			}else{
				scrollTo[0]=-scrollTo[0];
			}
			if(!el[0].mcs){
				_mcs();  /* init mcs object (once) to make it available before callbacks */
				if(_cb("onInit")){o.callbacks.onInit.call(el[0]);} /* callbacks: onInit */
			}
			clearTimeout(mCSB_container[0].onCompleteTimeout);
			if(!d.tweenRunning && ((contentPos===0 && scrollTo[0]>=0) || (contentPos===limit[0] && scrollTo[0]<=limit[0]))){return;}
			_tweenTo(mCSB_dragger[0],property,Math.round(scrollTo[1]),dur[1],options.scrollEasing);
			_tweenTo(mCSB_container[0],property,Math.round(scrollTo[0]),dur[0],options.scrollEasing,options.overwrite,{
				onStart:function(){
					if(options.callbacks && options.onStart && !d.tweenRunning){
						/* callbacks: onScrollStart */
						if(_cb("onScrollStart")){_mcs(); o.callbacks.onScrollStart.call(el[0]);}
						d.tweenRunning=true;
						_onDragClasses(mCSB_dragger);
						d.cbOffsets=_cbOffsets();
					}
				},onUpdate:function(){
					if(options.callbacks && options.onUpdate){
						/* callbacks: whileScrolling */
						if(_cb("whileScrolling")){_mcs(); o.callbacks.whileScrolling.call(el[0]);}
					}
				},onComplete:function(){
					if(options.callbacks && options.onComplete){
						if(o.axis==="yx"){clearTimeout(mCSB_container[0].onCompleteTimeout);}
						var t=mCSB_container[0].idleTimer || 0;
						mCSB_container[0].onCompleteTimeout=setTimeout(function(){
							/* callbacks: onScroll, onTotalScroll, onTotalScrollBack */
							if(_cb("onScroll")){_mcs(); o.callbacks.onScroll.call(el[0]);}
							if(_cb("onTotalScroll") && scrollTo[1]>=limit[1]-totalScrollOffset && d.cbOffsets[0]){_mcs(); o.callbacks.onTotalScroll.call(el[0]);}
							if(_cb("onTotalScrollBack") && scrollTo[1]<=totalScrollBackOffset && d.cbOffsets[1]){_mcs(); o.callbacks.onTotalScrollBack.call(el[0]);}
							d.tweenRunning=false;
							mCSB_container[0].idleTimer=0;
							_onDragClasses(mCSB_dragger,"hide");
						},t);
					}
				}
			});
			/* checks if callback function exists */
			function _cb(cb){
				return d && o.callbacks[cb] && typeof o.callbacks[cb]==="function";
			}
			/* checks whether callback offsets always trigger */
			function _cbOffsets(){
				return [o.callbacks.alwaysTriggerOffsets || contentPos>=limit[0]+tso,o.callbacks.alwaysTriggerOffsets || contentPos<=-tsbo];
			}
			/* 
			populates object with useful values for the user 
			values: 
				content: this.mcs.content
				content top position: this.mcs.top 
				content left position: this.mcs.left 
				dragger top position: this.mcs.draggerTop 
				dragger left position: this.mcs.draggerLeft 
				scrolling y percentage: this.mcs.topPct 
				scrolling x percentage: this.mcs.leftPct 
				scrolling direction: this.mcs.direction
			*/
			function _mcs(){
				var cp=[mCSB_container[0].offsetTop,mCSB_container[0].offsetLeft], /* content position */
					dp=[mCSB_dragger[0].offsetTop,mCSB_dragger[0].offsetLeft], /* dragger position */
					cl=[mCSB_container.outerHeight(false),mCSB_container.outerWidth(false)], /* content length */
					pl=[mCustomScrollBox.height(),mCustomScrollBox.width()]; /* content parent length */
				el[0].mcs={
					content:mCSB_container, /* original content wrapper as jquery object */
					top:cp[0],left:cp[1],draggerTop:dp[0],draggerLeft:dp[1],
					topPct:Math.round((100*Math.abs(cp[0]))/(Math.abs(cl[0])-pl[0])),leftPct:Math.round((100*Math.abs(cp[1]))/(Math.abs(cl[1])-pl[1])),
					direction:options.dir
				};
				/* 
				this refers to the original element containing the scrollbar(s)
				usage: this.mcs.top, this.mcs.leftPct etc. 
				*/
			}
		},
		/* -------------------- */
		
		
		/* 
		CUSTOM JAVASCRIPT ANIMATION TWEEN 
		Lighter and faster than jquery animate() and css transitions 
		Animates top/left properties and includes easings 
		*/
		_tweenTo=function(el,prop,to,duration,easing,overwrite,callbacks){
			if(!el._mTween){el._mTween={top:{},left:{}};}
			var callbacks=callbacks || {},
				onStart=callbacks.onStart || function(){},onUpdate=callbacks.onUpdate || function(){},onComplete=callbacks.onComplete || function(){},
				startTime=_getTime(),_delay,progress=0,from=el.offsetTop,elStyle=el.style,_request,tobj=el._mTween[prop];
			if(prop==="left"){from=el.offsetLeft;}
			var diff=to-from;
			tobj.stop=0;
			if(overwrite!=="none"){_cancelTween();}
			_startTween();
			function _step(){
				if(tobj.stop){return;}
				if(!progress){onStart.call();}
				progress=_getTime()-startTime;
				_tween();
				if(progress>=tobj.time){
					tobj.time=(progress>tobj.time) ? progress+_delay-(progress-tobj.time) : progress+_delay-1;
					if(tobj.time<progress+1){tobj.time=progress+1;}
				}
				if(tobj.time<duration){tobj.id=_request(_step);}else{onComplete.call();}
			}
			function _tween(){
				if(duration>0){
					tobj.currVal=_ease(tobj.time,from,diff,duration,easing);
					elStyle[prop]=Math.round(tobj.currVal)+"px";
				}else{
					elStyle[prop]=to+"px";
				}
				onUpdate.call();
			}
			function _startTween(){
				_delay=1000/60;
				tobj.time=progress+_delay;
				_request=(!window.requestAnimationFrame) ? function(f){_tween(); return setTimeout(f,0.01);} : window.requestAnimationFrame;
				tobj.id=_request(_step);
			}
			function _cancelTween(){
				if(tobj.id==null){return;}
				if(!window.requestAnimationFrame){clearTimeout(tobj.id);
				}else{window.cancelAnimationFrame(tobj.id);}
				tobj.id=null;
			}
			function _ease(t,b,c,d,type){
				switch(type){
					case "linear": case "mcsLinear":
						return c*t/d + b;
						break;
					case "mcsLinearOut":
						t/=d; t--; return c * Math.sqrt(1 - t*t) + b;
						break;
					case "easeInOutSmooth":
						t/=d/2;
						if(t<1) return c/2*t*t + b;
						t--;
						return -c/2 * (t*(t-2) - 1) + b;
						break;
					case "easeInOutStrong":
						t/=d/2;
						if(t<1) return c/2 * Math.pow( 2, 10 * (t - 1) ) + b;
						t--;
						return c/2 * ( -Math.pow( 2, -10 * t) + 2 ) + b;
						break;
					case "easeInOut": case "mcsEaseInOut":
						t/=d/2;
						if(t<1) return c/2*t*t*t + b;
						t-=2;
						return c/2*(t*t*t + 2) + b;
						break;
					case "easeOutSmooth":
						t/=d; t--;
						return -c * (t*t*t*t - 1) + b;
						break;
					case "easeOutStrong":
						return c * ( -Math.pow( 2, -10 * t/d ) + 1 ) + b;
						break;
					case "easeOut": case "mcsEaseOut": default:
						var ts=(t/=d)*t,tc=ts*t;
						return b+c*(0.499999999999997*tc*ts + -2.5*ts*ts + 5.5*tc + -6.5*ts + 4*t);
				}
			}
		},
		/* -------------------- */
		
		
		/* returns current time */
		_getTime=function(){
			if(window.performance && window.performance.now){
				return window.performance.now();
			}else{
				if(window.performance && window.performance.webkitNow){
					return window.performance.webkitNow();
				}else{
					if(Date.now){return Date.now();}else{return new Date().getTime();}
				}
			}
		},
		/* -------------------- */
		
		
		/* stops a tween */
		_stopTween=function(){
			var el=this;
			if(!el._mTween){el._mTween={top:{},left:{}};}
			var props=["top","left"];
			for(var i=0; i<props.length; i++){
				var prop=props[i];
				if(el._mTween[prop].id){
					if(!window.requestAnimationFrame){clearTimeout(el._mTween[prop].id);
					}else{window.cancelAnimationFrame(el._mTween[prop].id);}
					el._mTween[prop].id=null;
					el._mTween[prop].stop=1;
				}
			}
		},
		/* -------------------- */
		
		
		/* deletes a property (avoiding the exception thrown by IE) */
		_delete=function(c,m){
			try{delete c[m];}catch(e){c[m]=null;}
		},
		/* -------------------- */
		
		
		/* detects left mouse button */
		_mouseBtnLeft=function(e){
			return !(e.which && e.which!==1);
		},
		/* -------------------- */
		
		
		/* detects if pointer type event is touch */
		_pointerTouch=function(e){
			var t=e.originalEvent.pointerType;
			return !(t && t!=="touch" && t!==2);
		},
		/* -------------------- */
		
		
		/* checks if value is numeric */
		_isNumeric=function(val){
			return !isNaN(parseFloat(val)) && isFinite(val);
		},
		/* -------------------- */
		
		
		/* returns element position according to content */
		_childPos=function(el){
			var p=el.parents(".mCSB_container");
			return [el.offset().top-p.offset().top,el.offset().left-p.offset().left];
		};
		/* -------------------- */
		
	
	
	
	
	/* 
	----------------------------------------
	PLUGIN SETUP 
	----------------------------------------
	*/
	
	/* plugin constructor functions */
	$.fn[pluginNS]=function(method){ /* usage: $(selector).mCustomScrollbar(); */
		if(methods[method]){
			return methods[method].apply(this,Array.prototype.slice.call(arguments,1));
		}else if(typeof method==="object" || !method){
			return methods.init.apply(this,arguments);
		}else{
			$.error("Method "+method+" does not exist");
		}
	};
	$[pluginNS]=function(method){ /* usage: $.mCustomScrollbar(); */
		if(methods[method]){
			return methods[method].apply(this,Array.prototype.slice.call(arguments,1));
		}else if(typeof method==="object" || !method){
			return methods.init.apply(this,arguments);
		}else{
			$.error("Method "+method+" does not exist");
		}
	};
	
	/* 
	allow setting plugin default options. 
	usage: $.mCustomScrollbar.defaults.scrollInertia=500; 
	to apply any changed default options on default selectors (below), use inside document ready fn 
	e.g.: $(document).ready(function(){ $.mCustomScrollbar.defaults.scrollInertia=500; });
	*/
	$[pluginNS].defaults=defaults;
	
	/* 
	add window object (window.mCustomScrollbar) 
	usage: if(window.mCustomScrollbar){console.log("custom scrollbar plugin loaded");}
	*/
	window[pluginNS]=true;
	
	$(window).load(function(){
		
		$(defaultSelector)[pluginNS](); /* add scrollbars automatically on default selector */
		
		/* extend jQuery expressions */
		$.extend($.expr[":"],{
			/* checks if element is within scrollable viewport */
			mcsInView:$.expr[":"].mcsInView || function(el){
				var $el=$(el),content=$el.parents(".mCSB_container"),wrapper,cPos;
				if(!content.length){return;}
				wrapper=content.parent();
				cPos=[content[0].offsetTop,content[0].offsetLeft];
				return 	cPos[0]+_childPos($el)[0]>=0 && cPos[0]+_childPos($el)[0]<wrapper.height()-$el.outerHeight(false) && 
						cPos[1]+_childPos($el)[1]>=0 && cPos[1]+_childPos($el)[1]<wrapper.width()-$el.outerWidth(false);
			},
			/* checks if element is overflowed having visible scrollbar(s) */
			mcsOverflow:$.expr[":"].mcsOverflow || function(el){
				var d=$(el).data(pluginPfx);
				if(!d){return;}
				return d.overflowed[0] || d.overflowed[1];
			}
		});
	
	});

}))}));;
RetailBudgetPro.Budget = function () {
    var dataPercentageFilter = "data"; // variable used to detect which mode of data is to be shown (dollar or percentage)
    //var filter = ""; // comp non-comp filter
    var comments = [];
    var commentRow; // get the comment row
    var initialSelectedVendorsArray = [];
    var currentRow; // get the current row
    var isInEditMode = false;
    var firstTimeLoad = true;
    RetailBudgetPro.Budget.FormulaPopUpAudits = [];
    FormulaPopDeletedPLElementUIDs = [];
    var vendorList = [];
    var showOptionsInVendorDropDown = false;
    RetailBudgetPro.Budget.CurrencyFXRatesAudits = [];
    var StoreUIDListForCategory = [];

    return {

        growthRate: [],

        auditChanges: [[]],

        filter: '',

        fetchPercentApprovedValues: 1,

        showVendorChangePopupMessage: 0,

        globalCurrencyUID: "",

        isCurrencyOnForBudget: "",

        showVendorGlobalVal: 0,

        turnOnBalanceSheetVal: "",

        numberOfPeriodsVal: "",

        sortTotalByDollarHTML: "<div class='sort-total sortTotalByDollar'><a href='javascript:void(0)' class='sort-both'></a></div>",

        sortTotalByPercentHTML: "<div class='sort-total sortTotalByPercent'><a href='javascript:void(0)' class='sort-both'></a></div>",

        isUserInEditDataPageRole: "",

        isUserInApproveBudget: "",

        hasUserApprovers: "",

        //isUserInEditDataAmountOnlyRole: "", For branch BD-1122

        showAlertOnUndoChanges: 1,

        DataInput: function () {
            RetailBudgetPro.Budget.globalCurrencyUID = $('[name="GlobalCurrencyUID"]').val();
            RetailBudgetPro.Budget.isCurrencyOnForBudget = $('#hdnIsCurrencyOnForBudget').val();
            RetailBudgetPro.Budget.showVendorGlobalVal = $('#ShowVendor').val() == "True" ? 1 : 0;
            RetailBudgetPro.Budget.turnOnBalanceSheetVal = $('#TurnOnBalanceSheet').val();
            RetailBudgetPro.Budget.numberOfPeriodsVal = $('#hdnNumberOfPeriods').val();
            RetailBudgetPro.Budget.isUserInEditDataPageRole = $('#hdnIsUserInEditDataPageRole').val();
            RetailBudgetPro.Budget.isUserInApproveBudget = $('#hdnUserInApproveBudget').val();
            RetailBudgetPro.Budget.hasUserApprovers = $('#hdnHasUserApprovers').val();
            //RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole = $('#hdnIsUserInEditDataAmountOnlyRole').val(); For branch BD-1122

            $('.srcCat').prop('title', $('.srcCat option:selected').attr("data-title"));
            RetailBudgetPro.Budget.init();
            // Initializing Multiselect dropdown of Store
            RetailBudgetPro.Budget.InitializeMultiselect();

            RetailBudgetPro.Budget.CheckReadOnlyMode();

            //RetailBudgetPro.Budget.EnableDisableCurrencyLocalOption();

            $('[data-toggle="popover"]:not(.compound-growth-info)').popover({
                html: true,
                delay: { show: 50, hide: 100 }
            });

            $('.compound-growth-info[data-toggle="popover"]').popover({
                container: 'body',
                delay: { show: 50, hide: 100 },
                template: '<div class="popover compound-growth-info-popover" role="tooltip"><div class="arrow"></div><div class="popover-content"></div></div>'
            });

            $('.CurrencyOptionDropDown').on('change', function () {
                $('.displayDataInput').trigger('click')
            });

            $('#copyBudLink').on('click', function () {
                var val = "Budget";
                $.ajax({
                    url: '/Budget/SetSource',
                    data: "{ Source:'" + val + "'}",
                    contentType: "application/json; charset=UTF-8",
                    type: 'POST',
                    async: true,
                    success: function () {
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            });




            var lots_of_stuff_already_done = false;
            var lots_of_stuff_already_done1 = false;
            var lots_of_stuff_already_done2 = false;
            var lots_of_stuff_already_done3 = false;


            // Show alert in case user is navigating somewher else when the bottomlevel lines are in editable mode
            $(document).on('click', 'a', function (e) {

                if (lots_of_stuff_already_done === true) {
                    lots_of_stuff_already_done = false; // reset flag
                    if ($(e.target).attr('href') != undefined) {
                        window.location.href = $(e.target).attr('href');
                    }
                    return true; // let the event bubble away
                }
                else {

                    // Avoiding to show alert when the click is made on any of the following <a> tags

                    var sidebarMenuClick = $(this).closest('li').hasClass('menu') && $(this).parents('ul.page-sidebar-menu').length > 0 && $(this).closest('li').find('.sub-menu').length > 0;

                    if (!$(this).hasClass('gl-imported-rows') && !$(this).hasClass('compound-growth-info') && !$(this).hasClass('payrollDistributeEvenly') && !$(this).hasClass('documentDownload') && !$(this).hasClass('documentDelete') && !$(this).hasClass('downloadLinkedDocument') && !$(this).hasClass('editEmployeeLink') && !$(this).hasClass('periodRedistribute') && !$(this).hasClass('usePeriodRedistribution') && !$(this).hasClass('submit-delete-request') && !$(this).hasClass('saveByRequester') && !$(this).hasClass('saveByApprover') && !$(this).hasClass('submitForApproval') && !$(this).hasClass('submit-reject-directly') && !$(this).hasClass('submit-approve-directly') && !$(this).hasClass('hide-all-stores') && !$(this).hasClass('show-all-stores') && !$(this).hasClass('refresh-totals') && !$(this).hasClass('refresh-average') && !$(this).hasClass('documentUpload') && !$(this).hasClass('for-popover') && !$(this).hasClass('unselectAllStores') && !$(this).hasClass('selectAllStores') && !$(this).hasClass('LinkToDataPage') && !$(this).hasClass('distributeTotalEvenly') && !$(this).hasClass('distributeTotal') && !$(this).hasClass('copyPeriodValues') && !$(this).hasClass('add-new-line') && !$(this).hasClass('deleteChildRow') && !$(this).hasClass('addNewRow') && !$(this).hasClass('delete-row') && !$(this).hasClass('linked-category-data') && !$(this).hasClass('edit-formula') && !$(this).hasClass('downloadLinkedExcel') && !$(this).hasClass('downloadSubCatTemplate') && !$(this).hasClass('upload-excel') && !$(this).hasClass('edit') && !$(this).hasClass('newLineLink') && !$(this).hasClass('save') && !$(this).hasClass('undo') && !$(this).hasClass('deleteBottomLevelCategory') && !$(this).hasClass('checkComp') && !$(this).hasClass('checkNonComp') && !$(this).hasClass('dropdown-toggle') && !$(this).hasClass('growthRate') && !$(this).hasClass('copyValues') && !($(this).hasClass('bottomLevelCategoryComment')) && !($(this).hasClass('distributeTotalEven')) && !($(this).hasClass('distributeTotalPercent')) && !($(this).hasClass('sortVendorASC')) && !($(this).hasClass('sortVendorDESC')) && !($(this).hasClass('showDollarAmount')) && !($(this).hasClass('RecalculateForParentEmp')) && !($(this).hasClass('expand')) && !($(this).hasClass('collapse')) && !($(this).hasClass('inactivePeriodData')) && !($(this).hasClass('linked-currency-data')) && !($(this).hasClass('distributeTotalFXRates')) && !$(this).hasClass('show-more-rows') && !($(this).hasClass('CopyToMultipleStores')) && !($(this).hasClass('pasteToSingleStore')) && !$(this).hasClass('excelDownload') && !$(this).hasClass('pasteToSameRow') && !$(this).hasClass('transactionDate') && !$(this).hasClass('ui-datepicker-prev') && !$(this).hasClass('ui-datepicker-next') && !$(this).hasClass('openTransactionPopup') && !sidebarMenuClick && !$(this).hasClass('vendor-info-icon'))
                        if ($("#DataInputTable").find("a.save").parent().hasClass('show')) {

                            var confirmClick = function () {
                                if ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "False") $('#btnPercentage').removeClass('hide');
                                lots_of_stuff_already_done = true;
                                $(e.target).trigger("click");
                            }

                            var cancelClick = function () {
                                lots_of_stuff_already_done = false;
                            }

                            custom_confirm(confirmClick, cancelClick, "Confirm", "Any unsaved changes will be lost");

                            e.preventDefault();

                            //if (confirm("Any unsaved changes will be lost")) {
                            //}
                            //else {
                            //    e.preventDefault();
                            //}
                        }
                }
            });


            // multiselect store list region selection event to 
            // check all the stores of that region
            $('.multiselect-group').click(function (event) {
                var checkAll = true;
                var $opts = $(this).nextUntil('.multiselect-group');

                //if ($(this).find('span.checked').length > 0)
                //    $(this).find('span').removeClass('checked');
                //else
                var checkedLength = $opts.find('span.checked').length;
                var optsnLength = $opts.length;
                if (!$(this).find('span').hasClass('checked'))
                    $(this).find('span').addClass('checked');
                else if (optsnLength == checkedLength)
                    $(this).find('span').removeClass('checked');


                $opts.each(function () {
                    $(this).find('span').addClass('checked');
                    if (checkedLength == optsnLength)
                        $(this).find('span').removeClass('checked');
                });

                event.preventDefault();
            });

            $(document).on('click', '.delete-all-notes', RetailBudgetPro.Budget.DeleteNotes);

            $(document).on('input change', '.filterinput', function () {
                $(this).attr('data-currentValue', $(this).val());
            });

            if ($('[name=IsValidYearRange]').val() == "True")
                RetailBudgetPro.Budget.IninializeYearRange();

            $(document).on('change', 'input[type=radio][name=GrowthType], input[type=radio][name=GrowthTypeForPreviousYear]', RetailBudgetPro.Budget.GrowthPeriodChange);

        },
        init: function () {

            //extending jquery contains
            $.extend($.expr[":"], {
                containsExact: $.expr.createPseudo ?
                    $.expr.createPseudo(function (text) {
                        return function (elem) {
                            return $.trim(elem.innerHTML.toLowerCase()) === text.toLowerCase();
                        };
                    }) :
                    // support: jQuery <1.8
                    function (elem, i, match) {
                        return $.trim(elem.innerHTML.toLowerCase()) === match[3].toLowerCase();
                    },

                containsExactCase: $.expr.createPseudo ?
                    $.expr.createPseudo(function (text) {
                        return function (elem) {
                            return $.trim(elem.innerHTML).toLowerCase() === text;
                        };
                    }) :
                    // support: jQuery <1.8
                    function (elem, i, match) {
                        return $.trim(elem.innerHTML) === match[3];
                    },

                containsRegex: $.expr.createPseudo ?
                    $.expr.createPseudo(function (text) {
                        var reg = /^\/((?:\\\/|[^\/])+)\/([mig]{0,3})$/.exec(text);
                        return function (elem) {
                            return reg ? RegExp(reg[1], reg[2]).test($.trim(elem.innerHTML)) : false;
                        };
                    }) :
                    // support: jQuery <1.8
                    function (elem, i, match) {
                        var reg = /^\/((?:\\\/|[^\/])+)\/([mig]{0,3})$/.exec(match[3]);
                        return reg ? RegExp(reg[1], reg[2]).test($.trim(elem.innerHTML)) : false;
                    }

            });

            if (localStorage.getItem("AccountingMethodForBS") != null && localStorage.getItem("AccountingMethodForBS") != "") {
                $('[name="TransactionModeDropdown"]').val(localStorage.getItem("AccountingMethodForBS")).trigger('change');
                localStorage.removeItem("AccountingMethodForBS");
            }

            // Removing data level from the historical data
            $(".hideyear").each(function () {
                $(this).removeAttr("data-level");
            });

            // Showing side panel closed when user navigates to this(DataInput) page
            $('body').addClass('page-header-fixed page-quick-sidebar-over-content  page-sidebar-closed');

            $('.displayVendor').addClass('hide');

            // Avoiding to show the bottomlevel scenarios when datatable gets loaded.
            // Avoiding action columns,Vendor description columns etc.
            

            if ($.browser.mozilla || $('[name=groupedcategory]').val().split('|')[1] == -1 || $('#hdnAllMonthsLocked').val() == "True") {
                $('.CopyToMultipleStores').addClass('hide');
            }

            //(function ($) {
            //    $(window).load(function () {
            //        $(".demo-x").mCustomScrollbar({
            //            axis: "x",
            //            advanced: { autoExpandHorizontalScroll: true }
            //        });
            //    });
            //})(jQuery);

            $('input[type="text"]')
               // event handler
               .keyup(resizeInput)
               // resize on page load
               .each(resizeInput);
            //commented by Himanshu as it is of no use. Plugins are automatically loaded if classes are in properly placed.   
            $('[name="ShowInGlobal"]').select2();
            RetailBudgetPro.Budget.EnableDisableCurrencyLocalOption();
            
            // Initializing tabelizer
            if ($('[name=IsValidYearRange]').val() == "False") {
                var table1 = $('#DataInputTable').tabelize({
                    /*onRowClick : function(){
                        alert('test');
                    }*/
                    fullRowClickable: false,
                    // Gets called as soon as tabelizer is Ready
                    onReady: function () {

                        $('#DataInputTable tbody tr.netsales').each(function () {
                            if (!$(this).next('tr').hasClass('hideyear') && !$(this).next('tr').next('tr').hasClass('hideyear')) {
                                $(this).find('.expandYear').removeClass('expandYear').addClass('collapseYear');
                                $(this).removeClass('hideyear').addClass('showyear');
                            }
                        });

                        $('#DataInputTable tbody tr:not(.historicaldata)').each(function () {
                            $(this).find('.expandYear').attr('title', "Show historical data");
                            $(this).find('.collapseYear').attr('title', "Hide historical data");
                        });

                        $('#DataInputTable tbody tr').find('td:first .expander[title!="Collapse"]').attr('title', "Expand");

                        $('#DataInputTable tbody tr[data-allowdetailview="False"]').find('.expander').css('visibility', 'hidden');

                        $('#DataInputTable tbody tr td[title=Total]').css('font-weight', '600');

                        $('[name="datapageVendordd"]').SumoSelect({ selectAll: false, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val() });

                        if ($('.inEditMode').length == 0) {
                            if ($('[name="TransactionModeDropdown"]').val() == 'ACCRUAL') {
                                $('.accrualEditData-info-icon').removeClass('hide');
                            }
                            else {
                                $('.accrualEditData-info-icon').addClass('hide');
                            }
                        }

                        //$('#DataInputTable tbody tr').each(function () {
                        //    if ($(this).hasClass('netsales')) {
                        //        // Used to avoid opening of net sales historical data once it is contracted in single department case
                        //        if (!$(this).next('tr').hasClass('hideyear') && !$(this).next('tr').next('tr').hasClass('hideyear')) {
                        //            $(this).find('td.expandYear').removeClass('expandYear').addClass('collapseYear');
                        //            $(this).removeClass('hideyear').addClass('showyear');
                        //        }
                        //    }
                        //    // Managing Hover state
                        //    if (!$(this).hasClass('historicaldata')) {
                        //        $(this).find('td.expandYear').attr('title', "Show historical data");
                        //        $(this).find('td.collapseYear').attr('title', "Hide historical data");
                        //    }
                        //    if ($(this).find('td:first').find('.expander').attr('title') != "Collapse") {
                        //        $(this).find('td:first').find('.expander').attr('title', "Expand");
                        //    }
                        //    $(this).find('td[title=Total]').css('font-weight', '600');
                        //});

                        $('.linked-category-data').each(function () {
                            $(this).appendTo($(this).parents('td'));
                        });

                        $('.edit-formula').each(function () {
                            $(this).appendTo($(this).parents('td'));
                        });

                        $('.edit-employee').each(function () {
                            $(this).appendTo($(this).parents('td'));
                        });

                        $('.linked-currency-data').each(function () {
                            $(this).appendTo($(this).parents('td'));
                        });

                        $('.accrualEditData-info-icon').each(function () {
                            $(this).appendTo($(this).parents('td'));
                        });

                        $('.downloadLinkedExcel').each(function () {
                            var spanTxt = $(this).find('.exl-rowno').remove();
                            $(this).appendTo($(this).parents('td'));
                            $(spanTxt).appendTo($(this).parents('td'));
                        });

                        $('.gl-imported-rows').each(function () {
                            $(this).appendTo($(this).parents('td'));
                        });

                        $('.layout').css('display', 'none');

                        if ($('.budgetdata.showyear:not(.expanded):not(.bottomLevel)[data-allowdetailview!="False"]').length == 1 && $('.showyear.l1.expanded').length == 0 && localStorage.getItem("ExpandedRows") == null) {
                            $('.budgetdata.showyear:not(.expanded):not(.bottomLevel)').find('.expander').trigger('click');
                        }

                        if (localStorage.getItem("ExpandedRows") != null && localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "True") {
                            var storeID = localStorage.getItem("ExpandedRows").toString().split(',')[0].toString().split('|')[0].toString();
                            var depID = localStorage.getItem("ExpandedRows").toString().split(',')[0].toString().split('|')[1].toString();
                            var catID = localStorage.getItem("ExpandedRows").toString().split(',')[0].toString().split('|')[2].toString();

                            var filteredRows = $('.budgetdata.showyear.contracted').has('#hdnStoreUID:containsExact(' + storeID + ')').has('#hdnCatUID:containsExact(' + catID + ')').has('#hdnDeptUID:containsExact(' + depID + ')').has('#hdnViewLevel:containsExact("CATEGORY"), #hdnViewLevel:containsExact("STORE"), #hdnViewLevel:containsExact("DEPARTMENT")');

                            //console.log(storeID + " " + depID + " " + catID + " " + $(filteredRows).attr('id'));

                            $(filteredRows).find('.expander').trigger('click');
                            $(filteredRows).removeClass('budgetdata');

                            var finalStorage = localStorage.getItem("ExpandedRows").toString().split(',');

                            var expandedRow = finalStorage.shift();

                            if (finalStorage.length != 0) {
                                localStorage.setItem("ExpandedRows", finalStorage.join(","));
                            }
                            else {
                                localStorage.removeItem("ExpandRows");
                                localStorage.removeItem("ExpandedRows");
                            }
                        }

                        else if (localStorage.getItem('ActiveRow') != null) {
                            //console.log("Active row " + localStorage.getItem("ActiveRow"));

                            storeID = localStorage.getItem("ActiveRow").toString().split('|')[0].toString();
                            depID = localStorage.getItem("ActiveRow").toString().split('|')[1].toString();
                            catID = localStorage.getItem("ActiveRow").toString().split('|')[2].toString();

                            var activeRow = $('#DataInputTable tr').has('#hdnStoreUID:containsExact(' + storeID + ')').has('#hdnCatUID:containsExact(' + catID + ')').has('#hdnDeptUID:containsExact(' + depID + ')').has('#hdnViewLevel:containsExact("CATEGORY")').not('.historicaldata');

                            $(activeRow).find('.expander').trigger('click');
                            $(activeRow).find('.expander').trigger('click');

                            $(activeRow).addClass('show-action-btns').addClass('active-row');

                            localStorage.removeItem("ActiveRow");

                            $('.custom-data-table').show();

                            if (RetailBudgetPro.Budget.showVendorChangePopupMessage == 1) {
                                RetailBudgetPro.Budget.showVendorChangePopupMessage = 0;

                                if ($('#ShowVendor').val() == "True") {
                                    var confirmClick = function () {
                                    }

                                    custom_alert(confirmClick, "Note", $('#hdnVendorName').val() + " filter has changed to Any.");
                                }
                            }
                        }

                        else {
                            $('.custom-data-table').show();

                            if (localStorage.getItem("showPercentView") != undefined && localStorage.getItem("showPercentView") == "True" && $('.custom-data-table tbody').html().trim() != "") {
                                localStorage.removeItem("showPercentView");
                                $("#btnPercentage").trigger('click');
                            }
                        }

                        if (RetailBudgetPro.Budget.fetchPercentApprovedValues == 1) {
                            $.ajax({
                                url: '/Budget/FetchPercentApprovedValues',
                                type: 'POST',
                                async: true,
                                dataType: 'json',
                                data: "{ StoreUIDCSV:'" + $('[name=lstStores]').val() + "', groupedcategory:'" + $('[name=groupedcategory]').val() + "'}",
                                contentType: "application/json; charset=UTF-8",
                                success: function (data) {
                                    $('.submittedForApprovalPercent').text(data.submittedForApprovalPercent);
                                    $('.approvedPercent').text(data.approvedPercent);
                                    RetailBudgetPro.Budget.fetchPercentApprovedValues = 0;
                                },
                                error: function (err) {
                                    console.log(err);
                                }
                            });
                        }

                        if ($('button.data').hasClass('active')) {
                            $('#DataInputTable').find('.percentage').addClass('hide');
                            $('#DataInputTable').find('.data').removeClass('hide');
                        }
                        else {
                            $('#DataInputTable').find('.percentage').removeClass('hide');
                            $('#DataInputTable').find('.data').addClass('hide');
                        }

                        //fixTable(document.getElementById('fixed-table-container-datasheetTable'));

                    }, // On level expansion this method invokes and fetches the next level data
                    onBeforeRowClick: function (e) {
                        $tr = $(e.currentTarget).parents('tr');

                        if ($('.inEditMode').length != 0) {
                            $('.show .undo').trigger('click');
                        }

                        if ($tr.hasClass('budgetdata') && $tr.attr('data-allowdetailview') != "False") {
                            $('.layout').css('display', 'block');
                            $trAfterAppend = $(e.currentTarget).parents('tr');
                            // Fetching the value of hidden variables which will be used to get the data at a particular level.
                            var level = $tr.attr('data-level');
                            var viewlevel = $tr.find('#hdnViewLevel').html();
                            var storeID = $tr.find('#hdnStoreUID').html();
                            var deptID = $tr.find('#hdnDeptUID').html();

                            var budgetId = $('#hdnBudgetUID').val();
                            var budgetYear = $('#hdnBudgetYear').val();
                            var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                            var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                            var vendorIdCSV = ($('#vendordd').val() == null ? '' : $('#vendordd').val().join());

                            if (deptID == "") {
                                deptID = "-1";
                            }
                            var categoryID = $tr.find('#hdnCatUID').html();
                            if (categoryID == "") {
                                categoryID = "-1";
                            }
                            //else if (catID != undefined)
                            //    categoryID = catID;

                            $html = '';
                            $.ajax({
                                url: '/Budget/GetRowData',
                                data: "{ level:'" + level + "', StoreUID:'" + storeID + "', DeptUID:'" + deptID + "',CategoryUID:'" + categoryID + "',groupedcategory:'" + $('[name=groupedcategory]').val() + "' ,CompNonCompfilter:'" + RetailBudgetPro.Budget.filter + "',Stores:'" + $('[name=lstStores]').val() + "',viewLevel:'" + viewlevel + "',vendorIdCSV:'" + vendorIdCSV + "',showInGlobal:'" + ($('[name="ShowInGlobal"]').val() == "1") + "',bsMode:'" + bsMode + "',categoryType:'" + categoryType + "'}",
                                type: 'POST',
                                async: true,
                                dataType: 'html',
                                contentType: "application/json; charset=UTF-8",
                                success: function (data) {
                                    $html = $(data);
                                    var html = $($html);
                                    var html = $($html).insertAfter($trAfterAppend.next('tr').next('tr'));

                                    // Hide the historical data incase it is open when expanding
                                    $trAfterAppend.next('tr').addClass('hideyear')
                                    $trAfterAppend.next('tr').next('tr').addClass('hideyear')

                                    var hasUnapprovedRow = $html.filter(function () { if ($(this).is('[class*="unapproved-"]')) return this; }).length > 0 ? 1 : 0;

                                    //if ($tr.next('tr').hasClass('showyear')) {
                                    $html.filter('.totals').each(function () {
                                        $(this).addClass(hasUnapprovedRow == 1 ? 'totals-italics' : '');
                                        $(this).next('tr').removeClass('hideyear').addClass('showyear');
                                        $(this).next('tr').next('tr').removeClass('hideyear').addClass('showyear');
                                        $(this).next('tr').find('td:first').html('');
                                        $(this).next('tr').next('tr').find('td:first').html('');
                                        $(this).find('.expandYear').removeClass('expandYear').addClass('collapseYear');
                                        $($(this).nextAll('.LevelPercentLY ')[0]).find('.DATValueTotalF span').html($(this).find('.percentLYF span').html());
                                        $($(this).nextAll('.LevelPercentLY ')[1]).find('.DATValueTotalF span').html($(this).find('.percentLLYF span').html());
                                        //$(document).find('.isVendor').attr('disabled', true)
                                        if ($('#hdnShowHideLLY').val() == "False") $($(this).nextAll('.LevelPercentLY ')[1]).addClass('hide');
                                    });
                                    //$.each($html, function (i, val) {
                                    //    if ($(this).hasClass('totals')) {
                                    //        $(this).next('tr').removeClass('hideyear').addClass('showyear');
                                    //        $(this).next('tr').next('tr').removeClass('hideyear').addClass('showyear');
                                    //        $(this).next('tr').find('td:first').html('');
                                    //        $(this).next('tr').next('tr').find('td:first').html('');
                                    //        $(this).find('.expandYear').removeClass('expandYear').addClass('collapseYear');
                                    //        $($(this).nextAll('.LevelPercentLY ')[0]).find('.DATValueTotalF span').html($(this).find('.percentLYF span').html());
                                    //        $($(this).nextAll('.LevelPercentLY ')[1]).find('.DATValueTotalF span').html($(this).find('.percentLLYF span').html());

                                    //        if ($('#hdnShowHideLLY').val() == "False") $($(this).nextAll('.LevelPercentLY ')[1]).addClass('hide');
                                    //    }
                                    //});
                                    //}
                                    //$($html).find('.totals').next('tr').removeClass('hideyear').addClass('showyear')
                                    //$($html).find('.totals').next('tr').next('tr').removeClass('hideyear').addClass('showyear')



                                    //if ($($html).find('#hdnViewLevel').html() == "CATEGORY" && $($html).find('#hdnIsFOA').html() == "True") {
                                    //    //$html.find('tr').each(function () {
                                    //    //    if ($(this).find('#hdnIsFOA').html() == "True")
                                    //    //        $(this).find('td:first').append('<div class="action-items"><div class="no-record-found">AAAA</div></div>');
                                    //    //});


                                    //    for (var counter = 0; counter < $html.length; counter++) {
                                    //        if ($($html[counter]).find('#hdnIsFOA').html() == "True")
                                    //            var temp = getFormulaTypeAndUrl($($html[counter]).find('#hdnCatUID').html(), storeID);
                                    //        $($html[counter]).addClass('show-action-btns');
                                    //        if (!$($html[counter]).hasClass('totals') && !$($html[counter]).hasClass('LevelPercentLY')) {
                                    //            if (temp == "")
                                    //                //$trAfterAppend.children('td:first').append('<div class="action-items"><div class="no-record-found">No Record Found</div></div>');
                                    //                $($html[counter]).find('td:first').append('<div class="action-items"><div class="no-record-found"></div></div>');
                                    //            else
                                    //                $($html[counter]).find('td:first').append('<div class="action-items formulaType"><div class="show"><a href="' + temp.split('|')[1] + '" target = _blank >(' + temp.split('|')[0] + ')</a></div></div>');
                                    //        }
                                    //        // $($html[counter]).find('td:first').append('<div class="action-items"><div class="no-record-found">AAAA</div></div>');
                                    //    }
                                    //    $('.displayVendor').hide();

                                    //}

                                    // In case we have reached the bottom level then show the bottom lines and action buttons 
                                    if ($($html).hasClass('bottomLevel')) {

                                        $($html).find('.netsales').remove();
                                        // hide copy values button initially and show it when bottom lines are in edit mode
                                        $($html).find('.copyValues').hide();
                                        $('.budgets-table').addClass('vendor');
                                        //  $trAfterAppend.addClass('show-action-btns');
                                        $trAfterAppend.children('td:first').prepend('<input type="checkbox" class="checkAllToDelete hideCol" title="Select All"/>');

                                        $trAfterAppend.find('.displayVendor:first').html('<div class="sort-vendor"><a href="javascript:void(0)" class="sort-both"></a></div>')

                                        if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12)
                                            $trAfterAppend.find('.displayVendor:first').next().html('<div class="sort-date"><a href="javascript:void(0)" class="sort-both"></a></div>')

                                        $trAfterAppend.find('td.data.DATValueTotalF').html(RetailBudgetPro.Budget.sortTotalByDollarHTML);
                                        $trAfterAppend.find('td.percentage.DATValueTotalPF').html(RetailBudgetPro.Budget.sortTotalByPercentHTML);

                                        var isFOA = $($html).find('#hdnIsFOA').html();
                                        var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');
                                        var periods = getNumberOfPeriods();
                                        var submitForApproverIcon = '';
                                        if ($tr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').length > 0 && RetailBudgetPro.Budget.isUserInApproveBudget == "False")
                                            submitForApproverIcon = '<a href="javascript:void(0)" class="submitForApproval" title="Submit for approval"><i class="fa fa-thumbs-o-up"></i></a><a href="javascript:void(0)" class="undo-pending" title="Undo Pending"><i class="fa fa-thumbs-o-down"></i></a>';
                                        else if ($tr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').length > 0 && RetailBudgetPro.Budget.isUserInApproveBudget == "True")
                                            submitForApproverIcon = '<a href="javascript:void(0)" class="submit-approve-directly" title="Approve"><i class="fa fa-thumbs-up"></i></a><a href="javascript:void(0)" class="submit-reject-directly" title="Reject"><i class="fa fa-thumbs-down"></i></a>';
                                        else
                                            submitForApproverIcon = '';
                                        //var fromExcel = $($html).find('#hdnFromExcel:contains("True")').length >= 1 ? "True" : "False";
                                        if (isFOA != "True") {

                                            // If there is no formula and all periods are locked then show only copy category button
                                            if (lockedMonthsList.length == periods) {
                                                // If logged in user is admin then 
                                                if ($(document).find('#hdnUserInRole').val() == "True") {
                                                    if ($(document).find('#hdnIsConsolidated').val() != "True") {
                                                        // show only copy categories button
                                                        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show">' + ($('[name=groupedcategory]').val().split('|')[0] == "-2" ? '' : '<a href="javascript:void(0);" class="grey comment" id="btnComment" title="Show Comments"><i class="fa fa-comment-o"></i></a> <a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a>') + '</div></div>')
                                                    }
                                                }
                                                else {//     $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html());
                                                    // If user doesnot hav role to view budget then dont show the copy button
                                                    if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                                        var deleteIconClass = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "submit-delete-request" : "deleteBottomLevelCategory";
                                                        var deleteIconTitle = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "Submit for delete" : "Delete";
                                                        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="show"><div class="hide"><a href="javascript:void(0)" class="save" title="Save"><i class="fa fa-save"></i></a><a href="javascript:void(0)" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a> <a href="javascript:void(0)" class="undo" title="Undo"><i class="fa fa-undo"></i></a><a href="javascript:void(0)" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a><a href="javascript:void(0);" class="' + deleteIconClass + '" title="' + deleteIconTitle + '"><i class="fa fa-trash-o"></i></a></div></div>')
                                                    }
                                                    // If user has role to edit budget show the copy budget button
                                                    if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") {
                                                        if ($(document).find('#hdnIsConsolidated').val() != "True") {
                                                            $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show">' + ($('[name=groupedcategory]').val().split('|')[0] == "-2" ? '' : '<a href="javascript:void(0)" class="grey comment" id="btnComment" title="Show Comments"><i class="fa fa-comment-o"></i></a> <a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a>') + '</div></div>')
                                                        }
                                                    }
                                                    else if ($(document).find('#hdnIsUserInAddCommentsRole').val() == "True") {// If user has role to only comment budget show the comment button only
                                                        if ($(document).find('#hdnIsConsolidated').val() != "True") {
                                                            $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="show">' + ($('[name=groupedcategory]').val().split('|')[0] == "-2" ? '' : '<a href="javascript:void(0)" class="grey comment" id="btnComment" title="Show Comments"><i class="fa fa-comment-o"></i></a>') + '</div></div>')
                                                        }
                                                    }
                                                }
                                            }
                                                //If there is FTECategory then dont show copy and edit option
                                            else if ($('[name=groupedcategory]').val().split('|')[0] == "-2") {
                                                $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show"></div></div>')
                                            }

                                                //else if (fromExcel == "True") {
                                                //    if ($(document).find('#hdnUserInRole').val() == "True")
                                                //        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="show"><a href="javascript:void(0)" class="downloadLinkedExcel" title="Download linked excel"><i class="fa fa-file-excel-o downloadSubCatExcel"></i></a><a href="#" class="edit" title="Edit"> <i class="fa fa-pencil"></i> </a><a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a></div><div class="hide"><a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a><a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i> </a><a href="javascript:void(0);" class="deleteBottomLevelCategory" title="Delete"><i class="fa fa-trash-o"></i></a></div></div>')

                                                //    else {
                                                //        if ($(document).find('#hdnUserInEditBudgetRole').val() == "True") {
                                                //            $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="show"><a href="javascript:void(0)" class="downloadLinkedExcel" title="Download linked excel"><i class="fa fa-file-excel-o downloadSubCatExcel"></i></a><a href="#" class="edit" title="Edit"> <i class="fa fa-pencil"></i> </a><a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a></div><div class="hide"><a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a><a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i> </a><a href="javascript:void(0);" class="deleteBottomLevelCategory" title="Delete"><i class="fa fa-trash-o"></i></a></div></div>')
                                                //        }
                                                //        else if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                                //            $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="hide"><a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a><a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i> </a><a href="javascript:void(0);" class="deleteBottomLevelCategory" title="Delete"><i class="fa fa-trash-o"></i></a></div></div>')
                                                //        }

                                                //    }
                                                //}

                                                // If there are no periods locked or locked periods are less than the periods then
                                            else {
                                                var html = '';
						                        //For branch BD-1122
                                                //html += ((RetailBudgetPro.Budget.turnOnBalanceSheetVal == "False" || (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && $('[name="TransactionModeDropdown"]').val() == "ACCRUAL")) && ((RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True" || $('#hdnIsUserInAddCommentsRole').val() == 'True') && $('#hdnImpersonationMode').val() == "False") && $('[name="ReadOnlyMode"]').val() == "False" ? (RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True" && (($('[name="AllowBatchUpdates"]').val() == "True" && $('[name="ShowEditIcon"]').val() == "True") || $('[name="AllowBatchUpdates"]').val() == "False") ? '<a href="javascript:void(0)" class="edit" title="Edit"> <i class="fa fa-pencil"></i> </a>' : '') + '<a href="javascript:void(0);" class="grey comment" id="btnComment" title="Show Comments"><i class="fa fa-comment-o"></i></a>' : '');
						                        html += ((RetailBudgetPro.Budget.turnOnBalanceSheetVal == "False" || (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && $('[name="TransactionModeDropdown"]').val() == "ACCRUAL")) && ((RetailBudgetPro.Budget.isUserInEditDataPageRole == "True" || $('#hdnIsUserInAddCommentsRole').val() == 'True') && $('#hdnImpersonationMode').val() == "False") && $('[name="ReadOnlyMode"]').val() == "False" ? (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True" && (($('[name="AllowBatchUpdates"]').val() == "True" && $('[name="ShowEditIcon"]').val() == "True") || $('[name="AllowBatchUpdates"]').val() == "False") ? '<a href="javascript:void(0)" class="edit" title="Edit"> <i class="fa fa-pencil"></i> </a>' : '') + '<a href="javascript:void(0);" class="grey comment" id="btnComment" title="Show Comments"><i class="fa fa-comment-o"></i></a>' : '');

                                                var saveBtnClass = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? 'saveByRequester' : 'saveByApprover';

                                                var deleteIconClass = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "submit-delete-request" : "deleteBottomLevelCategory";
                                                var deleteIconTitle = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "Submit for delete" : "Delete";
                                                var deleteIcon = '<a href="javascript:void(0);" class="' + deleteIconClass + '" title="' + deleteIconTitle + '"><i class="fa fa-trash-o"></i></a>';

                                                if ($(document).find('#hdnUserInRole').val() == "True") {
                                                    $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description">' +
                                                                                                                                                                            '<a href="javascript:void(0)" class="sort-both"></a>' +
                                                                                                                                                                        '</div>' +
                                                                                                                                                                        '<div class="action-items">' +
                                                                                                                                                                            '<div class="show">' + html +
                                                                                                                                                                                '<a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"><i class="fa fa-copy"></i> </a>' +
                                                                                                                                                                            '</div>' +
                                                                                                                                                                            '<div class="hide">' +
                                                        '<a href="javascript:void(0)" class="save ' + saveBtnClass + '" title="Save">' +
                                                                                                                                                                                    '<i class="fa fa-save"></i>' +
                                                                                                                                                                                '</a>' +
                                                                                                                                                                                '<a href="javascript:void(0)" class="newLineLink" title="Add new line"><i class="fa fa-plus"></i></a>' +
                                                                                                                                                                                '<a href="javascript:void(0)" class="undo" title="Undo"><i class="fa fa-undo"></i></a><a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a>' +
                                                                                                                                                                                 deleteIcon +
                                                                                                                                                                            '</div>' +
                                                                                                                                                                        '</div>');
                                                }
                                                else {
                                                    if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") {
                                                        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show">' + html + '<a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a></div><div class="hide"><a href="javascript:void(0)" class="save ' + saveBtnClass + '" title="Save"><i class="fa fa-save"></i></a><a href="javascript:void(0)" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a> <a href="javascript:void(0)" class="undo" title="Undo"> <i class="fa fa-undo"></i></a><a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a>' + deleteIcon + '</div></div>')
                                                    }
						                            // For branch BD-1122
                                                    //else if (RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True") {
                                                    //    $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show">' + html + '</div><div class="hide"><a href="javascript:void(0)" class="save ' + saveBtnClass + '" title="Save"><i class="fa fa-save"></i></a><a href="javascript:void(0)" class="undo" title="Undo"> <i class="fa fa-undo"></i></a></div>')
                                                    //}
                                                    else if ($(document).find('#hdnIsUserInAddCommentsRole').val() == "True") {
                                                        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="show">' + html + '</div></div>')
                                                    }
                                                    else if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                                        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="hide"><a href="javascript:void(0)" class="save ' + saveBtnClass + '" title="Save"><i class="fa fa-save"></i></a><a href="javascript:void(0)" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a> <a href="javascript:void(0)" class="undo" title="Undo"> <i class="fa fa-undo"></i></a><a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a>' + deleteIcon + '</div></div>')
                                                    }
                                                }
                                            }

                                        } // if there is a formula on this category
                                        else {

                                            if ($(document).find('#hdnUserInRole').val() != "True") {
                                                if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") {
                                                }
                                                else if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                                    $($trAfterAppend.find('td:first').find('.formulaType')).find('.copy').remove();
                                                }
                                                //if ($(document).find('#hdnUserInManageFormulaRole').val() == "True") {
                                                //if (lockedMonthsList.length == periods) {
                                                //    $($trAfterAppend.find('td:first').find('.formulaType')).find('.copy').remove();
                                                //}
                                            }

                                            var formulaTypeHtml = $($trAfterAppend.find('td:first').find('.formulaType')).prop('outerHTML');
                                            $trAfterAppend.find('td:first').find('.formulaType').remove();
                                            $trAfterAppend.find('td:first').append(formulaTypeHtml);
                                            //}
                                        }
                                        $trAfterAppend.addClass('show-action-btns');

                                        $trAfterAppend.find('.action-items div.show').append(submitForApproverIcon);
                                        //else
                                        //    $trAfterAppend.children('td:first').append('<div class="action-items"><div class="show"><a href="#" class="edit" title="Edit" style="display:none;"> <i class="fa fa-pencil"></i> </a></div><div class="hide"><a href="#" class="save" title="Save"><i class="fa fa-check"></i></a><a href="#" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a> <a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i> </a>  <a href="javascript:void(0);" class="deleteBottomLevelCategory" title="Delete"><i class="fa fa-trash-o"></i></a></div></div>')
                                        //$trAfterAppend.find('.checkAllToDelete').append('<div class="delete-actions"><a class=checkAll title="Select All">All</a>   <a href="javascript:void(0);" class="deleteBottomLevelCategory" title="Delete"><i class="fa fa-trash-o"></i></a></div>');

                                        // Showing vendor column
                                        $('.displayVendor:not(.hideColumn)').removeClass('hide');

                                        $trAfterAppend.find('.hideNewLine').removeClass('hideNewLine').addClass('showNewLine');
                                        if (isFOA != "True") {
                                            // Inserting the growth rate distrinbution button in the totals historical rows.
                                            $($trAfterAppend.nextAll('.totals')[0]).each(function () {
                                                $(this).next('tr').find('.action-btn').html("<div class=''><a data-target='#growthRatePopUpForPreviousYear' data-year='" + (budgetYear - 1) + "' style='display:none;' data-toggle='modal' class='growthRate' title='Copy to current year with growth %'><i class='fa fa-angle-up'></i></a></div>");
                                                // Checking for locked months and disabling the textboxes in case particular period is locked.
                                                RetailBudgetPro.Budget.LockedMonthsCheck($(this).next('tr'), $(this).next('tr').find('td#hdnIsFOA').text());
                                                $(this).next('tr').next('tr').find('.action-btn').html("<div class=''><a data-target='#growthRatePopUpForPreviousYear' data-year='" + (budgetYear - 2) + "' style='display:none;' data-toggle='modal' class='growthRate' title='Copy to current year with growth %'><i class='fa fa-angle-up'></i></a></div>");
                                                RetailBudgetPro.Budget.LockedMonthsCheck($(this).next('tr').next('tr'), $(this).next('tr').next('tr').find('td#hdnIsFOA').text());
                                            });
                                        }


                                        // In case cat selected from dropdown Hides the totals and Ly and LLy row at group level not category level
                                        var $temp = "";
                                        if ($('[name=groupedcategory]').val().split('|')[1] != "-1") {
                                            $($html).each(function () {
                                                if ($(this).hasClass('totals')) {
                                                    $temp = $(this);
                                                }
                                            });

                                            //$($temp).removeClass('showyear').addClass('hideyear').addClass('l3');
                                            //$($temp).attr('data-level', '4');
                                            //var level = parseInt($($temp).data('level') - 2);
                                            //$($temp).nextUntil('.l' + level).each(function () {
                                            //    $(this).removeClass('showyear').addClass('hideyear');
                                            //});
                                            var level = $temp.data('level');

                                            // Hiding the totals and Ly and LLy row at group level not category level                                        
                                            $($temp).nextUntil('.l' + (level - 2), '.l' + (level - 1)).removeClass('showyear').addClass('hideyear');
                                        }


                                        $($html).find('.action-btn').removeClass('hideCol');
                                        $($html).find('.action-btn').find('.distributeTotalEven').hide();
                                        $($html).find('.action-btn').find('.usePeriodRedistribution').hide();
                                        $($html).find('.action-btn').find('.growthRate').hide();
                                        $($html).find('.action-btn').find('.distributeTotalPercent').hide();

                                        var level = $tr.data('level');

                                        if (level == 2) {
                                            //if ($('#btnComment').find('i').hasClass('fa-comment')) {
                                                //$('.highlight.bottomLevel:has(#hdnCatCalucaltedType:empty):not(:has(#hdnPLElementUID:containsExact("-1")))').find('.desc-field').addClass('commentModeOn');
                                                //$('.bottomLevel:has(#hdnCatCalucaltedType:empty):not(:has(#hdnPLElementUID:containsExact("-1")))').find('.vendor').addClass('commentModeOn');
                                                //$('.bottomLevel:has(#hdnCatCalucaltedType:empty):not(:has(#hdnPLElementUID:containsExact("-1")))').find('.data span').addClass('commentModeOn');
                                                //$('.bottomLevel:has(#hdnCatCalucaltedType:empty):not(:has(#hdnPLElementUID:containsExact("-1")))').find('.percentage span').addClass('commentModeOn');
                                            //}

                                            var plelementUID = localStorage.getItem("plelementUID");
                                            if (plelementUID != null || plelementUID != undefined) {
                                                if (!$('#btnComment').find('i').hasClass('fa-comment'))
                                                    $('#btnComment').trigger('click');

                                                var commentDoneOnField = localStorage.getItem("commentDoneOnField");

                                                var tr = $('.bottomLevel').has('#hdnPLElementUID:containsExact("' + plelementUID + '")')

                                                if (commentDoneOnField == 'Description')
                                                    tr.find('.desc-field').trigger('click');
                                                else if (commentDoneOnField == 'Total')
                                                    tr.find('.hasComment[title="Total"]').eq(0).find('.commentModeOn').trigger('click');  
                                                else if (commentDoneOnField == 'Vendor') {
                                                    if ($('#ShowVendor').val() == "True") {
                                                        tr.find('.vendor').trigger('click');
                                                    }
                                                    else {
                                                        tr.find('.isVendor').next('span').trigger('click');
                                                    }
                                                }
                                                else
                                                    tr.find('.data.hasComment').attr('data-Period', commentDoneOnField).eq(0).find('.commentModeOn').trigger('click');
                                              
                                                localStorage.removeItem("plelementUID");
                                                localStorage.removeItem("commentDoneOnField");
                                            }
                                        }
                                    }
                                    else {

                                        if ($($html[4]).find('#hdnViewLevel').html() == "CATEGORY") {

                                            $html.filter(function () {
                                                return $(this).hasClass('showyear') && $(this).not('.netsales')
                                            }).each(function () {
                                                //if ($(this).hasClass('showyear') && $(this).not('.netsales')) {

                                                var link = $(this).find('#hdnEditLink').html();

                                                // Setting title(FOA/Rule/C2C) if a formula is applied on a category
                                                if (link != "0" && link != "") {
                                                    var title = "";
                                                    if ($('#hdnUserInRole').val() == "True") {
                                                        if (link.split('/')[1] == "Formula")
                                                            title = "Edit FOA";
                                                        else if (link.split('/')[1] == "C2C")
                                                            title = "Edit C2C";
                                                        else if (link.split('/')[1] == "Rule") {
                                                            title = "Edit Rule"
                                                        }
                                                        else {
                                                            title = "Edit Employee Payroll"
                                                        }
                                                    }
                                                    else {
                                                        if ($('#hdnUserInManageFormulaRole').val() == "True") {
                                                            if (link.split('/')[1] == "Formula")
                                                                title = "Edit FOA";
                                                            else if (link.split('/')[1] == "C2C")
                                                                title = "Edit C2C";
                                                            else if (link.split('/')[1] == "Rule") {
                                                                title = "Edit Rule"
                                                            }
                                                            else {
                                                                title = "Edit Employee Payroll"
                                                            }
                                                        }
                                                        else {
                                                            var viewLink = "";
                                                            if (link.split('/')[1] == "Formula") {
                                                                title = "FOA";
                                                                viewLink = "/Formula/AllFormula"
                                                            }
                                                            else if (link.split('/')[1] == "C2C") {
                                                                title = "C2C";
                                                                viewLink = "/C2C/AllC2C";
                                                            }
                                                            else if (link.split('/')[1] == "Rule") {
                                                                title = "Rule"
                                                                viewLink = "/Rule/AllRules";
                                                            }
                                                            else {
                                                                title = "Employee Payroll"
                                                                viewLink = link;
                                                            }
                                                            link = viewLink;
                                                        }
                                                    }
                                                    $(this).children('td:first').attr('title', $(this).children('td:first').html()).append('<div class="action-items formulaType"><div class="show"><a href="' + link + '" target = _blank title="' + title + '"><img src="/assets/admin/layout/img/fx-sign.png"></a><a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category" style="display:none"> <i class="fa fa-copy"></i> </a></div></div>');
                                                    $(this).addClass('show-active-btns')
                                                }
                                                //}
                                            });
                                        }
                                        var flag = 0;
                                        //$('#DataInputTable tbody tr').each(function () {
                                        //    if ($(this).find('.displayVendor').is(':visible') && $(this).find('.displayVendor:first').attr('style') != undefined) {
                                        //        flag = 1;
                                        //        return false;
                                        //    }
                                        //});

                                        if ($('#DataInputTable tbody tr').find('.displayVendor:visible').length > 0 && $('#DataInputTable tbody tr').find('.displayVendor:visible:first').attr('style') != undefined) {
                                            flag = 1;
                                        }

                                        if (flag == 0) {
                                            $('.displayVendor').addClass('hide');
                                            $trAfterAppend.find('.showNewLine').removeClass('showNewLine').addClass('hideNewLine');
                                            $($($tr).nextAll('.totals')[0]).find('td:first').append('<div class="" style=display:inline><a href="#" class="expandAllHistoricalData" title="Expand">  <img src="/assets/admin/layout/img/plus.png" /> </a><a href="#" class="collapseAllHistoricalData" title="Collapse">  <img src="/assets/admin/layout/img/minus.png" /></a></div>');

                                        }
                                    }

                                    $(".hideyear").removeAttr("data-level");

                                    $html.filter(function () {
                                        return $(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != ""
                                    }).each(function () {
                                        var hoverText = "(Linked to Row " + $(this).find('#hdnExcelRowNum').html() + ") - Download Excel";
                                        var tHtml = '<a href="javascript:void(0)" class="downloadLinkedExcel" title="' + hoverText + '"><i class="file-excel-filed downloadSubCatExcel"></i>' + ($(this).find('#hdnFromExcel').val() == '' ? '' : '<span data-rowno="' + $(this).find('#hdnExcelRowNum').html() + '" class="exl-rowno">Row ' + $(this).find('#hdnExcelRowNum').html() + '</span>') + '</a>';
                                        $(this).find('td:first()').append(tHtml);
                                    });

                                    var hdnShowEmployeeModuleVal = $('#hdnShowEmployeeModule').val();
                                    var hdnIsUserInManageAdminPayrollRoleVal = $('#hdnIsUserInManageAdminPayrollRole').val();

                                    $html.filter(function () {
                                        return $(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != ""
                                    }).each(function () {

                                    var urlLink = $(this).find('#hdnCatCalucaltedType').html().trim() == "FOA" ? "/Formula/EditFormula/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : $(this).find('#hdnCatCalucaltedType').html().trim() == "C2C" ? "/C2C/EditC2C/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : ($(this).find('#hdnCatCalucaltedType').html().trim() == "EP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "FTE") ? "/EmployeePayroll/Edit/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : $(this).find('#hdnCatCalucaltedType').html().trim() == "EFP" ? "/EmployeeFormula/Edit/" + $(this).find('#hdnCatCalucaltedOn').html().split('|')[1] : "/Rule/EditRule/" + $(this).find('#hdnCatCalucaltedOn').html().trim();
                                        var formulaName = $(this).find('#hdnFormulaName').html().trim();

                                        var htmlInputIcon = '';
                                        var htmlFormulaLinkIcon = '';
                                        var htmlA = '';
                                        var payrollUIDList = $(this).find('#hdnPayrollUIDsNotInUser').text().split(",");

                                        if ($(this).find('.edit-formula').length == 0) {
                                            if (($(this).find('#hdnCatCalucaltedType').html().trim() == "EFP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "EP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "FTE") && (hdnIsUserInManageAdminPayrollRoleVal == "True" || $('#hdnIsUserInManagePayrollRole').val() == "True")) {
                                            if ($(this).find('#hdnCatCalucaltedType').html().trim() == "EP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "FTE") {
                                                htmlFormulaLinkIcon = '<i class="fa fa-user"></i>';
                                                htmlInputIcon = ($(this).find('#hdnCatCalucaltedType').html().trim() == "FTE" ? '' : '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>');

                                                    if (jQuery.inArray($(this).find('#hdnCatCalucaltedOn').html().trim(), payrollUIDList) == -1) {
                                                        htmlA += htmlInputIcon + '<a title="Edit Payroll" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>';
                                                    }
                                                    else {
                                                        htmlA += htmlInputIcon;
                                                    }
                                                }
                                                else {
                                                    htmlInputIcon = ($(this).find('#hdnEmpFormulaTypeFV').html().trim() == "F" || $(this).find('#hdnEmpFormulaTypeFV').html().trim() == "A") ? '' : '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>';
                                                    htmlFormulaLinkIcon = hdnIsUserInManageAdminPayrollRoleVal == "True" ? '<img src="/assets/admin/layout/img/fx-sign.png"></a>' : '';
                                                htmlEmployeeIcon = hdnShowEmployeeModuleVal == "True" ? ('<a title="Edit Employee" target="_blank" class="edit-employee" href="/Employee/Edit/' + $(this).find('#hdnEmployeeUID').html().trim() + '"><i class="fa fa-user"></i></a>') : "";
                                                    htmlA += htmlInputIcon + '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' + htmlEmployeeIcon;
                                                }
                                            }
                                        else if ($(this).find('#hdnCatCalucaltedType').html().trim() != "EFP" && $(this).find('#hdnCatCalucaltedType').html().trim() != "EP" && $(this).find('#hdnCatCalucaltedType').html().trim() != "FTE" && $(this).find('#hdnCatCalucaltedType').html().trim() != "LC") {
                                                htmlInputIcon = ($(this).find('#hdnIsFOAEliminationType').html() != "True" && $(this).find('#hdnC2COperator').html() != "E") ? '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>' : '';
                                                htmlA = htmlInputIcon;
                                                htmlFormulaLinkIcon = '<img src="/assets/admin/layout/img/fx-sign.png"></a>';
                                                htmlA += $('#hdnUserInManageFormulaRole').val() == 'True' ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' : '';
                                        }
                                        else if ($(this).find('#hdnCatCalucaltedType').html().trim() == "LC" && $(this).find('.linked-category-data').length == 0) {
                                                htmlA = '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="LC"></a>';
                                        }

                                            $(this).find('td:first()').append(htmlA)
                                        }
                                    });

                                    if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {
                                        $html.filter(function () {
                                            return $(this).hasClass('budgetdata') && $(this).find('#hdnPLElementUID').html() != undefined && $(this).find('#hdnPLElementUID').html() != "-1" && $(this).find('#hdnPLElementUnApprovedUID').html() == "-1" && !($(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != "") && ($(this).find('#hdnCatCalucaltedType').html() != undefined && $(this).find('#hdnCatCalucaltedType').html().trim() != "NE") /*&& ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() == "")*/;
                                        }).each(function () {
                                            var amortValue = parseInt($(this).find('.amortizePeriodLst.showAmortizePeriodInTitle span').text());

                                            if (!isNaN(amortValue) && amortValue > 1) {
                                                var htmlPopoverInfoIcon = '<a class="accrualEditData-info-icon"><i class="icon-info"></i></a>';
                                                $(this).find('td:first()').append(htmlPopoverInfoIcon);
                                            }
                                        });
                                    }

                                    //BD-1282|saurabh|add i icon to show accrual edit data for when amort=1 in the case of when there is at least one or more deactivated months
                                    if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && $(document).find('#hdnInactiveMonths').val().length > 0) {
                                        $html.filter(function () {
                                            return $(this).hasClass('budgetdata') && $(this).find('#hdnPLElementUID').html() != undefined && $(this).find('#hdnPLElementUID').html() != "-1" && $(this).find('#hdnPLElementUnApprovedUID').html() == "-1" && !($(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != "");
                                        }).each(function () {
                                            var amortValue = parseInt($(this).find('.amortizePeriodLst.showAmortizePeriodInTitle span').text());

                                            if (!isNaN(amortValue) && amortValue == 1) {
                                                var htmlPopoverInfoIcon = '<a class="accrualEditData-info-icon"><i class="icon-info"></i></a>';
                                                $(this).find('td:first()').append(htmlPopoverInfoIcon);
                                            }
                                        });
                                    }

                                    if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                                        $html.filter(function () {
                                            return $(this).hasClass('budgetdata') && $(this).find('#hdnPLElementUID').html() != undefined && $(this).find('#hdnPLElementUID').html() != "-1" && $(this).find('#hdnPLElementUID').html() != "-10" && $(this).find('#hdnPLElementUnApprovedUID').html() == "-1" && !($(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != "") && $('[name="groupedcategory"] option[value$="|' + $(this).find('#hdnCatUID').html().trim() + '"]').data('isfinancialcat') == "True";
                                        }).each(function () {
                                            htmlCurrencyLinkIcon = '<i class="fa fa-money"></i>';
                                            var htmlA = '<a title="View Inputs" href="#" data-target="#relatedCurrencyModal" data-toggle="modal" class="linked-currency-data" data-plelementUID="' + $(this).find('#hdnPLElementUID').html() + '">' + htmlCurrencyLinkIcon + '</a>';
                                            $(this).find('td:first()').append(htmlA);
                                        });
                                    }
                                    
                                    $html.filter(function () {
                                        return $(this).find('#hdnComment').html() != undefined && $(this).find('#hdnComment').html().trim() != ""
                                    }).each(function () {
                                        var commentHtml = '<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o hasComment"></i></i></a>';
                                        $(this).find('.function-btn a:last()').after(commentHtml);
                                    });

                                    $html.filter(function () {
                                        return $(this).find('#hdnAttachedSubCategoryFolderName').html() != undefined && $(this).find('#hdnAttachedSubCategoryFolderName').html().trim() != ""
                                    }).each(function () {
                                        var tempHtml = '<a href="javascript:void(0)" class="downloadLinkedDocument hasFile" title="Download Document"><i class="fa fa-file icon-red downloadDocumentFile"></i></a><input type="file" class="documentFile" accept=".pdf, .doc, .docx, .xls, .xlsx" style="display: none;" />';
                                        $(this).find('.function-btn a:last()').after(tempHtml);
                                    });

                                    $html.filter(function () {
                                        return $(this).find('#hdnCatCalucaltedType').html() != undefined && $(this).find('#hdnCatCalucaltedType').html().trim() == "NE"
                                    }).each(function () {
                                        var htmlGLIcon = '<a title="Imported/Copied, (non editable)" href="javascript:void(0)" class="gl-imported-rows"><i class="fa fa-minus-circle"></i></a>';
                                        $(this).find('td:first()').append(htmlGLIcon);
                                    });

                                    //$.each($html, function (i, val) {
                                    //    if ($(val).find('#hdnAttachedSubCategoryFolderName').html() != undefined && $(val).find('#hdnAttachedSubCategoryFolderName').html().trim() != "") {
                                    //        var hoverText = $(val).find('#hdnFromExcel').html().split('|')[1] != undefined ? "(Linked to Row " + $(val).find('#hdnFromExcel').html().split('|')[1] + ") - Download Excel" : "Download Excel";
                                    //        var tHtml = '<a href="javascript:void(0)" class="downloadLinkedExcel" title="' + hoverText + '"><i class="file-excel-filed downloadSubCatExcel"></i><span data-rowno="' + $(val).find('#hdnFromExcel').html().split('|')[1] + '" class="exl-rowno">Row ' + $(val).find('#hdnFromExcel').html().split('|')[1] + '</span></a>';
                                    //        $(val).find('td:first()').append(tHtml);
                                    //    }

                                    //    if ($(val).find('#hdnCatCalucaltedOn').html() != undefined && $(val).find('#hdnCatCalucaltedOn').html().trim() != "") {
                                    //        var urlLink = $(val).find('#hdnCatCalucaltedType').html().trim() == "FOA" ? "/Formula/EditFormula/" + $(val).find('#hdnCatCalucaltedOn').html().trim() : $(val).find('#hdnCatCalucaltedType').html().trim() == "C2C" ? "/C2C/EditC2C/" + $(val).find('#hdnCatCalucaltedOn').html().trim() : "/Rule/EditRule/" + $(val).find('#hdnCatCalucaltedOn').html().trim();
                                    //        var formulaName = $(val).find('#hdnFormulaName').html().trim();
                                    //        if ($(val).find('.edit-formula').length == 0) {

                                    //            var htmlInputIcon = $(val).find('#hdnIsFOAEliminationType').html() != "True" ? '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(val).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>' : '';

                                    //            var htmlA = htmlInputIcon;
                                    //            htmlA += $('#hdnUserInManageFormulaRole').val() == 'True' ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '><img src="/assets/admin/layout/img/fx-sign.png"></a>' : "";

                                    //            $(val).find('td:first()').append(htmlA)
                                    //        }
                                    //    }

                                    //    if ($(val).find('#hdnAttachedSubCategoryFolderName').html() != undefined && $(val).find('#hdnAttachedSubCategoryFolderName').html().trim() != "") {
                                    //        var tempHtml = '<a href="javascript:void(0)" class="downloadLinkedDocument" title="Download Document"><i class="fa fa-file icon-red downloadDocumentFile"></i></a>';
                                    //        $(val).find('.function-btn a:last()').before(tempHtml);
                                    //    }
                                    //});

                                    var stcRow = $html.filter(function () {
                                        return ($(this).find('#STCCompM1').html() == 'N' || $(this).find('#STCCompM2').html() == 'N' || $(this).find('#STCCompM3').html() == 'N' || $(this).find('#STCCompM4').html() == 'N' ||
                                                $(this).find('#STCCompM5').html() == 'N' || $(this).find('#STCCompM6').html() == 'N' || $(this).find('#STCCompM7').html() == 'N' || $(this).find('#STCCompM8').html() == 'N' ||
                                                $(this).find('#STCCompM9').html() == 'N' || $(this).find('#STCCompM10').html() == 'N' || $(this).find('#STCCompM11').html() == 'N' || $(this).find('#STCCompM12').html() == 'N' || ( RetailBudgetPro.Budget.numberOfPeriodsVal == 13 && $(this).find('#STCCompM13').html() == 'N'))
                                    }).eq(0);

                                    if (stcRow.length > 0) {
                                        
                                        if (( RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && stcRow.find('td[id^=STCComp]:not(#STCCompM13):containsExact("N")').length == 12) || ( RetailBudgetPro.Budget.numberOfPeriodsVal == 13 && stcRow.find('td[id^=STCComp]:containsExact("N")').length == 13))
                                            stcRow.prevAll('tr.show-action-btns.active-row').eq(0).find('div.action-items a.edit').addClass('hide');

                                        if ($('[name="lstStores"]').find('option:selected').length == 1) {

                                            $('.budgets-table').find('.header').find('th[data-period^=P]').each(function () {

                                                var period = parseInt($(this).attr('data-period').slice(-2))

                                                if (stcRow.find('#STCCompM' + period).text().trim() == 'N' && $(this).find('i').length == 0) $(this).append("<i class='fa fa-minus-circle STCComp' title='Month is Inactive'></i>");

                                            });
                                        }
                                    }
                                    // Call tabelizer to display data in a level form
                                    $('#DataInputTable').tabelize();

                                    RetailBudgetPro.Budget.InitializeMultiselect();

                                    //$('#DataInputTable').find('.formulaType').each(function () {
                                    //    var html = $(this).html();
                                    //    var parent = $(this).parents('td');
                                    //    $(this).remove();
                                    //    parent.append(html);

                                    //});

                                    $(document).find('tr.unapproved-sent, tr.unapproved-pending').filter(function () {
                                        if ($('#hdnUserInApproveBudget').val() == "True") {
                                            $(this).find('.detailed-view').appendTo($(this).find('.detailed-view').parents('td'));
                                        }
                                        else {
                                            $(this).find('.rowStatus').appendTo($(this).find('.rowStatus').parents('td'));
                                        }
                                        return false;
                                    });

                                    // After tabelizer,make the default changes
                                    $tr.removeClass('budgetdata');
                                    RetailBudgetPro.Budget.ManageDataAndPerentage();
                                    // removing expander
                                    $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                                    $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                                    $('.hideyear').find('td:first').html('');

                                    //$('.layout').css('display', 'none');

                                    // In case the category is selected in the category dropdown then expand to the category level at once.
                                    if ((viewlevel == "DEPARTMENT" || $($html).find('#hdnViewLevel').html() == "CATEGORY") && $('[name=groupedcategory]').val().split('|')[1] != "-1") {
                                        $($html).filter('[data-allowdetailview!="False"]').find('.expander').trigger('click');
                                    }

                                    var summaryOnlyPopoverHTML = '<a class="popover-icon summary-only-popover" data-toggle="popover" data-trigger="hover" data-placement="right" data-original-title="" data-content="Your administrator has restricted the access to the sub-category data for this category."><i class="icon-info"></i></a>';

                                    var hasSummaryOnlyRow = 0;

                                    $($html).filter('[data-allowdetailview="False"]').each(function () {
                                        var $labelDiv = $(this).find('.expander').next('.label');
                                        if ($labelDiv.html() != undefined) {

                                            $labelDiv.attr('title', $labelDiv.html().trim() + " (Summary Only)");

                                            $labelDiv.html($labelDiv.html().trim() + "<span class='summary-cat'>(Summary Only)</span>");

                                            var $parentTd = $(this).find('.expander').parents('td');

                                            $parentTd.append(summaryOnlyPopoverHTML);

                                            $parentTd.removeAttr('title');

                                            if (hasSummaryOnlyRow == 0) hasSummaryOnlyRow = 1;
                                        }
                                    });

                                    if (hasSummaryOnlyRow == 1) {
                                        $('.summary-only-popover[data-toggle="popover"]').popover({
                                            container: 'body',
                                            delay: { show: 50, hide: 100 }
                                        });
                                    }

                                    $('#DataInputTable tbody tr').removeClass('highlight').addClass('blurView');

                                    $tr.removeClass('blurView');

                                    // setting the focused view to detect on which store/category we are working on.
                                    if ($('[name=groupedcategory]').val().split('|')[1] != "-1") {
                                        $tr.nextUntil('.l1').addClass('highlight').removeClass('blurView');
                                    }
                                    else {
                                        $tr.nextUntil('.l' + level).addClass('highlight').removeClass('blurView');
                                    }

                                    $(".vendor-info-icon").popover({
                                        html: true,
                                        content: function () {
                                            return $(this).parents('td').find('[id="vendor-info"]').html()
                                        },
                                        delay: { show: 50, hide: 100 }
                                    });

                                    $(".modifiedByUser-info-icon").popover({
                                        html: true,
                                        content: function () {
                                            var $row = $(this).parents('td').find('[id="modifiedByUserNameDiv"]');
                                            $row.find('span.datModifiedDate').html(RetailBudgetPro.Layout.ConvertToLocalDateTime($row.find('span.datModifiedDate').html()))
                                            return $(this).parents('td').find('[id="modifiedByUserNameDiv"]').html()
                                        },
                                        delay: { show: 50, hide: 100 }
                                    });

                                },
                                error: function (err) {
                                    console.log(err);
                                }

                            });
                        }
                    },
                    onAfterRowClick: function () {
                    }
                });
            }

            // Methods initialization when the page loads.

            $('select.tbudgetYearDropDown').val($('#hdnBudgetYear').val()).trigger('click')

            $(document).find('table').find('.percentage').css('display', 'none');
            $('.percentage,.data').click(RetailBudgetPro.Budget.ManageDataAndPerentage);
            $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
            $(document).on('click', '.expandYear', RetailBudgetPro.Budget.ShowHistoricalData);
            $(document).on('click', '.collapseYear', RetailBudgetPro.Budget.HideHistoricalData);
            $(document).on('click', '.displayDataInput', function () {
                $('.budgets-table').find('.header').find('th[data-period^=P] i.STCComp').remove();
                RetailBudgetPro.Budget.fetchPercentApprovedValues = 1;
                RetailBudgetPro.Budget.DisplayFilteredData();
            });
            $('.hideyear').find('td:first').html('');
            $('.checkComp').click(RetailBudgetPro.Budget.CheckAllComp);
            $('.checkNonComp').click(RetailBudgetPro.Budget.CheckAllNonComp);
            $(document).on('click', '.copyValues', RetailBudgetPro.Budget.CopyValuesToRow);            
            $(document).on('click', '.newLineLink', RetailBudgetPro.Budget.AddNewLine);
            $(document).on('click', '.distributeTotalEven', RetailBudgetPro.Budget.DistributeTotalEven);
            $(document).on('click', '.distributeTotalPercent', RetailBudgetPro.Budget.DistributeTotalPercent);
            $(document).on('click', '.action-items .edit', RetailBudgetPro.Budget.EditCategoryData);
            $(document).on('click', '.action-items .undo', RetailBudgetPro.Budget.UndoCategorySaveData);
            $(document).on('click', '.checkAllToDelete', RetailBudgetPro.Budget.SelectAllRows);
            $(document).on('click', '.expander', RetailBudgetPro.Budget.OnContractBottomLevelCategory);
            $(document).on('click', '.deleteBottomLevelCategory', RetailBudgetPro.Budget.DeleteBottomLevelCategory);
            $(document).on('keypress', '.growthRateValue', RetailBudgetPro.Budget.AllowOnlyNumbers);
            $(document).on('click', '.recalculateTotals', RetailBudgetPro.Budget.DisplayFilteredData);
            $(document).on('click', '.resetData', RetailBudgetPro.Budget.ResetData);
            $(document).on('click', '.bottomLevelCategoryComment,.growthRate', RetailBudgetPro.Budget.GetCommentRow);
            $(document).on('click', '.budgets-table tr', RetailBudgetPro.Budget.SetBackgroundForSelectedRow);
            $(document).on('click', '.growthRate', RetailBudgetPro.Budget.DistributeGrowthrateByPercent);
            $(document).on('click', '.copyGrowthRateForPreviousYear', RetailBudgetPro.Budget.CopyGrowthRateofPreviousYear);
            $(document).on('click', '.copyGrowthRate', RetailBudgetPro.Budget.CopyGrowthRate);
            $(document).on('click', '.copyGrowthRateForGreaterThan100Percent', RetailBudgetPro.Budget.CopyGrowthRateSubmitHandler);
            $(document).on('click', '.copyGrowthRateOfPrevYear_GrtrThn100Prcnt', RetailBudgetPro.Budget.CopyGrowthRateSubmitHandler_PrevYear);
            $(document).on('click', '.saveComment', RetailBudgetPro.Budget.SaveComment);
            $(document).on('click', '.expandAllHistoricalData', RetailBudgetPro.Budget.ExpandAllHistoricalData);
            $(document).on('click', '.collapseAllHistoricalData', RetailBudgetPro.Budget.CollapseAllHistoricalData);
            $(document).on('change', '.formulamodal .allocationSalaryCheck [name$="VendorUID"], .formulamodal .overtimeSalaryCheck [name$="VendorUID"], .formulamodal .allocationHourCheck [name$="VendorUID"], .formulamodal .overtimeHourCheck [name$="VendorUID"]', RetailBudgetPro.Budget.VendorDDFunc)
            $(document).on('sumo:closed', '.allocationSalaryCheck table .vendorLstDD', RetailBudgetPro.Budget.SetVendorToAllocationSalaryCheckTable)

            $(document).on('click', 'tr.store-childData-row td:not(.vendorLst) input[type="text"]:not(.sumo-search)', function () {
                $(this).calculator({ customDecimalPlaces: $(this).attr('data-decimalplaces') });
            });

            $(document).on('change', '.srcCat, [name="TransactionModeDropdown"]', function () {
                $('.srcCat').prop('title', $('.srcCat option:selected').attr("data-title"));

                if ($.browser.mozilla || $('[name=groupedcategory]').val().split('|')[1] == -1 || $('#hdnAllMonthsLocked').val() == "True" || $('#hdnIsUserInApproveBudgetRole').val() == "False") $('.CopyToMultipleStores').addClass('hide');
                else $('.CopyToMultipleStores').removeClass('hide');

                $('.budgets-table').find('.header').find('th[data-period^=P] i.STCComp').remove();
                RetailBudgetPro.Budget.fetchPercentApprovedValues = 1;
                RetailBudgetPro.Budget.DisplayFilteredData()
            });

            $(document).on('keyup', '.isVendor', RetailBudgetPro.Budget.AvoidTidleInVendorDescription);

            $(document).on('click', '.copy', RetailBudgetPro.Budget.SetSource);
            //$(document).on('click', '.excelDownload', RetailBudgetPro.Budget.GenerateExcel);   
            $(document).on('click', '.generate-excel', RetailBudgetPro.Budget.GenerateExcel);

            $(document).on('click', '.sort-date .sort-both, .sort-date .sort-asc, .sort-date .sort-desc', RetailBudgetPro.Budget.SortTransactionDate);

            $(document).on('click', '.sort-vendor .sort-both, .sort-vendor .sort-asc, .sort-vendor .sort-desc', RetailBudgetPro.Budget.SortVendor);

            $(document).on('click', '.sort-description .sort-both, .sort-description .sort-asc, .sort-description .sort-desc', RetailBudgetPro.Budget.SortDescription);

            $(document).on('click', '.sort-total .sort-both, .sort-total .sort-asc, .sort-total .sort-desc', RetailBudgetPro.Budget.SortTotal);

            $.calculator.setDefaults({ showOn: 'operator', buttonImageOnly: true, buttonImage: 'calculator.png' });
            RetailBudgetPro.Budget.SetLockedMonthsOnHeader();
            RetailBudgetPro.Budget.DisplayFilteredData();

            DisableLockedPeriodsForCopyModal();
            DisableLockedPeriodsForCopyModalBS();

            $(document).on('change', '.tbudgetDropDown', RetailBudgetPro.Budget.BudgetDropDownChange);
            $(document).on('click', '.change-budget', RetailBudgetPro.Budget.ChangeBudgetBtnClick);
            $(document).on('click', '.cancel-change-budget', RetailBudgetPro.Budget.CancelChangeBudgetBtnClick);
            $('.tbudgetDropDown').select2();
            $('.tbudgetYearDropDown').select2();

            $(document).on('click', '.cancelUpload', function () {
                $('[name=RowNumber]').val('');
                $('#ExcelFile').val('');
            });

            var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val() - 1;
            var currentYear = $('#hdnBudgetYear').val() - (startMonthOfFiscalYear == 0 ? 0 : 1);
            var daysToMinDate = Math.ceil((new Date(currentYear, startMonthOfFiscalYear, 01) - new Date()) / (1000 * 60 * 60 * 24));
            var daysToMaxDate = Math.ceil((new Date(currentYear, 12 + startMonthOfFiscalYear, 0) - new Date()) / (1000 * 60 * 60 * 24));

            $('#transactionPopup').find('[name=TransactionDate]').datepicker({
                rtl: Metronic.isRTL(),
                dateFormat: 'mm/dd/yy',
                minDate: daysToMinDate + 'D',
                maxDate: daysToMaxDate + 'D',
                autoclose: true
            });

            $('#transactionPopup').find('select.dayOfPeriodDropdown').select2({
                dropdownCssClass: 'balancesheet-grid-selectors'
            });

            $(document).on('click', '.downloadSubCatExcel', RetailBudgetPro.Budget.DownloadSubCatExcel);

            $(document).on('click', '#subCatExcelUploadPopUp .submitFile', RetailBudgetPro.Budget.UploadSubCatExcel);

            $(document).on('click', '.upload-excel', RetailBudgetPro.Budget.ShowUploadSubCatExcelPopup);

            $(document).on('click', '.downloadSubCatTemplate', RetailBudgetPro.Budget.DownloadSubCatTemplate);

            $(document).on('click', '.closeCommentDialog', RetailBudgetPro.Budget.CloseCommentDialog);

            $(window).on('focus', function () {
                RetailBudgetPro.Budget.CheckForBudgetChangeInSession();
            });

            var timeout;
            $(document).on('input', '.amortize-period', function (e) {
               
                var $this = $(e.currentTarget);

                var value = $this.val();
                var currentValue = $this.parents('tr').find('#hdnPLElementUID').text() > 0 ? $this.attr('data-currentvalue') : -1;
                
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;
                }

                timeout = setTimeout(function () {
                    if (currentValue == 1 && value > 1) {
                        var confirmClick = function () {
                            $this.attr('data-currentvalue', value);
                            RetailBudgetPro.Budget.AmortizePeriodChange($this, "AmortizePeriod");
                        }

                        var cancelClick = function () {
                            $this.val(currentValue);
                        }

                        var $groupedCategory = $('[name=groupedcategory] :selected');
                        var amortLable = "";

                        if ($groupedCategory.attr('data-isdepreciationcategory') == "True") {
                            amortLable = "depreciation";
                        }
                        else if ($groupedCategory.val().split('|')[1] == '-1') {
                            amortLable = "amortization/depreciation";
                        }
                        else {
                            amortLable = "amortization";
                        }

                        custom_confirm(confirmClick, cancelClick, "Confirm", "The values for this period will move to the corresponding period for the " + amortLable + " change. Please click Ok to confirm.");
                    }
                    else { RetailBudgetPro.Budget.AmortizePeriodChange($this, "AmortizePeriod") }
                }, 500)
            });

            $(document).on('change', '[name="subCategoryTermDD"]', function () {
                RetailBudgetPro.Budget.AmortizePeriodChange($(this));
            })

            $(document).on('keydown', '.isVendor', RetailBudgetPro.Budget.VendorFocusOut);

            localStorage.removeItem("ExpandedRows");

            localStorage.removeItem("ExpandRows");

            $('.tbudgetYearDropDown').select2('val', $('#hdnBudgetYear').val());

            $(document).on('click', '.linked-category-data', RetailBudgetPro.Budget.GetLinkedCategoryData);

            $(document).on('click', '.add-new-line', RetailBudgetPro.Budget.AddNewLineToPopUp);

            $(document).on('click', '.delete-row', RetailBudgetPro.Budget.RemovePopupRow);

            $(document).on('click', '.addNewRow', RetailBudgetPro.Budget.AddNewLineToPayrollPopUp);

            $(document).on('click', '.deleteChildRow', RetailBudgetPro.Budget.RemovePayrollPopupRow);

            $(document).on('click', '.save-category-data', RetailBudgetPro.Budget.SaveRelatedCategoryData);

            $(document).on('click', '.copyPeriodValues', RetailBudgetPro.Budget.CopyPeriodValuesToRow);

            $(document).on('click', '.distributeTotalEvenly', RetailBudgetPro.Budget.DistributeTotalEvenly);

            $(document).on('click', '.LinkToDataPage', RetailBudgetPro.Budget.LinkToDataPage);

            $(document).on('click', '.locationRowCheck', RetailBudgetPro.Budget.CheckModalRow);

            $(document).on('click', '.selectAllStores', RetailBudgetPro.Budget.SelectAllStores);

            $(document).on('click', '.unselectAllStores', RetailBudgetPro.Budget.UnselectAllStores);

            $(document).on('shown.bs.modal', '#static-1', function () {
                $('.excelDownload').one('focus', function (e) { $(this).blur(); });
            });

            $(document).on('change', '.tbudgetYearDropDown', RetailBudgetPro.Budget.BudgetYearDropDownChange);

            $(document).on('click', '.change-budgetYear', RetailBudgetPro.Budget.ChangeBudgetYearBtnClick);

            $(document).on('click', '.cancel-change-budgetYear', RetailBudgetPro.Budget.CancelChangeBudgetYearBtnClick);

            $(document).on('click', '.documentUpload, .downloadLinkedDocument', RetailBudgetPro.Budget.SubCatDocumentBtnClick);

            $(document).on('click', '.downloadDocument', RetailBudgetPro.Budget.SubCatDocumentDownload)

            $(document).on('click', '.deleteDocument', RetailBudgetPro.Budget.SubCatDocumentDelete)

            $(document).on('click', '.show-all-data', RetailBudgetPro.Budget.ShowAllDataRows);

            $(document).on('click', '.action-items .comment', RetailBudgetPro.Budget.ToggleCommentMode);

            $(document).on('click', '.linked-currency-data', RetailBudgetPro.Budget.GetLinkedCurrencyData);

            $(document).on('click', '.save-linked-currency-data', RetailBudgetPro.Budget.SaveRelatedCurrencyData);

            $(document).on('click', '.distributeTotalFXRates', RetailBudgetPro.Budget.DistributeTotalFXRates);
            
            //$(document).on('click', '.pasteToSingleStore', RetailBudgetPro.Budget.GetModalForSingleStoreDataPaste);

            $(document).on('click', '.CopyToMultipleStores', RetailBudgetPro.Budget.GetModalForMultipleStoreDataPaste);

            $(document).on('click', '.saveCopiedData', RetailBudgetPro.Budget.SaveCopiedData);

            $(document).on('click', '.closeCopiedDataModal', RetailBudgetPro.Budget.CloseCopiedDataModal);

            $(document).on('hover', '.accrualEditData-info-icon', RetailBudgetPro.Budget.ShowAccrualEditData);

            $(document).on('input', '.commentModal .comment', function (e) {
                var remCommentLen = parseInt($('.commentModal .char-limit-msg').attr('data-remcommentlength'));
                var noteLen = $(this).val().length;

                if (noteLen == remCommentLen) {
                    e.preventDefault();
                } else if (noteLen > remCommentLen) {
                    // Maximum exceeded
                    $(this).val($(this).val().substring(0, remCommentLen));
                }
            });

            //document.getElementById('CopyPasteToMultipleStoresModal').addEventListener('paste', function (event) {

            //    $('.layout').show();

            //    var clipText = event.clipboardData.getData('text/html');

            //    var startIndex = clipText.indexOf('<table');
                
            //    var $modal = $('#CopyPasteToMultipleStoresModal');
                
            //    if (startIndex > 0) {

            //        var $valueTr = $($.parseHTML(clipText.substring(startIndex, clipText.indexOf('</table>') + 8))).find('tr').eq(0);

            //        $modal.find('tr.copiedRow').each(function () {

            //            var $tr = $(this);

            //            RetailBudgetPro.Budget.AddValuesToDataCopyModal($tr, $valueTr);
            //        })

            //        $modal.find('.copy-error-msg').addClass('hide');
            //    }
            //    else {
            //        $modal.find('.copy-error-msg').removeClass('hide');
            //    }

            //    $('.layout').hide();

            //    event.preventDefault();
            //});

            //document.getElementById('CopyPasteToSingleStoreModal').addEventListener('paste', function (event) {

            //    $('.layout').show();

            //    var clipText = event.clipboardData.getData('text/html');

            //    var startIndex = clipText.indexOf('<table');

            //    var $modal = $('#CopyPasteToSingleStoreModal');
               
            //    var storeUID = $modal.find('[name="hdnStoreUID"]').val();
            //    var currencyUID = $modal.find('[name="hdnCurrencyUID"]').val();
            //    var CategoryUID = $modal.find('[name="hdnCategoryUID"]').val();

            //    var isfinancialcat = $('[name="groupedcategory"] option[value$="|' + CategoryUID + '"]').data('isfinancialcat') == "True";

            //    var currencyCode = isfinancialcat ? $modal.find('[name="hdnCurrencyCode"]').val() : "";

            //    if (startIndex > 0) {

            //        $($.parseHTML(clipText.substring(startIndex, clipText.indexOf('</table>') + 8))).find('tr').each(function () {

            //            RetailBudgetPro.Budget.AddNewLineToDataCopyModal($modal, storeUID, currencyUID, currencyCode);

            //            var $tr = $modal.find('table tbody tr:last');
            //            var $valueTr = $(this);

            //            RetailBudgetPro.Budget.AddValuesToDataCopyModal($tr, $valueTr);

            //        })

            //        $modal.find('[type=text]').each(function () {
            //            if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('descriptionVal') && !$(this).hasClass('vendorVal') && !$(this).hasClass('store-desc')) {
            //                $(this).calculator();
            //            }
            //        });

            //        $modal.find('.copy-error-msg').addClass('hide');
            //    }
            //    else {
            //        $modal.find('.copy-error-msg').removeClass('hide');
            //    }
                
            //    $('.layout').hide();

            //    event.preventDefault();
            //});

            $(document).on('click', '.pasteToSingleStore', function () {

                var parentRow = $(this).parents('tr');

                if ($.browser.mozilla) {
                    var confirmClick = function () {
                    }
                    custom_alert(confirmClick, "Alert", "Failed to access the clipboard.");
                }
                else {

                    var confirmClick = function () {
                        $('.layout').show();

                        var datalevel = parentRow.data('level');
                        var vendorName = $('#VendorName').val();

                        navigator.permissions.query({ name: "clipboard-read" }).then(result => {

                            if (result.state == "granted" || result.state == "prompt") {
                                navigator.clipboard.read().then(data => {

                                    for (let i = 0; i < data.length; i++) {
                                        if (data[i].types.indexOf("text/html") > -1) {

                                            const blob = data[i].getType("text/html");

                                            blob.then(d => {
                                                const reader = new FileReader();

                                                reader.onload = function () {

                                                    if ($($.parseHTML(reader.result)).find('tr').length > 0) {

                                                        var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');

                                                        $($($.parseHTML(reader.result)).find('tr').get().reverse()).each(function () {
                                                            var html = "";

                                                            html = getNewRow(parentRow, parseInt(datalevel) + 1);

                                                            var finalHtml = $(html).insertBefore($(parentRow).nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel.showyear:first'));

                                                            finalHtml.removeClass('show-action-btns');

                                                            // If the locked periods are more than 1 then hide the distro buttons(=,%) and growth rate button
                                                            if (lockedMonthsList.length >= 1 && lockedMonthsList[0] != "") {
                                                                $(finalHtml).find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
                                                                $(finalHtml).find('.action-btn .usePeriodRedistribution').addClass('lockedMonthsActionBtns');
                                                                $(finalHtml).find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
                                                                $(finalHtml).find('.growthRate').addClass('lockedMonthsActionBtns');

                                                                for (var counter = 0; counter < lockedMonthsList.length; counter++) {

                                                                    $(finalHtml).find('.total').attr('readonly', 'readonly').addClass('lockedMonths');

                                                                    $(finalHtml).find('input[type=text]').each(function () {

                                                                        if ($(this).hasClass(lockedMonthsList[counter].trim(''))) {
                                                                            $(this).attr('readonly', 'readonly').addClass('lockedMonths');
                                                                        }
                                                                    });
                                                                }
                                                            }

                                                            $(finalHtml).find('input[type=text]:not(.sumo-search)').each(function () {
                                                                if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('isVendor') && !$(this).hasClass('isDescription')) {
                                                                    // show calculator only for the textboxes which are not period-locked
                                                                    $(this).calculator();
                                                                }
                                                            });

                                                            $(finalHtml).find('[name=subCategoryCurrencyDD]').SumoSelect();

                                                            $(finalHtml).find('[name=subCategoryTermDD]').SumoSelect();

                                                            if (showOptionsInVendorDropDown)
                                                                $(finalHtml).find('[name=VendorUID]').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + vendorName, optWrapperCstmWidthToAuto: true, venList: vendorList });
                                                            else
                                                                $(finalHtml).find('[name=VendorUID]').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + vendorName, optWrapperCstmWidthToAuto: true });

                                                            RetailBudgetPro.Budget.ManageDataAndPerentage();

                                                            var $tr = $(parentRow).nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel.showyear:first');
                                                            var $valueTr = $(this);

                                                            RetailBudgetPro.Budget.AddValuesToDataCopyModal($tr, $valueTr, 1);
                                                        });

                                                        $('.layout').hide();
                                                    }
                                                    else {
                                                        var confirmClick = function () {
                                                        }
                                                        $('.layout').hide();
                                                        custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                                    }
                                                };

                                                reader.readAsText(d);
                                            });
                                        } else {
                                            var confirmClick = function () {
                                            }
                                            $('.layout').hide();
                                            custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                        }
                                    }
                                })
                            }
                            else {
                                var confirmClick = function () {
                                }
                                $('.layout').hide();
                                custom_alert(confirmClick, "Alert", "Please allow the site to read from the clipboard.");
                            }
                        });
                    }
                    var cancelClick = function () { }

                    custom_confirm(confirmClick, cancelClick, "Confirm", "Please confirm you wish to append sub-categories rows based on the data copied to your clipboard from Excel. Note, description will be the first column, " + $('#VendorName').val() + " will be the second column and period 1 will be the third column and so on from the cells you copy from Excel.", "Paste", "Cancel");
                    
                    
                }
            });

            $(document).on('click', '.pasteToSameRow', function () {
                var $currentTr = $(this).parents('.copiedRow');

                navigator.permissions.query({ name: "clipboard-read" }).then(result => {

                    if (result.state == "granted" || result.state == "prompt") {
                        navigator.clipboard.read().then(data => {

                            var $modal = $('#CopyPasteToMultipleStoresModal');

                            for (let i = 0; i < data.length; i++) {

                                if (data[i].types.indexOf("text/html") > -1) {
                                    const blob = data[i].getType("text/html");

                                    blob.then(d => {
                                        const reader = new FileReader();

                                        reader.onload = function () {
                                            if ($($.parseHTML(reader.result)).find('tr').length > 0) {

                                                var $valueTr = $($.parseHTML(reader.result)).find('tr').eq(0);

                                                var $tr = $currentTr;

                                                RetailBudgetPro.Budget.AddValuesToDataCopyModal($tr, $valueTr, 0);
                                            }
                                            else {
                                                var confirmClick = function () {
                                                }
                                                custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                            }
                                        };

                                        reader.readAsText(d);
                                    });
                                } else {
                                    var confirmClick = function () {
                                    }
                                    custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                }
                            }
                        })
                    }
                    else {
                        alert("Please allow the site to read from the clipboard.")
                    }
                });
            });

            $(document).on('click', '.pasteAllRowsToAllStores', function () {
                navigator.permissions.query({ name: "clipboard-read" }).then(result => {

                    if (result.state == "granted" || result.state == "prompt") {
                        navigator.clipboard.read().then(data => {

                            var $selectedCategory = $('[name="groupedcategory"] option:selected');

                            var showBalanceSheetColumns = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && ($selectedCategory.data('isfinancialcat') == "True" || $selectedCategory.data('isbalancesheet') == "True")) ? "True" : "False";

                            var $modal = showBalanceSheetColumns == "True" ? $('#CopyPasteToMultipleStoresModalBS') : $('#CopyPasteToMultipleStoresModal');

                            //var $modal = $('#CopyPasteToMultipleStoresModal');

                            for (let i = 0; i < data.length; i++) {

                                if (data[i].types.indexOf("text/html") > -1) {
                                    const blob = data[i].getType("text/html");

                                    blob.then(d => {
                                        const reader = new FileReader();

                                        reader.onload = function () {
                                            if ($($.parseHTML(reader.result)).find('tr').length > 0) {
                                                $($.parseHTML(reader.result)).find('tr').each(function (indexVal) {
                                                    var $valueTr = $(this);

                                                    var $tr = $modal.find('tr.copiedRow').eq(indexVal);

                                                    RetailBudgetPro.Budget.AddValuesToDataCopyModal($tr, $valueTr, 0);

                                                });
                                            }
                                            else {
                                                var confirmClick = function () {
                                                }
                                                custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                            }
                                        };

                                        reader.readAsText(d);
                                    });
                                } else {
                                    var confirmClick = function () {
                                    }
                                    custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                }
                            }
                        })
                    }
                    else {
                        alert("Please allow the site to read from the clipboard.")
                    }
                });
            });

            $(document).on('click', '.pasteSingleRowToAllStore', function () {
                navigator.permissions.query({ name: "clipboard-read" }).then(result => {

                    if (result.state == "granted" || result.state == "prompt") {
                        navigator.clipboard.read().then(data => {
                            var $selectedCategory = $('[name="groupedcategory"] option:selected');

                            var showBalanceSheetColumns = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && ($selectedCategory.data('isfinancialcat') == "True" || $selectedCategory.data('isbalancesheet') == "True")) ? "True" : "False";

                            var $modal = showBalanceSheetColumns == "True" ? $('#CopyPasteToMultipleStoresModalBS') : $('#CopyPasteToMultipleStoresModal');
                            //var $modal = $('#CopyPasteToMultipleStoresModal');

                            for (let i = 0; i < data.length; i++) {

                                if (data[i].types.indexOf("text/html") > -1) {
                                    const blob = data[i].getType("text/html");

                                    blob.then(d => {
                                        const reader = new FileReader();

                                        reader.onload = function () {                                            
                                            if ($($.parseHTML(reader.result)).find('tr').length > 0) {

                                                var $valueTr = $($.parseHTML(reader.result)).find('tr').eq(0);

                                                $modal.find('tr.copiedRow').each(function () {

                                                    var $tr = $(this);

                                                    RetailBudgetPro.Budget.AddValuesToDataCopyModal($tr, $valueTr, 0);
                                                });
                                            }
                                            else {
                                                var confirmClick = function () {
                                                }
                                                custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                            }
                                        };

                                        reader.readAsText(d);
                                    });
                                } else {
                                    var confirmClick = function () {
                                    }
                                    custom_alert(confirmClick, "Alert", "This function copies data from your clipboard. The data in your clipboard must be from an Excel workbook and not any other application.");
                                }
                            }
                        })
                    }
                    else {
                        alert("Please allow the site to read from the clipboard.")
                    }
                });

            });

            $(document).on('click', '.openTransactionPopup', RetailBudgetPro.Budget.SetTransaction);

            $(document).on('click', '.saveTransactionDate', RetailBudgetPro.Budget.SaveTransaction);

            $(document).on('click', '.transaction-date', function () { $(this).datepicker('show'); });

            $(document).on('keypress', '.amortize-period', function (evt) {
                evt = (evt) ? evt : window.event;
                var charCode = (evt.which) ? evt.which : evt.keyCode;
                if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                    return false;
                }
                return true;
            });

            $(document).on('keypress', '#TransactionDate', function (e) { e.preventDefault(); });

            $(document).on('click', '.commentModeOn', function (e) {

                $target = $(e.target);

                //if (!($target.attr('data-target') == undefined)) {
                //    var modalId = $target.attr('data-target');
                //    $(modalId).parents('.modal-scrollable').remove();
                //    $('.modal-backdrop').remove();
                //}

                if ($($target).attr('data-target') == undefined || $($target).attr('data-target') == '#comment-modal') {

                    var plelementUID = parseFloat($target.closest('tr').find('#hdnPLElementUID').text());
                    var commentDoneOnField = '';
                    var categoryDesc = '';
                    var departmentDesc = '';

                    var catUID = parseInt($target.closest('tr').find('#hdnCatUID').text());
                    var deptUID = parseInt($target.closest('tr').find('#hdnStoreUID').text());

                    if ($target.hasClass('desc-field'))
                        commentDoneOnField = 'Description';
                    else if ($($target.closest('td'))[0].hasAttribute("data-period"))
                        commentDoneOnField = $target.closest('td').attr('data-period');
                    else if ($target.closest('td').attr('title') == 'Total')
                        commentDoneOnField = 'Total';

                    if ($('#ShowVendor').val() == "True") {
                        if ($target.hasClass('vendor'))
                            commentDoneOnField = 'Vendor';
                    }
                    else {
                        if ($target.prev('input').hasClass('isVendor'))
                            commentDoneOnField = 'Vendor';
                    }

                    var tempID = 'comment-modal' + Math.floor(1000 + Math.random() * 9999);

                    $target.attr('data-target', '#' + tempID);

                    $('.layout').show();

                    $.ajax({
                        url: '/Budget/GetUserComments',
                        type: 'POST',
                        dataType: 'html',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            PlElementUID: plelementUID,
                            CommentDoneOnField: commentDoneOnField
                        }),
                        success: function (result) {

                            var $cTar = $(document).find('[data-target="#' + tempID + '"]');

                            $('#comment-modal #hrefAttrVal').val($cTar.attr('data-href'));
                            $('#comment-modal #typeAttrVal').val($cTar.attr('data-type'));

                            var newID = 'comment-modal' + Math.floor(1000 + Math.random() * 9999);

                            $cTar.attr('data-target', '#' + newID);
                            $cTar.attr('data-toggle', 'modal');
                            $('.page-content-wrapper').append(result);
                            $('.page-content-wrapper').find('#comment-modal').attr('id', newID);

                            $('.commentNote').hide();
                            $('.routeToDataPage').hide();

                            $('.layout').hide();

                            $(document).on('shown.bs.modal', '#' + newID, function () {
                                var $commentContainer = $(this).find('.comment-container');
                                $commentContainer.scrollTop($commentContainer.height());
                                ConverToLocalDateTime($commentContainer);
                                $(this).find('.period').html($cTar.closest('td').attr('title'));
                                $(this).find('.categoryDesc').html($cTar.closest('td').parent('tr').prevAll('tr.historicaldata.level2:first').find("td:first").attr('title'));
                                $(this).find('.storeDesc').html($cTar.closest('td').parent('tr').prevAll('tr.level1:first').find("td:first").attr('title'));

                            });

                            $('#' + newID).modal('show');

                            $("[name=lstUsers]").SumoSelect({ selectAll: true, search: true, searchText: 'Search' });

                        },
                        error: function (er) {
                            $(document).find('[data-target="#"' + tempID + ']').removeAttr('data-target');
                            console.log(er);
                        }
                    });

                }

            });

            $(document).on('click', '.save-comments', function (e) {
                var $target = $(e.target);

                if ($target.parents('.modal').find('.input-comment-text').val().trim() != "") {

                    var $modalTarget = $(document).find('[data-target="#' + $target.parents('.modal').attr('id') + '"]');
                    var $modal = $target.parents('.modal');

                    var plelementUID = parseFloat($modalTarget.closest('tr').find('#hdnPLElementUID').text());
                    var storeUID = parseFloat($modalTarget.closest('tr').find('#hdnStoreUID').text());
                    var categoryUID = parseFloat($modalTarget.closest('tr').find('#hdnCatUID').text());
                    var budgetUID = parseInt($('[name=BudgetUID]').val());
                    var budYear = parseInt($('[name=BudgetDefaultYear]').val());

                    var commentDoneOnField = '';

                    if ($modalTarget.hasClass('desc-field'))
                        commentDoneOnField = 'Description';
                    else if ($($modalTarget.closest('td'))[0].hasAttribute("data-period"))
                        commentDoneOnField = $modalTarget.closest('td').attr('data-period');
                    else if ($modalTarget.closest('td').attr('title') == 'Total')
                        commentDoneOnField = 'Total';

                    if ($('#ShowVendor').val() == "True") {
                        if ($modalTarget.hasClass('vendor'))
                            commentDoneOnField = 'Vendor';
                    }
                    else {
                        if ($modalTarget.prev('input').hasClass('isVendor'))
                            commentDoneOnField = 'Vendor';
                    }

                    var notificationText = 'mentioned you in a comment about ';

                    var commentText = '';
                    var notifyUserIdCSV = '';
                    if ($modal.find('[name="lstUsers"]').val() != null) {
                        commentText = '@' + $modal.find('[name="lstUsers"]').val().map(function (v, i) { return v.split('|')[0].trim() }).join(', @') + ' ' + $target.parents('.modal').find('.input-comment-text').val();
                        notifyUserIdCSV = $modal.find('[name="lstUsers"]').val().map(function (v, i) { return v.split('|')[1].trim() }).join(',');
                    }
                    else {
                        commentText = $target.parents('.modal').find('.input-comment-text').val();
                        notifyUserIdCSV = -1;
                    }

                    $('.layout').show();

                    $.ajax({
                        url: '/Budget/SaveUserComments',
                        type: 'POST',
                        dataType: 'html',
                        contentType: 'application/json',
                        data: JSON.stringify({

                            PlElementUID: plelementUID,
                            CommentDoneOnField: commentDoneOnField,
                            CommentText: commentText,
                            NotifyUserIdCSV: notifyUserIdCSV,
                            NotificationText: notificationText,
                            StoreUID: storeUID,
                            CategoryUID: categoryUID,
                            BudgetUID: budgetUID,
                            BudgetYear: budYear

                        }),
                        success: function (result) {
                            $modal.find('.modal-body .comment-container').append(result);
                            $modal.find('.input-comment-text').val('');

                            var d = $modal.find('.comment-container');
                            d.scrollTop(d.prop("scrollHeight"));

                            ConverToLocalDateTime(d);

                            if ($($modalTarget.closest('td'))[0].hasAttribute("data-period")) {
                                var dataPeriod = $modalTarget.parents('td').attr('data-period');
                                $modalTarget.parents('td').parents('tr').find('td[data-period="' + dataPeriod + '"]').addClass("hasComment");
                            }
                            else if (($modalTarget.closest('td').attr('title') == 'Total')) {
                                $modalTarget.parents('td').parents('tr').find('td[title="Total"]').addClass("hasComment");
                            }
                            else
                                $modalTarget.parents('td').addClass("hasComment");

                            $('.layout').hide();

                        },
                        error: function (er) {
                            console.log(er);
                        }
                    });
                }
            });

            $(document).on('click', '.close-icon', function () {
                $(this).parents('.modal').find('.close-pop-up').trigger('click');
            });

            $(document).on('click', '.delete-comment', function (e) {
                var $target = $(e.currentTarget);

                var $detailsDiv = $target.parents('.comment-details');

                var $parentModal = $target.parents('.dashboard-comment-modal');

                $('.layout').show();
                //alert($target.attr('data-id'));
                $.ajax({
                    url: '/Dashboard/DeleteUserComment',
                    type: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({ id: $target.attr('data-id') }),
                    success: function (result) {
                        $detailsDiv.remove();

                        if ($parentModal.find('.comment-details').length == 0) {
                            if ($('[data-target="#' + $parentModal.attr('id') + '"]').parents('td')[0].hasAttribute("data-period")) {
                                var dataPeriod = $('[data-target="#' + $parentModal.attr('id') + '"]').parents('td').attr('data-period');
                                $('[data-target="#' + $parentModal.attr('id') + '"]').parents('td').parents('tr').find('td[data-period="' + dataPeriod + '"]').removeClass("hasComment");
                            }
                            else if ($('[data-target="#' + $parentModal.attr('id') + '"]').parents('td').attr('title') == 'Total') {
                                $('[data-target="#' + $parentModal.attr('id') + '"]').parents('td').parents('tr').find('td[title="Total"]').removeClass("hasComment");
                            }
                            else
                                $('[data-target="#' + $parentModal.attr('id') + '"]').parents('td').removeClass('hasComment');
                        }

                        $('.layout').hide();
                    },
                    error: function (er) {
                        console.log(er);
                    }
                });
            });

            $(document).on('change', 'input.documentFile', function (submitEvent) {
                var $this = $(this);
                var formdata = new FormData();
                var fileInput = $this.get(0);
                var setAttachedFolderNameElement = $(this).closest('tr').children('td#hdnAttachedSubCategoryFolderName');

                var extensionArray = ["doc", "docx", "pdf", "xls", "xlsx"];
                var filename = $this.val();
                var extension = filename.replace(/^.*\./, '');
                if ($.inArray(extension, extensionArray) == -1) {
                    setAttachedFolderNameElement.html("");
                    $this.parents('.action-btn').find('a.documentUpload i').removeClass('icon-red')
                    custom_dialog("Ok", "", "Alert", "File must be in .doc, .docx, .pdf, .xls or .xlsx format.");
                    submitEvent.preventDefault();
                }
                else {
                    if (fileInput.files.length != 0) {
                        $('.layout').show();
                        for (i = 0; i < fileInput.files.length; i++) {
                            formdata.append(fileInput.files[i].name, fileInput.files[i]);
                        }

                        $.ajax({
                            url: "/Budget/SaveAttachedSubCatDocument",
                            type: "POST",
                            contentType: false,
                            processData: false,
                            data: formdata,
                            dataType: 'json',
                            success: function (result) {
                                if (result.isMalicious) {
                                    $('.layout').hide();
                                    custom_dialog("Ok", "", "Alert", result.errorMsg);
                                }
                                else {
                                    setAttachedFolderNameElement.html(result.fileFolder);
                                    $this.parents('.action-btn').find('a.documentUpload i').addClass('icon-red');
                                    $('.layout').hide();
                                    //console.log(result);
                                }
                            },
                            error: function (err) {
                                console.log(err);
                            }
                        });
                    }
                }
            });

            $(document).on('click', '.refresh-totals,.refresh-average', RetailBudgetPro.Budget.CalculateRowTotal);

            //$(document).on('click', '.edit-rel-category', RetailBudgetPro.Budget.EditRelatedCategoryData);

            //$(document).on('click', '.undo-rel-category', RetailBudgetPro.Budget.UndoEditRelatedCategoryData);

            $(document).on('click', '.show-all-stores', RetailBudgetPro.Budget.ShowAllStoreOnInpupPopup);
            $(document).on('click', '.hide-all-stores', RetailBudgetPro.Budget.HideAllStoreOnInpupPopup);

            //$(document).on('click', '.save.saveUnapproved', RetailBudgetPro.Budget.SaveUnapprovedDataInput);

            //$(document).on('click', '.approve-data,.reject-data', RetailBudgetPro.Budget.SaveApprovedRejectedDataInput);

            //if ($(document).find('#hdnUserInApproveBudget').val() == "True") {
            $(document).on('click', '.save.saveByApprover', RetailBudgetPro.Budget.SaveDataInput);
            //}
            //else {
            $(document).on('click', '.submitForApproval', RetailBudgetPro.Budget.SubmitDataForApproval);
            $(document).on('click', '.saveByRequester', RetailBudgetPro.Budget.SaveUnapprovedDataInput);
            $(document).on('click', '.detailed-view', RetailBudgetPro.Budget.GetApprovalData);
            $(document).on('click', '.submit-approval-request,.submit-reject-request,.save-approval-comments', RetailBudgetPro.Budget.ProcessApprovalRequest);
            $(document).on('click', '.submit-approve-directly', RetailBudgetPro.Budget.SubmitApproveRejectDirectly);
            $(document).on('click', '.submit-reject-directly', RetailBudgetPro.Budget.SubmitRejectDirectly);
            $(document).on('click', '.reject-data', RetailBudgetPro.Budget.ProcessRejectRequest);

            $(document).on('click', '.show-more-rows', RetailBudgetPro.Budget.GetMoreSubCatRows);

            $(document).on('click', '.undo-pending', RetailBudgetPro.Budget.UndoPending);

            $(document).on('click', '.submit-delete-request', RetailBudgetPro.Budget.SubmitDeleteRequest);

            //}

            //$(document).on('click', '.show-more-rows', RetailBudgetPro.Budget.GetMoreSubCatRows);

            $(document).on('click', '.usePeriodRedistribution', RetailBudgetPro.Budget.UsePeriodRedistribution);

            $(document).on('click', '.save-payroll-data', RetailBudgetPro.Budget.SavePayrollData);

            $(document).on('click', '.show-employee-stores', function () {
                var $nonEditableRows = $('#' + $(this).parents('.modal').attr('id')).find('tr.non-editable-row');

                $nonEditableRows.show();

                $nonEditableRows.find('input[type=text]').attr('readonly', 'readonly').removeClass('yellowBckgTxtBx').addClass('removeBackgndColor');

                $nonEditableRows.find('.payrollDistributeEvenly').removeClass('show').hide();

                $nonEditableRows.find('select.vendorLstDD').attr('disabled', 'disabled').css('opacity', 0);

                $nonEditableRows.find('.vendorDD p').removeClass('yellowBckg');
            });

            $(document).on('click', '.save-balanceSheet-data', RetailBudgetPro.Budget.SaveLinkedCategoryBSData);

            $(document).on('click', '.savePayrollDataForParentEmp', RetailBudgetPro.Budget.SavePayrollDataForParentEmp);

            $(document).on('click', '.periodRedistribute', RetailBudgetPro.Budget.DistributeTotalValueBy4_4_5);
            $(document).on('click', '.payrollDistributeEvenly', RetailBudgetPro.Budget.DistributeTotalPayrollValueEvenly);

            $(document).on('click', '[name="EmployeePayroll.DisplayAmountFormat"]', RetailBudgetPro.Budget.DisplayFormattedDataOnPopUp);

            $(document).on('click', '.showDollarAmount', function () {
                DistributeAnnualSalary('#' + $(this).parents('.payrollModal').attr('id'));
            });

            $(document).on('click', '.RecalculateForParentEmp', function () {
                DistributeAnnualSalaryForParentEmp('#' + $(this).parents('.payrollModal').attr('id'));
            });

            $(document).on('click', '.distributeTotal', RetailBudgetPro.Budget.DistributeTotal);

            $(document).on('sumo:closed', '[name="lstStores"]', RetailBudgetPro.Budget.EnableDisableCurrencyLocalOption);

            $(document).on('shown.bs.modal', '#growthRatePopUp, #growthRatePopUpForPreviousYear', RetailBudgetPro.Budget.HideCompoundRate);

            $(document).on('click', '.batch-update', RetailBudgetPro.Budget.BatchUpdateProcess);

            if ($('#ShowVendor').val() == "True")
                RetailBudgetPro.Budget.SetGlobalVendorList();

            var originalLeave = $.fn.popover.Constructor.prototype.leave;
            $.fn.popover.Constructor.prototype.leave = function (obj) {
                var self = obj instanceof this.constructor ?
                    obj : $(obj.currentTarget)[this.type](this.getDelegateOptions()).data('bs.' + this.type)
                var container, timeout;

                originalLeave.call(this, obj);

                if (obj.currentTarget) {
                    container = $(obj.currentTarget).siblings('.popover')
                    timeout = self.timeout;
                    container.one('mouseenter', function () {
                        //We entered the actual popover  call off the dogs
                        clearTimeout(timeout);
                        //Let's monitor popover content instead
                        container.one('mouseleave', function () {
                            $.fn.popover.Constructor.prototype.leave.call(self, self);
                        });
                    })
                }
            };

            $(window).resize(function () {
                setTimeout(function () {
                    FreezeDataInputTable()
                }, 60)
                
            });

            //function to handle Ctrl+RightArrow event
            document.onkeydown = function (e) {
                var evtobj = window.event ? event : e;

                if (evtobj.keyCode == 39 && (evtobj.ctrlKey || evtobj.metaKey)) RetailBudgetPro.Budget.CopyValueWithShortcut();
            };
        },

        IninializeYearRange: function () {
            $('.layout').hide();

            var confirmClick = function () {
                var budgetUID = parseInt($('[name=BudgetUID]').val());
                var year = parseInt($('[name=BudgetDefaultYear]').val());
                location.href = '/Budget/DataInput/' + budgetUID + "/" + year;
            }

            custom_alert(confirmClick, "Confirm", "Looks like you entered invalid " + $("#hdnBudgetAlias").val() + " year. Expected " + $("#hdnBudgetAlias").val() + " year range is +5 and -3 to the default year. You will now be redirected to the default " + $("#hdnBudgetAlias").val() + " year.");
        },

        SetVendorToAllocationSalaryCheckTable: function () {
            var lstVendor = $(this).find('option:selected').map(function () {
                return $(this).text()
            }).get().join()

            var StoreUID = $(this).parents('tr').find('[name$="StoreUID"]').val()

            $('.allocationSalaryDollarCheck table').find('[name$="StoreUID"][value="' + StoreUID + '"]').parents('tr').find('.vendorDataLst').text(lstVendor)

        },

        CheckForBudgetChangeInSession: function () {
            $('#spinnerLayout').addClass('showPerm');
            var budgetUId = parseInt($('[name=BudgetUID]').val());
            var budgetYear = parseInt($('[name=BudgetYear]').val());
            $.ajax({
                url: '/Budget/CheckBudgetInSession',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify({ BudgetId: budgetUId, BudgetYear: budgetYear }),
                contentType: 'application/json',
                async: true,
                success: function (result) {
                    $('#spinnerLayout').removeClass('showPerm');
                    if (!result.success) {

                        var confirmClick = function () {
                            window.location.href = result.url;
                        }

                        if ($('#dialog').is(':data(uiDialog)') === true && $("#dialog").dialog("isOpen") === true) {
                            $("#dialog").dialog("close");
                        }

                        custom_alert2(confirmClick, "Alert", "There is change in " + $("#hdnBudgetAlias").val() + " session so the page will refresh.");
                    }
                },
                error: function (er) {
                    console.log(er);
                }
            });
        },

        BudgetDropDownChange: function () {

            var currentBudgetId = parseInt($('[name=BudgetUID]').val());

            var $this = this;

            var selectedBudgetId = parseInt($($this).val().split(',')[0]);

            var selectedYear = parseInt($($this).find('option:selected').attr('data-year'));

            if (currentBudgetId != selectedBudgetId) {

                localStorage.setItem("selectedBudget", "");
                localStorage.setItem("selectedBudgetYear", "");

                location.href = '/Budget/DataInput/' + selectedBudgetId + "/" + selectedYear;
            }

        },

        ChangeBudgetBtnClick: function () {
            $(this).addClass('hide');
            $('.datainput-header.budDesc').addClass('hide');
            $('.tbudgetDropDown').removeClass('hide');
            $('.cancel-change-budget').removeClass('hide');
            $('.budgetdropdown-parent-div').removeClass('hide');

            $('.tbudgetDropDown').select2('val', $('#hdnBudgetUID').val());// + ' , ' + $('#hdnBudgetYear').val());
        },

        CancelChangeBudgetBtnClick: function () {
            $(this).addClass('hide');
            $('.datainput-header.budDesc').removeClass('hide');
            $('.budgetdropdown-parent-div').addClass('hide');
            $('.tbudgetDropDown').addClass('hide');
            $('.change-budget').removeClass('hide');
        },

        AvoidTidleInVendorDescription: function (e) {
            if (e.keyCode == 0) {
                return false;
            }
        },

        // Function used to sort the bottom level rows on the basis of Transaction Date
        SortTransactionDate: function () {
            $parentTr = $(this).parents('tr');

            $parentTr.find('.sort-description a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            $parentTr.find('.sort-total a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            $parentTr.find('.sort-vendor a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');

            var rows = $parentTr.nextUntil('.doNotExpand.totals').filter('.budgetdata.bottomLevel.showyear');

            var $trPointer = $parentTr;

            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True") {
                $trPointer = rows.eq(0).prev();
            }

            var sortOrder = $(this).attr('class') == "sort-desc" || $(this).attr('class') == "sort-both" ? "asc" : "desc";

            if (sortOrder == "asc") $(this).removeClass('sort-both').removeClass('sort-desc').addClass('sort-asc');
            else $(this).removeClass('sort-both').removeClass('sort-asc').addClass('sort-desc');

            rows.sort(function (a, b) {

                var A = new Date($(a).find('.transactionDateDiv span.transactionSpan').attr('data-value'));
                var B = new Date($(b).find('.transactionDateDiv span.transactionSpan').attr('data-value'));

                A = new Date(A.getFullYear(), A.getMonth(), A.getDate());
                B = new Date(B.getFullYear(), B.getMonth(), B.getDate());

                if (A > B) {
                    return sortOrder == "desc" ? 1 : -1;
                }

                if (A < B) {
                    return sortOrder == "desc" ? -1 : 1;
                }

                return 0;
            });

            for (var t = 0; t < rows.length; t++) {
                $(rows[t]).detach();
                $trPointer.after($(rows[t]));
            }
        },

        // BD-1123|saurabh| Function to show Accrual Edit Mode data in the Accrual View Mode
        ShowAccrualEditData: function () {
            if ($(this).data("bs.popover") == undefined) {
                var tableHtml = '<table class="table table-bordered dataTable" id="accrualEditDataTable">' +
                    '<thead>' +
                    '<tr>' +
                    '<th>' + $('#period01Alias').val() + '</th>' +
                    '<th>' + $('#period02Alias').val() + '</th>' +
                    '<th>' + $('#period03Alias').val() + '</th>' +
                    '<th>' + $('#period04Alias').val() + '</th>' +
                    '<th>' + $('#period05Alias').val() + '</th>' +
                    '<th>' + $('#period06Alias').val() + '</th>' +
                    '<th>' + $('#period07Alias').val() + '</th>' +
                    '<th>' + $('#period08Alias').val() + '</th>' +
                    '<th>' + $('#period09Alias').val() + '</th>' +
                    '<th>' + $('#period10Alias').val() + '</th>' +
                    '<th>' + $('#period11Alias').val() + '</th>' +
                    '<th>' + $('#period12Alias').val() + '</th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>' +
                    '<tr>';

                var $parentTr = $(this).parents('tr');

                var value = '';

                if ($parentTr.hasClass('noFormulaRow')) {
                    $parentTr.find('.DATVal').each(function () {
                        var $span = $(this).parent('td').find('span');

                        if (typeof $span.attr('data-editvalue') !== 'undefined') value = $span.attr('data-editvalue').replace(/,/g, '');
                        else value = $span.attr('data-value').replace(/,/g, '');

                        tableHtml += '<td>' + ReplaceNumberWithCommas(Number(value)) + '</td>';
                    });
                }
                else if ($parentTr.hasClass('editableRow')) {
                    $parentTr.find('.DATVal').each(function () {
                        value = $(this).attr('data-accrualeditmodeval').replace(/,/g, '');
                        tableHtml += '<td>' + ReplaceNumberWithCommas(Number(value)) + '</td>';
                    });
                }
                else {
                    $parentTr.find('td.data.rightAlign').not('.DATValueTotalF').each(function () {
                        value = $(this).find('span').attr('data-value').replace(/,/g, '');
                        tableHtml += '<td>' + ReplaceNumberWithCommas(Number(value)) + '</td>';
                    });
                }

                tableHtml += '</tr>' +
                    '</tbody>' +
                    '</table>';

                $(this).popover({
                    html: true,
                    container: 'body',
                    template: '<div class="popover accrualEditDataPopover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
                    content: tableHtml,
                    delay: { show: 50, hide: 100 },
                    trigger: "hover",
                    placement: "bottomLeft",
                    title: parseInt($parentTr.find('.amortizePeriodLst span').text()) == 1 ? "Accrual Edit Mode Values" : "Unamortized Amount"
                });

                $(this).popover('show');

                $(this).on('show.bs.popover', function () {
                    var popover = $(this).attr('data-content', tableHtml).data('bs.popover');
                    popover.setContent();
                });
            }
        },

        ReplaceNumberWithCommas: function(yourNumber) {
            //Seperates the components of the number
            var n = yourNumber.toString().split(".");
            //Comma-fies the first part
            n[0] = n[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            //Combines the two sections
            return n.join(".");
        },

        // Function used to sort the bottom level rows on the basis of vendor description
        SortVendor: function () {
            //$parentTr = $(this).parents('tr');
            //var vendorArray = [];
            //var rowArray = [];
            //var counter = 0;
            //var indexArray = [];
            //var tempArray = [];


            //$parentTr.nextUntil('.bottomLevel.historicaldata', '.bottomLevel').each(function () {
            //    var vendor = $(this).find('.isVendor').next().html();
            //    vendorArray.push(vendor + "|" + counter);
            //    tempArray.push(vendor);
            //    indexArray.push(counter);
            //    counter++;
            //});


            //for (var counter = 0; counter < vendorArray.length; counter++) {
            //    if (counter + 1 < vendorArray.length) {
            //        if ($(this).attr('id') == "asc") {
            //            if (vendorArray[counter].split('|')[0] > vendorArray[counter + 1].split('|')[0]) {
            //                var temp = vendorArray[counter];
            //                vendorArray[counter] = vendorArray[counter + 1];
            //                vendorArray[counter + 1] = temp;
            //                counter = -1;
            //            }
            //        }
            //        else {
            //            if (vendorArray[counter].split('|')[0] < vendorArray[counter + 1].split('|')[0]) {
            //                var temp = vendorArray[counter + 1];
            //                vendorArray[counter + 1] = vendorArray[counter];
            //                vendorArray[counter] = temp;
            //                counter = -1;
            //            }
            //        }
            //    }
            //}

            ////console.log(vendorArray);

            //$parentTr.nextUntil('.bottomLevel.historicaldata', '.bottomLevel').each(function () {
            //    rowArray.push($(this));
            //});

            //var finalArray = [];
            //for (var counter = 0; counter < vendorArray.length; counter++) {
            //    finalArray[counter] = rowArray[vendorArray[counter].split('|')[1]];
            //}
            ////  console.log(finalArray);
            //counter = 0;
            //$parentTr.nextUntil('.bottomLevel.historicaldata', '.bottomLevel').each(function () {
            //    $(this).prop('outerHTML', $(finalArray[counter][0]).prop('outerHTML'));
            //    counter++;
            //});

            $parentTr = $(this).parents('tr');

            $parentTr.find('.sort-description a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            $parentTr.find('.sort-total a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12)
                $parentTr.find('.sort-date a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');

            var rows = $parentTr.nextUntil('.doNotExpand.totals').filter('.budgetdata.bottomLevel.showyear');//$parentTr.nextUntil('.bottomLevel.historicaldata:not(.newRowAfterDelAll)', '.bottomLevel:not(.newRowAfterDelAll)');

            var $trPointer = $parentTr;

            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True") {
                $trPointer = rows.eq(0).prev();
            }

            var sortOrder = $(this).attr('class') == "sort-desc" || $(this).attr('class') == "sort-both" ? "asc" : "desc";

            if (sortOrder == "asc") $(this).removeClass('sort-both').removeClass('sort-desc').addClass('sort-asc');
            else $(this).removeClass('sort-both').removeClass('sort-asc').addClass('sort-desc');

            var hdnShowVendorVal = $('#ShowVendor').val();

            if (hdnShowVendorVal == "True") {
                rows.sort(function (a, b) {
                    return sortOrder == "desc" ?
                        RetailBudgetPro.Layout.sortAlphaNum($(a).find('span.vendor').text().toLowerCase(), $(b).find('span.vendor').text().toLowerCase()) :
                        RetailBudgetPro.Layout.sortAlphaNum($(b).find('span.vendor').text().toLowerCase(), $(a).find('span.vendor').text().toLowerCase());
                });
            }
            else {
                rows.sort(function (a, b) {
                    return sortOrder == "desc" ?
                        RetailBudgetPro.Layout.sortAlphaNum($(a).find('.isVendor').val().toLowerCase(), $(b).find('.isVendor').val().toLowerCase()) :
                        RetailBudgetPro.Layout.sortAlphaNum($(b).find('.isVendor').val().toLowerCase(), $(a).find('.isVendor').val().toLowerCase());
                });
            }

            for (var t = 0; t < rows.length; t++) {
                $(rows[t]).detach();
                $trPointer.after($(rows[t]));
            }

        },

        // Function used to sort the bottom level rows on the basis of DATDescription
        SortDescription: function () {

            $parentTr = $(this).parents('tr');

            $parentTr.find('.sort-vendor a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            $parentTr.find('.sort-total a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12)
                $parentTr.find('.sort-date a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');

            var rows = $parentTr.nextUntil('.doNotExpand.totals').filter('.budgetdata.bottomLevel.showyear');//$parentTr.nextUntil('.bottomLevel.historicaldata:not(.newRowAfterDelAll)', '.bottomLevel:not(.newRowAfterDelAll)');

            var $trPointer = $parentTr;

            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True") {
                $trPointer = rows.eq(0).prev();
            }

            var sortOrder = $(this).attr('class') == "sort-desc" || $(this).attr('class') == "sort-both" ? "asc" : "desc";

            if (sortOrder == "asc") $(this).removeClass('sort-both').removeClass('sort-desc').addClass('sort-asc');
            else $(this).removeClass('sort-both').removeClass('sort-asc').addClass('sort-desc');

            rows.sort(function (a, b) {
                return sortOrder == "desc" ?
                       RetailBudgetPro.Layout.sortAlphaNum($(a).find('.isDescription').val().toLowerCase(), $(b).find('.isDescription').val().toLowerCase()) :
                       RetailBudgetPro.Layout.sortAlphaNum($(b).find('.isDescription').val().toLowerCase(), $(a).find('.isDescription').val().toLowerCase());
            });

            for (var t = 0; t < rows.length; t++) {
                $(rows[t]).detach();
                $trPointer.after($(rows[t]));
            }
        },

        // Function used to sort the bottom level rows on the basis of total
        SortTotal: function () {
            $parentTr = $(this).parents('tr');

            $parentTr.find('.sort-vendor a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            $parentTr.find('.sort-description a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');
            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12)
                $parentTr.find('.sort-date a').removeClass('sort-desc').removeClass('sort-asc').addClass('sort-both');

            var rows = $parentTr.nextUntil('.doNotExpand.totals').filter('.budgetdata.bottomLevel.showyear');//$parentTr.nextUntil('.bottomLevel.historicaldata:not(.newRowAfterDelAll)', '.bottomLevel:not(.newRowAfterDelAll)');

            var $trPointer = $parentTr;

            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True") {
                $trPointer = rows.eq(0).prev();
            }

            var sortOrder = $(this).attr('class') == "sort-desc" || $(this).attr('class') == "sort-both" ? "asc" : "desc";

            if (sortOrder == "asc") $parentTr.find('.sort-total a').removeClass('sort-both').removeClass('sort-desc').addClass('sort-asc');
            else $parentTr.find('.sort-total a').removeClass('sort-both').removeClass('sort-asc').addClass('sort-desc');

            var textboxClass = $(this).closest('div.sort-total').hasClass('sortTotalByDollar') ? '.data.DATValueTotalF' : '.percentage.DATValueTotalPF';

            rows.sort(function (a, b) {

                var aText = $(a).find('td' + textboxClass).text().trim();
                var bText = $(b).find('td' + textboxClass).text().trim();

                var A = parseFloat(aText == 'N/A' || aText == '-' || aText == '' ? '0' : aText.replace(/,/g, "").replace(/\%/g, "").replace(/\+/g, ''));

                var B = parseFloat(bText == 'N/A' || bText == '-' || bText == '' ? '0' : bText.replace(/,/g, "").replace(/\%/g, "").replace(/\+/g, ''));

                if (A > B) {
                    return sortOrder == "desc" ? 1 : -1;
                }

                if (A < B) {
                    return sortOrder == "desc" ? -1 : 1;
                }

                return 0;
            });

            for (var t = 0; t < rows.length; t++) {
                $(rows[t]).detach();
                $trPointer.after($(rows[t]));
            }
        },

        // Used to open the copy budget view with copy category into another category tab selected
        SetSource: function () {
            var val = "DataInput";
            $.ajax({
                url: '/Budget/SetSource',
                data: "{ Source:'" + val + "'}",
                contentType: "application/json; charset=UTF-8",
                type: 'POST',
                async: true,
                success: function () {
                },
                error: function (err) {
                    console.log(err);
                }
            });

        },
        // Expanding all the historical data
        ExpandAllHistoricalData: function () {
            var level = $(this).parents('tr').data('level');
            //$(this).parents('tr').prevUntil('.netsales').each(function () {

            var $RowsToSearch = "";
            var filtered = "";
            if (level > 1) {
                // Incase we are at level greater than 1 than expand all the historical data till level 1                
                $RowsToSearch = $(this).parents('tr').prevUntil('tr[data-level=1]');

                // in case the category is already selected 
                // prevent the totals of the cat level to expand
                if ($('[name=groupedcategory]').val().split('|')[1] != "-1") {

                    $RowsToSearch.each(function () {
                        if ($(this).hasClass('totals') && $(this).prev().hasClass('bottomLevel')) {
                            // clear the html of the bottomlevel historical data
                            $(this).next().html('');
                            $(this).next().next().html('');
                        }
                        else {

                        }
                    });
                }
            }
            else if (level == 1) {
                // Incase we are at level 1 than expand all the historical data of that level
                $RowsToSearch = $(this).parents('tr').prevAll('tr[data-level=1]');
            }

            $RowsToSearch.each(function () {
                if ($(this).data('level') == level) {
                    if (!$(this).hasClass('expanded')) {



                        // on Expand click add class collapseyear and remove expandyear to show historical data
                        $(this).find('.expandYear').removeClass('expandYear').addClass('collapseYear');

                        if (!$(this).hasClass('historicaldata')) // setting the title for the expader/collapse
                            $(this).find('.collapseYear').attr('title', "Hide historical data");
                        if (!$(this).hasClass('netsales')) {
                            $(this).next('tr').removeClass('hideyear').addClass('showyear');
                            $(this).next('tr').next('tr').removeClass('hideyear').addClass('showyear');
                        }
                    }
                    else {
                        $($(this).nextAll('.totals')[0]).find('.expandYear').removeClass('expandYear').addClass('collapseYear');
                        if (!$(this).hasClass('historicaldata')) // setting the title for the expader/collapse
                            $($(this).nextAll('.totals')[0]).find('.collapseYear').attr('title', "Hide historical data");
                        $($(this).nextAll('.totals')[0]).next('tr').removeClass('hideyear').addClass('showyear');
                        $($(this).nextAll('.totals')[0]).next('tr').next('tr').removeClass('hideyear').addClass('showyear');
                    }
                }
            });

            // To expand totals historical data
            $(this).parents('tr').find('.expandYear').removeClass('expandYear').addClass('collapseYear');
            if (!$(this).hasClass('historicaldata'))
                $(this).parents('tr').find('.collapseYear').attr('title', "Hide historical data");
            $(this).parents('tr').next('tr').removeClass('hideyear').addClass('showyear');
            $(this).parents('tr').next('tr').next('tr').removeClass('hideyear').addClass('showyear');


            return false;
        },
        // Collapsing all the historical data
        CollapseAllHistoricalData: function () {

            var level = $(this).parents('tr').data('level');
            var $RowsToSearch = "";
            if (level > 1) {
                // Incase we are at level greater than 1 than expand all the historical data till level 1     
                $RowsToSearch = $(this).parents('tr').prevUntil('tr[data-level=1]');
            }
            else if (level == 1) {
                // Incase we are at level 1 than expand all the historical data of that level
                $RowsToSearch = $(this).parents('tr').prevAll('tr[data-level=1]');
            }
            $RowsToSearch.each(function () {

                if ($(this).data('level') == level) {
                    if (!$(this).hasClass('expanded')) {
                        $(this).find('.collapseYear').removeClass('collapseYear').addClass('expandYear');
                        if (!$(this).hasClass('historicaldata')) // Setting the title of the expander/collapse
                            $(this).find('.expandYear').attr('title', "Show historical data");
                        if (!$(this).hasClass('netsales')) {
                            $(this).next('tr').removeClass('showyear').addClass('hideyear');
                            $(this).next('tr').next('tr').removeClass('showyear').addClass('hideyear');
                        }
                    }
                    else {
                        $($(this).nextAll('.totals')[0]).find('.collapseYear').removeClass('collapseYear').addClass('expandYear');
                        if (!$(this).hasClass('historicaldata')) // Setting the title of the expander/collapse
                            $(this).find('.collapseYear').attr('title', "Hide historical data");
                        $($(this).nextAll('.totals')[0]).next('tr').removeClass('showyear').addClass('hideyear');
                        $($(this).nextAll('.totals')[0]).next('tr').next('tr').removeClass('showyear').addClass('hideyear');
                    }
                }
            });

            // To collapse totals historical data
            $(this).parents('tr').find('.collapseYear').removeClass('collapseYear').addClass('expandYear');
            if (!$(this).parents('tr').hasClass('historicaldata'))
                $(this).parents('tr').find('.expandYear').attr('title', "Show historical data");
            $(this).parents('tr').next('tr').removeClass('showyear').addClass('hideyear');
            $(this).parents('tr').next('tr').next('tr').removeClass('showyear').addClass('hideyear');

            return false;
        },
        CopyGrowthRateSubmitHandler_PrevYear: function (e) {
            $('#growthRatePopUpForPreviousYear').modal('toggle');
            $('.layout').show();
            var copyFormat = $('#growthRatePopUpForPreviousYear').find('span.checked #CopyFormat').val();
            var $searchRows = $(currentRow).prevUntil('.expanded').not('.historicaldata').not('.totals').has('[type=checkbox]:enabled').filter(function (i) {
                return $(this).find('#hdnFromExcel').length == 0 || $(this).find('#hdnFromExcel').html().trim() == "";
            });
            var stores = [];
            var groupedcategory = $('[name=groupedcategory] :selected').val();
            var sourceBudgetYear = $(currentRow).find('[data-target="#growthRatePopUpForPreviousYear"]').attr('data-year');
            var stores = $('[name=lstStores]').val().toString();
            var datalevel = "0";
            var viewLevel = "STORE";
            var storeID = '-1';
            var deptID = '-1';
            var categoryID = '-1';
            var targetBudgetYear = $('[name=BudgetYear]').val();
            var vendorIdCSV = ($('#vendordd').val() == null ? '' : $('#vendordd').val().join());
            var growthPercentage = $('#growthRatePopUpForPreviousYear').find('.growthRateValue').val();
            var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
            var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));
            var growthType = $('#growthRatePopUpForPreviousYear').find('.checked [name=GrowthTypeForPreviousYear]').val();
            var growthCompoundPeriod = parseInt($('#growthRatePopUpForPreviousYear').find('[name="MonthlyPeriods"] :selected').val().replace(/\D/g, ''));

            if (!$(commentRow).hasClass('historicaldata')) {
                parentRow = $(currentRow);
                isCurrentYear = true;
            }
            else {
                // for historical year
                // Looping on the bottom level rows to map the values corresponding to the growth rate
                $searchRows.each(function () {
                    if ($(this).hasClass('bottomLevel')) {
                        datalevel = $(this).data('level');
                        storeID = $(this).find('#hdnStoreUID').text();
                        deptID = $(this).find('#hdnDeptUID').text();
                        categoryID = $(this).find('#hdnCatUID').text();
                        decimalPlaces = $(this).find('#hdnDecimalPlaces').text();
                        $(this).addClass('tempHideBottomLevel');
                        parentRow = $(this);
                    }
                });
            }

            $.ajax({
                url: '/Budget/GrowByPercentData',
                data: JSON.stringify({ SourceBudgetYear: sourceBudgetYear, TargetBudgetYear: targetBudgetYear, CopyType: copyFormat, CategoryUID: categoryID, StoreUID: storeID, DepartmentUID: deptID, GroupedCategory: groupedcategory, Level: '0', ViewLevel: viewLevel, Stores: stores, VendorUIDs: '-2', CompType: RetailBudgetPro.Budget.filter, GrowthPercentage: growthPercentage, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), bsMode: bsMode, categoryType: categoryType, GrowthType: growthType, GrowthCompoundPeriod: growthCompoundPeriod }),
                type: 'POST',
                async: true,
                dataType: 'html',
                contentType: "application/json; charset=UTF-8",
                success: function (data) {

                    //RemoveEditableMode(parentRow)

                    if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {
                        var rowString = $('.expanded').map(function (v) {
                            return $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html();
                        }).get().join();
                        localStorage.setItem("ActiveRow", parentRow.find('#hdnStoreUID').html() + '|' + parentRow.find('#hdnDeptUID').html() + '|' + parentRow.find('#hdnCatUID').html());
                        localStorage.setItem("ExpandedRows", rowString);
                        console.log(localStorage.getItem("ExpandedRows"))
                    }

                    localStorage.setItem("ExpandRows", "True");

                    RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                    $('#DataInputTable tbody').html('');
                    $('#DataInputTable tbody').html(data);
                    $(".hideyear").each(function () {
                        $(this).removeAttr("data-level");
                    });
                    $('#DataInputTable').find('.displayVendor').addClass('hide');
                    $('#DataInputTable').tabelize();
                    RetailBudgetPro.Budget.ManageDataAndPerentage();
                    $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                    $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                    $('.hideyear').find('td:first').html('');
                },
                error: function (err) {
                    console.log(err);
                }
            });
        },
        CopyGrowthRateofPreviousYear: function (e) {
            if (parseFloat(($('#growthRatePopUpForPreviousYear').find('.growthRateValue').val())) > 1) {
                $('#confirmPopUpOfPrevYear_GrtrThn100Prcnt').modal('show');
            }
            else {
                RetailBudgetPro.Budget.CopyGrowthRateSubmitHandler_PrevYear();
            }
        },
        CopyGrowthRateSubmitHandler: function () {
            $('#growthRatePopUp').modal('toggle');
            var $searchRows = $(currentRow).prevUntil('.expanded').not('.historicaldata').not('.totals').has('[type=checkbox]:enabled').filter(function (i) {
                return $(this).find('#hdnFromExcel').length == 0 || $(this).find('#hdnFromExcel').html().trim() == "";
            });

            // Initializing variables
            var data = [];
            var length = $searchRows.length;
            var growth = 1 + parseFloat(($('#growthRatePopUp').find('.growthRateValue').val()));
            var year = "";
            var guid = RetailBudgetPro.Budget.guid();
            var storeID = "";
            var deptID = "";
            var catID = "";
            var decimalPlaces = "";
            var isFOA = "";
            var comment = "";
            var datalevel = "";
            var classVal = "";
            var parentRow = "";
            var isCurrentYear = false;
            var growthType = $('#growthRatePopUp').find('.checked [name="GrowthType"]').val();
            var growthCompoundPeriod = $('#growthRatePopUp').find('[name="MonthlyPeriods"] :selected').val();

            // for Current  Year
            if (!$(commentRow).hasClass('historicaldata')) {
                parentRow = $(currentRow);
                isCurrentYear = true;
            }
            else {
                // for historical year
                // Looping on the bottom level rows to map the values corresponding to the growth rate
                $searchRows.each(function () {
                    if ($(this).hasClass('bottomLevel')) {
                        // Setting the values of the variables
                        year = $(this).find('td div.doNotExpand').html();
                        classVal = $(this).attr('class').toString() + " temp bottomLevel ";
                        datalevel = $(this).data('level');
                        storeID = $(this).find('#hdnStoreUID').text();
                        deptID = $(this).find('#hdnDeptUID').text();
                        catID = $(this).find('#hdnCatUID').text();
                        decimalPlaces = $(this).find('#hdnDecimalPlaces').text();
                        isFOA = $(this).find('#hdnIsFOA').text();
                        comment = $(this).find('#hdnComment').text();
                        $(this).addClass('tempHideBottomLevel');
                        parentRow = $(this);
                    }
                });
            }
            // Getting data row object of the current row 
            var element = getDataRowObject($(currentRow), "span", getNumberOfPeriods());

            // Mapping the growth rate
            mapNewRowOnCopyingGrowthRate(element, parentRow, growth, decimalPlaces, isCurrentYear, growthType, growthCompoundPeriod);
        },
        // Copying growth rate
        CopyGrowthRate: function () {

            if (parseFloat(($('#growthRatePopUp').find('.growthRateValue').val())) > 1) {
                $('#confirmationPopUpForGreaterThan100Percent').modal('show');
            }
            else {
                RetailBudgetPro.Budget.CopyGrowthRateSubmitHandler();
            }
        },
        // Distro method- Distributing the periods values on the basis of percent
        DistributeGrowthrateByPercent: function () {
            var element = $($(this).parents('tr').prevAll('.expanded')[0]).find('.edit');

	        // For branch BD-1122
            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "False" && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True") {
            //    var $parentTr = element.parents('tr');

            //    $parentTr.find('.checkAllToDelete').removeAttr("disabled");

            //    $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
            //        $(this).find('.selectRowToDelete').removeAttr("disabled");
            //    });
            //}

            RetailBudgetPro.Budget.EditCategoryData(element, "growthRate");
            currentRow = $(this).parents('tr');
        },
        GenerateExcel: function () {

            $('[name=IncludeHistData]').val($('.hist-data').prop('checked'));
            $('[name=IncludeSubCatData]').val($('.van-data').prop('checked'));
            localStorage.setItem("ReportDDValue", "DID");
            $('.close-pop-up').trigger('click');

            $('.layout').show();

            $.ajax({
                url: '/Budget/ExportYearData',
                data: JSON.stringify({ lstStores: $('[name=lstStores]').val(), groupedcategory: $('[name=groupedcategory]').val(), IncludeHistData: $('[name=IncludeHistData]').val(), IncludeSubCatData: $('[name=IncludeSubCatData]').val(), lstVendors: $('[name="datapageVendordd"]').val(), ShowInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), IsPercentageExport: ($('.percentage').hasClass('active') == true) }),
                type: 'POST',
                async: true,
                contentType: "application/json; charset=UTF-8",
                success: function (result) {
                    if (result.redirectToReport) {
                        var confirmClick = function () {
                            window.open(result.redirectURL, '_blank');
                        }
                        $('.layout').hide();
                        custom_alert(confirmClick, "Alert", "The requested data is too big to be downloaded here. You are now being redirected to the Reports area where this would be generated as a report.");
                    }
                    else {
                        $('.layout').hide();

                        var url = result.redirectURL;
                        url = url.substring(0, url.lastIndexOf("/")) + '/' + encodeURIComponent(url.split('/').pop());
                        window.location = url;
                        //window.location = encodeURI(result.redirectURL);
                    }
                },
                error: function (err) {
                    console.log(err);
                }
            });
        },
        // Method used to set the lock image on the table headers  (P01,P02,....)
        SetLockedMonthsOnHeader: function () {
            // Getting the locked months of a particular budget from hidden variable and spliting it to form an array.
            var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');

            // Getting the inactive months of a particular budget from hidden variable and spliting it to form an array.
            var inactiveMonthsList = $(document).find('#hdnInactiveMonths').val().split(',');

            // Incase there are locked months than set the locked image on the headers
            if (lockedMonthsList.length >= 1 && lockedMonthsList[0] != "") {
                $('.budgets-table').find('.header').find('th[data-period^=P]').each(function () {

                    for (var counter = 0; counter < lockedMonthsList.length; counter++) {
                        if ($(this).attr('data-period') == lockedMonthsList[counter].trim('')) {
                            // setting lock image on the headers
                            $(this).append("<i class='fa fa-lock'></i>");
                        }
                    }

                });
            }

            // Incase there are inactive months than set the inactive image on the headers
            if (inactiveMonthsList.length >= 1 && inactiveMonthsList[0] != "") {
                $('.budgets-table').find('.header').find('th[data-period^=P]').each(function () {

                    for (var counter = 0; counter < inactiveMonthsList.length; counter++) {
                        if ($(this).find('.fa-lock').length == 0 && $(this).attr('data-period') == inactiveMonthsList[counter].trim('')) {
                            // setting inactive image on the headers
                            $(this).append("<i class='fa fa-minus-circle'></i>");
                        }
                    }

                });
            }
        },
        // Method used to set the color of the selected row 
        SetBackgroundForSelectedRow: function () {
            $('.budgets-table tr').each(function () {
                $(this).removeClass('active-row');
            });
            // Add class active-row to show selected row by changing its color
            $(this).addClass('active-row');
        },
        // Method used to get the comment row(bottom level row) for which we are writing a comment
        GetCommentRow: function () {
            commentRow = $(this).parents('tr');

            $('.all-comments').html($(commentRow).find('#hdnComment').text());
            //$('.comment').val($(commentRow).find('#hdnComment').html());
            if ($(commentRow).prevAll('tr').not('.historicaldata, .budgetdata, .beginningBalance').eq(0).find('.edit').is(':visible') || $(commentRow).prevAll('tr').not('.historicaldata, .budgetdata, .beginningBalance').eq(0).find('.copy').is(':visible') || (commentRow.find('.isDescription').hasClass('lockedMonths') && $(commentRow).find('#hdnCatCalucaltedType').text() != 'NE') || ($('#hdnIsUserInAddCommentsRole').val() == 'True' && $('#hdnIsUserInEditDataPageRole').val() == 'False' && $('#hdnUserInRole').val() == 'False')) {
                //$('.comment').attr('readonly', 'readonly');
                $('#static .comment').addClass('hide');
                $('.commentModal').find('.saveComment').hide();
                $('.commentModal').find('.delete-all-notes').hide();
                $('.commentModal').find('.char-limit-msg').hide();
                if ($(commentRow).find('#hdnComment').text().trim() == "") {
                    $('.no-comment').removeClass('hide');
                }
                else {
                    $('.no-comment').addClass('hide');
                }
            }
            else {
                $('#static .comment').attr('readonly', false);
                $('#static .comment').removeClass('hide');
                $('.commentModal').find('.saveComment').show();
                $('.commentModal').find('.delete-all-notes').show();
                $('.commentModal').find('.char-limit-msg').show();
                $('.no-comment').addClass('hide');

                $('#static').find('.comment').val(commentRow.find('#hdnCurrentComment').html());

                //BD-722 | krishan | putting the maximum limit of all notes 1000 characters. we calculate current available chars for note after subtracting previous notes length(including the html stuff) and 250(maximum length of html) chars of html for current note. 
                if ($('.commentModal').find('.char-limit-msg').text().trim() == '') {
                    var oldCommentLen = $(commentRow).find('#hdnComment').text().trim().length;
                    var remCommentLen = (1000 - oldCommentLen - 250) < 0 ? 0 : (1000 - oldCommentLen - 250);

                    $('.commentModal').find('.char-limit-msg').text('Maximum limit: ' + remCommentLen + ' characters');
                    $('.commentModal').find('.char-limit-msg').attr('data-remcommentlength', remCommentLen);
                }
            }
        },
        // Method used to save the comment for a particular bottom level category.
        SaveComment: function () {
            //var nd = new Date();
            // setting the comment in the hidden field
            //commentRow.find('#hdnComment').text(commentRow.find('#hdnComment').text() + "|<br/> : " + $(this).parents('#static').find('.comment').val());                     

            if ($('#static').find('.comment').val().trim() != "") {
                commentRow.find('#hdnCurrentComment').text($('#static').find('.comment').val().trim());
                commentRow.find('.bottomLevelCategoryComment i').addClass('hasComment');
            }

            $('#static').find('.comment').val('');
            $('#static').find('.char-limit-msg').text('');

            $('.commentModal').modal('toggle');
        },

        CloseCommentDialog: function () {
            $('#static').find('.comment').val('');
            $('#static').find('.char-limit-msg').text('');
        },

        // Method used to reset the data 
        ResetData: function () {
            //Checking if save mode is open then on reset click show an alert
            if ($('#DataInputTable').find('.action-items .show .save').is(":visible")) {

                var confirmClick = function () {
                    $('#DataInputTable tbody tr').find('.current').each(function () {
                        $(this).removeClass('current');
                        $parentTr = $(this).parents('tr');
                        RemoveEditableMode($parentTr);
                        $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.temp:not(.beginningBalance)').remove();
                    });
                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Any unsaved changes will be lost");

                //if (confirm("Any unsaved changes will be lost")) {

                //}
            }
        },
        // Function used to allow only numbers in the textbox
        AllowOnlyNumbers: function (e) {
            var charCode = (e.which) ? e.which : e.keyCode
            if (charCode == 8 || ($(e.currentTarget).parents(".payrollModal").length == 1 && charCode == 44)) { // handle backspace and comma
                return true;
            }
            else {
                return isNumber(e, this);
            }
        },
        DeleteBottomLevelCategory: function (e) {

            var data = {};
            // Array used to hold the rows to be deleted
            var dataToDelete = [];
            var finalData = [];
            $periods = getNumberOfPeriods();
            var storeId = "";
            var deptId = "";
            var categoryId = "";
            var parentTr = $(e.target).parents('tr');
            var currentLevel = parseInt($(parentTr).attr('data-level'));
            var hasPendingSentRow = false;
            var decimalPlaces = parseInt($(e.target).parents('tr').find('#hdnDecimalPlaces').html().trim());


            RetailBudgetPro.Budget.auditChanges = [];

            var levelString = '';

            for (var loopVar = currentLevel; loopVar > 0; loopVar--) levelString += '[data-level=' + loopVar + '],';

            var rowsToQuery = $(parentTr).nextUntil('tr' + levelString.substring(0, levelString.length - 1)).filter(function (a) {
                return ($(this).hasClass('budgetdata') || $(this).hasClass('temp')) && $(this).attr('data-level') == (currentLevel + 1) && $(this).find('[type=checkbox]').is(':checked')
            });

            $(rowsToQuery).each(function () {
                var hdnCATCalculatedTypeVal = $(this).find('#hdnCatCalucaltedType').length > 0 ? $(this).find('#hdnCatCalucaltedType').html().trim() : "";

                if (hdnCATCalculatedTypeVal == 'NE') {
                    //added div.vendorDD to fetch vendor value as there is no textbox for the vendor column in NE sub-category row
                    RetailBudgetPro.Budget.auditChanges.push($(this).find('[type=text]:not(.search-txt), select, a.transactionDate, div.vendorDD').filter(function (a) {
                        return !$(this).parents('td').hasClass('percentage');
                    }).map(function (v) {
                        if ($(this).parents('td').hasClass('vendorLst')) return $(this).parents('tr').find('#hdnVendorUIDCSV').text().trim();
                        else if ($(this).parents('td').hasClass('isTransactionDate')) return $(this).parents('td').find('.transactionDateDiv .transactionSpan').html().trim();
                        else if ($(this).parents('td').hasClass('isDayOfPeriod')) return $(this).parents('td').find('.dayOfPeriodDiv .transactionSpan').html().trim();
                        else if ($(this).parents('td').hasClass('termLst')) return $(this).parents('td').find('.termSpan').html().trim();
                        else if ($(this).parents('td').hasClass('amortizePeriodLst')) return $(this).parents('td').find('span').html().trim();
                        else {
                            if ($(this).parents('td').hasClass('data')) return $(this).next('.hideCol').attr('data-value').replace(/,/g, '');
                            else if ($(this).next('.hideCol').length > 0) return $(this).next('.hideCol').text().trim();
                        }
                    }).get());
                }
                else {
                    RetailBudgetPro.Budget.auditChanges.push($(this).find('[type=text]:not(.search-txt), select, a.transactionDate').filter(function (a) {
                        return !$(this).parents('td').hasClass('percentage');
                    }).map(function (v) {
                        if ($(this).parents('td').hasClass('vendorLst')) return $(this).parents('tr').find('#hdnVendorUIDCSV').text().trim();
                        else if ($(this).parents('td').hasClass('isTransactionDate')) return $(this).parents('td').find('.transactionDateDiv .transactionSpan').html().trim();
                        else if ($(this).parents('td').hasClass('isDayOfPeriod')) return $(this).parents('td').find('.dayOfPeriodDiv .transactionSpan').html().trim();
                        else if ($(this).parents('td').hasClass('termLst')) return $(this).parents('td').find('.termSpan').html().trim();
                        else if ($(this).parents('td').hasClass('amortizePeriodLst')) return $(this).parents('td').find('span').html().trim();
                        else {
                            if ($(this).parents('td').hasClass('data')) return $(this).next('.hideCol').attr('data-value').replace(/,/g, '');
                            else if ($(this).next('.hideCol').length > 0) return $(this).next('.hideCol').text().trim();
                        }
                    }).get());
                }
            });

            // Check to see which all rows are checked for deleting
            $('.budgets-table tbody tr').has(".selectRowToDelete:checked").each(function () {
                if ($(this).hasClass('unapproved-pending') || $(this).hasClass('unapproved-sent')) {
                    hasPendingSentRow = true;
                }
            });
            if (hasPendingSentRow) {
                custom_dialog("Ok", "", "Alert", "No Pending rows can be deleted");
            }
            else {
                var confirmClick = function () {

                    if (!hasPendingSentRow) {
                        $('.budgets-table tbody tr').each(function () {
                            var IsChecked = $(this).find('.selectRowToDelete').is(':checked');
                            if (IsChecked) {
                                data = getDataRowObject($(this));
                                dataToDelete.push(data);
                                $(this).remove();
                            }
                        });
                    }


                    if (dataToDelete != null && dataToDelete.length > 0) {
                        $('.layout').css('display', 'block');

                        // After deleting the rows 
                        // recalculate the data till the top level
                        //ComputeLevel(parentTr, "Edit");
                        finalData = CreateJsonOfDataRowObject(dataToDelete, $periods, null, true);
                        $('.custom-data-table').hide();

                        var stores = [];
                        var groupedcategory = $('[name=groupedcategory] :selected').val();
                        var stores = $('[name=lstStores]').val().toString();
                        var level = "0";
                        var viewLevel = "STORE";
                        var storeID = "-1";
                        var deptID = "-1";
                        var categoryID = "-1";
                        var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                        var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                        // remove the bottom level categories
                        $.ajax({
                            url: '/Budget/DeleteBottomLevelCategory',
                            type: 'POST',
                            data: JSON.stringify({ dataList: finalData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, AuditData: RetailBudgetPro.Budget.auditChanges, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), vendorIdCSV: $('[name="datapageVendordd"]').length == 0 ? "-2" : $('[name="datapageVendordd"]').val().join(','), decimalPlaces: decimalPlaces, bsMode: bsMode, categoryType: categoryType }),
                            async: true,
                            contentType: "application/json; charset=UTF-8",
                            dataType: 'html',
                            success: function (data) {
                                //RetailBudgetPro.Budget.DisplayFilteredData(undefined, "delete");
                                var isValid = true;
                                if ($('[name=AllowBatchUpdates]').val() == 'True') {
                                    try {
                                        var result = $.parseJSON(data);

                                        if (result.result == 2) {
                                            isValid = false;
                                            $('.layout').hide();

                                            var confirm_click = function () {
                                                window.location.reload();
                                            }

                                            custom_alert(confirm_click, "Alert", "Can not save data as formula execution is started.");
                                        }
                                    }
                                    catch (e) {

                                    }
                                }

                                if (isValid) {
                                    if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                                        var rowString = '';

                                        $('.expanded').map(function (v) {
                                            rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                                        });

                                        localStorage.setItem("ActiveRow", $(parentTr).find('#hdnStoreUID').html() + '|' + $(parentTr).find('#hdnDeptUID').html() + '|' + $(parentTr).find('#hdnCatUID').html());

                                        localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                                    }

                                    localStorage.setItem("ExpandRows", "True");

                                    console.log(localStorage.getItem("ExpandedRows"));

                                    $('#DataInputTable tbody').html('');
                                    $('#DataInputTable tbody').html(data);
                                    $(".hideyear").each(function () {
                                        $(this).removeAttr("data-level");
                                    });
                                    $('#DataInputTable').find('.displayVendor').addClass('hide');
                                    $('#DataInputTable').tabelize();
                                    RetailBudgetPro.Budget.ManageDataAndPerentage();
                                    $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                                    $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                                    $('.hideyear').find('td:first').html('');
                                }

                                //RetailBudgetPro.Budget.DisplayFilteredData();
                            },
                            error: function (err) {
                                console.log(err);
                            }
                        });


                        var html = ""
                        if (parentTr.nextUntil('.doNotExpand:not(.beginningBalance)').not('.historicaldata').has('[type=checkbox]:enabled').has('[type=text]:not(.lockedMonths)').length == 0) {
                            var level = parentTr.data('level');
                            // get a new row -- as we need to show a row when we click on edit button
                            html = getNewRow(parentTr, parseInt(level) + 1);
                            var isFOA = parentTr.find('#hdnIsFOA').val();
                            // Insert after current rows historical data (Ly and LLY)
                            var finalHtml = $(html).insertAfter($(parentTr).next('tr').next('tr'));

                            finalHtml.removeClass('show-action-btns');
                            // Used to show the textbox disabled and enabled depending upon whether that period is locked or not
                            RetailBudgetPro.Budget.LockedMonthsCheck(finalHtml, isFOA);

                            // In case all bottom lines deleted add this class to use as an identifier
                            finalHtml.addClass('newRowAfterDelAll');

                            $('.newRowAfterDelAll td .subCategoryCurrencyDD').SumoSelect({ search: true });

                            $('.newRowAfterDelAll td .subCategoryTermDD').SumoSelect({ search: true });

                            if (showOptionsInVendorDropDown)
                                $('.newRowAfterDelAll td .drpdwnvendor').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                            else
                                $('.newRowAfterDelAll td .drpdwnvendor').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true });
                        }

                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        //Undoing the state
                        $('.current').removeClass('current');
                        parentTr.find('input[type=text]').removeClass('hasError');
                        parentTr.find('.checkAllToDelete').addClass('hideCol').removeClass('showCol').prop('checked', false);
                        RemoveEditableMode(parentTr);
                        parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').find('.copyValues').hide();
                        parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('input[type=text]').removeClass('hasError');
                        //parentTr.nextUntil('tr.doNotExpand', '.temp').remove();
                        parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.temp:not(.beginningBalance)').addClass('hide')
                        parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToDelete').addClass('hideCol').removeClass('showCol').prop('checked', false);

                        var saveBtnClass = $(document).find('#hdnUserInApproveBudget').val() == "False" ? 'saveByRequester' : 'saveByApprover';
                        var submitForApproverIcon = '';
                        if ($('#hdnImpersonationMode').val() == "False" && $tr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').length > 0 && $(document).find('#hdnUserInApproveBudget').val() == "False")
                            submitForApproverIcon = '<a href="#" class="submitForApproval" title="Submit for approval"><i class="fa fa-thumbs-o-up"></i></a><a href="javascript:void(0)" class="undo-pending" title="Undo Pending"><i class="fa fa-thumbs-o-down"></i></a>';
                        else if ($('#hdnImpersonationMode').val() == "False" && $tr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').length > 0 && $(document).find('#hdnUserInApproveBudget').val() == "True")
                            submitForApproverIcon = '<a href="javascript:void(0)" class="submit-approve-directly" title="Approve"><i class="fa fa-thumbs-up"></i></a><a href="javascript:void(0)" class="submit-reject-directly" title="Reject"><i class="fa fa-thumbs-down"></i></a>';
                        else
                            submitForApproverIcon = '';
                        //var saveBtnTitle = $(document).find('#hdnUserInApproveBudget').val() == "False" ? 'Submit for approval' : 'Save';

                        parentTr.find('.action-items .show').append(submitForApproverIcon);

                        if (parentTr.find('.action-items .save').length == 0) {
                            var htmlToApp = '<a href="#" class="save ' + saveBtnClass + '" title="Save"><i class="fa fa-save"></i></a>';
                            parentTr.find('.action-items .hide').prepend(htmlToApp);
                            //$(htmlToApp).insertAfter(parentTr.find('.action-items .hide .upload-excel'));
                        }

                        if (parentTr.find('.action-items .newLineLink').length == 0) {
                            htmlToApp = '<a href="#" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a>';
                            $(htmlToApp).insertAfter(parentTr.find('.action-items .hide .save'));
                        }

                        //RetailBudgetPro.Budget.auditChanges.push($($($(parentTr).nextUntil('tr[data-level=' + currentLevel + ']').filter(function (a) {
                        //    return $(this).hasClass('totals') && $(this).attr('data-level') == (currentLevel + 1)
                        //}))[0]).find('.data').map(function (v) {
                        //    return $(this).text();
                        //}).get());

                        //SaveToActivity($(parentTr));

                        //}

                    }
                    else {
                        custom_dialog("Ok", "", "Alert", "Select at least one before deleting");
                        //alert("Select atleast one before deleting");
                    }
                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Selected rows will be deleted! Continue?");
            }
            //if (confirm("Selected rows will be deleted! Continue?")) {

            //}
        },
        // Fucntion to modify the bottom level state when it is contracted 
        // (hiding the checkboxes,hiding the action-btns, removing the editable view)
        OnContractBottomLevelCategory: function (e) {
            if ($(e.target).attr('title') == "Expand") {
                $(e.currentTarget).parent().find('.edit').parent().find('a').has('.downloadSubCatExcel').addClass('hide');
            }
            else if ($(e.target).attr('title') == "Collapse") {
                $(e.currentTarget).parent().find('.edit').parent().find('a').has('.downloadSubCatExcel').removeClass('hide');
            }
            if ($(e.currentTarget).parent().find('.edit').parent().hasClass('hide')) {
                $parentTr = $(e.currentTarget).parents('tr');
                // removing the editable mode
                RemoveEditableMode($parentTr);
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.temp:not(.beginningBalance)').not('.newRowAfterDelAll').remove();
            }
            FreezeDataInputTable()
        },
        // Function to select all the bottom level rows to delete
        SelectAllRows: function () {

            $row = $(this).parents('tr');
            if ($(this).is(':checked')) {
                $row.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').each(function () {
                    //$(this).find('input[type=checkbox]').prop('checked', 'checked');
                    if (!$(this).find('input[type=checkbox]').is(':disabled'))
                        $(this).find('input[type=checkbox]').prop('checked', 'checked');

                });
            }
            else {
                $row.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').each(function () {
                    $(this).find('input[type=checkbox]').prop('checked', false);
                });
            }

        },
        // Function used to save the bottom level data
        SaveDataInput: function (e) {

            $('.layout').css('display', 'block');
            $parentTr = $(e.currentTarget).parents('tr');

            var currentLevel = parseInt($parentTr.attr('data-level'));
            var nd = new Date();

            RetailBudgetPro.Budget.auditChanges = [];

            var levelString = '';

            for (var loopVar = currentLevel; loopVar > 0; loopVar--) levelString += '[data-level=' + loopVar + '],';

            var rowsToQuery = $parentTr.nextUntil('tr' + levelString.substring(0, levelString.length - 1)).filter(function (a) {
                return (($(this).hasClass('budgetdata') && $(this).find('#hdnCatCalucaltedType').length != 0 && $(this).find('#hdnCatCalucaltedType').html() == "" && $(this).find('#hdnPLElementUID').length != 0 && $(this).find('#hdnPLElementUID').html() != "-10") || $(this).hasClass('temp')) && $(this).attr('data-level') == (currentLevel + 1);
            });

            $(rowsToQuery).each(function () {

                var tempArr = [];
                var arrayToPush = [];

                var isDefaultEmptyRow = false;

                if ($(this).find('td#hdnPLElementUID').length > 0 && $(this).find('td#hdnPLElementUID').html().trim() == "-1") {
                    isDefaultEmptyRow = true
                }

                if (!$(this).hasClass('temp') && isDefaultEmptyRow === false) {
                    tempArr = $(this).find('[type=text]:not(.search-txt), select, a.transactionDate').filter(function (a) {
                        return !$(this).parents('td').hasClass('percentage');
                    }).map(function (v) {
                        if ($(this).parents('td').hasClass('vendorLst') && RetailBudgetPro.Budget.showVendorGlobalVal == 1) return $(this).parents('tr').find('#hdnVendorUIDCSV').text().trim();
                        else if ($(this).parents('td').hasClass('isTransactionDate')) return $(this).parents('td').find('.transactionDateDiv .transactionSpan').html().trim();
                        else if ($(this).parents('td').hasClass('isDayOfPeriod')) return $(this).parents('td').find('.dayOfPeriodDiv .transactionSpan').html().trim();
                        else if ($(this).parents('td').hasClass('termLst')) return $(this).parents('td').find('.termSpan').html().trim();
                        else if ($(this).parents('td').hasClass('amortizePeriodLst')) return $(this).parents('td').find('span').html().trim();
                        else {
                            if ($(this).parents('td').hasClass('data')) return $(this).next('.hideCol').attr('data-value').replace(/,/g, '');
                            else if ($(this).next('.hideCol').length > 0) return $(this).next('.hideCol').text().trim();
                        }
                    }).get();

                    tempArr.unshift('-');
                    tempArr.push($(this).find('#hdnPLElementUID').html().trim())

                    arrayToPush = tempArr;

                    RetailBudgetPro.Budget.auditChanges.push(arrayToPush);
                }
                var termDesc = '';
                var isFormulaTerm = '';

                tempArr = $(this).find('[type=text]:not(.search-txt), select, a.transactionDate').filter(function (a) {
                    return !$(this).parents('td').hasClass('percentage');
                }).map(function (v) {
                    if ($(this).parents('td').hasClass('vendorLst') && RetailBudgetPro.Budget.showVendorGlobalVal == 1) return $(this).parents('td').find('.isVendor option:selected').map(function () { return $(this).val() }).get().join();
                    else if ($(this).parents('td').hasClass('dateLst')) {
                        var $selectedTermOption = $(this).parents('tr').find('select[name="subCategoryTermDD"] option:selected');
                        isFormulaTerm = $selectedTermOption.length > 0 && $selectedTermOption.attr('data-isformulatype') == "True";

                        if ($(this).parents('tr').find('.amortize-period').val() == "1" && !isFormulaTerm) {
                            return GetOrdinalValue($(this).parents('td').find('.dayOfPeriod').attr('data-day'));
                        }
                        else {
                            return $(this).parents('td').find('.transactionDate').attr('data-date');
                        }
                    } 
                    else if ($(this).parents('td').hasClass('termLst')) {
                        if ($(this).parents('td').find('.termSpan').html() != undefined && $(this).parents('td').find('.termSpan').html().trim() == "N/A") {
                            return "N/A";
                        }
                        else {
                            var $selectedTermOption = $(this).parents('td').find('select[name="subCategoryTermDD"] option:selected');
                            termDesc = $selectedTermOption.length > 0 ? $selectedTermOption.html().trim() : "";
                            return termDesc == "Select" ? "" : termDesc;
                        }
                    } 
                    else if ($(this).parents('td').hasClass('amortizePeriodLst')) return $(this).val();
                    else if ($(this).parents('td').hasClass('currencyLst')) { } //No need to add currency id to the array
                    else {
                        if ($(this).parents('td').hasClass('data')) {
                            var pValue = parseFloat($(this).val().replace(/,/g, '').trim());
                            return isNaN(pValue) || !isFinite(pValue) ? "0" : pValue.toString();
                        }
                        else return $(this).val();
                    }
                }).get();

                tempArr.unshift('+');
                tempArr.push($(this).find('#hdnPLElementUID').html().trim())

                arrayToPush = tempArr;

                RetailBudgetPro.Budget.auditChanges.push(arrayToPush);

            });
          
            $parentTr.nextUntil('.doNotExpand.totals').filter('.budgetdata.bottomLevel.showyear, .temp.bottomLevel.showyear').each(function () {
                if ($(this).find('#hdnCurrentComment').html().trim() != "") {
                    var textToAppend = $(this).find('#hdnComment').text() + "<br/><img class='img-circle layout-menu-image' src=" + $("input[name='hdnUSRProfilePic']").val() + " /><b>" + $('#hdnCurrentUser').val() + " " + (nd.getMonth() + 1) + "/" + nd.getDate() + "/" + nd.getFullYear() + "</b> : " + $(this).find('#hdnCurrentComment').html().trim();

                    $(this).find('#hdnComment').text(textToAppend);
                    $(this).find('#hdnCurrentComment').html('');
                }
                else if ($(this).find('#hdnCurrentComment').html().trim() == "" && $(this).find('#hdnCatCalucaltedType').text() == 'NE') {
                    $(this).find('#hdnComment').text('');
                }
            });

            //    var flag = 0;
            //$parentTr.nextUntil('.doNotExpand').not('.historicaldata').each(function () {
            //    var $input = $(this).find('input[type=text]')
            //    $input.each(function () {
            //        if (!$(this).hasClass('isVendor')) {
            //            if ($(this).val() == '' && !$(this).hasClass('isDescription')) {
            //                $(this).addClass('hasError');
            //                flag = 1;
            //            }
            //            else {
            //                $(this).removeClass('hasError');
            //            }
            //        }

            //    });

            //});


            //if (flag == 1) {
            //    $('.layout').css('display', 'none');
            //    return false;
            //}

            // compute the data at each level
            ComputeLevel($parentTr, "");
            // show sorting of vendor buttons when it is not in editable mode.
            $parentTr.find('.sort-vendor').show();
            $parentTr.find('.sort-description').show();
            $parentTr.find('.sort-total').show();
            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12)
                $parentTr.find('.sort-date').show();
            // Remove editable mode once the data is saved.
            //RemoveEditableMode($parentTr);
            $parentTr.nextAll('.doNotExpand:not(.beginningBalance)').find('.temp').removeClass('temp');
            //$('#DataInputTable').find('.displayVendor.actionBtnsTd').html('User Name');

            $('.commentModal .comment').val('');

            return false;
        },
        // Distribute the total value in the bottom level lines in all the periods of that row evenly
        DistributeTotalEven: function () {
            var $periods = getNumberOfPeriods();
            //get totals value
            var $row = $(this).parents('tr');
            var data = getDataRowObject($row, "span", $periods);
            var total = $row.find('.total').val();
            total = ConvertCurrencyStringToDecimal(total);

            var decimalPlaces = getDecimalPlaces($row);

            if (dataPercentageFilter == "data") {
                if ($periods == 12) {
                    data.DATValueM1 = total / 12;
                    data.DATValueM2 = total / 12;
                    data.DATValueM3 = total / 12;
                    data.DATValueM4 = total / 12;
                    data.DATValueM5 = total / 12;
                    data.DATValueM6 = total / 12;
                    data.DATValueM7 = total / 12;
                    data.DATValueM8 = total / 12;
                    data.DATValueM9 = total / 12;
                    data.DATValueM10 = total / 12;
                    data.DATValueM11 = total / 12;
                    data.DATValueM12 = total - (total / 12).toFixed(parseInt(decimalPlaces)) * 11;
                    //data.DATValueM13 = total / 12m;
                }
                else {
                    data.DATValueM1 = total / 13;
                    data.DATValueM2 = total / 13;
                    data.DATValueM3 = total / 13;
                    data.DATValueM4 = total / 13;
                    data.DATValueM5 = total / 13;
                    data.DATValueM6 = total / 13;
                    data.DATValueM7 = total / 13;
                    data.DATValueM8 = total / 13;
                    data.DATValueM9 = total / 13;
                    data.DATValueM10 = total / 13;
                    data.DATValueM11 = total / 13;
                    data.DATValueM12 = total / 13;
                    data.DATValueM13 = total - (total / 13).toFixed(parseInt(decimalPlaces)) * 12;
                }

                data.DATValueM1P = data.DATNetSalesM1 != 0 ? 100 * data.DATValueM1 / data.DATNetSalesM1 : 0;
                data.DATValueM2P = data.DATNetSalesM2 != 0 ? 100 * data.DATValueM2 / data.DATNetSalesM2 : 0;
                data.DATValueM3P = data.DATNetSalesM3 != 0 ? 100 * data.DATValueM3 / data.DATNetSalesM3 : 0;
                data.DATValueM4P = data.DATNetSalesM4 != 0 ? 100 * data.DATValueM4 / data.DATNetSalesM4 : 0;
                data.DATValueM5P = data.DATNetSalesM5 != 0 ? 100 * data.DATValueM5 / data.DATNetSalesM5 : 0;
                data.DATValueM6P = data.DATNetSalesM6 != 0 ? 100 * data.DATValueM6 / data.DATNetSalesM6 : 0;
                data.DATValueM7P = data.DATNetSalesM7 != 0 ? 100 * data.DATValueM7 / data.DATNetSalesM7 : 0;
                data.DATValueM8P = data.DATNetSalesM8 != 0 ? 100 * data.DATValueM8 / data.DATNetSalesM8 : 0;
                data.DATValueM9P = data.DATNetSalesM9 != 0 ? 100 * data.DATValueM9 / data.DATNetSalesM9 : 0;
                data.DATValueM10P = data.DATNetSalesM10 != 0 ? 100 * data.DATValueM10 / data.DATNetSalesM10 : 0;
                data.DATValueM11P = data.DATNetSalesM11 != 0 ? 100 * data.DATValueM11 / data.DATNetSalesM11 : 0;
                data.DATValueM12P = data.DATNetSalesM12 != 0 ? 100 * data.DATValueM12 / data.DATNetSalesM12 : 0;
                if ($periods > 12) {
                    data.DATValueM13P = data.DATNetSalesM13 != 0 ? 100 * data.DATValueM13 / data.DATNetSalesM13 : 0;
                }

            }
            else { // if data display mode is of Percentages
                data.DATValueM1P = total;
                data.DATValueM2P = total;
                data.DATValueM3P = total;
                data.DATValueM4P = total;
                data.DATValueM5P = total;
                data.DATValueM6P = total;
                data.DATValueM7P = total;
                data.DATValueM8P = total;
                data.DATValueM9P = total;
                data.DATValueM10P = total;
                data.DATValueM11P = total;
                data.DATValueM12P = total;
                data.DATValueM13P = total;

                data.DATValueM1 = data.DATValueM1P * data.DATNetSalesM1 / 100;
                data.DATValueM2 = data.DATValueM2P * data.DATNetSalesM2 / 100;
                data.DATValueM3 = data.DATValueM3P * data.DATNetSalesM3 / 100;
                data.DATValueM4 = data.DATValueM4P * data.DATNetSalesM4 / 100;
                data.DATValueM5 = data.DATValueM5P * data.DATNetSalesM5 / 100;
                data.DATValueM6 = data.DATValueM6P * data.DATNetSalesM6 / 100;
                data.DATValueM7 = data.DATValueM7P * data.DATNetSalesM7 / 100;
                data.DATValueM8 = data.DATValueM8P * data.DATNetSalesM8 / 100;
                data.DATValueM9 = data.DATValueM9P * data.DATNetSalesM9 / 100;
                data.DATValueM10 = data.DATValueM10P * data.DATNetSalesM10 / 100;
                data.DATValueM11 = data.DATValueM11P * data.DATNetSalesM11 / 100;
                data.DATValueM12 = data.DATValueM12P * data.DATNetSalesM12 / 100;
                data.DATValueM13 = data.DATValueM13P * data.DATNetSalesM13 / 100;

            }

            MapValues(data, $row, $periods, decimalPlaces);

            return false;

        },
        // Distribute the total value in the bottom level lines in all the periods of that row evenly 
        DistributeTotalPercent: function (e) {
            var $periods = getNumberOfPeriods();
            //get totals value
            var $row = $(this).parents('tr');
            var data = getDataRowObject($row, "span", $periods);
            //var dataLY = getDataRowObject($(e.currentTarget).parents('tr').next('tr'), "span", $periods);
            var total = $row.find('.total').val();
            var oldTotal = 0;
            total = ConvertCurrencyStringToDecimal(total);

            var decimalPlaces = getDecimalPlaces($row);

            if (dataPercentageFilter == "data") {
                if ($periods == 12) {
                    oldTotal = data.DATValueM1 + data.DATValueM2 + data.DATValueM3 + data.DATValueM4 + data.DATValueM5 + data.DATValueM6 +
                                       data.DATValueM7 + data.DATValueM8 + data.DATValueM9 + data.DATValueM10 + data.DATValueM11 + data.DATValueM12;
                    data.DATValueM1 = (oldTotal != 0 && data.DATValueM1 == 0) ? 0 : (oldTotal == 0 && data.DATValueM1 == 0) ? (total / 12) : (total * data.DATValueM1 / oldTotal);
                    data.DATValueM2 = (oldTotal != 0 && data.DATValueM2 == 0) ? 0 : (oldTotal == 0 && data.DATValueM2 == 0) ? (total / 12) : (total * data.DATValueM2 / oldTotal);
                    data.DATValueM3 = (oldTotal != 0 && data.DATValueM3 == 0) ? 0 : (oldTotal == 0 && data.DATValueM3 == 0) ? (total / 12) : (total * data.DATValueM3 / oldTotal);
                    data.DATValueM4 = (oldTotal != 0 && data.DATValueM4 == 0) ? 0 : (oldTotal == 0 && data.DATValueM4 == 0) ? (total / 12) : (total * data.DATValueM4 / oldTotal);
                    data.DATValueM5 = (oldTotal != 0 && data.DATValueM5 == 0) ? 0 : (oldTotal == 0 && data.DATValueM5 == 0) ? (total / 12) : (total * data.DATValueM5 / oldTotal);
                    data.DATValueM6 = (oldTotal != 0 && data.DATValueM6 == 0) ? 0 : (oldTotal == 0 && data.DATValueM6 == 0) ? (total / 12) : (total * data.DATValueM6 / oldTotal);
                    data.DATValueM7 = (oldTotal != 0 && data.DATValueM7 == 0) ? 0 : (oldTotal == 0 && data.DATValueM7 == 0) ? (total / 12) : (total * data.DATValueM7 / oldTotal);
                    data.DATValueM8 = (oldTotal != 0 && data.DATValueM8 == 0) ? 0 : (oldTotal == 0 && data.DATValueM8 == 0) ? (total / 12) : (total * data.DATValueM8 / oldTotal);
                    data.DATValueM9 = (oldTotal != 0 && data.DATValueM9 == 0) ? 0 : (oldTotal == 0 && data.DATValueM9 == 0) ? (total / 12) : (total * data.DATValueM9 / oldTotal);
                    data.DATValueM10 = (oldTotal != 0 && data.DATValueM10 == 0) ? 0 : (oldTotal == 0 && data.DATValueM10 == 0) ? (total / 12) : (total * data.DATValueM10 / oldTotal);
                    data.DATValueM11 = (oldTotal != 0 && data.DATValueM11 == 0) ? 0 : (oldTotal == 0 && data.DATValueM11 == 0) ? (total / 12) : (total * data.DATValueM11 / oldTotal);
                    var tValTot = parseFloat(data.DATValueM1.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM2.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM3.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM4.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM5.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM6.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM7.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM8.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM9.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM10.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM11.toFixed(parseInt(decimalPlaces)));
                    data.DATValueM12 = (oldTotal != 0 && data.DATValueM12 == 0) ? 0 : (oldTotal == 0 && data.DATValueM12 == 0) ? total - (total / 12).toFixed(parseInt(decimalPlaces)) * 11 : total - tValTot;
                }
                else {
                    oldTotal = data.DATValueM1 + data.DATValueM2 + data.DATValueM3 + data.DATValueM4 + data.DATValueM5 + data.DATValueM6 +
                                       data.DATValueM7 + data.DATValueM8 + data.DATValueM9 + data.DATValueM10 + data.DATValueM11 + data.DATValueM12
                                       + data.DATValueM13;
                    data.DATValueM1 = (oldTotal != 0 && data.DATValueM1 == 0) ? 0 : (oldTotal == 0 && data.DATValueM1 == 0) ? (total / 13) : (total * data.DATValueM1 / oldTotal);
                    data.DATValueM2 = (oldTotal != 0 && data.DATValueM2 == 0) ? 0 : (oldTotal == 0 && data.DATValueM2 == 0) ? (total / 13) : (total * data.DATValueM2 / oldTotal);
                    data.DATValueM3 = (oldTotal != 0 && data.DATValueM3 == 0) ? 0 : (oldTotal == 0 && data.DATValueM3 == 0) ? (total / 13) : (total * data.DATValueM3 / oldTotal);
                    data.DATValueM4 = (oldTotal != 0 && data.DATValueM4 == 0) ? 0 : (oldTotal == 0 && data.DATValueM4 == 0) ? (total / 13) : (total * data.DATValueM4 / oldTotal);
                    data.DATValueM5 = (oldTotal != 0 && data.DATValueM5 == 0) ? 0 : (oldTotal == 0 && data.DATValueM5 == 0) ? (total / 13) : (total * data.DATValueM5 / oldTotal);
                    data.DATValueM6 = (oldTotal != 0 && data.DATValueM6 == 0) ? 0 : (oldTotal == 0 && data.DATValueM6 == 0) ? (total / 13) : (total * data.DATValueM6 / oldTotal);
                    data.DATValueM7 = (oldTotal != 0 && data.DATValueM7 == 0) ? 0 : (oldTotal == 0 && data.DATValueM7 == 0) ? (total / 13) : (total * data.DATValueM7 / oldTotal);
                    data.DATValueM8 = (oldTotal != 0 && data.DATValueM8 == 0) ? 0 : (oldTotal == 0 && data.DATValueM8 == 0) ? (total / 13) : (total * data.DATValueM8 / oldTotal);
                    data.DATValueM9 = (oldTotal != 0 && data.DATValueM9 == 0) ? 0 : (oldTotal == 0 && data.DATValueM9 == 0) ? (total / 13) : (total * data.DATValueM9 / oldTotal);
                    data.DATValueM10 = (oldTotal != 0 && data.DATValueM10 == 0) ? 0 : (oldTotal == 00 && data.DATValueM10 == 0) ? (total / 13) : (total * data.DATValueM10 / oldTotal);
                    data.DATValueM11 = (oldTotal != 0 && data.DATValueM11 == 0) ? 0 : (oldTotal == 0 && data.DATValueM11 == 0) ? (total / 13) : (total * data.DATValueM11 / oldTotal);
                    data.DATValueM12 = (oldTotal != 0 && data.DATValueM12 == 0) ? 0 : (oldTotal == 0 && data.DATValueM12 == 0) ? (total / 13) : (total * data.DATValueM12 / oldTotal);
                    var tValTot = parseFloat(data.DATValueM1.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM2.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM3.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM4.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM5.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM6.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM7.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM8.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM9.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM10.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM11.toFixed(parseInt(decimalPlaces))) + parseFloat(data.DATValueM12.toFixed(parseInt(decimalPlaces)));
                    data.DATValueM13 = (oldTotal != 0 && data.DATValueM13 == 0) ? 0 : (oldTotal == 0 && data.DATValueM13 == 0) ? total - (total / 13).toFixed(parseInt(decimalPlaces)) * 12 : total - (tValTot).toFixed(parseInt(decimalPlaces));
                }
                data.DATValueM1P = data.DATNetSalesM1 != 0 ? 100 * data.DATValueM1 / data.DATNetSalesM1 : 0;
                data.DATValueM2P = data.DATNetSalesM2 != 0 ? 100 * data.DATValueM2 / data.DATNetSalesM2 : 0;
                data.DATValueM3P = data.DATNetSalesM3 != 0 ? 100 * data.DATValueM3 / data.DATNetSalesM3 : 0;
                data.DATValueM4P = data.DATNetSalesM4 != 0 ? 100 * data.DATValueM4 / data.DATNetSalesM4 : 0;
                data.DATValueM5P = data.DATNetSalesM5 != 0 ? 100 * data.DATValueM5 / data.DATNetSalesM5 : 0;
                data.DATValueM6P = data.DATNetSalesM6 != 0 ? 100 * data.DATValueM6 / data.DATNetSalesM6 : 0;
                data.DATValueM7P = data.DATNetSalesM7 != 0 ? 100 * data.DATValueM7 / data.DATNetSalesM7 : 0;
                data.DATValueM8P = data.DATNetSalesM8 != 0 ? 100 * data.DATValueM8 / data.DATNetSalesM8 : 0;
                data.DATValueM9P = data.DATNetSalesM9 != 0 ? 100 * data.DATValueM9 / data.DATNetSalesM9 : 0;
                data.DATValueM10P = data.DATNetSalesM10 != 0 ? 100 * data.DATValueM10 / data.DATNetSalesM10 : 0;
                data.DATValueM11P = data.DATNetSalesM11 != 0 ? 100 * data.DATValueM11 / data.DATNetSalesM11 : 0;
                data.DATValueM12P = data.DATNetSalesM12 != 0 ? 100 * data.DATValueM12 / data.DATNetSalesM12 : 0;
                if ($periods > 12) {
                    data.DATValueM13P = data.DATNetSalesM13 != 0 ? 100 * data.DATValueM13 / data.DATNetSalesM13 : 0;
                }

            }
            else {
                oldTotal = data.DATNetSalesTotal == 0 ? 0 : 100 * data.DATValueTotal / data.DATNetSalesTotal;
                data.DATValueM1P = (oldTotal == 0) ? (total) : (data.DATValueM1P * total / oldTotal);
                data.DATValueM2P = (oldTotal == 0) ? (total) : (data.DATValueM2P * total / oldTotal);
                data.DATValueM3P = (oldTotal == 0) ? (total) : (data.DATValueM3P * total / oldTotal);
                data.DATValueM4P = (oldTotal == 0) ? (total) : (data.DATValueM4P * total / oldTotal);
                data.DATValueM5P = (oldTotal == 0) ? (total) : (data.DATValueM5P * total / oldTotal);
                data.DATValueM6P = (oldTotal == 0) ? (total) : (data.DATValueM6P * total / oldTotal);
                data.DATValueM7P = (oldTotal == 0) ? (total) : (data.DATValueM7P * total / oldTotal);
                data.DATValueM8P = (oldTotal == 0) ? (total) : (data.DATValueM8P * total / oldTotal);
                data.DATValueM9P = (oldTotal == 0) ? (total) : (data.DATValueM9P * total / oldTotal);
                data.DATValueM10P = (oldTotal == 0) ? (total) : (data.DATValueM10P * total / oldTotal);
                data.DATValueM11P = (oldTotal == 0) ? (total) : (data.DATValueM11P * total / oldTotal);
                data.DATValueM12P = (oldTotal == 0) ? (total) : (data.DATValueM12P * total / oldTotal);
                data.DATValueM13P = (oldTotal == 0) ? (total) : (data.DATValueM13P * total / oldTotal);

                data.DATValueM1 = data.DATValueM1P * data.DATNetSalesM1 / 100;
                data.DATValueM2 = data.DATValueM2P * data.DATNetSalesM2 / 100;
                data.DATValueM3 = data.DATValueM3P * data.DATNetSalesM3 / 100;
                data.DATValueM4 = data.DATValueM4P * data.DATNetSalesM4 / 100;
                data.DATValueM5 = data.DATValueM5P * data.DATNetSalesM5 / 100;
                data.DATValueM6 = data.DATValueM6P * data.DATNetSalesM6 / 100;
                data.DATValueM7 = data.DATValueM7P * data.DATNetSalesM7 / 100;
                data.DATValueM8 = data.DATValueM8P * data.DATNetSalesM8 / 100;
                data.DATValueM9 = data.DATValueM9P * data.DATNetSalesM9 / 100;
                data.DATValueM10 = data.DATValueM10P * data.DATNetSalesM10 / 100;
                data.DATValueM11 = data.DATValueM11P * data.DATNetSalesM11 / 100;
                data.DATValueM12 = data.DATValueM12P * data.DATNetSalesM12 / 100;
                data.DATValueM13 = data.DATValueM13P * data.DATNetSalesM13 / 100;

                //if ($periods == 12) {
                //    var netSalesTotal = data.DATNetSalesM1 + data.DATNetSalesM2 + data.DATNetSalesM3 + data.DATNetSalesM4 + data.DATNetSalesM5 + data.DATNetSalesM6 + data.DATNetSalesM7 + data.DATNetSalesM8 + data.DATNetSalesM9 + data.DATNetSalesM10
                //                         + data.DATNetSalesM11 + data.DATNetSalesM12;

                //    var valueTotal = data.DATValueM1 + data.DATValueM2 + data.DATValueM3 + data.DATValueM4 + data.DATValueM5 + data.DATValueM6 +
                //                       data.DATValueM7 + data.DATValueM8 + data.DATValueM9 + data.DATValueM10 + data.DATValueM11 + data.DATValueM12;

                //    oldTotal = netSalesTotal == 0 ? 0 : 100 * valueTotal / netSalesTotal;
                //    data.DATValueM1P = (oldTotal == 0) ? (total) : (data.DATValueM1P * total / oldTotal);
                //    data.DATValueM2P = (oldTotal == 0) ? (total) : (data.DATValueM2P * total / oldTotal);
                //    data.DATValueM3P = (oldTotal == 0) ? (total) : (data.DATValueM3P * total / oldTotal);
                //    data.DATValueM4P = (oldTotal == 0) ? (total) : (data.DATValueM4P * total / oldTotal);
                //    data.DATValueM5P = (oldTotal == 0) ? (total) : (data.DATValueM5P * total / oldTotal);
                //    data.DATValueM6P = (oldTotal == 0) ? (total) : (data.DATValueM6P * total / oldTotal);
                //    data.DATValueM7P = (oldTotal == 0) ? (total) : (data.DATValueM7P * total / oldTotal);
                //    data.DATValueM8P = (oldTotal == 0) ? (total) : (data.DATValueM8P * total / oldTotal);
                //    data.DATValueM9P = (oldTotal == 0) ? (total) : (data.DATValueM9P * total / oldTotal);
                //    data.DATValueM10P = (oldTotal == 0) ? (total) : (data.DATValueM10P * total / oldTotal);
                //    data.DATValueM11P = (oldTotal == 0) ? (total) : (data.DATValueM11P * total / oldTotal);
                //    data.DATValueM12P = (oldTotal == 0) ? (total) : (data.DATValueM12P * total / oldTotal);

                //    data.DATValueM1 = data.DATValueM1P * data.DATNetSalesM1 / 100;
                //    data.DATValueM2 = data.DATValueM2P * data.DATNetSalesM2 / 100;
                //    data.DATValueM3 = data.DATValueM3P * data.DATNetSalesM3 / 100;
                //    data.DATValueM4 = data.DATValueM4P * data.DATNetSalesM4 / 100;
                //    data.DATValueM5 = data.DATValueM5P * data.DATNetSalesM5 / 100;
                //    data.DATValueM6 = data.DATValueM6P * data.DATNetSalesM6 / 100;
                //    data.DATValueM7 = data.DATValueM7P * data.DATNetSalesM7 / 100;
                //    data.DATValueM8 = data.DATValueM8P * data.DATNetSalesM8 / 100;
                //    data.DATValueM9 = data.DATValueM9P * data.DATNetSalesM9 / 100;
                //    data.DATValueM10 = data.DATValueM10P * data.DATNetSalesM10 / 100;
                //    data.DATValueM11 = data.DATValueM11P * data.DATNetSalesM11 / 100;
                //    data.DATValueM12 = data.DATValueM12P * data.DATNetSalesM12 / 100;
                //}
                //else {
                //    var netSalesTotal = data.DATNetSalesM1 + data.DATNetSalesM2 + data.DATNetSalesM3 + data.DATNetSalesM4 + data.DATNetSalesM5 + data.DATNetSalesM6 + data.DATNetSalesM7 + data.DATNetSalesM8 + data.DATNetSalesM9 + data.DATNetSalesM10
                //                         + data.DATNetSalesM11 + data.DATNetSalesM12 + data.DATNetSalesM13;

                //    var valueTotal = data.DATValueM1 + data.DATValueM2 + data.DATValueM3 + data.DATValueM4 + data.DATValueM5 + data.DATValueM6 +
                //                       data.DATValueM7 + data.DATValueM8 + data.DATValueM9 + data.DATValueM10 + data.DATValueM11 + data.DATValueM12 + data.DATValueM13;

                //    oldTotal = netSalesTotal == 0 ? 0 : 100 * valueTotal / netSalesTotal;
                //    data.DATValueM1P = (oldTotal == 0) ? (total) : (data.DATValueM1P * total / oldTotal);
                //    data.DATValueM2P = (oldTotal == 0) ? (total) : (data.DATValueM2P * total / oldTotal);
                //    data.DATValueM3P = (oldTotal == 0) ? (total) : (data.DATValueM3P * total / oldTotal);
                //    data.DATValueM4P = (oldTotal == 0) ? (total) : (data.DATValueM4P * total / oldTotal);
                //    data.DATValueM5P = (oldTotal == 0) ? (total) : (data.DATValueM5P * total / oldTotal);
                //    data.DATValueM6P = (oldTotal == 0) ? (total) : (data.DATValueM6P * total / oldTotal);
                //    data.DATValueM7P = (oldTotal == 0) ? (total) : (data.DATValueM7P * total / oldTotal);
                //    data.DATValueM8P = (oldTotal == 0) ? (total) : (data.DATValueM8P * total / oldTotal);
                //    data.DATValueM9P = (oldTotal == 0) ? (total) : (data.DATValueM9P * total / oldTotal);
                //    data.DATValueM10P = (oldTotal == 0) ? (total) : (data.DATValueM10P * total / oldTotal);
                //    data.DATValueM11P = (oldTotal == 0) ? (total) : (data.DATValueM11P * total / oldTotal);
                //    data.DATValueM12P = (oldTotal == 0) ? (total) : (data.DATValueM12P * total / oldTotal);
                //    data.DATValueM13P = (oldTotal == 0) ? (total) : (data.DATValueM13P * total / oldTotal);

                //    data.DATValueM1 = data.DATValueM1P * data.DATNetSalesM1 / 100;
                //    data.DATValueM2 = data.DATValueM2P * data.DATNetSalesM2 / 100;
                //    data.DATValueM3 = data.DATValueM3P * data.DATNetSalesM3 / 100;
                //    data.DATValueM4 = data.DATValueM4P * data.DATNetSalesM4 / 100;
                //    data.DATValueM5 = data.DATValueM5P * data.DATNetSalesM5 / 100;
                //    data.DATValueM6 = data.DATValueM6P * data.DATNetSalesM6 / 100;
                //    data.DATValueM7 = data.DATValueM7P * data.DATNetSalesM7 / 100;
                //    data.DATValueM8 = data.DATValueM8P * data.DATNetSalesM8 / 100;
                //    data.DATValueM9 = data.DATValueM9P * data.DATNetSalesM9 / 100;
                //    data.DATValueM10 = data.DATValueM10P * data.DATNetSalesM10 / 100;
                //    data.DATValueM11 = data.DATValueM11P * data.DATNetSalesM11 / 100;
                //    data.DATValueM12 = data.DATValueM12P * data.DATNetSalesM12 / 100;
                //    data.DATValueM13 = data.DATValueM13P * data.DATNetSalesM13 / 100;
                //}
            }

            MapValues(data, $row, $periods, decimalPlaces);

            return false;
        },
        // Function used to add new row in the bottom level
        AddNewLine: function () {
            var html = "";
            var parentRow = $(this).parents('tr');
            var datalevel = parentRow.data('level');
            var classVal = parentRow.attr('class').toString() + " temp bottomLevel contracted ";
            var percentLYF = parentRow.find('.percentLYF span').html();
            var percentLLYF = parentRow.find('.percentLLYF span').html();
            var year = parentRow.find('.year').html();
            var guid = RetailBudgetPro.Budget.guid();
            var storeID = parentRow.find('#hdnStoreUID').text();
            var deptID = parentRow.find('#hdnDeptUID').text();
            var catID = parentRow.find('#hdnCatUID').text();
            var decimalPlaces = parentRow.find('#hdnDecimalPlaces').text();
            var isFOA = parentRow.find('#hdnIsFOA').text();
            var comment = parentRow.find('#hdnComment').text();
            //html += "<tr data-level=" + (parseInt(datalevel) + 1) + " class= 'temp bottomLevel l" + (parseInt(datalevel) + 1) + " contracted'  id=" + guid + "><td><input type='text' value='' class='bottomLevelText catDescription'/></td><td>" + year + "</td><td class=''><input type='text' value='0' class='bottomLevelText'/><a href='#' class='copyValues'><i class='fa fa-sort-up'></i></a></td><td class='data rightAlign DATValueM1F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM2F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM3F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM4F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM5F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM6F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM7F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM8F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM9F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM10F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM11F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM12F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueM13F'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='data rightAlign DATValueTotalF'><input type='text' value='0' class='bottomLevelText total'/><span></span></td><td class='percentage rightAlign DATValueM1PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM2PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM3PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM4PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM5PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM6PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM7PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM8PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM9PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM10PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM11PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM12PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueM13PF'><input type='text' value='0' class='bottomLevelText editPeriod'/><span></span></td><td class='percentage rightAlign DATValueTotalPF'><input type='text' value='0' class='bottomLevelText total'/><span></span></td><td class='data rightAlign'>" + percentLYF + "</td><td class='data rightAlign'>" + percentLLYF + "</td><td class='data action-btn'><a href='#' class='TotalEven'>=</a><a href='#' class='TotalPercent'>%</a></td><td><input type='checkbox' value='0' /></td><td></td></tr>"



            html = getNewRow(parentRow, parseInt(datalevel) + 1);

            var catTypeRE = parentRow.find('#hdnCATTypeRE').text();

            var finalHtml = $(html).insertBefore($(parentRow).nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel.showyear:first'));
            //var finalHtml = $(html).insertAfter($(parentRow).next('tr').next('tr'));
            finalHtml.removeClass('show-action-btns');
            RetailBudgetPro.Budget.LockedMonthsCheck(finalHtml, isFOA);

            if (catTypeRE == "R") {
                $(finalHtml).find('[name=subCategoryTermDD] option[data-cattype="C"]').remove();
            }
            else if (catTypeRE == "E" || catTypeRE == "D") {
                $(finalHtml).find('[name=subCategoryTermDD] option[data-cattype="D"]').remove();
            }

            $(finalHtml).find('[name=subCategoryCurrencyDD]').SumoSelect();

            $(finalHtml).find('[name=subCategoryTermDD]').SumoSelect();

            if (showOptionsInVendorDropDown)
                $(finalHtml).find('[name=VendorUID]').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
            else
                $(finalHtml).find('[name=VendorUID]').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true });

            //RetailBudgetPro.Budget.InitializeMultiselect();
            RetailBudgetPro.Budget.ManageDataAndPerentage();
            return false;
        },
        // Function used to manage view if the periods are locked or not
        LockedMonthsCheck: function (row, isFOA) {

            if ($(row).find('#hdnFromExcel').html().trim() != "") {
                $(row).find('input[type=text]').each(function () {
                    //if condition commented by Jatin (BD-34) to make all the tds readonly if the row is excel linked row
                    //if (!($(this).hasClass('isDescription') || $(this).hasClass('isVendor'))) {

                    $(this).attr('readonly', 'readonly').addClass('lockedMonths');

                    //}
                });
                $(row).find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
                $(row).find('.action-btn .usePeriodRedistribution').addClass('lockedMonthsActionBtns');
                $(row).find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
                $(row).find('.growthRate').addClass('lockedMonthsActionBtns');
                $(row).find('.selectRowToDelete ').attr('disabled', 'disabled');
            }

            if (($(row).find('#hdnCatCalucaltedOn').length > 0 && $(row).find('#hdnCatCalucaltedOn').text() != '') || $(row).hasClass('nonEditableRow')) {

                var urlLink = $(row).find('#hdnCatCalucaltedType').html().trim() == "FOA" ? "/Formula/EditFormula/" + $(row).find('#hdnCatCalucaltedOn').html().trim() : $(row).find('#hdnCatCalucaltedType').html().trim() == "C2C" ? "/C2C/EditC2C/" + $(row).find('#hdnCatCalucaltedOn').html().trim() : $(row).find('#hdnCatCalucaltedType').html().trim() == "EP" ? "/EmployeePayroll/Edit/" + $(row).find('#hdnCatCalucaltedOn').html().trim() : $(row).find('#hdnCatCalucaltedType').html().trim() == "EFP" ? "/EmployeeFormula/Edit/" + $(row).find('#hdnCatCalucaltedOn').html().split('|')[1] : "/Rule/EditRule/" + $(row).find('#hdnCatCalucaltedOn').html().trim();
                var formulaName = $(row).find('#hdnFormulaName').html().trim();
                if ($(row).find('#hdnCatCalucaltedOn').length > 0 && $(row).find('#hdnCatCalucaltedOn').text() != '' && $(row).find('.edit-formula').length == 0) {

                    var htmlA = '';
                    var htmlFormulaLinkIcon = '';
                    var htmlInputIcon = '';
                    var payrollUIDList = $(row).find('#hdnPayrollUIDsNotInUser').text().split(",");

                    //var htmlFormulaLinkIcon = $(row).find('#hdnCatCalucaltedType').html().trim() != "EP" ? '<img src="/assets/admin/layout/img/fx-sign.png?v=1">' : '<i class="fa fa-user"></i>';
                    if (($(row).find('#hdnCatCalucaltedType').html().trim() == "EFP" || $(row).find('#hdnCatCalucaltedType').html().trim() == "EP") && ($('#hdnIsUserInManageAdminPayrollRole').val() == "True" || $('#hdnIsUserInManagePayrollRole').val() == "True")) {

                        if ($(row).find('.linked-category-data').length == 0) {

                            if ($(row).find('#hdnCatCalucaltedType').html().trim() == "EP") {
                                htmlFormulaLinkIcon = '<i class="fa fa-user"></i>';
                                htmlInputIcon = '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(row).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>';

                                if (jQuery.inArray($(row).find('#hdnCatCalucaltedOn').html().trim(), payrollUIDList) == -1) {
                                    htmlA += htmlInputIcon + '<a title="Edit Payroll" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>';
                                }
                                else {
                                    htmlA += htmlInputIcon;
                                }
                            }
                            else {
                                htmlInputIcon = ($(row).find('#hdnEmpFormulaTypeFV').html().trim() == "F" || $(row).find('#hdnEmpFormulaTypeFV').html().trim() == "A") ? '' : '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(row).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>';
                                htmlFormulaLinkIcon = $('#hdnIsUserInManageAdminPayrollRole').val() == "True" ? '<img src="/assets/admin/layout/img/fx-sign.png"></a>' : '';
                                htmlA += htmlInputIcon + '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>';
                            }
                        }
                        else {
                            htmlInputIcon = '';
                            htmlFormulaLinkIcon = $(row).find('#hdnCatCalucaltedType').html().trim() != "EP" && $('#hdnIsUserInManageAdminPayrollRole').val() == "True" ? '<img src="/assets/admin/layout/img/fx-sign.png?v=1">' : '<i class="fa fa-user"></i>';

                            if ($(row).find('#hdnCatCalucaltedType').html().trim() == "EP") {
                                htmlA += jQuery.inArray($(row).find('#hdnCatCalucaltedOn').html().trim(), payrollUIDList) > 0 ? '' : '<a title="Edit Payroll" target="_blank" class="edit-formula" href=' + urlLink + '>';
                            }
                            else if ($('#hdnUserInManageFormulaRole').val() == 'True' && $(row).find('#hdnCatCalucaltedType').html().trim() == "EFP") {
                                htmlA += htmlInputIcon + '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>';
                            }
                            else {
                                htmlA += '';
                            }

                            $(row).find('td:first()').append(htmlA);
                        }
                    }
                    else if ($(row).find('#hdnCatCalucaltedType').html().trim() != "EFP" && $(row).find('#hdnCatCalucaltedType').html().trim() != "EP" && $(row).find('#hdnCatCalucaltedType').html().trim() != "LC") {
                        if ($(row).find('.linked-category-data').length == 0 && $(row).find('#hdnIsFOAEliminationType').html() != "True" && $(this).find('#hdnC2COperator').html() != "E") {
                            htmlA += '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(row).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>';
                            htmlA += $('#hdnUserInManageFormulaRole').val() == "True" ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' : '';
                            $(row).find('td:first()').append(htmlA);
                        }
                        else {
                            htmlA += $('#hdnUserInManageFormulaRole').val() == 'True' ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' : '';
                            $(row).find('td:first()').append(htmlA);
                        }
                    }
                    else if ($(row).find('#hdnCatCalucaltedType').html().trim() == "LC" && $(row).find('.linked-category-data').length == 0) {
                        htmlA += '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(row).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="LC"></a>';
                        $(row).find('td:first()').append(htmlA);
                    }
                }

                var periodHasNonZeroVal = 0;

                var catCalculatedType = $(row).find('#hdnCatCalucaltedType').html().trim();

                if (catCalculatedType == "NE") {
                    $(row).find('td.data').each(function () {
                        if (ConvertCurrencyStringToDecimal($(this).children('input.editPeriod').val()) != 0) {
                            periodHasNonZeroVal = 1;
                            return false;
                        }
                    });
                }

                //prevent disabling sub-category row checkbox if it is a NE row and all periods are 0 as we will let user delete this row
                if (!(catCalculatedType == "NE" && periodHasNonZeroVal == 0)) {
                    $(row).find('.selectRowToDelete ').attr('disabled', 'disabled');
                }

                $(row).find('input[type=text]').each(function () {
                    $(this).attr('readonly', 'readonly').addClass('lockedMonths');

                });
                $(row).find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
                $(row).find('.action-btn .usePeriodRedistribution').addClass('lockedMonthsActionBtns');
                $(row).find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
                $(row).find('.growthRate').addClass('lockedMonthsActionBtns');

                $(row).find('.amortizePeriodLst .amortize-period').addClass('hideCol');
                $(row).find('.amortizePeriodLst span').removeClass('hideCol');
                $(row).find('.openTransactionPopup').addClass('hide');
                $(row).find('.transactionSpan').removeClass('hideCol');
            }

            //var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');
            ////if (lockedMonthsList.length == getNumberOfPeriods()) {
            //if (lockedMonthsList.length > 1) {
            //    $('#DataInputTable').find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
            //    $('#DataInputTable').find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
            //    $('#DataInputTable').find('.growthRate').addClass('lockedMonthsActionBtns');
            //}
            //for (var counter = 0; counter < lockedMonthsList.length; counter++) {
            //    $(row).find('input[type=text]').each(function () {
            //        if ($(this).hasClass(lockedMonthsList[counter].trim(''))) {
            //            $(this).attr('readonly', 'readonly').addClass('lockedMonths');
            //        }
            //    });
            //}


            // Get the locked months for the budget
            var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');

            //if (lockedMonthsList.length == getNumberOfPeriods()) {
            //    $('#DataInputTable').find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
            //    $('#DataInputTable').find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
            //    $('#DataInputTable').find('.growthRate').addClass('lockedMonthsActionBtns');
            //}

            // If the locked periods are more than 1 then hide the distro buttons(=,%) and growth rate button
            if (lockedMonthsList.length >= 1 && lockedMonthsList[0] != "") {
                $(row).find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
                $(row).find('.action-btn .usePeriodRedistribution').addClass('lockedMonthsActionBtns');
                $(row).find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
                $(row).find('.growthRate').addClass('lockedMonthsActionBtns');
            }
            var flag = 0;
            if (lockedMonthsList.length >= 1 && lockedMonthsList[0] != "") {
                for (var counter = 0; counter < lockedMonthsList.length; counter++) {
                    if ($(row).find('#hdnPLElementUID').text() > 0) { // added by Ankit to avoid locking of desc and vendor for new rows
                        $(row).find('.isDescription').not('.notLocked').attr('readonly', 'readonly').addClass('lockedMonths');
                        $(row).find('.isVendor:first').not('.notLocked').attr('readonly', 'readonly').addClass('lockedMonths');

                        if ((!$(row).find('[name="subcategoryVendordd"].lockedMonths').hasClass('disable')) && $(row).find('[name="subcategoryVendordd"].lockedMonths').length > 0) {
                            $(row).find('[name="subcategoryVendordd"].lockedMonths').addClass('disable')
                            $(row).find('[name="subcategoryVendordd"].lockedMonths').attr('disabled', 'disabled');

                            if ($(row).find('select[name="subcategoryVendordd"].lockedMonths').length > 0) {
                                $(row).find('select[name="subcategoryVendordd"].lockedMonths')[0].sumo.reload();
                            }
                        }
                    }
                    $(row).find('.total').attr('readonly', 'readonly').addClass('lockedMonths');

                    $(row).find('input[type=text]').each(function () {

                        if ($(this).hasClass(lockedMonthsList[counter].trim(''))) {
                            $(this).attr('readonly', 'readonly').addClass('lockedMonths');
                            if (Math.abs(parseFloat($(this).val())) > 0) {
                                flag = 1;
                                return false;
                            }
                        }
                        if (flag == 1) {
                            return false;
                        }
                    });
                }
            }

            if (flag == 1) {
                // commented by Ankit as the cells which are not locked should be editable.
                //$(row).find('input[type=text]').each(function () {
                //    $(this).attr('readonly', 'readonly').addClass('lockedMonths');
                //});
                // added by himanshu
                if (!$(row).hasClass('temp')) {
                    $(row).find('.selectRowToDelete').attr('disabled', 'disabled');
                }
            }
            //else {  // commented by Ankit as we need to lock the cells which are from locked periods for any case.
            for (var counter = 0; counter < lockedMonthsList.length; counter++) {
                $(row).find('input[type=text]').each(function () {
                    if ($(this).hasClass(lockedMonthsList[counter].trim(''))) {
                        $(this).attr('readonly', 'readonly').addClass('lockedMonths');
                    }
                    //else {
                    //    $(this).removeAttr('readonly').removeClass('lockedMonths');
                    //}

                });

                //$(row).find('.action-btn .distributeTotalEven').removeClass('lockedMonthsActionBtns');
                //$(row).find('.action-btn .distributeTotalPercent').removeClass('lockedMonthsActionBtns');
                //$(row).find('.growthRate').removeClass('lockedMonthsActionBtns');
            }
            //}

            //var flag = 1;
            //if (getNumberOfPeriods() > 0) {
            //    if ($(row).find('.data .editPeriod[value=0]').length != getNumberOfPeriods()) {
            //        $(row).find('input[type=text]').attr('readonly', 'readonly').addClass('lockedMonths');

            //        $(row).find('.action-btn .distributeTotalEven').addClass('lockedMonthsActionBtns');
            //        $(row).find('.action-btn .distributeTotalPercent').addClass('lockedMonthsActionBtns');
            //        $(row).find('.selectRowToDelete ').attr('disabled', 'disabled');
            //        if (!$(row).hasClass('historicaldata'))
            //            $(row).find('.growthRate').addClass('lockedMonthsActionBtns');
            //    }

            //    var flag = 0;
            //    for (var counter = 0; counter < lockedMonthsList.length; counter++) {
            //        $(row).find('input[type=text]').each(function () {
            //            if ($(this).hasClass(lockedMonthsList[counter].trim(''))) {
            //                $(this).attr('readonly', 'readonly').addClass('lockedMonths');
            //            }
            //            else {
            //                $(this).removeAttr('readonly').removeClass('lockedMonths');
            //                flag = 1;
            //            }
            //        });
            //    }
            //}

            //if (flag == 1) {
            //    $(row).find('.selectRowToDelete ').removeAttr('disabled');
            //}



            // Check if there is no formula for current category
            if (isFOA != "True") {
                $(row).find('input[type=text]:not(.sumo-search)').each(function () {
                    if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('isVendor') && !$(this).hasClass('isDescription')) {
                        // show calculator only for the textboxes which are not period-locked
                        $(this).calculator({ customDecimalPlaces: $(this).attr('data-decimalplaces') });
                    }
                });
            }

        },
        // Function used to create guid for each row
        guid: function () {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                  .toString(16)
                  .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
              s4() + '-' + s4() + s4() + s4();
        },
        // Function used to copy value of the first period textbox for all the period textboxes.
        CopyValuesToRow: function () {

            var firstPeriodVal = $(this).parent().nextAll('td.data').eq(0).find('input[type=text]').val();
            if (dataPercentageFilter == "data") {
                firstPeriodVal = $(this).parent().nextAll('td.data').find('input[type=text]:not(.inactive):not(.total):not(.lockedMonths):not(.disableByTransaction)').eq(0).val();
                $(this).parents('tr').find('td.data.rightAlign').each(function () {
                    // copying value to the textboxes which are not period-locked and not total.
                    $(this).find('input[type=text]:not(.inactive)').not('.total').not('.lockedMonths').not('.disableByTransaction').val(firstPeriodVal);
                });
            }
            else {
                firstPeriodVal = $(this).parents("tr").find("td.percentage").find("input[type=text]:not(.inactive):not(.total):not(.lockedMonths)").eq(0).val()
                $(this).parents('tr').find('td.percentage.rightAlign').each(function () {
                    // copying value to the textboxes which are not period-locked and not total.
                    $(this).find('input[type=text]:not(.inactive)').not('.total').not('.lockedMonths').not('.disableByTransaction').val(firstPeriodVal);
                });
            }

            return false;
        },
        //BD-954|saurabh|Function used to copy value of the active period textbox to the remaining forward month textboxes.
        CopyValueWithShortcut: function () {
           
            var activeElement = document.activeElement;
            if (!activeElement.classList.contains('lockedMonths') && activeElement.dataset.period != 'P12') {

                var value = document.activeElement.value;
                var activeMonth = activeElement.dataset.period.substring(1);

                //make a string of classes on which the value won't be copied/duplicated
                var classes = '';
                for (let i = 1; i < parseInt(activeMonth); i++) {
                    if (i < 10) classes += '.P0' + i;
                    else classes += '.P' + i;

                    if (i < parseInt(activeMonth) - 1) classes += ',';
                }

                if (dataPercentageFilter == "data") var elementsToTraverse = 'td.data.rightAlign';
                else var elementsToTraverse = 'td.percentage.rightAlign';

                $(":focus").parents('tr').find(elementsToTraverse).each(function () {
                    // copying value to the textboxes which are not period-locked or total and are behind the active textbox.
                    $(this).find('input[type=text]:not(.inactive)').not('.total').not('.lockedMonths').not('.disableByTransaction').not(classes).val(value);
                });
            }

            return false;
        },
        // Function used to select all the comp stores from the store dropdown.
        CheckAllComp: function () {
            RetailBudgetPro.Budget.filter = "Comp";
            $(this).attr('style', 'text-decoration:underline !important');
            $('.checkNonComp').removeAttr('style');
            $('.storeDD').find('select option').each(function () {
                $(this).removeAttr('selected');
                if ($(this).hasClass('comp')) {
                    $(this).prop('selected', 'selected');
                }
            });

            $(".multiselectLst").multiselect();

            $(".multiselectLst").multiselect("refresh");

            $('.multiselect-container').find('li:not(.active)').find('span').removeClass('checked');
            $('.multiselect-container').find('li.active').find('span').addClass('checked');

            // display data according to the comp stores
            RetailBudgetPro.Budget.DisplayFilteredData();
        },
        // Function used to select all the non-comp stores from the store dropdown.
        CheckAllNonComp: function () {
            RetailBudgetPro.Budget.filter = "NonComp"
            $(this).attr('style', 'text-decoration:underline !important');
            $('.checkComp').removeAttr('style');
            $('.storeDD').find('select option').each(function () {
                $(this).removeAttr('selected');
                if ($(this).hasClass('nonComp')) {
                    $(this).prop('selected', 'selected');
                }
            });


            $(".multiselectLst").multiselect("refresh");
            $('.multiselect-container').find('li:not(.active)').find('span').removeClass('checked');
            $('.multiselect-container').find('li.active').find('span').addClass('checked');

            // display data according to the non-comp stores
            RetailBudgetPro.Budget.DisplayFilteredData();
        },
        // Function used to display data according to the selected category and stores.
        DisplayFilteredData: function (e, mode) {

            var stores = $('[name=lstStores]').val();

            if (stores == null) {
                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "Please select at least one " + $('#hdnStoreName').val() + ".");
            }
            else {
                var confirmClick = function () {
                    if (e == undefined && mode != "delete")
                        $('.custom-data-table').hide();
                    $('.layout').css('display', 'block');

                    var groupedcategory = $('[name=groupedcategory] :selected').val();
                    var level = "0";
                    var viewLevel = "STORE";
                    var storeID = "-1";
                    var deptID = "-1";
                    var vendorIdCSV = ($('#vendordd').val() == null ? '' : $('#vendordd').val().join());

                    var categoryID = "-1";
                    var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                    var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                    if (categoryType == "NF") {
                        $('th.dateHeader, th.termHeader, th.amortizePeriodHeader').remove();
                        $('#DataInputTable').removeClass('bsCategory');
                        $('.transactionModeDiv').addClass('hide');
                    }
                    else if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {

                        var amortDeprHeaderText = '';
                        var DeprCatCount = 0;
                        var NonDeprCatCount = 0;

                        if (groupedcategory.split('|')[1] == '-1') {

                            var filteredCategories = $('[name="groupedcategory"] .boldGroup[value="' + groupedcategory + '"]').nextUntil('option.boldGroup');

                            DeprCatCount = filteredCategories.filter(function () { return $(this).data('isdepreciationcategory') == 'True'; }).length;
                            NonDeprCatCount = filteredCategories.filter(function () { return $(this).data('isdepreciationcategory') == 'False'; }).length;

                            if (NonDeprCatCount == 0) amortDeprHeaderText = 'Depr';
                            else if (DeprCatCount > 0 && NonDeprCatCount > 0) amortDeprHeaderText = 'A/D';
                            else amortDeprHeaderText = 'Amort';
                        }

                        if ($('th.dateHeader').length == 0) {
                            if ($('[name="groupedcategory"]').find('option:selected').attr('data-isdepreciationcategory') == "True" || amortDeprHeaderText == 'Depr') {
                                $('th.displayVendor:first').after('<th class="displayVendor dateHeader">Date</th><th class="displayVendor termHeader">Term</th><th title="Depreciation" class="displayVendor amortizePeriodHeader">Depr</th>')
                            }
                            else if (amortDeprHeaderText == 'A/D') {
                                $('th.displayVendor:first').after('<th class="displayVendor dateHeader">Date</th><th class="displayVendor termHeader">Term</th><th title="Choose amortization or depreciation period length" class="displayVendor amortizePeriodHeader">A/D</th>')
                            }
                            else {
                                $('th.displayVendor:first').after('<th class="displayVendor dateHeader">Date</th><th class="displayVendor termHeader">Term</th><th title="Amort" class="displayVendor amortizePeriodHeader">Amort</th>')
                            }
                            $('#DataInputTable').addClass('bsCategory');
                            $('.transactionModeDiv').removeClass('hide');
                        }
                        else {
                            if ($('[name="groupedcategory"]').find('option:selected').attr('data-isdepreciationcategory') == "True" || amortDeprHeaderText == 'Depr') {
                                $('#DataInputTable thead th.amortizePeriodHeader').text('Depr').attr('title', 'Choose amortization period length');
                            }
                            else if (amortDeprHeaderText == 'A/D') {
                                $('#DataInputTable thead th.amortizePeriodHeader').text('A/D').attr('title', 'Choose amortization or depreciation period length');
                            }
                            else {
                                $('#DataInputTable thead th.amortizePeriodHeader').text('Amort').attr('title', 'Choose amortization period length');
                            }
                        }
                    }

                    RetailBudgetPro.Budget.GetRowData(level, storeID, deptID, categoryID, groupedcategory, stores, RetailBudgetPro.Budget.filter, viewLevel, vendorIdCSV, bsMode, categoryType);
                }

                var cancelClick = function () {
                }

                // Check if the BottomLevel is open in edit mode if- then show alert else not
                if ($("#DataInputTable").find("a.save").parent().hasClass('show')) {
                    custom_confirm(confirmClick, cancelClick, "Confirm", "Any unsaved changes will be lost");
                    //if (confirm("Any unsaved changes will be lost")) {

                    //}
                }
                else {
                    if (e == undefined && mode != "delete")
                        $('.custom-data-table').hide();
                    $('.layout').css('display', 'block');
                    var groupedcategory = $('[name=groupedcategory] :selected').val();
                    var level = "0";
                    var viewLevel = "STORE";
                    var storeID = "-1";
                    var vendorIdCSV = ($('#vendordd').val() == null ? '' : $('#vendordd').val().join());
                    var deptID = "-1";
                    var categoryID = "-1";
                    var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                    var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                    if (categoryType == "NF") {
                        $('th.dateHeader, th.termHeader, th.amortizePeriodHeader').remove();
                        $('#DataInputTable').removeClass('bsCategory');
                        $('.transactionModeDiv').addClass('hide');
                    }
                    else if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {

                        var amortDeprHeaderText = '';
                        var DeprCatCount = 0;
                        var NonDeprCatCount = 0;

                        if (groupedcategory.split('|')[1] == '-1') {

                            var filteredCategories = $('[name="groupedcategory"] .boldGroup[value="' + groupedcategory + '"]').nextUntil('option.boldGroup');

                            DeprCatCount = filteredCategories.filter(function () { return $(this).data('isdepreciationcategory') == 'True'; }).length;
                            NonDeprCatCount = filteredCategories.filter(function () { return $(this).data('isdepreciationcategory') == 'False'; }).length;

                            if (NonDeprCatCount == 0) amortDeprHeaderText = 'Depr';
                            else if (DeprCatCount > 0 && NonDeprCatCount > 0) amortDeprHeaderText = 'A/D';
                            else amortDeprHeaderText = 'Amort';
                        }

                        if ($('th.dateHeader').length == 0) {
                            if ($('[name="groupedcategory"]').find('option:selected').attr('data-isdepreciationcategory') == "True" || amortDeprHeaderText == 'Depr') {
                                $('th.displayVendor:first').after('<th class="displayVendor dateHeader">Date</th><th class="displayVendor termHeader">Term</th><th title="Depreciation" class="displayVendor amortizePeriodHeader">Depr</th>')
                            }
                            else if (amortDeprHeaderText == 'A/D') {
                                $('th.displayVendor:first').after('<th class="displayVendor dateHeader">Date</th><th class="displayVendor termHeader">Term</th><th title="Choose amortization or depreciation period length" class="displayVendor amortizePeriodHeader">A/D</th>')
                            }
                            else {
                                $('th.displayVendor:first').after('<th class="displayVendor dateHeader">Date</th><th class="displayVendor termHeader">Term</th><th title="Amort" class="displayVendor amortizePeriodHeader">Amort</th>')
                            }

                            $('#DataInputTable').addClass('bsCategory');
                            $('.transactionModeDiv').removeClass('hide');
                        }
                        else {
                            if ($('[name="groupedcategory"]').find('option:selected').attr('data-isdepreciationcategory') == "True" || amortDeprHeaderText == 'Depr') {
                                $('#DataInputTable thead th.amortizePeriodHeader').text('Depr').attr('title', 'Choose amortization period length');
                            }
                            else if (amortDeprHeaderText == 'A/D') {
                                $('#DataInputTable thead th.amortizePeriodHeader').text('A/D').attr('title', 'Choose amortization or depreciation period length');
                            }
                            else {
                                $('#DataInputTable thead th.amortizePeriodHeader').text('Amort').attr('title', 'Choose amortization period length');
                            }
                        }
                    }

                    RetailBudgetPro.Budget.GetRowData(level, storeID, deptID, categoryID, groupedcategory, stores, RetailBudgetPro.Budget.filter, viewLevel, vendorIdCSV, bsMode, categoryType);
                }
            }
        },
        // Function used to display the select list as multiselect
        InitializeMultiselect: function () {
            //$('.multiselectLst').multiselect({
            //    includeSelectAllOption: true,
            //    enableCaseInsensitiveFiltering: true,
            //    enableClickableOptGroups: true,
            //    onChange: function (option, checked) {
            //        // Remove comp and non-comp selection if any store is checked from the dropdown.
            //        if (option != undefined) {
            //            if (option.hasClass('comp')) {
            //                $('.checkNonComp').removeAttr('style');
            //            }
            //            else if (option.hasClass('nonComp')) {
            //                $('.checkComp').removeAttr('style');
            //            }
            //        }
            //        else {
            //            $('.checkNonComp').removeAttr('style');
            //            $('.checkComp').removeAttr('style');
            //        }

            //        if (checked) {
            //            if ($(option).val() == undefined) {
            //                $($(this)[0].$container[0]).find('span').addClass('checked');
            //            }
            //            if ($($(this)[0].$container[0]).find('.checked').length + 2 == $($(this)[0].$container[0]).find('span').length) {
            //                $($($($(this)[0].$container[0]).find('[value="multiselect-all"]'))[0]).parents('span').addClass('checked');
            //            }
            //        }
            //        else {
            //            if ($(option).val() == undefined) {
            //                $($(this)[0].$container[0]).find('span').removeClass('checked');
            //            }
            //            else {
            //                $($($($(this)[0].$container[0]).find('[value="multiselect-all"]'))[0]).parents('span').removeClass('checked');
            //            }
            //        }
            //    }
            //});

            $('.multiselectLst').SumoSelect({ selectAll: true, search: true, searchText: 'Search' });
        },

        CheckReadOnlyMode: function() {
            if ($('[name="ReadOnlyMode"]').val() == 'True') {
                if ($('[name = "USRWithWriteAccess"]').val() != '' && $('[name = "USRWithWriteAccess"]').val() != $('[name = "USRLogin"]').val()) {
                    $('.budgets-fixed-sec').addClass('read-only-budgets-fixed-sec');
                }
                else if ($('[name = "USRWithWriteAccess"]').val() == '') {
                    $('.budgets-fixed-sec').addClass('read-only-budgets-fixed-sec');
                }
            }

            if ($('[name="batchEditReadOnlyMode"]').val() == 'True') {
                $('.budgets-fixed-sec').addClass('read-only-budgets-fixed-sec');
            }
        },
        // Function used to show historical data once the expander for current year is clicked
        ShowHistoricalData: function () {
            $parentTr = $(this).parents('tr');
            $LYTr = $parentTr.next('tr');
            $LLYTr = $LYTr.next('tr');

            $LYTr.removeClass('hideyear').addClass('showyear');
            $LLYTr.removeClass('hideyear').addClass('showyear');
            $parentTr.find('.expandYear').removeClass('expandYear').addClass('collapseYear')
            $parentTr.find('.collapseYear').attr('title', 'Hide Historical Data');
            $parentTr.next('tr').removeClass('hidden');
            $parentTr.next('tr').next('tr').removeClass('hidden');

        },
        // Function used to hide historical data once the expander for current year is clicked
        HideHistoricalData: function () {
            $parentTr = $(this).parents('tr');
            $LYTr = $parentTr.next('tr');
            $LLYTr = $LYTr.next('tr');

            $LYTr.removeClass('showyear').addClass('hideyear');
            $LLYTr.removeClass('showyear').addClass('hideyear');
            $parentTr.find('.collapseYear').removeClass('collapseYear').addClass('expandYear')
            $parentTr.find('.expandYear').attr('title', 'Show Historical Data');
        },
        // Function used to switch between data and percentage mode.
        // show dollar when mode is 'data' else show percentage mode.
        ManageDataAndPerentage: function () {
            if ($(this).hasClass("data")) {
                dataPercentageFilter = "data";
                
                if (!firstTimeLoad) {
                    var $btLevel = $('.bottomLevel').has('#hdnCatCalucaltedType:empty');
                    $btLevel.not($btLevel.has('#hdnPLElementUID:containsExact("-1")')).find('.data span').attr('data-target', null);
                }
            }
            else if ($(this).hasClass("percentage")) {
                dataPercentageFilter = "percentage";

                var $btLevel = $('.bottomLevel').has('#hdnCatCalucaltedType:empty');
                $btLevel.not($btLevel.has('#hdnPLElementUID:containsExact("-1")')).find('.percentage span').attr('data-target', null);
            }

            var $allTables = $(document).find('table').filter(function () {
                return $(this).parents('.formulamodal').length == 0;
            });

            var $td = $allTables.find('tr.netsales .percentage');

            if (dataPercentageFilter == "data") {

                $allTables.find('tr:not(.store-childData-row):not(.store-data-row) .percentage').addClass('hide');
                $allTables.find('tr:not(.store-childData-row):not(.store-data-row) .data').removeClass('hide');

                $td.find('span').html(function (index) {
                    return $td.eq(index).attr('data-percentVal');
                });

                $('#btnPercentage').removeClass('active');
                $('#btnData').addClass('active');

                $('.edit').removeClass('hide');
            }
            else {
                $allTables.find('tr:not(.store-childData-row):not(.store-data-row) .data').addClass('hide');
                $allTables.find('tr:not(.store-childData-row):not(.store-data-row) .percentage').removeClass('hide');

                // Net sales data will always be shown in data mode i.e in  dollar
                $td.find('span').html(function (index) {
                    return $td.eq(index).attr('data-dollarVal');
                });

                $('#btnPercentage').addClass('active');
                $('#btnData').removeClass('active');

                if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True") $('.edit').addClass('hide');
            }

            firstTimeLoad = false;

            $(document).find('tr[data-isnoneditablecategory="True"] a.edit').addClass('hide')

            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True")
            {
                $('tr.deltaTotal .collapseYear').trigger('click');
            }

            FreezeDataInputTable()

            //if (relayout) fixTable(document.getElementById('fixed-table-container-datasheetTable'));

            //$(document).find('table tr.netsales').each(function () {
            //    $(this).find('.data').show();
            //    $(this).find('.percentage').hide()
            //});
        },

        ToggleCommentMode: function () {
            $parentTr = $(this).parents('tr');
            var $tr = $parentTr.nextUntil('.l' + $parentTr.attr('data-level'));

            $('#DataInputTable tbody tr').removeClass('active-row').addClass('blurView').removeClass('highlight');
            $parentTr.addClass('active-row').removeClass('blurView');
            $tr.addClass('highlight').removeClass('blurView');

            var $tFilteredRows = $tr.filter('.bottomLevel').has('#hdnCatCalucaltedType:empty,#hdnCatCalucaltedType:containsExact("NE")');

            var $filteredRows = $tFilteredRows.not($tFilteredRows.has('#hdnPLElementUID:containsExact("-1")'));

            if ($parentTr.find('.comment').find('i').hasClass('fa-comment-o')) {
                $(this).attr("title", 'Hide Comments');

                $parentTr.find('.comment').find('i').removeClass('fa fa-comment-o').addClass('fa fa-comment');

                $filteredRows.find('.desc-field, .data span, .percentage span').addClass('commentModeOn').attr("data-toggle", "modal");

                if ($('#ShowVendor').val() == "True") {
                    $filteredRows.find('.vendor').addClass('commentModeOn').attr("data-toggle", "modal");
                }
                else {
                    $filteredRows.find('.isVendor').next('span').addClass('commentModeOn').attr("data-toggle", "modal");
                }
            }
            else if ($parentTr.find('.comment').find('i').hasClass('fa-comment')) {
                $(this).attr("title", 'Show Comments');

                $parentTr.find('.comment').find('i').removeClass('fa fa-comment').addClass('fa fa-comment-o');

                $filteredRows.find('.desc-field, .data span, .percentage span').removeClass('commentModeOn').removeAttr("data-toggle");

                if ($('#ShowVendor').val() == "True") {
                    $filteredRows.find('.vendor').removeClass('commentModeOn').removeAttr("data-toggle");
                }
                else {
                    $filteredRows.find('.isVendor').next('span').removeClass('commentModeOn').removeAttr("data-toggle");
                }
            }           
        },

        // Function used to present the editable view
        EditCategoryData: function (e, source) {
            var TurnOnBalanceSheetVal = RetailBudgetPro.Budget.turnOnBalanceSheetVal;
            var hdnNumberOfPeriodsVal = RetailBudgetPro.Budget.numberOfPeriodsVal;

            // Check if the source is 'Growth rate click' as we are opening edit mode on clicking of growth rate button click
            // and we dont have $(e.currenttarget)
            if (RetailBudgetPro.Budget.isUserInApproveBudget == "True" || (RetailBudgetPro.Budget.isUserInApproveBudget == "False" && RetailBudgetPro.Budget.hasUserApprovers == "True")) {

                if (source == "growthRate") {
                    $parentTr = $(e).parents('tr');
                    var catTypeRE = $parentTr.find('td#hdnCATTypeRE').text();

                    var isFOA = $parentTr.find('#hdnIsFOA').text();
                    var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');

                    if (isFOA != "True") {
                        // Show the growth rate button on the totals historical data
                        $parentTr.nextAll('.totals').eq(0).next('tr').find('.growthRate').show();
                        $parentTr.nextAll('.totals').eq(0).next('tr').next('tr').find('.growthRate').show();

                        $parentTr.find('.checkAllToDelete').removeClass('hideCol').addClass('showCol');
                        $parentTr.find('.sort-vendor').hide();
                        $parentTr.find('.sort-description').hide();
                        if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12)
                            $parentTr.find('.sort-date').hide();
                        $parentTr.find('.sort-total').hide();
                        $parentTr.find('.save').parent().removeClass('hideCol');

			            // For branch BD-1122
                        //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                        //    $parentTr.find('.checkAllToDelete').attr('disabled', true);
                        //}
                        $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
                            // Used to show the newly created row we created after deleting all bottom lines
                            if ($(this).hasClass('newRowAfterDelAll')) {
                                $(this).removeClass('hide');
                            }

                            var $hdnCatCalucaltedOnTd = $(this).find('#hdnCatCalucaltedOn');
                            var isCashFlowThrough = $parentTr.find('td#hdnIsCashFlowThrough').text();
                            var catTypeRE = $parentTr.find('td#hdnCATTypeRE').text();
                            var isDepreciationExpense = $parentTr.find('td#hdnIsDepreciationExpense').text();

                            if ($hdnCatCalucaltedOnTd.length == 0 || $hdnCatCalucaltedOnTd.text().trim() == '') $(this).find('.copyValues').show();

			                // For branch BD-1122
			                //if (isCashFlowThrough == "False" || !(RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True')) {
                            if (isCashFlowThrough == "False") {
                                $(this).find('input').removeClass('hideCol');
                                $(this).find('td:not(.vendorLst):not(.currencyLst):not(.termLst) span').addClass('hideCol');
                            }
                            else {
                                $(this).find('input:not(.amortize-period)').removeClass('hideCol');
                                $(this).find('td:not(.vendorLst):not(.currencyLst):not(.termLst):not(.amortizePeriodLst) span').addClass('hideCol');

                                if ($(this).find('td.amortizePeriodLst span').html() == '') {
                                    $(this).find('td.amortizePeriodLst span').html('1');
                                }
                            }

                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'True') { For branch BD-1122
                            $(this).find('td.vendorLst .vendor').hide();
                            $(this).find('td.vendorLst .vendorDD').removeClass('hide');
                            //}

                            var $hdnCatCalucaltedType = $(this).find('#hdnCatCalucaltedType');

                            var hdnCatCalucaltedTypeVal = '';

                            if ($hdnCatCalucaltedType.length > 0) {
                                hdnCatCalucaltedTypeVal = $hdnCatCalucaltedType.text().trim();
                            }

			                //For branch BD-1122
			                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True" && !($(this).find('td').eq(0).find('a').hasClass('linked-category-data') || $(this).find('td').eq(0).find('a').hasClass('edit-formula') || $(this).hasClass('nonEditableRow') || hdnCatCalucaltedTypeVal == 'EFP' || hdnCatCalucaltedTypeVal == 'EP')) {
                            if (!($(this).find('td').eq(0).find('a').hasClass('linked-category-data') || $(this).find('td').eq(0).find('a').hasClass('edit-formula') || $(this).hasClass('nonEditableRow') || hdnCatCalucaltedTypeVal == 'EFP' || hdnCatCalucaltedTypeVal == 'EP')) {
                                $(this).find('td.currencyLst .currency').addClass('hide');
                                $(this).find('td.currencyLst .currencyDD').removeClass('hide');

                                if (isCashFlowThrough == "False" && catTypeRE != "C" && isDepreciationExpense == "False") {
                                    $(this).find('td.termLst .termSpan').addClass('hide');
                                    $(this).find('td.termLst .termDD').removeClass('hide');
                                }
                                else {
                                    $(this).find('td.termLst .termSpan').html('N/A');
                                }
                            }
                            $(this).find('.action-btn').removeClass('hideCol');
                            $(this).find('td.hasComment').removeClass('hasComment').addClass('hideComent');
                            $(this).find('td.dateLst .openTransactionPopup').removeClass('hide');

                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'True') { For branch BD-1122
                            $(this).find('td.vendorLst').removeClass('vendor-wrap');
                            $(this).find('td.termLst').removeClass('vendor-wrap');
                            //}

                            //if ($(document).find('#hdnUserInApproveBudget').val() == "True") {
                            //    $(this).find('input[type=checkbox]').not('.unapproved-row').removeClass('hideCol').addClass('showCol');
                            //}
                            //else {
                            $(this).find('input[type=checkbox]').removeClass('hideCol').addClass('showCol');
                            $(this).find('.rowStatus').removeClass('showCol').addClass('hideCol');
                            //}
                            $(this).find('.exl-rowno').removeClass('hideCol').addClass('showCol');
                            //$parentTr.find('.checkAllToDelete').removeClass('hideCol');
                            //$(this).find('.selectRowToDelete').removeClass('hideCol');

                            var isCatFixed = 0;

                            var catId = $parentTr.find('td#hdnCatUID').text().trim();

                            if ($('[name=groupedcategory] option.clsCategory[value$="|' + catId + '"]').attr('data-cattype') == 'F') {
                                isCatFixed = 1;
                            }

                            if (isCatFixed == 0) {
                                $parentTr.nextAll('.bottomLevel:not(.historicaldata)').each(function () {
                                    if ($(this).hasClass('nonEditableRow') || (RetailBudgetPro.Budget.isUserInApproveBudget == "True" && $(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == "")) {
                                        $(this).find('.upload-excel').remove();
                                    }
                                });
                                //$parentTr.find('.action-items .edit').parent('div').next('div').find('.upload-excel').remove();
                            }
                            else {
                                //commented by Aman as we can traverse the bottom level rows itself  
                                //$parentTr.nextUntil('.bottomLevel.historicaldata', '.bottomLevel').each(function () {
                                //For branch BD-1122
				                //if (!$(this).hasClass('nonEditableRow') && ($(this).find('#hdnCatCalucaltedOn').length == 0 || ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == "") && RetailBudgetPro.Budget.isUserInEditDataPageRole == 'True')) {
				                if (!$(this).hasClass('nonEditableRow') && ($(this).find('#hdnCatCalucaltedOn').length == 0 || ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == ""))) {

                                    if (RetailBudgetPro.Budget.isUserInApproveBudget == "True" && !$(this).hasClass('unapproved-sent')) {
                                        var excelFileClass = $(this).find('#hdnFromExcel').html().trim() == "" ? "fa fa-file-excel-o" : "file-excel-filed";

                                        var excelFileRowClass = $(this).find('#hdnFromExcel').html().trim() == "" ? "" : "highlightExcelRow";

                                        if ($(this).find('.upload-excel').length == 0) {
                                            $(this).find('td:first()').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="' + excelFileClass + '"></i></a>');
                                        }
                                        else {
                                            $(this).find('.upload-excel').removeClass('hide');
                                        }

                                        $(this).addClass(excelFileRowClass);
                                    }


                                    if ($(this).find('.bottomLevelCategoryComment i').length == 0 && ($(this).find('#hdnComment').html() == "" || $(this).find('#hdnComment').html() == undefined)) {
                                        if ($(this).find('.function-btn a:last()').hasClass('downloadLinkedDocument'))
                                            $(this).find('.function-btn a:last()').before('<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o"></i></a>');
                                        else
                                            $(this).find('.function-btn a:last()').after('<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o"></i></a>');
                                    }
                                    else {
                                        $(this).find('.bottomLevelCategoryComment i').removeClass('hide');
                                    }

                                    var docFileClass = $(this).find('#hdnAttachedSubCategoryFolderName').html().trim() == "" ? "fa fa-file" : "fa fa-file icon-red";

                                    $(this).filter('.highlightExcelRow').find('.action-btn .bottomLevelCategoryComment').addClass('hide');
                                    $(this).filter('.highlightExcelRow').find('td.vendorLst').removeClass('showVendorInTitle');

                                    if ($(this).find('.documentUpload').length == 0 && ($(this).find('#hdnAttachedSubCategoryFolderName').html() == "" || $(this).find('#hdnAttachedSubCategoryFolderName').html() == undefined)) {
                                        $(this).find('.function-btn a:last()').after('<a href="javascript:void(0)" class="documentUpload" title="Upload document"><i class="' + docFileClass + '"></i></a><input type="file" class="documentFile" accept=".pdf, .doc, .docx, .xls, .xlsx" style="display: none;" />');
                                    }
                                    else {
                                        $(this).find('.documentUpload').removeClass('hide');
                                    }
                                }

                                if (($(this).hasClass('nonEditableRow') && $(this).find('#hdnFromExcel').length != 0 && $(this).find('#hdnFromExcel').html().trim() != "")) {
                                    $(this).addClass("highlightExcelRow");

                                    $(this).filter('.highlightExcelRow').find('.action-btn .bottomLevelCategoryComment').addClass('hide');
                                    $(this).filter('.highlightExcelRow').find('td.vendorLst').removeClass('showVendorInTitle');
                                }

                                //else if ($(this).find('#hdnCatCalucaltedOn').length == 0) {
                                //    if ($(this).find('.upload-excel').length == 0) {
                                //        $(this).find('td:first()').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a>');
                                //    }
                                //    else {
                                //        $(this).find('.upload-excel').removeClass('hide');
                                //    }
                                //}
                                //});
                                //$parentTr.find('.action-items .edit').parent('div').next('div').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a>');
                            }

                            $(this).find('.downloadLinkedExcel').addClass('hide');

                            $parentTr.find('.action-items .edit').parent('div').removeClass('show').addClass('hide').next('div').addClass('show').removeClass('hide');

                            $(this).find('.action-btn').find('.distributeTotalEven').show();
                            $(this).find('.action-btn').find('.usePeriodRedistribution').show();
                            $(this).find('.action-btn').find('.growthRate').show();
                            $(this).find('.action-btn').find('.distributeTotalPercent').show();
                            $(this).find('.action-btn').find('.userdata').hide();
                            //$('#DataInputTable').find('.displayVendor.actionBtnsTd').html('Actions');
                            $(this).find('.function-btn').removeClass('userDetail');
                            RetailBudgetPro.Budget.LockedMonthsCheck($(this), "false");

			                //For branch BD-1122
                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "False") {
                            //    $(this).find('.action-btn .downloadLinkedDocument').addClass('hide');
                            //    $(this).find('.action-btn .bottomLevelCategoryComment').addClass('hide');
                            //}

                            if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                                $(this).find('input[type=text]:not(.isDescription):not(.isVendor)').addClass('highlightBckg');

                                $(this).find('td.vendorLst .vendorDD .sumo_subcategoryVendordd').addClass('hidePerm');
                                $(this).find('td.termLst .termDD .sumo_subCategoryTermDD').addClass('hidePerm');
                                $(this).find('td.currencyLst .currencyDD .sumo_subCategoryCurrencyDD').addClass('hidePerm');
                            }

                            $(this).find('.linked-category-data').attr('title', 'Edit Inputs');
                            //if (source != "growthRate")
                            //  $('div[class=action-items][class!=current]').hide();

                            if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && $(this).hasClass('highlightExcelRow')) {
                                $(this).find('.transactionDateDiv').addClass('disable-wrapper');
                                $(this).find('.dayOfPeriodDiv').addClass('disable-wrapper');
                                //$(document).find('tr.beginningBalance:not(.blurView), tr.endingBalance:not(.blurView), tr.totals:not(.blurView)').each(function () {
                                //    $(this).find('span.accrualViewData').addClass('hide');
                                //    $(this).find('span.editViewData').removeClass('hide');
                                //})
                            }
                        });
                        //$parentTr.nextAll('tr.ViewMoreRows').first().addClass('hideyear');

                        if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True") {
                            $('#btnPercentage').addClass('hide');

                            //$(document).find('tr.beginningBalance:not(.blurView), tr.endingBalance:not(.blurView), tr.totals:not(.blurView)').each(function () {
                            //    $(this).find('span.accrualViewData').addClass('hide');
                            //    $(this).find('span.editViewData').removeClass('hide');
                            //})
                        }
                    }

                    $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
                        if (($(this).hasClass('unapproved-sent') && RetailBudgetPro.Budget.isUserInApproveBudget == "True") || (RetailBudgetPro.Budget.isUserInApproveBudget == "False" && $(this).hasClass('delete-request'))) {
                            $(this).find('input[type="text"]').attr('readonly', 'readonly').addClass('lockedMonths');
                        }
                    });

                    if ($parentTr.nextUntil('.doNotExpand:not(.beginningBalance)').not('.historicaldata').has('[type=checkbox]:enabled').has('[type=text]:not(.lockedMonths)').length == 0) {
                        var level = $parentTr.data('level');
                        html = getNewRow($parentTr, parseInt(level) + 1);
                        var isFOA = $parentTr.find('#hdnIsFOA').val();
                        var finalHtml = $(html).insertBefore($($parentTr).nextUntil('.bottomLevel.historicaldata', '.bottomLevel').first());

                        if (catTypeRE == "E" || catTypeRE == "D") {
                            $(finalHtml).find('[name="subCategoryTermDD"] option[data-cattype="D"]').remove();
                        }
                        else if (catTypeRE == "R") {
                            $(finalHtml).find('[name="subCategoryTermDD"] option[data-cattype="C"]').remove();
                        }

                        finalHtml.removeClass('show-action-btns');
                        RetailBudgetPro.Budget.LockedMonthsCheck(finalHtml, isFOA);


                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        // In case all bottom lines deleted add this class to use as an identifier
                        finalHtml.addClass('newRowAfterDelAll');

                        $('.newRowAfterDelAll [name="subCategoryCurrencyDD"]').SumoSelect();

                        $('.newRowAfterDelAll [name="subCategoryTermDD"]').SumoSelect();

                        if (showOptionsInVendorDropDown)
                            $('.newRowAfterDelAll .drpdwnvendor').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                        else
                            $('.newRowAfterDelAll .drpdwnvendor').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true });

			            //For branch BD-1122
                        //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                        //    $(finalHtml).find('td .selectRowToDelete').addClass('disable-wrapper').attr('disabled', true);
                        //    $(finalHtml).find('td .isDescription').addClass('hideCol');
                        //    $(finalHtml).find('td.action-btn .bottomLevelCategoryComment, td.action-btn .documentUpload').addClass('hide');


                        //    if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                        //        $(finalHtml).find('td.amortizePeriodLst .amortize-period').addClass('hideCol');
                        //        $(finalHtml).find('td.amortizePeriodLst span').removeClass('hideCol');
                        //        $(finalHtml).find('.termLst .termDD').addClass('hide');
                        //        $(finalHtml).find('.termLst span').removeClass('hide');
                        //        $(finalHtml).find('td .dayOfPeriodDiv .dayOfPeriod').hide();
                        //        $(finalHtml).find('.dayOfPeriodDiv span').removeClass('hideCol').removeClass('hide').addClass('showCol');
                        //    }

                        //    if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                        //        $(finalHtml).find('.currencyLst .currencyDD').addClass('hide');
                        //        $(finalHtml).find('.currencyLst span').removeClass('hide');
                        //    }

                        //    $(finalHtml).find('.ven-list, .isVendor').addClass('hide');
                        //    $(finalHtml).find('.vendor').removeClass('hide');

                        //}
                    //}

                    //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                    //    $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
                    //        $(this).find('[class*="DATValue"] input, td.amortizePeriodLst span').removeClass('hideCol').addClass('showCol');
                    //        $(this).find('[class*="DATValue"] span, td.amortizePeriodLst input').addClass('hideCol').removeClass('showCol');

                    //        if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                    //            $(this).find('td .dayOfPeriodDiv .dayOfPeriod, td .transactionDateDiv .transactionDate').hide();
                    //            $(this).find('.dayOfPeriodDiv span, .transactionDateDiv span').removeClass('hideCol').addClass('showCol');
                    //        }

                    //        $(this).find('.selectRowToDelete').attr("disabled", true);
                    //    });
                    }

                    if ($('#hdnUsePeriodReDistribution').val() == "True") $parentTr.parents('table').addClass('UsePeriodRedibution');

                }
                else {
                    initialSelectedVendorsArray = [];
                    $(e.currentTarget).parent('div').parent('div').addClass('current');
                    $parentTr = $(e.currentTarget).parents('tr');
                    var catTypeRE = $parentTr.find('td#hdnCATTypeRE').text();
                    var isDepreicationExpense = $parentTr.find('td#hdnIsDepreciationExpense').text();

                    if ($('.inEditMode').length == 0) {
                        $parentTr.addClass('inEditMode');
                        var isFOA = $parentTr.find('#hdnIsFOA').text();
                        var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');

                        if (isFOA != "True") {
                            // Show the growth rate button on the totals historical data
                            $parentTr.nextAll('.totals').eq(0).next('tr').find('.growthRate').show();
                            $parentTr.nextAll('.totals').eq(0).next('tr').next('tr').find('.growthRate').show();

                            $parentTr.find('.checkAllToDelete').removeClass('hideCol').addClass('showCol');
                            $parentTr.find('.sort-vendor').hide();
                            if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12)
                                $parentTr.find('.sort-date').hide();
                            $parentTr.find('.sort-description').hide();
                            $parentTr.find('.sort-total').hide();
                            $parentTr.find('.save').parent().removeClass('hideCol');

			                //For branch BD-1122
                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                            //    $parentTr.find('.checkAllToDelete').attr("disabled", true);
                            //}

                            $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {//:not(.nonEditableRow)
                                // Used to show the newly created row we created after deleting all bottom lines
                                if ($(this).hasClass('newRowAfterDelAll')) {
                                    $(this).removeClass('hide');
                                }
                                $(this).find('td.hasComment').removeClass('hasComment').addClass('hideComment');

                                var $hdnCatCalucaltedOnTd = $(this).find('#hdnCatCalucaltedOn');
                                var isCashFlowThrough = $parentTr.find('td#hdnIsCashFlowThrough').text();

                                var catId = $parentTr.find('td#hdnCatUID').text().trim();
                                var catOption = $('[name=groupedcategory] option.clsCategory[value$="|' + catId + '"]');

                                var isCapex = catOption.data('iscapex');
                                var isBalanceSheet = catOption.data('isbalancesheet');

                                if ($hdnCatCalucaltedOnTd.length == 0 || $hdnCatCalucaltedOnTd.text().trim() == '') $(this).find('.copyValues').show();

                                if (isCashFlowThrough == "True" || (isCapex == "False" && isBalanceSheet == "True")) {
                                    $(this).find('input:not(.amortize-period)').removeClass('hideCol');
                                    $(this).find('td:not(.vendorLst):not(.currencyLst):not(.termLst):not(.amortizePeriodLst) span:not(.modifiedByUser)').addClass('hideCol');

                                    if ($(this).find('td.amortizePeriodLst span').html() == '') {
                                        $(this).find('td.amortizePeriodLst span').html('1');
                                    }
                                }
                                else { //if (!(RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True')) { For branch BD-1122
                                    $(this).find('input').removeClass('hideCol');
                                    $(this).find('td:not(.vendorLst):not(.currencyLst):not(.termLst) span:not(.modifiedByUser)').addClass('hideCol');
                                }

                                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'True') { For branch BD-1122
                                $(this).find('td.vendorLst .vendor').hide();
                                $(this).find('td.vendorLst .vendorDD').removeClass('hide');
                                //}

                                var $hdnCatCalucaltedType = $(this).find('#hdnCatCalucaltedType');

                                var hdnCatCalucaltedTypeVal = '';

                                if ($hdnCatCalucaltedType.length > 0) {
                                    hdnCatCalucaltedTypeVal = $hdnCatCalucaltedType.text().trim();
                                }

				                //For branch BD-1122
				                //if ((RetailBudgetPro.Budget.isUserInEditDataPageRole == 'True') && !($(this).find('td').eq(0).find('a').hasClass('linked-category-data') || $(this).find('td').eq(0).find('a').hasClass('edit-formula') || $(this).hasClass('nonEditableRow') || hdnCatCalucaltedTypeVal == 'EFP' || hdnCatCalucaltedTypeVal == 'EP')) {
                                if (!($(this).find('td').eq(0).find('a').hasClass('linked-category-data') || $(this).find('td').eq(0).find('a').hasClass('edit-formula') || $(this).hasClass('nonEditableRow') || hdnCatCalucaltedTypeVal == 'EFP' || hdnCatCalucaltedTypeVal == 'EP')) {
                                    $(this).find('td.currencyLst .currency').addClass('hide');
                                    $(this).find('td.currencyLst .currencyDD').removeClass('hide');

                                    if (isCashFlowThrough == "False" && catTypeRE != "C" && isDepreicationExpense == "False") {
                                        $(this).find('td.termLst .termSpan').addClass('hide');
                                        $(this).find('td.termLst .termDD').removeClass('hide');
                                    }
                                    else {
                                        $(this).find('td.termLst .termSpan').html('N/A');
                                    }
                                }
                                $(this).find('.action-btn').removeClass('hideCol');
                                $(this).find('.action-btn').removeClass('hideCol');
                                $(this).find('input[type=checkbox]').removeClass('hideCol').addClass('showCol');
                                $(this).find('.exl-rowno').removeClass('hideCol').addClass('showCol');
                                $(this).find('.rowStatus').removeClass('showCol').addClass('hideCol');

                                $(this).find('td.dateLst .openTransactionPopup').removeClass('hide');

                                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") { For branch BD-1122
                                $(this).find('td.vendorLst').removeClass('vendor-wrap');
                                $(this).find('td.termLst').removeClass('vendor-wrap');
                                ////$parentTr.find('.checkAllToDelete').removeClass('hideCol');
                                ////$(this).find('.selectRowToDelete').removeClass('hideCol');
                                //}

                                var isCatFixed = 0;

                                if ($('[name=groupedcategory] option.clsCategory[value$="|' + catId + '"]').attr('data-cattype') == 'F') {
                                    isCatFixed = 1;
                                }

                                if (RetailBudgetPro.Budget.isUserInApproveBudget == "True" && isCatFixed == 0) {
                                    $parentTr.nextAll('.bottomLevel:not(.historicaldata)').each(function () {
                                        if ($(this).hasClass('nonEditableRow') || ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == "")) {
                                            $(this).find('.upload-excel').remove();
                                        }
                                    });
                                    //$parentTr.find('.action-items .edit').parent('div').next('div').find('.upload-excel').remove();
                                }
                                else {
                                    //commented by Aman as we can traverse the bottom level rows itself 
                                    // $parentTr.nextUntil('.bottomLevel.historicaldata', '.bottomLevel').each(function () {

				                    //For branch BD-1122
				                    //if (!($(this).hasClass('nonEditableRow') && $(this).find('#hdnCatCalucaltedType').text() != 'NE') && ($(this).find('#hdnCatCalucaltedOn').length == 0 || ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == "") && ($('#hdnIsUserInEditDataPageRole').val() == 'True'))) {
                                    if (!($(this).hasClass('nonEditableRow') && $(this).find('#hdnCatCalucaltedType').text() != 'NE') && ($(this).find('#hdnCatCalucaltedOn').length == 0 || ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == ""))) {

                                        if (RetailBudgetPro.Budget.isUserInApproveBudget == "True" && !$(this).hasClass('unapproved-sent') && $(this).find('#hdnCatCalucaltedType').text() != 'NE') {
                                            var excelFileClass = $(this).find('#hdnFromExcel').html().trim() == "" ? "fa fa-file-excel-o" : "file-excel-filed";

                                            var excelFileRowClass = $(this).find('#hdnFromExcel').html().trim() == "" ? "" : "highlightExcelRow";

                                            if ($(this).find('.upload-excel').length == 0) {
                                                $(this).find('td:first()').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="' + excelFileClass + '"></i></a>');
                                            }
                                            else {
                                                $(this).find('.upload-excel').removeClass('hide');
                                            }

                                            $(this).addClass(excelFileRowClass);
                                        }

                                        if ($(this).find('.bottomLevelCategoryComment i').length == 0 && ($(this).find('#hdnComment').html() == "" || $(this).find('#hdnComment').html() == undefined)) {
                                            if ($(this).find('.function-btn a:last()').hasClass('downloadLinkedDocument'))
                                                $(this).find('.function-btn a:last()').before('<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o"></i></a>');
                                            else
                                                $(this).find('.function-btn a:last()').after('<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o"></i></a>');
                                        }
                                        else {
                                            $(this).find('.bottomLevelCategoryComment i').removeClass('hide');
                                        }

                                        if ($(this).find('#hdnCatCalucaltedType').text() != 'NE') {
                                            var docFileClass = $(this).find('#hdnAttachedSubCategoryFolderName').html().trim() == "" ? "fa fa-file" : "fa fa-file icon-red";

                                            $(this).filter('.highlightExcelRow').find('.action-btn .bottomLevelCategoryComment').addClass('hide');
                                            $(this).filter('.highlightExcelRow').find('td.vendorLst').removeClass('showVendorInTitle');

                                            if ($(this).find('.documentUpload').length == 0 && ($(this).find('#hdnAttachedSubCategoryFolderName').html() == "" || $(this).find('#hdnAttachedSubCategoryFolderName').html() == undefined)) {
                                                $(this).find('.function-btn a:last()').after('<a href="javascript:void(0)" class="documentUpload" title="Upload document"><i class="' + docFileClass + '"></i></a><input type="file" class="documentFile" accept=".pdf, .doc, .docx, .xls, .xlsx" style="display: none;" />');
                                            }
                                            else {
                                                $(this).find('.documentUpload').removeClass('hide');
                                            }
                                        }
                                    }

                                    if (($(this).hasClass('nonEditableRow') && $(this).find('#hdnFromExcel').length != 0 && $(this).find('#hdnFromExcel').html().trim() != "")) {
                                        $(this).addClass("highlightExcelRow");

                                        $(this).filter('.highlightExcelRow').find('.action-btn .bottomLevelCategoryComment').addClass('hide');
                                        $(this).filter('.highlightExcelRow').find('td.vendorLst').removeClass('showVendorInTitle');
                                    }

                                    //else if ($(this).find('#hdnCatCalucaltedOn').length == 0) {
                                    //    if ($(this).find('.upload-excel').length == 0) {
                                    //        $(this).find('td:first()').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a>');
                                    //    }
                                    //    else {
                                    //        $(this).find('.upload-excel').removeClass('hide');
                                    //    }
                                    //}
                                    // });
                                    //$parentTr.find('.action-items .edit').parent('div').next('div').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="fa fa-file-excel-o"></i></a>');
                                }

                                $(this).find('.downloadLinkedExcel').addClass('hide');

                                $parentTr.find('.action-items .edit').parent('div').removeClass('show').addClass('hide').next('div').addClass('show').removeClass('hide');

                                $(this).find('.action-btn').find('.distributeTotalEven').show();
                                $(this).find('.action-btn').find('.usePeriodRedistribution').show();
                                $(this).find('.action-btn').find('.growthRate').show();
                                $(this).find('.action-btn').find('.distributeTotalPercent').show();
                                $(this).find('.action-btn').find('.userdata').hide();
                                //$('#DataInputTable').find('.displayVendor.actionBtnsTd').html('Actions');
                                $(this).find('.function-btn').removeClass('userDetail');
                                RetailBudgetPro.Budget.LockedMonthsCheck($(this), "false");
				
				                //For branch BD-1122
                                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "False") {
                                //    $(this).find('.action-btn .downloadLinkedDocument').addClass('hide');
                                //    $(this).find('.action-btn .bottomLevelCategoryComment').addClass('hide');
                                //}

                                if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                                    $(this).find('input[type=text]').addClass('highlightBckg');

                                    $(this).find('td.vendorLst .vendorDD .sumo_subcategoryVendordd').addClass('hidePerm');
                                    $(this).find('td.termLst .termDD .sumo_subCategoryTermDD').addClass('hidePerm');
                                    $(this).find('td.currencyLst .currencyDD .sumo_subCategoryCurrencyDD').addClass('hidePerm');
                                }

                                $(this).find('.linked-category-data').attr('title', 'Edit Inputs');

                                if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && $(this).hasClass('highlightExcelRow')) {
                                    $(this).find('.transactionDateDiv').addClass('disable-wrapper');
                                    $(this).find('.dayOfPeriodDiv').addClass('disable-wrapper');
                                    //$(document).find('tr.beginningBalance:not(.blurView), tr.endingBalance:not(.blurView), tr.totals:not(.blurView)').each(function () {
                                    //    $(this).find('span.accrualViewData').addClass('hide');
                                    //    $(this).find('span.editViewData').removeClass('hide');
                                    //})
                                }
                                //if (source != "growthRate")
                                //  $('div[class=action-items][class!=current]').hide();
                            });
                            //$parentTr.nextAll('tr.ViewMoreRows').first().addClass('hideyear');

                            if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True") {
                                $('#btnPercentage').addClass('hide');

                                //$(document).find('tr.beginningBalance:not(.blurView), tr.endingBalance:not(.blurView), tr.totals:not(.blurView)').each(function () {
                                //    $(this).find('span.accrualViewData').addClass('hide');
                                //    $(this).find('span.editViewData').removeClass('hide');
                                //})
                            }
                        }

                        $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {

                            if ($(this).find('[name="subcategoryVendordd"]').length > 0) {
                                initialSelectedVendorsArray.push($(this).find('.vendorLst .vendorDD [name="subcategoryVendordd"]').val())
                                $(this).find('[name="subcategoryVendordd"]')[0].sumo.unload();

                                if (showOptionsInVendorDropDown)
                                    $(this).find('[name="subcategoryVendordd"]').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                                else
                                    $(this).find('[name="subcategoryVendordd"]').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true });

                                if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                                    $(this).find('td.vendorLst .vendorDD .sumo_subcategoryVendordd').addClass('hidePerm');
                                }
                            }

                            $(this).find('[name="subCategoryCurrencyDD"]').SumoSelect({ searchText: true });

                            $(this).find('[name="subCategoryTermDD"]').SumoSelect({ searchText: true });

                            if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                                $(this).find('td.termLst .termDD .sumo_subCategoryTermDD').addClass('hidePerm');
                                $(this).find('td.currencyLst .currencyDD .sumo_subCategoryCurrencyDD').addClass('hidePerm');
                            }

                            if (($(this).hasClass('unapproved-sent') && RetailBudgetPro.Budget.isUserInApproveBudget == "True") || (RetailBudgetPro.Budget.isUserInApproveBudget == "False" && $(this).hasClass('delete-request'))) {
                                $(this).find('input[type="text"]').attr('readonly', 'readonly').addClass('lockedMonths');
                            }
                        });

                        if ($parentTr.nextUntil('.doNotExpand:not(.beginningBalance)').not('.historicaldata').has('[type=checkbox]:enabled').has('[type=text]:not(.lockedMonths)').length == 0) {
                            var level = $parentTr.data('level');
                            html = getNewRow($parentTr, parseInt(level) + 1);
                            var isFOA = $parentTr.find('#hdnIsFOA').val();
                            var finalHtml = $(html).insertBefore($($parentTr).nextUntil('.bottomLevel.historicaldata', '.bottomLevel').first());
                            finalHtml.removeClass('show-action-btns');
                            RetailBudgetPro.Budget.LockedMonthsCheck(finalHtml, isFOA);
                            RetailBudgetPro.Budget.ManageDataAndPerentage();
                            // In case all bottom lines deleted add this class to use as an identifier
                            finalHtml.addClass('newRowAfterDelAll');

                            if (catTypeRE == "E" || catTypeRE == "D") {
                                $(finalHtml).find('[name="subCategoryTermDD"] option[data-cattype="D"]').remove();
                            }
                            else if (catTypeRE == "R") {
                                $(finalHtml).find('[name="subCategoryTermDD"] option[data-cattype="C"]').remove();
                            }

                            $('.newRowAfterDelAll [name="subCategoryCurrencyDD"]').SumoSelect();

                            $('.newRowAfterDelAll [name="subCategoryTermDD"]').SumoSelect();

                            if (showOptionsInVendorDropDown)
                                $('.newRowAfterDelAll .drpdwnvendor').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                            else
                                $('.newRowAfterDelAll .drpdwnvendor').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true });

                            //For branch BD-1122
                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True") {
                            //    $(finalHtml).find('td .selectRowToDelete').addClass('disable-wrapper').attr('disabled', true);
                            //    $(finalHtml).find('td .isDescription').addClass('hideCol');
                            //    $(finalHtml).find('td.action-btn .bottomLevelCategoryComment, td.action-btn .documentUpload').addClass('hide');


                            //    if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                            //        $(finalHtml).find('td.amortizePeriodLst .amortize-period').addClass('hideCol');
                            //        $(finalHtml).find('td.amortizePeriodLst span').removeClass('hideCol');
                            //        $(finalHtml).find('.termLst .termDD').addClass('hide');
                            //        $(finalHtml).find('.termLst span').removeClass('hide');
                            //        $(finalHtml).find('td .dayOfPeriodDiv .dayOfPeriod').hide();
                            //        $(finalHtml).find('.dayOfPeriodDiv span').removeClass('hideCol').removeClass('hide').addClass('showCol');
                            //    }

                            //    if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                            //        $(finalHtml).find('.currencyLst .currencyDD').addClass('hide');
                            //        $(finalHtml).find('.currencyLst span').removeClass('hide');
                            //    }

                            //    $(finalHtml).find('.ven-list, .isVendor').addClass('hide');
                            //    $(finalHtml).find('.vendor').removeClass('hide');

                            //}

                            //}
                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True") {
                            //    $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {

                            //        $(this).find('[class*="DATValue"] input').removeClass('hideCol').addClass('showCol');
                            //        $(this).find('[class*="DATValue"] span').addClass('hideCol').removeClass('showCol');

                            //        if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                            //            $(this).find('td .dayOfPeriodDiv .dayOfPeriod, td .transactionDateDiv .transactionDate').hide();
                            //            $(this).find('.dayOfPeriodDiv span, .transactionDateDiv span').removeClass('hideCol').addClass('showCol');
                            //        }

                            //        $(this).find('.selectRowToDelete').attr("disabled", true);
                            //    });
                            //}

                        }

                        $('#DataInputTable tbody tr').removeClass('active-row').addClass('blurView').removeClass('highlight');

                        $parentTr.addClass('active-row').removeClass('blurView');

                        $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').removeClass('showCol').addClass('hideCol');
                        $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.detailed-view').hide();

                        $parentTr.nextUntil('.l' + $parentTr.attr('data-level')).addClass('highlight').removeClass('blurView');
                        if ($('#hdnUsePeriodReDistribution').val() == "True") $parentTr.parents('table').addClass('UsePeriodRedibution');

                        $parentTr.nextAll('tr').find('.accrualEditData-info-icon').addClass('hide');
                    }

                    else {
                        var confirmClick = function () {
                            $('.show .undo').trigger('click', $parentTr.attr('id'));
                        }

                        var cancelClick = function () {
                            var currentLevel = parseInt($('.inEditMode').attr('data-level'));

                            $('.inEditMode').addClass('redTopBorder').addClass('redBorderLeft').addClass('redBorderRight');
                            $('.inEditMode').nextUntil('[data-level=' + (currentLevel - 1) + '], [data-level=' + (currentLevel) + ']').not('.hideyear').addClass('redBorderLeft').addClass('redBorderRight');
                            $('.inEditMode').nextUntil('[data-level=' + (currentLevel - 1) + '], [data-level=' + (currentLevel) + ']').not('.hideyear').last().addClass('redBottomBorder');
                        }

                        custom_confirm(confirmClick, cancelClick, "Alert", "Another category is already in edit mode. Do you want to discard those changes and proceed with this edit operation?");
                    }
                }
            }
            else {
                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "This sub-category can not be edited without an approver assigned");
            }


            return false;

        },
        // Function used to present the original bottom level view 
        // Remove editable mode if it is in editable mode
        UndoCategorySaveData: function (e, id) {
            var confirmClick = function () {
                $('.current').removeClass('current');
                $parentTr = $(e.currentTarget).parents('tr');
                $parentTr.removeClass('inEditMode');
                $('.redTopBorder').removeClass('redTopBorder');
                $('.redBottomBorder').removeClass('redBottomBorder');
                $('.redBorderLeft').removeClass('redBorderLeft');
                $('.redBorderRight').removeClass('redBorderRight');
                $parentTr.find('input[type=text]').removeClass('hasError');
                $parentTr.find('.checkAllToDelete').addClass('hideCol').removeClass('showCol').prop('checked', false);
                RetailBudgetPro.Budget.growthRate = [];

                RemoveEditableMode($parentTr);

                var hdnIsUserInManageAdminPayrollRoleVal = $('#hdnIsUserInManageAdminPayrollRole').val();
                var hdnIsUserInManagePayrollRoleVal = $('#hdnIsUserInManagePayrollRole').val();
                var hdnUserInManageFormulaRoleVal = $('#hdnUserInManageFormulaRole').val()

                var i = 0;
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
                    $this = $(this)
                    $(this).find('td.hideComment').removeClass('hideComment').addClass('hasComment')
                    if ($this.hasClass('temp') && $this.find('.vendorLst .ven-list select[name="VendorUID"]').length > 0) {
                        $this.find('.vendorLst .ven-list [name="VendorUID"] option:selected').prop("selected", false);
                        $this.find('.vendorLst .ven-list select[name="VendorUID"]')[0].sumo.reload();
                    }

                    else if ($this.find('.vendorLst .vendorDD select[name="subcategoryVendordd"]').length > 0) {
                        if (!$this.find('.vendorLst .vendorDD [name="subcategoryVendordd"]').hasClass('lockedMonths')) {
                            var currValue = initialSelectedVendorsArray[i];                            
                            //$this.find('.vendorLst .vendorDD [name="subcategoryVendordd"] option:selected').prop("selected", false);

                            if (showOptionsInVendorDropDown) {
                                $this.find('.vendorLst .vendorDD [name="subcategoryVendordd"] option').remove();
                                if (currValue != null) {
                                    jQuery.each(currValue, function (j, val) {
                                        var $optHtml = $this.find('.vendorLst .vendorDD [name="subcategoryVendordd"] option').filter('[value=' + currValue[j] + ']');
                                        if ($optHtml.length == 0) {
                                            var optionHtml = $('[name="datapageVendordd"] option').filter('[value=' + currValue[j] + ']').prop('outerHTML');
                                            $this.find('.vendorLst .vendorDD [name="subcategoryVendordd"]').append(optionHtml);
                                        }
                                        $optHtml = $this.find('.vendorLst .vendorDD [name="subcategoryVendordd"] option').filter('[value=' + currValue[j] + ']');
                                        $optHtml.attr('selected', true);
                                    });
                                }
                            }
                            else {
                                $this.find('.vendorLst .vendorDD [name="subcategoryVendordd"] option:selected').prop("selected", false);
                                if (currValue != null) {
                                    jQuery.each(currValue, function (j, val) {
                                        $this.find('.vendorLst .vendorDD [name="subcategoryVendordd"] option').filter('[value=' + currValue[j] + ']').attr('selected', true)
                                    });
                                }
                            }
                            
                            $this.find('.vendorLst .vendorDD select[name="subcategoryVendordd"]')[0].sumo.reload();
                        }
                        i++;
                    }

                    var $hdnCatCalucaltedOn = $(this).find('#hdnCatCalucaltedOn').html();
                    var $hdnCatCalucaltedOn = $(this).find('#hdnCatCalucaltedOn').html();
                    var $hdnCatCalucaltedType = $(this).find('#hdnCatCalucaltedType').html();

                    if ($hdnCatCalucaltedOn != undefined && $hdnCatCalucaltedOn.trim() != "") {
                        var urlLink = $hdnCatCalucaltedType.trim() == "FOA" ? "/Formula/EditFormula/" + $hdnCatCalucaltedOn.trim() : $hdnCatCalucaltedType.trim() == "C2C" ? "/C2C/EditC2C/" + $hdnCatCalucaltedOn.trim() : $hdnCatCalucaltedType.trim() == "EP" ? "/EmployeePayroll/Edit/" + $hdnCatCalucaltedOn.trim() : $hdnCatCalucaltedType.trim() == "EFP" ? "/EmployeeFormula/Edit/" + $hdnCatCalucaltedOn.split('|')[1] : "/Rule/EditRule/" + $hdnCatCalucaltedOn.trim();
                        var formulaName = $(this).find('#hdnFormulaName').html().trim();

                        if ($(this).find('.edit-formula').length == 0) {
                            var htmlA = '';
                            var htmlFormulaLinkIcon = '';
                            var htmlInputIcon = '';
                            var payrollUIDList = $(this).find('#hdnPayrollUIDsNotInUser').text().split(",");

                            if (($hdnCatCalucaltedType.trim() == "EFP" || $hdnCatCalucaltedType.trim() == "EP") && (hdnIsUserInManageAdminPayrollRoleVal == "True" || hdnIsUserInManagePayrollRoleVal == "True")) {
                                if ($(this).find('.linked-category-data').length == 0) {
                                    if ($hdnCatCalucaltedType.trim() == "EP") {
                                        htmlFormulaLinkIcon = '<i class="fa fa-user"></i>';
                                        htmlInputIcon = '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $hdnCatCalucaltedType.trim() + '" data-formulaName="' + formulaName + '"></a>';

                                        if (jQuery.inArray($hdnCatCalucaltedOn.trim(), payrollUIDList) == -1) {
                                            htmlA += htmlInputIcon + '<a title="Edit Payroll" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>';
                                        }
                                        else {
                                            htmlA += htmlInputIcon;
                                        }

                                        $(this).find('td:first()').append(htmlA);
                                    }
                                    else {
                                        htmlFormulaLinkIcon = hdnIsUserInManageAdminPayrollRoleVal == "True" ? '<img src="/assets/admin/layout/img/fx-sign.png?v=1">' : '';
                                        htmlEmployeeIcon = $('#hdnShowEmployeeModule').val() == "True" ? ('<a title="Edit Employee" target="_blank" class="edit-employee" href="/Employee/Edit/' + $(this).find('#hdnEmployeeUID').html().trim() + '"><i class="fa fa-user"></i></a>') : "";
                                        htmlInputIcon = ($(this).find('#hdnEmpFormulaTypeFV').html().trim() == "F" || $(this).find('#hdnEmpFormulaTypeFV').html().trim() == "A") ? '' : '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $hdnCatCalucaltedType.trim() + '" data-formulaName="' + formulaName + '"></a>';
                                        htmlA += htmlInputIcon + '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' + htmlEmployeeIcon;
                                        $(this).find('td:first()').append(htmlA);
                                    }
                                }
                                else {
                                    htmlFormulaLinkIcon = $hdnCatCalucaltedType.trim() != "EP" && hdnIsUserInManageAdminPayrollRoleVal == "True" ? '<img src="/assets/admin/layout/img/fx-sign.png?v=1">' : '<i class="fa fa-user"></i>';
                                    htmlInputIcon = '';

                                    if ($hdnCatCalucaltedType.trim() == "EP") {
                                        htmlA += ((jQuery.inArray($hdnCatCalucaltedOn.trim(), payrollUIDList) > 0) ? '' : '<a title="Edit Payroll" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>');
                                    }
                                    else if (hdnUserInManageFormulaRoleVal == 'True' && $hdnCatCalucaltedType.trim() == "EFP") {
                                        htmlEmployeeIcon = $('#hdnShowEmployeeModule').val() == "True" ? ('<a title="Edit Employee" target="_blank" class="edit-employee" href="/Employee/Edit/' + $(this).find('#hdnEmployeeUID').html().trim() + '"><i class="fa fa-user"></i></a>') : "";

                                        htmlA += htmlInputIcon + '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' + htmlEmployeeIcon;
                                    }
                                    else {
                                        htmlA += '';
                                    }

                                    $(this).find('td:first()').append(htmlA);
                                }
                            }
                            else if ($hdnCatCalucaltedType.trim() != "EFP" && $hdnCatCalucaltedType.trim() != "EP" && $hdnCatCalucaltedType.trim() != "LC") {
                                if ($(this).find('.linked-category-data').length == 0 && $(this).find('#hdnIsFOAEliminationType').html() != "True" && $(this).find('#hdnC2COperator').html() != "E") {
                                    htmlA += '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $hdnCatCalucaltedType.trim() + '" data-formulaName="' + formulaName + '"></a>';
                                    htmlA += hdnUserInManageFormulaRoleVal == "True" ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' : '';
                                    $(this).find('td:first()').append(htmlA);
                                }
                                else {
                                    htmlFormulaLinkIcon = '<img src="/assets/admin/layout/img/fx-sign.png">';
                                    htmlA += hdnUserInManageFormulaRoleVal == 'True' ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' : '';
                                    $(this).find('td:first()').append(htmlA);
                                }
                            }
                            else if ($hdnCatCalucaltedType.trim() == "LC" && $(this).find('.linked-category-data').length == 0) {
                                htmlA += '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $hdnCatCalucaltedType.trim() + '" data-formulaName="LC"></a>';
                                $(this).find('td:first()').append(htmlA);
                            }
                        }
                    }
                    $(this).find('#hdnAttachedSubCategoryFolderName').html($(this).find('#hdnAttachedSubCategoryFolderName').data('attachedfolder'));

                    if ($(this).find('#hdnAttachedSubCategoryFolderName').data('attachedfolder') == undefined || $(this).find('#hdnAttachedSubCategoryFolderName').data('attachedfolder').trim() == "") {
                        $(this).find('.documentUpload i').removeClass('icon-red');
                        $(this).find('.documentUpload').removeClass('hasFile');

                        $(this).find('.downloadLinkedDocument i').removeClass('icon-red');
                        $(this).find('.downloadLinkedDocument').removeClass('hasFile');
                    }
                    else {
                        $(this).find('.documentUpload i').addClass('icon-red');
                        $(this).find('.documentUpload').addClass('hasFile');

                        $(this).find('.downloadLinkedDocument i').addClass('icon-red');
                        $(this).find('.downloadLinkedDocument').addClass('hasFile');
                    }

                    $(this).find('.linked-category-data').attr('title', 'View Inputs');

                    if ($(this).find('#hdnComment').text() == undefined || $(this).find('#hdnComment').text() == '') {
                        $(this).find('#hdnCurrentComment').text('');
                        $(this).find('.bottomLevelCategoryComment i').removeClass('hasComment');
                    }

                    $(this).find('.bottomLevelCategoryComment i').addClass("hide");
                    $(this).find('.bottomLevelCategoryComment i.hasComment').removeClass("hide");

                    //if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                    //    $(this).addClass('highlightExcelRow');
                    //    $(this).find('input[type=text]').addClass('highlightBckg');
                    //}
                });

                //$(document).find('tr.beginningBalance:not(.blurView), tr.endingBalance:not(.blurView), tr.totals:not(.blurView)').each(function () {
                //    $(this).find('span.accrualViewData').removeClass('hide');
                //    $(this).find('span.editViewData').addClass('hide');
                //})

                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').removeClass('highlightExcelRow');

                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('input[type=text]').removeClass('hasError');
                // Hide the copy values button on undo
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').find('.copyValues').hide();
                $parentTr.find('.sort-vendor').show();
                if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12)
                    $parentTr.find('.sort-date').show();
                $parentTr.find('.sort-description').show();
                $parentTr.find('.sort-total').show();
                // Used to avoid deleting the row we created after deleting all bottom lines
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.temp:not(.beginningBalance)').not('.newRowAfterDelAll').remove();
                $parentTr.nextAll('tr.ViewMoreRows').first().removeClass('hideyear').removeClass('blurView').addClass('highlight');
                //$($parentTr.nextAll('.newRowAfterDelAll')[0]).hide();

                var allDelRows = $.grep($parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)'), function (t, i) { return $(t).hasClass('newRowAfterDelAll'); })

                for (var cc = 0 ; cc < allDelRows.length; cc++) {
                    $(allDelRows[cc]).addClass('hide')
                }

                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.tempHideBottomLevel:not(.beginningBalance)').removeClass('tempHideBottomLevel');
                //if ($(document).find('#hdnUserInApproveBudget').val() == "True") {
                //    $parentTr.nextUntil('tr.doNotExpand').not('.historicaldata').find('.selectRowToDelete').addClass('hideCol').prop('checked', false);
                //    $parentTr.nextUntil('tr.doNotExpand','.unapproved-row').not('.historicaldata').find('.selectRowToDelete').removeClass('hideCol').addClass('showCol').prop('checked', false);
                //}
                //else {
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToDelete').addClass('hideCol').prop('checked', false);
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').removeClass('hideCol').addClass('showCol').prop('checked', false);
                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.detailed-view').show();

                if ($('[name="TransactionModeDropdown"]').val() == 'ACCRUAL') {
                    $parentTr.nextAll('tr').find('.accrualEditData-info-icon').removeClass('hide');
                }
                else {
                    $parentTr.nextAll('tr').find('.accrualEditData-info-icon').addClass('hide');
                }
                //}
                //$parentTr.nextUntil('tr.doNotExpand', '.bottomLevel.contracted').each(function () {
                //    $(this).find('#hdnComment').text($(this).find('#hdnComment').text().split('|')[0]);
                //});

                $('.commentModal .comment').val('');
                $('#static').find('.char-limit-msg').text('');
                $('[name=RowNumber]').val('');
                $('#ExcelFile').val('');

                FreezeDataInputTable()
            }

            var cancelClick = function () {
            }

            if (RetailBudgetPro.Budget.showAlertOnUndoChanges == 0) {
                RetailBudgetPro.Budget.showAlertOnUndoChanges = 1;
                confirmClick();
            }
            
            else if (e.originalEvent == undefined) {
                confirmClick();
                $('#DataInputTable').find('#' + id + ' .action-items .edit').trigger('click');
            }
            else {
                custom_confirm(confirmClick, cancelClick, "Confirm", "Any unsaved changes will be lost");
                return false;
            }
        },
        DownloadSubCatExcel: function (e) {
            $parentTr = $(e.target).parents('tr');

            var excelFolder = $parentTr.find('#hdnFromExcel').html().split('|')[0];

            window.location = '/Budget/DownloadSubCatExcelInfo/' + excelFolder;

            //$.ajax({
            //    url: '/Budget/GetSubCatExcelInfo',
            //    data: JSON.stringify({ id: plElementId }),
            //    type: 'post',
            //    dataType: 'json',
            //    contentType: 'application/json',
            //    success: function (result) {

            //    },
            //    error: function (er) {
            //        console.log(er);
            //    }
            //});
        },
        UploadSubCatExcel: function (e) {

            var fileInput = document.getElementById('ExcelFile');
            $currentTr = $('tr[id=' + $('.rowToLink').val() + ']');

            var formdata = new FormData();
            var fileInput = document.getElementById('ExcelFile');
            for (i = 0; i < fileInput.files.length; i++) {
                formdata.append(fileInput.files[i].name, fileInput.files[i]);
            }

            $('.layout').css('display', 'block');

            $.ajax({
                url: '/Budget/UploadSubCatExcel?rowNum=' + (parseInt($('[name=RowNumber]').val()) - 1) + '&numOfPeriods=' + parseInt( RetailBudgetPro.Budget.numberOfPeriodsVal),
                type: 'POST',
                data: formdata,
                contentType: false,
                processData: false,
                success: function (result) {

                    if (result.isMalicious) {
                        $('.layout').css('display', 'none');
                        custom_dialog("Ok", "", "Alert", result.errorMsg);
                    }
                    else {
                        var counterMax = 12;

                        var valueFlag = 0;

                        if (result.values == undefined) {
                            $('.layout').css('display', 'none');
                            custom_dialog("Ok", "", "Alert", "Please include a worksheet named 'Input' and ensure it is properly formatted as displayed in the download template.");
                        }

                        else {

                            counterMax = parseInt(RetailBudgetPro.Budget.numberOfPeriodsVal);

                            var ifValidExcel = true;

                            if (result.values.length == 0) {
                                $('.layout').css('display', 'none');
                                ifValidExcel = false;
                                custom_dialog("Ok", "", "Alert", "Please format the input worksheet as shown in the 'Budgyt-Excel Linking Template'.");
                            }

                            else if (result.isError) {
                                $('.layout').css('display', 'none');
                                ifValidExcel = false;
                                custom_dialog("Ok", "", "Alert", "Invalid " + $('#hdnVendorName').val() + " code(s)");
                            }


                            else {

                                //for (var co = 1; co <= counterMax; co++) {
                                //    if (result.values[co] == undefined || isNaN(parseInt(result.values[co].trim()))) {
                                //        valueFlag = 1;
                                //        break;
                                //    }
                                //}

                                //if (valueFlag == 1) {
                                //    $('.layout').css('display', 'none');
                                //    custom_dialog("Ok", "", "Alert", "Data in the excel sheet is invalid.");
                                //}

                                //else {
                                //var hasInserted = 0;
                                //$parentTr.nextUntil('.doNotExpand', '.bottomLevel').not('.historicaldata').has('[type=checkbox]').each(function () {
                                //if ($(this).find('#hdnCatCalucaltedOn').length == 0 || $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {

                                //hasInserted = 1;

                                //$currentTr.find('td:has(.isDescription) [type=text]').val(result.values[0]);
                                //$currentTr.find('td:has(.isDescription) .hideCol').text(result.values[0]);

                                var isCurrencyOn = RetailBudgetPro.Budget.isCurrencyOnForBudget == "True";
                                var isTurnOnBalanceSheetVal = RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True";
                                var isValidCurrency = true;
                                var isValidBalanceSheetData = true;

                                if (isCurrencyOn) {

                                    var currencyCode = result.values[3 + (isTurnOnBalanceSheetVal ? 3 : 0)].trim();
                                    var currencyID = $currentTr.find('[name="subCategoryCurrencyDD"] [data-code="' + currencyCode + '"]').val();

                                    if (currencyID == undefined) {
                                        isValidCurrency = false
                                        $('.layout').css('display', 'none');
                                        ifValidExcel = false;
                                        custom_dialog("Ok", "", "Alert", "Invalid currency code(s)");
                                    }

                                    if (isValidCurrency) {
                                        $currentTr.find('[name="subCategoryCurrencyDD"]').val(currencyID);
                                        $currentTr.find('[name="subCategoryCurrencyDD"]')[0].sumo.reload();
                                    }
                                }
                                if (isTurnOnBalanceSheetVal) {
                                    var transcationDate = result.values[3].trim().split(' ')[0];
                                    var termCode = result.values[4].trim();
                                    var amort = Number(result.values[5].trim());
                                    var termID = -1;


                                    //validate termCode
                                    if (termCode != null && termCode.trim() != "") {
                                        //termCode = result.values[3 + (isTurnOnBalanceSheetVal ? 3 : 0)].trim();
                                        termID = $currentTr.find('.termDD [name="subCategoryTermDD"] [data-Termcode="' + termCode + '"]').val();
                                        if (termID == undefined) {
                                            isValidBalanceSheetData = false
                                            custom_dialog("Ok", "", "Alert", "Invalid term code");
                                        }

                                        termId = termID = $currentTr.find('.termDD:not(.hide) [name="subCategoryTermDD"] [data-Termcode="' + termCode + '"]').val(); //hide is added to not allow terms to be tagged for credit type and depreiciation expense categories 
                                        if (termID == undefined) {
                                            isValidBalanceSheetData = false
                                            custom_dialog("Ok", "", "Alert", "Cannot add term to this category.");
                                        }
                                    }

                                    //validate amort
                                    if (!(amort >= 1)) {
                                        isValidBalanceSheetData = false;
                                        custom_dialog("Ok", "", "Alert", "Invalid amort");
                                    }

                                    var catId = $currentTr.find('td#hdnCatUID').text().trim();
                                    var catOption = $('[name=groupedcategory] option.clsCategory[value$="|' + catId + '"]');

                                    var isCapex = catOption.data('iscapex');
                                    var isBalanceSheet = catOption.data('isbalancesheet');
                                    var defaultAmortType = catOption.data('defaultamorttype');

                                    //Validate amort for non Capex categories
                                    if (isCapex == "False" && isBalanceSheet == "True" && amort > 1) {
                                        isValidBalanceSheetData = false;
                                        custom_dialog("Ok", "", "Alert", "Amort can not be greater than 1 for balance sheet categories except for Capex.");
                                    }

                                    //Validate import for Accumulated Depreciation Category
                                    if (defaultAmortType == "ACCUMULATED_DEPRECIATION") {
                                        isValidBalanceSheetData = false;
                                        custom_dialog("Ok", "", "Alert", "Data can not be imported in Accumulated Depreciation categories.");
                                    }

                                    //validate transaction date
                                    if (!moment(transcationDate, 'M/D/YYYY', true).isValid()) {
                                        isValidBalanceSheetData = false;
                                        custom_dialog("Ok", "", "Alert", "Invalid date");
                                    }
                                    else {
                                        var year = $('#hdnBudgetYear').val();
                                        if (!(year == moment(new Date(transcationDate)).format('Y'))) {
                                            isValidBalanceSheetData = false;
                                            custom_dialog("Ok", "", "Alert", "Transaction date must lie within the year");
                                        }
                                    }
                                }

                                if ((!isCurrencyOn || (isCurrencyOn && isValidCurrency)) && (!isTurnOnBalanceSheetVal || (isTurnOnBalanceSheetVal && isValidBalanceSheetData))) {

                                    $currentTr.find('.bottomLevelText.isDescription').val(result.values[0].trim());

                                    if ($('#ShowVendor').val() == "False")
                                        $currentTr.find('.bottomLevelText.isVendor').val(result.values[1].trim());
                                    else {
                                        $currentTr.find('.drpdwnvendor option').attr('selected', false);
                                        var vendorListOptions = '';
                                        result.lstVendor.forEach(function (item, index) {
                                            vendorListOptions += $('[name="datapageVendordd"] [value="' + item + '"]').prop('outerHTML');
                                        });
                                        $currentTr.find('.drpdwnvendor').append(vendorListOptions);
                                        $currentTr.find('.drpdwnvendor').val(result.lstVendor);
                                        $currentTr.find('.drpdwnvendor')[0].sumo.reload();
                                        
                                        var vendorSpanText = ""
                                        if (result.lstVendor.length > 3) {
                                            vendorSpanText = result.lstVendor.length + ' selected';
                                        }
                                        else {
                                            vendorSpanText = result.values[1].trim();
                                        }

                                        var $venList = $currentTr.find('td.vendorLst .ven-list');

                                        if ($venList.find('span.isVendor').length == 0) {
                                            $venList.append('<span class="isVendor" title="' + vendorSpanText + '">' + vendorSpanText + '</span>');
                                        }
                                        else {
                                            $venList.find('span.isVendor').attr('title', vendorSpanText).html(vendorSpanText);
                                        }
                                        $venList.find('.sumo_VendorUID').addClass('hidePerm');
                                        $venList.find('.sumo_subcategoryVendordd').addClass('hidePerm');
                                    }

                                    $currentTr.find('#hdnCurrentComment').html(result.values[2].trim())

                                    $currentTr.find('.bottomLevelCategoryComment i').addClass('hasComment');

                                    var isCurrencyOn = RetailBudgetPro.Budget.isCurrencyOnForBudget == "True";

                                    if (isCurrencyOn) {
                                        var currencyCode = result.values[3 + (isTurnOnBalanceSheetVal ? 3 : 0)].trim();
                                        var currencyID = $currentTr.find('[name="subCategoryCurrencyDD"] [data-code="' + currencyCode + '"]').val();
                                        $currentTr.find('[name="subCategoryCurrencyDD"]').val(currencyID);
                                        $currentTr.find('[name="subCategoryCurrencyDD"]')[0].sumo.reload();

                                        var $currencyList = $currentTr.find('td.currencyLst .currencyDD');

                                        if ($currencyList.find('span.selectedCurrencySpan').length == 0) {
                                            $currencyList.append('<span class="selectedCurrencySpan" title="' + currencyCode + '">' + currencyCode + '</span>');
                                        }
                                        else {
                                            $currencyList.find('span.selectedCurrencySpan').attr('title', currencyCode).html(currencyCode);
                                        }
                                        $currentTr.find('td.currencyLst .currencyDD .sumo_subCategoryCurrencyDD').addClass('hidePerm');
                                    }

                                    for (var co = 3 + (isCurrencyOn ? 1 : 0) + (isTurnOnBalanceSheetVal ? 3 : 0); co < counterMax + 3 + (isCurrencyOn ? 1 : 0) + (isTurnOnBalanceSheetVal ? 3 : 0); co++) {
                                        var valueToInsert = 0;
                                        if (result.values[co].trim() == "") valueToInsert = 0;
                                        else valueToInsert = parseFloat(result.values[co].trim()).toFixed(getDecimalPlaces($currentTr));

                                        $currentTr.find('.DATValueM' + (co - 2 - (isCurrencyOn ? 1 : 0) - (isTurnOnBalanceSheetVal ? 3 : 0)) + 'F [type=text]').val(valueToInsert);
                                        //$currentTr.find('.DATValueM' + co + 'F .hideCol').text(valueToInsert);
                                    }

                                    if (isTurnOnBalanceSheetVal) {
                                        var period = new Date(transcationDate).getMonth() + 1;

                                        if (amort > 1) {
                                            transcationDate = moment(new Date(transcationDate)).format("MM/DD/YYYY");
                                            $currentTr.find('a.transactionDate').attr('data-date', transcationDate);
                                            $currentTr.find('a.transactionDate').text(transcationDate);
                                            $currentTr.find('a.transactionDate').attr('data-currentvalue', transcationDate);
                                        }
                                        else {
                                            var month = moment(new Date(transcationDate)).format('D');
                                            $currentTr.find('a.dayOfPeriod').attr('data-day', month);
                                            $currentTr.find('a.dayOfPeriod').text(moment.localeData().ordinal(month));
                                        }

                                        $currentTr.find('[name="subCategoryTermDD"]').val(termID);
                                        $currentTr.find('[name="subCategoryTermDD"]')[0].sumo.reload();

                                        var $termList = $currentTr.find('td.termLst .termDD');

                                        if ($termList.find('span.selectedTermSpan').length == 0) {
                                            $termList.append('<span class="selectedTermSpan" title="' + result.values[4] + '">' + result.values[4] + '</span>');
                                        }
                                        else {
                                            $termList.find('span.selectedTermSpan').attr('title', result.values[4]).html(result.values[4]);
                                        }
                                        $currentTr.find('td.termLst .termDD .sumo_subCategoryTermDD').addClass('hidePerm');
                                        
                                        var $amort = $currentTr.find('td.amortizePeriodLst .amortize-period');

                                        $amort.val(amort);
                                        RetailBudgetPro.Budget.AmortizePeriodChange($amort, "UploadSubCatExcel");
                                    }

                                    $currentTr.find('input[type=text]:not(.sumo-search)').each(function () {
                                        if (!($(this).hasClass('isDescription') || $(this).parents('td').hasClass('vendorLst') || $(this).parents('td').hasClass('currencyLst'))) {
                                            $(this).attr('readonly', 'readonly').addClass('lockedMonths');
                                            $(this).removeClass('is-calculator');
                                            var cloneElement = $(this).clone();
                                            $(this).parents('td').prepend(cloneElement);
                                            $(this).remove();
                                        }

                                    });

                                    $currentTr.find('#hdnFromExcel').html(result.folderName);
                                    $currentTr.find('#hdnExcelRowNum').html($('[name=RowNumber]').val());
                                }
                                // }
                                //});

                                //var nd = new Date();

                                //$parentTr.nextUntil('.doNotExpand', '.bottomLevel').not('.historicaldata').each(function () {
                                //    if ($('#static').find('.comment').val().trim() != "") {
                                //        var textToAppend = $(this).find('#hdnComment').text() + "<br/><b>" + $('#hdnCurrentUser').val() + " " + (nd.getMonth() + 1) + "/" + nd.getDate() + "/" + nd.getFullYear() + "</b> : " + $('#static').find('.comment').val();

                                //        $(this).find('#hdnComment').text(textToAppend);
                                //    }
                                //});

                                //ComputeLevel($parentTr, "", result.folderName);
                                //$parentTr.find('.sort-vendor').show();
                                //RemoveEditableMode($parentTr);
                                //$parentTr.nextAll('.doNotExpand').find('.temp').removeClass('temp');

                                //$('.commentModal .comment').val('');

                                if (!isValidBalanceSheetData)
                                    ifValidExcel = false;

                                if (!$currentTr.hasClass('highlightExcelRow') && ifValidExcel) {
                                    $currentTr.find('.bottomLevelText.isDescription').attr('readonly', 'readonly');
                                    $currentTr.addClass('excel-linked-row');
                                }

                                $('.layout').css('display', 'none');
                            }
                        }
                    }
                },
                error: function (er) {
                    $('.layout').css('display', 'none');
                    console.log(er);
                }

            });
        },
        ShowUploadSubCatExcelPopup: function (e) {
            var $parentTr = $(e.target).parents('tr');

            $('.rowToLink').val($parentTr.attr('id'));
        },
        DownloadSubCatTemplate: function (e) {
            window.location = "/Budget/DownloadSubCatTemplate";
        },
        VendorFocusOut: function (e) {
            var keyCode = e.keyCode || e.which;

            if (keyCode == 9) {
                $(this).closest('td').next('td').find('[type=text]').focus();
                e.preventDefault();
            }
        },
        GetRowData: function (level, storeID, deptID, categoryID, groupedcategory, stores, filter, viewLevel, vendorIdCSV, bsMode, categoryType) {
            $.ajax({
                url: '/Budget/GetRowData',
                type: 'POST',
                async: true,
                dataType: 'html',
                data: "{ level:'" + level + "', StoreUID:'" + storeID + "', DeptUID:'" + deptID + "',CategoryUID:'" + categoryID + "', groupedcategory:'" + groupedcategory + "', Stores:'" + stores + "',CompNonCompfilter:'" + filter + "',viewLevel:'" + viewLevel + "',vendorIdCSV:'" + vendorIdCSV + "',showInGlobal:'" + ($('[name="ShowInGlobal"]').val() == "1") + "',bsMode:'" + bsMode + "',categoryType:'" + categoryType + "'}",
                contentType: "application/json; charset=UTF-8",
                success: function (data) {
                    $('#DataInputTable tbody').html('');
                    $('#DataInputTable tbody').html(data);

                    $(".hideyear").removeAttr("data-level");

                    $('#DataInputTable').find('.displayVendor').addClass('hide');
                    $('#DataInputTable').tabelize();
                    if (categoryType == "BS") $('#btnPercentage').addClass('hide');
                    else $('#btnPercentage').removeClass('hide');
                    RetailBudgetPro.Budget.ManageDataAndPerentage();
                    $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                    $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                    $('.hideyear').find('td:first').html('');
                    RetailBudgetPro.Budget.growthRate = [];
                    //$('.layout').css('display', 'none');
                    //$('.custom-data-table').show();
                },
                error: function (err) {
                    console.log(err);
                    $('.layout').css('display', 'none');
                }
            });

        },
        GetLinkedCategoryData: function (e) {
            var $target = $(e.target);//.parents('.linked-category-data');  

            $('.allocationSalaryCheck table .vendorLstDD').trigger('sumo:closed');

            if ($target.parents('tr').find('#hdnCatCalucaltedType').html() == "EP" || $target.parents('tr').find('#hdnCatCalucaltedType').html() == "EFP") {

                RetailBudgetPro.Budget.GetLinkedPayrollData($target);

                return false;
            }
            else if ($target.parents('tr').find('#hdnCatCalucaltedType').html() == "LC") {

                RetailBudgetPro.Budget.GetLinkedCategoryBSData($target);

                return false;
            }

            if ($($($target).attr('data-target')).html() == undefined) {

                $('.layout').show();

                var $currentTr = $($target).parents('tr');
                var $parentTr = $($target).parents('tr').prevAll('tr[data-level="' + (parseInt($($target).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');// $($target).parents('tr');
                var storeUID = $($parentTr).find('#hdnStoreUID').html().trim();
                var depUID = $($parentTr).find('#hdnDeptUID').html().trim();
                var catUID = $($parentTr).find('#hdnCatUID').html().trim();
                var formulaType = $($target).attr('data-formType');
                var stores = $('[name=lstStores]').val().join();
                var groupedCat = $('[name=groupedcategory]').val();
                var formulaId = parseInt($($target).parents('tr').find('#hdnCatCalucaltedOn').html());
                var vendorUIDCSV = $($target).parents('tr').find('#hdnVendorUIDCSV').html().trim();
                var plElementUID = $currentTr.find('#hdnCatCalucaltedType') == "LC" ? $currentTr.find('#hdnCatCalucaltedOn').html().trim() : $($target).parents('tr').find('#hdnPLElementUID').html().trim();
                var vendorCode = [];
                var storeDesc = $('[name=lstStores] [value="' + $currentTr.find('#hdnStoreUID').text().trim() + '"]').text();

                var inEditMode = $parentTr.hasClass('inEditMode');

                var categoryName = $($parentTr).find('td:eq(0) .label').html().trim();

                var cloneDropdownVendor = $('#vendordd').clone();
                $(cloneDropdownVendor).find('option:contains("Blank")[value=-1], :contains("Any")[value=-2]').remove();

                $(cloneDropdownVendor).find('option').prop('selected', false).removeAttrs('selected disabled');
                var vendorDD = $(cloneDropdownVendor).html();

                var currencyDD = $('#subCategoryCurrencyDD').html();

                var showVendorRow = $currentTr.find('.isVendor').text().trim();

                var hdnNumberOfPeriodsVal = RetailBudgetPro.Budget.numberOfPeriodsVal;
                var TurnOnBalanceSheetVal = RetailBudgetPro.Budget.turnOnBalanceSheetVal;

                var totalRow = '<h2>Total</h2><table class="table controller table-bordered budgets-table vendor non-editable total-summary-row no-border' + (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 ? " BalanceSheetOn" : "") + (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? " hasCurrencyOn" : "") + '">' +
                                            '<thead>' +
                                                '<tr>' +
                                                    '<th class="storeHead storeNameHead store-col hide">' + $('#hdnStoreName').val() + '</th>' +
                                                    '<th class="dechead">Description</th>' +
                                                    '<th>Year</th>' +
                                                    '<th class="venhead vend-breakword">' + $('#hdnVendorName').val() + '</th>' +
                                                    (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 ? '<th class="bs-column-width"></th><th class="bs-term-width"></th><th class="amort-col-width"></th>' : '') +
                                                    (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? '<th class="curheadTotal">Fx</th>' : '') +
                                                    '<th data-periodHead="P01">' + $('#period01Alias').val() + '</th>' +
                                                    '<th data-periodHead="P02">' + $('#period02Alias').val() + '</th>' +
                                                    '<th data-periodHead="P03">' + $('#period03Alias').val() + '</th>' +
                                                    '<th data-periodHead="P04">' + $('#period04Alias').val() + '</th>' +
                                                    '<th data-periodHead="P05">' + $('#period05Alias').val() + '</th>' +
                                                    '<th data-periodHead="P06">' + $('#period06Alias').val() + '</th>' +
                                                    '<th data-periodHead="P07">' + $('#period07Alias').val() + '</th>' +
                                                    '<th data-periodHead="P08">' + $('#period08Alias').val() + '</th>' +
                                                    '<th data-periodHead="P09">' + $('#period09Alias').val() + '</th>' +
                                                    '<th data-periodHead="P10">' + $('#period10Alias').val() + '</th>' +
                                                    '<th data-periodHead="P11">' + $('#period11Alias').val() + '</th>' +
                                                    '<th data-periodHead="P12">' + $('#period12Alias').val() + '</th>' +
                                                    (hdnNumberOfPeriodsVal == "13" ? '<th data-periodHead="P13">' + $('#period13Alias').val() + '</th>' : '') +
                                                    '<th>Total</th>' +
                                                    '<th class="action-temp hide">Actions</th>' +
                                                '</tr>' +
                                            '</thead>' +
                                            '<tbody>' +
                                                '<tr>' +
                                                    '<td class="storeNameHead store-col hide">' + storeDesc + '</td>' +
                                                    '<td>' +
                                                        '<input type="text" class="descriptionVal  readonlyTxt" value="' + $currentTr.find('.isDescription').val() + '" readonly="readonly">' +
                                                    '</td>' +
                                                    '<td class="year-row">' + $currentTr.find('.year').html() + '</td>';

                var $venDD = $('#vendordd');

                var vendorDivText = [];

                $.each(vendorUIDCSV.split(','), function (index, value) {
                    if (value != '') {
                        var $vOption = $venDD.find('option[value="' + value + '"]');
                        vendorCode[index] = $vOption.data("vencode");
                        vendorDivText.push($vOption.html());
                    }
                });

                var vendorSpan = vendorUIDCSV.split(",").length <= 3 ? vendorCode.join(',') : (vendorUIDCSV.split(",").length + " selected");

                if ($('#ShowVendor').val() == "True" && RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                    totalRow += '<td class="vendorLst currencyOn th-minWidth">' +
                        "<span class='vendor'> <a class='vendor-info-icon' role='button' data-toggle='popover' data-trigger='hover'>" + vendorSpan + "</a> </span>" +
                        "<div id='vendor-info' class='vendor-info-modal hide'>" +
                        "<ul>";

                    totalRow += '<li>' + vendorDivText.join('</li><li>') + '</li>';

                    totalRow += "</ul>" +
                                "</div>" +
                                    "<span class='vendorDD hide'>" +
                                        "<select class='form-control multiselectLst formulaVendorDD vendorLstDD' multiple='multiple' name='VendorUID'>" +
                                            vendorDD +
                                        "</select>" +
                                    "</span>" +
                                    "<input type='hidden' value='' class='hdnVendorID hideCol'>" +
                                '</td>';
                }
                else if ($('#ShowVendor').val() == "True") {
                    totalRow += '<td class="vendorLst th-minWidth">' +
                        "<span class='vendor'> <a class='vendor-info-icon' role='button' data-toggle='popover' data-trigger='hover'>" + vendorSpan + "</a> </span>" +
                        "<div id='vendor-info' class='vendor-info-modal hide'>" +
                        "<ul>";

                    totalRow += '<li>' + vendorDivText.join('</li><li>') + '</li>';

                    totalRow += "</ul>" +
                        "</div>" +
                        "<span class='vendorDD hide'>" +
                        "<select class='form-control multiselectLst formulaVendorDD vendorLstDD' multiple='multiple' name='VendorUID'>" +
                        vendorDD +
                        "</select>" +
                        "</span>" +
                        (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 ? "" : "<a href='#' class='copyValues visibilityClass' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
                        "<input type='hidden' value='' class='hdnVendorID hideCol'>" +
                        '</td>';
                }
                else {
                    totalRow += '<td class="vendorTd">' +
                        '<input type="text" class="vendorVal ven-desc readonlyTxt" value="' + $currentTr.find('.isVendor').val() + '" readonly="readonly">' +
                        '</td>';
                }
                if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                    totalRow += '<td></td><td class="bs-term-width"></td><td></td>';
                }
                if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                    totalRow += "<td class='currencyLstTotal showCurrencyInTitle'>" +
                        "    <span class='currency'>" + $currentTr.find('.currency').text().trim() + "</span>" +
                       
                        "         </td>";

                }
                   
                            '</td>'
                totalRow += '<td>' +
                            '<input type="text" class="DATVal P01Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM1F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P02Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM2F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P03Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM3F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P04Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM4F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P05Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM5F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P06Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM6F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P07Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM7F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P08Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM8F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P09Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM9F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P10Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM10F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P11Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM11F][type=text]').val() + '" readonly="readonly"></td>' +
                        '<td>' +
                            '<input type="text" class="DATVal P12Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM12F][type=text]').val() + '" readonly="readonly"></td>' +
                        (hdnNumberOfPeriodsVal == "13" ?
                        '<td>' +
                            '<input type="text" class="DATVal P13Val  readonlyTxt" value="' + $currentTr.find('[name=DATValueM13F][type=text]').val() + '" readonly="readonly"></td>' : '') +
                        '<td>' +
                            '<input type="text" class="rowTotal  readonlyTxt" value="' + $currentTr.find('.total').val() + '" readonly="readonly">' +
                        '</td>' +
                        '<td class="action-temp hide">' +
                            '<a href="javascript:void(0)" class="distributeTotalEvenly" title="Spread the Total amount evenly to all periods">=</a>' +
                            ($('#hdnUsePeriodReDistribution').val() == "True" ? "<a class='usePeriodRedistribution' title='Distribute by " + $('#hdnPeriodReDistributionValue').val() + "' data-value='" + $('#hdnPeriodReDistributionValue').val() + "'>" + $('#hdnPeriodReDistributionValue').val() + "</a>" : "") +
                            '<a class="delete-row"><i class="fa fa-trash-o"></i></a>' +
                        '</td>' +
                    '</tr>' +
                '</tbody>' +
            '</table>';
                $.ajax({
                    url: '/Budget/GetLinkedCategoryData',
                    data: JSON.stringify({ StoreUID: storeUID, DeptUID: depUID, CategoryUID: catUID, Stores: stores, groupedcategory: groupedCat, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: "DETAILS", FormulaType: formulaType, FormulaID: formulaId, VendorUIDCSV: vendorUIDCSV, PlElementUID: plElementUID, ShowInGlobal: ($('[name="ShowInGlobal"]').val() == "1")  }),
                    dataType: 'html',
                    type: 'post',
                    contentType: 'application/json',
                    success: function (result) {
                        var newID = 'formulaModal' + Math.floor(1000 + Math.random() * 9999);
                        $($target).attr('data-target', '#' + newID);
                        $('.page-content-wrapper').append(result);
                        $('.page-content-wrapper').find('#formulaModal').attr('id', newID);
                        $('#' + newID).find('.popup-formulatype').val(formulaType);
                        $('#' + newID).find('.popup-formulaId').val(formulaId);
                        $('#' + newID + ' .source-cat-title').html(categoryName + " " + formulaType + " - " + $($target).attr('data-formulaName'));
                        $('#' + newID).find('.lockedMonths').attr('readonly', 'readonly');

                        var textResult = '';

                        if ($('#' + newID).find('.popup-formulatype').val() == 'FOA') {
                            textResult = '\'' + $($target).attr('data-formulaName') + '\' formula is the result of adding the below categories together first, then ' + $('#' + newID).find('.popup-formulaTypeName').val().toLocaleLowerCase() + ' by the Grid Input Values at the bottom.';
                            $('#' + newID).find('.txtForFOA').html(textResult);
                        }
                        else if ($('#' + newID).find('.popup-formulatype').val() == 'C2C') {
                            if ($('#' + newID).find('.popup-formulaTypeName').val() == 'Counting') {
                                textResult = '\'' + $($target).attr('data-formulaName') + '\' formula is the result of Counting non-zero subcategory rows of below categories.';
                                $('#' + newID).find('.txtForFOA').html(textResult);
                            }
                            else if ($('#' + newID).find('.popup-formulaTypeName').val() == 'RunningTotal') {
                                textResult = '\'' + $($target).attr('data-formulaName') + '\' formula is the result of adding each prior period as a running total for the below categories.';
                                $('#' + newID).find('.txtForFOA').html(textResult);
                            }
                            else {
                                var phraseTxt = $('#' + newID).find('.popup-formulaTypeName').val() == 'adding' || 'multiplying' ? 'together' : 'from each other';
                                textResult = '\'' + $($target).attr('data-formulaName') + '\' formula is the result of ' + $('#' + newID).find('.popup-formulaTypeName').val().toLocaleLowerCase() + ' the below categories ' + phraseTxt + '.';
                                $('#' + newID).find('.txtForFOA').html(textResult);
                            }
                        }
                        else {
                            textResult = 'This formula is the result of ' + $('#' + newID).find('.FormulaTypeName').val() + ' the below categories';
                            $('#' + newID).find('.txtForFOA').html(textResult);
                        }

                        var removeStoreColumn = 0;

                        if ($('#' + newID).find('.storeHead').length == 0) removeStoreColumn = 1;

                        $('#' + newID).find('.formulamodal-wrap').append(totalRow);

                        var SelectedtVendorList = $currentTr.find('#hdnVendorUIDCSV').text().split(',');

                        $('#' + newID).find('.formulamodal-wrap').find('.formulaVendorDD option').each(function () {
                            if ($.inArray($(this).val(), SelectedtVendorList) != -1) {
                                $(this).attr('selected', 'selected');
                            }
                        });

                        if (removeStoreColumn == 1) $('#' + newID).find('.storeNameHead').remove();

                        $('.page-content-wrapper').append('<div class="hide ' + (newID + '-1') + '">' + $('#' + newID).html() + '</div>');

                        $(document).on('hidden.bs.modal', '#' + newID, function () {
                            $('#' + newID).html($('.' + newID + '-1').html());
                        });

                        $(document).on('shown.bs.modal', '#' + newID, function () {
                            RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                            FormulaPopDeletedPLElementUIDs = [];
                        });

                        $(document).on('show.bs.modal', '#' + newID, function () {
                            $(".vendor-info-icon").popover({
                                html: true,
                                content: function () {
                                    return $(this).parents('td').find('[id="vendor-info"]').html()
                                },
                                delay: { show: 50, hide: 100 }
                            });
                            $(this).find('.currencyFxRates tbody td .targetCurrency').html($currentTr.find('.currency').text().trim());

                            var $targetDiv = $('[data-target="#' + $(this).attr('id') + '"]')

                            var $parentRow = $($targetDiv).parents('tr').prevAll('tr[data-level="' + (parseInt($($targetDiv).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');

                            var inEditMode = $parentTr.hasClass('inEditMode');

                            if ($(this).find('.contains-multiple-stores').val() != undefined && $(this).find('.contains-multiple-stores').val().trim() == "True") {
                                $(this).find('.show-all-stores').removeClass('hide');
                                $(this).find('.hide-all-stores').addClass('hide');
                            }
                            else {
                                $(this).find('.show-all-stores').addClass('hide');
                                $(this).find('.hide-all-stores').addClass('hide');
                            }

                            $(this).find('tr.other-store').addClass('hide');
                            $(this).find('.store-col').addClass('hide');

                            //BD-1123|saurabh|adjusting the popover icon in the formula popup only
                            $(this).find('div.formulamodal-wrap table tr.noFormulaRow .accrualEditData-info-icon').each(function () {
                                $(this).appendTo($(this).parents('td'));
                            });

                            if (inEditMode) {
                                $(this).find('.add-new-line').removeClass('hide');
                                $(this).find('.save-category-data').removeClass('hide');
                                //$(this).find('.refresh-totals').removeClass('hide');
                                $(this).find('.copyPeriodValues').removeClass('hide');
                                $(this).find('.action-head').removeClass('hide');
                                $(this).find('.action-row').removeClass('hide');
                                $(this).find('.accrualEditData-info-icon').addClass('hide');

                                $(this).find('.noFormulaRow .descriptionVal').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.noFormulaRow .vendorVal').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.noFormulaRow .DATVal:not(.removeBackgndColor):not(.disableByTransaction)').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.noFormulaRow .rowTotal').removeAttr('readonly').removeClass('readonlyTxt');

                                if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                                    $(this).find('.noFormulaRow').each(function () {
                                        $(this).find('.DATVal').each(function () {
                                            $(this).val($(this).parents('td').find('span').attr('data-editvalue'));
                                        })

                                        $(this).find('.rowTotal').val($(this).find('.rowTotal').parents('td').find('span').attr('data-editvalue'));

                                        $(this).find('.amortizePeriodLst .amortize-period:not(.disableByTransaction)').removeAttr('readonly').removeClass('readonlyTxt');
                                        
                                        $td = $(this).find('td.dateLst');

                                        if ($td.hasClass('isTransactionDate')) {
                                            $td.find('.dayOfPeriodDiv').addClass('hide');
                                            $td.find('.transactionDateDiv').removeClass('hide');
                                        }
                                        else {
                                            $td.find('.dayOfPeriodDiv').removeClass('hide');
                                            $td.find('.transactionDateDiv').addClass('hide');
                                        }

                                        $(this).find('td.dateLst .openTransactionPopup').removeClass('hide');
                                        $(this).find('span.transactionSpan').addClass('hide');

                                    })
                                }

                                $(this).find('.selectAllStores').removeClass('hide');
                                $(this).find('.unselectAllStores').removeClass('hide');

                                //$(this).find('.formulamodal-sec.store-grid table thead th:eq(0)').removeClass('hide');
                                //$(this).find('.formulamodal-sec.store-grid table tbody tr.store-data-row td:eq(0)').removeClass('hide');
                                $(this).find('.formulamodal-sec.store-grid table').addClass('editable');
                                $(this).find('.formulamodal-sec.store-grid table tbody [type=text]:disabled').addClass('disabledTxt');
                                $(this).find('.formulamodal-sec.store-grid table tbody [type=text]:not(.removeBackgndColor)').removeAttr('readonly').removeClass('readonlyTxt').addClass('form-control');
                                //$(this).find('.formulamodal-sec.store-grid table thead tr').append('<th style=visibility:hidden;>Actions</th>');
                                //$(this).find('.formulamodal-sec.store-grid table tbody tr').append('<td style=visibility:hidden;> <a>=</a><a><i class="fa fa-trash-o"></i></a></td>');

                                //$(this).find('table.total-summary-row tbody td.vendorTd .ven-desc[type=text]').removeAttr('readonly').removeClass('readonlyTxt').addClass('form-control');

                                $(this).find('.noFormulaRow .DATVal').map(function () {
                                    var $parentTr = $(this).parents('tr');

                                    if ($parentTr.find('.hdnFromExcel').val() == "True") {
                                        $(this).attr('readonly', 'readonly').addClass('readonlyTxt highlightBckg');
                                        $parentTr.find('td input.rowTotal').addClass('highlightExcelRow');
                                        $parentTr.find('td input.rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt highlightBckg');
                                        $parentTr.find('td.action-row').html('');
                                        $parentTr.find('td input.amortize-period, td input.descriptionVal, td.vendorLst span.vendor').addClass('highlightBckg').attr('readonly', 'readonly');
                                        $parentTr.addClass('highlightExcelRow');
                                        $parentTr.find('td.showDateInTitle div.dayOfPeriodDiv, td.showDateInTitle div.transactionDateDiv').addClass('disable-wrapper');
                                        $parentTr.find('td input.descriptionVal, td.vendorTd .vendorVal').addClass('highlightBckg').attr('readonly', 'readonly');
                                    }
                                    else if ($parentTr.find('.hdnCATCalculatedType').val() != '') {
                                        $(this).attr('readonly', 'readonly').addClass('readonlyTxt');
                                        $parentTr.find('td input.rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                        $parentTr.find('td.action-row').html('');
                                        $parentTr.find('td input.amortize-period, td input.descriptionVal, td.vendorLst span.vendor').addClass('readonlyTxt').attr('readonly', 'readonly');
                                        $parentTr.find('td.showDateInTitle div.dayOfPeriodDiv, td.showDateInTitle div.transactionDateDiv').addClass('disable-wrapper');
                                        $parentTr.find('td input.descriptionVal, td.vendorTd .vendorVal, td input.vendorVal').attr('readonly', 'readonly');
                                    }
				                    //For branch BD-1122
                                    //else if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                                    //    $parentTr.find('td input.amortize-period, td input .descriptionVal, td .vendorLst span.vendor').addClass('readonlyTxt').attr('readonly', 'readonly');
                                    //    $parentTr.find('td.showDateInTitle div.dayOfPeriodDiv, td.showDateInTitle div.transactionDateDiv').addClass('disable-wrapper');
                                    //    $parentTr.find('td input.descriptionVal, td.vendorTd .vendorVal, td input.vendorVal').attr('readonly', 'readonly');
                                    //    $parentTr.find('.vendorLst .vendorDD').hide();
                                    //    $parentTr.find('td .delete-row, .vendorDesc .vendorVal, .ven-list, .isVendor').addClass('hide');
                                    //    $parentTr.find('.vendorDesc .vendorDescCSV, .vendor').removeClass('hide');
                                    //}
                                    else {
                                        $parentTr.find('.vendorDD').removeClass("hide");
                                        $parentTr.find('span.vendor').addClass("hide");
                                        
                                        $parentTr.find('td.currencyLst .currency').addClass('hide');
                                        $parentTr.find('td.currencyLst .currencyDD').removeClass('hide');

                                        var isDepreciationExpense = $parentTr.find('.hdnIsDepreciationExpense').val();

                                        if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                                            if (isDepreciationExpense == "False") {
                                                $parentTr.find('td.termLst .termSpan').addClass('hide');
                                                $parentTr.find('td.termLst .termDD').removeClass('hide');
                                            }
                                            else {
                                                $parentTr.find('td.termLst .termSpan').html('N/A');
                                            }
                                        }
                                    }
                                });

                                $(this).find('.formulamodal-sec input[type=text]:not(.sumo-search)').each(function () {
                                    if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('descriptionVal') && !$(this).hasClass('vendorVal')) {
                                        $(this).not('.highlightBckg').calculator({ customDecimalPlaces: $(this).attr('data-decimalplaces') });
                                    }
                                });

                                $(this).find('.action-temp').addClass('visibilityClass').removeClass('hide');

                                $(this).find('.GrowthRateDiv table tbody [type=text]').addClass('readonlyTxt');
                                $(this).find('.allocationSalaryDollarCheck table tbody [type=text]').addClass('readonlyTxt');
                                $(this).find('.showDollarAmount').removeClass('hide');
                                $(this).find('.RecalculateForParentEmp').removeClass('hide');

                                if ($(this).find('.popup-CalculateOn').val() == "3") {
                                    $(this).find('.total-summary-row .vendorDD').addClass("hide");
                                    $(this).find('.total-summary-row span.vendor').removeClass("hide");
                                }
                                
                                //remove edit mode of fte categories
                                var catFTEUID = $("[name='groupedcategory'] option.clsCategory[value*='-2|']").val().split('|')[1];

                                var $fteCatDiv = $(this).find('.formulamodal-sec').has('.popup-categoryID[value="' + catFTEUID + '"]');

                                if ($fteCatDiv.length > 0) {
                                    $fteCatDiv.find('.add-new-line').addClass('hide');
                                    $fteCatDiv.find('.vendor').removeClass('hide');
                                    $fteCatDiv.find('.vendorDD').addClass('hide');
                                    $fteCatDiv.find('.copyPeriodValues').addClass('hide');
                                    $fteCatDiv.find('.action-row').html('');
                                    $fteCatDiv.find('table tbody tr:not(.hidden-height0) td input[type="text"]').attr('readonly', 'readonly').addClass('readonlyTxt');;
                                }
                                //$(this).find('.SubCatRow').removeClass("hide");
                                //$(this).find('.show-all-data').addClass("hide");
                            }

                            else {

                                if ($('[name="TransactionModeDropdown"]').val() == 'ACCRUAL') {
                                    $(this).find('.accrualEditData-info-icon').removeClass('hide');
                                }
                                else {
                                    $(this).find('.accrualEditData-info-icon').addClass('hide');
                                }

                                $(this).find('.add-new-line').addClass('hide');
                                $(this).find('.save-category-data').addClass('hide');
                                //$(this).find('.refresh-totals').addClass('hide');
                                $(this).find('.action-head').addClass('hide');
                                $(this).find('.action-row').addClass('hide');
                                $(this).find('.copyPeriodValues').addClass('hide');

                                $(this).find('.noFormulaRow .descriptionVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.noFormulaRow .vendorVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.noFormulaRow .DATVal:not(.removeBackgndColor)').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.noFormulaRow .rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');

                                if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) {
                                    $(this).find('.noFormulaRow').each(function () {
                                        $(this).find('.DATVal').each(function () {
                                            $(this).val($(this).parents('td').find('span').attr('data-accrualvalue'));
                                        })

                                        $(this).find('.rowTotal').val($(this).find('.rowTotal').parents('td').find('span').attr('data-accrualvalue'));

                                        $(this).find('.amortizePeriodLst .amortize-period').attr('readonly', 'readonly').addClass('readonlyTxt');
                                        $(this).find('td.termLst .termSpan').removeClass('hide');
                                        $(this).find('td.termLst .termDD').addClass('hide');

                                        $td = $(this).find('td.dateLst');

                                        if ($td.hasClass('isTransactionDate')) {
                                            $td.find('.dayOfPeriodDiv').addClass('hide');
                                            $td.find('.transactionDateDiv').removeClass('hide');
                                        }
                                        else {
                                            $td.find('.dayOfPeriodDiv').removeClass('hide');
                                            $td.find('.transactionDateDiv').addClass('hide');
                                        }

                                        $(this).find('td.dateLst .openTransactionPopup').addClass('hide');
                                        $(this).find('span.transactionSpan').removeClass('hide');

                                        //if ($(this).find('td.termLst [name="subCategoryTermDD"]').length > 0) {
                                        //    $(this).find('td.termLst [name="subCategoryTermDD"]').val($(this).find('td.termLst .termSpan').attr('data-termuid'))
                                        //    $(this).find('td.termLst [name="subCategoryTermDD"]')[0].sumo.reload();
                                        //}

                                        //$td.find('.dayOfPeriod').attr('data-day', $td.find('.dayOfPeriodDiv .transactionSpan').attr('data-value'));
                                        //$td.find('.dayOfPeriod').text(moment.localeData().ordinal($td.find('.dayOfPeriodDiv .transactionSpan').attr('data-value')));

                                        //$td.find('.transactionDate').attr('data-date', $td.find('.transactionDateDiv .transactionSpan').attr('data-value'));
                                        //$td.find('.transactionDate').attr('data-currentvalue', $td.find('.transactionDateDiv .transactionSpan').attr('data-value'));
                                        //$td.find('.transactionDate').text($td.find('.transactionDateDiv .transactionSpan').attr('data-value'));

                                        //RetailBudgetPro.Budget.AmortizePeriodChange($(this).find('td.amortizePeriodLst .amortize-period'));

                                    })
                                }

                                $(this).find('.selectAllStores').addClass('hide');
                                $(this).find('.unselectAllStores').addClass('hide');

                                $(this).find('.formulamodal-sec.store-grid table').removeClass('editable');
                                $(this).find('.formulamodal-sec.store-grid table tbody [type=text]:disabled').addClass('disabledTxt');
                                //$(this).find('.formulamodal-sec.store-grid table thead th:eq(0)').addClass('hide');
                                //$(this).find('.formulamodal-sec.store-grid table tbody tr.store-data-row').find('td:eq(0)').addClass('hide');
                                $(this).find('.formulamodal-sec.store-grid table tbody [type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');

                                $(this).find('table.total-summary-row tbody td.vendorTd .ven-desc[type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');

                                $(this).find('.action-temp').removeClass('visibilityClass').addClass('hide');

                                $(this).find('.GrowthRateDiv table tbody [type=text]').addClass('readonlyTxt');
                                $(this).find('.allocationSalaryDollarCheck table tbody [type=text]').addClass('readonlyTxt');
                                $(this).find('.showDollarAmount').addClass('hide');
                                $(this).find('.RecalculateForParentEmp').addClass('hide');

                                $(this).find('.vendorDD ').addClass("hide");
                                $(this).find('span.vendor').removeClass("hide");

                                $(this).find('td.currencyLst .currency').removeClass('hide');
                                $(this).find('td.currencyLst .currencyDD').addClass('hide');

                                //$(this).find('.SubCatRow').addClass("hide");
                                //$(this).find('.show-all-data').removeClass("hide");
                            }

                            //Disable inactive or locked periods
                            var period = 0;
                            var periodCount = Number(hdnNumberOfPeriodsVal);
                            
                            if ($('#' + newID).find('.popup-formulatype').val() == 'C2C' || $('#' + newID).find('.popup-formulatype').val() == 'Rule') {

                                var $dataRowGrids = $(this).find('.formulamodal-sec table tbody');
                                var $dataHeadRowGrids = $(this).find('.formulamodal-sec table thead');
                                var $totalSummaryRow = $(this).find('.total-summary-row');

                                for (var x = 1; x <= periodCount; x++) {
                                    period = ("0" + x).slice(-2);

                                    if ($('#LockedP' + period).val() == 'Y') {
                                        $dataRowGrids.find(('.DATVal.P' + period + 'Val:not(.hidden-height0)')).removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true);
                                        $dataHeadRowGrids.find('[data-periodHead="P' + period + '"]').append("<i class='fa fa-lock'></i>");

                                        $totalSummaryRow.find('[data-periodHead="P' + period + '"]').append("<i class='fa fa-lock'></i>");
                                        $totalSummaryRow.find('tbody .DATVal.P' + period + 'Val').addClass('removeBackgndColor');
                                    }
                                    else if ($('#BUDInactiveM' + period).val() == 'Y') {
                                        $totalSummaryRow.find('thead [data-periodHead="P' + period + '"]').append("<i class='fa fa-minus-circle'></i>").attr('title', 'Deactivated Period makes the Formula Inactive');
                                        $totalSummaryRow.find('tbody .DATVal.P' + period + 'Val').addClass('removeBackgndColor');
                                    }
                                }
                            }
                            else if ($('#' + newID).find('.popup-formulatype').val() == 'FOA') {

                                var $dataRowGrid = $(this).find('table.gridValueInput');
                                var $formulaModalRows = $(this).find('.formulamodal-sec .data-rows');
                                var $totalSummaryRow = $(this).find('.total-summary-row');

                                for (var x = 1; x <= periodCount; x++) {
                                    period = ("0" + x).slice(-2);

                                    if ($('#LockedP' + period).val() == 'Y') {
                                        $dataRowGrid.find(('[data-Period="P' + period + '"]')).removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true);
                                        $dataRowGrid.find('[data-periodHead="P' + period + '"]').append("<i class='fa fa-lock'></i>");

                                        $formulaModalRows.find(('.DATVal.P' + period + 'Val:not(.hidden-height0)')).removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true);
                                        $formulaModalRows.find('[data-periodHead="P' + period + '"]').append("<i class='fa fa-lock'></i>");

                                        $totalSummaryRow.find('[data-periodHead="P' + period + '"]').append("<i class='fa fa-lock'></i>");
                                        $totalSummaryRow.find('tbody .DATVal.P' + period + 'Val').addClass('removeBackgndColor');
                                    }
                                    else if ($('#BUDInactiveM' + period).val() == 'Y') {
                                        $totalSummaryRow.find('thead [data-periodHead="P' + period + '"]').append("<i class='fa fa-minus-circle'></i>").attr('title', 'Deactivated Period makes the Formula Inactive');
                                        $totalSummaryRow.find('tbody .DATVal.P' + period + 'Val').addClass('removeBackgndColor');

                                        $dataRowGrid.find('thead [data-periodHead="P' + period + '"]').append("<i class='fa fa-minus-circle'></i>").attr('title', 'Deactivated Period makes the Formula Inactive');
                                        $dataRowGrid.find('tbody [data-Period="P' + period + '"]').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true);
                                    }
                                }
                            }

                            $('#' + newID).find('[data-toggle="popover"]').popover({
                                html: true,
                                content: function () {
                                    return $('.popover-content').html();
                                },
                                delay: { show: 50, hide: 100 }
                            });

                            $('#' + newID).find('[data-toggle="popover"]:not(".vendor-info-icon"):not(".modifiedByUser-info-icon"):not(".accrualEditData-info-icon")').on('show.bs.popover', function () {

                                var $this = $(this);

                                if ($(this).hasClass('title-formula')) {

                                    var $parentRow = $(this).parents('.formulamodal-wrap');

                                    var isDataLoaded = $parentRow.find('.popover-content-data:eq(0)').html().trim() != "";

                                    var isTargetCategory = true, categoryUID = -1;

                                    var formulaTypeCSV = '', formulaIDCSV = '';

                                    if (isTargetCategory) {
                                        formulaTypeCSV = $parentRow.find('.popup-formulatype').val();
                                        formulaIDCSV = $parentRow.find('.popup-formulaId').val();
                                    }

                                    if (!isDataLoaded) {
                                        var popoverObject = $(this).data('bs.popover');

                                        $.ajax({
                                            url: '/Budget/GetRelatedCategoryHoverText',
                                            data: JSON.stringify({ IsTargetCategory: isTargetCategory, FormulaTypeCSV: formulaTypeCSV, FormulaIDCSV: formulaIDCSV, CategoryUID: categoryUID }),
                                            dataType: 'html',
                                            type: 'post',
                                            contentType: 'application/json',
                                            success: function (result) {
                                                var newResultSet = $(result).clone().find('.bckgYellow').removeClass('bckgYellow').end().prop('outerHTML');
                                                //console.log(result);
                                                popoverObject.tip().find('.popover-content').empty().append(newResultSet);
                                                popoverObject.options.content = newResultSet;//"<div class='content-table'>asdasd</div>";
                                                $parentRow.find('.popover-content-data:eq(0)').html(newResultSet);
                                                $this.popover('show');
                                            },
                                            error: function (er) {
                                                console.log(er);
                                            }
                                        });

                                    }
                                    else {
                                        var popoverObject = $(this).data('bs.popover');
                                        popoverObject.tip().find('.popover-content').empty().append($parentRow.find('.popover-content-data:eq(0)').html());
                                        popoverObject.options.content = $parentRow.find('.popover-content-data:eq(0)').html();
                                    }
                                }

                                else {
                                    var $parentRow = $(this).parents('.formulamodal-sec');

                                    var $formalModal = $(this).parents('.formulamodal-wrap');

                                    var isDataLoaded = $parentRow.find('.popover-content-data').html().trim() != "";

                                    var isTargetCategory = $parentRow.find('.popup-cat-formulaType').val().trim() != "", categoryUID = -1;

                                    var formulaTypeCSV = '', formulaIDCSV = '';

                                    if (isTargetCategory) {
                                        formulaTypeCSV = $parentRow.find('.popup-cat-formulaType').val();
                                        formulaIDCSV = $parentRow.find('.popup-cat-formulaID').val();
                                    }
                                    else {
                                        var tempformType = [], tempformId = [];

                                        tempformType.push($formalModal.find('.popup-formulatype').val());
                                        tempformId.push($formalModal.find('.popup-formulaId').val());

                                        $formalModal.find('.formulamodal-sec:not(.store-grid)').each(function () {
                                            if ($(this).find('.popup-cat-formulaType').val() != "") {
                                                tempformType.push($(this).find('.popup-cat-formulaType').val());
                                                tempformId.push($(this).find('.popup-cat-formulaID').val());
                                            }
                                        });
                                        formulaTypeCSV = tempformType.toString();
                                        formulaIDCSV = tempformId.toString();
                                        categoryUID = $parentRow.find('.popup-categoryID').val();
                                    }

                                    if (!isDataLoaded) {
                                        var popoverObject = $(this).data('bs.popover');

                                        $.ajax({
                                            url: '/Budget/GetRelatedCategoryHoverText',
                                            data: JSON.stringify({ IsTargetCategory: isTargetCategory, FormulaTypeCSV: formulaTypeCSV, FormulaIDCSV: formulaIDCSV, CategoryUID: categoryUID }),
                                            dataType: 'html',
                                            type: 'post',
                                            contentType: 'application/json',
                                            success: function (result) {
                                                popoverObject.tip().find('.popover-content').empty().append(result);
                                                popoverObject.options.content = result;//"<div class='content-table'>asdasd</div>";
                                                $parentRow.find('.popover-content-data').html(result);
                                                $this.popover('show');
                                            },
                                            error: function (er) {
                                                console.log(er);
                                            }
                                        });

                                    }
                                }
                            })

                            $('#' + newID).find('[data-toggle="popover"]').on('shown.bs.popover', function () {

                                $('.scroller.popover-cat-lst').slimScroll({
                                    height: 'auto',
                                    color: '#bbbbbb'
                                });

                                $(".slimScrollBar,.slimScrollRail").remove();
                                $(".slimScrollDiv").contents().unwrap();

                                $('.scroller.popover-cat-lst').slimScroll({
                                    height: 'auto',
                                    color: '#bbbbbb'
                                });

                            });

                        });
                        $('#' + newID).find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                        $('#' + newID).find('[name="subCategoryCurrencyDD"]').SumoSelect();
                        $('#' + newID).find('[name="subCategoryTermDD"]').SumoSelect();

                        var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                        var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                        var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                        var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                        var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                        var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                        var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                        var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                        var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                        var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                        var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                        var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();
                        var STCCompM13 = $currentTr.find('#STCCompM13').eq(0).text();

                        if (STCCompM1 == "N")
                            $('#' + newID).find('input.P01Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM2 == "N")
                            $('#' + newID).find('input.P02Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM3 == "N")
                            $('#' + newID).find('input.P03Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM4 == "N")
                            $('#' + newID).find('input.P04Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM5 == "N")
                            $('#' + newID).find('input.P05Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM6 == "N")
                            $('#' + newID).find('input.P06Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM7 == "N")
                            $('#' + newID).find('input.P07Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM8 == "N")
                            $('#' + newID).find('input.P08Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM9 == "N")
                            $('#' + newID).find('input.P09Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM10 == "N")
                            $('#' + newID).find('input.P10Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM11 == "N")
                            $('#' + newID).find('input.P11Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM12 == "N")
                            $('#' + newID).find('input.P12Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM13 == "N")
                            $('#' + newID).find('input.P13Val').attr('readonly', 'readonly').addClass('removeBackgndColor');

                        $('.layout').hide();

                        $('#' + newID).modal('show');
                    },
                    error: function (er) {
                        console.log(er);
                    }
                });
            }
            else {
                var $currentTr = $($target).parents('tr');
                var newID = $($target).attr('data-target');

                var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();
                var STCCompM13 = $currentTr.find('#STCCompM13').eq(0).text();

                if (STCCompM1 == "N")
                    $(newID).find('input.P01Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM2 == "N")
                    $(newID).find('input.P02Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM3 == "N")
                    $(newID).find('input.P03Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM4 == "N")
                    $(newID).find('input.P04Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM5 == "N")
                    $(newID).find('input.P05Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM6 == "N")
                    $(newID).find('input.P06Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM7 == "N")
                    $(newID).find('input.P07Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM8 == "N")
                    $(newID).find('input.P08Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM9 == "N")
                    $(newID).find('input.P09Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM10 == "N")
                    $(newID).find('input.P10Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM11 == "N")
                    $(newID).find('input.P11Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM12 == "N")
                    $(newID).find('input.P12Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM13 == "N")
                    $(newID).find('input.P13Val').attr('readonly', 'readonly').addClass('removeBackgndColor');

                $($($target).attr('data-target')).find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                $($($target).attr('data-target')).find('[name="subCategoryCurrencyDD"]').SumoSelect();
                $($($target).attr('data-target')).find('[name="subCategoryTermDD"]').SumoSelect();
            } 
            //else {

            //    var $parentTr = $($target).parents('tr').prevAll('tr[data-level="' + (parseInt($($target).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');
            //    var inEditMode = $parentTr.hasClass('inEditMode');

            //    var newID = $target.attr('data-target');

            //    if (inEditMode) {
            //        $(newID).find('.add-new-line').removeClass('hide');
            //        $(newID).find('.save-category-data').removeClass('hide');                    
            //        $(newID).find('.copyPeriodValues').removeClass('hide');
            //        $(newID).find('.action-head').removeClass('hide');
            //        $(newID).find('.action-row').removeClass('hide');

            //        $(newID).find('.descriptionVal').removeAttr('readonly').removeClass('readonlyTxt');
            //        $(newID).find('.vendorVal').removeAttr('readonly').removeClass('readonlyTxt');
            //        $(newID).find('.DATVal').removeAttr('readonly').removeClass('readonlyTxt');
            //        $(newID).find('.rowTotal').removeAttr('readonly').removeClass('readonlyTxt');

            //        $(newID).find('.singleFixedValue').remove();
            //        $(newID).find('#DivDistributetoAll').remove();
            //        $(newID).find('#divPercentDistributionCategory').remove();

            //        $(newID).find('.selectAllCheckGrowByPercent').removeClass('hide');
            //        $(newID).find('.unselectAllCheckGrowByPercent').removeClass('hide');
            //        $(newID).find('.formulamodal-sec.store-grid table thead th:eq(0)').removeClass('hide');
            //        $(newID).find('.formulamodal-sec.store-grid table tbody tr.store-data-row td:eq(0)').removeClass('hide');
            //        $(newID).find('.formulamodal-sec.store-grid table tbody [type=text]').removeAttr('readonly').removeClass('readonlyTxt').addClass('form-control');
            //    }

            //    else {
            //        $(newID).find('.add-new-line').addClass('hide');
            //        $(newID).find('.save-category-data').addClass('hide');                    
            //        $(newID).find('.copyPeriodValues').addClass('hide');
            //        $(newID).find('.action-head').addClass('hide');
            //        $(newID).find('.action-row').addClass('hide');

            //        $(newID).find('.descriptionVal').attr('readonly', 'readonly').addClass('readonlyTxt');
            //        $(newID).find('.vendorVal').attr('readonly', 'readonly').addClass('readonlyTxt');
            //        $(newID).find('.DATVal').attr('readonly', 'readonly').addClass('readonlyTxt');
            //        $(newID).find('.rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');

            //        $(newID).find('.singleFixedValue').remove();
            //        $(newID).find('#DivDistributetoAll').remove();
            //        $(newID).find('#divPercentDistributionCategory').remove();

            //        $(newID).find('.selectAllCheckGrowByPercent').addClass('hide');
            //        $(newID).find('.unselectAllCheckGrowByPercent').addClass('hide');
            //        $(newID).find('.formulamodal-sec.store-grid table thead th:eq(0)').addClass('hide');
            //        $(newID).find('.formulamodal-sec.store-grid table tbody tr.store-data-row').find('td:eq(0)').addClass('hide');
            //        $(newID).find('.formulamodal-sec.store-grid table tbody [type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');
            //    }
            //}
        },

        GetModalForSingleStoreDataPaste: function (e) {

            $('.layout').show();

            var $target = $(e.target);

            var CategoryUID = $target.parents('tr').find('#hdnCatUID').html();
            var StoreUID = $target.parents('tr').find('#hdnStoreUID').html();

            var $modal = $('#CopyPasteToSingleStoreModal');

            $modal.find('[name="hdnDepartmentUID"]').val($target.parents('tr').find('#hdnDeptUID').html());

            if (CategoryUID != $modal.find('[name="hdnCategoryUID"]').val()) {

                $modal.find('[name="hdnCategoryUID"]').val(CategoryUID);
                $modal.find('.category-desc').html($target.parents('tr').find('.label').html().trim())
            }
            if (StoreUID != $modal.find('[name="hdnStoreUID"]').val()) {

                $modal.find('[name="hdnStoreUID"]').val(StoreUID);

                var $Option = $('[name="lstStores"]').find('option[value="' + StoreUID + '"]');

                $modal.find('[name="hdnCurrencyUID"]').val($Option.attr('data-currencyid'));
                $modal.find('[name="hdnCurrencyCode"]').val($Option.attr('data-currencycode'));
                $modal.find('.store-heading').html($Option.html().trim());
            }

            $modal.modal('show');

            $('.layout').hide();
        },

        GetModalForMultipleStoreDataPaste: function (e) {

            if ($('[name="lstStores"]').val() == null) {
                custom_dialog("Ok", "", "Alert", "Please select at least one " + $('#hdnStoreName').val() + ".");
            }
            else {

                $('.layout').show();

                var $selectedCategory = $('[name="groupedcategory"] option:selected');

                var CategoryUID = $selectedCategory.val().split('|')[1];

                var isfinancialcat = $selectedCategory.data('isfinancialcat') == "True";

                var isbalancesheetcat = $selectedCategory.data('isbalancesheet') == "True";

                var showBalanceSheetColumns = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && (isfinancialcat == true || isbalancesheetcat == true)) ? "True" : "False";

                var $modal = showBalanceSheetColumns == "True" ? $('#CopyPasteToMultipleStoresModalBS') : $('#CopyPasteToMultipleStoresModal');
                
                //$modal.find('[name="hdnDepartmentUID"]').val($target.parents('tr').find('#hdnDeptUID').html());

                if (CategoryUID != $modal.find('[name="hdnCategoryUID"]').val()) {

                    $modal.find('[name="hdnCategoryUID"]').val(CategoryUID);

                    $modal.find('.category-desc').html($selectedCategory.html().trim())

                    StoreUIDListForCategory = [];

                    $.ajax({
                        url: '/Budget/GetCategoryStoreList',
                        type: 'POST',
                        dataType: 'json',
                        async: false,
                        contentType: "application/json; charset=UTF-8",
                        data: JSON.stringify({ CategoryUID: CategoryUID }),
                        success: function (data) {
                            StoreUIDListForCategory = data.list;
                        }
                    });
                }

                $('[name="lstStores"]').find('option:selected').each(function () {

                    if (jQuery.inArray(parseInt($(this).val()), StoreUIDListForCategory) != -1) {

                        RetailBudgetPro.Budget.AddNewLineToDataCopyModal($modal, $(this).val(), $(this).attr('data-currencyid'), (isfinancialcat ? $(this).attr('data-currencycode') : ""), $(this).html().trim(), showBalanceSheetColumns);
                    }
                })

                $modal.find('[type=text]:not(.sumo-search)').each(function () {
                    if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('descriptionVal') && !$(this).hasClass('vendorVal') && !$(this).hasClass('store-desc')) {
                        $(this).calculator();
                    }
                });

                $modal.modal('show');

                $('.layout').hide();
            }
        },

        AddNewLineToDataCopyModal: function ($modal, storeUID, currencyUID, currencyCode, storeDesc, showBalanceSheetColumns) {

            var storeCompDataList = JSON.parse($('#hdnStoreCompDataList').val()).filter(function (v) {
                return v.Year == $('select.tbudgetYearDropDown').find('option:selected').val();
            })[0];
            
            var html = '';
            var periods = RetailBudgetPro.Budget.numberOfPeriodsVal;
            var turnOnStorePeriods = $('#hdnTurnOnStorePeriods').val() == "True";

            html = '<tr class="copiedRow">' +
                '<input type="hidden" class="storeUID" value="' + storeUID + '">' +
                '<input type="hidden" class="currencyUID" value="' + currencyUID + '">' +
                ($modal.attr('id') == 'CopyPasteToSingleStoreModal' ? '' : '<td class="store-desc"><span>' + storeDesc + '</span><a href="javascript:void(0);" class="pasteToSameRow" title="Paste sub-category row in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a></td>') +
                '<td><input class="descriptionVal" type="text" value=""></td>'

            if ($('#ShowVendor').val() == "True") {
                html += "<td class='vendorLst " + (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" || showBalanceSheetColumns == "True" ? "full-width" : "") + "' style='position: relative;background-clip: padding-box !important;'>" +
                    "<span class='vendorDD'>" +
                    "<select class='form-control multiselectLst vendorLstDD SumoUnder' multiple='multiple' name='VendorUID'>" +
                    "</select></span>" +
                    (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" || showBalanceSheetColumns == "True" ? "" : "<a href='javascript:void(0)' class='copyPeriodValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
                    "</td>";
            }
            else {
                html += '<td class=vendorTd>' +
                    '<input class="vendorVal ' + (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" || showBalanceSheetColumns == "True" ? "full-width" : "") + '" type="text" value="">' +
                    (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" || showBalanceSheetColumns == "True" ? '' : '<a href="javascript:void(0)" class="copyPeriodValues" title="Copy first active period values to all periods"><i class="fa fa-sort-up"></i></a>') +
                    '</td>';
            }

            if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                html += "<td class='currencyTd readonlyTxt' readonly>" + currencyCode + (showBalanceSheetColumns == "True" ? "" : "<a href='javascript:void(0)' class='copyPeriodValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") + "</td>";
            }

            if (showBalanceSheetColumns == "True") {
                html += "<td class='dateLst showDateInTitle centerAlign isDayOfPeriod'>" +
                    "       <span>15th</span>" +
                    "    </td>";

                html += "<td class='termLst showTermInTitle centerAlign' style='position: relative;background-clip: padding-box !important;'>" +
                    "         <span class='termSpan'>N/A</span>" +
                    "        </td>";

                html += "<td class='amortizePeriodLst centerAlign'>" +
                    "       <span>1</span>" +
                    "<a href='javascript:void(0)' class='copyPeriodValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>" +
                    "        </td>";
            }

            for (var i = 1; i <= periods; i++) {

                disableStoreCompPeriod = (turnOnStorePeriods && (storeCompDataList == undefined || $.inArray(storeUID, storeCompDataList['P' + i + 'StoreIdCSV'].split(',')) == -1) ? true : false);

                html += '<td><input class="P' + ("0" + i).slice(-2) + 'Val' + (disableStoreCompPeriod ? " readonlyTxt" : "") + ($('#LockedP' + ("0" + i).slice(-2)).val() == 'Y' ? " disableBckgTxtBx" : "") + '" type="text" ' + ($('#LockedP' + ("0" + i).slice(-2)).val() == 'Y' || disableStoreCompPeriod ? "readonly" : "") +' value="0"></td>'
            }

            html += '</tr>';

            if (showBalanceSheetColumns == "True") {
                $modal.find('#CopyDataTableBS tbody').append(html);
                $modal.find('[name="subCategoryTermDD"]').SumoSelect();
            }
            else {
                $modal.find('#CopyDataTable tbody').append(html);
            }

            if ($('#ShowVendor').val() == "True") {

                var $appendedTr = $modal.find('table tbody tr:last');
                $appendedTr.find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Paste ' + $('#VendorName').val() + '-code', optWrapperCstmWidthToAuto: true, venList: vendorList });
            }

        },

        AddValuesToDataCopyModal: function ($tr, $valueTr, copyToSubCatRow) {

            var value = 0;
            var $inputField = '';
            var periods = getNumberOfPeriods();

            var $currentTrRow = $tr.find('td:not(.store-desc,.currencyTd,.currencyLst,.dateLst,.termLst,.amortizePeriodLst)').not($tr.find('td').has('.year'));

            for (var i = 0; i < 2 + periods; i++) {

                value = $valueTr.find('td').eq(i).text();
                $inputField = $currentTrRow.eq(i).find('input[type="text"]');

                if (i == 0)
                    $inputField.val(value);
                else if (i == 1) {

                    if (RetailBudgetPro.Budget.showVendorGlobalVal == 1) {

                        var html = '';
                        var datapageVerdor = $('[name="datapageVendordd"]');
                        var venCodeList = (value != null && value != undefined ? value.split(',') : "");
                        var $vendorDD = $tr.find('[name="VendorUID"]');

                        if (venCodeList.length > 0 && venCodeList[0] != "") {

                            if ($vendorDD.find('option').length > 0 && copyToSubCatRow == 1) {
                                $.each(venCodeList, function (index, val) {
                                    $vendorDD.find('option[data-vencode="' + val + '"]').attr('selected', 'selected');
                                });
                            }
                            else {
                                $.each(venCodeList, function (index, val) {
                                    var $optionTag = datapageVerdor.find('option[data-vencode="' + val + '"]');
                                    if ($optionTag != undefined) {
                                        html += $optionTag.prop('outerHTML');
                                    }
                                });

                                $vendorDD.html(html);
                                $vendorDD.find('option').attr('selected', 'selected');
                            }
                            $vendorDD[0].sumo.reload();
                        }
                    }
                    else {
                        $inputField.val(value);
                    }
                }
                else if ($inputField.hasClass('amortize-period')) {
                    continue;
                }
                else {

                    var parsedVal = parseFloat(value.replace(/,/g, ""));

                    if (!isNaN(parsedVal) && $inputField.attr('readonly') == undefined)
                        $inputField.val(parsedVal);
                    else
                        $inputField.val(0);
                }
            }
        },

        AddNewLineToPopUp: function (e) {
            var $target = $(e.target);
            var $parentDiv = $($target).parents('.formulamodal-sec');
            var decimalPlaces = $parentDiv.find('.popup-decimalPlaces').val();
            var isDepreciationExpense = $parentDiv.find('.popup-isDepreciationExpense').val();

            var modalID = $($target).parents('.modal').attr('id');
            var $currentTr = $('a[data-target="#' + modalID + '"]').parents('tr');

            var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
            var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
            var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
            var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
            var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
            var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
            var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
            var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
            var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
            var STCCompM10 = $currentTr.find('#STCCompM9').eq(0).text();
            var STCCompM11 = $currentTr.find('#STCCompM9').eq(0).text();
            var STCCompM12 = $currentTr.find('#STCCompM9').eq(0).text();
            var STCCompM13 = $currentTr.find('#STCCompM9').eq(0).text();

            var cloneDropdownVendor = $('#vendordd').clone();
            $(cloneDropdownVendor).find('option:contains("Blank")[value=-1], :contains("Any")[value=-2]').remove();
            $(cloneDropdownVendor).find('option').prop('selected', false).removeAttrs('selected disabled');
            var vendorDD = $(cloneDropdownVendor).html();

            var periods = getNumberOfPeriods();
            var showBSColumns = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && periods == 12);
            var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val();
            var currentYear = $('#hdnBudgetYear').val() - (startMonthOfFiscalYear == 1 ? 0 : 1);
            var termDD = $('[name="DatapageTermdd"]').html();
            var isNonFinCat = $parentDiv.find('.popup-isNonFinCategory').val() == "True";

            var html = '<tr class="noFormulaRow">' +
                       '<input type="hidden" class="storeUID" value="' + $parentDiv.find('tr.noFormulaRow:not(.other-store):eq(0) .storeUID').val() + '">' +
                       '<input type="hidden" class="hdnPLElementUID" value="-1"><input type="hidden" class="hdnCATType" value="' + $parentDiv.find('.popup-cattype').val() + '">' +
                            ($parentDiv.find('.contains-multiple-stores').val() == "True" ? '<td class="store-col ' + ($parentDiv.parents('.formulamodal').find('.show-all-stores').hasClass('hide') ? '' : 'hide') + '">' + $parentDiv.find('tr.noFormulaRow:not(.other-store):eq(0) .store-col').text().trim() + '</td>' : '') +
                            '<td>' +
                                 '<input class="descriptionVal" type="text" value="">' +
                            '</td>' +
                            '<td>' + $('#hdnBudgetYear').val() + '</td>';
            if ($('#ShowVendor').val() == "True" && RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                html += "<td class='vendorLst currencyOn th-minWidth' style='position: relative;background-clip: padding-box !important;'>" +
                    "<span class='vendorDD'>" +
                    "<select class='form-control multiselectLst vendorLstDD SumoUnder' multiple='multiple' name='VendorUID'>" +
                    vendorDD +
                    "</select>" +
                    "</span>" +
                    "</td>";
            }
            else if ($('#ShowVendor').val() == "True") {
                html += "<td class='vendorLst th-minWidth' style='position: relative;background-clip: padding-box !important;'>" +
                            "<span class='vendorDD'>" +
                                "<select class='form-control multiselectLst vendorLstDD SumoUnder' multiple='multiple' name='VendorUID'>" +
                                                    vendorDD +
                                "</select>" +
                            "</span>" +
                    (showBSColumns ? '' : '<a href="javascript:void(0)" class="copyPeriodValues" title="Copy first active period values to all periods"><i class="fa fa-sort-up"></i></a>') +
                        "</td>";
            }
            else if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                html += '<td class=vendorTd>' +
                    '<input class="vendorVal" type="text" value="">' +
                    '</td>';
            }
            else {
                html += '<td class=vendorTd>' +
                            '<input class="vendorVal" type="text" value="">' +
                    (showBSColumns ? '' : '<a href="javascript:void(0)" class="copyPeriodValues" title="Copy first active period values to all periods"><i class="fa fa-sort-up"></i></a>') +
                        '</td>';
            }

            if (showBSColumns) {
                if (isNonFinCat) {
                    html += "<td></td><td></td><td>" +
                        (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? "" : "<a href='#' class='copyPeriodValues formulas' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
                        "        </td>";
                }
                else {
                    html += "<td class='dateLst showDateInTitle centerAlign isDayOfPeriod'>" +
                        "       <div class='transactionDateDiv hide'>" +
                        "          <a href='javascript:void(0)' class='openTransactionPopup transactionDate' title='Transaction date' data-date='" + ("0" + $('[name=StartMonthOfFiscalYear]').val()).slice(-2) + "/15/" + currentYear + "'>" + ("0" + $('[name=StartMonthOfFiscalYear]').val()).slice(-2) + "/15/" + currentYear + "</a>" +
                        "          <span class='transactionSpan hide' data-value='" + ("0" + $('[name=StartMonthOfFiscalYear]').val()).slice(-2) + "/15/" + currentYear + "'></span>" +
                        "       </div>" +
                        "       <div class='dayOfPeriodDiv'>" +
                        "          <a href='javascript:void(0)' class='openTransactionPopup dayOfPeriod' title='Day of period' data-day='15'>15th</a>" +
                        "           <span class='transactionSpan hide' data-value='15'></span>" +
                        "       </div>" +
                        "    </td>";

                    if (isDepreciationExpense == "False") {
                        html += "<td class='termLst showTermInTitle centerAlign'>" +
                            "         <span class='termtd hide'></span>" +
                            "           <div class='termDD'>" +
                            "               <select class='form-control select2me' name='subCategoryTermDD'>" + termDD + "</select>" +
                            "           </div>" +
                            "        </td>";
                    }
                    else {
                        html += "<td class='termLst showTermInTitle centerAlign'>" +
                            "         <span class='termtd'>N/A</span>" +
                            "           <div class='termDD hide'>" +
                            "               <select class='form-control select2me' name='subCategoryTermDD'>" + termDD + "</select>" +
                            "           </div>" +
                            "        </td>";
                    }

                    html += "<td class='amortizePeriodLst showAmortizePeriodInTitle vendor-wrap rightAlign'>" +
                        "         <input type='text' value='1' class='amortize-period'>" +
                        "           <span data-value='1' class='hide'></span>" +
                        (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? "" : "<a href='#' class='copyPeriodValues formulas' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
                        "        </td>";
                }
            }

            if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                if ($('[name="groupedcategory"] option[value$="|' + $parentDiv.find('.popup-categoryID').val() + '"]').data('isfinancialcat') == "False") {
                    html += "<td class='currencyLst showCurrencyInTitle'>" +
                        "<span class='currency hide'></span>" +
                        "<input type='hidden' value='-1' name='subCategoryCurrencyDD' id='subCategoryCurrencyDD'>" +
                        "<a href='#' class='copyPeriodValues formulas' title='Copy first active period values to all periods'> <i class='fa fa-sort-up'></i></a > " +
                        "</td>"
                }
                else {
                    var currencyDD = $parentDiv.find('#subCategoryCurrencyDD').html();
                    html += "<td class='currencyLst showCurrencyInTitle'>" +
                        "    <span class='currency hide'></span>" +
                        "    <div class='currencyDD'>" +
                        "          <select class='form-control' name='subCategoryCurrencyDD' id = 'subCategoryCurrencyDD' >" +
                        currencyDD +
                        "          </select>" +
                        "     </div>" +
                        "<a href='javascript:void(0)' class='copyPeriodValues formulas' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>" +
                        "         </td>";
                }
            }

            html += '<td>' +
                '<input class="DATVal P01Val ' + (STCCompM1 == "N" || $('#LockedP01').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM1 == "N" || $('#LockedP01').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P02Val ' + (STCCompM2 == "N" || $('#LockedP02').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM2 == "N" || $('#LockedP02').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                 '<input class="DATVal P03Val ' + (STCCompM3 == "N" || $('#LockedP03').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM3 == "N" || $('#LockedP03').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                 '<input class="DATVal P04Val ' + (STCCompM4 == "N" || $('#LockedP04').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM4 == "N" || $('#LockedP04').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                 '<input class="DATVal P05Val ' + (STCCompM5 == "N" || $('#LockedP05').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM5 == "N" || $('#LockedP05').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P06Val ' + (STCCompM6 == "N" || $('#LockedP06').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM6 == "N" || $('#LockedP06').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P07Val ' + (STCCompM7 == "N" || $('#LockedP07').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM7 == "N" || $('#LockedP07').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P08Val ' + (STCCompM8 == "N" || $('#LockedP08').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM8 == "N" || $('#LockedP08').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P09Val ' + (STCCompM9 == "N" || $('#LockedP09').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM9 == "N" || $('#LockedP09').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P10Val ' + (STCCompM10 == "N" || $('#LockedP10').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM10 == "N" || $('#LockedP10').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P11Val ' + (STCCompM11 == "N" || $('#LockedP11').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM11 == "N" || $('#LockedP11').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>' +
            '<td>' +
                '<input class="DATVal P12Val ' + (STCCompM12 == "N" || $('#LockedP12').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM12 == "N" || $('#LockedP12').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
            '</td>';

            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                html += '<td>' +
                             '<input class="DATVal P13Val ' + (STCCompM13 == "N"|| $('#LockedP13').val() == 'Y' ? "removeBackgndColor" : "") + '" type="text" value="0" ' + (STCCompM13 == "N" || $('#LockedP13').val() == 'Y' ? "readonly = readonly" : "") + ' data-DecimalPlaces="' + decimalPlaces + '" >' +
                        '</td>';
            }

            html += '<td>' +
                         '<input type="text" class="rowTotal" value="0" />' +
                         '</td>';

            html += '<td>' +
                         '<a href="javascript:void(0)" class="distributeTotalEvenly" title="Spread the Total amount evenly to all periods">=</a>' +
                         '<a class="delete-row"><i class="fa fa-trash-o"></i></a>' +
                    '</td></tr>';

            $($parentDiv).find('.budgets-table tbody').append(html);
            $($parentDiv).find('[type=text]:not(.sumo-search)').each(function () {
                if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('descriptionVal') && !$(this).hasClass('vendorVal')) {
                    $(this).calculator({ customDecimalPlaces: $(this).attr('data-decimalplaces') });
                }
            });

            if ($parentDiv.find('.popup-cattype').val() == "R") {
                $($parentDiv).find('[name="subCategoryTermDD"] option[data-cattype="C"]').remove();
            }
            else if ($parentDiv.find('.popup-cattype').val() == "E") {
                $($parentDiv).find('[name="subCategoryTermDD"] option[data-cattype="D"]').remove();
            }

            $($parentDiv).find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
            $($parentDiv).find('[name="subCategoryCurrencyDD"]').SumoSelect();
            $($parentDiv).find('[name="subCategoryTermDD"]').SumoSelect();
        },
        RemovePopupRow: function (e) {
            $parentsTr = $(e.target).parents('tr');

            var isNonFinCat = $parentsTr.parents('.formulamodal-sec').find('.popup-isNonFinCategory').val() == "True";
            var oldVendorVal = $parentsTr.find('.hdnVendorUIDCSV').val();

            if ($parentsTr.find('.hdnPLElementUID').val() != "-1") {
                var tempArray = [];
                tempArray.unshift('+');
                tempArray.push($parentsTr.parents('.formulamodal-sec').find('.popup-categoryID').val());
                tempArray.push($parentsTr.find('.storeUID').val());
                tempArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");
                tempArray.push($parentsTr.find('[type="text"].descriptionVal').siblings('span').html());
                tempArray.push(oldVendorVal);
                
                if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && !isNonFinCat && $parentsTr.parents('.modal').hasClass('nonEmployeeFormulas')) {
                    if ($parentsTr.find('.dateLst').hasClass('isTransactionDate'))
                        tempArray.push($parentsTr.find('.dateLst .transactionDateDiv .transactionSpan').attr('data-value'));
                    else
                        tempArray.push(GetOrdinalValue($parentsTr.find('.dateLst .dayOfPeriodDiv .transactionSpan').attr('data-value')));

                    tempArray.push($parentsTr.find('.termLst .termSpan').html());
                    tempArray.push($parentsTr.find('.amortizePeriodLst span').html());
                }

                $parentsTr.find('input[type="text"].DATVal').each(function () {
                    tempArray.push(ConvertCurrencyStringToDecimal($(this).siblings('span:eq(0)').attr('data-editvalue')));
                })

                //$parentsTr.find('[type="text"]').siblings('span').filter(function () {
                //    if ($(this).siblings('[type="text"]').hasClass('vendorVal') || $(this).siblings('[type="text"]').hasClass('descriptionVal'))
                //        tempArray.push($(this).html());
                //    else
                //        tempArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                //});
                tempArray.push('1');
                tempArray.push($parentsTr.find('.hdnPLElementUID').val());
                RetailBudgetPro.Budget.FormulaPopUpAudits.push(tempArray);

                FormulaPopDeletedPLElementUIDs.push($parentsTr.find('.hdnPLElementUID').val())
            }

            $parentsTr.remove();
        },

        AddNewLineToPayrollPopUp: function (e) {

            var $parentDiv = $(this).parents('.formulamodal');
            var $tr = $(this).parents('tr');

            var divClass = ''
            var property = '';
            var isOvertimeRow = '';

            if ($(this).parents('div').hasClass('allocationSalaryCheck')) {
                divClass = 'allocationSalaryCheck';
                property = 'LstAllocationPercentData';
                isOvertimeRow = false;
            }
            else if ($(this).parents('div').hasClass('overtimeSalaryCheck')) {
                divClass = 'overtimeSalaryCheck';
                property = 'LstOvertimeSalaryData';
                isOvertimeRow = true;
            }
            else if ($(this).parents('div').hasClass('allocationHourCheck')) {
                divClass = 'allocationHourCheck';
                property = 'LstAllocationHourData';
                isOvertimeRow = false;
            }
            else {
                divClass = 'overtimeHourCheck';
                property = 'LstOvertimeHourData';
                isOvertimeRow = true;
            }

            var storeUID = $tr.find('[name$="StoreUID"]').val()

            var showVendor = $('#ShowVendor').val() == "True" ? true : false;
            var showPeriodDistribution = ($('#hdnUsePeriodReDistribution').val() == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == "12" ? true : false)
            var periodReDistributionValue = $('#hdnPeriodReDistributionValue').val()
            var classVal = "store-childData-row";

            var cloneDropdownVendor = $tr.find('td.vendorLst select[name$="VendorUID"]').clone();
            var vendorDD = $(cloneDropdownVendor).html();

            var count = parseInt($tr.attr('data-childrowcount')) + 1;

            html = "<tr class=" + classVal + " id=" + storeUID + " data-rowNum=" + count + ">" +
                "    <input class='hdnRowStoreUID' id='" + property + "_0__StoreUID' name='" + property + "[0].StoreUID' type='hidden' value='" + storeUID + "'>" +
                "    <td><div class='loc-lbl'></div>" + (showVendor ? "" : 
                "    <a href ='javascript:void(0)' class='copyPeriodValues store-grid copy-amount copyPeriodHeadCount' title ='Copy first active period value to all periods'><i class='fa fa-sort-up'></i></a>") +
                "    </td>"
            if (showVendor) {
                html += "<td class='vendorLst th-minWidth loc-lbl'>" +
                    "     <select class='form-control child-dropdown vendorLstDD' name='" + property + "[0].VendorUID'>" + vendorDD + "</select>" +
                    "     <a href ='javascript:void(0)' class='copyPeriodValues store-grid copy-amount' title ='Copy first active period value to all periods'><i class='fa fa-sort-up'></i></a>" +
                    " </td>";
            }

            $tr.find('input[type=text]:not(.disabled)').removeAttr('readonly').removeClass('readonlyTxt');

            if (divClass == 'allocationSalaryCheck') {
                $tr.find('td.percentage').each(function () {
                    return html += "<td class='percentage td-minWidth'>" + $(this).html() + "</td>"
                })
            }
            else {
                $tr.find('td.td-minWidth').each(function () {
                    return html += "<td class='td-minWidth'>" + $(this).html() + "</td>"
                })
            }

            $tr.find('input[type=text]:not(.disabled)').attr('readonly', true).addClass('readonlyTxt');

            html += "<td class='action-btn'>" +
                "     <div class='function-btn'>" +
                "     <a class='payrollDistributeEvenly' title='Spread the Total amount evenly to all periods'>=</a>" +
                (showPeriodDistribution ? "<a class='periodRedistribute hide' data-value=" + periodReDistributionValue + " title='Distribute by " + periodReDistributionValue + ">" + periodReDistributionValue + "</a>" : "") +
                "     <a class='deleteChildRow' title = 'Delete this row'> <i class='fa fa-trash-o'></i></a>" +
                " </td></tr>";

            if ($tr.nextUntil('tr.store-data-row').not('.totals-row').length == 0)
                $tr.after(html)
            else
                $tr.nextUntil('tr.store-data-row').not('.totals-row').last().after(html)

            var appendedTr = $tr.parents('div.' + divClass).find('tr#' + storeUID + '[data-rowNum="' + count + '"]')

            appendedTr.find('select[name$="VendorUID"]').select2({
                dropdownAutoWidth: 'true',
                width: 'auto',
                dropdownCssClass: 'payroll-grid-selectors'
            });

            appendedTr.find('td input[type="text"]').attr('data-currentvalue', 0).attr('value', '');

            if ($('#hdnLockedMonths').val() == "")
                $parentDiv.find('.' + divClass + ' .deleteChildRow').removeClass('hide');

            //for next grid

            if (divClass == 'allocationSalaryCheck') {
                divClass = 'allocationSalaryDollarCheck';
                property = 'LstAllocationSalaryData';
            }
            else if (divClass == 'overtimeSalaryCheck') {
                divClass = 'overtimeSalaryRateCheck';
                property = 'LstOvertimeSalaryRateData';
            }
            else if (divClass == 'allocationHourCheck') {
                divClass = 'allocationHourlyRateCheck';
                property = 'LstAllocationHouryRateData';
            }
            else {
                divClass = 'overtimeHourlyRateCheck';
                property = 'LstOvertimeHouryRateData';
            }

            var $dollarTr = $parentDiv.find('.' + divClass + ' table tbody tr.store-data-row').has('[type=hidden][name$=StoreUID][value=' + storeUID + ']');

            html = "<tr class=" + classVal + " id=" + storeUID + " data-rowNum=" + count + ">" +
                "   <input class='hdnRowStoreUID' id='" + property + "_0__StoreUID' name='" + property + "[0].StoreUID' type='hidden' value='" + storeUID + "'>" +
            (divClass == 'allocationSalaryDollarCheck' ? "<td></td>" : "<input class='resetCurrentRow' id='" + property + "_0__IsRowReset' name='" + property + "[0].IsRowReset' type='hidden' value='False'>" +
                                                                       "<td><div class='loc-lbl'>" +
                                                                       "<a href ='javascript:void(0)' class='copyPeriodValues store-grid copy-amount' title ='Copy first active period value to all periods'><i class='fa fa-sort-up'></i></a>" +
                                                                       "</div ></td>")

            if (showVendor) {
                html += "<td class='vendorLst th-minWidth loc-lbl'><div class='hide'>" +
                    "     <select class='form-control child-dropdown vendorLstDD' name='" + property + "[0].VendorUID'>" + vendorDD + "</select>" +
                    " </div></td>";
            }

            if (divClass == 'allocationSalaryDollarCheck') {
                $dollarTr.find('td.data').each(function () {
                    return html += "<td class='data td-minWidth'>" + $(this).html() + "</td>"
                })
            }
            else {
                $dollarTr.find('input[type=text]:not(.disabled)').removeAttr('readonly').removeClass('readonlyTxt');
                $dollarTr.find('td.td-minWidth').each(function () {
                    return html += "<td class='td-minWidth'>" + $(this).html() + "</td>"
                })
                $dollarTr.find('input[type=text]:not(.disabled)').attr('readonly', true).addClass('readonlyTxt');
            }

            if (divClass != 'allocationSalaryDollarCheck') {
                html += "<td class='action-btn'>" +
                    "     <div class='function-btn'>" +
                    "     <a class='payrollDistributeEvenly distributeByAverage' title='Spread the Total amount evenly to all periods'>=</a>" +
                    (showPeriodDistribution ? "<a class='periodRedistribute distributeByAverage hide' data-value=" + periodReDistributionValue + " title='Distribute by " + periodReDistributionValue + ">" + periodReDistributionValue + "</a>" : "") +
                    " </td><td class='hide hdnDecimalPlaces'>0</td></tr>";
            }
            else {
                html += "<td></td></tr>";
            }

            if ($dollarTr.nextUntil('tr.store-data-row').not('.totals-row').length == 0)
                $dollarTr.after(html)
            else
                $dollarTr.nextUntil('tr.store-data-row').not('.totals-row').last().after(html)

            appendedTr = $dollarTr.parents('div.' + divClass).find('tr#' + storeUID + '[data-rowNum="' + count + '"]')

            appendedTr.find('td input[type="text"]').attr('data-currentvalue', 0).attr('value', (divClass == 'allocationSalaryDollarCheck' ? 0 : ''));

            var venDD = appendedTr.find('td.vendorLst select[name$="VendorUID"]')
            
            venDD.select2({
                dropdownAutoWidth: 'true',
                width: 'auto',
                dropdownCssClass: 'payroll-grid-selectors'
            });

            venDD.find('option').attr('disabled', true);

            $(this).parents('tr').attr('data-childrowcount', count)

            if (isOvertimeRow) {

                if ((divClass == 'overtimeSalaryRateCheck' && $parentDiv.find('.allocationSalaryCheck tr.store-childData-row').length == $parentDiv.find('.overtimeSalaryCheck tr.store-childData-row').length) ||
                    (divClass == 'overtimeHourlyRateCheck' && $parentDiv.find('.allocationHourCheck tr.store-childData-row').length == $parentDiv.find('.overtimeHourCheck tr.store-childData-row').length)) {
                    $parentDiv.find('.addNewRow.overtime').addClass('hide');
                }

                if (divClass == 'overtimeSalaryRateCheck') {
                    var allocationDivClass = 'allocationSalaryCheck'
                    var overtimeDiv = 'overtimeSalaryCheck';
                }
                else if (divClass == 'overtimeHourlyRateCheck') {
                    var allocationDivClass = 'allocationHourCheck'
                    var overtimeDiv = 'overtimeHourCheck';
                }

                var vendorVal = $parentDiv.find('.' + allocationDivClass + ' tbody tr.store-childData-row[id=' + storeUID + '][data-rownum=' + count + '] select[name$="VendorUID"] option:selected').val()

                var $tr = $parentDiv.find('.' + overtimeDiv + ' tbody tr.store-childData-row[id=' + storeUID + '][data-rownum=' + count + ']')

                $tr.find('[name$="VendorUID"] option').attr('disabled',true)
                $tr.find('[name$="VendorUID"] option[value="' + vendorVal + '"]').removeAttr('disabled')
                $tr.find('[name$="VendorUID"]').val(vendorVal).trigger('change')
                $tr.find('[name$="VendorUID"] option[value="' + vendorVal + '"]').attr('disabled', true)
            }
            else {
                $parentDiv.find('.addNewRow.overtime').removeClass('hide');
            }

            DisableInActivePeriods($('.payrollModal').attr('id'));
            DisableLockedPeriods();
        },
        RemovePayrollPopupRow: function (e) {
            
            var $parentDiv = $(this).parents('.formulamodal');
            var divClass = '';
            var overtimeDivClass = '';
            var allocationDivClass = '';
            var triggerEvent = '';

            if ($(this).parents('div').hasClass('allocationSalaryCheck')) {
                divClass = 'allocationSalaryDollarCheck';
                currDivClass = 'allocationSalaryCheck'
                overtimeDivClass = 'overtimeSalaryCheck'
                allocationDivClass = 'allocationSalaryCheck';
            }
            else if ($(this).parents('div').hasClass('overtimeSalaryCheck')) {
                divClass = 'overtimeSalaryRateCheck';
                currDivClass = 'overtimeSalaryCheck'
                overtimeDivClass = 'overtimeSalaryCheck'
                allocationDivClass = 'allocationSalaryCheck';
            }
            else if ($(this).parents('div').hasClass('allocationHourCheck')) {
                divClass = 'allocationHourlyRateCheck';
                currDivClass = 'allocationHourCheck'
                overtimeDivClass = 'overtimeHourCheck'
                allocationDivClass = 'allocationHourCheck';
            }
            else {
                divClass = 'overtimeHourlyRateCheck';
                currDivClass = 'overtimeHourCheck';
                overtimeDivClass = 'overtimeHourCheck'
                allocationDivClass = 'allocationHourCheck';
            }

            $parentDiv.find('.' + divClass + ' tbody tr.store-childData-row[id=' + $(this).parents('tr').attr('id') + '][data-rownum=' + $(this).parents('tr').attr('data-rownum') + ']').remove();

            if ($parentDiv.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {

                if (currDivClass == 'allocationSalaryCheck' || currDivClass == 'allocationHourCheck') {

                    if ($parentDiv.find('.' + currDivClass + ' tr.store-childData-row').length == $parentDiv.find('.' + overtimeDivClass + ' tr.store-childData-row').length) {
                        triggerEvent = $parentDiv.find('.' + overtimeDivClass + ' tbody tr.store-childData-row[id=' + $(this).parents('tr').attr('id') + '][data-rownum=' + $(this).parents('tr').attr('data-rownum') + ']').find('a.deleteChildRow');
                    }
                    else if (($parentDiv.find('.' + currDivClass + ' tr.store-childData-row').length - 1) == $parentDiv.find('.' + overtimeDivClass + ' tr.store-childData-row').length) {
                        $parentDiv.find('.addNewRow.overtime').addClass('hide');
                    }
                }
                else {
                    if ($('[name="ShowVendor"]').val() == "True" && $parentDiv.find('.' + currDivClass + ' tr.store-childData-row').length <= $parentDiv.find('.' + allocationDivClass + ' tr.store-childData-row').length) {
                        $parentDiv.find('.addNewRow.overtime').removeClass('hide');
                    }
                    else {
                        $parentDiv.find('.addNewRow.overtime').addClass('hide');
                    }
                }
            }

            $(this).parents('tr').remove();

            $parentDiv.find('.' + currDivClass + ' tbody tr.store-childData-row').each(function (i) {

                $parentDiv.find('.' + divClass + ' tbody tr.store-childData-row[data-rownum="' + $(this).attr('data-rownum') + '"]').attr('data-rownum', (i + 1))
                $(this).attr('data-rownum', (i + 1))

                if ($('[name="ShowVendor"]').val() == "True" && $parentDiv.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {

                    var vendorVal = $parentDiv.find('.' + allocationDivClass + ' tbody tr.store-childData-row[data-rownum=' + $(this).attr('data-rownum') + '] select[name$="VendorUID"] option:selected').val()

                    var $overtimeTr = $parentDiv.find('.' + overtimeDivClass + ' tbody tr.store-childData-row[data-rownum=' + $(this).attr('data-rownum') + ']')

                    $overtimeTr.find('[name$="VendorUID"] option').attr('disabled', true)
                    $overtimeTr.find('[name$="VendorUID"] option[value="' + vendorVal + '"]').removeAttr('disabled')
                    $overtimeTr.find('[name$="VendorUID"]').val(vendorVal).trigger('change')
                    $overtimeTr.find('[name$="VendorUID"] option[value="' + vendorVal + '"]').attr('disabled', true)
                }

            })

            if ($parentDiv.find('div.' + currDivClass).find('tr.store-childData-row').length == 1)
                $parentDiv.find('div.' + currDivClass).find('tr.store-childData-row .deleteChildRow').addClass('hide');

            $parentDiv.find('.' + currDivClass + ' tbody tr.store-data-row').attr('data-childrowcount', $parentDiv.find('.' + currDivClass + ' tbody tr.store-childData-row').length)

            if (triggerEvent != '') triggerEvent.trigger('click');

        },

        DisableChildDropDown:  function () {

            var $parentDiv = $('.formulamodal');

            $parentDiv.find('select[name$=".VendorUID"] option').removeAttr('disabled');
            $parentDiv.find('select[name$=".VendorUID"]').select2({
                dropdownAutoWidth: 'true',
                width: 'auto',
                dropdownCssClass: 'payroll-grid-selectors'
            });

            $parentDiv.find('.allocationSalaryDollarCheck table tbody tr.store-childData-row').each(function () {
                if ($(this).find('td.vendorLst select[name$="VendorUID"]').length > 0) {
                    $(this).find('option').attr('disabled', true);
                }
            });

            $parentDiv.find('.allocationHourlyRateCheck table tbody tr.store-childData-row').each(function () {
                if ($(this).find('td.vendorLst select[name$="VendorUID"]').length > 0) {
                    $(this).find('option').attr('disabled', true);
                }
            });

            $parentDiv.find('.overtimeSalaryRateCheck table tbody tr.store-childData-row').each(function () {
                if ($(this).find('td.vendorLst select[name$="VendorUID"]').length > 0) {
                    $(this).find('option').attr('disabled', true);
                }
            });

            $parentDiv.find('.overtimeHourlyRateCheck table tbody tr.store-childData-row').each(function () {
                if ($(this).find('td.vendorLst select[name$="VendorUID"]').length > 0) {
                    $(this).find('option').attr('disabled', true);
                }

            });

            $parentDiv.find('.overtimeSalaryCheck table tbody tr.store-childData-row').each(function () {
                if ($(this).find('td.vendorLst select[name$="VendorUID"]').length > 0) {
                    $(this).find('option').attr('disabled', true);
                }
            });

            $parentDiv.find('.overtimeHourCheck table tbody tr.store-childData-row').each(function () {
                if ($(this).find('td.vendorLst select[name$="VendorUID"]').length > 0) {
                    $(this).find('option').attr('disabled', true);
                }
            });

            if (($parentDiv.find('.allocationSalaryCheck').length > 0 && ($parentDiv.find('.allocationSalaryCheck tr.store-childData-row').length == $parentDiv.find('.overtimeSalaryCheck tr.store-childData-row').length)) ||
                ($parentDiv.find('.allocationHourCheck').length > 0 && ($parentDiv.find('.allocationHourCheck tr.store-childData-row').length == $parentDiv.find('.overtimeHourCheck tr.store-childData-row').length))) {
                $parentDiv.find('.addNewRow.overtime').addClass('hide');
            }
        },

        VendorDDFunc: function () {

            var $parentDiv = $('.formulamodal');
            var storeUID = $(this).parents('tr').attr('id')
            var rowNum = $(this).parents('tr').attr('data-rownum')

            if ($(this).parents('div').hasClass('allocationSalaryCheck')) { var divClass = 'allocationSalaryDollarCheck'; }
            else if ($(this).parents('div').hasClass('overtimeSalaryCheck')) { var divClass = 'overtimeSalaryRateCheck'; }
            else if ($(this).parents('div').hasClass('allocationHourCheck')) { var divClass = 'allocationHourlyRateCheck';}
            else { var divClass = 'overtimeHourlyRateCheck'; }
            
            var $tr = $parentDiv.find('.' + divClass + ' tbody tr.store-childData-row[id=' + storeUID + '][data-rownum=' + rowNum + ']')
            var overtimeDiv = ($(this).parents('div').hasClass('allocationSalaryCheck') ? 'overtimeSalaryCheck' : 'overtimeHourCheck')

            $tr.find('[name$="VendorUID"] option[value="' + $(this).val() + '"]').removeAttr('disabled')
            $tr.find('[name$="VendorUID"]').val($(this).val()).trigger('change')
            $tr.find('[name$="VendorUID"] option[value="' + $(this).val() + '"]').attr('disabled', true)

            if ($parentDiv.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {

                if ($(this).parents('div').hasClass('allocationSalaryCheck') || $(this).parents('div').hasClass('allocationHourCheck')) {
                    var $overtimeTr = $('.' + overtimeDiv + ' table tr.store-childData-row[id="' + storeUID + '"][data-rownum="' + rowNum + '"]');

                    $overtimeTr.find('[name$="VendorUID"] option[value="' + $(this).val() + '"]').removeAttr('disabled')
                    $overtimeTr.find('[name$="VendorUID"]').val($(this).val()).trigger('change')
                }
                else {
                    $(this).parents('tr').find('[name$="VendorUID"] option[value="' + $(this).val() + '"]').attr('disabled', true)
                }
            }
        },

        SaveRelatedCategoryData: function () {

            var $formaulaModal = $(this).parents('.formulamodal');

            var decimalPlaces = $formaulaModal.find('.popup-decimalPlaces').val();
            
            if (SaveRelatedCategoryDataValidation('#' + $formaulaModal.attr('id')) != -1) {

                $('#' + $formaulaModal.attr('id')).modal('toggle');

                $('.layout').show();

                $('.custom-data-table').hide();

                var showVendor = $('#ShowVendor').val() == "True";

                var dataObj = [];
                var data = {};

                var storeDataObj = [];
                var storeData = {};

                var hdnNumberOfPeriodsVal = RetailBudgetPro.Budget.numberOfPeriodsVal;
                var TurnOnBalanceSheetVal = RetailBudgetPro.Budget.turnOnBalanceSheetVal;

                $('#' + $formaulaModal.attr('id')).find('tr.store-data-row').each(function () {
                    var $pRow = $(this);
                    if (hdnNumberOfPeriodsVal == "13") {
                        storeData = {
                            "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "P01": $pRow.find('#StoreDataP01').val(), "P02": $pRow.find('#StoreDataP02').val()
                            , "P03": $pRow.find('#StoreDataP03').val(), "P04": $pRow.find('#StoreDataP04').val(), "P05": $pRow.find('#StoreDataP05').val()
                            , "P06": $pRow.find('#StoreDataP06').val(), "P07": $pRow.find('#StoreDataP07').val(), "P08": $pRow.find('#StoreDataP08').val()
                            , "P09": $pRow.find('#StoreDataP09').val(), "P10": $pRow.find('#StoreDataP10').val(), "P11": $pRow.find('#StoreDataP11').val()
                            , "P12": $pRow.find('#StoreDataP12').val(), "P13": $pRow.find('#StoreDataP13').val(), "IsDistributed": false
                        };
                    }
                    else {
                        storeData = {
                            "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "P01": $pRow.find('#StoreDataP01').val(), "P02": $pRow.find('#StoreDataP02').val()
                            , "P03": $pRow.find('#StoreDataP03').val(), "P04": $pRow.find('#StoreDataP04').val(), "P05": $pRow.find('#StoreDataP05').val()
                            , "P06": $pRow.find('#StoreDataP06').val(), "P07": $pRow.find('#StoreDataP07').val(), "P08": $pRow.find('#StoreDataP08').val()
                            , "P09": $pRow.find('#StoreDataP09').val(), "P10": $pRow.find('#StoreDataP10').val(), "P11": $pRow.find('#StoreDataP11').val()
                            , "P12": $pRow.find('#StoreDataP12').val(), "P13": $('.popup-foa-type').val() == 'Div' ? 1 : 0, "IsDistributed": false
                        };
                    }

                    storeDataObj.push(storeData);
                });

                $formaulaModal.find('.formulamodal-sec:not(.catDetailViewNotAllowed)').each(function () {

                    var $formSec = $(this);

                    var decimalPlaces = $formSec.find('.popup-decimalPlaces').val();
                    var isNonFinCat = $formSec.find('.popup-isNonFinCategory').val() == "True";

                    if ($(this).find('.budgets-table tbody tr.noFormulaRow').length == 0) {
                        data = {};

                        var vendorUIDCSV = $(this).find('.vendorLstDD').val();

                        if (hdnNumberOfPeriodsVal == "13")
                            data = {
                                "PLElementUID": -1, "DATValueM1": 0, "DATValueM2": 0, "DATValueM3": 0, "DATValueM4": 0, "DATValueM5": 0, "DATValueM6": 0, "DATValueM7": 0, "DATValueM8": 0, "DATValueM9": 0, "DATValueM10": 0, "DATValueM11": 0, "DATValueM12": 0, "DATValueM13": 0,
                                "VENDescription": '', "DATDescription": '', "DATPLCategoryUID": $formSec.find('.popup-categoryID').val(), "DATDepartmentUID": $formSec.find('.popup-departmentID').val(), "DATStoreUID": $formSec.find('.popup-storeID').val(), "DATVendorUID": vendorUIDCSV, "LoadFromExcel": false, "CurrencyUID": $formSec.find('[name = "subCategoryCurrencyDD"]').val() == undefined ? RetailBudgetPro.Budget.globalCurrencyUID : $formSec.find('[name = "subCategoryCurrencyDD"]').val(),
                                "TransactionDate": new Date(), "DayOfPeriod": 15, "TermUID": -1, "AmortizePeriod": 1//undefined if new row added
                            };
                        else
                            data = {
                                "PLElementUID": -1, "DATValueM1": 0, "DATValueM2": 0, "DATValueM3": 0, "DATValueM4": 0, "DATValueM5": 0, "DATValueM6": 0, "DATValueM7": 0, "DATValueM8": 0, "DATValueM9": 0, "DATValueM10": 0, "DATValueM11": 0, "DATValueM12": 0,
                                "VENDescription": '', "DATDescription": '', "DATPLCategoryUID": $formSec.find('.popup-categoryID').val(), "DATDepartmentUID": $formSec.find('.popup-departmentID').val(), "DATStoreUID": $formSec.find('.popup-storeID').val(), "DATVendorUID": vendorUIDCSV, "LoadFromExcel": false, "CurrencyUID": $formSec.find('[name = "subCategoryCurrencyDD"]').val() == undefined ? RetailBudgetPro.Budget.globalCurrencyUID : $formSec.find('[name = "subCategoryCurrencyDD"]').val(),
                                "TransactionDate": new Date(), "DayOfPeriod": 15, "TermUID": -1, "AmortizePeriod": 1//undefined if new row added
                            };

                        dataObj.push(data);
                    }

                    else {
                        $(this).find('.budgets-table tbody tr.noFormulaRow').each(function () {

                            var $this = $(this);

                            var fromExcel = $this.find('.hdnFromExcel').val();
                            var cATCalculatedType = $this.find('.hdnCATCalculatedType').val();

                            // skipping Excel linked row and any other row which has CATCalculatedType as C2C/FOA/Rule/EP/EFP/LC/NE as the user is not allowed to make any changes to these rows
                            if (fromExcel === 'True' || (cATCalculatedType !== undefined && cATCalculatedType !== "")) {
                                return;
                            }

                            var newArray = [];
                            var oldArray = [];

                            var isTermFormulaType = $this.find('[name="subCategoryTermDD"] option:selected').attr('data-isformulatype') == "True";
                            var turnOnBalanceSheet = (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && !isNonFinCat);

                            var oldVendorVal = showVendor ? $this.find('.hdnVendorUIDCSV').val() : $this.find('.vendorVal').siblings('span:eq(0)').html();
                            var newVendorVal = showVendor ? $this.find('.vendorLstDD option:selected').map(function () { return $(this).val() }).get().join() : $this.find('.vendorVal').val();

                            data = {};

                            var amortPeriod = (turnOnBalanceSheet ? $this.find('.amortize-period').val() : 1)

                            if (hdnNumberOfPeriodsVal == "13") {
                                var vendorUIDCSV = $this.find('.vendorLstDD').val();

                                data = {
                                    "PLElementUID": $this.find('.hdnPLElementUID').val(), "DATValueM1": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(decimalPlaces), "DATValueM2": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(decimalPlaces), "DATValueM3": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(decimalPlaces), "DATValueM4": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(decimalPlaces), "DATValueM5": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(decimalPlaces), "DATValueM6": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(decimalPlaces), "DATValueM7": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(decimalPlaces), "DATValueM8": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(decimalPlaces), "DATValueM9": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(decimalPlaces), "DATValueM10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()), "DATValueM11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()), "DATValueM12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(decimalPlaces), "DATValueM13": ConvertCurrencyStringToDecimal($this.find('.P13Val').val()).toFixed(decimalPlaces),
                                    "VENDescription": $this.find('.vendorVal').val(), "DATDescription": $this.find('.descriptionVal').val(), "DATPLCategoryUID": $formSec.find('.popup-categoryID').val(), "DATDepartmentUID": $formSec.find('.popup-departmentID').val(), "DATStoreUID": $this.find('.storeUID').val(), "VendorUID": vendorUIDCSV, "LoadFromExcel": false, "CurrencyUID": $this.find('[name = "subCategoryCurrencyDD"]').val() == undefined ? RetailBudgetPro.Budget.globalCurrencyUID : $this.find('[name = "subCategoryCurrencyDD"]').val(),
                                    "TransactionDate": new Date(), "DayOfPeriod": 15, "TermUID": -1, "AmortizePeriod": 1 //undefined if new row added
                                };

                                oldArray.unshift('-');
                                oldArray.push($this.parents('.formulamodal-sec').find('.popup-categoryID').val());
                                oldArray.push($this.find('.storeUID').val());
                                oldArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");
                                if ($this.find('.hdnPLElementUID').val() != "-1") {
                                    $this.find('[type="text"]').siblings('span').filter(function () {
                                        if ($(this).siblings('[type="text"]').hasClass('vendorVal') || $(this).siblings('[type="text"]').hasClass('descriptionVal'))
                                            oldArray.push($(this).html());
                                        else if ($(this).parents('td').hasClass('currencyLst')) oldArray.push($(this).parents('td').find('[name="subCategoryCurrencyDD"]').val());
                                        else
                                            oldArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                                    });
                                }
                                else
                                    oldArray.push("", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                                oldArray.push('0');
                                oldArray.push($this.find('.hdnPLElementUID').val());
                                RetailBudgetPro.Budget.FormulaPopUpAudits.push(oldArray);

                                newArray.unshift('+');
                                newArray.push($this.parents('.formulamodal-sec').find('.popup-categoryID').val());
                                newArray.push($this.find('.storeUID').val());
                                newArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");
                                newArray.push($this.find('.descriptionVal').val());
                                newArray.push($this.find('.vendorVal').val());
                                newArray.push(data.DATValueM1, data.DATValueM2, data.DATValueM3, data.DATValueM4, data.DATValueM5, data.DATValueM6, data.DATValueM7, data.DATValueM8, data.DATValueM9, data.DATValueM10, data.DATValueM11, data.DATValueM12, data.DATValueM13);
                                newArray.push('0');
                                newArray.push($this.find('.hdnPLElementUID').val());
                                RetailBudgetPro.Budget.FormulaPopUpAudits.push(newArray);
                            }
                            else {
                                var vendorUIDCSV = $this.find('.vendorLstDD').val();

                                data = {
                                    "PLElementUID": $this.find('.hdnPLElementUID').val(), "DATValueM1": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(decimalPlaces), "DATValueM2": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(decimalPlaces), "DATValueM3": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(decimalPlaces), "DATValueM4": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(decimalPlaces), "DATValueM5": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(decimalPlaces), "DATValueM6": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(decimalPlaces), "DATValueM7": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(decimalPlaces), "DATValueM8": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(decimalPlaces), "DATValueM9": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(decimalPlaces), "DATValueM10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()), "DATValueM11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()), "DATValueM12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(decimalPlaces),
                                    "VENDescription": $this.find('.vendorVal').val(), "DATDescription": $this.find('.descriptionVal').val(), "DATPLCategoryUID": $formSec.find('.popup-categoryID').val(), "DATDepartmentUID": $formSec.find('.popup-departmentID').val(), "DATStoreUID": $this.find('.storeUID').val(), "VendorUID": vendorUIDCSV, "LoadFromExcel": false, "CurrencyUID": $this.find('[name = "subCategoryCurrencyDD"]').val() == undefined ? RetailBudgetPro.Budget.globalCurrencyUID : $this.find('[name = "subCategoryCurrencyDD"]').val(),
                                    "TransactionDate": (amortPeriod > 1 || isTermFormulaType ? $this.find('.transactionDate').attr('data-date') : new Date()), "DayOfPeriod": (turnOnBalanceSheet && amortPeriod <= 1 && !isTermFormulaType ? $this.find('.dayOfPeriod').attr('data-day') : 15),
                                    "TermUID": (!turnOnBalanceSheet || $this.find('[name="subCategoryTermDD"] option:selected').val() == "" ? -1 : $this.find('[name="subCategoryTermDD"] option:selected').val()), "AmortizePeriod": amortPeriod
                                };

                                oldArray.unshift('-');
                                oldArray.push($this.parents('.formulamodal-sec').find('.popup-categoryID').val());
                                oldArray.push($this.find('.storeUID').val());
                                oldArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");
                                if ($this.find('.hdnPLElementUID').val() != "-1") {

                                    oldArray.push($this.find('[type="text"].descriptionVal').siblings('span').html());
                                    oldArray.push(oldVendorVal);

                                    if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && !isNonFinCat) {
                                        if ($this.find('.dateLst').hasClass('isTransactionDate'))
                                            oldArray.push($this.find('.dateLst .transactionDateDiv .transactionSpan').attr('data-value'));
                                        else
                                            oldArray.push(GetOrdinalValue($this.find('.dateLst .dayOfPeriodDiv .transactionSpan').attr('data-value')));

                                        oldArray.push($this.find('.termLst .termSpan').html());
                                        oldArray.push($this.find('.amortizePeriodLst span').html());
                                    }

                                    $this.find('input[type="text"].DATVal').each(function () {
                                        oldArray.push(ConvertCurrencyStringToDecimal($(this).siblings('span:eq(0)').attr('data-editvalue')));
                                    })

                                    //$this.find('[type="text"]').siblings('span').filter(function () {
                                    //    if ($(this).siblings('[type="text"]').hasClass('vendorVal') || $(this).siblings('[type="text"]').hasClass('descriptionVal'))
                                    //        oldArray.push($(this).html());
                                    //    else if ($(this).parents('td').hasClass('currencyLst')) oldArray.push($(this).parents('td').find('[name="subCategoryCurrencyDD"]').val());
                                    //    else
                                    //        oldArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                                    //});
                                }
                                else {
                                    if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) 
                                        oldArray.push("", "", "", "", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                                    else
                                        oldArray.push("", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                                }
                                    
                                oldArray.push('0');
                                oldArray.push($this.find('.hdnPLElementUID').val());

                                RetailBudgetPro.Budget.FormulaPopUpAudits.push(oldArray);

                                newArray.unshift('+');
                                newArray.push($this.parents('.formulamodal-sec').find('.popup-categoryID').val());
                                newArray.push($this.find('.storeUID').val());
                                newArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");
                                newArray.push($this.find('.descriptionVal').val());
                                newArray.push(newVendorVal);

                                if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && !isNonFinCat) {
                                    newArray.push((data.AmortizePeriod > 1 ? data.TransactionDate : GetOrdinalValue(data.DayOfPeriod)), (data.TermUID == -1 ? "" : $this.find('[name="subCategoryTermDD"] option:selected').html()), data.AmortizePeriod);
                                }

                                newArray.push(data.DATValueM1, data.DATValueM2, data.DATValueM3, data.DATValueM4, data.DATValueM5, data.DATValueM6, data.DATValueM7, data.DATValueM8, data.DATValueM9, data.DATValueM10, data.DATValueM11, data.DATValueM12);
                                newArray.push('0');
                                newArray.push($this.find('.hdnPLElementUID').val());

                                RetailBudgetPro.Budget.FormulaPopUpAudits.push(newArray);
                            }

                            dataObj.push(data);
                        });
                    }

                });

                //adding dummy data in audit activity in case no changes are made to the popup data
                if (RetailBudgetPro.Budget.FormulaPopUpAudits.length == 0) {
                    var oldArray = [];
                    oldArray.unshift('-');
                    oldArray.push("-1");
                    oldArray.push("-1");
                    oldArray.push("FINANCIAL");

                    if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12)
                        oldArray.push("", "", "", "", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                    else
                        oldArray.push("", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");

                    oldArray.push('0');
                    oldArray.push("-1");

                    RetailBudgetPro.Budget.FormulaPopUpAudits.push(oldArray);
                }

                if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                    var rowString = '';

                    $('.expanded').map(function (v) {
                        rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                    });

                    var $linkedRow = $('.linked-category-data[data-target="#' + $formaulaModal.attr('id') + '"]').parents('tr');

                    var $activeRow = $linkedRow.prevAll('[data-level=' + ($linkedRow.attr('data-level') - 1) + ']').eq(0);

                    localStorage.setItem("ActiveRow", $activeRow.find('#hdnStoreUID').html() + '|' + $activeRow.find('#hdnDeptUID').html() + '|' + $activeRow.find('#hdnCatUID').html());

                    localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                }

                localStorage.setItem("ExpandRows", "True");

                var stores = [];
                var groupedcategory = $('[name=groupedcategory] :selected').val();
                var stores = $('[name=lstStores]').val().toString();
                var level = "0";
                var viewLevel = "STORE";
                var storeID = "-1";
                var deptID = "-1";
                var categoryID = "-1";
                var bsMode = (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                var venDescription = "";
                if ($('#ShowVendor').val() == "True") {
                    venDescription = $formaulaModal.find('table.total-summary-row tbody td.vendorLst select').val() == null ? null : $formaulaModal.find('table.total-summary-row tbody td.vendorLst select').val().join();
                }
                else {
                    venDescription = $formaulaModal.find('table.total-summary-row tbody td.vendorTd .ven-desc[type=text]').val();
                }

                $.ajax({
                    url: '/Budget/SaveRelatedCategoryData',
                    type: 'POST',
                    async: true,
                    dataType: 'html',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ data: dataObj, lstStoreComponentData: storeDataObj, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, FormulaID: $('#' + $formaulaModal.attr('id')).find('.popup-formulaId').val(), FormulaType: $('#' + $formaulaModal.attr('id')).find('.popup-formulatype').val(), VENDescription: venDescription, AuditData: RetailBudgetPro.Budget.FormulaPopUpAudits, decimalPlaces, vendorIdCSV: $('[name="datapageVendordd"]').val() == undefined ? "-2" : $('[name="datapageVendordd"]').val().join(','), showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), deletedPLElementUIDCSV: (FormulaPopDeletedPLElementUIDs.length > 0 ? FormulaPopDeletedPLElementUIDs.join() : ""), bsMode: bsMode, categoryType: categoryType }),
                    success: function (data) {
                        RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                        FormulaPopDeletedPLElementUIDs = [];
                        $('#DataInputTable tbody').html('');
                        $('#DataInputTable tbody').html(data);
                        $(".hideyear").each(function () {
                            $(this).removeAttr("data-level");
                        });
                        $('#DataInputTable').find('.displayVendor').addClass('hide');
                        $('#DataInputTable').tabelize();
                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                        $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                        $('.hideyear').find('td:first').html('');
                    }
                });
            }
        },
        CopyPeriodValuesToRow: function () {

            if ($(this).parents('.payrollModal').find('[name="EmployeePayroll.EmpTypeSP"]').val() == "P" || $(this).parents('.modal').hasClass('CopyDataModal') || $(this).parents('.modal').hasClass('CopyDataModalBS')) {
                var firstPeriodVal = $(this).parents('tr').find('td:not(.vendorLst) [type=text]:not([readonly]):not(.descriptionVal):not([disabled]):not(.vendorVal)').eq(0).val();
                $(this).parents('tr').find('td:not(.vendorLst) [type=text]:not([readonly]):not([title="Average"]):not([title="Total"]):not(.descriptionVal):not(.vendorVal)').each(function () {
                    $(this).val(firstPeriodVal).trigger('change');
                });
            }
            else {

                if ($(this).hasClass('copy-amount')) {
                    var tdSelector = $(this).parents('.payrollModal').find('[name="EmployeePayroll.CompType"]').val() == "S" && $(this).parents('div').hasClass('allocationSalaryCheck') ? ($('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" ? "td.percentage" : "td.data") : "td";
                    var firstPeriodVal = $(this).parents('.store-data-row').find(tdSelector + ' input[type="text"][data-period*="P"]:not([readonly]):not([disabled])').eq(0).val();
                    $(this).parents('.store-data-row').find(tdSelector + ' [type=text]').not('input[type="text"][data-Period="P01"], input[type="text"][title="Total"],input[type="text"][title=Comment], input[readonly]').each(function () {
                        $(this).val(firstPeriodVal).trigger('change');
                    });
                }
                else if ($(this).parents('tr').hasClass('allocation-data-row')) {
                    var firstPeriodVal = $(this).parents('tr').find('td input[type="text"][data-period*="P"]:not([readonly]):not([disabled])').eq(0).val();
                    $(this).parents('.store-data-row').find('[type=text]').not('input[type="text"][data-Period="P01"], input[type="text"][title="Total"], input[type="text"][title="EADescription"],input[type="text"][title=Comment], input[readonly]').each(function () {
                        $(this).val(firstPeriodVal).trigger('change');
                    });
                }
                else if ($(this).hasClass('store-grid')) {
                    var firstPeriodVal = $(this).parents(".store-data-row").find('[type=text][data-period*="P"]:not([readonly]):not([disabled])').eq(0).val();
                    $(this).parents('.store-data-row').find('[type=text]:not(#StoreDataP01):not([readonly])').each(function () {
                        $(this).val(firstPeriodVal).trigger('change');
                    });
                }
                else if ($(this).parents('table').hasClass('bsData')) {
                    var firstPeriodVal = $(this).parents('tr').find('.DATVal:not(.lockedMonths):first()').val().replace(/,/g, '');
                    $(this).parents('tr').find('.DATVal:not(.lockedMonths)').each(function () {
                        $(this).val(firstPeriodVal).trigger('change');
                    });
                }
                else {
                    var firstPeriodVal = $(this).parents(".noFormulaRow").find(".DATVal:not(.disableByTransaction):not([readonly]):not([disabled])").eq(0).val();
                    $(this).parents('.noFormulaRow').find('.DATVal:not(:eq(0)):not([readonly]):not(.disableByTransaction)').each(function () {
                        $(this).val(firstPeriodVal).trigger('change');
                    });
                }
            }

            if ($(this).parents('div.formulamodal').hasClass('payrollModal')) {
                HireDateCheck('#' + $(this).parents('.payrollModal').attr('id'));
            }
            DisableInActivePeriods('#' + $(this).parents('.payrollModal').attr('id'));
            DisableLockedPeriods();

            if ($(this).parents('div.linkedCurrencymodal').length > 0) //linked currency pop-up
            {
                var p1val = $(this).parents('tr').find('.DATVal:not([readonly])').eq(0).val();
                $(this).parents('tr.editableRow').find('td input.DATVal:not([readonly])').each(function () {
                    $(this).val(p1val);
                });
            }
        },
        DistributeTotalEvenly: function () {

            var isRelatedCurrencyPopup = $(this).parents('div.linkedCurrencymodal').length > 0;

            var $periods = getNumberOfPeriods();
            //get totals value  
            
            var total = ConvertCurrencyStringToDecimal(isRelatedCurrencyPopup ? ($(this).parents('tr.editableRow').find('.rowTotal').val()) : ($(this).parents('.noFormulaRow').find('.rowTotal').val()));
            var decimalPlaces = isRelatedCurrencyPopup ? $(this).parents('div.modal-body').find('.popup-decimalPlaces').val() : $(this).parents('.formulamodal-sec').find('.popup-decimalPlaces').val();

            var $parentRow = isRelatedCurrencyPopup ? $(this).parents('tr.editableRow') : $(this).parents('.noFormulaRow');

            var periodRowValue = (total / $periods).toFixed(decimalPlaces);
            var lastPeriodValue = (total - (total / $periods).toFixed(parseInt(decimalPlaces)) * ($periods - 1)).toFixed(decimalPlaces);

            $parentRow.find('.P01Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P02Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P03Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P04Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P05Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P06Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P07Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P08Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P09Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P10Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);
            $parentRow.find('.P11Val:not(.removeBackgndColor):not(.disableByTransaction)').val(periodRowValue);

            if ($periods == 12) {
                $parentRow.find('.P12Val:not(.removeBackgndColor):not(.disableByTransaction)').val(lastPeriodValue);
            }
            else {
                $parentRow.find('.P12Val:not(.removeBackgndColor)').val(periodRowValue);
                $parentRow.find('.P13Val:not(.removeBackgndColor)').val(lastPeriodValue);
            }
        },
        LinkToDataPage: function () {
            var Id = $(this).attr('data-catid');
            var url = $(this).attr('data-href');
            var type = '';
            $.ajax({
                url: '/Dashboard/RouteToDataPageWithGroupSelected',
                type: 'POST',
                data: JSON.stringify({ ID: Id, Type: type, Stores: $('[name=lstStores]').val() }),
                dataType: 'html',
                async: false,
                contentType: "application/json; charset=UTF-8",
                success: function (data) {
                    //window.location = url;
                },
                error: function (err) {
                    console.log(err);
                }
            });
        },
        CheckModalRow: function () {
            var $parentRow = $(this).parents('.store-data-row');

            if ($parentRow.parents('.formulamodal-sec').hasClass('allocationHourCheck') || $parentRow.parents('.formulamodal-sec').hasClass('allocationHourlyRateCheck') || $parentRow.parents('.formulamodal-sec').hasClass('overtimeHourCheck') || $parentRow.parents('.formulamodal-sec').hasClass('overtimeHourlyRateCheck') || $parentRow.parents('.formulamodal-sec').hasClass('allocationSalaryCheck')) {
                if ($(this).is(':checked')) {
                    $parentRow.find('[type=text]').val('0').removeClass('readonlyTxt').removeAttr('readonly');
                    $parentRow.find('.copyPeriodValues').removeClass('hide');
                    $parentRow.find('.periodRedistribute').removeClass('hide');
                    $parentRow.find('.payrollDistributeEvenly').removeClass('hide');
                }
                else {
                    $parentRow.find('[type=text]').val('').addClass('readonlyTxt').attr('readonly', 'readonly');
                    $parentRow.find('.copyPeriodValues').addClass('hide');
                    $parentRow.find('.periodRedistribute').addClass('hide');
                    $parentRow.find('.payrollDistributeEvenly').addClass('hide');
                }
            }
            else if ($(this).is(':checked')) {
                $parentRow.find('[type=text]').val('0').removeClass('disabledTxt').removeAttr('disabled');
            }
            else {
                $parentRow.find('[type=text]').val('').addClass('disabledTxt').attr('disabled', 'disabled');
            }
        },
        SelectAllStores: function () {
            $('.locationRowCheck').prop('checked', true);
            $(this).parents('table.table').find('[type=text]:disabled').val('0');
            $(this).parents('table.table').find('[type=text]').removeClass('disabledTxt').removeAttr('disabled');
        },
        UnselectAllStores: function () {
            $('.locationRowCheck').prop('checked', false);
            $(this).parents('table.table').find('[type=text]').val('').addClass('disabledTxt').attr('disabled', 'disabled');
        },
        CancelChangeBudgetYearBtnClick: function () {
            $(this).addClass('hide');
            $('.datainput-header.budYear').removeClass('hide');
            $('.tbudgetYearDropDown').addClass('hide');
            $('.change-budgetYear').removeClass('hide');
        },
        ChangeBudgetYearBtnClick: function () {
            $(this).addClass('hide');
            $('.datainput-header.budYear').addClass('hide');
            $('.tbudgetYearDropDown').removeClass('hide');
            $('.cancel-change-budgetYear').removeClass('hide');

            $('.tbudgetYearDropDown').select2('val', $('#hdnBudgetYear').val());
        },
        BudgetYearDropDownChange: function () {

            var currentBudgetYear = parseInt($('#hdnBudgetYear').val());

            var $this = this;

            var selectedBudgetId = parseInt($('[name=BudgetUID]').val());

            var selectedYear = parseInt($($this).val());

            if (currentBudgetYear != selectedYear) {
                location.href = '/Budget/DataInput/' + selectedBudgetId + "/" + selectedYear;
            }

        },
        SubCatDocumentDownload: function () {

            $parentTr = $(document).find('#' + $('#subCatDocumentPopUp .subCatRowId').val());
            var documentFolder = $parentTr.find('#hdnAttachedSubCategoryFolderName').html();
            window.location = '/Budget/DownloadSubCatDocument/' + documentFolder;
        },

        SubCatDocumentDelete: function () {

            $parentTr = $(document).find('#' + $('#subCatDocumentPopUp .subCatRowId').val());

            $this = $parentTr.find('.hasFile');

            var DeleteFromDb = false;

            if ($this.hasClass('downloadLinkedDocument'))
                DeleteFromDb = true

            $('.layout').show();

            $.ajax({
                url: '/Budget/DeleteAttachedFolder',
                type: 'POST',
                async: true,
                dataType: 'json',
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify({ PLElementUID: $parentTr.find('#hdnPLElementUID').text(), FolderName: $parentTr.find('#hdnAttachedSubCategoryFolderName').text(), DeleteFromDb: DeleteFromDb }),
                success: function (data) {
                    $parentTr.find('#hdnAttachedSubCategoryFolderName').text('');
                    $parentTr.find('#hdnAttachedSubCategoryFolderName').attr('data-attachedfolder', '');
                    $this.removeClass('downloadLinkedDocument documentUpload hasFile').addClass('documentUpload');
                    $this.attr('title', 'Upload document');
                    $this.find('i').removeClass('icon-red downloadDocumentFile');
                    $this.parents('.action-btn').find('input.documentFile').val('');
                    $('.layout').hide();
                }
            });
        },

        SubCatDocumentBtnClick: function () {

            var $this = $(this);
            var level = $(this).parents('tr').attr('data-level')
            if (!$this.parents('tr').prevAll('tr[data-level="' + (level - 1) + '"]').eq(0).hasClass('inEditMode')) {
                $parentTr = $this.parents('tr');

                var documentFolder = $parentTr.find('#hdnAttachedSubCategoryFolderName').html();

                window.location = '/Budget/DownloadSubCatDocument/' + documentFolder;
            }
            else {
                if (!$this.hasClass('hasFile')) {
                    $this.parents('.action-btn').find('input.documentFile').trigger('click');
                }
                else {
                    $('#subCatDocumentPopUp .subCatRowId').val($(this).parents('tr').attr('id'));
                    $('#subCatDocumentPopUp').modal('show');
                }
            }
        },
        CalculateRowTotal: function () {
            $formulaModal = $(this).parents('.formulamodal');

            $formulaModal.find('.totals-row-action button').removeClass('active');

            var className = $(this).attr('class').split(' ').pop();

            var divisorVal = className == 'refresh-totals' ? 1 : getNumberOfPeriods();

            $formulaModal.find('.budgets-table.vendor tbody tr').each(function () {

                var decimalPlaces = $(this).hasClass('total-summary-row') ? 0 : parseInt($(this).parents('.formulamodal-sec').find('.popup-decimalPlaces').val());

                var totVal = $(this).find('input[type=text].DATVal').map(function () {
                    return parseFloat($(this).val().replace(/,/g, ""));
                }).get().reduce(function (a, b) {
                    return a + b;
                });

                $(this).find('input[type=text].rowTotal').val(Number(ConvertCurrencyStringToDecimal(totVal / divisorVal).toFixed(decimalPlaces)).toLocaleString("en"));

            });

            $(this).addClass('active');
        },
        ShowAllStoreOnInpupPopup: function () {
            $('.hide-all-stores').removeClass('hide');
            $('.show-all-stores').addClass('hide');

            var parentPopUpId = $(this).parents('.formulamodal').attr('id');

            $('#' + parentPopUpId).find('.other-store').removeClass('hide');
            $('#' + parentPopUpId).find('.store-col').removeClass('hide');

            $('#' + parentPopUpId).find('.add-new-line').addClass('hide');

        },
        HideAllStoreOnInpupPopup: function () {
            $('.show-all-stores').removeClass('hide');
            $('.hide-all-stores').addClass('hide');

            var parentPopUpId = $(this).parents('.formulamodal').attr('id');

            $('#' + parentPopUpId).find('.other-store').addClass('hide');
            $('#' + parentPopUpId).find('.store-col').addClass('hide');

            $('#' + parentPopUpId).find('.add-new-line').removeClass('hide');
        },
        SaveUnapprovedDataInput: function (e) {

            var statusString = $(e.currentTarget).hasClass('submitForApproval') ? "Sent" : "Pending";

            $parentTr = $(e.currentTarget).parents('tr');

            var currentLevel = parseInt($parentTr.attr('data-level'));
            var nd = new Date();

            var finalData = [];

            var periods = getNumberOfPeriods();

            var $storeLevelNetSales = $parentTr.prevAll('.netsales.l2:last');

            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').filter(function () {

                if ($(this).find('#hdnCatCalucaltedOn').length == 0 || $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {

                    var hasAnyChange = 0;

                    if (statusString == "Sent" && $(this).hasClass('unapproved-pending')) {
                        hasAnyChange = 1;
                    }

                    else {
                        if ($(this).find('td .isDescription').val() != $(this).find('td .isDescription').siblings('span').text()) {
                            hasAnyChange = 1;
                        }
                        else if ($('#ShowVendor').val() == "True" && $(this).find('td .isVendor option:selected').map(function () { return $(this).text().trim() }).get().join() != ($(this).find('td .vendor-info-modal').length > 0 ? $(this).find('td .vendor-info-modal li').map(function () { return $(this).text().trim() }).get().join() : $(this).find('td span.vendor').text().trim())) {
                            hasAnyChange = 1;
                        }
                        else if ($('#ShowVendor').val() == "False" && $(this).find('td .isVendor').val() != $(this).find('td .isVendor').siblings('span').text()) {
                            hasAnyChange = 1;
                        }
                        else if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" && $(this).find('[name="subCategoryCurrencyDD"] option:selected').html().trim() != $(this).find('td.currencyLst span.currency').html().trim()) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P01').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P01').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P02').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P02').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P03').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P03').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P04').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P04').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P05').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P05').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P06').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P06').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P07').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P07').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P08').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P08').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P09').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P09').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P10').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P10').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P11').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P11').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P12').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P12').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                        else if (periods > 12 && ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P13').val()) != ConvertCurrencyStringToDecimal($(this).find('td:not(.percentage) .P13').siblings('span').text())) {
                            hasAnyChange = 1;
                        }
                    }

                    if (hasAnyChange == 1) return this;
                }

            });

            if ($rowsToSearch.length > 0) {

                $('.layout').show();

                var NetSales = [];

                for (var counterVar = 0; counterVar < periods; counterVar++) {
                    NetSales["DATValueM" + (counterVar + 1)] = ConvertCurrencyStringToDecimal($storeLevelNetSales.find('.data.DATValueM' + (counterVar + 1) + 'F').text());
                }

                if ($('#btnPercentage').hasClass('active')) {

                }
                else {
                    $rowsToSearch.each(function () {
                        if ($(this).find('#hdnCatCalucaltedOn').length == 0 || $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {
                            NetSales["DATValueM1"] = NetSales["DATValueM1"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val());
                            NetSales["DATValueM2"] = NetSales["DATValueM2"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val());
                            NetSales["DATValueM3"] = NetSales["DATValueM3"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val());
                            NetSales["DATValueM4"] = NetSales["DATValueM4"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val());
                            NetSales["DATValueM5"] = NetSales["DATValueM5"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val());
                            NetSales["DATValueM6"] = NetSales["DATValueM6"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val());
                            NetSales["DATValueM7"] = NetSales["DATValueM7"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val());
                            NetSales["DATValueM8"] = NetSales["DATValueM8"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val());
                            NetSales["DATValueM9"] = NetSales["DATValueM9"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val());
                            NetSales["DATValueM10"] = NetSales["DATValueM10"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val());
                            NetSales["DATValueM11"] = NetSales["DATValueM11"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val());
                            NetSales["DATValueM12"] = NetSales["DATValueM12"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val());
                            NetSales["DATValueM13"] = NetSales["DATValueM13"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').val());
                        }
                    });
                }

                $rowsToSearch.each(function () {
                    if ($(this).find('#hdnCurrentComment').html().trim() != "") {
                        var textToAppend = $(this).find('#hdnComment').text() + "<br/><img class='img-circle layout-menu-image' src=" + $("input[name='hdnUSRProfilePic']").val() + " /><b>" + $('#hdnCurrentUser').val() + " " + (nd.getMonth() + 1) + "/" + nd.getDate() + "/" + nd.getFullYear() + "</b> : " + $(this).find('#hdnCurrentComment').html().trim();

                        $(this).find('#hdnComment').text(textToAppend);
                        $(this).find('#hdnCurrentComment').html('');
                    }
                });

                $rowsToSearch.each(function () {
                    if ($(this).find('#hdnCatCalucaltedOn').length == 0 || $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {
                        data = {};
                        if (periods > 12) {
                            data = {
                                "DATValueM1": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()), "DATValueM2": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()),
                                "DATValueM3": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()), "DATValueM4": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()),
                                "DATValueM5": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()), "DATValueM6": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()),
                                "DATValueM7": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()), "DATValueM8": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()),
                                "DATValueM9": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()), "DATValueM10": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()),
                                "DATValueM11": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()), "DATValueM12": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()),
                                "DATValueM13": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').val()),
                                "DATValueM1P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()) * 100 / NetSales["DATValueM1"],
                                "DATValueM2P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()) * 100 / NetSales["DATValueM2"],
                                "DATValueM3P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()) * 100 / NetSales["DATValueM3"],
                                "DATValueM4P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()) * 100 / NetSales["DATValueM4"],
                                "DATValueM5P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()) * 100 / NetSales["DATValueM5"],
                                "DATValueM6P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()) * 100 / NetSales["DATValueM6"],
                                "DATValueM7P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()) * 100 / NetSales["DATValueM7"],
                                "DATValueM8P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()) * 100 / NetSales["DATValueM8"],
                                "DATValueM9P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()) * 100 / NetSales["DATValueM9"],
                                "DATValueM10P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()) * 100 / NetSales["DATValueM10"],
                                "DATValueM11P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()) * 100 / NetSales["DATValueM11"],
                                "DATValueM12P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()) * 100 / NetSales["DATValueM12"],
                                "DATValueM13P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').val()) * 100 / NetSales["DATValueM13"],
                                "DATNetSalesM1": NetSales["DATValueM1"], "DATNetSalesM2": NetSales["DATValueM2"],
                                "DATNetSalesM3": NetSales["DATValueM3"], "DATNetSalesM4": NetSales["DATValueM4"],
                                "DATNetSalesM5": NetSales["DATValueM5"], "DATNetSalesM6": NetSales["DATValueM6"],
                                "DATNetSalesM7": NetSales["DATValueM7"], "DATNetSalesM8": NetSales["DATValueM8"],
                                "DATNetSalesM9": NetSales["DATValueM9"], "DATNetSalesM10": NetSales["DATValueM9"],
                                "DATNetSalesM11": NetSales["DATValueM11"], "DATNetSalesM12": NetSales["DATValueM10"],
                                "DATNetSalesM13": NetSales["DATValueM13"],
                                "VENDescription": $(this).find('td').eq(2).find('input[type=text]').val(), "DATDescription": $(this).find('.isDescription').val(), 
                                "DATPLCategoryUID": $(this).find('#hdnCatUID').text(), "DATDepartmentUID": $(this).find('#hdnDeptUID').text(),
                                "DATStoreUID": $(this).find('#hdnStoreUID').text(), "DATVendorUID": $(this).find('#hdnVendorUID').text(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').text(), "Comments": $(this).find('#hdnComment').text() == "" ? undefined : $(this).find('#hdnComment').text(),
                                "LoadFromExcel": $(this).find('#hdnFromExcel').html() == "" ? false : true,
                                "ExcelRowNumber": parseInt($('[name=RowNumber]').val() == "" ? "0" : $('[name=RowNumber]').val()), "ExcelFolderName": $(this).find('#hdnFromExcel').html(),
                                "AttachedSubCategoryFolderName": $(this).find('#hdnAttachedSubCategoryFolderName').html(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').html().trim(),
                                "UnApprovedPLElementUID": $(this).find('#hdnPLElementUnApprovedUID').length == 0 ? '-1' : $(this).find('#hdnPLElementUnApprovedUID').html().trim(),
                                "VendorUIDCSV": $(this).find('.drpdwnvendor').val() != undefined ? $(this).find('.drpdwnvendor').val().join() : "",
                                "CurrencyUID": (($('[name="groupedcategory"] option[value$="|' + $(this).find('#hdnCatUID').text() + '"]').data('isfinancialcat') == "True") ? (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? $(this).find('[name="subCategoryCurrencyDD"]').val() : RetailBudgetPro.Budget.globalCurrencyUID) : -1)
                            };
                        }
                        else {
                            data = {
                                "DATValueM1": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()), "DATValueM2": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()),
                                "DATValueM3": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()), "DATValueM4": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()),
                                "DATValueM5": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()), "DATValueM6": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()),
                                "DATValueM7": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()), "DATValueM8": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()),
                                "DATValueM9": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()), "DATValueM10": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()),
                                "DATValueM11": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()), "DATValueM12": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()),
                                "DATValueM1P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()) * 100 / NetSales["DATValueM1"],
                                "DATValueM2P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()) * 100 / NetSales["DATValueM2"],
                                "DATValueM3P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()) * 100 / NetSales["DATValueM3"],
                                "DATValueM4P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()) * 100 / NetSales["DATValueM4"],
                                "DATValueM5P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()) * 100 / NetSales["DATValueM5"],
                                "DATValueM6P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()) * 100 / NetSales["DATValueM6"],
                                "DATValueM7P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()) * 100 / NetSales["DATValueM7"],
                                "DATValueM8P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()) * 100 / NetSales["DATValueM8"],
                                "DATValueM9P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()) * 100 / NetSales["DATValueM9"],
                                "DATValueM10P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()) * 100 / NetSales["DATValueM10"],
                                "DATValueM11P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()) * 100 / NetSales["DATValueM11"],
                                "DATValueM12P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()) * 100 / NetSales["DATValueM12"],
                                "DATNetSalesM1": NetSales["DATValueM1"], "DATNetSalesM2": NetSales["DATValueM2"],
                                "DATNetSalesM3": NetSales["DATValueM3"], "DATNetSalesM4": NetSales["DATValueM4"],
                                "DATNetSalesM5": NetSales["DATValueM5"], "DATNetSalesM6": NetSales["DATValueM6"],
                                "DATNetSalesM7": NetSales["DATValueM7"], "DATNetSalesM8": NetSales["DATValueM8"],
                                "DATNetSalesM9": NetSales["DATValueM9"], "DATNetSalesM10": NetSales["DATValueM9"],
                                "DATNetSalesM11": NetSales["DATValueM11"], "DATNetSalesM12": NetSales["DATValueM12"],
                                "VENDescription": $(this).find('td').eq(2).find('input[type=text]').val(), "DATDescription": $(this).find('.isDescription').val(),
                                "DATPLCategoryUID": $(this).find('#hdnCatUID').text(), "DATDepartmentUID": $(this).find('#hdnDeptUID').text(),
                                "DATStoreUID": $(this).find('#hdnStoreUID').text(), "DATVendorUID": $(this).find('#hdnVendorUID').text(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').text(), "Comments": $(this).find('#hdnComment').text() == "" ? undefined : $(this).find('#hdnComment').text(),
                                "LoadFromExcel": $(this).find('#hdnFromExcel').html() == "" ? false : true,
                                "ExcelRowNumber": parseInt($('[name=RowNumber]').val() == "" ? "0" : $('[name=RowNumber]').val()), "ExcelFolderName": $(this).find('#hdnFromExcel').html(),
                                "AttachedSubCategoryFolderName": $(this).find('#hdnAttachedSubCategoryFolderName').html(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').html().trim(),
                                "UnApprovedPLElementUID": $(this).find('#hdnPLElementUnApprovedUID').length == 0 ? '-1' : $(this).find('#hdnPLElementUnApprovedUID').html().trim(),
                                "VendorUIDCSV": $(this).find('.drpdwnvendor').val() != undefined ? $(this).find('.drpdwnvendor').val().join() : "",
                                "CurrencyUID": (($('[name="groupedcategory"] option[value$="|' + $(this).find('#hdnCatUID').text() + '"]').data('isfinancialcat') == "True") ? (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? $(this).find('[name="subCategoryCurrencyDD"]').val() : RetailBudgetPro.Budget.globalCurrencyUID) : -1)
                            };
                        }
                        finalData.push(data);
                    }
                });

                //console.log(finalData);                

                var stores = [];
                var groupedcategory = $('[name=groupedcategory] :selected').val();
                var stores = $('[name=lstStores]').val().toString();
                //var level = "1";
                //var viewLevel = "CATEGORY";
                //var storeID = $parentTr.find('#hdnStoreUID').html();
                //var deptID = $parentTr.find('#hdnDeptUID').html();
                //var categoryID = $parentTr.find('#hdnCatUID').html();
                var level = "0";
                var viewLevel = "STORE";
                var storeID = "-1";
                var deptID = "-1";
                var categoryID = "-1";

                if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                    var rowString = '';

                    $('.expanded').map(function (v) {
                        rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                    });

                    localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                    localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                }

                localStorage.setItem("ExpandRows", "True");


                $.ajax({
                    url: '/Budget/SaveUnApprovedDataInput',
                    type: 'POST',
                    async: true,
                    dataType: 'json',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ data: finalData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, statusString: statusString }),
                    success: function (data) {


                        //ComputeLevel($parentTr, "");
                        //// show sorting of vendor buttons when it is not in editable mode.
                        //$parentTr.find('.sort-vendor').show();
                        //$parentTr.find('.sort-description').show();
                        //// Remove editable mode once the data is saved.
                        //RemoveEditableMode($parentTr);
                        //$parentTr.nextAll('.doNotExpand').find('.temp').removeClass('temp');

                        //$('.commentModal .comment').val('');

                        //RemoveEditableMode($parentTr);

                        var trLevel = $parentTr.data('level');
                        var stopLevel = $('[name="groupedcategory"] :selected').hasClass('boldGroup') ? ($('[name="groupedcategory"] :selected').nextUntil('.boldGroup').length > 1 ? trLevel : (trLevel - 1)) : (trLevel - 1);

                        $parentTr.find('td:first .expander').trigger('click');
                        $parentTr.find('td:first .sort-description,.action-items').remove();
                        $parentTr.nextUntil('tr[data-level="' + stopLevel + '"]', 'tr:not(.historicaldata.hideyear.level' + trLevel + ',.totals.level' + trLevel + '.hideyear,.LevelPercentLY.level' + trLevel + '.hideyear)').remove();
                        $parentTr.addClass('budgetdata');
                        $parentTr.find('td:first .expander').trigger('click');

                    },
                    error: function (err) {
                        console.log(err);
                        $('.layout').hide();
                    }
                });
            }

            else {
                RetailBudgetPro.Budget.showAlertOnUndoChanges = 0;
                $parentTr.find('.action-items .undo').trigger('click');
            }

            //return false;
        },

        SaveApprovedRejectedDataInput: function () {

            $parentTr = $(document).find('tr.expanded:not(blurView)').has('#hdnViewLevel:containsExact("CATEGORY")');

            var currentLevel = parseInt($parentTr.attr('data-level'));
            var nd = new Date();

            var finalData = [];

            var periods = getNumberOfPeriods();

            var $storeLevelNetSales = $parentTr.prevAll('.netsales.l2:last');

            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').has('.selectRowToDelete:checked');

            if ($rowsToSearch.length > 0) {

                $('.layout').show();

                var NetSales = [];

                for (var counterVar = 0; counterVar < periods; counterVar++) {
                    NetSales["DATValueM" + (counterVar + 1)] = ConvertCurrencyStringToDecimal($storeLevelNetSales.find('.data.DATValueM' + (counterVar + 1) + 'F').text());
                }

                if ($('#btnPercentage').hasClass('active')) {

                }
                else {
                    $rowsToSearch.each(function () {
                        if ($(this).find('#hdnCatCalucaltedOn').length == 0 || $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {
                            NetSales["DATValueM1"] = NetSales["DATValueM1"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val());
                            NetSales["DATValueM2"] = NetSales["DATValueM2"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val());
                            NetSales["DATValueM3"] = NetSales["DATValueM3"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val());
                            NetSales["DATValueM4"] = NetSales["DATValueM4"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val());
                            NetSales["DATValueM5"] = NetSales["DATValueM5"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val());
                            NetSales["DATValueM6"] = NetSales["DATValueM6"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val());
                            NetSales["DATValueM7"] = NetSales["DATValueM7"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val());
                            NetSales["DATValueM8"] = NetSales["DATValueM8"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val());
                            NetSales["DATValueM9"] = NetSales["DATValueM9"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val());
                            NetSales["DATValueM10"] = NetSales["DATValueM10"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val());
                            NetSales["DATValueM11"] = NetSales["DATValueM11"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val());
                            NetSales["DATValueM12"] = NetSales["DATValueM12"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val());
                            NetSales["DATValueM13"] = NetSales["DATValueM13"] - ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').next('span').text()) + ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').val());
                        }
                    });
                }

                $rowsToSearch.each(function () {
                    if ($(this).find('#hdnCurrentComment').html().trim() != "") {
                        var textToAppend = $(this).find('#hdnComment').text() + "<br/><img class='img-circle layout-menu-image' src=" + $("input[name='hdnUSRProfilePic']").val() + " /><b>" + $('#hdnCurrentUser').val() + " " + (nd.getMonth() + 1) + "/" + nd.getDate() + "/" + nd.getFullYear() + "</b> : " + $(this).find('#hdnCurrentComment').html().trim();

                        $(this).find('#hdnComment').text(textToAppend);
                        $(this).find('#hdnCurrentComment').html('');
                    }
                });

                $rowsToSearch.each(function () {
                    if ($(this).find('#hdnCatCalucaltedOn').length == 0 || $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {
                        data = {};
                        if (periods > 12) {
                            data = {
                                "DATValueM1": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()), "DATValueM2": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()),
                                "DATValueM3": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()), "DATValueM4": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()),
                                "DATValueM5": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()), "DATValueM6": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()),
                                "DATValueM7": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()), "DATValueM8": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()),
                                "DATValueM9": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()), "DATValueM10": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()),
                                "DATValueM11": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()), "DATValueM12": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()),
                                "DATValueM13": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').val()),
                                "DATValueM1P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()) * 100 / NetSales["DATValueM1"],
                                "DATValueM2P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()) * 100 / NetSales["DATValueM2"],
                                "DATValueM3P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()) * 100 / NetSales["DATValueM3"],
                                "DATValueM4P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()) * 100 / NetSales["DATValueM4"],
                                "DATValueM5P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()) * 100 / NetSales["DATValueM5"],
                                "DATValueM6P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()) * 100 / NetSales["DATValueM6"],
                                "DATValueM7P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()) * 100 / NetSales["DATValueM7"],
                                "DATValueM8P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()) * 100 / NetSales["DATValueM8"],
                                "DATValueM9P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()) * 100 / NetSales["DATValueM9"],
                                "DATValueM10P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()) * 100 / NetSales["DATValueM10"],
                                "DATValueM11P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()) * 100 / NetSales["DATValueM11"],
                                "DATValueM12P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()) * 100 / NetSales["DATValueM12"],
                                "DATValueM13P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM13F]').val()) * 100 / NetSales["DATValueM13"],
                                "DATNetSalesM1": NetSales["DATValueM1"], "DATNetSalesM2": NetSales["DATValueM2"],
                                "DATNetSalesM3": NetSales["DATValueM3"], "DATNetSalesM4": NetSales["DATValueM4"],
                                "DATNetSalesM5": NetSales["DATValueM5"], "DATNetSalesM6": NetSales["DATValueM6"],
                                "DATNetSalesM7": NetSales["DATValueM7"], "DATNetSalesM8": NetSales["DATValueM8"],
                                "DATNetSalesM9": NetSales["DATValueM9"], "DATNetSalesM10": NetSales["DATValueM9"],
                                "DATNetSalesM11": NetSales["DATValueM11"], "DATNetSalesM12": NetSales["DATValueM10"],
                                "DATNetSalesM13": NetSales["DATValueM13"],
                                "VENDescription": $(this).find('.isVendor').val(), "DATDescription": $(this).find('.isDescription').val(),
                                "DATPLCategoryUID": $(this).find('#hdnCatUID').text(), "DATDepartmentUID": $(this).find('#hdnDeptUID').text(),
                                "DATStoreUID": $(this).find('#hdnStoreUID').text(), "DATVendorUID": $(this).find('#hdnVendorUID').text(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').text(), "Comments": $(this).find('#hdnComment').text() == "" ? undefined : $(this).find('#hdnComment').text(),
                                "LoadFromExcel": $(this).find('#hdnFromExcel').html() == "" ? false : true,
                                "ExcelRowNumber": parseInt($('[name=RowNumber]').val() == "" ? "0" : $('[name=RowNumber]').val()), "ExcelFolderName": $(this).find('#hdnFromExcel').html(),
                                "AttachedSubCategoryFolderName": $(this).find('#hdnAttachedSubCategoryFolderName').html(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').html().trim(),
                                "UnApprovedPLElementUID": $(this).find('#hdnPLElementUnApprovedUID').length == 0 ? '-1' : $(this).find('#hdnPLElementUnApprovedUID').html().trim()
                            };
                        }
                        else {
                            data = {
                                "DATValueM1": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()), "DATValueM2": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()),
                                "DATValueM3": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()), "DATValueM4": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()),
                                "DATValueM5": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()), "DATValueM6": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()),
                                "DATValueM7": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()), "DATValueM8": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()),
                                "DATValueM9": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()), "DATValueM10": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()),
                                "DATValueM11": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()), "DATValueM12": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()),
                                "DATValueM1P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM1F]').val()) * 100 / NetSales["DATValueM1"],
                                "DATValueM2P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM2F]').val()) * 100 / NetSales["DATValueM2"],
                                "DATValueM3P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM3F]').val()) * 100 / NetSales["DATValueM3"],
                                "DATValueM4P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM4F]').val()) * 100 / NetSales["DATValueM4"],
                                "DATValueM5P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM5F]').val()) * 100 / NetSales["DATValueM5"],
                                "DATValueM6P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM6F]').val()) * 100 / NetSales["DATValueM6"],
                                "DATValueM7P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM7F]').val()) * 100 / NetSales["DATValueM7"],
                                "DATValueM8P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM8F]').val()) * 100 / NetSales["DATValueM8"],
                                "DATValueM9P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM9F]').val()) * 100 / NetSales["DATValueM9"],
                                "DATValueM10P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM10F]').val()) * 100 / NetSales["DATValueM10"],
                                "DATValueM11P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM11F]').val()) * 100 / NetSales["DATValueM11"],
                                "DATValueM12P": ConvertCurrencyStringToDecimal($(this).find('[name=DATValueM12F]').val()) * 100 / NetSales["DATValueM12"],
                                "DATNetSalesM1": NetSales["DATValueM1"], "DATNetSalesM2": NetSales["DATValueM2"],
                                "DATNetSalesM3": NetSales["DATValueM3"], "DATNetSalesM4": NetSales["DATValueM4"],
                                "DATNetSalesM5": NetSales["DATValueM5"], "DATNetSalesM6": NetSales["DATValueM6"],
                                "DATNetSalesM7": NetSales["DATValueM7"], "DATNetSalesM8": NetSales["DATValueM8"],
                                "DATNetSalesM9": NetSales["DATValueM9"], "DATNetSalesM10": NetSales["DATValueM9"],
                                "DATNetSalesM11": NetSales["DATValueM11"], "DATNetSalesM12": NetSales["DATValueM12"],
                                "VENDescription": $(this).find('.isVendor').val(), "DATDescription": $(this).find('.isDescription').val(),
                                "DATPLCategoryUID": $(this).find('#hdnCatUID').text(), "DATDepartmentUID": $(this).find('#hdnDeptUID').text(),
                                "DATStoreUID": $(this).find('#hdnStoreUID').text(), "DATVendorUID": $(this).find('#hdnVendorUID').text(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').text(), "Comments": $(this).find('#hdnComment').text() == "" ? undefined : $(this).find('#hdnComment').text(),
                                "LoadFromExcel": $(this).find('#hdnFromExcel').html() == "" ? false : true,
                                "ExcelRowNumber": parseInt($('[name=RowNumber]').val() == "" ? "0" : $('[name=RowNumber]').val()), "ExcelFolderName": $(this).find('#hdnFromExcel').html(),
                                "AttachedSubCategoryFolderName": $(this).find('#hdnAttachedSubCategoryFolderName').html(),
                                "PLElementUID": $(this).find('#hdnPLElementUID').html().trim(),
                                "UnApprovedPLElementUID": $(this).find('#hdnPLElementUnApprovedUID').length == 0 ? '-1' : $(this).find('#hdnPLElementUnApprovedUID').html().trim()
                            };
                        }
                        finalData.push(data);
                    }
                });

                //console.log(finalData);                

                var stores = [];
                var groupedcategory = $('[name=groupedcategory] :selected').val();
                var stores = $('[name=lstStores]').val().toString();
                //var level = "1";
                //var viewLevel = "CATEGORY";
                //var storeID = $parentTr.find('#hdnStoreUID').html();
                //var deptID = $parentTr.find('#hdnDeptUID').html();
                //var categoryID = $parentTr.find('#hdnCatUID').html();
                var level = "0";
                var viewLevel = "STORE";
                var storeID = "-1";
                var deptID = "-1";
                var categoryID = "-1";
                var status = $(this).hasClass('approve-data') ? 'APPROVED' : 'REJECTED';

                if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                    var rowString = '';

                    $('.expanded').map(function (v) {
                        rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                    });

                    localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                    localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                }
                var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                localStorage.setItem("ExpandRows", "True");

                console.log(localStorage.getItem("ExpandedRows"));

                $.ajax({
                    url: '/Budget/SaveApprovedRejectedDataInput',
                    type: 'POST',
                    async: true,
                    dataType: 'html',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ data: finalData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, status: status, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), vendorIdCSV: $('[name="datapageVendordd"]').length == 0 ? "-2" : $('[name="datapageVendordd"]').val().join(','), bsMode: bsMode, categoryType: categoryType }),
                    success: function (data) {

                        //var level = $('[name="groupedcategory"] :selected').hasClass('boldGroup') ? ($('[name="groupedcategory"] :selected').nextUntil('.boldGroup').length > 1 ? 2 : 1) : 1;

                        //$parentTr.find('td:first .expander').trigger('click');
                        //$parentTr.find('td:first .sort-description,.action-items').remove();
                        //$parentTr.nextUntil('tr[data-level="' + level + '"]', 'tr:not(.historicaldata.hideyear.level2,.totals.level2.hideyear,.LevelPercentLY.level2.hideyear)').remove()
                        //$parentTr.attr('class', '').addClass('budgetdata showyear SalesIdentifier level2 l2 contracted highlight');
                        //$parentTr.find('td:first .expander').trigger('click');

                        $('#DataInputTable tbody').html('');
                        $('#DataInputTable tbody').html(data);
                        $(".hideyear").each(function () {
                            $(this).removeAttr("data-level");
                        });
                        $('#DataInputTable').find('.displayVendor').addClass('hide');
                        $('#DataInputTable').tabelize();
                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                        $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                        $('.hideyear').find('td:first').html('');

                    },
                    error: function (err) {
                        console.log(err);
                        $('.layout').hide();
                    }
                });
            }

            else {
            }

            //return false;        
        },
        SubmitDataForApproval: function (e) {
            $parentTr = $(e.currentTarget).parents('tr');

            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').has('.selectRowToSubmit:checked');

            if ($rowsToSearch.length > 0) {

                var confirmClick = function () {

                    $('.layout').show();

                    var plElementUnApprovedUIDCSV = $rowsToSearch.map(function () {
                        return $(this).find('#hdnPLElementUnApprovedUID').html().trim();
                    }).get().join();

                    //console.log(plElementUnApprovedUIDCSV);

                    if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                        var rowString = '';

                        $('.expanded').map(function (v) {
                            rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                        });

                        localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                        localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                    }

                    localStorage.setItem("ExpandRows", "True");

                    console.log(localStorage.getItem("ExpandedRows"));

                    $.ajax({
                        url: '/Budget/SubmitDataForApproval',
                        type: 'POST',
                        async: true,
                        dataType: 'json',
                        contentType: "application/json; charset=UTF-8",
                        data: JSON.stringify({ plElementUnApprovedUIDCSV: plElementUnApprovedUIDCSV }),
                        success: function (data) {

                            var trLevel = $parentTr.data('level');
                            var stopLevel = $('[name="groupedcategory"] :selected').hasClass('boldGroup') ? ($('[name="groupedcategory"] :selected').nextUntil('.boldGroup').length > 1 ? trLevel : (trLevel - 1)) : (trLevel - 1);

                            $parentTr.find('td:first .expander').trigger('click');
                            $parentTr.find('td:first .sort-description,.action-items').remove();
                            $parentTr.nextUntil('tr[data-level="' + stopLevel + '"]', 'tr:not(.historicaldata.hideyear.level' + trLevel + ',.totals.level' + trLevel + '.hideyear,.LevelPercentLY.level' + trLevel + '.hideyear)').remove();
                            $parentTr.addClass('budgetdata');
                            $parentTr.find('td:first .expander').trigger('click');

                        },
                        error: function (err) {
                            console.log(err);
                            $('.layout').hide();
                        }
                    });

                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Are you sure you want to submit for approval?");

            }

            else {

                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "Please select a row to submit for approval.");
            }
        },
        GetApprovalData: function (e) {
            var $target = $(e.target).hasClass('detailed-view') ? $(e.target) : $(e.target).parents('.detailed-view');
            var $Tr = $target.parents('tr');
            var plElementUnApprovedUID = $Tr.find('#hdnPLElementUnApprovedUID').text();

            if ($target.attr('data-target') == undefined || $target.attr('data-target') == "") {
                $('.layout').show();
                $.ajax({
                    url: '/Budget/GetApprovalLogByPLElementUnApprovedUID',
                    type: 'POST',
                    contentType: 'application/json; charset=UTF-8',
                    async: true,
                    dataType: 'html',
                    data: JSON.stringify({ plElementUnApprovedUID: plElementUnApprovedUID }),
                    success: function (result) {
                        var newID = 'approval-modal' + plElementUnApprovedUID;

                        $('#' + newID).remove();

                        $($target).attr('data-target', '#' + newID);

                        $('.page-content-wrapper').append(result);

                        $('.layout').hide();
                        $('#' + newID).modal('show');
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            }
        },
        ProcessApprovalRequest: function () {
            var $parentTr = $(document).find('tr.expanded:not(blurView)').has('#hdnViewLevel:containsExact("CATEGORY")');
            var $target = $(this);
            $parentModal = $(this).parents('.modal');
            var status = 2;
            switch ($target.attr('class').split(' ').pop()) {
                case 'submit-approval-request':
                    status = 0;
                    break;
                case 'submit-reject-request':
                    status = 1;
                    break;
                case 'save-approval-comments':
                    status = 2;
                    break;
            }

            var dataList = [];
            var obj = {
                "PLElementUnApprovedUID": $parentModal.find('#hdnPLElementUnApprovedUID').val(),
                "PLCategoryUId": $parentModal.find('#hdnCategoryUID').val(),
                "Year": $parentModal.find('#hdnYear').val(),
                "BudgetUID": $parentModal.find('#hdnBudgetUID').val(),
                "DATDescriptionComments": $parentModal.find('.approver-comments-val').val(),
                "VendorComments": "",
                "DATValueM1Comments": "",
                "DATValueM2Comments": "",
                "DATValueM3Comments": "",
                "DATValueM4Comments": "",
                "DATValueM5Comments": "",
                "DATValueM6Comments": "",
                "DATValueM7Comments": "",
                "DATValueM8Comments": "",
                "DATValueM9Comments": "",
                "DATValueM10Comments": "",
                "DATValueM11Comments": "",
                "DATValueM12Comments": "",
                "DATValueM13Comments": '',
                "RequestedBy": $parentModal.find('#hdnRequestedBy').val()
            }

            dataList.push(obj);

            $parentModal.modal('hide');

            if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                var rowString = '';

                $('.expanded').map(function (v) {
                    rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                });

                localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

            }

            localStorage.setItem("ExpandRows", "True");

            console.log(localStorage.getItem("ExpandedRows"));

            $('.layout').show();

            $.ajax({
                url: '/Budget/ProcessApprovalRequest',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify({ dataList: dataList, status: status }),
                contentType: 'application/json',
                success: function (result) {

                    if (status == 2) {
                        ////$target.parents('tr').find('.detailed-view').trigger('click');
                        //var newID = 'approval-modal' + $parentModal.find('#hdnPLElementUnApprovedUID').val();
                        //$('.page-content-wrapper').find('#' + newID).remove();
                        //var $link = $('a:has(i[data-target="' + newID + '"])');
                        //$link.attr('data-target', '');
                        //$link.trigger('click');
                        //$target.parents('tr').find('.detailed-view').attr('data-target', '');
                        //$target.parents('tr').find('.detailed-view').trigger('click');
                        //$('.page-content-wrapper').append(result);
                        //$('.page-content-wrapper').find('#approval-modal').attr('id', newID);
                        //$('.page-content-wrapper').find('#' + newID).find('[type="checkbox"]').uniform();
                        ////$modal.html(data);       
                        //$('a[data-target="#' + $parentModal.attr('id') + '"]').trigger('click');

                        var $modalTarget = $('a[data-target="#' + $parentModal.attr('id') + '"]');
                        $parentModal.remove();
                        $modalTarget.attr('data-target', '');
                        $modalTarget.trigger('click');

                        //setTimeout(function () {
                        //    $parentModal.modal('show');
                        //    $('.layout').hide();
                        //}, 1000);                        
                    }
                    else {
                        $(document).find('.displayDataInput').trigger('click');
                    }
                },
                error: function (er) {
                    console.log(er);
                }
            });
        },
        SubmitApproveRejectDirectly: function () {

            var $parentTr = $(this).parents('tr');
            var status = $(this).hasClass('submit-approve-directly') ? 0 : 1;

            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').has('.selectRowToSubmit:checked');

            if ($rowsToSearch.length > 0) {

                var confirmClick = function () {

                    var dataList = $rowsToSearch.map(function () {
                        return {
                            "PLElementUnApprovedUID": $(this).find('#hdnPLElementUnApprovedUID').text(),
                            "PLCategoryUId": $(this).find('#hdnCatUID').text(),
                            "Year": $(document).find('#hdnBudgetYear').val(),
                            "BudgetUID": $(document).find('#hdnBudgetUID').val(),
                            "DATDescriptionComments": '',
                            "VendorComments": '',
                            "DATValueM1Comments": '',
                            "DATValueM2Comments": '',
                            "DATValueM3Comments": '',
                            "DATValueM4Comments": '',
                            "DATValueM5Comments": '',
                            "DATValueM6Comments": '',
                            "DATValueM7Comments": '',
                            "DATValueM8Comments": '',
                            "DATValueM9Comments": '',
                            "DATValueM10Comments": '',
                            "DATValueM11Comments": '',
                            "DATValueM12Comments": '',
                            "DATValueM13Comments": '',
                            "RequestedBy": ''
                        }
                    }).get();

                    if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                        var rowString = '';

                        $('.expanded').map(function (v) {
                            rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                        });

                        localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                        localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                    }

                    localStorage.setItem("ExpandRows", "True");

                    console.log(localStorage.getItem("ExpandedRows"));

                    $('.layout').show();

                    $.ajax({
                        url: '/Budget/ProcessApprovalRequest',
                        type: 'POST',
                        dataType: 'json',
                        data: JSON.stringify({ dataList: dataList, status: status }),
                        contentType: 'application/json',
                        success: function (result) {
                            $(document).find('.displayDataInput').trigger('click');
                        },
                        error: function (er) {
                            console.log(er);
                        }
                    });
                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", 'Are you sure you want to approve?');

            }

            else {

                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "Please select a row to submit.");
            }
        },
        SubmitRejectDirectly: function () {

            var $parentTr = $(this).parents('tr');
            var status = $(this).hasClass('submit-approve-directly') ? 0 : 1;

            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').has('.selectRowToSubmit:checked');

            if ($rowsToSearch.length > 0) {

                var confirmClick = function () {

                    var ids = $rowsToSearch.map(function () {
                        return $(this).find('#hdnPLElementUnApprovedUID').text()
                    }).get().join();

                    $('#reject-data-popup #rowToSubitIds').val(ids);
                    $('#parentRowId').val($parentTr.attr('id'));
                    $('#reject-data-popup .approver-comments').val('');
                    $('#reject-data-popup').modal('show');
                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Are you sure you want to reject?");

            }

            else {

                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "Please select a row to submit.");
            }
        },
        ProcessRejectRequest: function () {

            var $rowsToSearch = $('#rowToSubitIds').val().split(',').map(function (v) {
                return $('#DataInputTable tr').has('#hdnPLElementUnApprovedUID:containsExact("' + v + '")');
            });

            var $parentTr = $('#DataInputTable tr#' + $('#parentRowId').val());

            var dataList = $($rowsToSearch).map(function () {
                return {
                    "PLElementUnApprovedUID": $(this).find('#hdnPLElementUnApprovedUID').text(),
                    "PLCategoryUId": $(this).find('#hdnCatUID').text(),
                    "Year": $(document).find('#hdnBudgetYear').val(),
                    "BudgetUID": $(document).find('#hdnBudgetUID').val(),
                    "DATDescriptionComments": $('#reject-data-popup .approver-comments').val(),
                    "VendorComments": '',
                    "DATValueM1Comments": '',
                    "DATValueM2Comments": '',
                    "DATValueM3Comments": '',
                    "DATValueM4Comments": '',
                    "DATValueM5Comments": '',
                    "DATValueM6Comments": '',
                    "DATValueM7Comments": '',
                    "DATValueM8Comments": '',
                    "DATValueM9Comments": '',
                    "DATValueM10Comments": '',
                    "DATValueM11Comments": '',
                    "DATValueM12Comments": '',
                    "DATValueM13Comments": '',
                    "RequestedBy": ''
                }
            }).get();

            if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                var rowString = '';

                $('.expanded').map(function (v) {
                    rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                });

                localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

            }

            localStorage.setItem("ExpandRows", "True");

            console.log(localStorage.getItem("ExpandedRows"));

            $('.layout').show();

            $('#reject-data-popup').modal('hide');

            $.ajax({
                url: '/Budget/ProcessApprovalRequest',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify({ dataList: dataList, status: 1 }),
                contentType: 'application/json',
                success: function (result) {
                    $(document).find('.displayDataInput').trigger('click');
                },
                error: function (er) {
                    console.log(er);
                }
            });
        },
        GetMoreSubCatRowsInEditableMode: function (data) {
            var $html = $(data);            
            var isFOA = $($html).find('#hdnIsFOA').html();           
            var $parentTr = $('tr.inEditMode');

            initialSelectedVendorsArray = [];
            
            if (isFOA != "True") {
                var catTypeRE = $parentTr.find('td#hdnCATTypeRE').text();
                var isDepreicationExpense = $parentTr.find('td#hdnIsDepreciationExpense').text();

                $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted.newRow:not(".highlightExcelRow"):not(.beginningBalance)').each(function () {
                    $(this).removeClass('newRow');
                    if ($(this).hasClass('newRowAfterDelAll')) {
                        $(this).removeClass('hide');
                    }
                    $(this).find('td.hasComment').removeClass('hasComment').addClass('hideComment');
                    //$(this).find('.copyValues').show();

                    var catId = $parentTr.find('td#hdnCatUID').text().trim();
                    var catOption = $('[name=groupedcategory] option.clsCategory[value$="|' + catId + '"]');

                    var isCapex = catOption.data('iscapex');
                    var isBalanceSheet = catOption.data('isbalancesheet');
                    var isCashFlowThrough = $parentTr.find('td#hdnIsCashFlowThrough').text();

                    if (isCashFlowThrough == "True" || (isCapex == "False" && isBalanceSheet == "True")) {
                        $(this).find('input:not(.amortize-period)').removeClass('hideCol');
                        $(this).find('td:not(.vendorLst):not(.currencyLst):not(.termLst):not(.amortizePeriodLst) span:not(.modifiedByUser, .transactionSpan)').addClass('hideCol');

                        if ($(this).find('td.amortizePeriodLst span').html() == '') {
                            $(this).find('td.amortizePeriodLst span').html('1');
                        }
                    }
                    else {
                        $(this).find('input').removeClass('hideCol');
                        $(this).find('td:not(.vendorLst):not(.currencyLst):not(.termLst) span:not(.modifiedByUser, .transactionSpan)').addClass('hideCol');
                    }

                    //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") { For branch BD-1122
                    $(this).find('td.vendorLst .vendor').hide();
                    $(this).find('td.vendorLst .vendorDD').removeClass('hide');
                    //}

                    var $hdnCatCalucaltedType = $(this).find('#hdnCatCalucaltedType');

                    var hdnCatCalucaltedTypeVal = '';

                    if ($hdnCatCalucaltedType.length > 0) {
                        hdnCatCalucaltedTypeVal = $hdnCatCalucaltedType.text().trim();
                    }

		            //For branch BD-1122
		            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True" && !($(this).find('td').eq(0).find('a').hasClass('linked-category-data') || $(this).find('td').eq(0).find('a').hasClass('edit-formula'))) {
                    if (!($(this).find('td').eq(0).find('a').hasClass('linked-category-data') || $(this).find('td').eq(0).find('a').hasClass('edit-formula') || $(this).hasClass('nonEditableRow') || hdnCatCalucaltedTypeVal == 'EFP' || hdnCatCalucaltedTypeVal == 'EP')) {
                        $(this).find('td.currencyLst .currency').addClass('hide');
                        $(this).find('td.currencyLst .currencyDD').removeClass('hide');

                        if (isCashFlowThrough == "False" && catTypeRE != "C" && isDepreicationExpense == "False") {
                            $(this).find('td.termLst .termSpan').addClass('hide');
                            $(this).find('td.termLst .termDD').removeClass('hide');
                        }
                        else {
                            $(this).find('td.termLst .termSpan').html('N/A');
                        }
                    }

                    $(this).find('.action-btn').removeClass('hideCol');
                    $(this).find('.action-btn .userdata').hide();
                    $(this).find('input[type=checkbox]').removeClass('hideCol').addClass('showCol');
                    $(this).find('.exl-rowno').removeClass('hideCol').addClass('showCol');
                    $(this).find('.rowStatus').removeClass('showCol').addClass('hideCol');

                    //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") { For branch BD-1122
                    $(this).find('td.vendorLst').removeClass('vendor-wrap');
                    $(this).find('td.termLst').removeClass('vendor-wrap');
                    //}

                    $(this).find('input[type=checkbox]').removeClass('hideCol').addClass('showCol');
                    $(this).find('.rowStatus').removeClass('showCol').addClass('hideCol');
                    //}
                    $(this).find('.exl-rowno').removeClass('hideCol').addClass('showCol');

                    var isCatFixed = 0;
                    
                    var catId = $parentTr.find('#hdnCatUID').html().trim();

                    if ($('[name=groupedcategory] option.clsCategory[value$="' + catId + '"]').text().split('(')[1].toString().indexOf('VARIABLE') == -1) {
                        isCatFixed = 1;
                    }

                    if (RetailBudgetPro.Budget.isUserInApproveBudget == "True" && isCatFixed == 0) {
                        $($html).find('.bottomLevel:not(.historicaldata)').each(function () {
                            if ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == "") {
                                $(this).find('.upload-excel').remove();
                            }
                        });
                        //$parentTr.find('.action-items .edit').parent('div').next('div').find('.upload-excel').remove();
                    }
                    else {
                        //commented by Aman as we can traverse the bottom level rows itself 
                        // $parentTr.nextUntil('.bottomLevel.historicaldata', '.bottomLevel').each(function () {

                        if ($(this).find('#hdnCatCalucaltedOn').length == 0 || ($(this).find('#hdnCatCalucaltedOn').length != 0 && $(this).find('#hdnCatCalucaltedOn').html().trim() == "" && $(this).find('#hdnCatCalucaltedType').html().trim() == "")) {

                            $(this).find('.copyValues').show();

                            if (RetailBudgetPro.Budget.isUserInApproveBudget == "True" && !$(this).hasClass('unapproved-sent')) {
                                var excelFileClass = $(this).find('#hdnFromExcel').html().trim() == "" ? "fa fa-file-excel-o" : "file-excel-filed";

                                var excelFileRowClass = $(this).find('#hdnFromExcel').html().trim() == "" ? "" : "highlightExcelRow";

                                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") { For branch BD-1122
                                if ($(this).find('.upload-excel').length == 0) {
                                    $(this).find('td:first()').prepend('<a href="#" data-target="#subCatExcelUploadPopUp" data-toggle="modal" class="upload-excel" title="Upload excel"><i class="' + excelFileClass + '"></i></a>');
                                }
                                else {
                                    $(this).find('.upload-excel').removeClass('hide');
                                }
                                //}
                                $(this).addClass(excelFileRowClass);
                            }

                            //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") { For branch BD-1122
                            if ($(this).find('.bottomLevelCategoryComment i').length == 0 && ($(this).find('#hdnComment').html() == "" || $(this).find('#hdnComment').html() == undefined)) {
                                if ($(this).find('.function-btn a:last()').hasClass('downloadLinkedDocument'))
                                    $(this).find('.function-btn a:last()').before('<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o"></i></a>');
                                else
                                    $(this).find('.function-btn a:last()').after('<a data-target="#static" data-toggle="modal" class="bottomLevelCategoryComment" title="Insert Notes"><i class="fa fa-pencil-square-o"></i></a>');
                            }
                            else {
                                $(this).find('.bottomLevelCategoryComment i').removeClass('hide');
                            }

                            var docFileClass = $(this).find('#hdnAttachedSubCategoryFolderName').html().trim() == "" ? "fa fa-file" : "fa fa-file icon-red";

                            if ($(this).find('.documentUpload').length == 0 && ($(this).find('#hdnAttachedSubCategoryFolderName').html() == "" || $(this).find('#hdnAttachedSubCategoryFolderName').html() == undefined)) {
                                $(this).find('.function-btn a:last()').after('<a href="javascript:void(0)" class="documentUpload" title="Upload document"><i class="' + docFileClass + '"></i></a><input type="file" class="documentFile" accept=".pdf, .doc, .docx, .xls, .xlsx" style="display: none;" />');
                            }
                            else {
                                $(this).find('.documentUpload').removeClass('hide');
                            }
                            //}
                        }
                    }

                    $(this).find('.downloadLinkedExcel').addClass('hide');

                    $parentTr.find('.action-items .edit').parent('div').removeClass('show').addClass('hide').next('div').addClass('show').removeClass('hide');

                    $(this).find('.action-btn').find('.distributeTotalEven').show();
                    $(this).find('.action-btn').find('.usePeriodRedistribution').show();
                    $(this).find('.action-btn').find('.growthRate').show();
                    $(this).find('.action-btn').find('.distributeTotalPercent').show();

                    RetailBudgetPro.Budget.LockedMonthsCheck($(this), "false");

                    if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                        $(this).find('input[type=text]').addClass('highlightBckg');
                        $(this).find('td.vendorLst .vendorDD .sumo_subcategoryVendordd').addClass('hidePerm');
                        $(this).find('td.termLst .termDD .sumo_subCategoryTermDD').addClass('hidePerm');
                        $(this).find('td.currencyLst .currencyDD .sumo_subCategoryCurrencyDD').addClass('hidePerm');
                    }

                    $(this).find('.linked-category-data').attr('title', 'Edit Inputs');
                    //if (source != "growthRate")
                    //  $('div[class=action-items][class!=current]').hide();

                    if ($(this).find('[name="subcategoryVendordd"]').length > 0) {
                        initialSelectedVendorsArray.push($(this).find('.vendorLst .vendorDD [name="subcategoryVendordd"]').val())
                        $(this).find('[name="subcategoryVendordd"]')[0].sumo.unload();

                        if (showOptionsInVendorDropDown)
                            $(this).find('[name="subcategoryVendordd"]').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Search ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                        else
                            $(this).find('[name="subcategoryVendordd"]').SumoSelect({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true });

                        if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                            $(this).find('td.vendorLst .vendorDD .sumo_subcategoryVendordd').addClass('hidePerm');
                        }
                    }

                    $(this).find('[name="subCategoryCurrencyDD"]').SumoSelect({ searchText: true });

                    $(this).find('[name="subCategoryTermDD"]').SumoSelect({ searchText: true });

                    if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
                        $(this).find('td.termLst .termDD .sumo_subCategoryTermDD').addClass('hidePerm');
                        $(this).find('td.currencyLst .currencyDD .sumo_subCategoryCurrencyDD').addClass('hidePerm');
                    }

                    if (($(this).hasClass('unapproved-sent') && RetailBudgetPro.Budget.isUserInApproveBudget == "True") || (RetailBudgetPro.Budget.isUserInApproveBudget == "False" && $(this).hasClass('delete-request'))) {
                        $(this).find('input[type="text"]').attr('readonly', 'readonly').addClass('lockedMonths');
                    }

		            //For branch BD-1122
                    //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                    //    $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
                    //        $(this).find('[class*="DATValue"] input, td.amortizePeriodLst span').removeClass('hideCol').addClass('showCol');
                    //        $(this).find('[class*="DATValue"] span, td.amortizePeriodLst input').addClass('hideCol').removeClass('showCol');

                    //        if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {
                    //            $(this).find('td .dayOfPeriodDiv .dayOfPeriod, td .transactionDateDiv .transactionDate').hide();
                    //            $(this).find('.dayOfPeriodDiv span, .transactionDateDiv span').removeClass('hideCol').addClass('showCol');
                    //        }

                    //        $(this).find('.selectRowToDelete').attr("disabled", true);
                    //        $(this).find('input.isDescription, td.showVendorInTitle input').addClass('hideCol');
                    //        $(this).find('span.desc-field').removeClass('hideCol');
                    //        $(this).find('td .accrualEditData-info-icon').addClass('hide');
                    //        $(this).find('td.showVendorInTitle span').removeClass('hideCol').addClass('showCol');

                    //        if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                    //            $(this).find('td.currencyLst span.currency').removeClass('hideCol');
                    //        }
                    //    });
                    //}

                });
            }

            //$('#DataInputTable tbody tr').not('.highlightExcelRow').removeClass('active-row').addClass('blurView').removeClass('highlight');
            
            $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').not('.highlightExcelRow').find('.selectRowToSubmit').removeClass('showCol').addClass('hideCol');
            $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').not('.highlightExcelRow').find('.detailed-view').hide();

            $parentTr.nextUntil('.l' + $parentTr.attr('data-level')).not('.highlightExcelRow').addClass('highlight').removeClass('blurView');
            if ($('#hdnUsePeriodReDistribution').val() == "True") $parentTr.parents('table').addClass('UsePeriodRedibution');
            
        },

        GetMoreSubCatRows: function () {

            var $currentTr = $(this).parents('tr');

            var $prevTr = $currentTr.prevAll('tr[data-level=' + (parseInt($currentTr.attr('data-level')) - 1) + ']').first();

            $('#DataInputTable tbody tr').removeClass('active-row').addClass('blurView').removeClass('highlight');

            $prevTr.prevUntil('[data-level=2]').last().prev();

            $prevTr.addClass('active-row').removeClass('blurView');

            $prevTr.nextUntil('.l' + $prevTr.attr('data-level')).addClass('highlight').removeClass('blurView');

            //$('.custom-data-table').hide();
            $('.layout').css('display', 'block');

            var stores = [];
            var groupedcategory = $('[name=groupedcategory] :selected').val();
            var stores = $('[name=lstStores]').val();
            var level = $prevTr.attr('data-level');
            var viewlevel = $prevTr.find('#hdnViewLevel').html();
            var storeID = $prevTr.find('#hdnStoreUID').html();
            var deptID = $prevTr.find('#hdnDeptUID').html();
            var vendorIdCSV = ($('#vendordd').val() == null ? '' : $('#vendordd').val().join());
            var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
            var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

            if (deptID == "") {
                deptID = "-1";
            }
            var categoryID = $prevTr.find('#hdnCatUID').html();
            if (categoryID == "") {
                categoryID = "-1";
            }

            //console.log("{ level:'" + level + "', StoreUID:'" + storeID + "', DeptUID:'" + deptID + "',CategoryUID:'" + categoryID + "', groupedcategory:'" + groupedcategory + "', Stores:'" + stores + "',CompNonCompfilter:'" + RetailBudgetPro.Budget.filter + "',viewLevel:'" + viewlevel + "', PageIndex: '" + $currentTr.attr('data-pageIndex') + "' }");

            $.ajax({
                url: '/Budget/GetMoreSubCatRows',
                type: 'POST',
                async: true,
                dataType: 'html',
                data: "{ level:'" + level + "', StoreUID:'" + storeID + "', DeptUID:'" + deptID + "',CategoryUID:'" + categoryID + "', groupedcategory:'" + groupedcategory + "', Stores:'" + stores + "',CompNonCompfilter:'" + RetailBudgetPro.Budget.filter + "',viewLevel:'" + viewlevel + "', PageIndex: '" + (parseInt($currentTr.find('a.show-more-rows').attr('data-pageIndex')) + 1) + "', vendorIdCSV: '" + vendorIdCSV + "', showInGlobal: '" + ($('[name="ShowInGlobal"]').val() == "1") + "', bsMode: '" + bsMode + "', categoryType: '" + categoryType + "' }",
                contentType: "application/json; charset=UTF-8",
                success: function (data) {
                    //var pageIndex = parseInt($currentTr.find('a.show-more-rows').attr('data-pageIndex'));

                    //$(data).find('a.show-more-rows').attr('data-pageIndex', (pageIndex + 1));

                    //$(data).find('.copyValues').hide();

                    //$currentTr.prevAll('tr[data-level=' + (parseInt($currentTr.attr('data-level'))) + ']').first().after(data);

                    //$currentTr.nextUntil('.noResultFound').find('.copyValues').hide();

                    var $html = $(data);
                    var inEditMode = $prevTr.hasClass('inEditMode');
                    if (inEditMode) {
                        $html = $html.addClass('newRow');
                    }
                    var $trAfterAppend = $currentTr;
                    var $tr = $currentTr;

                    var budgetId = $('#hdnBudgetUID').val();
                    var budgetYear = $('#hdnBudgetYear').val();
                    var storeID = $html.find('#hdnStoreUID').val();

                    var hdnIsUserInManagePayrollRoleVal = $('#hdnIsUserInManagePayrollRole').val();
                    var hdnIsUserInManageAdminPayrollRoleVal = $('#hdnIsUserInManageAdminPayrollRole').val();
                    var hdnShowEmployeeModuleVal = $('#hdnShowEmployeeModule').val();
                    var hdnInactiveMonths = $(document).find('#hdnInactiveMonths').val().length > 0;

                    $(".hideyear").removeAttr("data-level");

                    $($html).find('.netsales').remove();
                    // hide copy values button initially and show it when bottom lines are in edit mode
                    $($html).find('.copyValues').hide();
                    $('.budgets-table').addClass('vendor');
                    //  $trAfterAppend.addClass('show-action-btns');

                    if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {
                        $html.filter(function () {
                            return $(this).hasClass('budgetdata') && $(this).find('#hdnPLElementUID').html() != undefined && $(this).find('#hdnPLElementUID').html() != "-1" && $(this).find('#hdnPLElementUnApprovedUID').html() == "-1" && !($(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != "") && ($(this).find('#hdnCatCalucaltedType').html() != undefined && $(this).find('#hdnCatCalucaltedType').html().trim() != "NE") && ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() == "");
                        }).each(function () {
                            var amortValue = parseInt($(this).find('.amortizePeriodLst.showAmortizePeriodInTitle span').text());

                            if (!isNaN(amortValue) && (amortValue > 1 || (amortValue == 1 && hdnInactiveMonths))) {
                                var htmlPopoverInfoIcon = '<a class="accrualEditData-info-icon ' + (inEditMode ? 'hide' : '') + '"><i class="icon-info"></i></a>';
                                $(this).find('td:first()').append(htmlPopoverInfoIcon);
                            }
                        });
                    }

                    $trAfterAppend.children('td:first').prepend('<input type="checkbox" class="checkAllToDelete hideCol" title="Select All"/>');

                    $trAfterAppend.find('.displayVendor:first').html('<div class="sort-vendor"><a href="javascript:void(0)" class="sort-both"></a></div>');
                    $trAfterAppend.find('td.data.DATValueTotalF').html(RetailBudgetPro.Budget.sortTotalByDollarHTML);
                    $trAfterAppend.find('td.percentage.DATValueTotalPF').html(RetailBudgetPro.Budget.sortTotalByPercentHTML);

                    var isFOA = $($html).find('#hdnIsFOA').html();
                    var lockedMonthsList = $(document).find('#hdnLockedMonths').val().split(',');
                    var periods = getNumberOfPeriods();
                    var submitForApproverIcon = '';

                    if ($('#hdnImpersonationMode').val() == "False" && $tr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').length > 0 && $(document).find('#hdnUserInApproveBudget').val() == "False")
                        submitForApproverIcon = '<a href="javascript:void(0)" class="submitForApproval" title="Submit for approval"><i class="fa fa-thumbs-o-up"></i></a><a href="javascript:void(0)" class="undo-pending" title="Undo Pending"><i class="fa fa-thumbs-o-down"></i></a>';

                    else if ($('#hdnImpersonationMode').val() == "False" && $tr.nextUntil('tr.doNotExpand:not(.beginningBalance)').not('.historicaldata').find('.selectRowToSubmit').length > 0 && $(document).find('#hdnUserInApproveBudget').val() == "True")
                        submitForApproverIcon = '<a href="javascript:void(0)" class="submit-approve-directly" title="Approve"><i class="fa fa-thumbs-up"></i></a><a href="javascript:void(0)" class="submit-reject-directly" title="Reject"><i class="fa fa-thumbs-down"></i></a>';

                    else
                        submitForApproverIcon = '';

                    //var fromExcel = $($html).find('#hdnFromExcel:contains("True")').length >= 1 ? "True" : "False";
                    if (isFOA != "True") {

                        // If there is no formula and all periods are locked then show only copy category button
                        if (lockedMonthsList.length == periods) {
                            // If logged in user is admin then 
                            if ($(document).find('#hdnUserInRole').val() == "True") {
                                if ($(document).find('#hdnIsConsolidated').val() != "True") {
                                    // show only copy categories button
                                    $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show"> <a href="javascript:void(0);" class="grey comment" id="btnComment" title="Show Comments"><i class="fa fa-pencil-square-o"></i></a> <a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a></div></div>')
                                }
                            }
                            else {//     $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html());
                                // If user doesnot hav role to view budget then dont show the copy button
                                if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                    var deleteIconClass = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "submit-delete-request" : "deleteBottomLevelCategory";
                                    var deleteIconTitle = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "Submit for delete" : "Delete";
                                    $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="show"><div class="hide"><a href="#" class="save" title="Save"><i class="fa fa-save"></i></a><a href="#" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a> <a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i></a><a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a><a href="javascript:void(0);" class="' + deleteIconClass + '" title="' + deleteIconTitle + '"><i class="fa fa-trash-o"></i></a></div></div>')
                                }
                                // If user has role to edit budget show the copy budget button
                                if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") {
                                    if ($(document).find('#hdnIsConsolidated').val() != "True") {
                                        $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show"> <a href="javascript:void(0);" class="grey comment" id="btnComment" title="Show Comments"><i class="fa pencil-square-o"></i></a> <a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i> </a></div></div>')
                                    }
                                }
                            }
                        }

                        // If there are no periods locked or locked periods are less than the periods then
                        else {
                            var html = '';
                            html += ((RetailBudgetPro.Budget.turnOnBalanceSheetVal == "False" || (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && $('[name="TransactionModeDropdown"]').val() == "ACCRUAL")) && (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'True' && $('#hdnImpersonationMode').val() == "False") && $('[name="ReadOnlyMode"]').val() == "False" && (($('[name="AllowBatchUpdates"]').val() == "True" && $('[name="ShowEditIcon"]').val() == "True") || $('[name="AllowBatchUpdates"]').val() == "False") ? '<a href="#" class="edit" title="Edit"> <i class="fa fa-pencil"></i> </a>' : '');

                            var saveBtnClass = $(document).find('#hdnUserInApproveBudget').val() == "False" ? 'saveByRequester' : 'saveByApprover';

                            var deleteIconClass = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "submit-delete-request" : "deleteBottomLevelCategory";
                            var deleteIconTitle = RetailBudgetPro.Budget.isUserInApproveBudget == "False" ? "Submit for delete" : "Delete";
                            var deleteIcon = '<a href="javascript:void(0);" class="' + deleteIconClass + '" title="' + deleteIconTitle + '"><i class="fa fa-trash-o"></i></a>';

                            if ($(document).find('#hdnUserInRole').val() == "True") {
                                $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description">' +
                                    '<a href="javascript:void(0)" class="sort-both"></a>' +
                                    '</div>' +
                                    '<div class="action-items">' +
                                    '<div class="show">' + html +
                                    '<a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"><i class="fa fa-copy"></i> </a>' +
                                    '</div>' +
                                    '<div class="hide">' +                                    
                                    '<a href="#" class="save ' + saveBtnClass + '" title="Save">' +
                                    '<i class="fa fa-save"></i>' +
                                    '</a>' +
                                    '<a href="#" class="newLineLink" title="Add new line"><i class="fa fa-plus"></i></a>' +
                                    '<a href="#" class="undo" title="Undo"><i class="fa fa-undo"></i></a>' +
                                    '<a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a>' +
                                    deleteIcon +
                                    '</div>' +
                                    '</div>');
                            }
                            else {
                                if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True") {
                                    $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="sort-description"><a href="javascript:void(0)" class="sort-both"></a></div><div class="action-items"><div class="show">' + html + '<a href="/Budget/CopyBudget/' + budgetId + '/' + budgetYear + '/' + storeID + '" class="copy" title="Copy this category to another category"> <i class="fa fa-copy"></i></a></div><div class="hide"><a href="#" class="save ' + saveBtnClass + '" title="Save"><i class="fa fa-save"></i></a><a href="#" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i></a><a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i></a><a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a>' + deleteIcon + '</div></div>')
                                }
                                else if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                    $trAfterAppend.children('td:first').attr('title', $trAfterAppend.children('td:first').find('.label').html()).append('<div class="action-items"><div class="hide"><a href="#" class="save ' + saveBtnClass + '" title="Save"><i class="fa fa-save"></i></a><a href="#" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a> <a href="#" class="undo" title="Undo"> <i class="fa fa-undo"></i></a><a href="javascript:void(0);" class="pasteToSingleStore" title="Paste multiple sub-category rows in the ' + $('#hdnStoreName').val() + '"><i class="fa fa-paste"></i></a>' + deleteIcon + '</div></div>')
                                }
                            }
                        }

                    } // if there is a formula on this category
                    else {

                        if ($(document).find('#hdnUserInRole').val() != "True") {
                            if ($(document).find('#hdnIsUserInEditDataPageRole').val() == "True") {
                            }
                            else if ($(document).find('#hdnUserInViewBudgetRole').val() == "True") {
                                $($trAfterAppend.find('td:first').find('.formulaType')).find('.copy').remove();
                            }
                        }

                        var formulaTypeHtml = $($trAfterAppend.find('td:first').find('.formulaType')).prop('outerHTML');
                        $trAfterAppend.find('td:first').find('.formulaType').remove();
                        $trAfterAppend.find('td:first').append(formulaTypeHtml);
                    }
                    $trAfterAppend.addClass('show-action-btns');

                    $trAfterAppend.find('.action-items div.show').append(submitForApproverIcon);

                    // Showing vendor column
                    $('.displayVendor').removeClass('hide');

                    $trAfterAppend.find('.hideNewLine').removeClass('hideNewLine').addClass('showNewLine');
                    if (isFOA != "True") {
                        // Inserting the growth rate distrinbution button in the totals historical rows.
                        $($trAfterAppend.nextAll('.totals')[0]).each(function () {
                            $(this).next('tr').find('.action-btn').html("<div class=''><a data-target='#growthRatePopUp' style='display:none;' data-toggle='modal' class='growthRate' title='Copy to current year with growth %'><i class='fa fa-angle-up'></i></a></div>");
                            // Checking for locked months and disabling the textboxes in case particular period is locked.
                            RetailBudgetPro.Budget.LockedMonthsCheck($(this).next('tr'), $(this).next('tr').find('td#hdnIsFOA').text());
                            $(this).next('tr').next('tr').find('.action-btn').html("<div class=''><a data-target='#growthRatePopUp' style='display:none;' data-toggle='modal' class='growthRate' title='Copy to current year with growth %'><i class='fa fa-angle-up'></i></a></div>");
                            RetailBudgetPro.Budget.LockedMonthsCheck($(this).next('tr').next('tr'), $(this).next('tr').next('tr').find('td#hdnIsFOA').text());
                        });
                    }

                    $($html).find('.action-btn').removeClass('hideCol');
                    $($html).find('.action-btn').find('.distributeTotalEven').hide();
                    $($html).find('.action-btn').find('.usePeriodRedistribution').hide();
                    $($html).find('.action-btn').find('.growthRate').hide();
                    $($html).find('.action-btn').find('.distributeTotalPercent').hide();

                    $html.filter(function () {
                        return $(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != ""
                    }).each(function () {
                        var hoverText = "(Linked to Row " + $(this).find('#hdnExcelRowNum').html() + ") - Download Excel";
                        var tHtml = '<a href="javascript:void(0)" class="downloadLinkedExcel" title="' + hoverText + '"><i class="file-excel-filed downloadSubCatExcel"></i>' + ($(this).find('#hdnFromExcel').val() == '' ? '' : '<span data-rowno="' + $(this).find('#hdnExcelRowNum').html() + '" class="exl-rowno">Row ' + $(this).find('#hdnExcelRowNum').html() + '</span>') + '</a>';
                        $(this).find('td:first()').append(tHtml);
                    });

                    if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                        $html.filter(function () {
                            return $(this).hasClass('budgetdata') && $(this).find('#hdnPLElementUID').html() != undefined && $(this).find('#hdnPLElementUID').html() != "-1" && $(this).find('#hdnPLElementUID').html() != "-10" && !($(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != "") && $('[name="groupedcategory"] option[value$="|' + $(this).find('#hdnCatUID').html().trim() + '"]').data('isfinancialcat') == "True";
                        }).each(function () {
                            htmlCurrencyLinkIcon = '<i class="fa fa-money"></i>';
                            var htmlA = '<a title="View Inputs" href="#" data-target="#relatedCurrencyModal" data-toggle="modal" class="linked-currency-data" data-plelementUID="' + $(this).find('#hdnPLElementUID').html() + '">' + htmlCurrencyLinkIcon + '</a>';
                            $(this).find('td:first()').append(htmlA);
                        });
                    }

                    $html.filter(function () {
                        return $(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != ""
                    }).each(function () {

                        var urlLink = $(this).find('#hdnCatCalucaltedType').html().trim() == "FOA" ? "/Formula/EditFormula/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : $(this).find('#hdnCatCalucaltedType').html().trim() == "C2C" ? "/C2C/EditC2C/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : ($(this).find('#hdnCatCalucaltedType').html().trim() == "EP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "FTE") ? "/EmployeePayroll/Edit/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : $(this).find('#hdnCatCalucaltedType').html().trim() == "EFP" ? "/EmployeeFormula/Edit/" + $(this).find('#hdnCatCalucaltedOn').html().split('|')[1] : "/Rule/EditRule/" + $(this).find('#hdnCatCalucaltedOn').html().trim();
                        var formulaName = $(this).find('#hdnFormulaName').html().trim();

                        var htmlInputIcon = '';
                        var htmlFormulaLinkIcon = '';
                        var htmlA = '';
                        var payrollUIDList = $(this).find('#hdnPayrollUIDsNotInUser').text().split(",");

                        if ($(this).find('.edit-formula').length == 0) {
                            if (($(this).find('#hdnCatCalucaltedType').html().trim() == "EFP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "EP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "FTE") && (hdnIsUserInManageAdminPayrollRoleVal == "True" || hdnIsUserInManagePayrollRoleVal == "True")) {
                                if ($(this).find('#hdnCatCalucaltedType').html().trim() == "EP" || $(this).find('#hdnCatCalucaltedType').html().trim() == "FTE") {
                                    htmlFormulaLinkIcon = '<i class="fa fa-user"></i>';
                                    htmlInputIcon = ($(this).find('#hdnCatCalucaltedType').html().trim() == "FTE" ? '' : '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>');

                                    if (jQuery.inArray($(this).find('#hdnCatCalucaltedOn').html().trim(), payrollUIDList) == -1) {
                                        htmlA += htmlInputIcon + '<a title="Edit Payroll" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>';
                                    }
                                    else {
                                        htmlA += htmlInputIcon;
                                    }
                                }
                                else {
                                    htmlInputIcon = ($(this).find('#hdnEmpFormulaTypeFV').html().trim() == "F" || $(this).find('#hdnEmpFormulaTypeFV').html().trim() == "A") ? '' : '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>';
                                    htmlFormulaLinkIcon = hdnIsUserInManageAdminPayrollRoleVal == "True" ? '<img src="/assets/admin/layout/img/fx-sign.png"></a>' : '';
                                    htmlEmployeeIcon = hdnShowEmployeeModuleVal == "True" ? ('<a title="Edit Employee" target="_blank" class="edit-employee" href="/Employee/Edit/' + $(this).find('#hdnEmployeeUID').html().trim() + '"><i class="fa fa-user"></i></a>') : "";
                                    htmlA += htmlInputIcon + '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' + htmlEmployeeIcon;
                                }
                            }
                            else if ($(this).find('#hdnCatCalucaltedType').html().trim() != "EFP" && $(this).find('#hdnCatCalucaltedType').html().trim() != "EP" && $(this).find('#hdnCatCalucaltedType').html().trim() != "FTE" && $(this).find('#hdnCatCalucaltedType').html().trim() != "LC") {
                                htmlInputIcon = ($(this).find('#hdnIsFOAEliminationType').html() != "True" && $(this).find('#hdnC2COperator').html() != "E") ? '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="' + formulaName + '"></a>' : '';
                                htmlA = htmlInputIcon;
                                htmlFormulaLinkIcon = '<img src="/assets/admin/layout/img/fx-sign.png"></a>';
                                htmlA += $('#hdnUserInManageFormulaRole').val() == 'True' ? '<a title="Edit Formula" target="_blank" class="edit-formula" href=' + urlLink + '>' + htmlFormulaLinkIcon + '</a>' : '';
                            }
                            else if ($(this).find('#hdnCatCalucaltedType').html().trim() == "LC" && $(this).find('.linked-category-data').length == 0) {
                                htmlA = '<a title="View Inputs" href="#" data-target="#formulaModal" data-toggle="modal" class="linked-category-data" data-formType="' + $(this).find('#hdnCatCalucaltedType').html().trim() + '" data-formulaName="LC"></a>';
                            }

                            $(this).find('td:first()').append(htmlA)
                        }
                    });

                    $html.filter(function () {
                        return $(this).find('#hdnAttachedSubCategoryFolderName').html() != undefined && $(this).find('#hdnAttachedSubCategoryFolderName').html().trim() != ""
                    }).each(function () {
                        var tempHtml = '<a href="javascript:void(0)" class="downloadLinkedDocument hasFile" title="Upload Document"><i class="fa fa-file icon-red downloadDocumentFile"></i></a><input type="file" class="documentFile" accept=".pdf, .doc, .docx, .xls, .xlsx" style="display: none;" />';
                        $(this).find('.function-btn a:last()').before(tempHtml);
                    });

                    $html.filter(function() {
                        return $(this).find('#hdnCatCalucaltedType').html() != undefined && $(this).find('#hdnCatCalucaltedType').html().trim() == "NE"
                    }).each(function () {
                        var htmlGLIcon = '<a title="Imported/Copied, (non editable)" href="javascript:void(0)" class="gl-imported-rows"><i class="fa fa-minus-circle"></i></a>';
                        $(this).find('td:first()').append(htmlGLIcon);
                    });

                    $html.filter(function () {
                        return $(this).find('#hdnComment').html() != undefined && $(this).find('#hdnComment').html().trim() == ""
                    }).each(function () {
                        $(this).find('.bottomLevelCategoryComment i').addClass('hide');
                    });

                    $html.filter(function () {
                        return ($(this).find('#STCCompM1').html() == 'N' && $(this).find('#STCCompM2').html() == 'N' && $(this).find('#STCCompM3').html() == 'N' && $(this).find('#STCCompM4').html() == 'N' &&
                            $(this).find('#STCCompM5').html() == 'N' && $(this).find('#STCCompM6').html() == 'N' && $(this).find('#STCCompM7').html() == 'N' && $(this).find('#STCCompM8').html() == 'N' &&
                            $(this).find('#STCCompM9').html() == 'N' && $(this).find('#STCCompM10').html() == 'N' && $(this).find('#STCCompM11').html() == 'N' && $(this).find('#STCCompM12').html() == 'N' && $(this).find('#STCCompM13').html() == 'N')
                    }).eq(0).prevAll('tr.show-action-btns.active-row').eq(0).find('div.action-items a.edit').addClass('hide')


                    $html.find(".vendor-info-icon").popover({
                        html: true,
                        content: function () {
                            return $(this).parents('td').find('[id="vendor-info"]').html()
                        },
                        delay: { show: 50, hide: 100 }
                    });

                    $html.find(".modifiedByUser-info-icon").popover({
                        html: true,
                        content: function () {
                            var $row = $(this).parents('td').find('[id="modifiedByUserNameDiv"]');
                            $row.find('span.datModifiedDate').html(RetailBudgetPro.Layout.ConvertToLocalDateTime($row.find('span.datModifiedDate').html()))
                            return $(this).parents('td').find('[id="modifiedByUserNameDiv"]').html()
                        },
                        delay: { show: 50, hide: 100 }
                    });

                    $currentTr.prevAll('tr[data-level=' + (parseInt($currentTr.attr('data-level'))) + ']').first().after($html);

                    $currentTr.remove();

                    RetailBudgetPro.Budget.InitializeMultiselect();

                    $('#DataInputTable').tabelize();
                    
                    $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                    $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                    $('.hideyear').find('td:first').html('');

                    if ($prevTr.find('.comment').find('i').hasClass('fa-comment')) {
                        var $tr = $prevTr.nextUntil('.l' + $parentTr.attr('data-level'));

                        var $tFilteredRows = $tr.filter('.bottomLevel').has('#hdnCatCalucaltedType:empty,#hdnCatCalucaltedType:containsExact("NE")');

                        var $filteredRows = $tFilteredRows.not($tFilteredRows.has('#hdnPLElementUID:containsExact("-1")'));

                        $filteredRows.find('.desc-field, .data span, .percentage span').addClass('commentModeOn');

                        if ($('#ShowVendor').val() == "True") {
                            $filteredRows.find('.vendor').addClass('commentModeOn');
                        }
                        else {
                            $filteredRows.find('.isVendor').next('span').addClass('commentModeOn');
                        }
                    }

                    //if ($('.action-items.current .edit').parents('div').hasClass('hide'))
                    if (inEditMode) {
                        RetailBudgetPro.Budget.GetMoreSubCatRowsInEditableMode(data);
                    }

                    RetailBudgetPro.Budget.ManageDataAndPerentage();
                },
                error: function (err) {
                    console.log(err);
                    $('.layout').css('display', 'none');
                }
            });
        },
        SubmitDeleteRequest: function (e) {
            $parentTr = $(e.currentTarget).parents('tr');

            var hasPendingSentRow = false;
            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata, .unapproved-sent, .unapproved-pending').has('.selectRowToDelete:checked');
            var $allRows = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').has('.selectRowToDelete:checked');

            $allRows.filter(function () {
                if ($(this).hasClass('unapproved-sent') || $(this).hasClass('unapproved-pending'))
                    hasPendingSentRow = true;
            });

            if (hasPendingSentRow)
                custom_dialog("Ok", "", "Alert", "No Pending or Sent rows can be submitted for delete");
            else if ($rowsToSearch.length > 0) {

                var confirmClick = function () {

                    $('.layout').show();

                    var plElementUIDCSV = $rowsToSearch.map(function () {
                        return $(this).find('#hdnPLElementUID').html().trim();
                    }).get().join();

                    if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                        var rowString = '';

                        $('.expanded').map(function (v) {
                            rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                        });

                        localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                        localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                    }

                    localStorage.setItem("ExpandRows", "True");

                    console.log(localStorage.getItem("ExpandedRows"));

                    $.ajax({
                        url: '/Budget/SubmitDataForDelete',
                        type: 'POST',
                        async: true,
                        dataType: 'json',
                        contentType: "application/json; charset=UTF-8",
                        data: JSON.stringify({ plElementUIDCSV: plElementUIDCSV }),
                        success: function (data) {

                            var trLevel = $parentTr.data('level');
                            var stopLevel = $('[name="groupedcategory"] :selected').hasClass('boldGroup') ? ($('[name="groupedcategory"] :selected').nextUntil('.boldGroup').length > 1 ? trLevel : (trLevel - 1)) : (trLevel - 1);

                            $parentTr.find('td:first .expander').trigger('click');
                            $parentTr.find('td:first .sort-description,.action-items').remove();
                            $parentTr.nextUntil('tr[data-level="' + stopLevel + '"]', 'tr:not(.historicaldata.hideyear.level' + trLevel + ',.totals.level' + trLevel + '.hideyear,.LevelPercentLY.level' + trLevel + '.hideyear)').remove();
                            $parentTr.addClass('budgetdata');
                            $parentTr.find('td:first .expander').trigger('click');

                        },
                        error: function (err) {
                            console.log(err);
                            $('.layout').hide();
                        }
                    });

                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Are you sure you want to submit for delete?");

            }

            else {

                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "Please select a row to submit for delete.");
            }
        },
        UndoPending: function (e) {
            $parentTr = $(e.currentTarget).parents('tr');

            var $rowsToSearch = $parentTr.nextUntil('.doNotExpand:not(.beginningBalance)', '.bottomLevel:not(.beginningBalance)').not('.historicaldata').has('.selectRowToSubmit:checked');

            if ($rowsToSearch.length > 0) {

                var confirmClick = function () {

                    $('.layout').show();

                    var plElementUnApprovedUIDCSV = $rowsToSearch.map(function () {
                        return $(this).find('#hdnPLElementUnApprovedUID').html().trim();
                    }).get().join();

                    if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                        var rowString = '';

                        $('.expanded').map(function (v) {
                            rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                        });

                        localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                        localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                    }

                    localStorage.setItem("ExpandRows", "True");

                    console.log(localStorage.getItem("ExpandedRows"));

                    $.ajax({
                        url: '/Budget/UndoPending',
                        type: 'POST',
                        async: true,
                        dataType: 'json',
                        contentType: "application/json; charset=UTF-8",
                        data: JSON.stringify({ plElementUnApprovedUIDCSV: plElementUnApprovedUIDCSV }),
                        success: function (data) {

                            var trLevel = $parentTr.data('level');
                            var stopLevel = $('[name="groupedcategory"] :selected').hasClass('boldGroup') ? ($('[name="groupedcategory"] :selected').nextUntil('.boldGroup').length > 1 ? trLevel : (trLevel - 1)) : (trLevel - 1);

                            $parentTr.find('td:first .expander').trigger('click');
                            $parentTr.find('td:first .sort-description,.action-items').remove();
                            $parentTr.nextUntil('tr[data-level="' + stopLevel + '"]', 'tr:not(.historicaldata.hideyear.level' + trLevel + ',.totals.level' + trLevel + '.hideyear,.LevelPercentLY.level' + trLevel + '.hideyear)').remove();
                            $parentTr.addClass('budgetdata');
                            $parentTr.find('td:first .expander').trigger('click');

                        },
                        error: function (err) {
                            console.log(err);
                            $('.layout').hide();
                        }
                    });

                }

                var cancelClick = function () {
                }

                custom_confirm(confirmClick, cancelClick, "Confirm", "Are you sure you want to undo?");

            }

            else {

                confirm_click1 = function () {
                }

                custom_alert(confirm_click1, "Alert", "Please select a row to undo pending.");
            }
        },
        UsePeriodRedistribution: function (e) {
            $parentTr = $(e.currentTarget).parents('tr');

            var periodDistributionValueArr = $parentTr.find('.usePeriodRedistribution').attr('data-value').split('-');

            var periodDistributionValue = [];

            for (var i = 0; i < 4; i++) {
                periodDistributionValue.push(periodDistributionValueArr[0]);
                periodDistributionValue.push(periodDistributionValueArr[1]);
                periodDistributionValue.push(periodDistributionValueArr[2]);
            }

            var $periods = getNumberOfPeriods();

            var data = getDataRowObject($parentTr, "span", $periods);

            var total = $parentTr.find('.total').val();

            total = ConvertCurrencyStringToDecimal(total);

            var decimalPlaces = getDecimalPlaces($parentTr);

            if (dataPercentageFilter == "data") {
                if ($periods == 12) {
                    data.DATValueM1 = (total * periodDistributionValue[0]) / 52;
                    data.DATValueM2 = (total * periodDistributionValue[1]) / 52;
                    data.DATValueM3 = (total * periodDistributionValue[2]) / 52;
                    data.DATValueM4 = (total * periodDistributionValue[3]) / 52;
                    data.DATValueM5 = (total * periodDistributionValue[4]) / 52;
                    data.DATValueM6 = (total * periodDistributionValue[5]) / 52;
                    data.DATValueM7 = (total * periodDistributionValue[6]) / 52;
                    data.DATValueM8 = (total * periodDistributionValue[7]) / 52;
                    data.DATValueM9 = (total * periodDistributionValue[8]) / 52;
                    data.DATValueM10 = (total * periodDistributionValue[9]) / 52;
                    data.DATValueM11 = (total * periodDistributionValue[10]) / 52;
                    data.DATValueM12 = (total * periodDistributionValue[11]) / 52;
                }

                data.DATValueM1P = data.DATNetSalesM1 != 0 ? 100 * data.DATValueM1 / data.DATNetSalesM1 : 0;
                data.DATValueM2P = data.DATNetSalesM2 != 0 ? 100 * data.DATValueM2 / data.DATNetSalesM2 : 0;
                data.DATValueM3P = data.DATNetSalesM3 != 0 ? 100 * data.DATValueM3 / data.DATNetSalesM3 : 0;
                data.DATValueM4P = data.DATNetSalesM4 != 0 ? 100 * data.DATValueM4 / data.DATNetSalesM4 : 0;
                data.DATValueM5P = data.DATNetSalesM5 != 0 ? 100 * data.DATValueM5 / data.DATNetSalesM5 : 0;
                data.DATValueM6P = data.DATNetSalesM6 != 0 ? 100 * data.DATValueM6 / data.DATNetSalesM6 : 0;
                data.DATValueM7P = data.DATNetSalesM7 != 0 ? 100 * data.DATValueM7 / data.DATNetSalesM7 : 0;
                data.DATValueM8P = data.DATNetSalesM8 != 0 ? 100 * data.DATValueM8 / data.DATNetSalesM8 : 0;
                data.DATValueM9P = data.DATNetSalesM9 != 0 ? 100 * data.DATValueM9 / data.DATNetSalesM9 : 0;
                data.DATValueM10P = data.DATNetSalesM10 != 0 ? 100 * data.DATValueM10 / data.DATNetSalesM10 : 0;
                data.DATValueM11P = data.DATNetSalesM11 != 0 ? 100 * data.DATValueM11 / data.DATNetSalesM11 : 0;
                data.DATValueM12P = data.DATNetSalesM12 != 0 ? 100 * data.DATValueM12 / data.DATNetSalesM12 : 0;

            }
            else { // if data display mode is of Percentages
                data.DATValueM1P = (total * 400) / 52;
                data.DATValueM2P = (total * 400) / 52;
                data.DATValueM3P = (total * 400) / 52;
                data.DATValueM4P = (total * 400) / 52;
                data.DATValueM5P = (total * 400) / 52;
                data.DATValueM6P = (total * 400) / 52;
                data.DATValueM7P = (total * 400) / 52;
                data.DATValueM8P = (total * 400) / 52;
                data.DATValueM9P = (total * 400) / 52;
                data.DATValueM10P = (total * 400) / 52;
                data.DATValueM11P = (total * 400) / 52;
                data.DATValueM12P = (total * 400) / 52;
                data.DATValueM13P = (total * 400) / 52;

                data.DATValueM1 = data.DATValueM1P * data.DATNetSalesM1 / 100;
                data.DATValueM2 = data.DATValueM2P * data.DATNetSalesM2 / 100;
                data.DATValueM3 = data.DATValueM3P * data.DATNetSalesM3 / 100;
                data.DATValueM4 = data.DATValueM4P * data.DATNetSalesM4 / 100;
                data.DATValueM5 = data.DATValueM5P * data.DATNetSalesM5 / 100;
                data.DATValueM6 = data.DATValueM6P * data.DATNetSalesM6 / 100;
                data.DATValueM7 = data.DATValueM7P * data.DATNetSalesM7 / 100;
                data.DATValueM8 = data.DATValueM8P * data.DATNetSalesM8 / 100;
                data.DATValueM9 = data.DATValueM9P * data.DATNetSalesM9 / 100;
                data.DATValueM10 = data.DATValueM10P * data.DATNetSalesM10 / 100;
                data.DATValueM11 = data.DATValueM11P * data.DATNetSalesM11 / 100;
                data.DATValueM12 = data.DATValueM12P * data.DATNetSalesM12 / 100;
                data.DATValueM13 = data.DATValueM13P * data.DATNetSalesM13 / 100;

            }

            MapValues(data, $parentTr, $periods, decimalPlaces);

            return false;

        },
        GetLinkedPayrollData: function (e) {
            var $target = e;
            if ($($($target).attr('data-target')).html() == undefined) {

                $('.layout').show();

                var $currentTr = $($target).parents('tr');

                var payrollId = parseInt($currentTr.find('#hdnCatCalucaltedType').html() == "EFP" ? $currentTr.find('#hdnCatCalucaltedOn').html().split('|')[0].trim().toString() : $currentTr.find('#hdnCatCalucaltedOn').html());
                var $parentTr = $($target).parents('tr').prevAll('tr[data-level="' + (parseInt($($target).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');
                var formulaId = parseInt($currentTr.find('#hdnCatCalucaltedType').html() == "EFP" ? $currentTr.find('#hdnCatCalucaltedOn').html().split('|')[1].trim().toString() : -1);
                var inEditMode = $parentTr.hasClass('inEditMode');

                var storeUID = $currentTr.find('#hdnStoreUID').html();
                var categoryUID = $currentTr.find('#hdnCatUID').html().trim();

                var plElementUID = $currentTr.find('#hdnPLElementUID').html();

                var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();
                var STCCompM13 = $currentTr.find('#STCCompM13').eq(0).text();

                $.ajax({
                    url: '/Budget/GetLinkedCategoryPayrollData',
                    data: JSON.stringify({ empPayrollUID: payrollId, storeUID: storeUID, categoryUID: categoryUID, plElementUID: plElementUID, decimalPlaces: getDecimalPlaces($currentTr), formulaId: formulaId, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1") }),
                    dataType: 'html',
                    type: 'post',
                    contentType: 'application/json',
                    success: function (result) {
                        var newID = 'formulaModal' + Math.floor(1000 + Math.random() * 9999);
                        $($target).attr('data-target', '#' + newID);
                        $('.page-content-wrapper').append(result);
                        $('.page-content-wrapper').find('#formulaModal').attr('id', newID);
                        $('#' + newID).find('.popup-formulaId').val(payrollId);
                        $('#' + newID).find('.lockedMonths').attr('readonly', 'readonly');

                        $('.page-content-wrapper').append('<div class="hide ' + (newID + '-1') + '">' + $('#' + newID).html() + '</div>');

                        $(document).on('hidden.bs.modal', '#' + newID, function () {
                            $('#' + newID).html($('.' + newID + '-1').html());
                        });

                        $(document).on('shown.bs.modal', '#' + newID, function () {
                            RetailBudgetPro.Budget.FormulaPopUpAudits = [];

                            //added by Himanshu as the radio button were not getting checked because of they got duplicated
                            if ($('#' + newID + ' [name="RoundType"]').length > 0) {
                                $('#' + newID + ' [name="EmployeePayroll.RoundType"][value="' + $('#' + newID + ' [name="RoundType"]').val() + '"]').attr('checked', 'checked');
                            }
                        });

                        $(document).on('show.bs.modal', '#' + newID, function () {

                            var $targetDiv = $('[data-target="#' + $(this).attr('id') + '"]');

                            var $parentRow = $($targetDiv).parents('tr').prevAll('tr[data-level="' + (parseInt($($targetDiv).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');

                            var inEditMode = $parentTr.hasClass('inEditMode');

                            if ($(this).find('[name="EmployeePayroll.EmpTypeSP"]').val() == "P") {

                                if (inEditMode) {
                                    if ($('#hdnIsUserInManageAdminPayrollRole').val() != "True") {
                                        $(this).find('.allocation-table [type="text"]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');
                                    }
                                    else {
                                        $(this).find('.allocation-table .payrollDistributeEvenly').removeClass('hide');
                                        $(this).find('.allocation-table .periodRedistribute').removeClass('hide');
                                        $(this).find('.allocation-table .copyPeriodValues').removeClass('hide');

                                    }
                                    $(this).find('.savePayrollDataForParentEmp').removeClass('hide');
                                    $(this).find('.show-employee-stores').removeClass('hide');
                                    $(this).find('.action-head').removeClass('hide');
                                    $(this).find('.action-btn').removeClass('hide');

                                    if ($('[name="ShowVendor"]').val() == "True")
                                         $(this).find('.addNewRow').removeClass('hide')

                                    $(this).find('tr').filter(function () {

                                        $(this).find('.copyPeriodValues').removeClass('hide');
                                        $(this).find('.periodRedistribute').removeClass('hide');
                                    });

                                    $(this).find('.formulamodal-sec.store-grid table').addClass('editable');

                                    if ($(this).find('[name="EmployeePayroll.CompType"]').val() == "S") {

                                        $(this).find('[name="EmployeePayroll.DisplayAmountFormat"][value="' + $(this).find('[name="DisplayFormat"]').val() + '"]').attr('checked', 'checked');

                                        $(this).find('[name="EmployeePayroll.RoundType"][value="' + $(this).find('[name="RoundType"]').val() + '"]').attr('checked', 'checked');

                                    }

                                    $(this).find('.growthRateFlag a').addClass('growthAfterEdit');
                                    $(this).find('.growthRateFlag a').removeClass('growthdata');
                                    $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').removeClass('readonlyTxt');
                                    $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('yellowBckgTxtBx');
                                    $(this).find('.GrowthRateDiv table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.allocationSalaryDollarCheck table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.showDollarAmount').removeClass('hide');
                                    $(this).find('.RecalculateForParentEmp').removeClass('hide');
                                    $('#' + newID).find('[data-toggle="popover"]').popover({
                                        html: true,
                                        content: function () {
                                            return $(this).parents('td').find('.growthDataContent').html();
                                        },
                                        delay: { show: 50, hide: 100 }
                                    });

                                    $('#' + newID + ' .vendor').hide();
                                    $('#' + newID + ' .vendorDD:not(.hidePayrollVendor) ').removeClass("hide");

                                    $('#' + newID + ' select[name$="VendorUID"]').select2({
                                        dropdownAutoWidth: 'true',
                                        width: 'auto',
                                        dropdownCssClass: 'payroll-grid-selectors'
                                    });
                                    RetailBudgetPro.Budget.DisableChildDropDown();

                                    if ($('#hdnLockedMonths').val() != "")
                                        $('.deleteChildRow').addClass('hide')
                                }
                                else {
                                    $(this).find('.addNewRow').addClass('hide')
                                    $(this).find('.savePayrollDataForParentEmp').addClass('hide');
                                    $(this).find('.action-head').addClass('hide');
                                    $(this).find('.action-btn').addClass('hide');

                                    $(this).find('.allocation-table .payrollDistributeEvenly').addClass('hide');
                                    $(this).find('.allocation-table .periodRedistribute').addClass('hide');
                                    $(this).find('.allocation-table .copyPeriodValues').addClass('hide');
                                    $(this).find('.formulamodal-sec.store-grid table').removeClass('editable');

                                    $(this).find('.formulamodal-sec.store-grid table tbody [type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');
                                    $(this).find('.usePeriodRedistribution').addClass('hide');

                                    $(this).find('.totals-row').filter(function () {
                                        $(this).find('td:first').attr('colspan', '1');
                                    });

                                    if ($(this).find('[name="EmployeePayroll.CompType"]').val() == "S") {

                                        $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('readonlyTxt');
                                        $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').removeClass('yellowBckgTxtBx');
                                        $(this).find('[name="EmployeePayroll.DisplayAmountFormat"][value="' + $(this).find('[name="DisplayFormat"]').val() + '"]').attr('checked', 'checked');
                                        $(this).find('[name="EmployeePayroll.RoundType"][value="' + $(this).find('[name="RoundType"]').val() + '"]').attr('checked', 'checked');

                                    }

                                    $(this).find('.growthRateFlag a').addClass('growthdata');
                                    $(this).find('.growthRateFlag a').removeClass('growthAfterEdit');
                                    $(this).find('.GrowthRateDiv table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.allocationSalaryDollarCheck table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.showDollarAmount').addClass('hide');
                                    $(this).find('.RecalculateForParentEmp').addClass('hide');

                                    $('#' + newID).find('[data-toggle="popover"]').popover({
                                        html: true,
                                        content: function () {
                                            return $(this).parents('td').find('.growthDataContent').html();
                                        },
                                        delay: { show: 50, hide: 100 }
                                    });
                                    $('#' + newID + ' .vendor').show();
                                    $('#' + newID + ' .vendorDD ').addClass("hide");
                                }

                            }
                            else {
                                
                                if (inEditMode) {
                                    if ($('#hdnIsUserInManageAdminPayrollRole').val() != "True") {
                                        $(this).find('.allocation-table [type="text"]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');
                                    }
                                    else {
                                        $(this).find('.allocation-table .payrollDistributeEvenly').removeClass('hide');
                                        $(this).find('.allocation-table .periodRedistribute').removeClass('hide');
                                        $(this).find('.allocation-table .copyPeriodValues').removeClass('hide');

                                    }
                                    $(this).find('.save-payroll-data').removeClass('hide');
                                    $(this).find('.show-employee-stores').removeClass('hide');
                                    $(this).find('.action-head').removeClass('hide');
                                    $(this).find('.action-btn').removeClass('hide');

                                    $(this).find('tr').filter(function () {

                                        $(this).find('.copyPeriodValues').removeClass('hide');
                                        $(this).find('.periodRedistribute').removeClass('hide');
                                    });

                                    $(this).find('.formulamodal-sec.store-grid table').addClass('editable');

                                    if ($(this).find('[name="EmployeePayroll.CompType"]').val() == "S") {

                                        $(this).find('[name="EmployeePayroll.DisplayAmountFormat"][value="' + $(this).find('[name="DisplayFormat"]').val() + '"]').attr('checked', 'checked');

                                        $(this).find('[name="EmployeePayroll.RoundType"][value="' + $(this).find('[name="RoundType"]').val() + '"]').attr('checked', 'checked');

                                        if ($(this).find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT") {
                                            $(this).find('.allocationSalaryCheck table td.percentage').show();
                                            $(this).find('.allocationSalaryCheck table td.data').hide();
                                            $(this).find('.annualSalaryTxtBoxDiv').show();
                                            $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').removeClass('readonlyTxt');
                                            $(this).find('.dollarOrPercentage').text("Average");
                                            $(this).find('.changeTitle').attr("title", "Average")
                                        }
                                        else {
                                            $(this).find('.allocationSalaryCheck table td.percentage').hide();
                                            $(this).find('.allocationSalaryCheck table td.data').show();
                                            $(this).find('.annualSalaryTxtBoxDiv').hide();
                                            $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('readonlyTxt');
                                            $(this).find('.dollarOrPercentage').text("Total");
                                            $(this).find('.changeTitle').attr("title", "Total")
                                        }
                                    }

                                    $(this).find('.growthRateFlag a').addClass('growthAfterEdit');
                                    $(this).find('.growthRateFlag a').removeClass('growthdata');
                                    $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').removeClass('readonlyTxt');
                                    $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('yellowBckgTxtBx');
                                    $(this).find('.GrowthRateDiv table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.allocationSalaryDollarCheck table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.showDollarAmount').removeClass('hide');
                                    $(this).find('.RecalculateForParentEmp').removeClass('hide');
                                    $('#' + newID).find('[data-toggle="popover"]').popover({
                                        html: true,
                                        content: function () {
                                            return $(this).parents('td').find('.growthDataContent').html();
                                        },
                                        delay: { show: 50, hide: 100 }
                                    });
                                    $('#' + newID + ' .vendor').hide();
                                    $('#' + newID + ' .vendorDD ').removeClass("hide");
                                    $('#' + newID + ' .vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });

                                }
                                else {
                                    $(this).find('.save-payroll-data').addClass('hide');
                                    $(this).find('.action-head').addClass('hide');
                                    $(this).find('.action-btn').addClass('hide');

                                    $(this).find('.allocation-table .payrollDistributeEvenly').addClass('hide');
                                    $(this).find('.allocation-table .periodRedistribute').addClass('hide');
                                    $(this).find('.allocation-table .copyPeriodValues').addClass('hide');
                                    $(this).find('.formulamodal-sec.store-grid table').removeClass('editable');

                                    $(this).find('.formulamodal-sec.store-grid table tbody [type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');
                                    $(this).find('.usePeriodRedistribution').addClass('hide');

                                    $(this).find('.totals-row').filter(function () {
                                        $(this).find('td:first').attr('colspan', '1');
                                    });

                                    if ($(this).find('[name="EmployeePayroll.CompType"]').val() == "S") {

                                        $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('readonlyTxt');
                                        $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').removeClass('yellowBckgTxtBx');
                                        $(this).find('[name="EmployeePayroll.DisplayAmountFormat"][value="' + $(this).find('[name="DisplayFormat"]').val() + '"]').attr('checked', 'checked');
                                        $(this).find('[name="EmployeePayroll.RoundType"][value="' + $(this).find('[name="RoundType"]').val() + '"]').attr('checked', 'checked');

                                        if ($(this).find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT") {
                                            $(this).find('.allocationSalaryCheck table td.percentage').show();
                                            $(this).find('.allocationSalaryCheck table td.data').hide();
                                            $(this).find('.annualSalaryTxtBoxDiv').show();
                                            $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('readonlyTxt');
                                            $(this).find('.dollarOrPercentage').text("Average");
                                            $(this).find('.changeTitle').attr("title", "Average")
                                        }
                                        else {
                                            $(this).find('.allocationSalaryCheck table td.percentage').hide();
                                            $(this).find('.allocationSalaryCheck table td.data').show();
                                            $(this).find('.annualSalaryTxtBoxDiv').hide();
                                            $(this).find('[name="EmployeePayroll.AnnualSalaryAmount"]').addClass('readonlyTxt');
                                            $(this).find('.dollarOrPercentage').text("Total");
                                            $(this).find('.changeTitle').attr("title", "Total")
                                        }
                                    }

                                    $(this).find('.growthRateFlag a').addClass('growthdata');
                                    $(this).find('.growthRateFlag a').removeClass('growthAfterEdit');
                                    $(this).find('.GrowthRateDiv table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.allocationSalaryDollarCheck table tbody [type=text]').addClass('readonlyTxt');
                                    $(this).find('.showDollarAmount').addClass('hide');
                                    $(this).find('.RecalculateForParentEmp').addClass('hide');

                                    $('#' + newID).find('[data-toggle="popover"]').popover({
                                        html: true,
                                        content: function () {
                                            return $(this).parents('td').find('.growthDataContent').html();
                                        },
                                        delay: { show: 50, hide: 100 }
                                    });
                                    $('#' + newID + ' .vendor').show();
                                    $('#' + newID + ' .vendorDD ').addClass("hide");
                                }

                                $(this).find('input[type="text"]:not(.sumo-search,[name=EADescription])').calculator({ customDecimalPlaces: $(this).attr('data-decimalplaces') });
                            }

                            $(this).find('tr.non-editable-row').hide();

                            HireDateCheck($($target).attr('data-target'));
                            DisableInActivePeriods($($target).attr('data-target'));
                            DisableLockedPeriods();

                        });

                        if (STCCompM1 == "N")
                            $('#' + newID).find('input[data-period="P01"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM2 == "N")
                            $('#' + newID).find('input[data-period="P02"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM3 == "N")
                            $('#' + newID).find('input[data-period="P03"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM4 == "N")
                            $('#' + newID).find('input[data-period="P04"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM5 == "N")
                            $('#' + newID).find('input[data-period="P05"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM6 == "N")
                            $('#' + newID).find('input[data-period="P06"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM7 == "N")
                            $('#' + newID).find('input[data-period="P07"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM8 == "N")
                            $('#' + newID).find('input[data-period="P08"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM9 == "N")
                            $('#' + newID).find('input[data-period="P09"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM10 == "N")
                            $('#' + newID).find('input[data-period="P10"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM11 == "N")
                            $('#' + newID).find('input[data-period="P11"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM12 == "N")
                            $('#' + newID).find('input[data-period="P12"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM13 == "N")
                            $('#' + newID).find('input[data-period="P13"]').attr('readonly', 'readonly').addClass('removeBackgndColor');

                        $('.layout').hide();

                        $('#' + newID).modal('show');


                    },
                    error: function (er) {
                        console.log(er);
                    }
                });
            }
            else {
                var $currentTr = $($target).parents('tr');
                var newID = $($target).attr('data-target');

                var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();
                var STCCompM13 = $currentTr.find('#STCCompM13').eq(0).text();

                if (STCCompM1 == "N")
                    $(newID).find('input[data-period="P01"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM2 == "N")
                    $(newID).find('input[data-period="P02"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM3 == "N")
                    $(newID).find('input[data-period="P03"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM4 == "N")
                    $(newID).find('input[data-period="P04"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM5 == "N")
                    $(newID).find('input[data-period="P05"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM6 == "N")
                    $(newID).find('input[data-period="P06"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM7 == "N")
                    $(newID).find('input[data-period="P07"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM8 == "N")
                    $(newID).find('input[data-period="P08"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM9 == "N")
                    $(newID).find('input[data-period="P09"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM10 == "N")
                    $(newID).find('input[data-period="P10"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM11 == "N")
                    $(newID).find('input[data-period="P11"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM12 == "N")
                    $(newID).find('input[data-period="P12"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM13 == "N")
                    $(newID).find('input[data-period="P13"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
            }
        },
        SavePayrollData: function () {

            $('.layout').show();

            var $formaulaModal = $('#' + $(this).parents('.modal').attr('id'));

            var hasError = false;

            var storeDataObj = [];

            var allocationData = {};

            var headCountData = {};

            var raisePercentData = {};

            var errorMsg = '';

            var annualSalary = 0;

            var displayFormat = 'DOLLARS';

            $formaulaModal.find('tr.store-data-row').each(function () {

                var valueToCopy = $(this).find('td input[data-currentvalue]:not(.disabledByBudInactive)').filter(function (i, v) {
                    return $(v).val().replace(/,/g, "") != 0;
                }).eq(0).val();

                $(this).find('td input.disabledByBudInactive:not(.disabledByHire)').attr('data-currentvalue', valueToCopy).val(valueToCopy);
            });


            if ($formaulaModal.find('.allocation-table').length != 0) {
                var $pRow = $formaulaModal.find('.allocation-table tbody tr');
                if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                    allocationData = {
                        "EmpAllocationUID": $pRow.find('[name=EmpAllocationUID]').val(), "EADescription": $pRow.find('[name=EADescription]').val(), "EAValueM1": parseFloat($pRow.find('input[data-Period="P01"]').val().replace(/,/g, "")), "EAValueM2": parseFloat($pRow.find('input[data-Period="P02"]').val().replace(/,/g, ""))
                        , "EAValueM3": parseFloat($pRow.find('input[data-Period="P03"]').val().replace(/,/g, "")), "EAValueM4": parseFloat($pRow.find('input[data-Period="P04"]').val().replace(/,/g, "")), "EAValueM5": parseFloat($pRow.find('input[data-Period="P05"]').val().replace(/,/g, ""))
                        , "EAValueM6": parseFloat($pRow.find('input[data-Period="P06"]').val().replace(/,/g, "")), "EAValueM7": parseFloat($pRow.find('input[data-Period="P07"]').val().replace(/,/g, "")), "EAValueM8": parseFloat($pRow.find('input[data-Period="P08"]').val().replace(/,/g, ""))
                        , "EAValueM9": parseFloat($pRow.find('input[data-Period="P09"]').val().replace(/,/g, "")), "EAValueM10": parseFloat($pRow.find('input[data-Period="P10"]').val().replace(/,/g, "")), "EAValueM11": parseFloat($pRow.find('input[data-Period="P11"]').val().replace(/,/g, ""))
                        , "EAValueM12": parseFloat($pRow.find('input[data-Period="P12"]').val().replace(/,/g, "")), "EAValueM13": parseFloat($pRow.find('input[data-Period="P13"]').val().replace(/,/g, "")), "EABudgetUID": parseFloat($pRow.find('[name=EABudgetUID]').val()), "EAYear": $pRow.find('[name=EAYear]').val()
                    };
                    //hasError = allocationData.EAValueM1 + allocationData.EAValueM2 + allocationData.EAValueM3 + allocationData.EAValueM4 + allocationData.EAValueM5 + allocationData.EAValueM6 + allocationData.EAValueM7 +
                    //           allocationData.EAValueM8 + allocationData.EAValueM9 + allocationData.EAValueM10 + allocationData.EAValueM11 + allocationData.EAValueM12 + allocationData.EAValueM13 != 13;

                    //errorMsg = 'Allocation total must be equal to 13.';
                }
                else {
                    allocationData = {
                        "EmpAllocationUID": $pRow.find('[name=EmpAllocationUID]').val(), "EADescription": $pRow.find('[name=EADescription]').val(), "EAValueM1": parseFloat($pRow.find('input[data-Period="P01"]').val().replace(/,/g, "")), "EAValueM2": parseFloat($pRow.find('input[data-Period="P02"]').val().replace(/,/g, ""))
                        , "EAValueM3": parseFloat($pRow.find('input[data-Period="P03"]').val().replace(/,/g, "")), "EAValueM4": parseFloat($pRow.find('input[data-Period="P04"]').val().replace(/,/g, "")), "EAValueM5": parseFloat($pRow.find('input[data-Period="P05"]').val().replace(/,/g, ""))
                        , "EAValueM6": parseFloat($pRow.find('input[data-Period="P06"]').val().replace(/,/g, "")), "EAValueM7": parseFloat($pRow.find('input[data-Period="P07"]').val().replace(/,/g, "")), "EAValueM8": parseFloat($pRow.find('input[data-Period="P08"]').val().replace(/,/g, ""))
                        , "EAValueM9": parseFloat($pRow.find('input[data-Period="P09"]').val().replace(/,/g, "")), "EAValueM10": parseFloat($pRow.find('input[data-Period="P10"]').val().replace(/,/g, "")), "EAValueM11": parseFloat($pRow.find('input[data-Period="P11"]').val().replace(/,/g, ""))
                        , "EAValueM12": parseFloat($pRow.find('input[data-Period="P12"]').val().replace(/,/g, "")), "EAValueM13": 0, "EABudgetUID": $pRow.find('[name=EABudgetUID]').val(), "EAYear": $pRow.find('[name=EAYear]').val()
                    };
                    //hasError = allocationData.EAValueM1 + allocationData.EAValueM2 + allocationData.EAValueM3 + allocationData.EAValueM4 + allocationData.EAValueM5 + allocationData.EAValueM6 + allocationData.EAValueM7 +
                    //           allocationData.EAValueM8 + allocationData.EAValueM9 + allocationData.EAValueM10 + allocationData.EAValueM11 + allocationData.EAValueM12 != 12;

                    //errorMsg = 'Allocation total must be equal to 12.';
                }

                //if (hasError) {
                //    $formaulaModal.find('.allocationDataErr span').html(errorMsg);
                //}
                //else {
                $formaulaModal.find('.allocationDataErr span').html("");
                //}
            }

            if ($formaulaModal.find('[name="EmployeePayroll.CompType"]').val() == "S") {
                DistributeAnnualSalary('#' + $(this).parents('.payrollModal').attr('id'));
                CalculateRateGrowth('#' + $(this).parents('.payrollModal').attr('id'));
                //SalaryAllocationStoresDataList
                if ($formaulaModal.find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" && $formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').length > 0 && $formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').val() == "") {
                    hasError = true;
                    var errMsg = "Annual Salary is required.";

                    $formaulaModal.find('.allocationSalaryErr').removeClass('hide').addClass('show').html(errMsg);
                }
                else {
                    displayFormat = $formaulaModal.find('[name="DisplayFormat"]').val();
                    annualSalary = displayFormat != "PERCENT" ? 0 : ($formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').length > 0 ? $formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').val().replace(/,/g, "") : $formaulaModal.find('[name="AnnualSalary"]').val().replace(/,/g, ""));
                    $formaulaModal.find('.allocationSalaryCheck tr.store-data-row').each(function () {
                        var $pRow = $(this);
                        var tdSelector = "td.percentage";
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StorePercentP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP13": $pRow.find(tdSelector + ' input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": ""
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "PERCENT"
				                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                            storeDataObj.push(storeData);
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StorePercentP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StorePercentP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP13": "0", "DistributionType": "Allocation", "ValueType": ""
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "PERCENT"
			                  	, "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                            storeDataObj.push(storeData);
                        }
                    });

                    $formaulaModal.find('.allocationSalaryDollarCheck tr.store-data-row').each(function () {
                        var $pRow = $(this);
                        var tdSelector = "td.data";
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find(tdSelector + ' input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": ""
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                            storeDataObj.push(storeData);
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Allocation", "ValueType": ""
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                            storeDataObj.push(storeData);
                        }
                    });

                    $formaulaModal.find('.allocationSalaryErr').removeClass('show').addClass('hide').html("");
                }

                if ($formaulaModal.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {
                    $formaulaModal.find('.overtimeSalaryCheck tr.store-data-row').each(function () {
                        var $pRow = $(this);
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "H"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "H"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
				                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                        }

                        storeDataObj.push(storeData);
                    });

                    $formaulaModal.find('.overtimeSalaryRateCheck tr.store-data-row').each(function () {
                        var $pRow = $(this);
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').val().replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "R"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                            };
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "R"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                            };
                        }

                        storeDataObj.push(storeData);
                    });
                }
            }
            else if ($formaulaModal.find('[name="EmployeePayroll.CompType"]').val() == "H") {
                CalculateRateGrowth('#' + $(this).parents('.payrollModal').attr('id'));
                //HourlyAllocationStoresDataList
                $formaulaModal.find('.allocationHourCheck tr.store-data-row').each(function () {
                    var $pRow = $(this);
                    if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                        storeData = {
                            "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": "H"
                            , "IsSelected": true
                            , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                            , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                            , "FormatType": "DOLLAR"
                            , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                        };
                    }
                    else {
                        storeData = {
                            "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                            , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Allocation", "ValueType": "H"
                            , "IsSelected": true
                            , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                            , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                            , "FormatType": "DOLLAR"
			                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                        };
                    }

                    storeDataObj.push(storeData);
                });

                $formaulaModal.find('.allocationHourlyRateCheck tr.store-data-row').each(function () {
                    var $pRow = $(this);
                    if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                        storeData = {
                            "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                            , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                            , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                            , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                            , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').val().replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": "R"
                            , "IsSelected": true
                            , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                            , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                            , "FormatType": "DOLLAR"
                        };
                    }
                    else {
                        storeData = {
                            "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                            , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                            , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                            , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                            , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Allocation", "ValueType": "R"
                            , "IsSelected": true
                            , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                            , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                            , "FormatType": "DOLLAR"
                        };
                    }

                    storeDataObj.push(storeData);
                });

                //HourlyOvertimeStoresDataList
                if ($formaulaModal.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {
                    $formaulaModal.find('.overtimeHourCheck tr.store-data-row').each(function () {
                        var $pRow = $(this);
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "H"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
				                , "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "H"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
		                 		, "VendorUIDCSV": $pRow.find('[name*=VendorUID]').val() != null ? $pRow.find('[name*=VendorUID]').val().join() : ''
                            };
                        }

                        storeDataObj.push(storeData);
                    });

                    $formaulaModal.find('.overtimeHourlyRateCheck tr.store-data-row').each(function () {
                        var $pRow = $(this);
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').val().replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "R"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                            };
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "R"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                            };
                        }

                        storeDataObj.push(storeData);
                    });
                }
            }

            if ($formaulaModal.find('.headCountTable').length != 0) {
                var $pRow = $formaulaModal.find('.headCountTable tbody tr');
                if ($('[name="HeadCountType"]').val() == "CATEGORY") {
                    headCountData = {
                        "RoundType": $formaulaModal.find('[name="EmployeePayroll.RoundType"]:checked').val()
                    };
                }
                else {
                    if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                        headCountData = {
                            "HeadcountM1": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM2": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM3": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM4": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM5": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM6": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM7": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM8": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM9": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM13": parseFloat($pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""))
                        };
                    }
                    else {
                        headCountData = {
                            "HeadcountM1": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM2": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM3": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM4": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM5": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM6": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM7": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM8": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM9": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM13": 0
                        };
                    }
                }
            }
            if ($formaulaModal.find('.allocationRaiseTable').length != 0) {
                var $pRow = $formaulaModal.find('.allocationRaiseTable tbody tr');
                if ($('#hdnNumberOfPeriods').attr('data-currentvalue') == "13") {
                    raisePercentData = {
                        "GrowthStoreP01": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP02": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP03": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP04": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP05": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP06": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP07": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP08": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP09": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP13": parseFloat($pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""))
                    };
                }
                else {
                    raisePercentData = {
                        "GrowthStoreP01": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP02": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP03": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP04": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP05": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP06": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP07": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP08": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP09": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP13": 0
                    };
                }
            }

            if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                var rowString = '';

                $('.expanded').map(function (v) {
                    rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                });

                var $linkedRow = $('.linked-category-data[data-target="#' + $formaulaModal.attr('id') + '"]').parents('tr');

                var $activeRow = $linkedRow.prevAll('[data-level=' + ($linkedRow.attr('data-level') - 1) + ']').eq(0);

                localStorage.setItem("ActiveRow", $activeRow.find('#hdnStoreUID').html() + '|' + $activeRow.find('#hdnDeptUID').html() + '|' + $activeRow.find('#hdnCatUID').html());

                localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

            }

            localStorage.setItem("ExpandRows", "True");

            console.log(localStorage.getItem("ExpandedRows"));

            //console.log(dataObj);

            if (!hasError) {
                $('#' + $formaulaModal.attr('id')).modal('toggle');

                var stores = [];
                var groupedcategory = $('[name=groupedcategory] :selected').val();
                var stores = $('[name=lstStores]').val().toString();
                var level = "0";
                var viewLevel = "STORE";
                var storeID = "-1";
                var deptID = "-1";
                var categoryID = "-1";
                var venDescription = $formaulaModal.find('table.total-summary-row tbody td.vendorTd .ven-desc[type=text]').val();
                var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                $.ajax({
                    url: '/Budget/SaveEmployeePayrollStoresData',
                    type: 'POST',
                    async: true,
                    dataType: 'html',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ empPayrollUID: $formaulaModal.find('[name="EmployeePayroll.EmpPayrollUID"]').val(), compType: $formaulaModal.find('[name="EmployeePayroll.CompType"]').val(), hasOvertimePay: $formaulaModal.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True", lstStoresData: storeDataObj, employeeAllocationData: allocationData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, displayFormat: displayFormat, annualSalary: annualSalary, headCountData: headCountData, raisePercentData: raisePercentData, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), vendorIdCSV: $('[name="datapageVendordd"]').length == 0 ? "-2" : $('[name="datapageVendordd"]').val().join(','), bsMode: bsMode, categoryType: categoryType }),
                    success: function (data) {
                        var isValid = true;
                        if ($('[name=AllowBatchUpdates]').val() == 'True') {
                            try {
                                var result = $.parseJSON(data);

                                if (result.result == 2) {
                                    isValid = false;
                                    $('.layout').hide();

                                    var confirm_click = function () {
                                        window.location.reload();
                                    }

                                    custom_alert(confirm_click, "Alert", "Can not save data as formula execution is started.");
                                }
                            }
                            catch (e) {

                            }
                        }

                        if (isValid) {
                            RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                            $('#DataInputTable tbody').html('');
                            $('#DataInputTable tbody').html(data);
                            $(".hideyear").each(function () {
                                $(this).removeAttr("data-level");
                            });
                            $('#DataInputTable').find('.displayVendor').addClass('hide');
                            $('#DataInputTable').tabelize();
                            RetailBudgetPro.Budget.ManageDataAndPerentage();
                            $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                            $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                            $('.hideyear').find('td:first').html('');
                        }
                    }
                });
            }
            else {
                $('.layout').hide();
            }
        },

        SavePayrollDataForParentEmp: function () {

            $('.layout').show();

            var $formaulaModal = $('#' + $(this).parents('.modal').attr('id'));

            var hasError = false;

            var storeDataObj = [];

            var allocationData = {};

            var headCountData = {};

            var raisePercentData = {};

            var errorMsg = '';

            var annualSalary = 0;

            var displayFormat = 'DOLLARS';

            var categoryUID = $formaulaModal.find('[name="EmployeePayroll.AllocationCategoryUID"]').val();

            var StoreUID = 0;

            DistributeAnnualSalaryForParentEmp('#' + $('.payrollModal').attr('id'));

            $formaulaModal.find('tr.store-childData-row').each(function () {

                var valueToCopy = $(this).find('td input[data-currentvalue]:not(.disabledByBudInactive)').filter(function (i, v) {
                    return $(v).val().replace(/,/g, "") != 0;
                }).eq(0).val();

                $(this).find('td input.disabledByBudInactive:not(.disabledByHire)').attr('data-currentvalue', valueToCopy).val(valueToCopy);
            });


            if ($formaulaModal.find('.allocation-table').length != 0) {
                var $pRow = $formaulaModal.find('.allocation-table tbody tr');
                if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                    allocationData = {
                        "EmpAllocationUID": $pRow.find('[name=EmpAllocationUID]').val(), "EADescription": $pRow.find('[name=EADescription]').val(), "EAValueM1": parseFloat($pRow.find('input[data-Period="P01"]').val().replace(/,/g, "")), "EAValueM2": parseFloat($pRow.find('input[data-Period="P02"]').val().replace(/,/g, ""))
                        , "EAValueM3": parseFloat($pRow.find('input[data-Period="P03"]').val().replace(/,/g, "")), "EAValueM4": parseFloat($pRow.find('input[data-Period="P04"]').val().replace(/,/g, "")), "EAValueM5": parseFloat($pRow.find('input[data-Period="P05"]').val().replace(/,/g, ""))
                        , "EAValueM6": parseFloat($pRow.find('input[data-Period="P06"]').val().replace(/,/g, "")), "EAValueM7": parseFloat($pRow.find('input[data-Period="P07"]').val().replace(/,/g, "")), "EAValueM8": parseFloat($pRow.find('input[data-Period="P08"]').val().replace(/,/g, ""))
                        , "EAValueM9": parseFloat($pRow.find('input[data-Period="P09"]').val().replace(/,/g, "")), "EAValueM10": parseFloat($pRow.find('input[data-Period="P10"]').val().replace(/,/g, "")), "EAValueM11": parseFloat($pRow.find('input[data-Period="P11"]').val().replace(/,/g, ""))
                        , "EAValueM12": parseFloat($pRow.find('input[data-Period="P12"]').val().replace(/,/g, "")), "EAValueM13": parseFloat($pRow.find('input[data-Period="P13"]').val().replace(/,/g, "")), "EABudgetUID": parseFloat($pRow.find('[name=EABudgetUID]').val()), "EAYear": $pRow.find('[name=EAYear]').val()
                    };
                }
                else {
                    allocationData = {
                        "EmpAllocationUID": $pRow.find('[name=EmpAllocationUID]').val(), "EADescription": $pRow.find('[name=EADescription]').val(), "EAValueM1": parseFloat($pRow.find('input[data-Period="P01"]').val().replace(/,/g, "")), "EAValueM2": parseFloat($pRow.find('input[data-Period="P02"]').val().replace(/,/g, ""))
                        , "EAValueM3": parseFloat($pRow.find('input[data-Period="P03"]').val().replace(/,/g, "")), "EAValueM4": parseFloat($pRow.find('input[data-Period="P04"]').val().replace(/,/g, "")), "EAValueM5": parseFloat($pRow.find('input[data-Period="P05"]').val().replace(/,/g, ""))
                        , "EAValueM6": parseFloat($pRow.find('input[data-Period="P06"]').val().replace(/,/g, "")), "EAValueM7": parseFloat($pRow.find('input[data-Period="P07"]').val().replace(/,/g, "")), "EAValueM8": parseFloat($pRow.find('input[data-Period="P08"]').val().replace(/,/g, ""))
                        , "EAValueM9": parseFloat($pRow.find('input[data-Period="P09"]').val().replace(/,/g, "")), "EAValueM10": parseFloat($pRow.find('input[data-Period="P10"]').val().replace(/,/g, "")), "EAValueM11": parseFloat($pRow.find('input[data-Period="P11"]').val().replace(/,/g, ""))
                        , "EAValueM12": parseFloat($pRow.find('input[data-Period="P12"]').val().replace(/,/g, "")), "EAValueM13": 0, "EABudgetUID": $pRow.find('[name=EABudgetUID]').val(), "EAYear": $pRow.find('[name=EAYear]').val()
                    };
                }

                $formaulaModal.find('.allocationDataErr span').html("");
            }

            if ($formaulaModal.find('[name="EmployeePayroll.CompType"]').val() == "S") {

                if ($('#ShowVendor').val() == "True" && CheckForUniqueRows('allocationSalaryCheck', $formaulaModal)) {

                    hasError = true;
                    var errMsg = $('[name="VendorName"]').val() + " must be unique for each sub-row.";

                    $formaulaModal.find('.allocationSalaryErr').removeClass('hide').addClass('show').html(errMsg);
                }
                else {
                    DistributeAnnualSalary('#' + $(this).parents('.payrollModal').attr('id'));
                    CalculateRateGrowth('#' + $(this).parents('.payrollModal').attr('id'));
                    //SalaryAllocationStoresDataList
                    if ($formaulaModal.find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" && $formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').length > 0 && $formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').val() == "") {
                        hasError = true;
                        var errMsg = "Annual Salary is required.";

                        $formaulaModal.find('.allocationSalaryErr').removeClass('hide').addClass('show').html(errMsg);
                    }
                    else {
                        displayFormat = $formaulaModal.find('[name="DisplayFormat"]').val();
                        annualSalary = displayFormat != "PERCENT" ? 0 : ($formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').length > 0 ? $formaulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').val().replace(/,/g, "") : $formaulaModal.find('[name="AnnualSalary"]').val().replace(/,/g, ""));
                        $formaulaModal.find('.allocationSalaryCheck tr.store-childData-row').each(function () {
                            var $pRow = $(this);
                            var tdSelector = "td.percentage";
                            StoreUID = $pRow.find('.hdnRowStoreUID').val();
                            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StorePercentP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP13": $pRow.find(tdSelector + ' input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": ""
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "PERCENT"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                                storeDataObj.push(storeData);
                            }
                            else {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StorePercentP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StorePercentP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StorePercentP13": "0", "DistributionType": "Allocation", "ValueType": ""
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "PERCENT"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                                storeDataObj.push(storeData);
                            }
                        });

                        $formaulaModal.find('.allocationSalaryDollarCheck tr.store-childData-row').each(function () {
                            var $pRow = $(this);
                            var tdSelector = "td.data";
                            StoreUID = $pRow.find('.hdnRowStoreUID').val();
                            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find(tdSelector + ' input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": ""
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                                storeDataObj.push(storeData);
                            }
                            else {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find(tdSelector + ' input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find(tdSelector + ' input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP03": $pRow.find(tdSelector + ' input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find(tdSelector + ' input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find(tdSelector + ' input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP06": $pRow.find(tdSelector + ' input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find(tdSelector + ' input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find(tdSelector + ' input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP09": $pRow.find(tdSelector + ' input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find(tdSelector + ' input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find(tdSelector + ' input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP12": $pRow.find(tdSelector + ' input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Allocation", "ValueType": ""
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                                storeDataObj.push(storeData);
                            }
                        });

                        $formaulaModal.find('.allocationSalaryErr').removeClass('show').addClass('hide').html("");
                    }

                    if ($formaulaModal.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {
                        $formaulaModal.find('.overtimeSalaryCheck tr.store-childData-row').each(function () {
                            var $pRow = $(this);
                            StoreUID = $pRow.find('.hdnRowStoreUID').val();
                            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "H"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                            }
                            else {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "H"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                            }

                            storeDataObj.push(storeData);
                        });

                        $formaulaModal.find('.overtimeSalaryRateCheck tr.store-childData-row').each(function () {
                            var $pRow = $(this);
                            StoreUID = $pRow.find('.hdnRowStoreUID').val();
                            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').val().replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "R"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                };
                            }
                            else {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "R"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                };
                            }

                            storeDataObj.push(storeData);
                        });
                    }
                }
            }
            else if ($formaulaModal.find('[name="EmployeePayroll.CompType"]').val() == "H") {

                if ($('#ShowVendor').val() == "True" && CheckForUniqueRows('allocationHourCheck', $formaulaModal)) {

                    hasError = true;
                    var errMsg = $('[name="VendorName"]').val() + " must be unique for each sub-row.";

                    $formaulaModal.find('.allocationHourlyRateErr').removeClass('hide').addClass('show').html(errMsg);
                }
                else {
                    CalculateRateGrowth('#' + $(this).parents('.payrollModal').attr('id'));
                    //HourlyAllocationStoresDataList
                    $formaulaModal.find('.allocationHourCheck tr.store-childData-row').each(function () {
                        var $pRow = $(this);
                        StoreUID = $pRow.find('.hdnRowStoreUID').val();
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": "H"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                                , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                            };
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Allocation", "ValueType": "H"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                                , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                            };
                        }

                        storeDataObj.push(storeData);
                    });

                    $formaulaModal.find('.allocationHourlyRateCheck tr.store-childData-row').each(function () {
                        var $pRow = $(this);
                        StoreUID = $pRow.find('.hdnRowStoreUID').val();
                        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').val().replace(/,/g, ""), "DistributionType": "Allocation", "ValueType": "R"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                            };
                        }
                        else {
                            storeData = {
                                "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Allocation", "ValueType": "R"
                                , "IsSelected": true
                                , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                , "FormatType": "DOLLAR"
                            };
                        }

                        storeDataObj.push(storeData);
                    });

                    //HourlyOvertimeStoresDataList
                    if ($formaulaModal.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True") {
                        $formaulaModal.find('.overtimeHourCheck tr.store-childData-row').each(function () {
                            var $pRow = $(this);
                            StoreUID = $pRow.find('.hdnRowStoreUID').val();
                            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "H"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                            }
                            else {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "H"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                    , "VendorUIDCSV": $pRow.find('select[name$=VendorUID]').val() != null ? $pRow.find('select[name$=VendorUID]').val() : ''
                                };
                            }

                            storeDataObj.push(storeData);
                        });

                        $formaulaModal.find('.overtimeHourlyRateCheck tr.store-childData-row').each(function () {
                            var $pRow = $(this);
                            StoreUID = $pRow.find('.hdnRowStoreUID').val();
                            if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": $pRow.find('input[data-Period="P13"]').val().replace(/,/g, ""), "DistributionType": "Overtime", "ValueType": "R"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                };
                            }
                            else {
                                storeData = {
                                    "StoreUID": $pRow.find('.hdnRowStoreUID').val(), "CategoryUID": categoryUID, "StoreValP01": $pRow.find('input[data-Period="P01"]').val().replace(/,/g, ""), "StoreValP02": $pRow.find('input[data-Period="P02"]').val().replace(/,/g, "")
                                    , "StoreValP03": $pRow.find('input[data-Period="P03"]').val().replace(/,/g, ""), "StoreValP04": $pRow.find('input[data-Period="P04"]').val().replace(/,/g, ""), "StoreValP05": $pRow.find('input[data-Period="P05"]').val().replace(/,/g, "")
                                    , "StoreValP06": $pRow.find('input[data-Period="P06"]').val().replace(/,/g, ""), "StoreValP07": $pRow.find('input[data-Period="P07"]').val().replace(/,/g, ""), "StoreValP08": $pRow.find('input[data-Period="P08"]').val().replace(/,/g, "")
                                    , "StoreValP09": $pRow.find('input[data-Period="P09"]').val().replace(/,/g, ""), "StoreValP10": $pRow.find('input[data-Period="P10"]').val().replace(/,/g, ""), "StoreValP11": $pRow.find('input[data-Period="P11"]').val().replace(/,/g, "")
                                    , "StoreValP12": $pRow.find('input[data-Period="P12"]').val().replace(/,/g, ""), "StoreValP13": "0", "DistributionType": "Overtime", "ValueType": "R"
                                    , "IsSelected": true
                                    , "IsRowReset": $pRow.find('.resetCurrentRow').val()
                                    , "EmpPayrollStoreUID": $pRow.find('.empPayrollStoreUID').val()
                                    , "FormatType": "DOLLAR"
                                };
                            }

                            storeDataObj.push(storeData);
                        });
                    }
                }
            }

            if ($formaulaModal.find('.headCountTable').length != 0) {
                var $pRow = $formaulaModal.find('.headCountTable tbody tr');
                if ($('[name="HeadCountType"]').val() == "CATEGORY") {
                    headCountData = {
                        "RoundType": $formaulaModal.find('[name="EmployeePayroll.RoundType"]:checked').val()
                    };
                }
                else {
                    if ( RetailBudgetPro.Budget.numberOfPeriodsVal == "13") {
                        headCountData = {
                            "HeadcountM1": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM2": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM3": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM4": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM5": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM6": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM7": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM8": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM9": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM13": parseFloat($pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""))
                        };
                    }
                    else {
                        headCountData = {
                            "HeadcountM1": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM2": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM3": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM4": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM5": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM6": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM7": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM8": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM9": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "HeadcountM12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                            "HeadcountM13": 0
                        };
                    }
                }
            }
            if ($formaulaModal.find('.allocationRaiseTable').length != 0) {
                var $pRow = $formaulaModal.find('.allocationRaiseTable tbody tr');
                if ($('#hdnNumberOfPeriods').attr('data-currentvalue') == "13") {
                    raisePercentData = {
                        "GrowthStoreP01": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP02": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP03": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP04": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP05": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP06": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP07": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP08": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP09": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP13": parseFloat($pRow.find('input[data-Period="P13"]').attr('data-currentvalue').replace(/,/g, ""))
                    };
                }
                else {
                    raisePercentData = {
                        "GrowthStoreP01": parseFloat($pRow.find('input[data-Period="P01"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP02": parseFloat($pRow.find('input[data-Period="P02"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP03": parseFloat($pRow.find('input[data-Period="P03"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP04": parseFloat($pRow.find('input[data-Period="P04"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP05": parseFloat($pRow.find('input[data-Period="P05"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP06": parseFloat($pRow.find('input[data-Period="P06"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP07": parseFloat($pRow.find('input[data-Period="P07"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP08": parseFloat($pRow.find('input[data-Period="P08"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP09": parseFloat($pRow.find('input[data-Period="P09"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP10": parseFloat($pRow.find('input[data-Period="P10"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP11": parseFloat($pRow.find('input[data-Period="P11"]').attr('data-currentvalue').replace(/,/g, "")), "GrowthStoreP12": parseFloat($pRow.find('input[data-Period="P12"]').attr('data-currentvalue').replace(/,/g, "")),
                        "GrowthStoreP13": 0
                    };
                }
            }

            if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                var rowString = '';

                $('.expanded').map(function (v) {
                    rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                });

                var $linkedRow = $('.linked-category-data[data-target="#' + $formaulaModal.attr('id') + '"]').parents('tr');

                var $activeRow = $linkedRow.prevAll('[data-level=' + ($linkedRow.attr('data-level') - 1) + ']').eq(0);

                localStorage.setItem("ActiveRow", $activeRow.find('#hdnStoreUID').html() + '|' + $activeRow.find('#hdnDeptUID').html() + '|' + $activeRow.find('#hdnCatUID').html());

                localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

            }

            localStorage.setItem("ExpandRows", "True");

            if (!hasError) {
                $('#' + $formaulaModal.attr('id')).modal('toggle');

                var stores = [];
                var groupedcategory = $('[name=groupedcategory] :selected').val();
                var stores = $('[name=lstStores]').val().toString();
                var level = "0";
                var viewLevel = "STORE";
                var storeID = StoreUID;
                var deptID = "-1";
                var categoryID = categoryUID;
                var venDescription = $formaulaModal.find('table.total-summary-row tbody td.vendorTd .ven-desc[type=text]').val();
                var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                $.ajax({
                    url: '/Budget/SaveParentEmployeePayrollStoresData',
                    type: 'POST',
                    async: true,
                    dataType: 'html',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ empPayrollUID: $formaulaModal.find('[name="EmployeePayroll.EmpPayrollUID"]').val(), compType: $formaulaModal.find('[name="EmployeePayroll.CompType"]').val(), hasOvertimePay: $formaulaModal.find('[name="EmployeePayroll.HasOvertimePay"]').val() == "True", lstStoresData: storeDataObj, employeeAllocationData: allocationData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, displayFormat: displayFormat, annualSalary: annualSalary, headCountData: headCountData, raisePercentData: raisePercentData, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), vendorIdCSV: $('[name="datapageVendordd"]').length == 0 ? "-2" : $('[name="datapageVendordd"]').val().join(','), bsMode: bsMode, categoryType: categoryType }),
                    success: function (data) {
                        var isValid = true;
                        if ($('[name=AllowBatchUpdates]').val() == 'True') {
                            try {
                                var result = $.parseJSON(data);

                                if (result.result == 2) {
                                    isValid = false;
                                    $('.layout').hide();

                                    var confirm_click = function () {
                                        window.location.reload();
                                    }

                                    custom_alert(confirm_click, "Alert", "Can not save data as formula execution is started.");
                                }
                            }
                            catch (e) {

                            }
                        }

                        if (isValid) {
                            RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                            $('#DataInputTable tbody').html('');
                            $('#DataInputTable tbody').html(data);
                            $(".hideyear").each(function () {
                                $(this).removeAttr("data-level");
                            });
                            $('#DataInputTable').find('.displayVendor').addClass('hide');
                            $('#DataInputTable').tabelize();
                            RetailBudgetPro.Budget.ManageDataAndPerentage();
                            $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                            $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                            $('.hideyear').find('td:first').html('');
                        }
                    }
                });
            }
            else {
                $('.layout').hide();
            }
        },

        SaveCopiedData: function (e) {

            var $target = $(e.target);
            
            $('.layout').show();

            $('.custom-data-table').hide();

            var $selectedCategory = $('[name="groupedcategory"] option:selected');
            var isBalanceSheetCategory = $selectedCategory.data('isbalancesheet') == "True";
            var isFinancialCategory = $selectedCategory.data('isfinancialcat') == "True";

            var hdnNumberOfPeriodsVal = RetailBudgetPro.Budget.numberOfPeriodsVal;

            var TurnOnBalanceSheetVal = RetailBudgetPro.Budget.turnOnBalanceSheetVal;

            var addDefaultBSValues = (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && (isBalanceSheetCategory == true || isFinancialCategory == true)) ? "True" : "False";

            var bsMode = (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";

            var $modal = $target.parents('.modal');

            var finalData = [];

            var showVendor = $('#ShowVendor').val() == "True";

            var saveBy = $target.hasClass('approver') ? "Approver" : "Requester";
            var status = $target.hasClass('approver') ? "" : "Pending";

            var DepartmentUID = $modal.find('[name="hdnDepartmentUID"]').val();
            var CategoryUID = $modal.find('[name="hdnCategoryUID"]').val();

            $modal.find('tr.copiedRow').each(function () {
                var $pRow = $(this);

                data = {
                    "DATValueM1": $pRow.find('.P01Val').val(), "DATValueM2": $pRow.find('.P02Val').val(), "DATValueM3": $pRow.find('.P03Val').val(), "DATValueM4": $pRow.find('.P04Val').val(), "DATValueM5": $pRow.find('.P05Val').val(), "DATValueM6": $pRow.find('.P06Val').val(),
                    "DATValueM7": $pRow.find('.P07Val').val(), "DATValueM8": $pRow.find('.P08Val').val(), "DATValueM9": $pRow.find('.P09Val').val(), "DATValueM10": $pRow.find('.P10Val').val(), "DATValueM11": $pRow.find('.P11Val').val(), "DATValueM12": $pRow.find('.P12Val').val(),
                    "VENDescription": (showVendor ? "" : $pRow.find('.vendorVal').val()), "DATDescription": $pRow.find('.descriptionVal').val(), "DATPLCategoryUID": CategoryUID, "DATDepartmentUID": DepartmentUID, "DATStoreUID": $pRow.find('.storeUID').val(), "PLElementUID": -1, "Comments": undefined,
                    "LoadFromExcel": false, "ExcelRowNumber": -1, "VendorUIDCSV": (showVendor && $pRow.find('[name="VendorUID"]').val() != null ? $pRow.find('[name="VendorUID"]').val().join() : ""), "UnApprovedPLElementUID": -1,
                    "CurrencyUID": (($('[name="groupedcategory"] option[value$="|' + CategoryUID + '"]').data('isfinancialcat') == "True") ? (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? $pRow.find('.currencyUID').val() : RetailBudgetPro.Budget.globalCurrencyUID) : -1)
                };
                
                finalData.push(data);
            });

            $modal.modal('toggle');
            $modal.find('.copy-error-msg').addClass('hide');

            var stores = [];
            var groupedcategory = $('[name=groupedcategory] :selected').val();
            var stores = $('[name=lstStores]').val().toString();
            var level = "0";
            var viewLevel = "STORE";
            var storeID = "-1";
            var deptID = "-1";
            var catID = "-1";

            var categoryType = (isBalanceSheetCategory == true ? "BS" : (isFinancialCategory == true ? "PL" : "NF"));

            $.ajax({
                url: '/Budget/SaveCopiedData',
                type: 'POST',
                async: true,
                dataType: 'html',
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify({ data: finalData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: catID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, VendorUIDs: $('[name="datapageVendordd"]').val() == undefined ? "-2" : $('[name="datapageVendordd"]').val().join(','), saveBy: saveBy, status: status, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), categoryType: categoryType, addDefaultBSValues: addDefaultBSValues == "True", bsMode: bsMode }),
                success: function (data) {
                    var isValid = true;
                    if ($('[name=AllowBatchUpdates]').val() == 'True') {
                        try {
                            var result = $.parseJSON(data);

                            if (result.result == 2) {
                                isValid = false;
                                $('.layout').hide();

                                var confirm_click = function () {
                                    window.location.reload();
                                }

                                custom_alert(confirm_click, "Alert", "Can not save data as either batch edit has not started yet or formula execution has already started.");
                            }
                        }
                        catch (e) {

                        }
                    }

                    if (isValid) {
                        $modal.find('table tbody').html('');

                        if ($('#vendordd').length > 0) {
                            $('#vendordd').val("-2");

                            $('#vendordd')[0].sumo.reload();
                        }

                        $('#DataInputTable tbody').html('');
                        $('#DataInputTable tbody').html(data);
                        $(".hideyear").each(function () {
                            $(this).removeAttr("data-level");
                        });
                        $('#DataInputTable').find('.displayVendor').addClass('hide');
                        $('#DataInputTable').tabelize();
                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                        $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                        $('.hideyear').find('td:first').html('');
                    }
                },
                error: function (err) {
                    console.log(err);
                    $('.layout').hide();
                }
            });
        },

        CloseCopiedDataModal: function (e) {

            var $modal = $(e.target).parents('.modal');

            $modal.find('table tbody').html('');
            $modal.find('.copy-error-msg').addClass('hide');
        },

        GetLinkedCategoryBSData: function (e) {
            var $target = e;
            if ($($($target).attr('data-target')).html() == undefined) {

                $('.layout').show();

                var $currentTr = $($target).parents('tr');
                var $parentTr = $($target).parents('tr').prevAll('tr[data-level="' + (parseInt($($target).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');

                //var plElementUID = $currentTr.find('#hdnPLElementUID').html().trim();
                var catCalculatedOn = $currentTr.find('#hdnCatCalucaltedOn').html().trim();
                var targetPLCategoryUID = $currentTr.find('#hdnCatUID').html().trim();

                var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();

                $.ajax({
                    url: '/Budget/GetLinkedCategoryBSData',
                    data: JSON.stringify({ sourcePLElementUID: catCalculatedOn, mode: $('[name="TransactionModeDropdown"]').val(), targetPLCategoryUID: targetPLCategoryUID, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1") }),
                    dataType: 'html',
                    type: 'post',
                    contentType: 'application/json',
                    success: function (result) {
                        var newID = 'formulaModal' + Math.floor(1000 + Math.random() * 9999);
                        var inEditMode = $parentTr.hasClass('inEditMode');
                        $($target).attr('data-target', '#' + newID);
                        $('.page-content-wrapper').append(result);
                        $('.page-content-wrapper').find('#formulaModal').attr('id', newID);
                        $('#' + newID).find('.lockedMonths').attr('readonly', 'readonly');


                        $(document).on('hidden.bs.modal', '#' + newID, function () {
                            $('#' + newID).html($('.' + newID + '-1').html());
                        });

                        $(document).on('shown.bs.modal', '#' + newID, function () {
                            RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                        });

                        $(document).on('show.bs.modal', '#' + newID, function () {

                            $(this).find('.currencyFxRates tbody td .targetCurrency').html($currentTr.find('.currency').text().trim());

                            var $targetDiv = $('[data-target="#' + $(this).attr('id') + '"]')

                            var $parentRow = $($targetDiv).parents('tr').prevAll('tr[data-level="' + (parseInt($($targetDiv).parents('tr').attr('data-level')) - 1) + '"]:eq(0)');

                            if (inEditMode) {
                                if ($(this).find('.no-bs-source-msg').length == 0) $(this).find('.save-balanceSheet-data').removeClass('hide');
                                else $(this).find('.save-balanceSheet-data').addClass('hide');

                                $(this).find('.copyPeriodValues').removeClass('hide');
                                $(this).find('.action-head').removeClass('hide');
                                $(this).find('.action-row').removeClass('hide');

                                $(this).find('.noFormulaRow .descriptionVal').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.noFormulaRow input.vendorVal').removeAttr('readonly').removeClass('readonlyTxt').removeClass('hide');
                                $(this).find('.noFormulaRow span.vendorVal').addClass('hide');
                                $(this).find('.noFormulaRow .DATVal, .totals-row .DATVal').removeClass('hide');
                                $(this).find('.noFormulaRow .DATVal:not(.removeBackgndColor)').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.noFormulaRow .rowTotal').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.noFormulaRow .showCol, .totals-row .showCol').addClass('hideCol').removeClass('showCol');

                                $(this).find('.formulamodal-sec table.bsData').addClass('editable');
                                $(this).find('.formulamodal-sec table.bsData tbody [type=text]:disabled').addClass('disabledTxt');
                                $(this).find('.formulamodal-sec table.bsData tbody [type=text]:not(.removeBackgndColor):not(.search-txt)').removeAttr('readonly').removeClass('readonlyTxt').addClass('form-control');

                                $(this).find('table.bsData tbody td.vendorTd .ven-desc[type=text]').removeAttr('readonly').removeClass('readonlyTxt').addClass('form-control');

                                $(this).find('.noFormulaRow .DATVal').map(function () {
                                    if ($(this).parents('tr').find('.hdnFromExcel').val() == "True") {
                                        $(this).attr('readonly', 'readonly').addClass('readonlyTxt highlightBckg');
                                        $(this).parents('tr').find('td input.rowTotal').addClass('highlightExcelRow');
                                        $(this).parents('tr').find('td input.rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt highlightBckg');
                                        $(this).parents('tr').find('td.action-row').html('');
                                    }
                                });

                                $(this).find('.formulamodal-sec input[type=text]').each(function () {
                                    if (!$(this).hasClass('lockedMonths') && !$(this).hasClass('descriptionVal') && !$(this).hasClass('vendorVal') && !$(this).hasClass('search-txt')) {
                                        $(this).not('.highlightBckg').calculator();
                                    }
                                });

                                $(this).find('.action-temp').addClass('visibilityClass').removeClass('hide');

                                if ($(this).find('tr.highlightExcelRow').length > 0) {
                                    var $highlightExcelRow = $(this).find('tr.highlightExcelRow');
                                    $highlightExcelRow.find('td [type=text].DATVal, [type=text].rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt highlightBckg');
                                    $highlightExcelRow.find('td input.amortize-period, td input.descriptionVal, td.vendorLst span.vendor').addClass('highlightBckg').attr('readonly', 'readonly');
                                    $highlightExcelRow.find('td.showDateInTitle div.dayOfPeriodDiv, td.showDateInTitle div.transactionDateDiv').addClass('disable-wrapper');
                                    $highlightExcelRow.find('td input.descriptionVal, td.vendorTd .vendorVal').addClass('highlightBckg').attr('readonly', 'readonly');
                                }
                                else if ($(this).find('tr.nonEditableRow').length > 0) {
                                    var $nonEditableRow = $(this).find('tr.nonEditableRow');
                                    $nonEditableRow.find('td [type=text].DATVal, [type=text].rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                    $nonEditableRow.find('td input.amortize-period, td input.descriptionVal, td.vendorLst span.vendor').attr('readonly', 'readonly');
                                    $nonEditableRow.find('td.showDateInTitle div.dayOfPeriodDiv, td.showDateInTitle div.transactionDateDiv').addClass('disable-wrapper');
                                    $nonEditableRow.find('td input.descriptionVal, td.vendorTd .vendorVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                }
                                else {
                                    $(this).find('.vendorDD').removeClass("hide");
                                    $(this).find('span.vendor').addClass("hide");

                                    $(this).find('td.currencyLst .currency').addClass('hide');
                                    $(this).find('td.currencyLst .currencyDD').removeClass('hide');
                                }

                                $(this).find('.noFormulaRow td .accrualEditData-info-icon').addClass('hide');

				                //For branch BD-1122
                                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                                //    $(this).find('.vendorLst .vendorDD').hide();
                                //    $(this).find('td .vendorVal').closest('input').addClass('hide');
                                //    $(this).find('td .vendorVal').closest('span').removeClass('hide');
                                //    $(this).find('.vendorDesc .vendorVal, .ven-list, .isVendor').addClass('hide');
                                //    $(this).find('.vendorDesc .vendorDescCSV, .vendor').removeClass('hide');
                                //    $(this).find('td input.descriptionVal, td.vendorTd .vendorVal').attr('readonly', 'readonly').addClass('readonlyTxt');

                                //    if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
                                //        $(this).find('td.currencyLst .currency').removeClass('hide');
                                //        $(this).find('td.currencyLst .currencyDD').addClass('hide');
                                //    }
                                //}

                            }
                            else {
                                $(this).find('.save-balanceSheet-data').addClass('hide');
                                $(this).find('.action-head').addClass('hide');
                                $(this).find('.action-row').addClass('hide');
                                $(this).find('.copyPeriodValues').addClass('hide');

                                $(this).find('.noFormulaRow .descriptionVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.noFormulaRow input.vendorVal').attr('readonly', 'readonly').addClass('readonlyTxt').addClass('hide');
                                $(this).find('.noFormulaRow span.vendorVal').removeClass('hide');
                                $(this).find('.noFormulaRow .DATVal:not(.removeBackgndColor)').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.noFormulaRow .rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.noFormulaRow .hideCol, .totals-row .hideCol').addClass('showCol').removeClass('hideCol');
                                $(this).find('.noFormulaRow .DATVal, .totals-row .DATVal').addClass('hide');

                                $(this).find('.formulamodal-sec table.bsData').removeClass('editable');
                                $(this).find('.formulamodal-sec table tbody.bsData [type=text]:disabled').addClass('disabledTxt');

                                $(this).find('.formulamodal-sec table.bsData tbody [type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');

                                $(this).find('table.bsData tbody td.vendorTd .ven-desc[type=text]').attr('readonly', 'readonly').addClass('readonlyTxt').removeClass('form-control');

                                $(this).find('.action-temp').removeClass('visibilityClass').addClass('hide');

                                $(this).find('.vendorDD ').addClass("hide");
                                $(this).find('span.vendor').removeClass("hide");

                                $(this).find('td.currencyLst .currency').removeClass('hide');
                                $(this).find('td.currencyLst .currencyDD').addClass('hide');

                                if ($('[name="TransactionModeDropdown"]').val() == 'ACCRUAL') {
                                    $(this).find('.noFormulaRow td .accrualEditData-info-icon').removeClass('hide');
                                }
                                else {
                                    $(this).find('.noFormulaRow td .accrualEditData-info-icon').addClass('hide');
                                }

                            }

                        });
                        $('#' + newID).find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                        $('#' + newID).find('[name="subCategoryCurrencyDD"]').SumoSelect();

                        if (!inEditMode) { //|| (inEditMode && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True" && RetailBudgetPro.Budget.isUserInEditDataPageRole == "False")) { //For branch BD-1122
                            $('#' + newID).find(".vendor-info-icon").popover({
                                html: true,
                                content: function () {
                                    return $(this).parents('td').find('[id="vendor-info"]').html()
                                },
                                delay: { show: 50, hide: 100 }
                            });
                        }

                        var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                        var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                        var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                        var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                        var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                        var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                        var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                        var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                        var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                        var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                        var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                        var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();

                        if (STCCompM1 == "N")
                            $('#' + newID).find('input.P01Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM2 == "N")
                            $('#' + newID).find('input.P02Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM3 == "N")
                            $('#' + newID).find('input.P03Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM4 == "N")
                            $('#' + newID).find('input.P04Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM5 == "N")
                            $('#' + newID).find('input.P05Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM6 == "N")
                            $('#' + newID).find('input.P06Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM7 == "N")
                            $('#' + newID).find('input.P07Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM8 == "N")
                            $('#' + newID).find('input.P08Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM9 == "N")
                            $('#' + newID).find('input.P09Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM10 == "N")
                            $('#' + newID).find('input.P10Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM11 == "N")
                            $('#' + newID).find('input.P11Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        if (STCCompM12 == "N")
                            $('#' + newID).find('input.P12Val').attr('readonly', 'readonly').addClass('removeBackgndColor');
                        
                        $('.layout').hide();

                        $('#' + newID).modal('show');
                    },
                    error: function (er) {
                        console.log(er);
                    }
                });
            }
            else {
                var $currentTr = $($target).parents('tr');
                var newID = $($target).attr('data-target');
               
                var STCCompM1 = $currentTr.find('#STCCompM1').eq(0).text();
                var STCCompM2 = $currentTr.find('#STCCompM2').eq(0).text();
                var STCCompM3 = $currentTr.find('#STCCompM3').eq(0).text();
                var STCCompM4 = $currentTr.find('#STCCompM4').eq(0).text();
                var STCCompM5 = $currentTr.find('#STCCompM5').eq(0).text();
                var STCCompM6 = $currentTr.find('#STCCompM6').eq(0).text();
                var STCCompM7 = $currentTr.find('#STCCompM7').eq(0).text();
                var STCCompM8 = $currentTr.find('#STCCompM8').eq(0).text();
                var STCCompM9 = $currentTr.find('#STCCompM9').eq(0).text();
                var STCCompM10 = $currentTr.find('#STCCompM10').eq(0).text();
                var STCCompM11 = $currentTr.find('#STCCompM11').eq(0).text();
                var STCCompM12 = $currentTr.find('#STCCompM12').eq(0).text();

                if (STCCompM1 == "N")
                    $(newID).find('input[data-period="P01"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM2 == "N")
                    $(newID).find('input[data-period="P02"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM3 == "N")
                    $(newID).find('input[data-period="P03"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM4 == "N")
                    $(newID).find('input[data-period="P04"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM5 == "N")
                    $(newID).find('input[data-period="P05"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM6 == "N")
                    $(newID).find('input[data-period="P06"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM7 == "N")
                    $(newID).find('input[data-period="P07"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM8 == "N")
                    $(newID).find('input[data-period="P08"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM9 == "N")
                    $(newID).find('input[data-period="P09"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM10 == "N")
                    $(newID).find('input[data-period="P10"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM11 == "N")
                    $(newID).find('input[data-period="P11"]').attr('readonly', 'readonly').addClass('removeBackgndColor');
                if (STCCompM12 == "N")
                    $(newID).find('input[data-period="P12"]').attr('readonly', 'readonly').addClass('removeBackgndColor');

                $($($target).attr('data-target')).find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                $($($target).attr('data-target')).find('[name="subCategoryCurrencyDD"]').SumoSelect();
            }
        },
        SaveLinkedCategoryBSData: function () {

            var $formaulaModal = $(this).parents('.formulamodal');

            var decimalPlaces = $formaulaModal.find('.popup-decimalPlaces').val();

            if (SaveRelatedCategoryDataValidation('#' + $formaulaModal.attr('id')) != -1) {

                $('#' + $formaulaModal.attr('id')).modal('toggle');

                $('.layout').show();
                var showVendor = $('#ShowVendor').val() == "True";
                $('.custom-data-table').hide();

                var dataObj = [];
                var data = {};

                $formaulaModal.find('.formulamodal-sec:not(.catDetailViewNotAllowed)').each(function () {

                    var $formSec = $(this);

                    var decimalPlaces = $formSec.find('.popup-decimalPlaces').val();

                    if ($(this).find('.budgets-table tbody tr.noFormulaRow').length != 0) {
                        $(this).find('.budgets-table tbody tr.noFormulaRow').each(function () {

                            var $this = $(this);

                            data = {};

                            var vendorUIDCSV = $this.find('.vendorLstDD').val() == null ? "" : $this.find('.vendorLstDD').val().join();

                            var newArray = [];
                            var oldArray = [];

                            var oldVendorVal = showVendor ? $('.linked-category-bsdata .popup-vendorUIDCSV').val() : $this.find('.vendorVal').siblings('span:eq(0)').html();
                            var newVendorVal = showVendor ? $this.find('.vendorLstDD option:selected').map(function () { return $(this).val() }).get().join() : $this.find('.vendorVal').val();

                            var isTermFormulaType = $this.find('.termLst .termSpan').attr('data-isformulatype') == "True";

                            oldArray.unshift('-');
                            oldArray.push($this.find('.descriptionVal').attr('data-initialvalue'));
                            oldArray.push(oldVendorVal);
                            oldArray.push($this.find('.dateLst span').html());
                            oldArray.push($this.find('.termLst .termSpan').html().trim());
                            oldArray.push($this.find('.amortizePeriodLst span').attr('data-value'));

                            newArray.unshift('+');
                            newArray.push($this.find('.descriptionVal').val());
                            newArray.push(newVendorVal);
                            newArray.push($this.find('.dateLst span').html());
                            newArray.push($this.find('.termLst .termSpan').html().trim());
                            newArray.push($this.find('.amortizePeriodLst span').attr('data-value'));

                            $this.find('input[type="text"].DATVal').each(function () {
                                oldArray.push($(this).siblings('span:eq(0)').attr('data-value').replace(/,/g, ''));
                                newArray.push($(this).val().replace(/,/g, ''));
                            })
                            oldArray.push(0);
                            newArray.push(0);

                            oldArray.push($('.linked-category-bsdata .popup-plelementUID').val());
                            newArray.push($('.linked-category-bsdata .popup-plelementUID').val());

                            RetailBudgetPro.Budget.FormulaPopUpAudits.push(oldArray);
                            RetailBudgetPro.Budget.FormulaPopUpAudits.push(newArray);

                            data = {
                                "PLElementUID": $formSec.find('.popup-plelementUID').val(), "DATYear": $formSec.find('.popup-budgetYear').val(), "DATStoreUID": $formSec.find('.popup-storeUID').val(), "DATPLCategoryUID": $formSec.find('.popup-plCategoryUID').val(), "DATDepartmentUID": $formSec.find('.popup-departmentUID').val(),
                                "DATVendorUID": -1, "DATDescription": $this.find('.descriptionVal').val(), "VENDescription": $this.find('.vendorVal').val(), "DATValueM1": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(decimalPlaces), "DATValueM2": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(decimalPlaces),
                                "DATValueM3": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(decimalPlaces), "DATValueM4": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(decimalPlaces), "DATValueM5": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(decimalPlaces),
                                "DATValueM6": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(decimalPlaces), "DATValueM7": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(decimalPlaces), "DATValueM8": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(decimalPlaces),
                                "DATValueM9": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(decimalPlaces), "DATValueM10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()), "DATValueM11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()), "DATValueM12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(decimalPlaces),
                                "VendorUIDCSV": vendorUIDCSV, "CurrencyUID": $this.find('[name="subCategoryCurrencyDD"]').val() == undefined ? RetailBudgetPro.Budget.globalCurrencyUID : $this.find('[name = "subCategoryCurrencyDD"]').val(), "TransactionDate": ($formSec.find('.popup-amortizePeriod').val() > 1 || isTermFormulaType ? $this.find('.transactionDate').attr('data-value') : new Date()), "DayOfPeriod": ($formSec.find('.popup-amortizePeriod').val() <= 1 && !isTermFormulaType ? $this.find('.dayOfPeriod').attr('data-value') : 15),
                                "TermUID": ($this.find('.termSpan').html() == "" ? -1 : $formSec.find('.popup-termUID').val()), "AmortizePeriod": $formSec.find('.popup-amortizePeriod').val(), "LoadFromExcel": false
                            };

                            dataObj.push(data);
                        });
                    }
                });

                if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                    var rowString = '';

                    $('.expanded').map(function (v) {
                        rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                    });

                    var $linkedRow = $('.linked-category-data[data-target="#' + $formaulaModal.attr('id') + '"]').parents('tr');

                    var $activeRow = $linkedRow.prevAll('[data-level=' + ($linkedRow.attr('data-level') - 1) + ']').eq(0);

                    localStorage.setItem("ActiveRow", $activeRow.find('#hdnStoreUID').html() + '|' + $activeRow.find('#hdnDeptUID').html() + '|' + $activeRow.find('#hdnCatUID').html());

                    localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

                }

                localStorage.setItem("ExpandRows", "True");

                var stores = [];
                var groupedcategory = $('[name=groupedcategory] :selected').val();
                var stores = $('[name=lstStores]').val().toString();
                var level = "0";
                var viewLevel = "STORE";
                var storeID = "-1";
                var deptID = "-1";
                var categoryID = "-1";
                var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
                var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

                var venDescription = $formaulaModal.find('.formulamodal-sec .budgets-table tbody tr.noFormulaRow .vendorVal').val();
                
                $.ajax({
                    url: '/Budget/SaveLinkedCategoryBSData',
                    type: 'POST',
                    async: true,
                    dataType: 'html',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ data: dataObj, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, AuditData: RetailBudgetPro.Budget.FormulaPopUpAudits, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), decimalPlaces, vendorIdCSV: $('[name="datapageVendordd"]').val() == undefined ? "-2" : $('[name="datapageVendordd"]').val().join(','), bsMode: bsMode, categoryType: categoryType }),
                    success: function (data) {
                        RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                        $('#DataInputTable tbody').html('');
                        $('#DataInputTable tbody').html(data);
                        $(".hideyear").each(function () {
                            $(this).removeAttr("data-level");
                        });
                        $('#DataInputTable').find('.displayVendor').addClass('hide');
                        $('#DataInputTable').tabelize();
                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                        $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                        $('.hideyear').find('td:first').html('');
                    }
                });
            }
        },

        DistributeTotalValueBy4_4_5: function () {
            var $periods = RetailBudgetPro.Budget.numberOfPeriodsVal;
            var periodDistributionValueArr = $(this).attr("data-value").split("-").map(function (val) { return parseInt(val) });
            var $parentTr = $(this).parents('tr');
            var tdSelector = !$(this).parents('tr').hasClass('allocation-data-row') && $(this).parents('.payrollModal').find('[name="EmployeePayroll.CompType"]').val() == "S" && $(this).parents('div').hasClass('allocationSalaryCheck') ? ($('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" ? "td.percentage" : "td.data") : "td";
            var periodDistributionValue = [];
            var percentOrDollar = $(this).parents('div').find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val();
            var isOvertimeSalaryDiv = $(this).parents('div').hasClass('overtimeSalaryCheck');
            var IsSalary = $(this).parents('div').find('[name="EmployeePayroll.CompType"]').val() == "S";
            var total = ((percentOrDollar == 'PERCENT' && IsSalary && !isOvertimeSalaryDiv) || $(this).hasClass('distributeByAverage')) ? $(this).parents('tr').find(tdSelector + ' input[type="text"][title="Average"]').val().replace(/,/g, "") * $periods : $(this).parents('tr').find(tdSelector + ' input[type="text"][title="Total"]').val().replace(/,/g, "");
            for (var i = 0; i < 4; i++) {
                periodDistributionValue.push(periodDistributionValueArr[0]);
                periodDistributionValue.push(periodDistributionValueArr[1]);
                periodDistributionValue.push(periodDistributionValueArr[2]);
            }
            var fixedDecimalPlaces = $(this).parents('tr').hasClass('allocation-data-row') ? 5 : ($(this).parents('.payrollModal').find('[name="EmployeePayroll.CompType"]').val() == "S" && $('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" && $(this).parents('div').hasClass('allocationSalaryCheck') ? 3 : $('a[data-target="#' + $(this).parents('.payrollModal').attr('id') + '"]').parents('tr').find('#hdnDecimalPlaces').html());
            var lastPeriodValue = parseFloat(total).toFixed(fixedDecimalPlaces) - (parseFloat(((total * periodDistributionValue[0]) / 52).toFixed(fixedDecimalPlaces)) + parseFloat(((total * periodDistributionValue[1]) / 52).toFixed(fixedDecimalPlaces)) +
                                  parseFloat(((total * periodDistributionValue[2]) / 52).toFixed(fixedDecimalPlaces)) + parseFloat(((total * periodDistributionValue[3]) / 52).toFixed(fixedDecimalPlaces)) +
                                  parseFloat(((total * periodDistributionValue[4]) / 52).toFixed(fixedDecimalPlaces)) + parseFloat(((total * periodDistributionValue[5]) / 52).toFixed(fixedDecimalPlaces)) +
                                  parseFloat(((total * periodDistributionValue[6]) / 52).toFixed(fixedDecimalPlaces)) + parseFloat(((total * periodDistributionValue[7]) / 52).toFixed(fixedDecimalPlaces)) +
                                  parseFloat(((total * periodDistributionValue[8]) / 52).toFixed(fixedDecimalPlaces)) + parseFloat(((total * periodDistributionValue[9]) / 52).toFixed(fixedDecimalPlaces)) +
                                  parseFloat(((total * periodDistributionValue[10]) / 52).toFixed(fixedDecimalPlaces)));

            if ($periods == 12) {
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P01"]:not([readonly])').val(((total * periodDistributionValue[0]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P02"]:not([readonly])').val(((total * periodDistributionValue[1]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P03"]:not([readonly])').val(((total * periodDistributionValue[2]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P04"]:not([readonly])').val(((total * periodDistributionValue[3]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P05"]:not([readonly])').val(((total * periodDistributionValue[4]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P06"]:not([readonly])').val(((total * periodDistributionValue[5]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P07"]:not([readonly])').val(((total * periodDistributionValue[6]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P08"]:not([readonly])').val(((total * periodDistributionValue[7]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P09"]:not([readonly])').val(((total * periodDistributionValue[8]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P10"]:not([readonly])').val(((total * periodDistributionValue[9]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P11"]:not([readonly])').val(((total * periodDistributionValue[10]) / 52).toFixed(fixedDecimalPlaces)).trigger("change");
                $parentTr.find(tdSelector + ' input[type="text"][data-Period="P12"]:not([readonly])').val((lastPeriodValue).toFixed(fixedDecimalPlaces)).trigger("change");
            }
            HireDateCheck('#' + $(this).parents('.payrollModal').attr('id'));
            DisableInActivePeriods('#' + $(this).parents('.payrollModal').attr('id'));
            DisableLockedPeriods();
            $parentTr.find('.resetCurrentRow').val(true);
        },
        DistributeTotalPayrollValueEvenly: function () {
            var $periods = getNumberOfPeriods();
            var $parentRow = $(this).parents('tr');
            //get totals value
            var tdSelector = !$(this).parents('tr').hasClass('allocation-data-row') && $(this).parents('.payrollModal').find('[name="EmployeePayroll.CompType"]').val() == "S" && $(this).parents('div').hasClass('allocationSalaryCheck') ? ($('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" ? "td.percentage" : "td.data") : "td";

            var fixedDecimalPlaces = $(this).parents('.payrollModal').find('[name="EmployeePayroll.CompType"]').val() == "S" && $('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT" && $(this).parents('div').hasClass('allocationSalaryCheck') ? 3 : 5;

            var percentODollar = $(this).parents('div').find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val();
            var IsSalary = $(this).parents('div').find('[name="EmployeePayroll.CompType"]').val() == "S";
            var isOvertimeSalaryDiv = $(this).parents('div').hasClass('overtimeSalaryCheck');
            var total = ((percentODollar == 'PERCENT' && IsSalary && !isOvertimeSalaryDiv) || $(this).hasClass('distributeByAverage')) ? ConvertCurrencyStringToDecimal($parentRow.find(tdSelector + ' input[type="text"][title="Average"]').val()) : ConvertCurrencyStringToDecimal($parentRow.find(tdSelector + ' input[type="text"][title="Total"]').val());
            var periodRowValue = ((percentODollar == 'PERCENT' && IsSalary && !isOvertimeSalaryDiv) || $(this).hasClass('distributeByAverage')) ? total.toFixed(fixedDecimalPlaces) : (total / $periods).toFixed(fixedDecimalPlaces);

            if ($periods == 12) {
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P01"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P02"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P03"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P04"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P05"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P06"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P07"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P08"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P09"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P10"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P11"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                var period12Val = (total - periodRowValue * 11).toFixed(fixedDecimalPlaces);
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P12"]:not([readonly])').val(Number(((percentODollar == 'PERCENT' && IsSalary && !isOvertimeSalaryDiv) || $(this).hasClass('distributeByAverage')) ? periodRowValue : period12Val)).trigger("change");
            }
            else {
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P01"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P02"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P03"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P04"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P05"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P06"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P07"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P08"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P09"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P10"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P11"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P12"]:not([readonly])').val(Number(periodRowValue)).trigger("change");
                var period13Val = (total - periodRowValue * 12).toFixed(fixedDecimalPlaces);
                $parentRow.find(tdSelector + ' input[type="text"][data-Period="P13"]:not([readonly])').val(Number(((percentODollar == 'PERCENT' && IsSalary && !isOvertimeSalaryDiv) || $(this).hasClass('distributeByAverage')) ? periodRowValue : period13Val)).trigger("change");
            }
            HireDateCheck('#' + $(this).parents('.payrollModal').attr('id'));
            DisableInActivePeriods('#' + $(this).parents('.payrollModal').attr('id'));
            DisableLockedPeriods();
            $parentRow.find('.resetCurrentRow').val(true);
        },
        DisplayFormattedDataOnPopUp: function () {
            //var $formulaModal = $(this).parents('.payrollModal');
            //if ($formulaModal.find('[name="EmployeePayroll.DisplayAmountFormat"]:checked').val() == "PERCENT") {
            //    $formulaModal.find('.allocationSalaryCheck table td.percentage').show();
            //    $formulaModal.find('.allocationSalaryCheck table td.data').hide();
            //    $formulaModal.find('.annualSalaryTxtBoxDiv').show();
            //    $formulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').removeAttr('disabled');
            //    $formulaModal.find('.dollarOrPercentage').text("Average");
            //    $formulaModal.find('.changeTitle').attr("title", "Average")
            //}
            //else {
            //    $formulaModal.find('.allocationSalaryCheck table td.percentage').hide();
            //    $formulaModal.find('.allocationSalaryCheck table td.data').show();
            //    $formulaModal.find('.annualSalaryTxtBoxDiv').hide();
            //    $formulaModal.find('[name="EmployeePayroll.AnnualSalaryAmount"]').attr('disabled', 'disabled');
            //    $formulaModal.find('.dollarOrPercentage').text("Total");
            //    $formulaModal.find('.changeTitle').attr("title", "Total")
            //}
        },
        DeleteNotes: function (e) {
            $('.layout').show();

            var $this = $(this);

            $.ajax({
                url: '/Budget/DeleteNotes',
                type: 'POST',
                async: true,
                dataType: 'json',
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify({ PLElementUID: commentRow.find('#hdnPLElementUID').text() }),
                success: function (data) {
                    $this.parents('.commentModal').find('.all-comments').html('');
                    $this.parents('.commentModal').find('.char-limit-msg').text('');
                    commentRow.find('#hdnComment').text('');
                    commentRow.find('td.action-btn div.function-btn a.bottomLevelCategoryComment i').removeClass('hasComment');
                    $('.layout').hide();
                }
            });
        },
        DistributeTotal: function (e) {
            var $parentTr = $(e.currentTarget).parents('tr');

            var decimalPlaces = $(this).parents('.formulamodal-sec').find('.popup-decimalPlaces').val();

            var periodDistributionValueArr = $parentTr.find('.distributeTotal').attr('data-value').split('-');

            var periodDistributionValue = [];

            for (var i = 0; i < 4; i++) {
                periodDistributionValue.push(periodDistributionValueArr[0]);
                periodDistributionValue.push(periodDistributionValueArr[1]);
                periodDistributionValue.push(periodDistributionValueArr[2]);
            }
            var value;
            var periodClass;

            total = ConvertCurrencyStringToDecimal($parentTr.find('.rowTotal').val());

            var $periods = getNumberOfPeriods();
            if ($periods == 12) {
                for (var i = 0; i < 12 ; i++) {
                    periodClass = '.P' + String("0" + (i + 1)).slice(-2) + 'Val';
                    value = (total * periodDistributionValue[i]) / 52;
                    $parentTr.find(periodClass).val(value.toFixed(decimalPlaces));
                    $parentTr.find(periodClass).next('span').text(value.toFixed(decimalPlaces));
                }
            }
        },
        ShowAllDataRows: function () {
            var $formaulaModal = $(this).parents('.formulamodal');
            var currentModal = $('#' + $formaulaModal.attr('id'));

            if (currentModal.find('.SubCatRow').hasClass('hide')) {
                currentModal.find('.SubCatRow').removeClass('hide');
                currentModal.find('.currencyFxRates tr.non-editableRow:not(".currCalculationFXRate")').removeClass('hide');
                currentModal.find('.show-all-data').text("Show Current Calculation Inputs Only");
            }
            else {
                currentModal.find('.SubCatRow').addClass('hide');
                currentModal.find('.currencyFxRates tr.non-editableRow:not(".currCalculationFXRate")').addClass('hide');
                currentModal.find('.show-all-data').text("Show All Inputs");
            }
        },
        EnableDisableCurrencyLocalOption: function () {
            if ($('#hdnShowCurrency').val() == "True") {
                var isCurrencyOnForBudget = RetailBudgetPro.Budget.isCurrencyOnForBudget == "True";

                var selectedStoreCurrencyCode = $('[name=lstStores] :selected').map(function () {
                    return $(this).attr('data-currencyCode')
                }).toArray();

                if (selectedStoreCurrencyCode.length > 0)
                    var isAllCodeSame = selectedStoreCurrencyCode.reduce(function (a, b) { return (a === b) ? a : (!b); }) === selectedStoreCurrencyCode[0];

                if (isAllCodeSame && isCurrencyOnForBudget) {
                    $('.CurrencyOptionDropDown option[value="0"]').html("Local (" + selectedStoreCurrencyCode[0] + ")");
                    $('.CurrencyOptionDropDown option[value="0"]').removeAttr('disabled');
                    $('.datasheetCurrency-Div .popover-icon').addClass('hide');
                    $('.CurrencyOptionDropDown').select2('val', '0');
                }
                else {
                    $('.CurrencyOptionDropDown option[value="0"]').html("Local");
                    $('.CurrencyOptionDropDown option[value="0"]').attr('disabled', 'disabled');
                    $('.CurrencyOptionDropDown').select2('val', '1');
                    $('.datasheetCurrency-Div .popover-icon').removeClass('hide')
                }
            }
        },

        GetLinkedCurrencyData: function (e) {
            var $target = $(e.target);

            if ($($($target).parents('.linked-currency-data').attr('data-target')).html() == undefined) {
                $('.layout').show();

                var $this = $(this);
                
                var plelementUID = $this.data('plelementuid');
                var decimalPlaces = $this.parents('tr').find('#hdnDecimalPlaces').html();
                var departmentUID = $this.parents('tr').find('#hdnDeptUID').html();
                var isNonFinancialCat = !($('[name="groupedcategory"] option[value$="|' + $this.parents('tr').find('#hdnCatUID').text() + '"]').data('isfinancialcat') == "True");

                var $parentTr = $($target).parents('tr').prevAll('tr[data-level="' + (parseInt($($target).parents('tr').attr('data-level')) - 1) + '"]:eq(0)')
                var transactionMode = $('[name="TransactionModeDropdown"]').val() == 'CASH' ? 'CASH' : 'ACCRUAL';
                $.ajax({
                    url: '/Budget/GetLinkedCurrencyData',
                    data: JSON.stringify({ plelementUID: plelementUID, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), mode: transactionMode }),
                    dataType: 'html',
                    type: 'post',
                    contentType: 'application/json',
                    success: function (result) {

                        var newID = 'linkedCurrencyModal' + Math.floor(1000 + Math.random() * 9999);
                        $($target).parents('.linked-currency-data').attr('data-target', '#' + newID);
                        $('.page-content-wrapper').append(result);
                        $('.page-content-wrapper').find('#linkedCurrencyModal').attr('id', newID);

                        $(document).on('show.bs.modal', '#' + newID, function () {

                            $('#' + newID).find('.popup-plelementUID').val(plelementUID);
                            $('#' + newID).find('.popup-decimalPlaces').val(decimalPlaces);
                            $('#' + newID).find('.popup-departmentID').val(departmentUID);
                            $('#' + newID).find('.popup-isNonFinCategory').val(isNonFinancialCat);

                            $('#' + newID).find('.vendorLstDD').SumoSelectVendor({ selectAll: true, search: true, searchText: 'Search', placeholder: 'Select ' + $('#VendorName').val(), optWrapperCstmWidthToAuto: true, venList: vendorList });
                            $('#' + newID).find('[name="subCategoryCurrencyDD"]').SumoSelect();
                            $('#' + newID).find('[name="subCategoryTermDD"]').SumoSelect();

                            $('#' + newID).find(".vendor-info-icon").popover({
                                html: true,
                                content: function () {
                                    return $(this).parents('td').find('[id="vendor-info"]').html()
                                },
                                delay: { show: 50, hide: 100 }
                            });

                            var inEditMode = $parentTr.hasClass('inEditMode');
                            if (inEditMode) {
                                RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                                RetailBudgetPro.Budget.CurrencyFXRatesAudits = [];

                                var editableDataRows = $(this).find('.dataRow .editableRow');

                                if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True") {
                                    var convertedDataRows = $(this).find('.convertedDataRow tbody tr:not(.hidden-height0)');

                                    for (var i = 1; i <= 12; i++) {
                                        var selector = '.P' + ('0' + i).slice(-2) + 'Val';
                                        var $this_editable = editableDataRows.find(selector);
                                        var $this_converted = convertedDataRows.find(selector);

                                        $this_editable.val($this_editable.attr('data-accrualEditModeVal'));
                                        $this_converted.next("span").text($this_converted.attr('data-accrualEditModeVal'))
                                    }

                                    editableDataRows.find('.rowTotal').val(editableDataRows.find('.rowTotal').attr('data-accrualEditModeVal'));

                                    convertedDataRows.find('input.rowTotal').val(convertedDataRows.find('input.rowTotal').attr('data-accrualEditModeVal'));

                                    convertedDataRows.find('span.rowTotal').html(convertedDataRows.find('span.rowTotal').attr('data-accrualEditModeVal'));

                                    if (editableDataRows.find('.transactionDateDiv').hasClass('hide')) {
                                        editableDataRows.find('.dayOfPeriodDiv span').addClass('hide');
                                        editableDataRows.find('.dayOfPeriodDiv a').removeClass('hide');
                                        
                                    }
                                    else {
                                        editableDataRows.find('.transactionDateDiv span').addClass('hide');
                                        editableDataRows.find('.transactionDateDiv a').removeClass('hide');
                                    }

                                    //editableDataRows.find('.termSpan').addClass('hide');
                                    //editableDataRows.find('.termDD').removeClass('hide');
                                    
                                    editableDataRows.find('.amortSpan').addClass('hide');
                                    editableDataRows.find('.amortTextBox').removeClass('hide');
                                }
                                
                                //if ($(this).find('.currencyFxRates .currencyUID').val() != "-1") {
                                //    $(this).find('.currencyFxRates .editableRow .DATVal:not(.removeBackgndColor)').removeAttr('readonly').removeClass('readonlyTxt');
                                //    $(this).find('.currencyFxRates .editableRow .rowTotal').removeAttr('readonly').removeClass('readonlyTxt');
                                //    $(this).find('.currencyFxRates .averageFXRates').removeAttr('readonly').removeClass('readonlyTxt');

                                //    $(this).find('.currencyFxRates .action-head').removeClass("hide");
                                //    $(this).find('.currencyFxRates .action-row').removeClass("hide");
                                //}
                                //else {
                                //    $(this).find('.currencyFxRates .editableRow .DATVal:not(.removeBackgndColor)').attr('readonly', 'readonly').addClass('readonlyTxt');
                                //    $(this).find('.currencyFxRates .editableRow .rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                //    $(this).find('.currencyFxRates .averageFXRates').attr('readonly', 'readonly').addClass('readonlyTxt');

                                //    //$(this).find('.currencyFxRates .action-head').html("");
                                //    $(this).find('.currencyFxRates .action-row .distributeTotalFXRates').addClass("hide");
                                //}

                                $(this).find('.currencyFxRates .editableRow .DATVal:not(.removeBackgndColor), .currencyFxRates .averageFXRates').attr('readonly', 'readonly').addClass('readonlyTxt');
                               
			                    //For branch BD-1122
                                //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                                //    $(this).find('.currencyFxRates .averageFXRates').attr('readonly', 'readonly').addClass('readonlyTxt');
                                //}

                                $(this).find('.dataRow .editableRow .descriptionVal').removeAttr('readonly').removeClass('readonlyTxt');
                                //$(this).find('.dataRow .editableRow .vendorVal').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.dataRow .editableRow .DATVal:not(.removeBackgndColor)').removeAttr('readonly').removeClass('readonlyTxt');
                                $(this).find('.dataRow .editableRow .rowTotal').removeAttr('readonly').removeClass('readonlyTxt');

                                $(this).find('.save-linked-currency-data').removeClass('hide');
                                               
                                $(this).find('.copyPeriodValues').removeClass('hide');

                                //$(this).find('.dataRow .currencyDD').removeClass('hide');
                                //$(this).find('.dataRow .currency').addClass('hide');

                                //$(this).find('.dataRow .vendorDD').removeClass("hide");
                                //$(this).find('span.vendor').addClass("hide");

                                $(this).find('.accrualEditData-info-icon').addClass("hide");

                                $(this).find('.action-head').removeClass("hide");
                                $(this).find('.action-row').removeClass("hide");

                                if (editableDataRows.hasClass('highlightExcelRow')) {
                                    editableDataRows.find('td [type=text].DATVal, [type=text].rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt highlightBckg');
                                    editableDataRows.find('td input.amortize-period, td input.descriptionVal, td.vendorLst span.vendor').addClass('highlightBckg').attr('readonly', 'readonly');
                                    editableDataRows.find('div.dayOfPeriodDiv, div.transactionDateDiv, td.action-row div').addClass('disable-wrapper');
                                    editableDataRows.find('td input.descriptionVal').addClass('highlightBckg').attr('readonly', 'readonly');
                                    editableDataRows.find('td.currencyLst span.currency').removeClass('hide');
                                    editableDataRows.find('td.currencyLst div.sumo_subCategoryCurrencyDD').addClass('hidePerm');
                                    editableDataRows.find('td.vendorDesc .vendorVal').attr('readonly', 'readonly').addClass('highlightBckg');
                                }
                                else if (editableDataRows.find('.hdnCATCalculatedType').val() == "NE") {
                                    editableDataRows.find('td [type=text].DATVal, [type=text].rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                    editableDataRows.find('td.vendorLst span.vendor').attr('readonly', 'readonly');
                                    editableDataRows.find('div.dayOfPeriodDiv, div.transactionDateDiv, td.action-row div').addClass('disable-wrapper');
                                    editableDataRows.find('td input.descriptionVal, td input.amortize-period').attr('readonly', 'readonly').addClass('readonlyTxt');
                                    editableDataRows.find('td.currencyLst span.currency').removeClass('hide');
                                    editableDataRows.find('td.currencyLst div.sumo_subCategoryCurrencyDD').addClass('hidePerm');
                                    editableDataRows.find('td.vendorDesc .vendorVal').attr('readonly', 'readonly');
                                }
				                //For branch BD-1122
                                //else if (RetailBudgetPro.Budget.isUserInEditDataPageRole == 'False' && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == 'True') {
                                //    $(this).find('.currencyFxRates .editableRow .DATVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                //    editableDataRows.find('td.vendorLst span.vendor').attr('readonly', 'readonly');
                                //    editableDataRows.find('div.dayOfPeriodDiv, div.transactionDateDiv, td.action-row div').addClass('disable-wrapper');
                                //    editableDataRows.find('td input.descriptionVal, td input.amortize-period').attr('readonly', 'readonly').addClass('readonlyTxt');
                                //    editableDataRows.find('td.currencyLst span.currency').removeClass('hide');
                                //    editableDataRows.find('td.currencyLst div.sumo_subCategoryCurrencyDD').addClass('hidePerm');
                                //    editableDataRows.find('td.vendorDesc .vendorVal').attr('readonly', 'readonly');

                                //}
                                else {
                                    editableDataRows.find('.vendorDD').removeClass("hide");
                                    editableDataRows.find('span.vendor').addClass("hide");
                                    editableDataRows.find('.ven-lbl').addClass("hide");
                                    
                                    editableDataRows.find('td.currencyLst .currency').addClass('hide');
                                    editableDataRows.find('td.currencyLst .currencyDD').removeClass('hide');

                                    editableDataRows.find('.termSpan').addClass('hide');
                                    editableDataRows.find('.termDD').removeClass('hide');
                                }

                                var isCashFlowThrough = $parentTr.find('td#hdnIsCashFlowThrough').text();

                                var catId = $parentTr.find('td#hdnCatUID').text().trim();
                                var catOption = $('[name=groupedcategory] option.clsCategory[value$="|' + catId + '"]');

                                var isCapex = catOption.data('iscapex');
                                var isBalanceSheet = catOption.data('isbalancesheet');

                                if (isCashFlowThrough == "True" || (isCapex == "False" && isBalanceSheet == "True")) {
                                    editableDataRows.find('.amortSpan').removeClass('hide');
                                    editableDataRows.find('.amortTextBox').addClass('hide');

                                    if (editableDataRows.find('.amortSpan').html() == '') {
                                        editableDataRows.find('.amortSpan').html('1');
                                    }
                                }
                                else {
                                    editableDataRows.find('.amortSpan').addClass('hide');
                                    editableDataRows.find('.amortTextBox').removeClass('hide');
                                }
                            }
                            else {

                                //$(".vendor-info-icon").popover({
                                //    html: true,
                                //    content: function () {
                                //        return $(this).parents('td').find('[id="vendor-info"]').html()
                                //    },
                                //    delay: { show: 50, hide: 100 }
                                //});

                                if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True") {
                                    var editableDataRows = $(this).find('.dataRow .editableRow');
                                    var convertedDataRows = $(this).find('.convertedDataRow tbody tr:not(.hidden-height0)');

                                    for (var i = 1; i <= 12; i++) {
                                        var selector = '.P' + ('0' + i).slice(-2) + 'Val';
                                        var $this_editable = editableDataRows.find(selector);
                                        var $this_converted = convertedDataRows.find(selector);

                                        $this_editable.val($this_editable.attr('data-ViewModeValAC'));
                                        $this_converted.val($this_converted.next("span").text($this_converted.attr('data-ViewModeValAC')));
                                    }

                                    editableDataRows.find('.rowTotal').val(editableDataRows.find('.rowTotal').attr('data-ViewModeValAC'));

                                    convertedDataRows.find('input.rowTotal').val(convertedDataRows.find('input.rowTotal').attr('data-ViewModeValAC'));

                                    convertedDataRows.find('span.rowTotal').html(convertedDataRows.find('span.rowTotal').attr('data-ViewModeValAC'));

                                    if (editableDataRows.find('.transactionDateDiv').hasClass('hide')) {
                                        editableDataRows.find('.dayOfPeriodDiv span').removeClass('hide');
                                        editableDataRows.find('.dayOfPeriodDiv a').addClass('hide');
                                    }
                                    else {
                                        editableDataRows.find('.transactionDateDiv span').removeClass('hide');
                                        editableDataRows.find('.transactionDateDiv a').addClass('hide');
                                    }

                                    $(this).find('.dataRow .editableRow .termSpan').removeClass('hide');
                                    $(this).find('.dataRow .editableRow .termDD').addClass('hide');

                                    $(this).find('.dataRow .editableRow .amortSpan').removeClass('hide');
                                    $(this).find('.dataRow .editableRow .amortTextBox').addClass('hide');

                                    if (transactionMode == 'ACCRUAL') {
                                        editableDataRows.find('.accrualEditData-info-icon').removeClass('hide');
                                    }
                                    else {
                                        editableDataRows.find('.accrualEditData-info-icon').addClass('hide');
                                    }
                                }

                                $(this).find('.editableRow .descriptionVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.editableRow .vendorVal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.editableRow .DATVal:not(.removeBackgndColor)').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.editableRow .rowTotal').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.averageFXRates').attr('readonly', 'readonly').addClass('readonlyTxt');
                                $(this).find('.save-linked-currency-data').addClass('hide');

                                $(this).find('.dataRow .currencyDD').addClass('hide');
                                $(this).find('.dataRow .currency').removeClass('hide');

                                $(this).find('.copyPeriodValues').addClass('hide');

                                $(this).find('.dataRow .vendorDD').addClass("hide");
                                //$(this).find('span.vendor').removeClass("hide");
                                $(this).find('.dataRow .ven-lbl').removeClass("hide");

                                $(this).find('.action-head').addClass("hide");
                                $(this).find('.action-row').addClass("hide");                                
                            }

                            //disable locked periods
                            var period = 0;
                            var periodCount = Number( RetailBudgetPro.Budget.numberOfPeriodsVal);

                            var $dataRowGrid = $(this).find('.data-rows:not(.final-converted-row) tbody');
                            var $dataHeadRowGrid = $(this).find('.data-rows:not(.final-converted-row) thead');

                            for (var x = 1; x <= periodCount; x++) {
                                period = ("0" + x).slice(-2);
                                if ($('#LockedP' + period).val() == 'Y') {
                                    $dataRowGrid.find(('.DATVal.P' + period + 'Val:not(.hidden-height0)')).removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true);
                                    var $periodHead = $dataHeadRowGrid.find('[data-periodHead="P' + period + '"]');
                                    $periodHead.html($periodHead.data('label') + "<i class='fa fa-lock'></i>");
                                }
                            }

                        });

                        $('#' + newID).modal('show');
                        $('.layout').hide();
                    }

                });
            }
        },
        SaveRelatedCurrencyData: function () {

            var $formaulaModal = $(this).parents('.formulamodal');

            $('#' + $formaulaModal.attr('id')).modal('toggle');

            $('.layout').show();

            $('.custom-data-table').hide();

            var dataObj = [];
            var data = {};

            var fxRatesDataObj = [];
            var fxRatesData = {};

            var showVendorVal = $('#ShowVendor').val();

            var hdnNumberOfPeriodsVal = RetailBudgetPro.Budget.numberOfPeriodsVal;

            var TurnOnBalanceSheetVal = RetailBudgetPro.Budget.turnOnBalanceSheetVal;

            $formaulaModal.find('.dataRow').each(function () {

                var $formSec = $(this);

                var decimalPlaces = $formaulaModal.find('.popup-decimalPlaces').val();

                $(this).find('.budgets-table tbody tr.editableRow').each(function () {

                    var $this = $(this);

                    var newArray = [];
                    var oldArray = [];

                    data = {};

                    if (hdnNumberOfPeriodsVal == "13") {
                        var vendorUIDCSV = $this.find('.vendorLstDD').val() == null ? null : $this.find('.vendorLstDD').val().join(',');

                        data = {
                            "PLElementUID": $formaulaModal.find('.popup-plelementUID').val(), "DATValueM1": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(decimalPlaces), "DATValueM2": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(decimalPlaces), "DATValueM3": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(decimalPlaces), "DATValueM4": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(decimalPlaces), "DATValueM5": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(decimalPlaces), "DATValueM6": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(decimalPlaces), "DATValueM7": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(decimalPlaces), "DATValueM8": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(decimalPlaces), "DATValueM9": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(decimalPlaces), "DATValueM10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()), "DATValueM11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()), "DATValueM12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(decimalPlaces), "DATValueM13": ConvertCurrencyStringToDecimal($this.find('.P13Val').val()).toFixed(decimalPlaces),
                            "VENDescription": $this.find('.vendorVal').val(), "DATDescription": $this.find('.descriptionVal').val(), "DATPLCategoryUID": $formaulaModal.find('.popup-categoryID').val(), "DATDepartmentUID": $formaulaModal.find('.popup-departmentID').val(), "DATStoreUID": $formaulaModal.find('.popup-storeID').val(), "VendorUIDCSV": vendorUIDCSV, "LoadFromExcel": false, "CurrencyUID": $this.find('[name="subCategoryCurrencyDD"]').val(),
                            "TransactionDate": new Date(), "DayOfPeriod": 15, "TermUID": -1, "AmortizePeriod": 1
                            //,"Decimal_Places": $formaulaModal.find('.popup-decimalPlaces').val()
                        };

                        oldArray.unshift('-');
                        oldArray.push($this.parents('.formulamodal-sec').find('.popup-categoryID').val());
                        oldArray.push($this.find('.storeUID').val());
                        if ($formaulaModal.find('.popup-plelementUID').val() != "-1") {
                            $this.find('[type="text"]').siblings('span').filter(function () {
                                if ($(this).siblings('[type="text"]').hasClass('vendorVal') || $(this).siblings('[type="text"]').hasClass('descriptionVal'))
                                    oldArray.push($(this).html());
                                else if ($(this).parents('td').hasClass('vendorDesc')) {
                                    oldArray.push($(this).parents('td.vendorDesc').find('.vendorVal').val().trim())
                                }
                                else if ($(this).parents('td').hasClass('currencyLst')) oldArray.push($(this).parents('td').find('[name="subCategoryCurrencyDD"]').val());
                                else
                                    oldArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                            });
                        }
                        else
                            oldArray.push("", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                        oldArray.push('0');
                        oldArray.push($('.linkedCurrencymodal .popup-plelementUID').val());
                        RetailBudgetPro.Budget.FormulaPopUpAudits.push(oldArray);

                        newArray.unshift('+');
                        newArray.push($this.parents('.formulamodal-sec').find('.popup-categoryID').val());
                        newArray.push($this.find('.storeUID').val());
                        newArray.push($this.find('.descriptionVal').val());
                        newArray.push($this.find('.vendorVal').val());
                        newArray.push(data.DATValueM1, data.DATValueM2, data.DATValueM3, data.DATValueM4, data.DATValueM5, data.DATValueM6, data.DATValueM7, data.DATValueM8, data.DATValueM9, data.DATValueM10, data.DATValueM11, data.DATValueM12, data.DATValueM13);
                        newArray.push($('.linkedCurrencymodal .popup-plelementUID').val());
                        RetailBudgetPro.Budget.FormulaPopUpAudits.push(newArray);
                    }
                    else {
                        var vendorUIDCSV = $this.find('.vendorLstDD').val() == null ? null : $this.find('.vendorLstDD').val().join(',');

                        var oldVendorVal = (showVendorVal == "True") ? ($this.find('.vendor').length == 0 ? "" : $this.find('.vendor').html().trim()) : $this.find('.vendorVal').siblings('span:eq(0)').html();
                        var newVendorVal = (showVendorVal == "True") ? $this.find('.vendorLstDD option:selected').map(function () { return $(this).html() }).get().join() : $this.find('.vendorVal').val();


                        var isNonFinCat = $formaulaModal.find('.popup-isNonFinCategory').val() == "true";
                        var isTermFormulaType = $this.find('[name="subCategoryTermDD"] option:selected').attr('data-isformulatype') == "True";
                        var turnOnBalanceSheet = (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && !isNonFinCat);
                        var amortPeriod = (turnOnBalanceSheet ? $this.find('.amortize-period').val() : 1);

                        data = {
                            "PLElementUID": $formaulaModal.find('.popup-plelementUID').val(), "DATValueM1": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(decimalPlaces), "DATValueM2": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(decimalPlaces), "DATValueM3": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(decimalPlaces), "DATValueM4": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(decimalPlaces), "DATValueM5": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(decimalPlaces), "DATValueM6": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(decimalPlaces), "DATValueM7": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(decimalPlaces), "DATValueM8": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(decimalPlaces), "DATValueM9": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(decimalPlaces), "DATValueM10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()), "DATValueM11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()), "DATValueM12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(decimalPlaces),
                            "VENDescription": $this.find('.vendorVal').val(), "DATDescription": $this.find('.descriptionVal').val(), "DATPLCategoryUID": $formaulaModal.find('.popup-categoryID').val(), "DATDepartmentUID": $formaulaModal.find('.popup-departmentID').val(), "DATStoreUID": $formaulaModal.find('.popup-storeID').val(), "VendorUIDCSV": vendorUIDCSV, "LoadFromExcel": false, "CurrencyUID": $this.find('[name="subCategoryCurrencyDD"]').val(),
                            "TransactionDate": (amortPeriod > 1 || isTermFormulaType ? $this.find('.transactionDateDiv a').attr('data-date') : new Date()), "DayOfPeriod": (turnOnBalanceSheet && amortPeriod <= 1 && !isTermFormulaType ? $this.find('.dayOfPeriodDiv a').attr('data-day') : 15),
                            "TermUID": (!turnOnBalanceSheet || $this.find('[name="subCategoryTermDD"] option:selected').val() == "" ? -1 : $this.find('[name="subCategoryTermDD"] option:selected').val()), "AmortizePeriod": amortPeriod
                            //,"Decimal_Places": $formaulaModal.find('.popup-decimalPlaces').val()
                        };
                        oldArray.unshift('-');
                        oldArray.push($formaulaModal.find('.popup-categoryID').val());
                        oldArray.push($formaulaModal.find('.popup-storeID').val());
                        oldArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");

                        if ($formaulaModal.find('.popup-plelementUID').val() != "-1") {

                            oldArray.push($this.find('[type="text"].descriptionVal').siblings('span').html());

                            //if ($(this).parents('td').hasClass('vendorLst')) {
                            //    oldArray.push($(this).parents('td.vendorLst').find('span.vendorDescCSV').html().trim());
                            //}
                            //else if ($(this).parents('td').hasClass('vendorDesc')) {
                            //    oldArray.push($(this).parents('td.vendorDesc').find('.vendorDescCSV').html());
                            //}

                            oldArray.push(oldVendorVal);

                            if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && !isNonFinCat) {
                                if ($this.find('.dateLst').hasClass('isTransactionDate'))
                                    oldArray.push($this.find('.dateLst .transactionDateDiv .transactionSpan').attr('data-value'));
                                else
                                    oldArray.push(GetOrdinalValue($this.find('.dateLst .dayOfPeriodDiv .dayOfPeriod').attr('data-value')));

                                oldArray.push($this.find('.termLst .termSpan').html());
                                oldArray.push($this.find('.amortizePeriodLst span').html());
                            }

                            $this.find('input[type="text"].DATVal').each(function () {
                                oldArray.push(ConvertCurrencyStringToDecimal($(this).attr('data-accrualEditModeVal')));
                            });

                            //$this.find('[type="text"]').siblings('span').filter(function () {
                            //    if ($(this).siblings('[type="text"]').hasClass('descriptionVal'))
                            //        oldArray.push($(this).html());
                            //    else if ($(this).parents('td').hasClass('vendorLst')) {
                            //        oldArray.push($(this).parents('td.vendorLst').find('span.vendorDescCSV').html().trim());
                            //    }
                            //    else if ($(this).parents('td').hasClass('vendorDesc')) {
                            //        oldArray.push($(this).parents('td.vendorDesc').find('.vendorDescCSV').html());
                            //    }
                            //    else if ($(this).parents('td').hasClass('currencyLst')) oldArray.push($(this).parents('td').find('[name="subCategoryCurrencyDD"]').val());
                            //    else
                            //        oldArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                            //});
                        }
                        else
                            if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12)
                                oldArray.push("", "", "", "", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                            else
                                oldArray.push("", "", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0");
                        oldArray.push('0');
                        oldArray.push($('.linkedCurrencymodal .popup-plelementUID').val());
                        RetailBudgetPro.Budget.FormulaPopUpAudits.push(oldArray);

                        newArray.unshift('+');
                        newArray.push($formaulaModal.find('.popup-categoryID').val());
                        newArray.push($formaulaModal.find('.popup-storeID').val());
                        newArray.push(isNonFinCat ? "NON-FINANCIAL" : "FINANCIAL");
                        newArray.push($this.find('.descriptionVal').val());


                        if (showVendorVal == "True") {
                            newArray.push($this.find('.vendorLstDD option:selected').map(function () {
                                return $(this).text().trim()
                            }).get().join(', '));
                        }
                        else {
                            newArray.push($this.find('.vendorVal').val().trim());
                        }

                        if (TurnOnBalanceSheetVal == "True" && hdnNumberOfPeriodsVal == 12 && !isNonFinCat) {
                            newArray.push((data.AmortizePeriod > 1 ? data.TransactionDate : GetOrdinalValue(data.DayOfPeriod)), (data.TermUID == -1 ? "" : $this.find('[name="subCategoryTermDD"] option:selected').html()), data.AmortizePeriod);
                        }

                        newArray.push(data.DATValueM1, data.DATValueM2, data.DATValueM3, data.DATValueM4, data.DATValueM5, data.DATValueM6, data.DATValueM7, data.DATValueM8, data.DATValueM9, data.DATValueM10, data.DATValueM11, data.DATValueM12);
                        newArray.push('0');
                        newArray.push($('.linkedCurrencymodal .popup-plelementUID').val());
                        RetailBudgetPro.Budget.FormulaPopUpAudits.push(newArray);
                    }

                    dataObj.push(data);
                });
            });

            var decimalPlaces = $formaulaModal.find('.popup-decimalPlaces').val();
            var $row = $formaulaModal.find('.currencyFxRates .fxrates-table tbody tr.editableRow');

            var $this = $row;

            var newArray = [];
            var oldArray = [];

            if (hdnNumberOfPeriodsVal == "13") {

                fxRatesData = {
                    "CurrencyID": $this.find('.currencyUID').val(), "CurrencyDescription": $this.find('.descriptionVal').html(), "Year": $this.find('.year-row').html(), "P01": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(3), "P02": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(3), "P03": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(3), "P04": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(3), "P05": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(3), "P06": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(3), "P07": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(3), "P08": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(3), "P09": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(3), "P10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()).toFixed(3), "P11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()).toFixed(3), "P12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(3), "P13": ConvertCurrencyStringToDecimal($this.find('.P13Val').val()).toFixed(3)
                };

                oldArray.unshift('-');
                oldArray.push($this.find('.descriptionVal').html());//CurrencyCode+description
                oldArray.push($this.find('.non-split-year').val());//Year
                $this.find('[type="text"]').siblings('span').filter(function () {
                    oldArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                });

                oldArray.push('-1');
                RetailBudgetPro.Budget.CurrencyFXRatesAudits.push(oldArray);

                newArray.unshift('+');
                newArray.push($this.find('.descriptionVal').html());//CurrencyCode+description
                newArray.push($this.find('.non-split-year').val());//Year
                newArray.push(fxRatesData.P01, fxRatesData.P02, fxRatesData.P03, fxRatesData.P04, fxRatesData.P05, fxRatesData.P06, fxRatesData.P07, fxRatesData.P08, fxRatesData.P09, fxRatesData.P10, fxRatesData.P11, fxRatesData.P12, fxRatesData.P13);

                RetailBudgetPro.Budget.CurrencyFXRatesAudits.push(newArray);
            }
            else {

                fxRatesData = {
                    "CurrencyID": $this.find('.currencyUID').val(), "CurrencyDescription": $this.find('.descriptionVal').html(), "Year": $this.find('.year-row').html(), "P01": ConvertCurrencyStringToDecimal($this.find('.P01Val').val()).toFixed(3), "P02": ConvertCurrencyStringToDecimal($this.find('.P02Val').val()).toFixed(3), "P03": ConvertCurrencyStringToDecimal($this.find('.P03Val').val()).toFixed(3), "P04": ConvertCurrencyStringToDecimal($this.find('.P04Val').val()).toFixed(3), "P05": ConvertCurrencyStringToDecimal($this.find('.P05Val').val()).toFixed(3), "P06": ConvertCurrencyStringToDecimal($this.find('.P06Val').val()).toFixed(3), "P07": ConvertCurrencyStringToDecimal($this.find('.P07Val').val()).toFixed(3), "P08": ConvertCurrencyStringToDecimal($this.find('.P08Val').val()).toFixed(3), "P09": ConvertCurrencyStringToDecimal($this.find('.P09Val').val()).toFixed(3), "P10": ConvertCurrencyStringToDecimal($this.find('.P10Val').val()).toFixed(3), "P11": ConvertCurrencyStringToDecimal($this.find('.P11Val').val()).toFixed(3), "P12": ConvertCurrencyStringToDecimal($this.find('.P12Val').val()).toFixed(3)
                };

                oldArray.unshift('-');
                oldArray.push($this.find('.descriptionVal').html());//CurrencyCode+description
                oldArray.push($this.find('.non-split-year').val());//Year
                $this.find('[type="text"]').siblings('span').filter(function () {
                    oldArray.push(ConvertCurrencyStringToDecimal($(this).html()));
                });
                oldArray.push('0');
                RetailBudgetPro.Budget.CurrencyFXRatesAudits.push(oldArray);

                newArray.unshift('+');
                newArray.push($this.find('.descriptionVal').html());//CurrencyCode+description
                newArray.push($this.find('.non-split-year').val());//Year
                newArray.push(fxRatesData.P01, fxRatesData.P02, fxRatesData.P03, fxRatesData.P04, fxRatesData.P05, fxRatesData.P06, fxRatesData.P07, fxRatesData.P08, fxRatesData.P09, fxRatesData.P10, fxRatesData.P11, fxRatesData.P12);
                newArray.push('0');
                newArray.push('-1');
                RetailBudgetPro.Budget.CurrencyFXRatesAudits.push(newArray);
            }

            fxRatesDataObj.push(data);

            if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                var rowString = '';

                $('.expanded').map(function (v) {
                    rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                });

                var $linkedRow = $('.linked-category-data[data-target="#' + $formaulaModal.attr('id') + '"]').parents('tr');

                var $activeRow = $linkedRow.prevAll('[data-level=' + ($linkedRow.attr('data-level') - 1) + ']').eq(0);

                localStorage.setItem("ActiveRow", $activeRow.find('#hdnStoreUID').html() + '|' + $activeRow.find('#hdnDeptUID').html() + '|' + $activeRow.find('#hdnCatUID').html());

                localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

            }

            localStorage.setItem("ExpandRows", "True");

            var stores = [];
            var groupedcategory = $('[name=groupedcategory] :selected').val();
            var stores = $('[name=lstStores]').val().toString();
            var level = "0";
            var viewLevel = "STORE";
            var storeID = "-1";
            var deptID = "-1";
            var categoryID = "-1";
            var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
            var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

            $.ajax({
                url: '/Budget/SaveRelatedCurrencyData',
                type: 'POST',
                async: true,
                dataType: 'html',
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify({ data: data, budgetFXRates: fxRatesData, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, Stores: stores, groupedcategory: groupedcategory, CompNonCompfilter: RetailBudgetPro.Budget.filter, level: level, viewLevel: viewLevel, AuditData: RetailBudgetPro.Budget.FormulaPopUpAudits, showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), budgetFXAuditData: RetailBudgetPro.Budget.CurrencyFXRatesAudits, decimalPlaces, vendorIdCSV: $('[name="datapageVendordd"]').val() == undefined ? "-2" : $('[name="datapageVendordd"]').val().join(','), bsMode: bsMode, categoryType: categoryType }),
                success: function (data) {
                    RetailBudgetPro.Budget.FormulaPopUpAudits = [];
                    $('#DataInputTable tbody').html('');
                    $('#DataInputTable tbody').html(data);
                    $(".hideyear").each(function () {
                        $(this).removeAttr("data-level");
                    });
                    $('#DataInputTable').find('.displayVendor').addClass('hide');
                    $('#DataInputTable').tabelize();
                    RetailBudgetPro.Budget.ManageDataAndPerentage();
                    $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                    $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                    $('.hideyear').find('td:first').html('');
                }
            });
        },
        SetGlobalVendorList: function () {
            showOptionsInVendorDropDown = $('[name="datapageVendordd"]').find('option:not([value=-1]):not([value=-2])').length >= parseInt($('#VendorCountThreshold').val());

            //the global variable vendorList must always be populated because it is used to initialize the sumoselectVendor dropdown for all the input popups
            //if (showOptionsInVendorDropDown) {
            $('[name="datapageVendordd"]').find('option:not([value=-1]):not([value=-2])').each(function (i) {
                var venObj = {
                    ParentVENDescription: $(this).closest('optgroup').attr('label'), VENDescription: $(this).text(), VendorUID: $(this).val()
                };
                vendorList.push(venObj);
            })
            //}
        },

        SetTransaction: function () {

            var $modal = $('#transactionPopup');

            if ($(this).parents('tr').hasClass('editableRow'))
                $modal.addClass('fromCurrencyModal').attr('data-srcid', $(this).parents('.modal').attr('id'));
            else if ($(this).parents('tr').hasClass('noFormulaRow'))
                $modal.addClass('fromFormulaModal').attr('data-srcid', $(this).parents('.modal').attr('id'));
            else
                $modal.removeClass('fromCurrencyModal').removeAttr('data-srcid');

            //if ($(this).parents('tr').hasClass('noFormulaRow'))
            //    $modal.addClass('fromFormulaModal').attr('data-srcid', $(this).parents('.modal').attr('id'));
            //else
            //    $modal.removeClass('fromFormulaModal').removeAttr('data-srcid');

            if ($(this).hasClass('dayOfPeriod')) {
                $modal.addClass('setDayOfPeriod').removeClass('setTransactionDate');
                $modal.find('.transactionDateDiv').addClass('hide');
                $modal.find('.dayOfPeriodDiv').removeClass('hide');
                $modal.find('select.dayOfPeriodDropdown').val($(this).attr('data-day')).trigger('change');
            }
            else {
                $modal.addClass('setTransactionDate').removeClass('setDayOfPeriod');
                $modal.find('.transactionDateDiv').removeClass('hide');
                $modal.find('.dayOfPeriodDiv').addClass('hide');
                $modal.find('[name="TransactionDate"]').val($(this).attr('data-date'));
            }

            $modal.modal('show');
        },

        SaveTransaction: function () {

            var $modal = $(this).parents('.modal');
            var isFromCurrencyModal = $modal.hasClass('fromCurrencyModal');

            if (isFromCurrencyModal || $modal.hasClass('fromFormulaModal')) {
                var $td = '';

                if (isFromCurrencyModal)
                    $td = $('#' + $modal.attr('data-srcid')).find('.dataRow tr.editableRow td.dateLst');
                else
                    $td = $('#' + $modal.attr('data-srcid')).find('tr.noFormulaRow.active-row td.dateLst');

                var value = '';
                var periodValue = $td.parents('tr').find('td input[type="text"].DATVal:not([readonly]):first()').val();

                if ($modal.hasClass('setDayOfPeriod')) {

                    value = $modal.find('select.dayOfPeriodDropdown option:selected').val();

                    $td.find('a.dayOfPeriod').attr('data-day', value).text(moment.localeData().ordinal(value));
                    
                    $modal.find('.close-pop-up').trigger('click');
                }
                else {
                    value = $modal.find('[name="TransactionDate"]').val();

                    var currentValueMonth = $td.parents('tr').find('#hdnPLElementUID').val() > 0 ? moment(new Date($td.find('a.transactionDate').attr('data-currentvalue'))).format('M') : -1;
                    var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val() - 1
                    var month = moment(new Date(value)).format('M');

                    if (currentValueMonth > 0 && month != currentValueMonth && !isFromCurrencyModal) {
                        $td.find('a.transactionDate').attr('data-date', value).attr('data-currentvalue', value).text(value);
                        
                        var periodClass = ("P" + ("0" + (month - startMonthOfFiscalYear > 0 ? (month - startMonthOfFiscalYear) : 12 + (month - startMonthOfFiscalYear))).slice(-2) + "Val");
                        
                        periodValue = periodValue != "" && periodValue != undefined ? periodValue : 0;
                        $td.parents('tr').find('input[type="text"].' + periodClass).val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');
                        $td.parents('tr').find('input[type="text"].DATVal:not(.amortize-period):not(.' + periodClass + ')').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');

                        $modal.find('.close-pop-up').trigger('click');
                    }
                    else {
                        $td.find('a.transactionDate').attr('data-date', value).text(value);
                       
                        var periodClass = ("P" + ("0" + (month - startMonthOfFiscalYear > 0 ? (month - startMonthOfFiscalYear) : 12 + (month - startMonthOfFiscalYear))).slice(-2) + "Val");

                        $td.parents('tr').find('input[type="text"].' + periodClass).val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

                        $td.parents('tr').find('input[type="text"].DATVal:not(.amortize-period):not(.' + periodClass + ')').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');

                        $modal.find('.close-pop-up').trigger('click');
                    }
                }
            }
            else {

                var $td = $('#DataInputTable tbody').find('tr.active-row td.dateLst');
                var value = '';
                var periodValue = $td.parents('tr').find('td.data input[type="text"]:not([readonly]):first()').val();

                if ($modal.hasClass('setDayOfPeriod')) {

                    value = $modal.find('select.dayOfPeriodDropdown option:selected').val();

                    $td.find('a.dayOfPeriod').attr('data-day', value);
                    $td.find('a.dayOfPeriod').text(moment.localeData().ordinal(value));

                    $modal.find('.close-pop-up').trigger('click');
                }
                else {
                    value = $modal.find('[name="TransactionDate"]').val();

                    var currentValueMonth = $td.parents('tr').find('#hdnPLElementUID').text() > 0 ? moment(new Date($td.find('a.transactionDate').attr('data-currentvalue'))).format('M') : -1;
                    var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val() - 1
                    var month = moment(new Date(value)).format('M');

                    if (currentValueMonth > 0 && month != currentValueMonth) {
                        $modal.find('.close-pop-up').trigger('click');

                        var confirmClick = function () {
                            $td.find('a.transactionDate').attr('data-date', value);
                            $td.find('a.transactionDate').text(value);
                            $td.find('a.transactionDate').attr('data-currentvalue', value);

                            var dataPeriod = ("P" + (month - startMonthOfFiscalYear > 0 ? (month - startMonthOfFiscalYear) : 12 + (month - startMonthOfFiscalYear)));
                            periodValue = periodValue != "" && periodValue != undefined ? periodValue : 0;
                            $td.parents('tr').find('input[type="text"][data-period="' + dataPeriod + '"]').val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');
                            $td.parents('tr').find('input[type="text"].bottomLevelText.editPeriod:not(.amortize-period):not([data-period="' + dataPeriod + '"])').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');
                        }

                        var cancelClick = function () {
                        }

                        custom_confirm(confirmClick, cancelClick, "Confirm", "The values for this period will move to the corresponding period for the date change. Please click Ok to confirm.");
                    }
                    else {
                        $td.find('a.transactionDate').attr('data-date', value);
                        $td.find('a.transactionDate').text(value);

                        var dataPeriod = ("P" + (month - startMonthOfFiscalYear > 0 ? (month - startMonthOfFiscalYear) : 12 + (month - startMonthOfFiscalYear)));

                        $td.parents('tr').find('input[type="text"][data-period="' + dataPeriod + '"]').val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');
                        $td.parents('tr').find('input[type="text"].bottomLevelText.editPeriod:not(.amortize-period):not([data-period="' + dataPeriod + '"])').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');

                        $modal.find('.close-pop-up').trigger('click');
                    }
                }
            }

            //if ($modal.hasClass('fromFormulaModal')) {
                
            //    var $td = $('#' + $modal.attr('data-srcid')).find('tr.noFormulaRow.active-row td.dateLst');
            //    var value = '';
            //    var periodValue = $td.parents('tr').find('td input[type="text"].DATVal:not([readonly]):first()').val();

            //    if ($modal.hasClass('setDayOfPeriod')) {

            //        value = $modal.find('select.dayOfPeriodDropdown option:selected').val();

            //        $td.find('a.dayOfPeriod').attr('data-day', value).text(moment.localeData().ordinal(value));

            //        $modal.find('.close-pop-up').trigger('click');
            //    }
            //    else {
            //        value = $modal.find('[name="TransactionDate"]').val();

            //        var currentValueMonth = $td.parents('tr').find('#hdnPLElementUID').val() > 0 ? moment(new Date($td.find('a.transactionDate').attr('data-currentvalue'))).format('M') : -1;

            //        var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val() - 1

            //        var month = moment(new Date(value)).format('M');

            //        if (currentValueMonth > 0 && month != currentValueMonth) {
            //            $td.find('a.transactionDate').attr('data-date', value).attr('data-currentvalue', value).text(value);

            //            var periodClass = ("P" + ("0" + (month - startMonthOfFiscalYear > 0 ? (month - startMonthOfFiscalYear) : 12 + (month - startMonthOfFiscalYear))).slice(-2) + "Val");

            //            periodValue = periodValue != "" && periodValue != undefined ? periodValue : 0;

            //            $td.parents('tr').find('input[type="text"].' + periodClass).val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

            //            $td.parents('tr').find('input[type="text"].DATVal:not(.amortize-period):not(.' + periodClass + ')').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');

            //            $modal.find('.close-pop-up').trigger('click');
            //        }
            //        else {
            //            $td.find('a.transactionDate').attr('data-date', value).text(value);

            //            var periodClass = ("P" + ("0" + (month - startMonthOfFiscalYear > 0 ? (month - startMonthOfFiscalYear) : 12 + (month - startMonthOfFiscalYear))).slice(-2) + "Val");

            //            $td.parents('tr').find('input[type="text"].' + periodClass).val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

            //            $td.parents('tr').find('input[type="text"].DATVal:not(.amortize-period):not(.' + periodClass + ')').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');

            //            $modal.find('.close-pop-up').trigger('click');
            //        }
            //    }
            //}
        },

        AmortizePeriodChange: function (obj, source) {
            var $this = obj;
       
            var $parentTr = $this.parents('tr');

            var $amort = $this.hasClass('amortize-period') ? $this : $parentTr.find('.amortize-period');
            var $termDD = $this.hasClass('amortize-period') ? $parentTr.find('[name="subCategoryTermDD"]') : $this;

            var $periodInputs = $parentTr.find('td.data input[type="text"]:not([readonly])');

            var hasDataClassInPeriodInputs = $periodInputs.length > 0;

            if (!hasDataClassInPeriodInputs) {
                $periodInputs = $parentTr.find('td input[type="text"]:not([readonly]).DATVal');
            }

            var $period = $periodInputs.filter(function () {
                return !isNaN(parseInt($(this).val(), 10)) && parseInt($(this).val(), 10) != 0;
            }).eq(0);

            var tbudgetYear = parseInt($('select.tbudgetYearDropDown').find('option:selected').val());

            if (Number($amort.val()) < 1) {
                custom_dialog("Ok", "", "Alert", "Amort must be greater than 0.");
                $amort.val("1");
            }

            if ($parentTr.hasClass('noFormulaRow') || $parentTr.hasClass('editableRow')) {

                if ($amort.val() == "" || ($termDD.find('option:selected').attr('data-isformulatype') != undefined && $termDD.find('option:selected').attr('data-isformulatype') == "True"))
                    $amort.val("1");

                if ($amort.val() == "1" && ($termDD.find('option:selected').attr('data-isformulatype') == undefined || $termDD.find('option:selected').attr('data-isformulatype') == "False")) {
                    $parentTr.find('td input[type="text"].DATVal').removeClass('disableByTransaction').removeAttr('readonly');

                    $parentTr.find('.transactionDateDiv').addClass('hide');
                    $parentTr.find('.dayOfPeriodDiv').removeClass('hide');
                }
                else {
                    if (source == "AmortizePeriod" || source == "UploadSubCatExcel") {
                        var periodValue = $period.val();

                        var periodClass = !hasDataClassInPeriodInputs ? $period.attr('class') : $period.attr('data-period');

                        var periodClassOrg = periodClass;

                        var transactionDate;
                        var month;

                        var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val() - 1;

                        tbudgetYear = startMonthOfFiscalYear > 0 ? tbudgetYear - 1 : tbudgetYear;

                        //var month = moment(new Date($parentTr.find('.transactionDateDiv .transactionDate').attr('data-date'))).format('M');

                        if (periodClass != undefined) {
                            periodClass = !hasDataClassInPeriodInputs ? periodClass.replace(/[^0-9]/g, '') : periodClass;

                            periodClassOrg = periodClass;

                            month = periodClass.length > 2 ? periodClass.slice(-2) : periodClass.slice(-1);

                            periodClass = "P" + month;

                            //month = (month - startMonthOfFiscalYear > 0 ? month - startMonthOfFiscalYear : 12 + (month - startMonthOfFiscalYear));

                            month = parseInt(month) + parseInt(startMonthOfFiscalYear) + 1;

                            if (month >= 12) tbudgetYear = tbudgetYear + 1;

                            month = month % 12 - 1;

                            transactionDate = moment(new Date(tbudgetYear, month - 1, "15")).format("MM/DD/YYYY");
                        }
                        else {
                            //commented by Himanshu because if all the periods are 0 then 1st periods must be enabled
                            periodClass = "P1";// + (startMonthOfFiscalYear + 1);

                            periodClassOrg = "01";

                            periodValue = "0";

                            transactionDate = moment(new Date(tbudgetYear, startMonthOfFiscalYear, "15")).format("MM/DD/YYYY");
                        }

                        //periodValue = ($inputToEnable.val() != "" && parseInt($inputToEnable.val().replace(',', ''), 10) != 0 ? $inputToEnable.val() : (periodValue != undefined && periodValue != "" ? periodValue : 0));

                        if (!hasDataClassInPeriodInputs) {
                            var $inputToEnable = $parentTr.find('td input[type="text"].P' + periodClassOrg + 'Val');

                            $inputToEnable.val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

                            $parentTr.find('td input[type="text"].DATVal:not(.amortize-period):not(.P' + periodClassOrg + 'Val)').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');
                        }
                        else {
                            var $inputToEnable = $parentTr.find('td input[type="text"][data-period="' + periodClass + '"].bottomLevelText.editPeriod');

                            $inputToEnable.val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

                            $parentTr.find('td input[type="text"].bottomLevelText.editPeriod:not(.amortize-period):not([data-period="' + periodClass + '"])').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');
                        }

                        $parentTr.find('.transactionDateDiv').removeClass('hide');

                        if (source != "UploadSubCatExcel") {
                            $parentTr.find('.transactionDateDiv a').attr('data-date', transactionDate).text(transactionDate);
                        }
                        $parentTr.find('.dayOfPeriodDiv').addClass('hide');
                    }
                }

                if ($termDD.find('option:selected').attr('data-isformulatype') != undefined && $termDD.find('option:selected').attr('data-isformulatype') == "True")
                    $amort.addClass('disableByTransaction').attr('readonly', 'readonly');
                else
                    $amort.removeClass('disableByTransaction').removeAttr('readonly');
            }
            else {

                if ($amort.val() == "" || ($termDD.find('option:selected').attr('data-isformulatype') != undefined && $termDD.find('option:selected').attr('data-isformulatype') == "True"))
                    $amort.val("1");

                if ($amort.val() == "1" && ($termDD.find('option:selected').attr('data-isformulatype') == undefined || $termDD.find('option:selected').attr('data-isformulatype') == "False")) {
                    $parentTr.find('td input[type="text"].bottomLevelText.editPeriod').removeClass('disableByTransaction').removeAttr('readonly');

                    $parentTr.find('.transactionDateDiv').addClass('hide');
                    $parentTr.find('.dayOfPeriodDiv').removeClass('hide');
                }
                else {
                    if (source == "AmortizePeriod" || source == "UploadSubCatExcel") {
                        var periodValue = $period.val();

                        var periodClass = !hasDataClassInPeriodInputs ? $period.attr('class') : $period.attr('data-period');

                        var periodClassOrg = periodClass;

                        var transactionDate;
                        var month;

                        var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val() - 1;
                        //var month = moment(new Date($parentTr.find('.transactionDateDiv .transactionDate').attr('data-date'))).format('M');

                        tbudgetYear = startMonthOfFiscalYear > 0 ? tbudgetYear - 1 : tbudgetYear;

                        if (periodClass != undefined) {
                            periodClass = !hasDataClassInPeriodInputs ? periodClass.replace(/[^0-9]/g, '') : periodClass;

                            periodClassOrg = periodClass;

                            month = periodClass.length > 2 ? periodClass.slice(-2) : periodClass.slice(-1);

                            periodClass = "P" + month;

                            //month = (month - startMonthOfFiscalYear > 0 ? month - startMonthOfFiscalYear : 12 + (month - startMonthOfFiscalYear));

                            month = parseInt(month) + parseInt(startMonthOfFiscalYear) + 1;

                            if (month >= 12) tbudgetYear = tbudgetYear + 1;

                            month = month % 12 - 1;

                            transactionDate = moment(new Date(tbudgetYear, month - 1, "15")).format("MM/DD/YYYY");
                        }
                        else {
                            //commented by Himanshu because if all the periods are 0 then 1st periods must be enabled
                            periodClass = "P1";// + (startMonthOfFiscalYear + 1); 

                            periodClassOrg = "01";

                            periodValue = "0";

                            transactionDate = moment(new Date(tbudgetYear, startMonthOfFiscalYear, "15")).format("MM/DD/YYYY");
                        }

                        //periodValue = ($inputToEnable.val() != "" && parseInt($inputToEnable.val().replace(',', ''), 10) != 0 ? $inputToEnable.val() : (periodValue != undefined && periodValue != "" ? periodValue : 0));

                        if (!hasDataClassInPeriodInputs) {
                            var $inputToEnable = $parentTr.find('td input[type="text"].P' + periodClassOrg + 'Val');

                            $inputToEnable.val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

                            $parentTr.find('td input[type="text"].DATVal:not(.amortize-period):not(.P' + periodClassOrg + 'Val)').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');
                        }
                        else {
                            var $inputToEnable = $parentTr.find('td input[type="text"][data-period="' + periodClass + '"].bottomLevelText.editPeriod');

                            $inputToEnable.val(periodValue).removeClass('disableByTransaction').removeAttr('readonly');

                            $parentTr.find('td input[type="text"].bottomLevelText.editPeriod:not(.amortize-period):not([data-period="' + periodClass + '"])').val('0').addClass('disableByTransaction').attr('readonly', 'readonly');
                        }

                        $parentTr.find('.transactionDateDiv').removeClass('hide');
                        if (source != "UploadSubCatExcel") {
                            $parentTr.find('.transactionDateDiv a').attr('data-date', transactionDate).text(transactionDate);
                        }
                        $parentTr.find('.dayOfPeriodDiv').addClass('hide');
                    }
                }

                if ($termDD.find('option:selected').attr('data-isformulatype') != undefined && $termDD.find('option:selected').attr('data-isformulatype') == "True")
                    $amort.addClass('disableByTransaction').attr('readonly', 'readonly');
                else
                    $amort.removeClass('disableByTransaction').removeAttr('readonly');
            }
        },

        DistributeTotalFXRates: function () {
            
            $(this).parents('tr.editableRow').find('.DATVal').val(Number($(this).parents('tr.editableRow').find('.averageFXRates').val()).toFixed(3));   
        },

        GrowthPeriodChange: function () {
            if ($(this).attr('name') == 'GrowthType') {
                if ($(this).val() == 'simple')
                    $('.form-group.growthPeriods').addClass('hide');
                else $('.form-group.growthPeriods').removeClass('hide');
            }
            else if ($(this).attr('name') == 'GrowthTypeForPreviousYear') {
                if ($(this).val() == 'simple')
                    $('.form-group.growthPeriodsForPreviousYear').addClass('hide');
                else $('.form-group.growthPeriodsForPreviousYear').removeClass('hide');
            }
        },

        HideCompoundRate: function () {
            var $periods = getNumberOfPeriods();

            if (RetailBudgetPro.Budget.turnOnBalanceSheetVal && $periods == 12) {
                var amortizePeriod = $(currentRow).find('.amortize-period').val();

                if (amortizePeriod > 1) {
                    $('.form-group.growthType').addClass('hide');
                    $('.form-group.growthPeriods').addClass('hide');
                } else {
                    $('.form-group.growthType').removeClass('hide');
                }
            }
        },

        BatchUpdateProcess: function (e) {
            var $target = e.target;
            var batchUpdateProcess = $($target).hasClass('start-edit-process') ? 1 : 2;

            var confirmClick = function () {

                $('.layout').show();

                $.ajax({
                    url: "/Budget/UpdateBatchProcessInfo",
                    type: "post",
                    async: true,
                    contentType: "application/json",
                    data: JSON.stringify({ BudgetId: parseInt($('[name=BudgetUID]').val()), BatchUpdateProcess: batchUpdateProcess }),
                    dataType: "json",
                    success: function (result) {

                        //console.log(result);
                        var confirmClick = function () {
                            window.location.reload();
                        }
                        var userMsg = "";

                        if (result.data == 8) {
                            userMsg = "Can not execute formulas as formulas are already executing for this " + $('[name="BudgetAlias"]').val();
                        }
                        else {
                            if (batchUpdateProcess == 1) {
                                if (result.data == -1) {
                                    userMsg = "Batch Edit Process successfully started.";
                                }
                                else if (result.data == 1) {
                                    userMsg = "Batch Edit Process is already started for this " + $('[name="BudgetAlias"]').val();
                                }
                                else if (result.data == 2) {
                                    userMsg = "Batch Edit Process can not start as formula execution is in process for this " + $('[name="BudgetAlias"]').val();
                                }
                                else if (result.data == 5) {
                                    userMsg = "Batch Edit Process is already started for this " + $('[name="BudgetAlias"]').val();
                                }
                                else if (result.data == 6) {
                                    userMsg = "Batch Edit Process can not start as formula execution is in process for this " + $('[name="BudgetAlias"]').val();
                                }
                            }
                            else {
                                if (result.data == 7) {
                                    userMsg = "Can not execute formulas as you do not have permission.";
                                }
                                else if (result.data == 0) {
                                    userMsg = "Formula Execution successfully started.";
                                }
                                else if (result.data == 2) {
                                    userMsg = "Can not execute formulas as formulas are already executing for this " + $('[name="BudgetAlias"]').val();
                                }
                                else if (result.data == 3 || result.data == -3) {
                                    // 3 - can not proceed as formulas are already executed.
                                    // -3 - can not execute formulas as edit process not started for this budget.
                                    userMsg = "Can not execute formulas as either formulas are already executed or the edit process not started for this " + $('[name="BudgetAlias"]').val();
                                }
                                else if (result.data == 4) {
                                    userMsg = "Some other user is saving the changes to the datasheet, please try after sometime";
                                }
                            }
                        }

                        custom_alert2(confirmClick, "Alert", userMsg);

                        $('.layout').hide();
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            }

            if (batchUpdateProcess == 1) {
                var cancelClick = function () {
                }

                var confirmMsg = "Once you click on the Mark Edit Process Complete button, it will start the formula execution " + ($('[name=TurnOnBalanceSheet]').val() == 'True' ? "and run the double entry" : "");

                custom_confirm(confirmClick, cancelClick, "Confirm", confirmMsg);
            }
            else confirmClick();
        }
    }  
}();

function HireDateCheck(ModalId) {

    //var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val();

    //var hire = new Date($(ModalId).find('[name="Employee.HireDate"]').val().split("/").reverse().join("/") + ' PST');
    //var termination = new Date($(ModalId).find('[name="Employee.TerminationDate"]').val().split("/").reverse().join("/") + ' PST');
    //var hireYear = hire.getFullYear();
    //var terminationYear = termination.getFullYear();
    //var terminationMonth = termination.getMonth() + 2;
    //var hireMonth = hire.getMonth() - startMonthOfFiscalYear + 1;
    //var currentYear = $('#hdnBudgetYear').val();

    //var classVals = [];

    //classVals.push(".allocationSalaryCheck");
    //classVals.push(".allocationHourCheck");
    //classVals.push(".allocationHourlyRateCheck");
    //classVals.push(".overtimeSalaryCheck");
    //classVals.push(".overtimeSalaryRateCheck");
    //classVals.push(".allocationTotal");
    //classVals.push(".overtimeHourCheck");
    //classVals.push(".overtimeHourlyRateCheck");
    //classVals.push(".grossComp-hrFormula-div");
    //classVals.push(".GrowthRateDiv");
    //classVals.push(".allocationSalaryDollarCheck");

    //if (currentYear == hireYear) {
    //    for (i = hireMonth; i > 0 ; i--) {

    //        var periodVal = i < 10 ? "0" + i.toString() : i.toString();

    //        for (var loopVar = 0; loopVar < classVals.length; loopVar++) {

    //            var divClass = ' ' + classVals[loopVar];

    //            $(ModalId + divClass + ' table tbody').find('[data-Period=P' + periodVal + ']').prop("disabled", true);
    //            $(ModalId + divClass + ' table tbody').find('[data-Period=P' + periodVal + ']').val(0);
    //            $(ModalId + divClass + ' table tbody').find('[data-Period=P' + periodVal + ']').addClass('disabledByHire removeBackgndColor');

    //            if (i == 1)
    //                $(ModalId + divClass + ' table tbody').find('.copyPeriodValues').hide();
    //        }
    //    }
    //}
    //else if (currentYear < hireYear) {
    //    for (var loopVar = 0; loopVar < classVals.length; loopVar++) {

    //        var divClass = ' ' + classVals[loopVar];

    //        $(ModalId + divClass + ' table tbody').find('[data-Period ^= "P"]').prop("disabled", true);
    //        $(ModalId + divClass + ' table tbody').find('[data-Period ^= "P"]').val(0);
    //        $(ModalId + divClass + ' table tbody').find('.copyPeriodValues').hide();
    //        $(ModalId + divClass + ' table tbody').find('[data-Period ^= "P"]').addClass('disabledByHire removeBackgndColor');
    //    }
    //}

    //if (!isNaN(terminationYear) && currentYear == terminationYear) {
    //    for (i = terminationMonth; i <= 13; i++) {
    //        for (var loopVar = 0; loopVar < classVals.length; loopVar++) {

    //            var divClass = ' ' + classVals[loopVar];

    //            $(ModalId + divClass + ' table tbody').find('[data-Period=P' + i + ']').prop("disabled", true);
    //            $(ModalId + divClass + ' table tbody').find('[data-Period=P' + i + ']').val(0);
    //            $(ModalId + divClass + ' table tbody').find('[data-Period=P' + i + ']').addClass('disabledByHire removeBackgndColor');

    //            if (i == 1)
    //                $(ModalId + divClass + ' table tbody').find('.copyPeriodValues').hide();
    //        }
    //    }
    //}
    //else if (!isNaN(terminationYear) && currentYear > terminationYear) {
    //    for (var loopVar = 0; loopVar < classVals.length; loopVar++) {

    //        var divClass = ' ' + classVals[loopVar];

    //        $(ModalId + divClass + ' table tbody').find('[data-Period ^= "P"]').prop("disabled", true);
    //        $(ModalId + divClass + ' table tbody').find('[data-Period ^= "P"]').val(0);
    //        $(ModalId + divClass + ' table tbody').find('.copyPeriodValues').hide();
    //        $(ModalId + divClass + ' table tbody').find('[data-Period ^= "P"]').addClass('disabledByHire removeBackgndColor');
    //    }
    //}

    var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val();
    var flag = 0;
    var hire = moment(new Date($(ModalId).find('[name="Employee.HireDate"]').val().split("/").reverse().join("/") + ' PST'));
    var termination = moment(new Date($(ModalId).find('[name="Employee.TerminationDate"]').val().split("/").reverse().join("/") + ' PST'));
    var hireYear = hire.format('YYYY');
    var terminationYear = termination.format('YYYY');
    var terminationMonth = termination.format('M') - startMonthOfFiscalYear + 3;
    var hireMonth = hire.format('M') - startMonthOfFiscalYear + 1;
    var currentYear = parseInt($('#hdnBudgetYear').val() - ($('[name=IsSplitYear]').val() == 'True' ? 1 : 0));

    var classVals = [];

    classVals.push(".allocationSalaryCheck");
    classVals.push(".allocationHourCheck");
    classVals.push(".allocationHourlyRateCheck");
    classVals.push(".overtimeSalaryCheck");
    classVals.push(".overtimeSalaryRateCheck");
    classVals.push(".allocationTotal");
    classVals.push(".overtimeHourCheck");
    classVals.push(".overtimeHourlyRateCheck");
    classVals.push(".grossComp-hrFormula-div");
    classVals.push(".GrowthRateDiv");
    classVals.push(".allocationSalaryDollarCheck");

    var fiscalMonth = startMonthOfFiscalYear - 1;
    var fiscalDate = moment(new Date(currentYear, fiscalMonth, 01, 00, 00, 00, 00));
    var fiscalDateMonth = fiscalDate.format('M');
    var fiscalDateYear = fiscalDate.format('YYYY');
    var date = moment(termination);
    if (isNaN(termination)) {
        flag = 1;
        date = moment(new Date());
    }

    var disabledByHireOrTermPeriodCount = 0;

    for (i = 1 ; i <= 13; i++) {
        var periodTxt = i < 10 ? "P0" + i : "P" + i;
        var monthDiffFromHireDate = hire.diff(fiscalDate, 'months');
        var monthDiffFromTerminationDate = termination.diff(fiscalDate, 'months');

        if (monthDiffFromHireDate > i - 1 || (isNaN(date) == isNaN(termination) && monthDiffFromTerminationDate < i - 1)) {
            for (var loopVar = 0; loopVar < classVals.length; loopVar++) {
                var divClass = ' ' + classVals[loopVar];

                $(ModalId + divClass + ' table tbody').find('[data-Period = "' + periodTxt + '"]').prop("disabled", true).val(0).addClass('disabledByHire removeBackgndColor');
                //$(ModalId + divClass + ' table tbody').find('.copyPeriodValues').hide();

                disabledByHireOrTermPeriodCount += 1;
            }
        }

    }

    if ($('#hdnAllMonthsLockedOrDeactivated').val() == "True" || disabledByHireOrTermPeriodCount == RetailBudgetPro.Budget.numberOfPeriodsVal) {
        $(ModalId + ' table tbody .copyPeriodValues').hide();
    }
}

function DisableLockedPeriods() {

    var i = ($('#ShowVendor').val() == "True" ? 3 : 2)

    if ($('#LockedP01').val() == 'Y') { $('.payrollModal [data-Period="P01"]:not("#EAValueM1")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P01"]:not("#EAValueM1")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P01"]:not("#EAValueM1")').parents('table').find('th:nth-child(' + (i + 0) + ')').html($('#period01Alias').val() + ($('#BUDInactiveM01').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP02').val() == 'Y') { $('.payrollModal [data-Period="P02"]:not("#EAValueM2")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P02"]:not("#EAValueM2")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P02"]:not("#EAValueM2")').parents('table').find('th:nth-child(' + (i + 1) + ')').html($('#period02Alias').val() + ($('#BUDInactiveM02').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP03').val() == 'Y') { $('.payrollModal [data-Period="P03"]:not("#EAValueM3")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P03"]:not("#EAValueM3")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P03"]:not("#EAValueM3")').parents('table').find('th:nth-child(' + (i + 2) + ')').html($('#period03Alias').val() + ($('#BUDInactiveM03').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP04').val() == 'Y') { $('.payrollModal [data-Period="P04"]:not("#EAValueM4")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P04"]:not("#EAValueM4")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P04"]:not("#EAValueM4")').parents('table').find('th:nth-child(' + (i + 3) + ')').html($('#period04Alias').val() + ($('#BUDInactiveM04').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP05').val() == 'Y') { $('.payrollModal [data-Period="P05"]:not("#EAValueM5")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P05"]:not("#EAValueM5")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P05"]:not("#EAValueM5")').parents('table').find('th:nth-child(' + (i + 4) + ')').html($('#period05Alias').val() + ($('#BUDInactiveM05').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP06').val() == 'Y') { $('.payrollModal [data-Period="P06"]:not("#EAValueM6")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P06"]:not("#EAValueM6")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P06"]:not("#EAValueM6")').parents('table').find('th:nth-child(' + (i + 5) + ')').html($('#period06Alias').val() + ($('#BUDInactiveM06').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP07').val() == 'Y') { $('.payrollModal [data-Period="P07"]:not("#EAValueM7")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P07"]:not("#EAValueM7")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P07"]:not("#EAValueM7")').parents('table').find('th:nth-child(' + (i + 6) + ')').html($('#period07Alias').val() + ($('#BUDInactiveM07').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP08').val() == 'Y') { $('.payrollModal [data-Period="P08"]:not("#EAValueM8")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P08"]:not("#EAValueM8")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P08"]:not("#EAValueM8")').parents('table').find('th:nth-child(' + (i + 7) + ')').html($('#period08Alias').val() + ($('#BUDInactiveM08').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP09').val() == 'Y') { $('.payrollModal [data-Period="P09"]:not("#EAValueM9")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P09"]:not("#EAValueM9")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P09"]:not("#EAValueM9")').parents('table').find('th:nth-child(' + (i + 8) + ')').html($('#period09Alias').val() + ($('#BUDInactiveM09').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP10').val() == 'Y') { $('.payrollModal [data-Period="P10"]:not("#EAValueM10")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P10"]:not("#EAValueM10")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P10"]:not("#EAValueM10")').parents('table').find('th:nth-child(' + (i + 9) + ')').html($('#period10Alias').val() + ($('#BUDInactiveM10').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP11').val() == 'Y') { $('.payrollModal [data-Period="P11"]:not("#EAValueM11")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr('readonly', true); $('.payrollModal [data-Period="P11"]:not("#EAValueM11")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P11"]:not("#EAValueM11")').parents('table').find('th:nth-child(' + (i + 10) + ')').html($('#period11Alias').val() + ($('#BUDInactiveM11').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP12').val() == 'Y') { $('.payrollModal [data-Period="P12"]:not("#EAValueM12")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P12"]:not("#EAValueM12")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P12"]:not("#EAValueM12")').parents('table').find('th:nth-child(' + (i + 11) + ')').html($('#period12Alias').val() + ($('#BUDInactiveM12').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
    if ($('#LockedP13').val() == 'Y') { $('.payrollModal [data-Period="P13"]:not("#EAValueM13")').removeClass('yellowBckgTxtBx').addClass('disableBckgTxtBx').attr("readonly", true); $('.payrollModal [data-Period="P13"]:not("#EAValueM13")').removeClass('yellowBckgTxtBx'); $('.payrollModal [data-Period="P13"]:not("#EAValueM13")').parents('table').find('th:nth-child(' + (i + 12) + ')').html($('#period13Alias').val() + ($('#BUDInactiveM13').val() == 'Y' ? ' <i class="fa fa-minus-circle"></i>' : ' <i class="fa fa-lock"></i>')) }
}

function DisableLockedPeriodsForCopyModal() {

    if ($('#LockedP01').val() == 'Y') { $('.CopyDataModal table.table').find('th.P01Val').html($('#period01Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP02').val() == 'Y') { $('.CopyDataModal table.table').find('th.P02Val').html($('#period02Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP03').val() == 'Y') { $('.CopyDataModal table.table').find('th.P03Val').html($('#period03Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP04').val() == 'Y') { $('.CopyDataModal table.table').find('th.P04Val').html($('#period04Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP05').val() == 'Y') { $('.CopyDataModal table.table').find('th.P05Val').html($('#period05Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP06').val() == 'Y') { $('.CopyDataModal table.table').find('th.P06Val').html($('#period06Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP07').val() == 'Y') { $('.CopyDataModal table.table').find('th.P07Val').html($('#period07Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP08').val() == 'Y') { $('.CopyDataModal table.table').find('th.P08Val').html($('#period08Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP09').val() == 'Y') { $('.CopyDataModal table.table').find('th.P09Val').html($('#period09Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP10').val() == 'Y') { $('.CopyDataModal table.table').find('th.P10Val').html($('#period10Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP11').val() == 'Y') { $('.CopyDataModal table.table').find('th.P11Val').html($('#period11Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP12').val() == 'Y') { $('.CopyDataModal table.table').find('th.P12Val').html($('#period12Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP13').val() == 'Y') { $('.CopyDataModal table.table').find('th.P13Val').html($('#period13Alias').val() + ' <i class="fa fa-lock"></i>') }
}

function DisableLockedPeriodsForCopyModalBS() {

    if ($('#LockedP01').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P01Val').html($('#period01Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP02').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P02Val').html($('#period02Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP03').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P03Val').html($('#period03Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP04').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P04Val').html($('#period04Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP05').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P05Val').html($('#period05Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP06').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P06Val').html($('#period06Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP07').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P07Val').html($('#period07Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP08').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P08Val').html($('#period08Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP09').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P09Val').html($('#period09Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP10').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P10Val').html($('#period10Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP11').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P11Val').html($('#period11Alias').val() + ' <i class="fa fa-lock"></i>') }
    if ($('#LockedP12').val() == 'Y') { $('.CopyDataModalBS table.table').find('th.P12Val').html($('#period12Alias').val() + ' <i class="fa fa-lock"></i>') }
}

function DisableInActivePeriods(ModalId) {

    var classVals = [];

    classVals.push(".allocationSalaryCheck");
    classVals.push(".allocationHourCheck");
    classVals.push(".allocationHourlyRateCheck");
    classVals.push(".overtimeSalaryCheck");
    classVals.push(".overtimeSalaryRateCheck");
    classVals.push(".allocationTotal");
    classVals.push(".overtimeHourCheck");
    classVals.push(".overtimeHourlyRateCheck");
    classVals.push(".grossComp-hrFormula-div");
    classVals.push(".GrowthRateDiv");
    classVals.push(".allocationSalaryDollarCheck");

    var budInactiveM01Val = $('#BUDInactiveM01').val();
    var budInactiveM02Val = $('#BUDInactiveM02').val();
    var budInactiveM03Val = $('#BUDInactiveM03').val();
    var budInactiveM04Val = $('#BUDInactiveM04').val();
    var budInactiveM05Val = $('#BUDInactiveM05').val();
    var budInactiveM06Val = $('#BUDInactiveM06').val();
    var budInactiveM07Val = $('#BUDInactiveM07').val();
    var budInactiveM08Val = $('#BUDInactiveM08').val();
    var budInactiveM09Val = $('#BUDInactiveM09').val();
    var budInactiveM10Val = $('#BUDInactiveM10').val();
    var budInactiveM11Val = $('#BUDInactiveM11').val();
    var budInactiveM12Val = $('#BUDInactiveM12').val();
    var budInactiveM13Val = $('#BUDInactiveM13').val();

    var period01AliasVal = $('#period01Alias').val();
    var period02AliasVal = $('#period02Alias').val();
    var period03AliasVal = $('#period03Alias').val();
    var period04AliasVal = $('#period04Alias').val();
    var period05AliasVal = $('#period05Alias').val();
    var period06AliasVal = $('#period06Alias').val();
    var period07AliasVal = $('#period07Alias').val();
    var period08AliasVal = $('#period08Alias').val();
    var period09AliasVal = $('#period09Alias').val();
    var period10AliasVal = $('#period10Alias').val();
    var period11AliasVal = $('#period11Alias').val();
    var period12AliasVal = $('#period12Alias').val();
    var period13AliasVal = $('#period13Alias').val();

    for (var loopVar = 0; loopVar < classVals.length; loopVar++) {

        var divClass = ' ' + classVals[loopVar];

        var i = ($('#ShowVendor').val() == "True" ? 3 : 2)

        if (budInactiveM01Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P01"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 0) + ')').html(period01AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM02Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P02"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 1) + ')').html(period02AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM03Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P03"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 2) + ')').html(period03AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM04Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P04"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 3) + ')').html(period04AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM05Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P05"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 4) + ')').html(period05AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM06Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P06"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 5) + ')').html(period06AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM07Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P07"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 6) + ')').html(period07AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM08Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P08"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 7) + ')').html(period08AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM09Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P09"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 8) + ')').html(period09AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM10Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P10"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 9) + ')').html(period10AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM11Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P11"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr('readonly', true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 10) + ')').html(period11AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM12Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P12"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 11) + ')').html(period12AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }
        if (budInactiveM13Val == 'Y') {
            $(ModalId + divClass + ' table tbody').find('[data-Period="P13"]').removeClass('yellowBckgTxtBx').addClass('disabledByBudInactive removeBackgndColor').attr("readonly", true).attr('data-value', '0');
            $(ModalId + divClass + ' table').find('th:nth-child(' + (i + 12) + ')').html(period13AliasVal + ' <i class="fa fa-minus-circle"></i>').attr('title', 'Deactivated Period makes the Payroll Inactive');
        }

        if (budInactiveM01Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P01"]').val(0); }
        if (budInactiveM02Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P02"]').val(0); }
        if (budInactiveM03Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P03"]').val(0); }
        if (budInactiveM04Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P04"]').val(0); }
        if (budInactiveM05Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P05"]').val(0); }
        if (budInactiveM06Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P06"]').val(0); }
        if (budInactiveM07Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P07"]').val(0); }
        if (budInactiveM08Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P08"]').val(0); }
        if (budInactiveM09Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P09"]').val(0); }
        if (budInactiveM10Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P10"]').val(0); }
        if (budInactiveM11Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P11"]').val(0); }
        if (budInactiveM12Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P12"]').val(0); }
        if (budInactiveM13Val == 'Y') { $(ModalId + divClass + ' table.dollarDataTable tbody').find('[data-Period="P13"]').val(0); }
    }
}

function mapNewRowOnCopyingGrowthRate(element, currentRow, growth, decimalPlaces, isCurrentYear, growthType, growthCompoundPeriod) {
    var data = [];

    var $periods = getNumberOfPeriods();
    
    var amortizePeriod = RetailBudgetPro.Budget.turnOnBalanceSheetVal && $periods == 12 ? $(currentRow).find('.amortize-period').val() : 0;

    var firstTimeGrowth = true;

    var growthRateData = {};

    var GrowthPercent = parseFloat(($('#growthRatePopUp').find('.growthRateValue').val()));

    //if Amort = 1 then the values in PLElement and AccrualCashData(AccrualMode) is same
    if (RetailBudgetPro.Budget.turnOnBalanceSheetVal && $periods == 12 && amortizePeriod > 1) {
        var transactionMonth = parseInt($(currentRow).find('.transactionDate').text().substr(0, 2));

        data["DATValueM" + transactionMonth] = ($(currentRow).find('[data-period=P' + transactionMonth + '] input'))[0].value.replace(/,/g, "") * growth;

        var existingGrowth = RetailBudgetPro.Budget.growthRate.filter(function (v) {
            return v.PlElementUID != element.PLElementUID;
        });

        RetailBudgetPro.Budget.growthRate = existingGrowth;

        growthRateData = {
            "PlElementUID": element.PLElementUID,
            "CommentDoneOnField": "P" + transactionMonth,
            "CommentText": "Simple Growth Rate % : " + GrowthPercent
        };
        RetailBudgetPro.Budget.growthRate.push(growthRateData);
    }
    else if (growthType == 'simple') {
        data["DATValueM1"] = element.DATValueM1 * growth;
        data["DATValueM2"] = element.DATValueM2 * growth;
        data["DATValueM3"] = element.DATValueM3 * growth;
        data["DATValueM4"] = element.DATValueM4 * growth;
        data["DATValueM5"] = element.DATValueM5 * growth;
        data["DATValueM6"] = element.DATValueM6 * growth;
        data["DATValueM7"] = element.DATValueM7 * growth;
        data["DATValueM8"] = element.DATValueM8 * growth;
        data["DATValueM9"] = element.DATValueM9 * growth;
        data["DATValueM10"] = element.DATValueM10 * growth;
        data["DATValueM11"] = element.DATValueM11 * growth;
        data["DATValueM12"] = element.DATValueM12 * growth;
        if ($periods > 12)
            data["DATValueM13"] = element.DATValueM13 * growth;

        var existingGrowth = RetailBudgetPro.Budget.growthRate.filter(function (v) {
            return v.PlElementUID != element.PLElementUID;
        });

        RetailBudgetPro.Budget.growthRate = existingGrowth;

        for (var i = 1; i <= $periods; i++) {
            growthRateData = {
                "PlElementUID": element.PLElementUID,
                "CommentDoneOnField": "P" + i,
                "CommentText": "Simple Growth Rate % : " + GrowthPercent
            };
            RetailBudgetPro.Budget.growthRate.push(growthRateData);
        }
        
    } else {
        var dataValues = [element.DATValueM1, element.DATValueM2, element.DATValueM3, element.DATValueM4, element.DATValueM5, element.DATValueM6,
        element.DATValueM7, element.DATValueM8, element.DATValueM9, element.DATValueM10, element.DATValueM11, element.DATValueM12, element.DATValueM13
        ];

        var periodVal = parseInt(growthCompoundPeriod.replace(/\D/g, ''));

        for (var i = 1; i <= $periods; i++) {
            if (i < periodVal) data["DATValueM" + i] = dataValues[i - 1];
            else {
                data["DATValueM" + i] = dataValues[periodVal - 1] * Math.pow(growth, i + 1 - periodVal);
            }
        }

        var periodName = $('#period' + ('0' + periodVal.toString().slice(-2)) + 'Alias').val();

        var existingGrowth = RetailBudgetPro.Budget.growthRate.filter(function (v) {
            return v.PlElementUID != element.PLElementUID;
        });

        RetailBudgetPro.Budget.growthRate = existingGrowth;

        for (var i = periodVal; i <= $periods; i++) {
            growthRateData = {
                "PlElementUID": element.PLElementUID,
                "CommentDoneOnField": "P" + i,
                "CommentText": "Compound Growth Rate % : " + GrowthPercent + " (" + periodName + ")"
            };
            RetailBudgetPro.Budget.growthRate.push(growthRateData);
        }
    }

    data["DATNetSalesM1"] = element.DATNetSalesM1;
    data["DATNetSalesM2"] = element.DATNetSalesM2;
    data["DATNetSalesM3"] = element.DATNetSalesM3;
    data["DATNetSalesM4"] = element.DATNetSalesM4;
    data["DATNetSalesM5"] = element.DATNetSalesM5;
    data["DATNetSalesM6"] = element.DATNetSalesM6;
    data["DATNetSalesM7"] = element.DATNetSalesM7;
    data["DATNetSalesM8"] = element.DATNetSalesM8;
    data["DATNetSalesM9"] = element.DATNetSalesM9;
    data["DATNetSalesM10"] = element.DATNetSalesM10;
    data["DATNetSalesM11"] = element.DATNetSalesM11;
    data["DATNetSalesM12"] = element.DATNetSalesM12;
    if ($periods > 12)
        data["DATNetSalesM13"] = element.DATNetSalesM13;
    data["DATModifiedDate"] = element.DATModifiedDate;


    data["TotalLY"] = element.TotalLY;
    data["TotalLLY"] = element.TotalLLY;

    data["DATValueM1P"] = data["DATNetSalesM1"] != 0 ? 100 * data["DATValueM1"] / data["DATNetSalesM1"] : 0;
    data["DATValueM2P"] = data["DATNetSalesM2"] != 0 ? 100 * data["DATValueM2"] / data["DATNetSalesM2"] : 0;
    data["DATValueM3P"] = data["DATNetSalesM3"] != 0 ? 100 * data["DATValueM3"] / data["DATNetSalesM3"] : 0;
    data["DATValueM4P"] = data["DATNetSalesM4"] != 0 ? 100 * data["DATValueM4"] / data["DATNetSalesM4"] : 0;
    data["DATValueM5P"] = data["DATNetSalesM5"] != 0 ? 100 * data["DATValueM5"] / data["DATNetSalesM5"] : 0;
    data["DATValueM6P"] = data["DATNetSalesM6"] != 0 ? 100 * data["DATValueM6"] / data["DATNetSalesM6"] : 0;
    data["DATValueM7P"] = data["DATNetSalesM7"] != 0 ? 100 * data["DATValueM7"] / data["DATNetSalesM7"] : 0;
    data["DATValueM8P"] = data["DATNetSalesM8"] != 0 ? 100 * data["DATValueM8"] / data["DATNetSalesM8"] : 0;
    data["DATValueM9P"] = data["DATNetSalesM9"] != 0 ? 100 * data["DATValueM9"] / data["DATNetSalesM9"] : 0;
    data["DATValueM10P"] = data["DATNetSalesM10"] != 0 ? 100 * data["DATValueM10"] / data["DATNetSalesM10"] : 0;
    data["DATValueM11P"] = data["DATNetSalesM11"] != 0 ? 100 * data["DATValueM11"] / data["DATNetSalesM11"] : 0;
    data["DATValueM12P"] = data["DATNetSalesM12"] != 0 ? 100 * data["DATValueM12"] / data["DATNetSalesM12"] : 0;
    if ($periods > 12)
        data["DATValueM13P"] = data["DATNetSalesM13"] != 0 ? 100 * data["DATValueM13"] / data["DATNetSalesM13"] : 0;


    var level = currentRow.data('level');
    var finalHtml = "";
    if (!isCurrentYear) {

        var html = getNewRow(currentRow, level);
        finalHtml = $(html).insertAfter($($(currentRow).prevAll('.expanded')[0]).next('tr').next('tr'));
        if (finalHtml.find("[name='VendorUID']").length > 0) {
            finalHtml.find("[name='VendorUID']").SumoSelect({ selectAll: true, search: true, searchText: 'Search', optWrapperCstmWidthToAuto: true });
        }
        // finalHtml.removeClass('tempHideBottomLevel');
    }
    else {
        finalHtml = currentRow;
        finalHtml.find('.total').val('0');
    }

    $(finalHtml).find('td.DATValueM1F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM1).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM2F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM2).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM3F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM3).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM4F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM4).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM5F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM5).toFixed(decimalPlaces)).toLocaleString("en"));

    $(finalHtml).find('td.DATValueM6F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM6).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM7F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM7).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM8F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM8).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM9F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM9).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM10F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM10).toFixed(decimalPlaces)).toLocaleString("en"));


    $(finalHtml).find('td.DATValueM11F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM11).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM12F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM12).toFixed(decimalPlaces)).toLocaleString("en"));
    if ($periods > 12)
        $(finalHtml).find('td.DATValueM13F').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM13).toFixed(decimalPlaces)).toLocaleString("en"));


    $(finalHtml).find('td.DATValueM1PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM1P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM2PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM2P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM3PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM3P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM4PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM4P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM5PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM5P).toFixed(decimalPlaces)).toLocaleString("en"));

    $(finalHtml).find('td.DATValueM6PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM6P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM7PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM7P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM8PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM8P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM9PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM9P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM10PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM10P).toFixed(decimalPlaces)).toLocaleString("en"));


    $(finalHtml).find('td.DATValueM11PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM11P).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.DATValueM12PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM12P).toFixed(decimalPlaces)).toLocaleString("en"));
    if ($periods > 12)
        $(finalHtml).find('td.DATValueM13PF').find('input:not(.inactive)').val(Number(ConvertCurrencyStringToDecimal(data.DATValueM13P).toFixed(decimalPlaces)).toLocaleString("en"));

    $(finalHtml).find('td.percentLYF').html(Number(ConvertCurrencyStringToDecimal(data.TotalLY).toFixed(decimalPlaces)).toLocaleString("en"));
    $(finalHtml).find('td.percentLLYF').html(Number(ConvertCurrencyStringToDecimal(data.TotalLLY).toFixed(decimalPlaces)).toLocaleString("en"));


    // Added by ankit
    finalHtml.find('.total').val('');
    finalHtml.find('.percentLYF').html('');
    finalHtml.find('.percentLLYF').html('');
}

// Function used to create a new row.
// Function contains a new row template
function getNewRow(parentRow, datalevel) {

    // var datalevel = parentRow.data('level');
    var classVal = " temp bottomLevel showyear contracted ";
    //  var classVal = " temp bottomLevel contracted ";
    var guid = RetailBudgetPro.Budget.guid();
    var year = parentRow.find('.year').html();
    var storeID = parentRow.find('#hdnStoreUID').text();
    var deptID = parentRow.find('#hdnDeptUID').text();
    var catID = parentRow.find('#hdnCatUID').text();
    var isCashFlowThrough = parentRow.find('#hdnIsCashFlowThrough').text();
    var catTypeRE = parentRow.find('#hdnCATTypeRE').text();
    var isDepreicationExpense = parentRow.find('#hdnIsDepreciationExpense').text();
    var decimalPlaces = parentRow.find('#hdnDecimalPlaces').text();
    var isFOA = parentRow.find('#hdnIsFOA').text();
    var comment = parentRow.find('#hdnComment').text();
    var periods = getNumberOfPeriods();
    var fromExcel = parentRow.find('#hdnFromExcel').text();
    var excelRowNum = parentRow.find('#hdnExcelRowNum').text();
    var classForLLY = $('#hdnShowHideLLY').val() == "False" ? "hide" : "";
    var subCategoryExcelPopUpIcon = $(document).find('#hdnUserInApproveBudget').val() == "True" ? "<a href='#' data-target='#subCatExcelUploadPopUp' data-toggle='modal' class='upload-excel' title='Upload excel'><i class='fa fa-file-excel-o'></i></a>" : "";
    //var subCategoryExcelPopUpIcon = (RetailBudgetPro.Budget.isUserInEditDataPageRole == "True" && RetailBudgetPro.Budget.isUserInApproveBudget == "True") ? "<a href='#' data-target='#subCatExcelUploadPopUp' data-toggle='modal' class='upload-excel' title='Upload excel4'><i class='fa fa-file-excel-o'></i></a>" : ""; //For branch BD-1122
    var cloneDropdownVendor = $('#vendordd').clone();

    var catOption = $('[name=groupedcategory] option.clsCategory[value$="|' + catID + '"]');
    var isCapex = catOption.data('iscapex');
    var isBalanceSheet = catOption.data('isbalancesheet');

    var showBSColumns = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && periods == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True");
    var modifyPeriodsWidthClass = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && periods == 12) ? "modifyPeriodWidth" : "";
    var startMonthOfFiscalYear = $('[name=StartMonthOfFiscalYear]').val();
    var currentYear = $('#hdnBudgetYear').val() - (startMonthOfFiscalYear == 1 ? 0 : 1);

    var $parentRow = parentRow.siblings('tr:not(.temp)');

    var $pRow = $parentRow.find('#hdnStoreUID:contains("' + storeID + '")').parents('tr');

    var period01AliasVal = $('#period01Alias').val();
    var period02AliasVal = $('#period02Alias').val();
    var period03AliasVal = $('#period03Alias').val();
    var period04AliasVal = $('#period04Alias').val();
    var period05AliasVal = $('#period05Alias').val();
    var period06AliasVal = $('#period06Alias').val();
    var period07AliasVal = $('#period07Alias').val();
    var period08AliasVal = $('#period08Alias').val();
    var period09AliasVal = $('#period09Alias').val();
    var period10AliasVal = $('#period10Alias').val();
    var period11AliasVal = $('#period11Alias').val();
    var period12AliasVal = $('#period12Alias').val();
    var period13AliasVal = $('#period13Alias').val();

    var hdnPeriodReDistributionValueVal = $('#hdnPeriodReDistributionValue').val();

    var STCCompM1 = $pRow.find('#STCCompM1').eq(0).text();
    var STCCompM2 = $pRow.find('#STCCompM2').eq(0).text();
    var STCCompM3 = $pRow.find('#STCCompM3').eq(0).text();
    var STCCompM4 = $pRow.find('#STCCompM4').eq(0).text();
    var STCCompM5 = $pRow.find('#STCCompM5').eq(0).text();
    var STCCompM6 = $pRow.find('#STCCompM6').eq(0).text();
    var STCCompM7 = $pRow.find('#STCCompM7').eq(0).text();
    var STCCompM8 = $pRow.find('#STCCompM8').eq(0).text();
    var STCCompM9 = $pRow.find('#STCCompM9').eq(0).text();
    var STCCompM10 = $pRow.find('#STCCompM10').eq(0).text();
    var STCCompM11 = $pRow.find('#STCCompM11').eq(0).text();
    var STCCompM12 = $pRow.find('#STCCompM12').eq(0).text();
    var STCCompM13 = $pRow.find('#STCCompM13').eq(0).text();

    $(cloneDropdownVendor).find('option:contains("Blank")[value=-1], :contains("Any")[value=-2]').remove();

    $(cloneDropdownVendor).find('option').prop('selected', false).removeAttrs('selected disabled');

    //var currencyDD = $('#subCategoryCurrencyDD').html() == undefined ? parentRow.nextAll('tr.bottomLevel').eq(0).find('td [name="subCategoryCurrencyDD"]') : $('#subCategoryCurrencyDD').html();
    var currencyDD = parentRow.nextAll('tr.bottomLevel').eq(0).find('td [name="subCategoryCurrencyDD"]').html();

    var termDD = $('[name="DatapageTermdd"]').html();
    
    var vendorDD = "";

    var $vendDatapageDD = $('[name="datapageVendordd"]');

    if ($vendDatapageDD.find('option:not([value=-1]):not([value=-2])').length >= parseInt($('#VendorCountThreshold').val())) {
        if ($vendDatapageDD.find('option:not([value=-1]):not([value=-2]):selected').length == 1) {
            vendorDD = $vendDatapageDD.find('option:not([value=-1]):not([value=-2]):selected').removeAttr('disabled').attr('selected', 'selected').prop('outerHTML');
        }
        else {
            vendorDD = "";
        }        
    }
    else {
        if ($vendDatapageDD.find('option:not([value=-1]):not([value=-2]):selected').length == 1) {
            $(cloneDropdownVendor).find('option[value="' + $vendDatapageDD.val() + '"]').attr('selected', 'selected');
        }
        
        vendorDD = $(cloneDropdownVendor).html();
    }

    if (periods > 12) {
        var html = "<tr data-level=" + datalevel + " class='" + classVal + " l" + datalevel + " level" + datalevel + "' id='" + guid + "'>" +
             "            <td class=''><div class='control'>  <div class='line level1'><div class='vert'></div><div class='horz'></div></div>  <div class='line level2'><div class='vert'></div><div class='horz'></div></div>  <div class='line level3'><div class='vert'></div><div class='horz'></div></div>  <div class='line level4'><div class='vert'></div><div class='horz'></div></div> </div>  <div class='label'>" +
             "               <input type=checkbox class=selectRowToDelete hideCol value='' />" +
             "                <input type='text' value='' class='bottomLevelText isDescription'>" +
             "                <span class='hideCol'></span>" +
            "            </div>" + subCategoryExcelPopUpIcon + "</td>" +
             "            <td class=''>" +
             "                <div class='doNotExpand showCol year'>" + year + "</div>" +
             "            </td>";
        if ($('#ShowVendor').val() == "True") {
            html += "<td class='vendorLst showVendorInTitle'>" +
            "         <span class='vendor' style='display: none;'></span>" +
            "           <div class='ven-list'>" +
            "               <select class='form-control multiselectLst isVendor bottomLevelText drpdwnvendor' multiple='multiple' name='VendorUID'>" + vendorDD + "</select>" +
            "           </div>" +
            (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? "" : "<a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
            "           <input type='hidden' value='' class='hdnVendorID hideCol'>" +
            "        </td>";
        }
        else {
            html += "<td class='vendorLst showVendorInTitle vendor-wrap'>" +
            "            <input type='text' value='' class='bottomLevelText isVendor'>" +
            (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? "" : "<span class='hideCol'></span><a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
            "            <input type='hidden' value='' class='hdnVendorID hideCol'>" +
            "        </td>";
        }

        if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
            if ($('[name="groupedcategory"] option[value$="|' + catID + '"]').data('isfinancialcat') == "False") {
                html += "<td class='currencyLst showCurrencyInTitle'>" +
                    "<span class='currency hide'></span>" +
                    "<input type='hidden' value='-1' name='subCategoryCurrencyDD' id='subCategoryCurrencyDD'>" +
                    "<a href='#' class='copyValues' title='Copy first active period values to all periods'> <i class='fa fa-sort-up'></i></a > " +
                "</td > "
            }
            else {
                html += "<td class='currencyLst showCurrencyInTitle'>" +
                    "    <span class='currency hide'></span>" +
                    "    <div class='currencyDD'>" +
                    "          <select class='form-control' name = 'subCategoryCurrencyDD' id = 'subCategoryCurrencyDD' >" +
                                    currencyDD +
                    "          </select>"
                    "     </div>" +
                    "     <a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>" +
                    "         </td>";
            }
            

        }

        html += "<td class='data rightAlign DATValueM1F " + modifyPeriodsWidthClass + "' title='" + period01AliasVal + "' data-Period = 'P1'>" +
            "                <input type='text' value='0' title='" + period01AliasVal + "' data-Period = 'P1' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM1F' " + (STCCompM1 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P01 " + (STCCompM1 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM2F " + modifyPeriodsWidthClass + "' title='" + period02AliasVal + "' data-Period = 'P2'>" +
            "                <input type='text' value='0' title='" + period02AliasVal + "' data-Period = 'P2' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM2F' " + (STCCompM2 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P02 " + (STCCompM2 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM3F " + modifyPeriodsWidthClass + "' title='" + period03AliasVal + "' data-Period = 'P3'>" +
            "                <input type='text' value='0' title='" + period03AliasVal + "' data-Period = 'P3' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM3F' " + (STCCompM3 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P03 " + (STCCompM3 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM4F " + modifyPeriodsWidthClass + "' title='" + period04AliasVal + "' data-Period = 'P4'>" +
            "                <input type='text' value='0' title='" + period04AliasVal + "' data-Period = 'P4' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM4F' " + (STCCompM4 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P04 " + (STCCompM4 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM5F " + modifyPeriodsWidthClass + "' title='" + period05AliasVal + "' data-Period = 'P5'>" +
            "                <input type='text' value='0' title='" + period05AliasVal + "' data-Period = 'P5' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM5F' " + (STCCompM5 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P05 " + (STCCompM5 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM6F " + modifyPeriodsWidthClass + "' title='" + period06AliasVal + "' data-Period = 'P6'>" +
            "                <input type='text' value='0' title='" + period06AliasVal + "' data-Period = 'P6' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM6F' " + (STCCompM6 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P06 " + (STCCompM6 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM7F " + modifyPeriodsWidthClass + "' title='" + period07AliasVal + "' data-Period = 'P7'>" +
            "                <input type='text' value='0' title='" + period07AliasVal + "' data-Period = 'P7' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM7F' " + (STCCompM7 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P07 " + (STCCompM7 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM8F " + modifyPeriodsWidthClass + "' title='" + period08AliasVal + "' data-Period = 'P8'>" +
            "                <input type='text' value='0' title='" + period08AliasVal + "' data-Period = 'P8' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM8F' " + (STCCompM8 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P08 " + (STCCompM8 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM9F " + modifyPeriodsWidthClass + "' title='" + period09AliasVal + "' data-Period = 'P9'>" +
            "                <input type='text' value='0' title='" + period09AliasVal + "' data-Period = 'P9' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM9F' " + (STCCompM9 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P09 " + (STCCompM9 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM10F " + modifyPeriodsWidthClass + "' title='" + period10AliasVal + "' data-Period = 'P10'>" +
            "                <input type='text' value='0' title='" + period10AliasVal + "' data-Period = 'P10' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM10F' " + (STCCompM10 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P10 " + (STCCompM10 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM11F " + modifyPeriodsWidthClass + "' title='" + period11AliasVal + "' data-Period = 'P11'>" +
            "                <input type='text' value='0' title='" + period11AliasVal + "' data-Period = 'P11' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM11F' " + (STCCompM11 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P11 " + (STCCompM11 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM12F " + modifyPeriodsWidthClass + "' title='" + period12AliasVal + "' data-Period = 'P12'>" +
            "                <input type='text' value='0' title='" + period12AliasVal + "' data-Period = 'P12' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM12F' " + (STCCompM12 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P12 " + (STCCompM12 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueM13F " + modifyPeriodsWidthClass + "' title='" + period13AliasVal + "' data-Period = 'P13'>" +
            "                <input type='text' value='0' title='" + period13AliasVal + "' data-Period = 'P13' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM13F' " + (STCCompM13 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P13 " + (STCCompM13 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='data rightAlign DATValueTotalF " + modifyPeriodsWidthClass + "' title='Total'>" +
            "                <input type='text' value='0' title='Total' class='bottomLevelText total'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM1PF' style='display: none;' title='" + period01AliasVal + "' data-Period = 'P1'>" +
            "                <input type='text' value='0' title='" + period01AliasVal + "' data-Period = 'P1' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM1PF' " + (STCCompM1 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P01 " + (STCCompM1 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM2PF' style='display: none;' title='" + period02AliasVal + "' data-Period = 'P2'>" +
            "                <input type='text' value='0' title='" + period02AliasVal + "' data-Period = 'P2' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM2PF' " + (STCCompM2 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P02 " + (STCCompM2 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM3PF' style='display: none;' title='" + period03AliasVal + "' data-Period = 'P3'>" +
            "                <input type='text' value='0' title='" + period03AliasVal + "' data-Period = 'P3' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM3PF' " + (STCCompM3 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P03 " + (STCCompM3 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM4PF' style='display: none;' title='" + period04AliasVal + "' data-Period = 'P4'>" +
            "                <input type='text' value='0' title='" + period04AliasVal + "' data-Period = 'P4' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM4PF' " + (STCCompM4 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P04 " + (STCCompM4 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM5PF' style='display: none;' title='" + period05AliasVal + "' data-Period = 'P5'>" +
            "                <input type='text' value='0' title='" + period05AliasVal + "' data-Period = 'P5' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM5PF' " + (STCCompM5 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P05 " + (STCCompM5 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM6PF' style='display: none;' title='" + period06AliasVal + "' data-Period = 'P6'>" +
            "                <input type='text' value='0' title='" + period06AliasVal + "' data-Period = 'P6' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM6PF' " + (STCCompM6 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P06 " + (STCCompM6 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM7PF' style='display: none;' title='" + period07AliasVal + "' data-Period = 'P7'>" +
            "                <input type='text' value='0' title='" + period07AliasVal + "' data-Period = 'P7' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM7PF' " + (STCCompM7 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P07 " + (STCCompM7 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM8PF' style='display: none;' title='" + period08AliasVal + "' data-Period = 'P8'>" +
            "                <input type='text' value='0' title='" + period08AliasVal + "' data-Period = 'P8' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM8PF' " + (STCCompM8 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P08 " + (STCCompM8 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM9PF' style='display: none;' title='" + period09AliasVal + "' data-Period = 'P9'>" +
            "                <input type='text' value='0' title='" + period09AliasVal + "' data-Period = 'P9' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM9PF' " + (STCCompM9 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P09 " + (STCCompM9 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM10PF' style='display: none;' title='" + period10AliasVal + "' data-Period = 'P10'>" +
            "                <input type='text' value='0' title='" + period10AliasVal + "' data-Period = 'P10' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM10PF' " + (STCCompM10 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P10 " + (STCCompM10 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM11PF' style='display: none;' title='" + period11AliasVal + "' data-Period = 'P11'>" +
            "                <input type='text' value='0' title='" + period11AliasVal + "' data-Period = 'P11' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM11PF' " + (STCCompM11 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P11 " + (STCCompM11 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM12PF' style='display: none;' title='" + period12AliasVal + "' data-Period = 'P12'>" +
            "                <input type='text' value='0' title='" + period12AliasVal + "' data-Period = 'P12' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM12PF' " + (STCCompM12 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P12 " + (STCCompM12 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueM13PF' style='display: none;' title='" + period13AliasVal + "' data-Period = 'P13'>" +
            "                <input type='text' value='0' title='" + period13AliasVal + "' data-Period = 'P13' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM13PF' " + (STCCompM13 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P13 " + (STCCompM13 == 'N' ? 'inactive' : 'active') +  "'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='percentage rightAlign DATValueTotalPF' style='display: none;' title='Total'>" +
            "                <input type='text' value='0' title='Total' class='bottomLevelText'>" +
            "                <span class='hideCol'>0</span>" +
            "            </td>" +
            "            <td class='bold rightAlign percentLYF' title='%LY'></td>" +
            "            <td class='bold rightAlign percentLLYF " + classForLLY + "' title='%LLY'></td>" +
            "            <td class='action-btn'><div class='function-btn'><a href='#' class='distributeTotalEven' title='Spread the Total amount evenly to all periods'>=</a><a href='#' class='distributeTotalPercent' title='Spread the Total amount for all periods based on Current Year percentages'>%</a><a data-target='#growthRatePopUp' data-toggle='modal' class='growthRate' title='Copy to current year with growth %'><i class='fa fa-angle-up'></i></a><a data-target='#static' data-toggle='modal' class='bottomLevelCategoryComment' title='Insert Notes'><i class='fa fa-pencil-square-o'></i></a><a href='javascript:void(0)' class='documentUpload' title='Upload a document'><i class='fa fa-file'></i></a><input type='file' class='documentFile' accept='.pdf,.doc,.docx,.xls,.xlsx' style='display: none;'></input></div></td>" +
            //"            <td class='selectRowToDelete'>" +
            //"                <input type='checkbox' value='' class=''></td>" +
            //"            <td></td>" +
            "            <td style='display: none' id='hdnStoreUID'>" + storeID + "</td>" +
            "            <td style='display: none' id='hdnDeptUID'>" + deptID + "</td>" +
            "            <td style='display: none' id='hdnCatUID'>" + catID + "</td>" +
            "            <td style='display: none' id='hdnVendorUID'>" + 0 + "</td>" +
            "            <td style='display: none' id='hdnPLElementUID'>" + -1 + "</td>" +
            "            <td style='display: none' id='hdnDecimalPlaces'>" + decimalPlaces + "</td>" +
            "            <td style='display: none' id='hdnIsFOA'>" + isFOA + "</td>" +
            "            <td style='display: none;' id='hdnComment'>" + comment + "</td>" +
            "            <td style='display: none;' id='hdnFromExcel'>" + fromExcel + "</td>" +
            "            <td style='display: none;' id='hdnExcelRowNum'>" + excelRowNum + "</td>" +
            "            <td style='display: none;' id='hdnCurrentComment'></td>" +
            "            <td style='display: none;' id='hdnAttachedSubCategoryFolderName' data-attachedfolder=''></td>" +
            "            </tr>";
    }
    else {
        var html = "<tr data-level=" + datalevel + " class='" + classVal + " l" + datalevel + " level" + datalevel + "' id='" + guid + "'>" +
          "            <td class=''><div class='control'>  <div class='line level1'><div class='vert'></div><div class='horz'></div></div>  <div class='line level2'><div class='vert'></div><div class='horz'></div></div>  <div class='line level3'><div class='vert'></div><div class='horz'></div></div>  <div class='line level4'><div class='vert'></div><div class='horz'></div></div> </div>  <div class='label'>" +
          "               <input type=checkbox class=selectRowToDelete hideCol value='' />" +
          "                <input type='text' value='' class='bottomLevelText isDescription'>" +
          "                <span class='hideCol'></span>" +
            "            </div>" + subCategoryExcelPopUpIcon + "</td>" +
          "            <td class=''>" +
          "                <div class='doNotExpand showCol year'>" + year + "</div>" +
          "            </td>";
        if ($('#ShowVendor').val() == "True") {
            html += "<td class='vendorLst showVendorInTitle'>" +
              "         <span class='vendor' style='display: none;'></span>" +
              "         <div class='ven-list'>" +
              "             <select class='form-control multiselectLst isVendor bottomLevelText drpdwnvendor' multiple='multiple' name='VendorUID'>" + vendorDD + "</select>" +
              "         </div>" +
                (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" || showBSColumns ? "" : " <a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
              
              "         <input type='hidden' value='' class='hdnVendorID hideCol'>" +
              "      </td>";
        }
        else {
            html += "<td class='vendorLst showVendorInTitle vendor-wrap'>" +
            "            <input type='text' value='' class='bottomLevelText isVendor'>" +
            (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" || showBSColumns ? "" : "<span class='hideCol'></span><a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
            "            <input type='hidden' value='' class='hdnVendorID hideCol'>" +
            "        </td>";
        }

        if (showBSColumns) {

            html += "<td class='dateLst showDateInTitle centerAlign isDayOfPeriod'>" +
                "       <div class='transactionDateDiv hide'>" + 
                "          <a href='javascript:void(0)' class='openTransactionPopup transactionDate' title='Transaction date' data-date='" + ("0" + startMonthOfFiscalYear).slice(-2) + "/15/" + currentYear + "'>" + ("0" + startMonthOfFiscalYear).slice(-2) + "/15/" + currentYear + "</a>" +
                "          <span class='transactionSpan hide' data-value='" + ("0" + startMonthOfFiscalYear).slice(-2) + "/15/" + currentYear + "'></span>" +
                "       </div>" + 
                "       <div class='dayOfPeriodDiv'>" + 
                "          <a href='javascript:void(0)' class='openTransactionPopup dayOfPeriod' title='Day of period' data-day='15'>15th</a>" + 
                "           <span class='transactionSpan hide' data-value='15'>15th</span>" + 
                "       </div>" + 
                "    </td>";

            if (isCashFlowThrough == "False" && catTypeRE != "C" && isDepreicationExpense == "False") {
                html += "<td class='termLst showTermInTitle centerAlign'>" +
                    "         <span class='termtd hide'></span>" +
                    "           <div class='termDD'>" +
                    "               <select class='form-control select2me' name='subCategoryTermDD'>" + termDD + "</select>" +
                    "           </div>" +
                    "        </td>";

                html += "<td class='amortizePeriodLst showAmortizePeriodInTitle vendor-wrap centerAlign'>";

                if (isCapex == "False" && isBalanceSheet == "True") {
                    html += "<input type='text' value='1' class='amortize-period bottomLevelText editPeriod hideCol'>" +
                        "       <span data-value='1'>1</span> ";
                }
                else {
                    html += "<input type='text' value='1' class='amortize-period bottomLevelText editPeriod'>" +
                        "       <span data-value='1' class='hideCol'>1</span> ";
                }

                html += (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? "" : "<a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
                    "        </td>";
            }
            else {
                html += "<td class='termLst showTermInTitle centerAlign'>" +
                    "         <span class='termtd'>N/A</span>" +
                    "           <div class='termDD hide'>" +
                    "               <select class='form-control select2me' name='subCategoryTermDD'>" + termDD + "</select>" +
                    "           </div>" +
                    "        </td>";

                html += "<td class='amortizePeriodLst showAmortizePeriodInTitle vendor-wrap centerAlign'>" 

                if (isCashFlowThrough == "True" || (isCapex == "False" && isBalanceSheet == "True")) {
                    html += "<input type='text' value='1' class='amortize-period bottomLevelText editPeriod hideCol'>" +
                        "       <span data-value='1'>1</span> "
                }
                else {
                    html += "<input type='text' value='1' class='amortize-period bottomLevelText editPeriod'>" +
                        "       <span data-value='1' class='hideCol'>1</span> "
                }
                

                html += (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? "" : "<a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>") +
                    "        </td>";
            }
        }

        if (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True") {
            if ($('[name="groupedcategory"] option[value$="|' + catID + '"]').data('isfinancialcat') == "False") {
                html += "<td class='currencyLst showCurrencyInTitle'>" +
                    "<span class='currency hide'></span>" +
                    "<input type='hidden' value='-1' name='subCategoryCurrencyDD' id='subCategoryCurrencyDD'>" +
                    "<a href='#' class='copyValues' title='Copy first active period values to all periods'> <i class='fa fa-sort-up'></i></a > " +
                    "</td> ";
            }
            else {
                html += "<td class='currencyLst showCurrencyInTitle'>" +
                    "    <span class='currency hide'></span>" +
                    "    <div class='currencyDD'>" +
                    "          <select class='form-control' name = 'subCategoryCurrencyDD' id = 'subCategoryCurrencyDD' >" +
                    currencyDD +
                    "          </select>" +
                    "     </div>" +
                    "     <a href='#' class='copyValues' title='Copy first active period values to all periods'><i class='fa fa-sort-up'></i></a>" +
                    "         </td>";
            }
        }

        html += "            <td class='data rightAlign DATValueM1F " + modifyPeriodsWidthClass + "' title='" + period01AliasVal + "' data-Period = 'P1'>" +
        "                <input type='text' value='0' title='" + period01AliasVal + "' data-Period = 'P1' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM1F' " + (STCCompM1 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P01 " + (STCCompM1 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM2F " + modifyPeriodsWidthClass + "' title='" + period02AliasVal + "' data-Period = 'P2'>" +
        "                <input type='text' value='0' title='" + period02AliasVal + "' data-Period = 'P2' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM2F' " + (STCCompM2 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P02 " + (STCCompM2 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM3F " + modifyPeriodsWidthClass + "' title='" + period03AliasVal + "' data-Period = 'P3'>" +
        "                <input type='text' value='0' title='" + period03AliasVal + "' data-Period = 'P3' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM3F' " + (STCCompM3 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P03 " + (STCCompM3 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM4F " + modifyPeriodsWidthClass + "' title='" + period04AliasVal + "' data-Period = 'P4'>" +
        "                <input type='text' value='0' title='" + period04AliasVal + "' data-Period = 'P4' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM4F' " + (STCCompM4 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P04 " + (STCCompM4 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM5F " + modifyPeriodsWidthClass + "' title='" + period05AliasVal + "' data-Period = 'P5'>" +
        "                <input type='text' value='0' title='" + period05AliasVal + "' data-Period = 'P5' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM5F' " + (STCCompM5 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P05 " + (STCCompM5 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM6F " + modifyPeriodsWidthClass + "' title='" + period06AliasVal + "' data-Period = 'P6'>" +
        "                <input type='text' value='0' title='" + period06AliasVal + "' data-Period = 'P6' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM6F' " + (STCCompM6 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P06 " + (STCCompM6 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM7F " + modifyPeriodsWidthClass + "' title='" + period07AliasVal + "' data-Period = 'P7'>" +
        "                <input type='text' value='0' title='" + period07AliasVal + "' data-Period = 'P7' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM7F' " + (STCCompM7 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P07 " + (STCCompM7 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM8F " + modifyPeriodsWidthClass + "' title='" + period08AliasVal + "' data-Period = 'P8'>" +
        "                <input type='text' value='0' title='" + period08AliasVal + "' data-Period = 'P8' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM8F' " + (STCCompM8 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P08 " + (STCCompM8 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM9F " + modifyPeriodsWidthClass + "' title='" + period09AliasVal + "' data-Period = 'P9'>" +
        "                <input type='text' value='0' title='" + period09AliasVal + "' data-Period = 'P9' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM9F' " + (STCCompM9 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P09 " + (STCCompM9 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM10F " + modifyPeriodsWidthClass + "' title='" + period10AliasVal + "' data-Period = 'P10'>" +
        "                <input type='text' value='0' title='" + period10AliasVal + "' data-Period = 'P10' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM10F' " + (STCCompM10 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P10 " + (STCCompM10 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM11F " + modifyPeriodsWidthClass + "' title='" + period11AliasVal + "' data-Period = 'P11'>" +
        "                <input type='text' value='0' title='" + period11AliasVal + "' data-Period = 'P11' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM11F' " + (STCCompM11 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P11 " + (STCCompM11 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueM12F " + modifyPeriodsWidthClass + "' title='" + period12AliasVal + "' data-Period = 'P12'>" +
        "                <input type='text' value='0' title='" + period12AliasVal + "' data-Period = 'P12' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM12F' " + (STCCompM12 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P12 " + (STCCompM12 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='data rightAlign DATValueTotalF " + modifyPeriodsWidthClass + "' title='Total'>" +
        "                <input type='text' value='0' title='Total' class='bottomLevelText total'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM1PF' style='display: none;' title='" + period01AliasVal + "' data-Period = 'P1'>" +
        "                <input type='text' value='0' title='" + period01AliasVal + "' data-Period = 'P1' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM1PF' " + (STCCompM1 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P01 " + (STCCompM1 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM2PF' style='display: none;' title='" + period02AliasVal + "' data-Period = 'P2'>" +
        "                <input type='text' value='0' title='" + period02AliasVal + "' data-Period = 'P2' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM2PF' " + (STCCompM2 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P02 " + (STCCompM2 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM3PF' style='display: none;' title='" + period03AliasVal + "' data-Period = 'P3'>" +
        "                <input type='text' value='0' title='" + period03AliasVal + "' data-Period = 'P3' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM3PF' " + (STCCompM3 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P03 " + (STCCompM3 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM4PF' style='display: none;' title='" + period04AliasVal + "' data-Period = 'P4'>" +
        "                <input type='text' value='0' title='" + period04AliasVal + "' data-Period = 'P4' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM4PF' " + (STCCompM4 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P04 " + (STCCompM4 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM5PF' style='display: none;' title='" + period05AliasVal + "' data-Period = 'P5'>" +
        "                <input type='text' value='0' title='" + period05AliasVal + "' data-Period = 'P5' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM5PF' " + (STCCompM5 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P05 " + (STCCompM5 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM6PF' style='display: none;' title='" + period06AliasVal + "' data-Period = 'P6'>" +
        "                <input type='text' value='0' title='" + period06AliasVal + "' data-Period = 'P6' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM6PF' " + (STCCompM6 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P06 " + (STCCompM6 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM7PF' style='display: none;' title='" + period07AliasVal + "' data-Period = 'P7'>" +
        "                <input type='text' value='0' title='" + period07AliasVal + "' data-Period = 'P7' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM7PF' " + (STCCompM7 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P07 " + (STCCompM7 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM8PF' style='display: none;' title='" + period08AliasVal + "' data-Period = 'P8'>" +
        "                <input type='text' value='0' title='" + period08AliasVal + "' data-Period = 'P8' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM8PF' " + (STCCompM8 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P08 " + (STCCompM8 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM9PF' style='display: none;' title='" + period09AliasVal + "' data-Period = 'P9'>" +
        "                <input type='text' value='0' title='" + period09AliasVal + "' data-Period = 'P9' data-DecimalPlaces = '" + decimalPlaces + "'  name='DATValueM9PF' " + (STCCompM9 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P09 " + (STCCompM9 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM10PF' style='display: none;' title='" + period10AliasVal + "' data-Period = 'P10'>" +
        "                <input type='text' value='0' title='" + period10AliasVal + "' data-Period = 'P10'data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM10PF' " + (STCCompM10 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P10 " + (STCCompM10 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM11PF' style='display: none;' title='" + period11AliasVal + "' data-Period = 'P11'>" +
        "                <input type='text' value='0' title='" + period11AliasVal + "' data-Period = 'P11' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM11PF' " + (STCCompM11 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P11 " + (STCCompM11 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueM12PF' style='display: none;' title='" + period12AliasVal + "' data-Period = 'P12'>" +
        "                <input type='text' value='0' title='" + period12AliasVal + "' data-Period = 'P12' data-DecimalPlaces = '" + decimalPlaces + "' name='DATValueM12PF' " + (STCCompM12 == 'N' ? 'readonly=readonly' : '') + " class='bottomLevelText editPeriod P12 " + (STCCompM12 == 'N' ? 'inactive' : 'active') + "'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='percentage rightAlign DATValueTotalPF' style='display: none;' title='Total'>" +
        "                <input type='text' value='0' title='Total' class='bottomLevelText'>" +
        "                <span class='hideCol'>0</span>" +
        "            </td>" +
        "            <td class='bold rightAlign percentLYF' title='%LY'></td>" +
        "            <td class='bold rightAlign percentLLYF " + classForLLY + "' title='%LLY'></td>" +
        "            <td class='action-btn'><div class='function-btn'><a href='#' class='distributeTotalEven' title='Spread the Total amount evenly to all periods'>=</a><a href='#' class='distributeTotalPercent'>%</a>" + ($('#hdnUsePeriodReDistribution').val() == "True" ? "<a class='usePeriodRedistribution' title='Distribute by " + hdnPeriodReDistributionValueVal + "' data-value='" + hdnPeriodReDistributionValueVal + "'>" + hdnPeriodReDistributionValueVal + "</a>" : "") + "<a data-target='#static' data-toggle='modal' class='bottomLevelCategoryComment' title='Insert Notes'><i class='fa fa-pencil-square-o'></i></a><a href='javascript:void(0)' class='documentUpload' title='Upload a document'><i class='fa fa-file'></i></a><input type='file' class='documentFile' accept='.pdf,.doc,.docx,.xls,.xlsx' style='display: none;'></input></div>" +
        "            </td>" +
        //"            <td class='selectRowToDelete'>" +
        //"                <input type='checkbox' value='' class=''></td>" +
        //"            <td></td>" +
        "            <td style='display: none' id='hdnStoreUID'>" + storeID + "</td>" +
        "            <td style='display: none' id='hdnDeptUID'>" + deptID + "</td>" +
        "            <td style='display: none' id='hdnCatUID'>" + catID + "</td>" +
        "            <td style='display: none' id='hdnVendorUID'>" + 0 + "</td>" +
        "            <td style='display: none' id='hdnPLElementUID'>" + -1 + "</td>" +
        "            <td style='display: none' id='hdnDecimalPlaces'>" + decimalPlaces + "</td>" +
        "            <td style='display: none' id='hdnIsFOA'>" + isFOA + "</td>" +
        "            <td style='display: none;' id='hdnComment'>" + comment + "</td>" +
        "            <td style='display: none;' id='hdnFromExcel'>" + fromExcel + "</td>" +
        "            <td style='display: none;' id='hdnExcelRowNum'>" + excelRowNum + "</td>" +
        "            <td style='display: none;' id='hdnCurrentComment'></td>" +
        "            <td style='display: none;' id='hdnAttachedSubCategoryFolderName' data-attachedfolder=''></td>" +
        "            </tr>";

    }

    return html;
}

function isNumber(evt, element) {

    var charCode = (evt.which) ? evt.which : event.keyCode

    if (
        (charCode != 45 || $(element).val().indexOf('-') != -1) &&      // - CHECK MINUS, AND ONLY ONE.
        (charCode != 46 || $(element).val().indexOf('.') != -1) &&      // . CHECK DOT, AND ONLY ONE.
        (charCode < 48 || charCode > 57))
        return false;

    return true;
}
function resizeInput() {
    $(this).attr('size', $(this).val().length);
}
function RemoveEditableMode($parentTr) {

    var $td = '';
    if ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "False") $('#btnPercentage').removeClass('hide');
    $parentTr.find('.checkAllToDelete ').addClass('hideCol');

    //For branch BD-1122
    //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "False" && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True") {
    //    $parentTr.find('.checkAllToDelete').removeAttr("disabled");
    //}

    $parentTr.nextUntil('tr.doNotExpand:not(.beginningBalance)', '.bottomLevel.contracted:not(.beginningBalance)').each(function () {
        $(this).find('input:not([type="hidden"])').each(function () {
            $(this).addClass('hideCol');
            $span = $(this).next('span');
            $span.removeClass('hideCol');
            $(this).val($span.attr('data-value'));
        });
        $(this).find('.vendor').show();
        $(this).find('.vendorDD').addClass("hide");
        $(this).find('.transactionDateDiv').removeClass('disable-wrapper');
        $(this).find('.dayOfPeriodDiv').removeClass('disable-wrapper');

        if ($(this).find('td.vendorLst .vendor-info-modal').length == 0)
            $(this).find('td.vendorLst').addClass('vendor-wrap');

        $(this).find('td.termLst').addClass('vendor-wrap');

        $(this).find('td.currencyLst .currency').removeClass('hide').removeClass('hideCol');
        $(this).find('td.currencyLst .currencyDD').addClass('hide');

        if (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True") {

            if ($(this).find('td.termLst [name="subCategoryTermDD"]').length > 0) {
                $(this).find('td.termLst [name="subCategoryTermDD"]').val($(this).find('td.termLst .termSpan').attr('data-termuid'))
                $(this).find('td.termLst [name="subCategoryTermDD"]')[0].sumo.reload();
            }

            $td = $(this).find('td.dateLst');

            if ($td.hasClass('isTransactionDate')) {
                $td.find('.dayOfPeriodDiv').addClass('hide');
                $td.find('.transactionDateDiv').removeClass('hide');
            }
            else {
                $td.find('.dayOfPeriodDiv').removeClass('hide');
                $td.find('.transactionDateDiv').addClass('hide');
            }

            $td.find('.dayOfPeriod').attr('data-day', $td.find('.dayOfPeriodDiv .transactionSpan').attr('data-value'));
            $td.find('.dayOfPeriod').text(moment.localeData().ordinal($td.find('.dayOfPeriodDiv .transactionSpan').attr('data-value')));

            $td.find('.transactionDate').attr('data-date', $td.find('.transactionDateDiv .transactionSpan').attr('data-value'));
            $td.find('.transactionDate').attr('data-currentvalue', $td.find('.transactionDateDiv .transactionSpan').attr('data-value'));
            $td.find('.transactionDate').text($td.find('.transactionDateDiv .transactionSpan').attr('data-value'));

            $(this).find('td.dateLst .openTransactionPopup').addClass('hide');
            $(this).find('span.transactionSpan').removeClass('hideCol');

            if ($(this).find('#hdnCatCalucaltedType').html() == '' && $(this).find('#hdnCatCalucaltedOn').html() == '')
                RetailBudgetPro.Budget.AmortizePeriodChange($(this).find('td.amortizePeriodLst .amortize-period'));

            $(this).find('td.amortizePeriodLst .amortize-period').attr('data-currentvalue', $(this).find('td.amortizePeriodLst .amortize-period').val());

            $(this).find('td.termLst .termSpan').removeClass('hide').removeClass('hideCol');
            $(this).find('td.termLst .termDD').addClass('hide');
        }

        //$(this).find('.action-btn').addClass('hideCol');
        $(this).find('.action-btn').find('.distributeTotalEven').hide();
        $(this).find('.action-btn').find('.usePeriodRedistribution').hide();
        $(this).find('.action-btn').find('.growthRate').hide();
        $(this).find('.action-btn').find('.distributeTotalPercent').hide();
        $(this).find('.action-btn').find('.userdata').show(); 
        $(this).find('.action-btn .bottomLevelCategoryComment').removeClass('hide');
        $(this).filter('.highlightExcelRow').find('td.vendorLst').addClass('showVendorInTitle');
        //$('#DataInputTable').find('.displayVendor.actionBtnsTd').html('User Name');
        $(this).find('.function-btn').addClass('userDetail');
        $(this).find('.edit-formula').remove();
        $(this).find('.edit-employee').remove();
        $(this).find('.downloadLinkedExcel').removeClass('hide');
        $(this).find('.documentUpload').addClass('hide');
        $(this).find('.downloadLinkedDocument').removeClass('hide');
        $(this).find('.upload-excel').addClass('hide');
        $(this).find('.exl-rowno').removeClass('hideCol');
        $(this).find('.rowStatus').removeClass('hideCol').addClass('showCol');
        $(this).find('.datModifiedDate').removeClass('hideCol');
        //if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != '') {
        //    $(this).addClass('highlightExcelRow');
        //    $(this).find('input[type=text]').addClass('highlightBckg');
        //}

	    //For branch BD-1122
        //if (RetailBudgetPro.Budget.isUserInEditDataPageRole == "False" && RetailBudgetPro.Budget.isUserInEditDataAmountOnlyRole == "True") {
        //    $(this).find('.selectRowToDelete').removeAttr("disabled");
        //    $(this).find('.action-btn .downloadLinkedDocument').removeClass('hide');
        //    $(this).find('.action-btn .bottomLevelCategoryComment').removeClass('hide');
        //}
    });

    var $nextTRs = $parentTr.nextAll('.totals').eq(0).next('tr');

    $nextTRs.find('.accrualEditData-info-icon').removeClass('hide');
    $parentTr.find('.action-items .edit').parent('div').removeClass('hide').addClass('show').next('div').addClass('hide').removeClass('show');
    $nextTRs.find('.growthRate').hide();
    $nextTRs.next('tr').find('.growthRate').hide();
    $('.action-items').show();
    $parentTr.removeClass('inEditMode');
    $parentTr.parents('table').removeClass('UsePeriodRedibution');
}

// Function used to convert string value to decimal
function ConvertCurrencyStringToDecimal(totalVal) {
    if (totalVal != undefined)
        return parseFloat(totalVal.toString().replace(/\,/g, '').replace(/\ /g, '').replace(/\$/g, '').replace(/\%/g, '')) || 0;
    else
        return 0;
}

function commaSeparateNumber(val) {
    if (val != undefined || val != "") {
        while (/^\d{1,3}([,]\d{3})*(\.\d{2})$/.test("1212121")) {
            val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
        }
    }
    return val;
}

// Function used to get the number of periods this budget is of(12 or 13)
function getNumberOfPeriods() {
    if ( RetailBudgetPro.Budget.numberOfPeriodsVal > 12)
        return 13;
    else
        return 12;
}

// Function used to get the decimal places for a particular row.
// This value is used to show decimal data upto the decimal places we get from a particular row.
function getDecimalPlaces($tr) {
    return $tr.find('#hdnDecimalPlaces').text();
}

// Function used to get the data object of the current row.
function getDataRowObject(objTr, controlType, periods) {
    var $row = objTr;
    var data = [];
    var counter = 1;
    var periodHasNonZeroVal = 0;

    if ($row.hasClass('netsales')) {
        $row.find('td.data').each(function () {
            data["DATNetSalesM" + counter] = ConvertCurrencyStringToDecimal($(this).children('span').text());
            data["DATValueM" + counter] = ConvertCurrencyStringToDecimal($(this).children('span').text());
            //data["DATValueM" + counter + "P"] = 0;
            counter++;
        });
    }
    else {
        $row.prevAll('tr.netsales').not('.historicaldata').first().find('td.data').each(function () {
            data["DATNetSalesM" + counter] = ConvertCurrencyStringToDecimal($(this).children('span').text());
            counter++;
        });

        counter = 1;

        $row.find('td.data').each(function () {
            if (controlType == "span") {
                data["DATValueM" + counter] = ConvertCurrencyStringToDecimal($(this).children('span').text());
            }
            else {
                data["DATValueM" + counter] = ConvertCurrencyStringToDecimal(($(this).children('input.editPeriod').val()));
            }

            if (data["DATValueM" + counter] != 0) {
                periodHasNonZeroVal = 1;
            }
            counter++;
        });

        data["IsZeroRow"] = periodHasNonZeroVal == 0;

        counter = 1;

        $row.find('td.percentage').each(function () {
            if (controlType == "span") {
                data["DATValueM" + counter + "P"] = ConvertCurrencyStringToDecimal($(this).children('span').text());
            }
            else {
                data["DATValueM" + counter + "P"] = ConvertCurrencyStringToDecimal(($(this).children('input.editPeriod').val()));
            }
            counter++;
        });

        counter = 1;

        if ($('.percentage').hasClass('active')) {
            $row.find('td.data').each(function () {
                if (data["DATNetSalesM" + counter] <= 0) {
                }
                else
                    data["DATValueM" + counter] = (data["DATValueM" + counter + "P"] * data["DATNetSalesM" + counter]) / 100;
                counter++;
            });
        }
        else {
            $row.find('td.percentage').each(function () {
                if (data["DATNetSalesM" + counter] <= 0)
                    data["DATValueM" + counter + "P"] = 0;
                else
                    data["DATValueM" + counter + "P"] = (data["DATValueM" + counter] * 100) / data["DATNetSalesM" + counter];
                counter++;
            });
        }
    }

    var showBSColumns = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && periods == 12 && $('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True");

    data["rowID"] = $row.attr('id');
    data["VENDescription"] = $row.find('td').eq(2).find('input[type=text]').val();
    data["CATDescription"] = $row.find('td:first').find('input[type=text]').val();
    data["DATStoreUID"] = $row.find('#hdnStoreUID').text();
    data["DATDepartmentUID"] = $row.find('#hdnDeptUID').text();
    data["DATPLCategoryUID"] = $row.find('#hdnCatUID').text();
    data["DATVendorUID"] = $row.find('#hdnVendorUID').text();
    data["PLElementUID"] = $row.find('#hdnPLElementUID').text();
    data["CatCalculatedOn"] = $row.find('#hdnCatCalucaltedOn').text();
    data["CatCalculatedType"] = $row.find('#hdnCatCalucaltedType').text();
    data["ExcelFolderName"] = $row.find('#hdnFromExcel').html();
    data["AttachedSubCategoryFolderName"] = $row.find('#hdnAttachedSubCategoryFolderName').html();

    var vendSubCatVal = $row.find('.drpdwnvendor').val();
    data["VendorUIDCSV"] = vendSubCatVal != undefined ? vendSubCatVal.join() : "";

    var currSubCatVal = $row.find('[name="subCategoryCurrencyDD"]').val();
    data["CurrencyUID"] = currSubCatVal != undefined ? currSubCatVal : "";

    data["TransactionDate"] = showBSColumns ? $row.find('.transactionDate').attr('data-date') : new Date();
    data["DayOfPeriod"] = showBSColumns ? $row.find('.dayOfPeriod').attr('data-day') : 15;
    data["TermUID"] = showBSColumns && $row.find('[name="subCategoryTermDD"]').val() != undefined && $row.find('[name="subCategoryTermDD"]').val() != "" ? $row.find('[name="subCategoryTermDD"]').val() : -1;
    data["AmortizePeriod"] = showBSColumns ? $row.find('input[type="text"].amortize-period').val() : 1;

    data = ComputeTotalForRow(data, periods);

    return data;
}

// Function used to compute total for a particular row.
function ComputeTotalForRow(data, periods) {
    var rowTotal = data.DATValueM1 + data.DATValueM2 + data.DATValueM3 +
                                  data.DATValueM4 + data.DATValueM5 + data.DATValueM6 +
                                  data.DATValueM7 + data.DATValueM8 + data.DATValueM9 +
                                  data.DATValueM10 + data.DATValueM11 + data.DATValueM12;

    if (periods > 12)
        rowTotal = rowTotal + data.DATValueM13;

    var NetSalesTotal = data.DATNetSalesM1 + data.DATNetSalesM2 + data.DATNetSalesM3 +
                                  data.DATNetSalesM4 + data.DATNetSalesM5 + data.DATNetSalesM6 +
                                  data.DATNetSalesM7 + data.DATNetSalesM8 + data.DATNetSalesM9 +
                                  data.DATNetSalesM10 + data.DATNetSalesM11 + data.DATNetSalesM12;

    if (periods > 12)
        NetSalesTotal = NetSalesTotal + data.DATNetSalesM13;

    data["Total"] = rowTotal;
    if (NetSalesTotal <= 0)
        data["TotalPercent"] = 0;
    else
        data["TotalPercent"] = (rowTotal * 100) / NetSalesTotal;
    return data;
}

// Function used to compute data for total row
function computeTotalsRow(DataCollection) {
    var $TotalsRow = [];
    $TotalsRow["DATValueM1"] = 0;
    $TotalsRow["DATValueM2"] = 0;
    $TotalsRow["DATValueM3"] = 0;
    $TotalsRow["DATValueM4"] = 0;
    $TotalsRow["DATValueM5"] = 0;
    $TotalsRow["DATValueM6"] = 0;
    $TotalsRow["DATValueM7"] = 0;
    $TotalsRow["DATValueM8"] = 0;
    $TotalsRow["DATValueM9"] = 0;
    $TotalsRow["DATValueM10"] = 0;
    $TotalsRow["DATValueM11"] = 0;
    $TotalsRow["DATValueM12"] = 0;
    $TotalsRow["DATValueM13"] = 0;

    var i = 0;
    for (i = 0; i < DataCollection.length; i++) {
        $TotalsRow["DATValueM1"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM1"]);
        $TotalsRow["DATValueM2"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM2"]);
        $TotalsRow["DATValueM3"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM3"]);
        $TotalsRow["DATValueM4"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM4"]);
        $TotalsRow["DATValueM5"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM5"]);
        $TotalsRow["DATValueM6"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM6"]);
        $TotalsRow["DATValueM7"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM7"]);
        $TotalsRow["DATValueM8"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM8"]);
        $TotalsRow["DATValueM9"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM9"]);
        $TotalsRow["DATValueM10"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM10"]);
        $TotalsRow["DATValueM11"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM11"]);
        $TotalsRow["DATValueM12"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM12"]);
        if (DataCollection[i]["DATValueM13"] != undefined)
            $TotalsRow["DATValueM13"] += ConvertCurrencyStringToDecimal(DataCollection[i]["DATValueM13"]);
    }

    var counter = 1;


    $row.prevAll('tr.netsales').not('.historicaldata').first().find('td.data').each(function () {
        $TotalsRow["DATNetSalesM" + counter] = ConvertCurrencyStringToDecimal($(this).children('span').text());
        if ($TotalsRow["DATNetSalesM" + counter] <= 0)
            $TotalsRow["DATValueM" + counter + "P"] = 0;
        else
            $TotalsRow["DATValueM" + counter + "P"] = ($TotalsRow["DATValueM" + counter] * 100) / $TotalsRow["DATNetSalesM" + counter];
        counter++;
    });

    //var rowTotal = $TotalsRow.DATValueM1 + $TotalsRow.DATValueM2 + $TotalsRow.DATValueM3 +
    //                              $TotalsRow.DATValueM4 + $TotalsRow.DATValueM5 + $TotalsRow.DATValueM6 +
    //                              $TotalsRow.DATValueM7 + $TotalsRow.DATValueM8 + $TotalsRow.DATValueM9 +
    //                              $TotalsRow.DATValueM10 + $TotalsRow.DATValueM11 + $TotalsRow.DATValueM12;

    //if (DataCollection.length > 0 && DataCollection[0]["DATValueM13"] != undefined)
    //    rowTotal = rowTotal + $TotalsRow.DATValueM13;

    //$TotalsRow["Total"] = rowTotal;
    //$TotalsRow["TotalPercent"] = rowTotal;
    $TotalsRow = ComputeTotalForRow($TotalsRow, getNumberOfPeriods());

    return $TotalsRow;
}

// Function used to compute data upto top level
function ComputeLevel($parentTr, mode) {
    var NewDataCollection = [];
    var TotalsData = [];
    var $periods = getNumberOfPeriods();

    $totalRow = $parentTr;

    var $RowsToSearch;
    var $Currentlevel = 0;


    if ($parentTr != null) {
        $Currentlevel = $parentTr.data("level");
        $CurrentlevelClass = "l" + $Currentlevel.toString();

        $Nextlevel = parseInt($Currentlevel) + 1;
        $NextlevelClass = "l" + $Nextlevel.toString();

        $Prevlevel = parseInt($Currentlevel) - 1;
        $PrevlevelClass = "l" + $Prevlevel.toString();

        $RowsToSearch = $parentTr.nextUntil('tr.' + $CurrentlevelClass, '.' + $NextlevelClass + ':not(.beginningBalance)');

        //if ($('[name=groupedcategory]').val() != '') {
        //    $RowsToSearch = $parentTr.nextUntil('tr.' + 'l2');
        //}

    }
    else {
        $parentTr = $('.netsales.l1:first');
        $RowsToSearch = $parentTr.nextAll('tr.l1');
    }

    //  var finalHtml= $($RowsToSearch[0]).nextUntil('.totals').addBack();



    $RowsToSearch.filter(':not(".unapproved-sent")').each(function () {

        if ($(this).hasClass('doNotExpand')) { //Totals Row          


            if ($(this).find('td:first').find('div.label').text().trim() != "%LLY" && $(this).find('td:first').find('div.label').text().trim() != "%LY") {
                if ($(this).hasClass('totals')) {
                    $totalRow = $(this);
                    TotalsData = computeTotalsRow(NewDataCollection);
                    NewDataCollection.push(TotalsData);
                }

                if ($parentTr.hasClass('SalesIdentifier')) { // calculate Net Sales for all levels
                    var $oldTotalRow = getDataRowObject($(this), "span", $periods);
                    // calculate Net Sales for Store level
                    var $StoreLevelNetSalesRow = $parentTr.prevAll('.netsales.l2:first');
                    // calculate only if we have row 
                    // Avoid data mapping for blank rows
                    if ($StoreLevelNetSalesRow.length > 0 && TotalsData.length > 0) {
                        var $StoreLevelNetSales = getDataRowObject($StoreLevelNetSalesRow, "span", $periods);
                        // Calculate Net Sales for Top Level
                        var $topLevelNetSalesRow = $parentTr.prevAll('.netsales.l1:first');
                        var $topLevelNetSales = getDataRowObject($topLevelNetSalesRow, "span", $periods);

                        var $NewStoreLevelNetSales = [];
                        var $NewTopLevelNetSales = [];
                        var counter1 = 1;
                        for (counter1 = 1; counter1 < 14; counter1++) {
                            // To Do - New Net Sales = $StoreLevelNetSales - $oldTotalRow + $totalRow                           
                            $NewStoreLevelNetSales["DATValueM" + counter1.toString()] = $StoreLevelNetSales["DATValueM" + counter1.toString()] - $oldTotalRow["DATValueM" + counter1.toString()] + TotalsData["DATValueM" + counter1.toString()];
                            // To Do - New Net Sales = $topLevelNetSales - $oldTotalRow + $totalRow                           
                            $NewTopLevelNetSales["DATValueM" + counter1.toString()] = $topLevelNetSales["DATValueM" + counter1.toString()] - $oldTotalRow["DATValueM" + counter1.toString()] + TotalsData["DATValueM" + counter1.toString()];

                            ComputeTotalForRow($NewStoreLevelNetSales, $periods);
                            ComputeTotalForRow($NewTopLevelNetSales, $periods);
                        }
                        var decimalPlaces = getDecimalPlaces($StoreLevelNetSalesRow);
                        MapValues($NewStoreLevelNetSales, $StoreLevelNetSalesRow, $periods, decimalPlaces);
                        decimalPlaces = getDecimalPlaces($topLevelNetSalesRow);
                        MapValues($NewTopLevelNetSales, $topLevelNetSalesRow, $periods, decimalPlaces);
                    }
                }
            }

        }
        else {
            //OldDataCollection.push(getDataRowObject($(this), "span"), $periods);
            var NewDataRow = [];
            var counter = 1;
            if (!$(this).hasClass('tempHideBottomLevel')) {
                if ($(this).hasClass('bottomLevel')) {
                    NewDataRow = getDataRowObject($(this), "edit", $periods);
                }
                else {
                    NewDataRow = getDataRowObject($(this), "span", $periods);
                }
            }
            NewDataRow["rowID"] = $(this).attr('id');
            if (!$(this).hasClass('tempHideBottomLevel')) {
                NewDataCollection.push(NewDataRow);
            }
            var decimalPlaces = getDecimalPlaces($(this));
            MapValues(NewDataRow, $(this), $periods, decimalPlaces);

        }

    });


    // update totals Row
    if ($totalRow != null) MapValues(TotalsData, $totalRow, $periods);



    if ($RowsToSearch.first().hasClass('bottomLevel')) {
        // Save the rows to database
        var data = {};
        var finalData = [];

        finalData = CreateJsonOfDataRowObject(NewDataCollection, $periods);
        if (mode != "Edit") {

            $('.custom-data-table').hide();

            var stores = [];
            var groupedcategory = $('[name=groupedcategory] :selected').val();
            var stores = $('[name=lstStores]').val().toString();
            var level = "0";
            var viewLevel = "STORE";
            var storeID = "-1";
            var deptID = "-1";
            var categoryID = "-1";

            if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                var rowString = '';

                $('.expanded').map(function (v) {
                    rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnDeptUID').html() + '|' + $(this).find('#hdnCatUID').html() + ','
                });

                localStorage.setItem("ActiveRow", $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnDeptUID').html() + '|' + $parentTr.find('#hdnCatUID').html());

                localStorage.setItem("ExpandedRows", rowString.substring(0, rowString.length - 1));

            }

            localStorage.setItem("ExpandRows", "True");


            //commented by Sachin as per client's request to change vendor filter to "Any" when "Save" button is clicked.
            //var arr = [];

            //finalData.forEach(function (v) {
            //    if (v.PLElementUID == "-1") {
            //        arr.push(v.VendorUIDCSV == "" ? "-1" : v.VendorUIDCSV.split(','));
            //    }
            //});

            //arr = [].concat.apply([], arr);

            //arr = arr.filter((v, p) => arr.indexOf(v) == p);

            //if (arr.length == 0 || (arr.length == 1 && arr[0] == "-1")) {
            //    arr.push($('[name=datapageVendordd]').val());
            //}

            // var VendorUIDs = [].concat.apply([], arr);

            //VendorUIDs = VendorUIDs.filter((v, p) => VendorUIDs.indexOf(v) == p);

           // console.log(localStorage.getItem("ExpandedRows"));
            var bsMode = (RetailBudgetPro.Budget.turnOnBalanceSheetVal == "True" && RetailBudgetPro.Budget.numberOfPeriodsVal == 12) ? $('[name="TransactionModeDropdown"]').val() : "";
            var categoryType = ($('[name="groupedcategory"]').find('option:selected').attr('data-isbalancesheet') == "True" ? "BS" : ($('[name="groupedcategory"]').find('option:selected').attr('data-isfinancialcat') == "True" ? "PL" : "NF"));

            $.ajax({
                url: '/Budget/SaveDataInput',
                type: 'POST',
                async: true,
                dataType: 'html',
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify({ data: finalData, level: level, StoreUID: storeID, DeptUID: deptID, CategoryUID: categoryID, groupedcategory: groupedcategory, Stores: stores, CompNonCompfilter: RetailBudgetPro.Budget.filter, viewLevel: viewLevel, AuditData: RetailBudgetPro.Budget.auditChanges, VendorUIDs: $('[name="datapageVendordd"]').val() == undefined ? "-2" : $('[name="datapageVendordd"]').val().join(','), showInGlobal: ($('[name="ShowInGlobal"]').val() == "1"), growthRate: RetailBudgetPro.Budget.growthRate, bsMode: bsMode, categoryType: categoryType }),
                success: function (data) {
                    var isValid = true;
                    if ($('[name=AllowBatchUpdates]').val() == 'True') {
                        try {
                            var result = $.parseJSON(data);

                            if (result.result == 2) {
                                isValid = false;
                                $('.layout').hide();

                                var confirm_click = function () {
                                    window.location.reload();
                                }

                                custom_alert(confirm_click, "Alert", "Can not save data as formula execution has already started.");
                            }
                        }
                        catch (e) {

                        }
                    }

                    if (isValid) {
                        if ($('#vendordd').length > 0) {

                            var selectedVen = $('#vendordd').val();

                            if (selectedVen != null && selectedVen[0] != "-2") {

                                if (selectedVen[0] != "-1" && selectedVen.length == 1) {
                                    var rowsWithoutFilteredVen = finalData.filter(function (a) {
                                        if (!(a.VendorUIDCSV != "" && a.VendorUIDCSV.split(',').indexOf(selectedVen[0]) > -1)) {
                                            return a;
                                        }
                                    });
                                }

                                if (rowsWithoutFilteredVen == undefined || rowsWithoutFilteredVen.length > 0) {
                                    RetailBudgetPro.Budget.showVendorChangePopupMessage = 1;

                                    $('#vendordd').val("-2");


                                    $('#vendordd').val("-2");

                                    $('#vendordd')[0].sumo.reload();
                                }
                            }
                        }

                        $('#DataInputTable tbody').html('');
                        $('#DataInputTable tbody').html(data);
                        $(".hideyear").each(function () {
                            $(this).removeAttr("data-level");
                        });
                        $('#DataInputTable').find('.displayVendor').addClass('hide');
                        $('#DataInputTable').tabelize();
                        RetailBudgetPro.Budget.ManageDataAndPerentage();
                        $(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                        $(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                        $('.hideyear').find('td:first').html('');
                        RetailBudgetPro.Budget.growthRate = [];
                    }

                    //$('.layout').css('display', 'none');
                    //$('.custom-data-table').show();

                    //var level = $parentTr.attr('data-level');

                    //$html = $(data);

                    ////$(data).find('.action-btn').removeClass('hideCol');
                    ////$(data).find('.action-btn').find('.distributeTotalEven').hide();
                    ////$(data).find('.action-btn').find('.growthRate').hide();
                    ////$(data).find('.action-btn').find('.distributeTotalPercent').hide();

                    //$html.attr('data-level', parseInt(level) + 1);
                    //$parentTr.nextUntil('.doNotExpand').not('.historicaldata').remove();
                    //$html.insertAfter($parentTr.next('tr').next('tr'));

                    //$($html).find('.copyValues').hide();
                    //$('#DataInputTable').tabelize();
                    //RetailBudgetPro.Budget.ManageDataAndPerentage();
                    //$(".doNotExpand").find('td:first').find('div[class=expander]').remove();
                    //$(".bottomLevel").find('td:first').find('div[class=expander]').remove();
                    //$('.hideyear').find('td:first').html('');

                    //if (excelFolderName != undefined) {
                    //    //$parentTr.find('.action-items .upload-excel').removeClass('marRight');
                    //    $parentTr.find('.action-items .newLineLink').remove();
                    //    $parentTr.find('.action-items .save').remove();
                    //    if ($parentTr.find('.action-items .show a .downloadSubCatExcel').length == 0) {
                    //        var htmlToApp = '<a href="javascript:void(0)" class="downloadLinkedExcel" title="Download linked excel"><i class="fa fa-file-excel-o downloadSubCatExcel"></i></a>';
                    //        $parentTr.find('.action-items .show').prepend(htmlToApp);
                    //    }
                    //}
                    //else {
                    //    if ($parentTr.find('.action-items .hide .save').length == 0) {
                    //        var htmlToApp = '<a href="#" class="save" title="Save"><i class="fa fa-save"></i></a>';
                    //        $parentTr.find('.action-items .hide').prepend(htmlToApp);
                    //        //$(htmlToApp).insertAfter($parentTr.find('.action-items .hide .upload-excel'));
                    //    }
                    //    if ($parentTr.find('.action-items .hide .newLineLink').length == 0) {
                    //        var htmlToApp = '<a href="#" class="newLineLink" title="Add new line"> <i class="fa fa-plus"></i> </a>';
                    //        $(htmlToApp).insertAfter($parentTr.find('.action-items .hide .save'));
                    //    }
                    //    //$parentTr.find('.action-items .upload-excel').addClass('marRight');
                    //    $parentTr.find('.action-items .show .downloadSubCatExcel').parents('a').remove();
                    //}

                    //$.each($html, function (i, val) {
                    //    if ($(this).find('#hdnFromExcel').html() != undefined && $(this).find('#hdnFromExcel').html().trim() != "") {
                    //        if ($(this).find('td:first()').find('.downloadLinkedExcel').length == 0) {
                    //            var hoverText = $(this).find('#hdnFromExcel').html().split('|')[1] != undefined ? "(Linked to Row " + $(val).find('#hdnFromExcel').html().split('|')[1] + ") - Download Excel" : "Download Excel";
                    //            $(this).find('td:first()').append('<a href="javascript:void(0)" class="downloadLinkedExcel" title="' + hoverText + '"><i class="file-excel-filed downloadSubCatExcel"></i></a>');
                    //        }
                    //    }
                    //    if ($(this).find('#hdnCatCalucaltedOn').html() != undefined && $(this).find('#hdnCatCalucaltedOn').html().trim() != "") {
                    //        var urlLink = $(this).find('.isVendor').attr('value').split('-')[0] == "FOA" ? "/Formula/EditFormula/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : $(this).find('.isVendor').attr('value').split('-')[0] == "C2C" ? "/C2C/EditC2C/" + $(this).find('#hdnCatCalucaltedOn').html().trim() : "/Rule/EditRule/" + $(this).find('#hdnCatCalucaltedOn').html().trim();
                    //        var formulaName = $(this).find('.isVendor').attr('value').split('-')[1];
                    //        if ($(this).find('.edit-formula').length == 0) {
                    //            $(this).find('td:first()').append('<a title="View ' + formulaName + '" target="_blank" class="edit-formula" href=' + urlLink + '><img src="/assets/admin/layout/img/sigma-blue.png"></a>')
                    //        }
                    //    }
                    //});

                    //$('[name=RowNumber]').val('');
                    //$('#ExcelFile').val('');

                    //var currentLevel = parseInt($parentTr.attr('data-level'));

                    //RetailBudgetPro.Budget.auditChanges.push($($($parentTr.nextUntil('tr[data-level=' + currentLevel + ']').filter(function (a) {
                    //    return $(this).hasClass('totals') && $(this).attr('data-level') == (currentLevel + 1)
                    //}))[0]).find('.data').map(function (v) {
                    //    return $(this).text();
                    //}).get());

                    //SaveToActivity($parentTr);






                    //if (localStorage.getItem("ExpandRows") == null || (localStorage.getItem("ExpandRows") != null && localStorage.getItem("ExpandRows") == "False")) {

                    //    var rowString = '';

                    //    $('.expanded').map(function (v) { if ($parentTr.attr('id') != $(this).attr('id')) rowString = rowString + $(this).find('#hdnStoreUID').html() + '|' + $(this).find('#hdnCatUID').html() + ',' });

                    //    rowString = rowString + $parentTr.find('#hdnStoreUID').html() + '|' + $parentTr.find('#hdnCatUID').html()

                    //    localStorage.setItem("ExpandedRows", rowString);

                    //}

                    //localStorage.setItem("ExpandRows", "True");

                    //RetailBudgetPro.Budget.DisplayFilteredData(undefined, 'delete');

                    //$('.layout').css('display', 'none');

                },
                error: function (err) {
                    console.log(err);
                    $('.layout').css('display', 'none');
                }
            });
        }
    }
    //  $('.layout').css('display', 'none');
    //update Main Row
    if ($Currentlevel > 0) {
        var decimalPlaces = getDecimalPlaces($parentTr);
        MapValues(TotalsData, $parentTr, $periods, decimalPlaces);
    }

    if ($Currentlevel > 1) {
        ComputeLevel($parentTr.prevAll('.' + $PrevlevelClass + ':first'), mode);
    }
    else if ($Currentlevel == 1) {
        ComputeLevel(null, mode);
    }

    //else {
    //    $parentTr.nextUntil('tr.doNotExpand', 'tr.l1').each(function () {
    //        var NewDataRow = [];
    //        NewDataRow = getDataRowObject($(this), "span", $periods);
    //        NewDataRow["rowID"] = $(this).attr('id');
    //        NewDataCollection.push(NewDataRow);
    //    });
    //    TotalsData = computeTotalsRow(NewDataCollection);
    //    MapValues(TotalsData, $totalRow, $periods);


}
function CreateJsonOfDataRowObject(NewDataCollection, $periods, excelFolderName, includeNonEditableZeroRows) {
    var finalData = [];
    for (var counter = 0; counter < NewDataCollection.length; counter++) {
        data = {};

        if ((NewDataCollection[counter].CatCalculatedOn == "" && NewDataCollection[counter].CatCalculatedType == "")) {
            if ($periods > 12)
                data = {
                    "DATValueM1": NewDataCollection[counter].DATValueM1, "DATValueM2": NewDataCollection[counter].DATValueM2, "DATValueM3": NewDataCollection[counter].DATValueM3, "DATValueM4": NewDataCollection[counter].DATValueM4, "DATValueM5": NewDataCollection[counter].DATValueM5, "DATValueM6": NewDataCollection[counter].DATValueM6, "DATValueM7": NewDataCollection[counter].DATValueM7, "DATValueM8": NewDataCollection[counter].DATValueM8, "DATValueM9": NewDataCollection[counter].DATValueM9, "DATValueM10": NewDataCollection[counter].DATValueM10, "DATValueM11": NewDataCollection[counter].DATValueM11, "DATValueM12": NewDataCollection[counter].DATValueM12, "DATValueM13": NewDataCollection[counter].DATValueM13,
                    "DATValueM1P": NewDataCollection[counter].DATValueM1P, "DATValueM2P": NewDataCollection[counter].DATValueM2P, "DATValueM3P": NewDataCollection[counter].DATValueM3P, "DATValueM4P": NewDataCollection[counter].DATValueM4P, "DATValueM5P": NewDataCollection[counter].DATValueM5P, "DATValueM6P": NewDataCollection[counter].DATValueM6P, "DATValueM7P": NewDataCollection[counter].DATValueM7P, "DATValueM8P": NewDataCollection[counter].DATValueM8P, "DATValueM9P": NewDataCollection[counter].DATValueM9P, "DATValueM10P": NewDataCollection[counter].DATValueM10P, "DATValueM11P": NewDataCollection[counter].DATValueM11P, "DATValueM12P": NewDataCollection[counter].DATValueM12P, "DATValueM13P": NewDataCollection[counter].DATValueM13P,
                    "DATNetSalesM1": NewDataCollection[counter].DATNetSalesM1, "DATNetSalesM2": NewDataCollection[counter].DATNetSalesM2, "DATNetSalesM3": NewDataCollection[counter].DATNetSalesM3, "DATNetSalesM4": NewDataCollection[counter].DATNetSalesM4, "DATNetSalesM5": NewDataCollection[counter].DATNetSalesM5, "DATNetSalesM6": NewDataCollection[counter].DATNetSalesM6, "DATNetSalesM7": NewDataCollection[counter].DATNetSalesM7, "DATNetSalesM8": NewDataCollection[counter].DATNetSalesM8, "DATNetSalesM9": NewDataCollection[counter].DATNetSalesM9, "DATNetSalesM10": NewDataCollection[counter].DATNetSalesM10, "DATNetSalesM11": NewDataCollection[counter].DATNetSalesM11, "DATNetSalesM12": NewDataCollection[counter].DATNetSalesM12, "DATNetSalesM13": NewDataCollection[counter].DATNetSalesM13,
                    "VENDescription": NewDataCollection[counter].VENDescription, "DATDescription": NewDataCollection[counter].DATDescription, "DATPLCategoryUID": NewDataCollection[counter].DATPLCategoryUID, "DATDepartmentUID": NewDataCollection[counter].DATDepartmentUID, "DATStoreUID": NewDataCollection[counter].DATStoreUID, "DATVendorUID": NewDataCollection[counter].DATVendorUID, "PLElementUID": NewDataCollection[counter].PLElementUID, "Comments": NewDataCollection[counter].Comment, "LoadFromExcel": NewDataCollection[counter].ExcelFolderName == "" ? false : true, "ExcelRowNumber": NewDataCollection[counter].ExcelRowNumber, "ExcelFolderName": NewDataCollection[counter].ExcelFolderName, "AttachedSubCategoryFolderName": NewDataCollection[counter].AttachedSubCategoryFolderName, "VendorUIDCSV": NewDataCollection[counter].VendorUIDCSV, "CurrencyUID": (($('[name="groupedcategory"] option[value$="|' + NewDataCollection[counter].DATPLCategoryUID + '"]').data('isfinancialcat') == "True") ? (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? NewDataCollection[counter].CurrencyUID : RetailBudgetPro.Budget.globalCurrencyUID) : -1),
                    "TransactionDate": NewDataCollection[counter].TransactionDate,
                    "DayOfPeriod": NewDataCollection[counter].DayOfPeriod,
                    "TermUID": NewDataCollection[counter].TermUID,
                    "AmortizePeriod": NewDataCollection[counter].AmortizePeriod
                };
            else

                data = {
                    "DATValueM1": NewDataCollection[counter].DATValueM1, "DATValueM2": NewDataCollection[counter].DATValueM2, "DATValueM3": NewDataCollection[counter].DATValueM3, "DATValueM4": NewDataCollection[counter].DATValueM4, "DATValueM5": NewDataCollection[counter].DATValueM5, "DATValueM6": NewDataCollection[counter].DATValueM6, "DATValueM7": NewDataCollection[counter].DATValueM7, "DATValueM8": NewDataCollection[counter].DATValueM8, "DATValueM9": NewDataCollection[counter].DATValueM9, "DATValueM10": NewDataCollection[counter].DATValueM10, "DATValueM11": NewDataCollection[counter].DATValueM11, "DATValueM12": NewDataCollection[counter].DATValueM12,
                    "DATValueM1P": NewDataCollection[counter].DATValueM1P, "DATValueM2P": NewDataCollection[counter].DATValueM2P, "DATValueM3P": NewDataCollection[counter].DATValueM3P, "DATValueM4P": NewDataCollection[counter].DATValueM4P, "DATValueM5P": NewDataCollection[counter].DATValueM5P, "DATValueM6P": NewDataCollection[counter].DATValueM6P, "DATValueM7P": NewDataCollection[counter].DATValueM7P, "DATValueM8P": NewDataCollection[counter].DATValueM8P, "DATValueM9P": NewDataCollection[counter].DATValueM9P, "DATValueM10P": NewDataCollection[counter].DATValueM10P, "DATValueM11P": NewDataCollection[counter].DATValueM11P, "DATValueM12P": NewDataCollection[counter].DATValueM12P,
                    "DATNetSalesM1": NewDataCollection[counter].DATNetSalesM1, "DATNetSalesM2": NewDataCollection[counter].DATNetSalesM2, "DATNetSalesM3": NewDataCollection[counter].DATNetSalesM3, "DATNetSalesM4": NewDataCollection[counter].DATNetSalesM4, "DATNetSalesM5": NewDataCollection[counter].DATNetSalesM5, "DATNetSalesM6": NewDataCollection[counter].DATNetSalesM6, "DATNetSalesM7": NewDataCollection[counter].DATNetSalesM7, "DATNetSalesM8": NewDataCollection[counter].DATNetSalesM8, "DATNetSalesM9": NewDataCollection[counter].DATNetSalesM9, "DATNetSalesM10": NewDataCollection[counter].DATNetSalesM10, "DATNetSalesM11": NewDataCollection[counter].DATNetSalesM11, "DATNetSalesM12": NewDataCollection[counter].DATNetSalesM12,
                    "VENDescription": NewDataCollection[counter].VENDescription, "DATDescription": NewDataCollection[counter].DATDescription, "DATPLCategoryUID": NewDataCollection[counter].DATPLCategoryUID, "DATDepartmentUID": NewDataCollection[counter].DATDepartmentUID, "DATStoreUID": NewDataCollection[counter].DATStoreUID, "DATVendorUID": NewDataCollection[counter].DATVendorUID, "PLElementUID": NewDataCollection[counter].PLElementUID, "Comments": NewDataCollection[counter].Comment, "LoadFromExcel": NewDataCollection[counter].ExcelFolderName == "" ? false : true, "ExcelRowNumber": NewDataCollection[counter].ExcelRowNumber, "ExcelFolderName": NewDataCollection[counter].ExcelFolderName, "AttachedSubCategoryFolderName": NewDataCollection[counter].AttachedSubCategoryFolderName, "VendorUIDCSV": NewDataCollection[counter].VendorUIDCSV, "CurrencyUID": (($('[name="groupedcategory"] option[value$="|' + NewDataCollection[counter].DATPLCategoryUID + '"]').data('isfinancialcat') == "True") ? (RetailBudgetPro.Budget.isCurrencyOnForBudget == "True" ? NewDataCollection[counter].CurrencyUID : RetailBudgetPro.Budget.globalCurrencyUID) : -1),
                    "TransactionDate": NewDataCollection[counter].TransactionDate,
                    "DayOfPeriod": NewDataCollection[counter].DayOfPeriod,
                    "TermUID": NewDataCollection[counter].TermUID,
                    "AmortizePeriod": NewDataCollection[counter].AmortizePeriod
                };
        }
        else if (NewDataCollection[counter].CatCalculatedType == "NE") {

            if (NewDataCollection[counter].Comment != undefined) {
                data = {
                    "PLElementUID": NewDataCollection[counter].PLElementUID,
                    "Comments": NewDataCollection[counter].Comment,
                    "CatCalculatedType": "NE"
                };
            }

            // added this to allow the user to send selected NE with all periods 0 rows to delete
            else if (includeNonEditableZeroRows == true && NewDataCollection[counter].IsZeroRow == true) {
                data = {
                    "PLElementUID": NewDataCollection[counter].PLElementUID,
                    "CatCalculatedType": "NE"
                };
            }
        }

        if (Object.keys(data).length > 0)
            finalData.push(data);
    }
    return finalData;
}

// Function used to map values to the table 
// After updating the row data,this function modifies the data till the top level
// and map those values to the respective 'td's
function MapValues(data, $row, $periods, decimalPlaces) {

    if (decimalPlaces == undefined) {

        var level = parseInt($row.attr('data-level'));

        var $allRows = $.grep($row.prevUntil('[data-level=' + (level - 1) + ']'), function (n, i) {
            return $(n).attr('data-level') == level.toString();
        });

        decimalPlaces = parseInt($($allRows[0]).find('#hdnDecimalPlaces').html());
    }
    else {
        decimalPlaces = parseInt(decimalPlaces);
    }

    if (decimalPlaces < 0)
        decimalPlaces = 0;

    var counter = 1;

    var $td_totalData = $row.find('.DATValueTotalF');
    var $td_totalPercentage = $row.find('.DATValueTotalPF');

    for (counter = 1; counter < 14; counter++) {
        if (counter < 13 || (counter == 13 && $periods > 12)) {
            var $td_data = $row.find('.DATValueM' + counter.toString() + 'F:first');
            var $td_percent = $row.find('.DATValueM' + counter.toString() + 'PF:first');

            //var $td_totalData = $row.find('.DATValueTotalF');
            //var $td_totalPercentage = $row.find('.DATValueTotalPF');

            //var $netSales = $('.netsales.doNotExpand .year:contains("' + $($row).find('.year').text() + '")').parents('tr');

            // setting bottom level data into spans


            //$td_data.parents('tr').find('span:first').text($row.find('td:first').find('input[type=text]').val());
            //$td_data.parents('tr').find('span').eq(1).text($row.find('td').eq(2).find('input[type=text]').val());

            if ($($row).hasClass('doNotExpand')) {
                //$td_data.find('span').text(Number(parseFloat(data["DATValueM" + counter.toString()]).toFixed(decimalPlaces)).toLocaleString("en"));
                $td_data.find('span').text(parseFloat(data["DATValueM" + counter.toString()]).toFixed(decimalPlaces));

                //var c = 0;
                //for (var i = 0; i < $netSales.length; i++) {
                //    $($netSales[i]).find('.DATValueM' + counter.toString() + 'F span').text(Number(parseFloat(data["DATNetSalesM" + counter.toString()]).toFixed(decimalPlaces)).toLocaleString("en"));
                //}

            }

            //$td_data.find('input').val(Number(parseFloat(data["DATValueM" + counter.toString()]).toFixed(decimalPlaces)).toLocaleString("en"));
            $td_data.find('input:not(.inactive):not(.disableByTransaction)').val(parseFloat(data["DATValueM" + counter.toString()]).toFixed(decimalPlaces));
            //$td_totalData.find('span').text(Number(parseFloat(data["Total"]).toFixed(decimalPlaces)).toLocaleString("en"));
            $td_totalData.find('span').text(parseFloat(data["Total"]).toFixed(decimalPlaces));
            $td_totalPercentage.find('span').text(parseFloat(data["TotalPercent"]));//.toFixed(1));
            $td_percent.find('span').text(parseFloat(data["DATValueM" + counter.toString() + "P"]));//.toFixed(1));
            $td_percent.find('input:not(.inactive):not(.disableByTransaction)').val(parseFloat(data["DATValueM" + counter.toString() + "P"]));//.toFixed(1));


        }

    }
    // calculating %Ly and %LLy for totals row
    if ($row.hasClass('totals')) {
        var total = $row.find('td.DATValueTotalF span').html().replace(/,/g, "");

        var lyTotal = $row.next('tr').find('td.DATValueTotalF span').html().replace(/,/g, "");
        var llyTotal = $row.next('tr').next('tr').find('td.DATValueTotalF span').html().replace(/,/g, "");

        var percentLY = 0;
        var percentLLY = 0;
        if (parseFloat(lyTotal) == 0) {

        } else
            percentLY = ((parseFloat(total) - parseFloat(lyTotal)) / Math.abs(parseFloat(lyTotal))) * 100;

        if (parseFloat(llyTotal) == 0) {

        } else
            percentLLY = ((parseFloat(total) - parseFloat(llyTotal)) / Math.abs(parseFloat(llyTotal))) * 100;

        $row.find('td.percentLYF').find('span').html(percentLY.toFixed(1));
        $row.find('td.percentLLYF').find('span').html(percentLLY.toFixed(1));
    }

    data["PLElementUID"] = $row.find('#hdnPLElementUID').text().trim();
    data["VENDescription"] = $row.find('td').eq(2).find('input[type=text]').val();
    data["DATDescription"] = $row.find('td:first').find('input[type=text]').val();
    data["DATStoreUID"] = $row.find('#hdnStoreUID').text();
    data["DATDepartmentUID"] = $row.find('#hdnDeptUID').text();
    data["DATPLCategoryUID"] = $row.find('#hdnCatUID').text();
    data["DATVendorUID"] = $row.find('#hdnVendorUID').text();
    data["PLElementUID"] = $row.find('#hdnPLElementUID').text();
    data["LoadFromExcel"] = $row.find('#hdnFromExcel').text().trim() != "" ? true : false;
    data["ExcelRowNumber"] = parseInt($row.find('#hdnExcelRowNum').length > 0 ? $row.find('#hdnExcelRowNum').text().trim() : "-1");
    if ($row.find('#hdnComment').text() != "")
        data["Comment"] = $row.find('#hdnComment').text();

}

// Function used to get the formula type (foa,c2c,rule)
function getFormulaTypeAndUrl(catId, storeUID) {
    //alert();
    var url = "";
    $.ajax({
        url: '/Budget/GetFormulaTypeAndUrl',
        data: "{ CategoryUID:'" + catId + "', StoreUID:'" + storeUID + "'}",
        type: 'POST',
        async: false,
        contentType: "application/json; charset=UTF-8",
        success: function (data) {
            url = data.data;
        },
        error: function (err) {
            console.log(err);
        }
    });

    return url;
}

function SaveToActivity($parentTr) {

    var activityhtml = "<tr><td class='bckgcolor-lghtred custom-font-wt'>Before</td>";

    $.grep(RetailBudgetPro.Budget.auditChanges[0], function (v, i) {
        if (RetailBudgetPro.Budget.auditChanges[0][i] == RetailBudgetPro.Budget.auditChanges[1][i]) activityhtml += '<td class="bckgcolor-lghtred">' + RetailBudgetPro.Budget.auditChanges[0][i] + '</td>';
        else activityhtml += '<td class="bckgcolor-drkred">' + RetailBudgetPro.Budget.auditChanges[0][i] + '</td>';
    });

    activityhtml += "</tr><tr><td class='bckgcolor-lghtgreen custom-font-wt'>Now</td>";

    $.grep(RetailBudgetPro.Budget.auditChanges[1], function (v, i) {
        if (RetailBudgetPro.Budget.auditChanges[0][i] == RetailBudgetPro.Budget.auditChanges[1][i]) activityhtml += '<td class="bckgcolor-lghtgreen">' + RetailBudgetPro.Budget.auditChanges[1][i] + '</td>';
        else activityhtml += '<td class="bckgcolor-drkgreen">' + RetailBudgetPro.Budget.auditChanges[1][i] + '</td>';
    });

    activityhtml += "</tr";

    var periodsHead = RetailBudgetPro.Budget.auditChanges[0].length == 14 ? "<th>P13</th>" : "";

    var activityData = "<span>Category '{CatDesc}' was updated for " + $('#hdnStoreName').val() + " '{StoreDesc}' (" + $('#hdnBudgetName').val() + " - " + $('#hdnBudgetYear').val() + ")</span><a class='linkToDataPage' data-catid='" + $($parentTr).find('#hdnCatUID').html() + "' data-storeid='" + $($parentTr).find('#hdnStoreUID').html() + "' data-budId='" + $('#hdnBudgetUID').val() + "' data-year='" + $('#hdnBudgetYear').val() + "' target='_blank' href='/Budget/DataInput/" + $('#hdnBudgetUID').val() + "/" + $('#hdnBudgetYear').val() + "'><i title='View Data' class='fa fa-search'></i></a><a class='showhidedetails'><i title='Expand' class='fa fa-plus-circle'></i></a><div class='toggle-details' style='display:none;'><table class='detail-changes'><thead><tr><th></th><th>" + $('#period01Alias').val() + "</th><th>" + $('#period02Alias').val() + "</th><th>" + $('#period03Alias').val() + "</th><th>" + $('#period04Alias').val() + "</th><th>" + $('#period05Alias').val() + "</th><th>" + $('#period06Alias').val() + "</th><th>" + $('#period07Alias').val() + "</th><th>" + $('#period08Alias').val() + "</th><th>" + $('#period09Alias').val() + "</th><th>" + $('#period10Alias').val() + "</th><th>" + $('#period11Alias').val() + "</th><th>" + $('#period12Alias').val() + "</th>" + periodsHead + "<th>Totals</th></tr></thead><tbody>" + activityhtml + "</tbody></table></div></td>";

    $.ajax({
        url: '/User/SavePLElementActivity',
        type: 'post',
        async: true,
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({ activityData: activityData, CatId: parseFloat($($parentTr).find('#hdnCatUID').html()), StoreId: parseFloat($($parentTr).find('#hdnStoreUID').html()) }),
        success: function (result) {
        },
        error: function (er) {
            console.log(er);
        }
    });
}

function SaveRelatedCategoryDataValidation(popUpId) {
    var cumVal = [];
    var result = 0;

    if ($(popUpId).find('.popup-foa-type').val() == "Eli") {
        $(popUpId).find('.store-data-row').has('.locationRowCheck:checked').each(function () {
            if (cumVal.length == 0) {
                $(this).find('.yellowBckgTxtBx').each(function () {
                    cumVal.push(parseInt($(this).val()));
                });
            }
            else {
                var i = 0;
                $(this).find('.yellowBckgTxtBx').each(function () {
                    cumVal[i] = parseInt(cumVal[i]) + parseInt($(this).val());
                    i += 1;
                });
            }
        });

        for (var j = 0 ; j < cumVal.length ; j++) {
            if (cumVal[j] > 1) {
                $(popUpId).find('.formula-store-error span').text("*Distribution percent for a period cannot be more than 100%.");
                $(popUpId).find('.formula-store-error').removeClass('hide');
                result = -1;
                return result;
            }
        }
    }

    else if ($(popUpId).find('.popup-foa-type').val() == "Div") {
        $(popUpId).find('.store-data-row').has('.locationRowCheck:checked').each(function () {
            $(this).find('.yellowBckgTxtBx').each(function () {
                if ($(this).val().trim() == "" || $(this).val().trim() == "0") {
                    $(popUpId).find('.formula-store-error span').text("*With Formula type division distribution store values cannot be 0 or empty.");
                    $(popUpId).find('.formula-store-error').removeClass('hide');
                    result = -1;
                    return result;
                }

            });
        });
    }
    return result;
}

function UpdateStoreLevelNetSales() {
    //$parentTr
}

var CheckForUniqueRows = function (divClass, $modal) {

    var flag = 0;
   
    $modal.find('.' + divClass + ' table tr.store-childData-row').each(function () {

        var $this = $(this);

        var thisVenVal = $this.find('[name$="VendorUID"] option:selected').val();

        flag = $(this).prevAll('tr.store-data-row').eq(0).nextUntil('tr.store-data-row').not('tr[id="' + $(this).attr('id') + '"][data-rownum="' + $(this).attr('data-rownum') + '"]')
                      .filter(function () {
                          return ($(this).find('[name$="VendorUID"] option:selected').val() == thisVenVal)
                      }).length

        if (flag > 0) return false
    })

    return (flag != 0);
}

function DistributeAnnualSalary(ModalId) {
    var $currentTr = $(ModalId).parents('tr');
    if ($(ModalId).find('[name="EmployeePayroll.AnnualSalaryAmount"]').length > 0) {
        var annualSalaryVal = $(ModalId).find('[name="EmployeePayroll.AnnualSalaryAmount"]').val().replace(/,/g, "");
        var monthSalVal = (annualSalaryVal / 12);
        $(ModalId).find('[name=P01Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP01"]').val())))));
        $(ModalId).find('[name=P02Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP02"]').val())))));
        $(ModalId).find('[name=P03Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP03"]').val())))));
        $(ModalId).find('[name=P04Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP04"]').val())))));
        $(ModalId).find('[name=P05Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP05"]').val())))));
        $(ModalId).find('[name=P06Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP06"]').val())))));
        $(ModalId).find('[name=P07Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP07"]').val())))));
        $(ModalId).find('[name=P08Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP08"]').val())))));
        $(ModalId).find('[name=P09Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP09"]').val())))));
        $(ModalId).find('[name=P10Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP10"]').val())))));
        $(ModalId).find('[name=P11Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP11"]').val())))));

        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {
            $(ModalId).find('[name=P12Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP12"]').val())))));
            $(ModalId).find('[name=P13Salary]').val(0);
        }
        else {
            $(ModalId).find('[name=P12Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP12"]').val())))));
            $(ModalId).find('[name=P13Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP13"]').val())))));
        }
       
        var valueP01 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(0).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P01Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(0).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP01"]').val())), getDecimalPlaces($currentTr));
        var valueP02 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(1).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P02Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(1).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP02"]').val())), getDecimalPlaces($currentTr));
        var valueP03 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(2).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P03Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(2).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP03"]').val())), getDecimalPlaces($currentTr));
        var valueP04 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(3).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P04Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(3).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP04"]').val())), getDecimalPlaces($currentTr));
        var valueP05 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(4).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P05Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(4).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP05"]').val())), getDecimalPlaces($currentTr));
        var valueP06 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(5).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P06Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(5).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP06"]').val())), getDecimalPlaces($currentTr));
        var valueP07 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(6).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P07Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(6).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP07"]').val())), getDecimalPlaces($currentTr));
        var valueP08 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(7).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P08Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(7).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP08"]').val())), getDecimalPlaces($currentTr));
        var valueP09 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(8).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P09Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(8).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP09"]').val())), getDecimalPlaces($currentTr));
        var valueP10 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(9).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P10Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(9).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP10"]').val())), getDecimalPlaces($currentTr));
        var valueP11 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(10).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P11Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(10).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP11"]').val())), getDecimalPlaces($currentTr));
        var valueP12 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(11).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P12Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(11).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP12"]').val())), getDecimalPlaces($currentTr));
        var valueP13 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(12).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P13Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(12).find('[type="text"]').val())) / (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row [name = "FinalRowData.FXRateP13"]').val())), getDecimalPlaces($currentTr));

        var total = valueP01 + valueP02 + valueP03 + valueP04 + valueP05 + valueP06 + valueP07 + valueP08 + valueP09 + valueP10 + valueP11 + valueP12 + valueP13;
        console.log(total);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(0).find('[type="text"]').attr('data-currentvalue', valueP01).val(valueP01);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(1).find('[type="text"]').attr('data-currentvalue', valueP02).val(valueP02);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(2).find('[type="text"]').attr('data-currentvalue', valueP03).val(valueP03);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(3).find('[type="text"]').attr('data-currentvalue', valueP04).val(valueP04);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(4).find('[type="text"]').attr('data-currentvalue', valueP05).val(valueP05);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(5).find('[type="text"]').attr('data-currentvalue', valueP06).val(valueP06);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(6).find('[type="text"]').attr('data-currentvalue', valueP07).val(valueP07);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(7).find('[type="text"]').attr('data-currentvalue', valueP08).val(valueP08);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(8).find('[type="text"]').attr('data-currentvalue', valueP09).val(valueP09);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(9).find('[type="text"]').attr('data-currentvalue', valueP10).val(valueP10);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(10).find('[type="text"]').attr('data-currentvalue', valueP11).val(valueP11);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(11).find('[type="text"]').attr('data-currentvalue', valueP12).val(valueP12);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(12).find('[type="text"]').attr('data-currentvalue', valueP13).val(valueP13);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').find('[type="text"][title = "Total"]').val(total);

        //for allocation Percent Calculation

        var enabledPeriods = 0;
        var totalPVal = 0
        var totalAvgPVal = 0

        var $td = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage')

        enabledPeriods = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage [type=text]:not([name$="StorePercentTotal"]):not(.removeBackgndColor)').length

        $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage [type=text]:not([name$="StorePercentTotal"]):not(.removeBackgndColor)').map(function () {
            return totalPVal += Number($(this).val() == "" ? 0 : $(this).val());
        })

        totalAvgPVal = enabledPeriods == 0 ? 0 : totalPVal / enabledPeriods;

        $td.find('[type=text][name$="StorePercentTotal"]').val(totalAvgPVal.toLocaleString('en'));
    }
}

function DistributeAnnualSalaryForParentEmp(ModalId) {
    
    if ($(ModalId).find('[name="EmployeePayroll.AnnualSalaryAmount"]').length > 0) {

        var annualSalaryVal = $(ModalId).find('[name="EmployeePayroll.AnnualSalaryAmount"]').val().replace(/,/g, "");
        var monthSalVal = (annualSalaryVal / 12);
        var periods = RetailBudgetPro.Budget.numberOfPeriodsVal;

        $(ModalId).find('[name=P01Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP01"]').val())))));
        $(ModalId).find('[name=P02Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP02"]').val())))));
        $(ModalId).find('[name=P03Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP03"]').val())))));
        $(ModalId).find('[name=P04Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP04"]').val())))));
        $(ModalId).find('[name=P05Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP05"]').val())))));
        $(ModalId).find('[name=P06Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP06"]').val())))));
        $(ModalId).find('[name=P07Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP07"]').val())))));
        $(ModalId).find('[name=P08Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP08"]').val())))));
        $(ModalId).find('[name=P09Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP09"]').val())))));
        $(ModalId).find('[name=P10Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP10"]').val())))));
        $(ModalId).find('[name=P11Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP11"]').val())))));

        if ( RetailBudgetPro.Budget.numberOfPeriodsVal == 12) {
            $(ModalId).find('[name=P12Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP12"]').val())))));
            $(ModalId).find('[name=P13Salary]').val(0);
        }
        else {
            $(ModalId).find('[name=P12Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP12"]').val())))));
            $(ModalId).find('[name=P13Salary]').val((monthSalVal * (1 + (Number($(ModalId).find('[name="EmpPayrollGrowthData.GrowthStoreP13"]').val())))));
        }

        var catDecimalPlaces = 3;

        var $tr = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row')

        var storeUID = $tr.find('[type=hidden][name$=StoreUID]').val();

        var enabledPeriods = 0;
        var totalAvgPVal = 0

        var childValP1 = 0
        var childValP2 = 0
        var childValP3 = 0
        var childValP4 = 0
        var childValP5 = 0
        var childValP6 = 0
        var childValP7 = 0
        var childValP8 = 0
        var childValP9 = 0
        var childValP10 = 0
        var childValP11 = 0
        var childValP12 = 0
        var childValP13 = 0
        var childTotalValP1 = 0
        var childTotalValP2 = 0
        var childTotalValP3 = 0
        var childTotalValP4 = 0
        var childTotalValP5 = 0
        var childTotalValP6 = 0
        var childTotalValP7 = 0
        var childTotalValP8 = 0
        var childTotalValP9 = 0
        var childTotalValP10 = 0
        var childTotalValP11 = 0
        var childTotalValP12 = 0
        var childTotalValP13 = 0
        var FXRateP01 = $tr.find('[name$="FXRateP01"]').val()
        var FXRateP02 = $tr.find('[name$="FXRateP02"]').val()
        var FXRateP03 = $tr.find('[name$="FXRateP03"]').val()
        var FXRateP04 = $tr.find('[name$="FXRateP04"]').val()
        var FXRateP05 = $tr.find('[name$="FXRateP05"]').val()
        var FXRateP06 = $tr.find('[name$="FXRateP06"]').val()
        var FXRateP07 = $tr.find('[name$="FXRateP07"]').val()
        var FXRateP08 = $tr.find('[name$="FXRateP08"]').val()
        var FXRateP09 = $tr.find('[name$="FXRateP09"]').val()
        var FXRateP10 = $tr.find('[name$="FXRateP10"]').val()
        var FXRateP11 = $tr.find('[name$="FXRateP11"]').val()
        var FXRateP12 = $tr.find('[name$="FXRateP12"]').val()
        var FXRateP13 = $tr.find('[name$="FXRateP13"]').val()

        enabledPeriods = $tr.find('.percentage [type=text]:not(.removeBackgndColor)').length - 1;

        $(ModalId).find('.allocationSalaryCheck tbody tr[id=' + storeUID + ']').each(function () {

            var $childTr = $(this)
            var $childModalTr = $(ModalId).find('.allocationSalaryDollarCheck tbody tr[id=' + storeUID + '][data-rownum=' + $childTr.attr('data-rownum') + ']');

            var childTotalPVal = 0
            var childTotalAvgPVal = 0

            $childTr.find('.percentage [type=text]:not(.removeBackgndColor):not([name$="StorePercentTotal"])').map(function () {
                return childTotalPVal += Number(parseFloat($(this).val() == "" ? 0 : $(this).val()).toFixed(3));
            })

            childTotalAvgPVal = enabledPeriods == 0 ? 0 : childTotalPVal / enabledPeriods;

            $childTr.find('[type=text][name$="StorePercentTotal"]').val(childTotalAvgPVal.toLocaleString('en'));

            totalAvgPVal += childTotalAvgPVal;

            childValP1 = Number($childTr.find('[type=text][name$="StorePercentP01"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP01"]').val() / FXRateP01)
            childValP2 = Number($childTr.find('[type=text][name$="StorePercentP02"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP02"]').val() / FXRateP02)
            childValP3 = Number($childTr.find('[type=text][name$="StorePercentP03"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP03"]').val() / FXRateP03)
            childValP4 = Number($childTr.find('[type=text][name$="StorePercentP04"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP04"]').val() / FXRateP04)
            childValP5 = Number($childTr.find('[type=text][name$="StorePercentP05"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP05"]').val() / FXRateP05)
            childValP6 = Number($childTr.find('[type=text][name$="StorePercentP06"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP06"]').val() / FXRateP06)
            childValP7 = Number($childTr.find('[type=text][name$="StorePercentP07"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP07"]').val() / FXRateP07)
            childValP8 = Number($childTr.find('[type=text][name$="StorePercentP08"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP08"]').val() / FXRateP08)
            childValP9 = Number($childTr.find('[type=text][name$="StorePercentP09"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP09"]').val() / FXRateP09)
            childValP10 = Number($childTr.find('[type=text][name$="StorePercentP10"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP10"]').val() / FXRateP10)
            childValP11 = Number($childTr.find('[type=text][name$="StorePercentP11"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP11"]').val() / FXRateP11)
            childValP12 = Number($childTr.find('[type=text][name$="StorePercentP12"]').val() == "" ? 0 : $childTr.find('[type=text][name$="StorePercentP12"]').val() / FXRateP12)
            childValP13 = Number(($childTr.find('[type=text][name$="StorePercentP13"]').val() == "" || periods == 12) ? 0 : $childTr.find('[type=text][name$="StorePercentP13"]').val() / FXRateP13)

            childTotalValP1 += childValP1
            childTotalValP2 += childValP2
            childTotalValP3 += childValP3
            childTotalValP4 += childValP4
            childTotalValP5 += childValP5
            childTotalValP6 += childValP6
            childTotalValP7 += childValP7
            childTotalValP8 += childValP8
            childTotalValP9 += childValP9
            childTotalValP10 += childValP10
            childTotalValP11 += childValP11
            childTotalValP12 += childValP12
            childTotalValP13 += childValP13

            childValP1 = Number((childValP1 * $(ModalId).find('[name=P01Salary]').val()).toFixed(catDecimalPlaces));
            childValP2 = Number((childValP2 * $(ModalId).find('[name=P02Salary]').val()).toFixed(catDecimalPlaces));
            childValP3 = Number((childValP3 * $(ModalId).find('[name=P03Salary]').val()).toFixed(catDecimalPlaces));
            childValP4 = Number((childValP4 * $(ModalId).find('[name=P04Salary]').val()).toFixed(catDecimalPlaces));
            childValP5 = Number((childValP5 * $(ModalId).find('[name=P05Salary]').val()).toFixed(catDecimalPlaces));
            childValP6 = Number((childValP6 * $(ModalId).find('[name=P06Salary]').val()).toFixed(catDecimalPlaces));
            childValP7 = Number((childValP7 * $(ModalId).find('[name=P07Salary]').val()).toFixed(catDecimalPlaces));
            childValP8 = Number((childValP8 * $(ModalId).find('[name=P08Salary]').val()).toFixed(catDecimalPlaces));
            childValP9 = Number((childValP9 * $(ModalId).find('[name=P09Salary]').val()).toFixed(catDecimalPlaces));
            childValP10 = Number((childValP10 * $(ModalId).find('[name=P10Salary]').val()).toFixed(catDecimalPlaces));
            childValP11 = Number((childValP11 * $(ModalId).find('[name=P11Salary]').val()).toFixed(catDecimalPlaces));
            childValP12 = Number((childValP12 * $(ModalId).find('[name=P12Salary]').val()).toFixed(catDecimalPlaces));
            childValP13 = Number((childValP13 * $(ModalId).find('[name=P13Salary]').val()).toFixed(catDecimalPlaces));

            $childModalTr.find('[type=text][name$="StoreValP01"]').attr('data-currentvalue', childValP1).val(childValP1.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP02"]').attr('data-currentvalue', childValP2).val(childValP2.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP03"]').attr('data-currentvalue', childValP3).val(childValP3.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP04"]').attr('data-currentvalue', childValP4).val(childValP4.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP05"]').attr('data-currentvalue', childValP5).val(childValP5.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP06"]').attr('data-currentvalue', childValP6).val(childValP6.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP07"]').attr('data-currentvalue', childValP7).val(childValP7.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP08"]').attr('data-currentvalue', childValP8).val(childValP8.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP09"]').attr('data-currentvalue', childValP9).val(childValP9.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP10"]').attr('data-currentvalue', childValP10).val(childValP10.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP11"]').attr('data-currentvalue', childValP11).val(childValP11.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP12"]').attr('data-currentvalue', childValP12).val(childValP12.toLocaleString('en'));
            $childModalTr.find('[type=text][name$="StoreValP13"]').attr('data-currentvalue', childValP13).val(childValP13.toLocaleString('en'));

            var childRowTotal = childValP1 + childValP2 + childValP3 + childValP4 + childValP5 + childValP6 + childValP7 + childValP8 + childValP9 + childValP10 + childValP11 + childValP12 + childValP13;

            $childModalTr.find('[type=text][name$="StoreValTotal"]').attr('data-currentvalue', childRowTotal).val(childRowTotal.toLocaleString('en'));

        })

        $tr.find('[type=text][name$="StorePercentP01"]').val(childTotalValP1.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP02"]').val(childTotalValP2.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP03"]').val(childTotalValP3.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP04"]').val(childTotalValP4.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP05"]').val(childTotalValP5.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP06"]').val(childTotalValP6.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP07"]').val(childTotalValP7.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP08"]').val(childTotalValP8.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP09"]').val(childTotalValP9.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP10"]').val(childTotalValP10.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP11"]').val(childTotalValP11.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP12"]').val(childTotalValP12.toFixed(catDecimalPlaces))
        $tr.find('[type=text][name$="StorePercentP13"]').val(childTotalValP13.toFixed(catDecimalPlaces))

        $tr.find('[type=text][name$="StorePercentTotal"]').val(totalAvgPVal.toLocaleString('en'));

        //for allocation dollar Calculation
        var valueP01 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(0).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P01Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(0).find('[type="text"]').val())), catDecimalPlaces);
        var valueP02 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(1).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P02Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(1).find('[type="text"]').val())), catDecimalPlaces);
        var valueP03 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(2).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P03Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(2).find('[type="text"]').val())), catDecimalPlaces);
        var valueP04 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(3).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P04Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(3).find('[type="text"]').val())), catDecimalPlaces);
        var valueP05 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(4).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P05Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(4).find('[type="text"]').val())), catDecimalPlaces);
        var valueP06 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(5).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P06Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(5).find('[type="text"]').val())), catDecimalPlaces);
        var valueP07 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(6).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P07Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(6).find('[type="text"]').val())), catDecimalPlaces);
        var valueP08 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(7).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P08Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(7).find('[type="text"]').val())), catDecimalPlaces);
        var valueP09 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(8).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P09Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(8).find('[type="text"]').val())), catDecimalPlaces);
        var valueP10 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(9).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P10Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(9).find('[type="text"]').val())), catDecimalPlaces);
        var valueP11 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(10).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P11Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(10).find('[type="text"]').val())), catDecimalPlaces);
        var valueP12 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(11).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P12Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(11).find('[type="text"]').val())), catDecimalPlaces);
        var valueP13 = $(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(12).find('[type="text"]').hasClass('removeBackgndColor') ? 0 : Math.round(Number($(ModalId).find('[name=P13Salary]').val()) * (Number($(ModalId).find('.allocationSalaryCheck table tbody tr.store-data-row td.percentage').eq(12).find('[type="text"]').val())), catDecimalPlaces);

        var total = valueP01 + valueP02 + valueP03 + valueP04 + valueP05 + valueP06 + valueP07 + valueP08 + valueP09 + valueP10 + valueP11 + valueP12 + valueP13;
        
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(0).find('[type="text"]').attr('data-currentvalue', valueP01).val(valueP01);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(1).find('[type="text"]').attr('data-currentvalue', valueP02).val(valueP02);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(2).find('[type="text"]').attr('data-currentvalue', valueP03).val(valueP03);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(3).find('[type="text"]').attr('data-currentvalue', valueP04).val(valueP04);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(4).find('[type="text"]').attr('data-currentvalue', valueP05).val(valueP05);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(5).find('[type="text"]').attr('data-currentvalue', valueP06).val(valueP06);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(6).find('[type="text"]').attr('data-currentvalue', valueP07).val(valueP07);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(7).find('[type="text"]').attr('data-currentvalue', valueP08).val(valueP08);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(8).find('[type="text"]').attr('data-currentvalue', valueP09).val(valueP09);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(9).find('[type="text"]').attr('data-currentvalue', valueP10).val(valueP10);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(10).find('[type="text"]').attr('data-currentvalue', valueP11).val(valueP11);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(11).find('[type="text"]').attr('data-currentvalue', valueP12).val(valueP12);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').eq(12).find('[type="text"]').attr('data-currentvalue', valueP13).val(valueP13);
        $(ModalId).find('.allocationSalaryDollarCheck table tbody tr.store-data-row td.data').find('[type="text"][title="Total"]').val(total);
    }

}

function CalculateRateGrowth(ModalId) {
    if ($(ModalId).find('[name="EmployeePayroll.CompType"]').val() == "S") {
        $(ModalId).find('.overtimeSalaryRateCheck table tbody tr').each(function () {
            var $this = $(this);
            $this.find('[type=text][name$="StoreValP01"]').val(Number($this.find('[type=text][name$="StoreValP01"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP01"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP02"]').val(Number($this.find('[type=text][name$="StoreValP02"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP02"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP03"]').val(Number($this.find('[type=text][name$="StoreValP03"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP03"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP04"]').val(Number($this.find('[type=text][name$="StoreValP04"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP04"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP05"]').val(Number($this.find('[type=text][name$="StoreValP05"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP05"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP06"]').val(Number($this.find('[type=text][name$="StoreValP06"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP06"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP07"]').val(Number($this.find('[type=text][name$="StoreValP07"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP07"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP08"]').val(Number($this.find('[type=text][name$="StoreValP08"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP08"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP09"]').val(Number($this.find('[type=text][name$="StoreValP09"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP09"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP10"]').val(Number($this.find('[type=text][name$="StoreValP10"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP10"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP11"]').val(Number($this.find('[type=text][name$="StoreValP11"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP11"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP12"]').val(Number($this.find('[type=text][name$="StoreValP12"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP12"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP13"]').val(Number($this.find('[type=text][name$="StoreValP13"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP13"]').data('currentvalue')))));
        });
    }
    else {
        $(ModalId).find('.allocationHourlyRateCheck table tbody tr').each(function () {
            var $this = $(this);
            $this.find('[type=text][name$="StoreValP01"]').val(Number($this.find('[type=text][name$="StoreValP01"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP01"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP02"]').val(Number($this.find('[type=text][name$="StoreValP02"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP02"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP03"]').val(Number($this.find('[type=text][name$="StoreValP03"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP03"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP04"]').val(Number($this.find('[type=text][name$="StoreValP04"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP04"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP05"]').val(Number($this.find('[type=text][name$="StoreValP05"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP05"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP06"]').val(Number($this.find('[type=text][name$="StoreValP06"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP06"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP07"]').val(Number($this.find('[type=text][name$="StoreValP07"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP07"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP08"]').val(Number($this.find('[type=text][name$="StoreValP08"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP08"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP09"]').val(Number($this.find('[type=text][name$="StoreValP09"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP09"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP10"]').val(Number($this.find('[type=text][name$="StoreValP10"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP10"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP11"]').val(Number($this.find('[type=text][name$="StoreValP11"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP11"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP12"]').val(Number($this.find('[type=text][name$="StoreValP12"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP12"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP13"]').val(Number($this.find('[type=text][name$="StoreValP13"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP13"]').data('currentvalue')))));
        });

        $(ModalId).find('.overtimeHourlyRateCheck table tbody tr').each(function () {
            var $this = $(this);
            $this.find('[type=text][name$="StoreValP01"]').val(Number($this.find('[type=text][name$="StoreValP01"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP01"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP02"]').val(Number($this.find('[type=text][name$="StoreValP02"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP02"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP03"]').val(Number($this.find('[type=text][name$="StoreValP03"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP03"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP04"]').val(Number($this.find('[type=text][name$="StoreValP04"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP04"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP05"]').val(Number($this.find('[type=text][name$="StoreValP05"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP05"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP06"]').val(Number($this.find('[type=text][name$="StoreValP06"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP06"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP07"]').val(Number($this.find('[type=text][name$="StoreValP07"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP07"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP08"]').val(Number($this.find('[type=text][name$="StoreValP08"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP08"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP09"]').val(Number($this.find('[type=text][name$="StoreValP09"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP09"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP10"]').val(Number($this.find('[type=text][name$="StoreValP10"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP10"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP11"]').val(Number($this.find('[type=text][name$="StoreValP11"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP11"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP12"]').val(Number($this.find('[type=text][name$="StoreValP12"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP12"]').data('currentvalue')))));
            $this.find('[type=text][name$="StoreValP13"]').val(Number($this.find('[type=text][name$="StoreValP13"]').data('currentvalue')) * (1 + (Number($(ModalId).find('.allocationRaiseTable [name="EmpPayrollGrowthData.GrowthStoreP13"]').data('currentvalue')))));
        });
    }
}

function FreezeDataInputTable() {

    $('#fixed-table-container-datasheetTable').find('thead, tbody, tr, th, td').not('[id*="hdn"]').not('[id*="STCComp"]').removeAttr('style');

    fixTable(document.getElementById('fixed-table-container-datasheetTable'));
}

function ConverToLocalDateTime(container, date) {

    //var month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    container.find('.comment-details').each(function () {

        if ($(this).find('#isDateUpdated').val() == "False") {

            var localDate = $(this).find('.commented-on').attr('data-datetimefromserver');

            //var zone = new Date().toLocaleTimeString('en-us', { timeZoneName: 'short' }).split(' ')[2];

            //var newDateVal = date == undefined ? new Date(("0" + localDate.substring(3, 5)).slice(-2) + "-" + ("0" + localDate.substring(0, 2)).slice(-2) + localDate.substring(5) + " " + zone) : date;

            //var hours = newDateVal.getHours();
            //var minutes = newDateVal.getMinutes();
            //var ampm = hours >= 12 ? 'PM' : 'AM';
            //hours = hours % 12;
            //hours = hours ? hours : 12; // the hour '0' should be '12'
            //minutes = minutes < 10 ? '0' + minutes : minutes;

            var returnDateVal = RetailBudgetPro.Layout.ConvertToLocalDateTime(localDate);

            $(this).find('.commented-on').html(returnDateVal);
            $(this).find('#isDateUpdated').val("True");
        }
    });
}

function GetOrdinalValue(value) {

    if (value <= 0) return value.ToString();

    switch (value % 100) {
        case 11:
        case 12:
        case 13:
            return value + "th";
    }

    switch (value % 10) {
        case 1:
            return value + "st";
        case 2:
            return value + "nd";
        case 3:
            return value + "rd";
        default:
            return value + "th";
    }
}

;
/**
 * Bootstrap Multiselect (https://github.com/davidstutz/bootstrap-multiselect)
 * 
 * Apache License, Version 2.0:
 * Copyright (c) 2012 - 2015 David Stutz
 * 
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a
 * copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 * 
 * BSD 3-Clause License:
 * Copyright (c) 2012 - 2015 David Stutz
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *    - Redistributions of source code must retain the above copyright notice,
 *      this list of conditions and the following disclaimer.
 *    - Redistributions in binary form must reproduce the above copyright notice,
 *      this list of conditions and the following disclaimer in the documentation
 *      and/or other materials provided with the distribution.
 *    - Neither the name of David Stutz nor the names of its contributors may be
 *      used to endorse or promote products derived from this software without
 *      specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
!function ($) {
    "use strict";// jshint ;_;
    if (typeof ko !== 'undefined' && ko.bindingHandlers && !ko.bindingHandlers.multiselect) {
        ko.bindingHandlers.multiselect = {
            after: ['options', 'value', 'selectedOptions'],

            init: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
                var $element = $(element);
                var config = ko.toJS(valueAccessor());

                $element.multiselect(config);

                if (allBindings.has('options')) {
                    var options = allBindings.get('options');
                    if (ko.isObservable(options)) {
                        ko.computed({
                            read: function () {
                                options();
                                setTimeout(function () {
                                    var ms = $element.data('multiselect');
                                    if (ms)
                                        ms.updateOriginalOptions();//Not sure how beneficial this is.
                                    $element.multiselect('rebuild');
                                }, 1);
                            },
                            disposeWhenNodeIsRemoved: element
                        });
                    }
                }

                //value and selectedOptions are two-way, so these will be triggered even by our own actions.
                //It needs some way to tell if they are triggered because of us or because of outside change.
                //It doesn't loop but it's a waste of processing.
                if (allBindings.has('value')) {
                    var value = allBindings.get('value');
                    if (ko.isObservable(value)) {
                        ko.computed({
                            read: function () {
                                value();
                                setTimeout(function () {
                                    $element.multiselect('refresh');
                                }, 1);
                            },
                            disposeWhenNodeIsRemoved: element
                        }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                    }
                }

                //Switched from arrayChange subscription to general subscription using 'refresh'.
                //Not sure performance is any better using 'select' and 'deselect'.
                if (allBindings.has('selectedOptions')) {
                    var selectedOptions = allBindings.get('selectedOptions');
                    if (ko.isObservable(selectedOptions)) {
                        ko.computed({
                            read: function () {
                                selectedOptions();
                                setTimeout(function () {
                                    $element.multiselect('refresh');
                                }, 1);
                            },
                            disposeWhenNodeIsRemoved: element
                        }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                    }
                }

                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $element.multiselect('destroy');
                });
            },

            update: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
                var $element = $(element);
                var config = ko.toJS(valueAccessor());

                $element.multiselect('setOptions', config);
                $element.multiselect('rebuild');
            }
        };
    }

    function forEach(array, callback) {
        for (var index = 0; index < array.length; ++index) {
            callback(array[index], index);
        }
    }

    /**
     * Constructor to create a new multiselect using the given select.
     *
     * @param {jQuery} select
     * @param {Object} options
     * @returns {Multiselect}
     */
    function Multiselect(select, options) {

        this.$select = $(select);

        // Placeholder via data attributes
        if (this.$select.attr("data-placeholder")) {
            options.nonSelectedText = this.$select.data("placeholder");
        }

        this.options = this.mergeOptions($.extend({}, options, this.$select.data()));

        // Initialization.
        // We have to clone to create a new reference.
        this.originalOptions = this.$select.clone()[0].options;
        this.query = '';
        this.searchTimeout = null;
        this.lastToggledInput = null

        this.options.multiple = this.$select.attr('multiple') === "multiple";
        this.options.onChange = $.proxy(this.options.onChange, this);
        this.options.onDropdownShow = $.proxy(this.options.onDropdownShow, this);
        this.options.onDropdownHide = $.proxy(this.options.onDropdownHide, this);
        this.options.onDropdownShown = $.proxy(this.options.onDropdownShown, this);
        this.options.onDropdownHidden = $.proxy(this.options.onDropdownHidden, this);

        // Build select all if enabled.
        this.buildContainer();
        this.buildButton();
        this.buildDropdown();
        this.buildSelectAll();
        this.buildDropdownOptions();
        this.buildFilter();

        this.updateButtonText();
        this.updateSelectAll();

        if (this.options.disableIfEmpty && $('option', this.$select).length <= 0) {
            this.disable();
        }

        this.$select.hide().after(this.$container);
    };

    Multiselect.prototype = {

        defaults: {
            /**
             * Default text function will either print 'None selected' in case no
             * option is selected or a list of the selected options up to a length
             * of 3 selected options.
             * 
             * @param {jQuery} options
             * @param {jQuery} select
             * @returns {String}
             */
            buttonText: function (options, select) {
                if (options.length === 0) {
                    return this.nonSelectedText;
                }
                else if (this.allSelectedText
                            && options.length === $('option', $(select)).length
                            && $('option', $(select)).length !== 1
                            && this.multiple) {

                    if (this.selectAllNumber) {
                        return this.allSelectedText + ' (' + options.length + ')';
                    }
                    else {
                        return this.allSelectedText;
                    }
                }
                else if (options.length > this.numberDisplayed) {
                    return options.length + ' ' + this.nSelectedText;
                }
                else {
                    var selected = '';
                    var delimiter = this.delimiterText;

                    options.each(function () {
                        var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).text();
                        selected += label + delimiter;
                    });

                    return selected.substr(0, selected.length - 2);
                }
            },
            /**
             * Updates the title of the button similar to the buttonText function.
             * 
             * @param {jQuery} options
             * @param {jQuery} select
             * @returns {@exp;selected@call;substr}
             */
            buttonTitle: function (options, select) {
                if (options.length === 0) {
                    return this.nonSelectedText;
                }
                else {
                    var selected = '';
                    var delimiter = this.delimiterText;

                    options.each(function () {
                        var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).text();
                        selected += label + delimiter;
                    });
                    return selected.substr(0, selected.length - 2);
                }
            },
            /**
             * Create a label.
             *
             * @param {jQuery} element
             * @returns {String}
             */
            optionLabel: function (element) {
                return $(element).attr('label') || $(element).text();
            },
            /**
             * Triggered on change of the multiselect.
             * 
             * Not triggered when selecting/deselecting options manually.
             * 
             * @param {jQuery} option
             * @param {Boolean} checked
             */
            onChange: function (option, checked) {

            },
            /**
             * Triggered when the dropdown is shown.
             *
             * @param {jQuery} event
             */
            onDropdownShow: function (event) {

            },
            /**
             * Triggered when the dropdown is hidden.
             *
             * @param {jQuery} event
             */
            onDropdownHide: function (event) {

            },
            /**
             * Triggered after the dropdown is shown.
             * 
             * @param {jQuery} event
             */
            onDropdownShown: function (event) {

            },
            /**
             * Triggered after the dropdown is hidden.
             * 
             * @param {jQuery} event
             */
            onDropdownHidden: function (event) {

            },
            /**
             * Triggered on select all.
             */
            onSelectAll: function () {

            },
            enableHTML: false,
            buttonClass: 'btn btn-default',
            inheritClass: false,
            buttonWidth: 'auto',
            buttonContainer: '<div class="btn-group" />',
            dropRight: false,
            selectedClass: 'active',
            // Maximum height of the dropdown menu.
            // If maximum height is exceeded a scrollbar will be displayed.
            maxHeight: false,
            checkboxName: false,
            includeSelectAllOption: false,
            includeSelectAllIfMoreThan: 0,
            selectAllText: ' Select all',
            selectAllValue: 'multiselect-all',
            selectAllName: false,
            selectAllNumber: true,
            enableFiltering: false,
            enableCaseInsensitiveFiltering: false,
            enableClickableOptGroups: false,
            filterPlaceholder: 'Search',
            // possible options: 'text', 'value', 'both'
            filterBehavior: 'text',
            includeFilterClearBtn: true,
            preventInputChangeEvent: false,
            nonSelectedText: 'None selected',
            nSelectedText: 'selected',
            allSelectedText: 'All selected',
            numberDisplayed: 1,
            disableIfEmpty: false,
            delimiterText: ', ',
            templates: {
                button: '<button type="button" class="multiselect dropdown-toggle" data-toggle="dropdown"><span class="multiselect-selected-text"></span> <b class="caret"></b></button>',
                ul: '<ul class="multiselect-container dropdown-menu"></ul>',
                filter: '<li class="multiselect-item filter"><div class="input-group"><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span><input class="form-control multiselect-search" type="text"></div></li>',
                filterClearBtn: '<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="glyphicon glyphicon-remove-circle"></i></button></span>',
                li: '<li><a tabindex="0"><label></label></a></li>',
                divider: '<li class="multiselect-item divider"></li>',
                liGroup: '<li class="multiselect-item multiselect-group"><label></label></li>'
            }
        },

        constructor: Multiselect,

        /**
         * Builds the container of the multiselect.
         */
        buildContainer: function () {
            this.$container = $(this.options.buttonContainer);
            this.$container.on('show.bs.dropdown', this.options.onDropdownShow);
            this.$container.on('hide.bs.dropdown', this.options.onDropdownHide);
            this.$container.on('shown.bs.dropdown', this.options.onDropdownShown);
            this.$container.on('hidden.bs.dropdown', this.options.onDropdownHidden);
        },

        /**
         * Builds the button of the multiselect.
         */
        buildButton: function () {
            this.$button = $(this.options.templates.button).addClass(this.options.buttonClass);
            if (this.$select.attr('class') && this.options.inheritClass) {
                this.$button.addClass(this.$select.attr('class'));
            }
            // Adopt active state.
            if (this.$select.prop('disabled')) {
                this.disable();
            }
            else {
                this.enable();
            }

            // Manually add button width if set.
            if (this.options.buttonWidth && this.options.buttonWidth !== 'auto') {
                this.$button.css({
                    'width': this.options.buttonWidth,
                    'overflow': 'hidden',
                    'text-overflow': 'ellipsis'
                });
                this.$container.css({
                    'width': this.options.buttonWidth
                });
            }

            // Keep the tab index from the select.
            var tabindex = this.$select.attr('tabindex');
            if (tabindex) {
                this.$button.attr('tabindex', tabindex);
            }

            this.$container.prepend(this.$button);
        },

        /**
         * Builds the ul representing the dropdown menu.
         */
        buildDropdown: function () {

            // Build ul.
            this.$ul = $(this.options.templates.ul);

            if (this.options.dropRight) {
                this.$ul.addClass('pull-right');
            }

            // Set max height of dropdown menu to activate auto scrollbar.
            if (this.options.maxHeight) {
                // TODO: Add a class for this option to move the css declarations.
                this.$ul.css({
                    'max-height': this.options.maxHeight + 'px',
                    'overflow-y': 'auto',
                    'overflow-x': 'hidden'
                });
            }

            this.$container.append(this.$ul);
        },

        /**
         * Build the dropdown options and binds all nessecary events.
         * 
         * Uses createDivider and createOptionValue to create the necessary options.
         */
        buildDropdownOptions: function () {

            this.$select.children().each($.proxy(function (index, element) {

                var $element = $(element);
                // Support optgroups and options without a group simultaneously.
                var tag = $element.prop('tagName')
                    .toLowerCase();

                if ($element.prop('value') === this.options.selectAllValue) {
                    return;
                }

                if (tag === 'optgroup') {
                    this.createOptgroup(element);
                }
                else if (tag === 'option') {

                    if ($element.data('role') === 'divider') {
                        this.createDivider();
                    }
                    else {
                        this.createOptionValue(element);
                    }

                }

                // Other illegal tags will be ignored.
            }, this));

            // Bind the change event on the dropdown elements.
            $('li input', this.$ul).on('change', $.proxy(function (event) {
                var $target = $(event.target);

                var checked = $target.prop('checked') || false;
                var isSelectAllOption = $target.val() === this.options.selectAllValue;

                // Apply or unapply the configured selected class.
                if (this.options.selectedClass) {
                    if (checked) {
                        $target.closest('li')
                            .addClass(this.options.selectedClass);
                    }
                    else {
                        $target.closest('li')
                            .removeClass(this.options.selectedClass);
                    }
                }

                // Get the corresponding option.
                var value = $target.val();
                var $option = this.getOptionByValue(value);

                var $optionsNotThis = $('option', this.$select).not($option);
                var $checkboxesNotThis = $('input', this.$container).not($target);

                if (isSelectAllOption) {
                    if (checked) {
                        this.selectAll();
                    }
                    else {
                        this.deselectAll();
                    }
                }

                if (!isSelectAllOption) {
                    if (checked) {
                        $option.prop('selected', true);

                        if (this.options.multiple) {
                            // Simply select additional option.
                            $option.prop('selected', true);
                        }
                        else {
                            // Unselect all other options and corresponding checkboxes.
                            if (this.options.selectedClass) {
                                $($checkboxesNotThis).closest('li').removeClass(this.options.selectedClass);
                            }

                            $($checkboxesNotThis).prop('checked', false);
                            $optionsNotThis.prop('selected', false);

                            // It's a single selection, so close.
                            this.$button.click();
                        }

                        if (this.options.selectedClass === "active") {
                            $optionsNotThis.closest("a").css("outline", "");
                        }
                    }
                    else {
                        // Unselect option.
                        $option.prop('selected', false);
                    }
                }

                this.$select.change();

                this.updateButtonText();
                this.updateSelectAll();

                this.options.onChange($option, checked);

                if (this.options.preventInputChangeEvent) {
                    return false;
                }
            }, this));

            $('li a', this.$ul).on('mousedown', function (e) {
                if (e.shiftKey) {
                    // Prevent selecting text by Shift+click
                    return false;
                }
            });

            $('li a', this.$ul).on('touchstart click', $.proxy(function (event) {
                event.stopPropagation();

                var $target = $(event.target);

                if (event.shiftKey && this.options.multiple) {
                    if ($target.is("label")) { // Handles checkbox selection manually (see https://github.com/davidstutz/bootstrap-multiselect/issues/431)
                        event.preventDefault();
                        $target = $target.find("input");
                        $target.prop("checked", !$target.prop("checked"));
                    }
                    var checked = $target.prop('checked') || false;

                    if (this.lastToggledInput !== null && this.lastToggledInput !== $target) { // Make sure we actually have a range
                        var from = $target.closest("li").index();
                        var to = this.lastToggledInput.closest("li").index();

                        if (from > to) { // Swap the indices
                            var tmp = to;
                            to = from;
                            from = tmp;
                        }

                        // Make sure we grab all elements since slice excludes the last index
                        ++to;

                        // Change the checkboxes and underlying options
                        var range = this.$ul.find("li").slice(from, to).find("input");

                        range.prop('checked', checked);

                        if (this.options.selectedClass) {
                            range.closest('li')
                                .toggleClass(this.options.selectedClass, checked);
                        }

                        for (var i = 0, j = range.length; i < j; i++) {
                            var $checkbox = $(range[i]);

                            var $option = this.getOptionByValue($checkbox.val());

                            $option.prop('selected', checked);
                        }
                    }

                    // Trigger the select "change" event
                    $target.trigger("change");
                }

                // Remembers last clicked option
                if ($target.is("input") && !$target.closest("li").is(".multiselect-item")) {
                    this.lastToggledInput = $target;
                }

                $target.blur();
            }, this));

            // Keyboard support.
            this.$container.off('keydown.multiselect').on('keydown.multiselect', $.proxy(function (event) {
                if ($('input[type="text"]', this.$container).is(':focus')) {
                    return;
                }

                if (event.keyCode === 9 && this.$container.hasClass('open')) {
                    this.$button.click();
                }
                else {
                    var $items = $(this.$container).find("li:not(.divider):not(.disabled) a").filter(":visible");

                    if (!$items.length) {
                        return;
                    }

                    var index = $items.index($items.filter(':focus'));

                    // Navigation up.
                    if (event.keyCode === 38 && index > 0) {
                        index--;
                    }
                        // Navigate down.
                    else if (event.keyCode === 40 && index < $items.length - 1) {
                        index++;
                    }
                    else if (!~index) {
                        index = 0;
                    }

                    var $current = $items.eq(index);
                    $current.focus();

                    if (event.keyCode === 32 || event.keyCode === 13) {
                        var $checkbox = $current.find('input');

                        $checkbox.prop("checked", !$checkbox.prop("checked"));
                        $checkbox.change();
                    }

                    event.stopPropagation();
                    event.preventDefault();
                }
            }, this));

            if (this.options.enableClickableOptGroups && this.options.multiple) {
                $('li.multiselect-group', this.$ul).on('click', $.proxy(function (event) {
                    event.stopPropagation();

                    var group = $(event.target).parent();

                    // Search all option in optgroup
                    var $options = group.nextUntil('li.multiselect-group');
                    var $visibleOptions = $options.filter(":visible:not(.disabled)");

                    // check or uncheck items
                    var allChecked = true;
                    var optionInputs = $visibleOptions.find('input');
                    optionInputs.each(function () {
                        allChecked = allChecked && $(this).prop('checked');
                    });

                    optionInputs.prop('checked', !allChecked).trigger('change');
                }, this));
            }
        },

        /**
         * Create an option using the given select option.
         *
         * @param {jQuery} element
         */
        createOptionValue: function (element) {
            var $element = $(element);
            if ($element.is(':selected')) {
                $element.prop('selected', true);
            }

            // Support the label attribute on options.
            var label = this.options.optionLabel(element);
            var value = $element.val();
            var inputType = this.options.multiple ? "checkbox" : "radio";

            var $li = $(this.options.templates.li);
            var $label = $('label', $li);
            $label.addClass(inputType);

            if (this.options.enableHTML) {
                $label.html(" " + label);
            }
            else {
                $label.text(" " + label);
            }

            var $checkbox = $('<input/>').attr('type', inputType);

            if (this.options.checkboxName) {
                $checkbox.attr('name', this.options.checkboxName);
            }
            $label.prepend($checkbox);

            var selected = $element.prop('selected') || false;
            $checkbox.val(value);

            if (value === this.options.selectAllValue) {
                $li.addClass("multiselect-item multiselect-all");
                $checkbox.parent().parent()
                    .addClass('multiselect-all');
            }

            $label.attr('title', $element.attr('title'));

            this.$ul.append($li);

            if ($element.is(':disabled')) {
                $checkbox.attr('disabled', 'disabled')
                    .prop('disabled', true)
                    .closest('a')
                    .attr("tabindex", "-1")
                    .closest('li')
                    .addClass('disabled');
            }

            $checkbox.prop('checked', selected);

            if (selected && this.options.selectedClass) {
                $checkbox.closest('li')
                    .addClass(this.options.selectedClass);
            }
        },

        /**
         * Creates a divider using the given select option.
         *
         * @param {jQuery} element
         */
        createDivider: function (element) {
            var $divider = $(this.options.templates.divider);
            this.$ul.append($divider);
        },

        /**
         * Creates an optgroup.
         *
         * @param {jQuery} group
         */
        createOptgroup: function (group) {
            var groupName = $(group).prop('label');

            // Add a header for the group.
            var $li = $(this.options.templates.liGroup);

            if (this.options.enableHTML) {
                $('label', $li).html(groupName);
            }
            else {
                $('label', $li).text(groupName);
            }

            if (this.options.enableClickableOptGroups) {
                $li.addClass('multiselect-group-clickable');
            }

            this.$ul.append($li);

            if ($(group).is(':disabled')) {
                $li.addClass('disabled');
            }

            // Add the options of the group.
            $('option', group).each($.proxy(function (index, element) {
                this.createOptionValue(element);
            }, this));
        },

        /**
         * Build the selct all.
         * 
         * Checks if a select all has already been created.
         */
        buildSelectAll: function () {
            if (typeof this.options.selectAllValue === 'number') {
                this.options.selectAllValue = this.options.selectAllValue.toString();
            }

            var alreadyHasSelectAll = this.hasSelectAll();

            if (!alreadyHasSelectAll && this.options.includeSelectAllOption && this.options.multiple
                    && $('option', this.$select).length > this.options.includeSelectAllIfMoreThan) {

                // Check whether to add a divider after the select all.
                if (this.options.includeSelectAllDivider) {
                    this.$ul.prepend($(this.options.templates.divider));
                }

                var $li = $(this.options.templates.li);
                $('label', $li).addClass("checkbox");

                if (this.options.enableHTML) {
                    $('label', $li).html(" " + this.options.selectAllText);
                }
                else {
                    $('label', $li).text(" " + this.options.selectAllText);
                }

                if (this.options.selectAllName) {
                    $('label', $li).prepend('<input type="checkbox" name="' + this.options.selectAllName + '" />');
                }
                else {
                    $('label', $li).prepend('<input type="checkbox" />');
                }

                var $checkbox = $('input', $li);
                $checkbox.val(this.options.selectAllValue);

                $li.addClass("multiselect-item multiselect-all");
                $checkbox.parent().parent()
                    .addClass('multiselect-all');

                this.$ul.prepend($li);

                $checkbox.prop('checked', false);
            }
        },

        /**
         * Builds the filter.
         */
        buildFilter: function () {

            // Build filter if filtering OR case insensitive filtering is enabled and the number of options exceeds (or equals) enableFilterLength.
            if (this.options.enableFiltering || this.options.enableCaseInsensitiveFiltering) {
                var enableFilterLength = Math.max(this.options.enableFiltering, this.options.enableCaseInsensitiveFiltering);

                if (this.$select.find('option').length >= enableFilterLength) {

                    this.$filter = $(this.options.templates.filter);
                    $('input', this.$filter).attr('placeholder', this.options.filterPlaceholder);

                    // Adds optional filter clear button
                    if (this.options.includeFilterClearBtn) {
                        var clearBtn = $(this.options.templates.filterClearBtn);
                        clearBtn.on('click', $.proxy(function (event) {
                            clearTimeout(this.searchTimeout);
                            this.$filter.find('.multiselect-search').val('');
                            $('li', this.$ul).show().removeClass("filter-hidden");
                            this.updateSelectAll();
                        }, this));
                        this.$filter.find('.input-group').append(clearBtn);
                    }

                    this.$ul.prepend(this.$filter);

                    this.$filter.val(this.query).on('click', function (event) {
                        event.stopPropagation();
                    }).on('input keydown', $.proxy(function (event) {
                        // Cancel enter key default behaviour
                        if (event.which === 13) {
                            event.preventDefault();
                        }

                        //hide select-all li
                        if (this.$filter.find(".multiselect-search").val() != "")
                            $("li", this.$ul).siblings("li.multiselect-all").addClass("filter-hidden").hide()
                        else
                            $("li", this.$ul).siblings("li.multiselect-all").removeClass("filter-hidden").show();

                        // This is useful to catch "keydown" events after the browser has updated the control.
                        clearTimeout(this.searchTimeout);

                        this.searchTimeout = this.asyncFunction($.proxy(function () {

                            if (this.query !== event.target.value) {
                                this.query = event.target.value;

                                var currentGroup, currentGroupVisible;
                                $.each($('li', this.$ul), $.proxy(function (index, element) {
                                    var value = $('input', element).length > 0 ? $('input', element).val() : "";
                                    var text = $('label', element).text();

                                    var filterCandidate = '';
                                    if ((this.options.filterBehavior === 'text')) {
                                        filterCandidate = text;
                                    }
                                    else if ((this.options.filterBehavior === 'value')) {
                                        filterCandidate = value;
                                    }
                                    else if (this.options.filterBehavior === 'both') {
                                        filterCandidate = text + '\n' + value;
                                    }

                                    if (value !== this.options.selectAllValue && text) {
                                        // By default lets assume that element is not
                                        // interesting for this search.
                                        var showElement = false;

                                        if (this.options.enableCaseInsensitiveFiltering && filterCandidate.toLowerCase().indexOf(this.query.toLowerCase()) > -1) {
                                            showElement = true;
                                        }
                                        else if (filterCandidate.indexOf(this.query) > -1) {
                                            showElement = true;
                                        }

                                        // Toggle current element (group or group item) according to showElement boolean.
                                        $(element).toggle(showElement).toggleClass('filter-hidden', !showElement);

                                        // Differentiate groups and group items.
                                        if ($(element).hasClass('multiselect-group')) {
                                            // Remember group status.
                                            currentGroup = element;
                                            currentGroupVisible = showElement;
                                        }
                                        else {
                                            // Show group name when at least one of its items is visible.
                                            if (showElement) {
                                                $(currentGroup).show().removeClass('filter-hidden');
                                            }

                                            // Show all group items when group name satisfies filter.
                                            if (!showElement && currentGroupVisible) {
                                                $(element).show().removeClass('filter-hidden');
                                            }
                                        }
                                    }
                                }, this));
                            }

                            this.updateSelectAll();
                        }, this), 300, this);
                    }, this));
                }
            }
        },

        /**
         * Unbinds the whole plugin.
         */
        destroy: function () {
            this.$container.remove();
            this.$select.show();
            this.$select.data('multiselect', null);
        },

        /**
         * Refreshs the multiselect based on the selected options of the select.
         */
        refresh: function () {
            $('option', this.$select).each($.proxy(function (index, element) {
                var $input = $('li input', this.$ul).filter(function () {
                    return $(this).val() === $(element).val();
                });

                if ($(element).is(':selected')) {
                    $input.prop('checked', true);

                    if (this.options.selectedClass) {
                        $input.closest('li')
                            .addClass(this.options.selectedClass);
                    }
                }
                else {
                    $input.prop('checked', false);

                    if (this.options.selectedClass) {
                        $input.closest('li')
                            .removeClass(this.options.selectedClass);
                    }
                }

                if ($(element).is(":disabled")) {
                    $input.attr('disabled', 'disabled')
                        .prop('disabled', true)
                        .closest('li')
                        .addClass('disabled');
                }
                else {
                    $input.prop('disabled', false)
                        .closest('li')
                        .removeClass('disabled');
                }
            }, this));

            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Select all options of the given values.
         * 
         * If triggerOnChange is set to true, the on change event is triggered if
         * and only if one value is passed.
         * 
         * @param {Array} selectValues
         * @param {Boolean} triggerOnChange
         */
        select: function (selectValues, triggerOnChange) {
            if (!$.isArray(selectValues)) {
                selectValues = [selectValues];
            }

            for (var i = 0; i < selectValues.length; i++) {
                var value = selectValues[i];

                if (value === null || value === undefined) {
                    continue;
                }

                var $option = this.getOptionByValue(value);
                var $checkbox = this.getInputByValue(value);

                if ($option === undefined || $checkbox === undefined) {
                    continue;
                }

                if (!this.options.multiple) {
                    this.deselectAll(false);
                }

                if (this.options.selectedClass) {
                    $checkbox.closest('li')
                        .addClass(this.options.selectedClass);
                }

                $checkbox.prop('checked', true);
                $option.prop('selected', true);

                if (triggerOnChange) {
                    this.options.onChange($option, true);
                }
            }

            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Clears all selected items.
         */
        clearSelection: function () {
            this.deselectAll(false);
            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Deselects all options of the given values.
         * 
         * If triggerOnChange is set to true, the on change event is triggered, if
         * and only if one value is passed.
         * 
         * @param {Array} deselectValues
         * @param {Boolean} triggerOnChange
         */
        deselect: function (deselectValues, triggerOnChange) {
            if (!$.isArray(deselectValues)) {
                deselectValues = [deselectValues];
            }

            for (var i = 0; i < deselectValues.length; i++) {
                var value = deselectValues[i];

                if (value === null || value === undefined) {
                    continue;
                }

                var $option = this.getOptionByValue(value);
                var $checkbox = this.getInputByValue(value);

                if ($option === undefined || $checkbox === undefined) {
                    continue;
                }

                if (this.options.selectedClass) {
                    $checkbox.closest('li')
                        .removeClass(this.options.selectedClass);
                }

                $checkbox.prop('checked', false);
                $option.prop('selected', false);

                if (triggerOnChange) {
                    this.options.onChange($option, false);
                }
            }

            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Selects all enabled & visible options.
         *
         * If justVisible is true or not specified, only visible options are selected.
         *
         * @param {Boolean} justVisible
         * @param {Boolean} triggerOnSelectAll
         */
        selectAll: function (justVisible, triggerOnSelectAll) {
            var justVisible = typeof justVisible === 'undefined' ? true : justVisible;
            var allCheckboxes = $("li input[type='checkbox']:enabled", this.$ul);
            var visibleCheckboxes = allCheckboxes.filter(":visible");
            var allCheckboxesCount = allCheckboxes.length;
            var visibleCheckboxesCount = visibleCheckboxes.length;

            if (justVisible) {
                visibleCheckboxes.prop('checked', true);
                $("li:not(.divider):not(.disabled)", this.$ul).filter(":visible").addClass(this.options.selectedClass);
            }
            else {
                allCheckboxes.prop('checked', true);
                $("li:not(.divider):not(.disabled)", this.$ul).addClass(this.options.selectedClass);
            }

            if (allCheckboxesCount === visibleCheckboxesCount || justVisible === false) {
                $("option:enabled", this.$select).prop('selected', true);
            }
            else {
                var values = visibleCheckboxes.map(function () {
                    return $(this).val();
                }).get();

                $("option:enabled", this.$select).filter(function (index) {
                    return $.inArray($(this).val(), values) !== -1;
                }).prop('selected', true);
            }

            if (triggerOnSelectAll) {
                this.options.onSelectAll();
            }
        },

        /**
         * Deselects all options.
         * 
         * If justVisible is true or not specified, only visible options are deselected.
         * 
         * @param {Boolean} justVisible
         */
        deselectAll: function (justVisible) {
            var justVisible = typeof justVisible === 'undefined' ? true : justVisible;

            if (justVisible) {
                var visibleCheckboxes = $("li input[type='checkbox']:not(:disabled)", this.$ul).filter(":visible");
                visibleCheckboxes.prop('checked', false);

                var values = visibleCheckboxes.map(function () {
                    return $(this).val();
                }).get();

                $("option:enabled", this.$select).filter(function (index) {
                    return $.inArray($(this).val(), values) !== -1;
                }).prop('selected', false);

                if (this.options.selectedClass) {
                    $("li:not(.divider):not(.disabled)", this.$ul).filter(":visible").removeClass(this.options.selectedClass);
                }
            }
            else {
                $("li input[type='checkbox']:enabled", this.$ul).prop('checked', false);
                $("option:enabled", this.$select).prop('selected', false);

                if (this.options.selectedClass) {
                    $("li:not(.divider):not(.disabled)", this.$ul).removeClass(this.options.selectedClass);
                }
            }
        },

        /**
         * Rebuild the plugin.
         * 
         * Rebuilds the dropdown, the filter and the select all option.
         */
        rebuild: function () {
            this.$ul.html('');

            // Important to distinguish between radios and checkboxes.
            this.options.multiple = this.$select.attr('multiple') === "multiple";

            this.buildSelectAll();
            this.buildDropdownOptions();
            this.buildFilter();

            this.updateButtonText();
            this.updateSelectAll();

            if (this.options.disableIfEmpty && $('option', this.$select).length <= 0) {
                this.disable();
            }
            else {
                this.enable();
            }

            if (this.options.dropRight) {
                this.$ul.addClass('pull-right');
            }
        },

        /**
         * The provided data will be used to build the dropdown.
         */
        dataprovider: function (dataprovider) {

            var groupCounter = 0;
            var $select = this.$select.empty();

            $.each(dataprovider, function (index, option) {
                var $tag;

                if ($.isArray(option.children)) { // create optiongroup tag
                    groupCounter++;

                    $tag = $('<optgroup/>').attr({
                        label: option.label || 'Group ' + groupCounter,
                        disabled: !!option.disabled
                    });

                    forEach(option.children, function (subOption) { // add children option tags
                        $tag.append($('<option/>').attr({
                            value: subOption.value,
                            label: subOption.label || subOption.value,
                            title: subOption.title,
                            selected: !!subOption.selected,
                            disabled: !!subOption.disabled
                        }));
                    });
                }
                else {
                    $tag = $('<option/>').attr({
                        value: option.value,
                        label: option.label || option.value,
                        title: option.title,
                        selected: !!option.selected,
                        disabled: !!option.disabled
                    });
                }

                $select.append($tag);
            });

            this.rebuild();
        },

        /**
         * Enable the multiselect.
         */
        enable: function () {
            this.$select.prop('disabled', false);
            this.$button.prop('disabled', false)
                .removeClass('disabled');
        },

        /**
         * Disable the multiselect.
         */
        disable: function () {
            this.$select.prop('disabled', true);
            this.$button.prop('disabled', true)
                .addClass('disabled');
        },

        /**
         * Set the options.
         *
         * @param {Array} options
         */
        setOptions: function (options) {
            this.options = this.mergeOptions(options);
        },

        /**
         * Merges the given options with the default options.
         *
         * @param {Array} options
         * @returns {Array}
         */
        mergeOptions: function (options) {
            return $.extend(true, {}, this.defaults, this.options, options);
        },

        /**
         * Checks whether a select all checkbox is present.
         *
         * @returns {Boolean}
         */
        hasSelectAll: function () {
            return $('li.multiselect-all', this.$ul).length > 0;
        },

        /**
         * Updates the select all checkbox based on the currently displayed and selected checkboxes.
         */
        updateSelectAll: function () {
            if (this.hasSelectAll()) {
                var allBoxes = $("li:not(.multiselect-item):not(.filter-hidden) input:enabled", this.$ul);
                var allBoxesLength = allBoxes.length;
                var checkedBoxesLength = allBoxes.filter(":checked").length;
                var selectAllLi = $("li.multiselect-all", this.$ul);
                var selectAllInput = selectAllLi.find("input");

                if (checkedBoxesLength > 0 && checkedBoxesLength === allBoxesLength) {
                    selectAllInput.prop("checked", true);
                    selectAllLi.addClass(this.options.selectedClass);
                    this.options.onSelectAll();
                }
                else {
                    selectAllInput.prop("checked", false);
                    selectAllLi.removeClass(this.options.selectedClass);
                }
            }
        },

        /**
         * Update the button text and its title based on the currently selected options.
         */
        updateButtonText: function () {
            var options = this.getSelected();

            // First update the displayed button text.
            if (this.options.enableHTML) {
                $('.multiselect .multiselect-selected-text', this.$container).html(this.options.buttonText(options, this.$select));
            }
            else {
                $('.multiselect .multiselect-selected-text', this.$container).text(this.options.buttonText(options, this.$select));
            }

            // Now update the title attribute of the button.       
            //var options=this.options.buttonTitle(options, this.$select).split(',');
            //var html = "";
            //html += "<ul>";

            // var mystring = '<ul><li>' + this.options.buttonTitle(options, this.$select).replace(/,/gi, '</li><li>') + '</li></ul>';

            $('.multiselect', this.$container).attr('title', this.options.buttonTitle(options, this.$select));

            if ($('.multiselect', this.$container).parent().parent().find('select option').length == options.length) {

                var form = $('.multiselect', this.$container).parents('form');
                var $span = "";
                if ($('.multiselect', this.$container).parent().parent().find('select').attr('name') == "lstStores") {
                    $span = $(form).find('[name=lstStores]').next().find('a.multiselect-all').find('span');
                    if (!$span.hasClass('checked'))
                        $span.addClass('checked');
                }
                //else {
                //    $span = $(form).find('[name=lstCategory]').next().find('a.multiselect-all').find('span');
                //}
                
            }
        },

        /**
         * Get all selected options.
         *
         * @returns {jQUery}
         */
        getSelected: function () {
            return $('option', this.$select).filter(":selected");
        },

        /**
         * Gets a select option by its value.
         *
         * @param {String} value
         * @returns {jQuery}
         */
        getOptionByValue: function (value) {

            var options = $('option', this.$select);
            var valueToCompare = value.toString();

            for (var i = 0; i < options.length; i = i + 1) {
                var option = options[i];
                if (option.value === valueToCompare) {
                    return $(option);
                }
            }
        },

        /**
         * Get the input (radio/checkbox) by its value.
         *
         * @param {String} value
         * @returns {jQuery}
         */
        getInputByValue: function (value) {

            var checkboxes = $('li input', this.$ul);
            var valueToCompare = value.toString();

            for (var i = 0; i < checkboxes.length; i = i + 1) {
                var checkbox = checkboxes[i];
                if (checkbox.value === valueToCompare) {
                    return $(checkbox);
                }
            }
        },

        /**
         * Used for knockout integration.
         */
        updateOriginalOptions: function () {
            this.originalOptions = this.$select.clone()[0].options;
        },

        asyncFunction: function (callback, timeout, self) {
            var args = Array.prototype.slice.call(arguments, 3);
            return setTimeout(function () {
                callback.apply(self || window, args);
            }, timeout);
        },

        setAllSelectedText: function (allSelectedText) {
            this.options.allSelectedText = allSelectedText;
            this.updateButtonText();



        }
    };

    $.fn.multiselect = function (option, parameter, extraOptions) {
        return this.each(function () {
            var data = $(this).data('multiselect');
            var options = typeof option === 'object' && option;

            // Initialize the multiselect.
            if (!data) {
                data = new Multiselect(this, options);
                $(this).data('multiselect', data);
            }

            // Call multiselect method.
            if (typeof option === 'string') {
                data[option](parameter, extraOptions);

                if (option === 'destroy') {
                    $(this).data('multiselect', false);
                }
            }
        });
    };

    $.fn.multiselect.Constructor = Multiselect;

    $(function () {
        $("select[data-role=multiselect]").multiselect();
    });

}(window.jQuery);
;
/* ===========================================================
 * bootstrap-modalmanager.js v2.2.5
 * ===========================================================
 * Copyright 2012 Jordan Schroter.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

!function ($) {

	"use strict"; // jshint ;_;

	/* MODAL MANAGER CLASS DEFINITION
	* ====================== */

	var ModalManager = function (element, options) {
		this.init(element, options);
	};

	ModalManager.prototype = {

		constructor: ModalManager,

		init: function (element, options) {
			this.$element = $(element);
			this.options = $.extend({}, $.fn.modalmanager.defaults, this.$element.data(), typeof options == 'object' && options);
			this.stack = [];
			this.backdropCount = 0;

			if (this.options.resize) {
				var resizeTimeout,
					that = this;

				$(window).on('resize.modal', function(){
					resizeTimeout && clearTimeout(resizeTimeout);
					resizeTimeout = setTimeout(function(){
						for (var i = 0; i < that.stack.length; i++){
							that.stack[i].isShown && that.stack[i].layout();
						}
					}, 10);
				});
			}
		},

		createModal: function (element, options) {
			$(element).modal($.extend({ manager: this }, options));
		},

		appendModal: function (modal) {
			this.stack.push(modal);

			var that = this;

			modal.$element.on('show.modalmanager', targetIsSelf(function (e) {

				var showModal = function(){
					modal.isShown = true;

					var transition = $.support.transition && modal.$element.hasClass('fade');

					that.$element
						.toggleClass('modal-open', that.hasOpenModal())
						.toggleClass('page-overflow', $(window).height() < that.$element.height());

					modal.$parent = modal.$element.parent();

					modal.$container = that.createContainer(modal);

					modal.$element.appendTo(modal.$container);

					that.backdrop(modal, function () {
						modal.$element.show();

						if (transition) {       
							//modal.$element[0].style.display = 'run-in';       
							modal.$element[0].offsetWidth;
							//modal.$element.one($.support.transition.end, function () { modal.$element[0].style.display = 'block' });  
						}
						
						modal.layout();

						modal.$element
							.addClass('in')
							.attr('aria-hidden', false);

						var complete = function () {
							that.setFocus();
							modal.$element.trigger('shown');
						};

						transition ?
							modal.$element.one($.support.transition.end, complete) :
							complete();
					});
				};

				modal.options.replace ?
					that.replace(showModal) :
					showModal();
			}));

			modal.$element.on('hidden.modalmanager', targetIsSelf(function (e) {
				that.backdrop(modal);
				// handle the case when a modal may have been removed from the dom before this callback executes
				if (!modal.$element.parent().length) {
					that.destroyModal(modal);
				} else if (modal.$backdrop){
					var transition = $.support.transition && modal.$element.hasClass('fade');

					// trigger a relayout due to firebox's buggy transition end event 
					if (transition) { modal.$element[0].offsetWidth; }
					$.support.transition && modal.$element.hasClass('fade') ?
						modal.$backdrop.one($.support.transition.end, function () { modal.destroy(); }) :
						modal.destroy();
				} else {
					modal.destroy();
				}

			}));

			modal.$element.on('destroyed.modalmanager', targetIsSelf(function (e) {
				that.destroyModal(modal);
			}));
		},

		getOpenModals: function () {
			var openModals = [];
			for (var i = 0; i < this.stack.length; i++){
				if (this.stack[i].isShown) openModals.push(this.stack[i]);
			}

			return openModals;
		},

		hasOpenModal: function () {
			return this.getOpenModals().length > 0;
		},

		setFocus: function () {
			var topModal;

			for (var i = 0; i < this.stack.length; i++){
				if (this.stack[i].isShown) topModal = this.stack[i];
			}

			if (!topModal) return;

			topModal.focus();
		},

		destroyModal: function (modal) {
			modal.$element.off('.modalmanager');
			if (modal.$backdrop) this.removeBackdrop(modal);
			this.stack.splice(this.getIndexOfModal(modal), 1);

			var hasOpenModal = this.hasOpenModal();

			this.$element.toggleClass('modal-open', hasOpenModal);

			if (!hasOpenModal){
				this.$element.removeClass('page-overflow');
			}

			this.removeContainer(modal);

			this.setFocus();
		},

		getModalAt: function (index) {
			return this.stack[index];
		},

		getIndexOfModal: function (modal) {
			for (var i = 0; i < this.stack.length; i++){
				if (modal === this.stack[i]) return i;
			}
		},

		replace: function (callback) {
			var topModal;

			for (var i = 0; i < this.stack.length; i++){
				if (this.stack[i].isShown) topModal = this.stack[i];
			}

			if (topModal) {
				this.$backdropHandle = topModal.$backdrop;
				topModal.$backdrop = null;

				callback && topModal.$element.one('hidden',
					targetIsSelf( $.proxy(callback, this) ));

				topModal.hide();
			} else if (callback) {
				callback();
			}
		},

		removeBackdrop: function (modal) {
			modal.$backdrop.remove();
			modal.$backdrop = null;
		},

		createBackdrop: function (animate, tmpl) {
			var $backdrop;

			if (!this.$backdropHandle) {
				$backdrop = $(tmpl)
					.addClass(animate)
					.appendTo(this.$element);
			} else {
				$backdrop = this.$backdropHandle;
				$backdrop.off('.modalmanager');
				this.$backdropHandle = null;
				this.isLoading && this.removeSpinner();
			}

			return $backdrop;
		},

		removeContainer: function (modal) {
			modal.$container.remove();
			modal.$container = null;
		},

		createContainer: function (modal) {
			var $container;

			$container = $('<div class="modal-scrollable">')
				.css('z-index', getzIndex('modal', this.getOpenModals().length))
				.appendTo(this.$element);

			if (modal && modal.options.backdrop != 'static') {
				$container.on('click.modal', targetIsSelf(function (e) {
					modal.hide();
				}));
			} else if (modal) {
				$container.on('click.modal', targetIsSelf(function (e) {
					modal.attention();
				}));
			}

			return $container;

		},

		backdrop: function (modal, callback) {
			var animate = modal.$element.hasClass('fade') ? 'fade' : '',
				showBackdrop = modal.options.backdrop &&
					this.backdropCount < this.options.backdropLimit;

			if (modal.isShown && showBackdrop) {
				var doAnimate = $.support.transition && animate && !this.$backdropHandle;

				modal.$backdrop = this.createBackdrop(animate, modal.options.backdropTemplate);

				modal.$backdrop.css('z-index', getzIndex( 'backdrop', this.getOpenModals().length ));

				if (doAnimate) modal.$backdrop[0].offsetWidth; // force reflow

				modal.$backdrop.addClass('in');

				this.backdropCount += 1;

				doAnimate ?
					modal.$backdrop.one($.support.transition.end, callback) :
					callback();

			} else if (!modal.isShown && modal.$backdrop) {
				modal.$backdrop.removeClass('in');

				this.backdropCount -= 1;

				var that = this;

				$.support.transition && modal.$element.hasClass('fade')?
					modal.$backdrop.one($.support.transition.end, function () { that.removeBackdrop(modal) }) :
					that.removeBackdrop(modal);

			} else if (callback) {
				callback();
			}
		},

		removeSpinner: function(){
			this.$spinner && this.$spinner.remove();
			this.$spinner = null;
			this.isLoading = false;
		},

		removeLoading: function () {
			this.$backdropHandle && this.$backdropHandle.remove();
			this.$backdropHandle = null;
			this.removeSpinner();
		},

		loading: function (callback) {
			callback = callback || function () { };

			this.$element
				.toggleClass('modal-open', !this.isLoading || this.hasOpenModal())
				.toggleClass('page-overflow', $(window).height() < this.$element.height());

			if (!this.isLoading) {

				this.$backdropHandle = this.createBackdrop('fade', this.options.backdropTemplate);

				this.$backdropHandle[0].offsetWidth; // force reflow

				var openModals = this.getOpenModals();

				this.$backdropHandle
					.css('z-index', getzIndex('backdrop', openModals.length + 1))
					.addClass('in');

				var $spinner = $(this.options.spinner)
					.css('z-index', getzIndex('modal', openModals.length + 1))
					.appendTo(this.$element)
					.addClass('in');

				this.$spinner = $(this.createContainer())
					.append($spinner)
					.on('click.modalmanager', $.proxy(this.loading, this));

				this.isLoading = true;

				$.support.transition ?
					this.$backdropHandle.one($.support.transition.end, callback) :
					callback();

			} else if (this.isLoading && this.$backdropHandle) {
				this.$backdropHandle.removeClass('in');

				var that = this;
				$.support.transition ?
					this.$backdropHandle.one($.support.transition.end, function () { that.removeLoading() }) :
					that.removeLoading();

			} else if (callback) {
				callback(this.isLoading);
			}
		}
	};

	/* PRIVATE METHODS
	* ======================= */

	// computes and caches the zindexes
	var getzIndex = (function () {
		var zIndexFactor,
			baseIndex = {};

		return function (type, pos) {

			if (typeof zIndexFactor === 'undefined'){
				var $baseModal = $('<div class="modal hide" />').appendTo('body'),
					$baseBackdrop = $('<div class="modal-backdrop hide" />').appendTo('body');

				baseIndex['modal'] = +$baseModal.css('z-index');
				baseIndex['backdrop'] = +$baseBackdrop.css('z-index');
				zIndexFactor = baseIndex['modal'] - baseIndex['backdrop'];

				$baseModal.remove();
				$baseBackdrop.remove();
				$baseBackdrop = $baseModal = null;
			}

			return baseIndex[type] + (zIndexFactor * pos);

		}
	}());

	// make sure the event target is the modal itself in order to prevent
	// other components such as tabsfrom triggering the modal manager.
	// if Boostsrap namespaced events, this would not be needed.
	function targetIsSelf(callback){
		return function (e) {
			if (e && this === e.target){
				return callback.apply(this, arguments);
			}
		}
	}


	/* MODAL MANAGER PLUGIN DEFINITION
	* ======================= */

	$.fn.modalmanager = function (option, args) {
		return this.each(function () {
			var $this = $(this),
				data = $this.data('modalmanager');

			if (!data) $this.data('modalmanager', (data = new ModalManager(this, option)));
			if (typeof option === 'string') data[option].apply(data, [].concat(args))
		})
	};

	$.fn.modalmanager.defaults = {
		backdropLimit: 999,
		resize: true,
		spinner: '<div class="loading-spinner fade" style="width: 200px; margin-left: -100px;"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div>',
		backdropTemplate: '<div class="modal-backdrop" />'
	};

	$.fn.modalmanager.Constructor = ModalManager

	// ModalManager handles the modal-open class so we need 
	// to remove conflicting bootstrap 3 event handlers
	$(function () {
		$(document).off('show.bs.modal').off('hidden.bs.modal');
	});

}(jQuery);
;
/* ===========================================================
 * bootstrap-modal.js v2.2.5
 * ===========================================================
 * Copyright 2012 Jordan Schroter
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */


!function ($) {

	"use strict"; // jshint ;_;

	/* MODAL CLASS DEFINITION
	* ====================== */

	var Modal = function (element, options) {
		this.init(element, options);
	};

	Modal.prototype = {

		constructor: Modal,

		init: function (element, options) {
			var that = this;

			this.options = options;

			this.$element = $(element)
				.delegate('[data-dismiss="modal"]', 'click.dismiss.modal', $.proxy(this.hide, this));

			this.options.remote && this.$element.find('.modal-body').load(this.options.remote, function () {
				var e = $.Event('loaded');
				that.$element.trigger(e);
			});

			var manager = typeof this.options.manager === 'function' ?
				this.options.manager.call(this) : this.options.manager;

			manager = manager.appendModal ?
				manager : $(manager).modalmanager().data('modalmanager');

			manager.appendModal(this);
		},

		toggle: function () {
			return this[!this.isShown ? 'show' : 'hide']();
		},

		show: function () {
			var e = $.Event('show');

			if (this.isShown) return;

			this.$element.trigger(e);

			if (e.isDefaultPrevented()) return;

			this.escape();

			this.tab();

			this.options.loading && this.loading();
		},

		hide: function (e) {
			e && e.preventDefault();

			e = $.Event('hide');

			this.$element.trigger(e);

			if (!this.isShown || e.isDefaultPrevented()) return;

			this.isShown = false;

			this.escape();

			this.tab();

			this.isLoading && this.loading();

			$(document).off('focusin.modal');

			this.$element
				.removeClass('in')
				.removeClass('animated')
				.removeClass(this.options.attentionAnimation)
				.removeClass('modal-overflow')
				.attr('aria-hidden', true);

			$.support.transition && this.$element.hasClass('fade') ?
				this.hideWithTransition() :
				this.hideModal();
		},

		layout: function () {
			var prop = this.options.height ? 'height' : 'max-height',
				value = this.options.height || this.options.maxHeight;

			if (this.options.width){
				this.$element.css('width', this.options.width);

				var that = this;
				this.$element.css('margin-left', function () {
					if (/%/ig.test(that.options.width)){
						return -(parseInt(that.options.width) / 2) + '%';
					} else {
						return -($(this).width() / 2) + 'px';
					}
				});
			} else {
				this.$element.css('width', '');
				this.$element.css('margin-left', '');
			}

			this.$element.find('.modal-body')
				.css('overflow', '')
				.css(prop, '');

			if (value){
				this.$element.find('.modal-body')
					.css('overflow', 'auto')
					.css(prop, value);
			}

			var modalOverflow = $(window).height() - 10 < this.$element.height();
            
			if (modalOverflow || this.options.modalOverflow) {
				this.$element
					.css('margin-top', 0)
					.addClass('modal-overflow');
			} else {
				this.$element
					.css('margin-top', 0 - this.$element.height() / 2)
					.removeClass('modal-overflow');
			}
		},

		tab: function () {
			var that = this;

			if (this.isShown && this.options.consumeTab) {
				this.$element.on('keydown.tabindex.modal', '[data-tabindex]', function (e) {
			    	if (e.keyCode && e.keyCode == 9){
						var elements = [],
							tabindex = Number($(this).data('tabindex'));

						that.$element.find('[data-tabindex]:enabled:visible:not([readonly])').each(function (ev) {
							elements.push(Number($(this).data('tabindex')));
						});
						elements.sort(function(a,b){return a-b});
						
						var arrayPos = $.inArray(tabindex, elements);
						if (!e.shiftKey){
						 		arrayPos < elements.length-1 ?
									that.$element.find('[data-tabindex='+elements[arrayPos+1]+']').focus() :
									that.$element.find('[data-tabindex='+elements[0]+']').focus();
							} else {
								arrayPos == 0 ?
									that.$element.find('[data-tabindex='+elements[elements.length-1]+']').focus() :
									that.$element.find('[data-tabindex='+elements[arrayPos-1]+']').focus();
							}
						
						e.preventDefault();
					}
				});
			} else if (!this.isShown) {
				this.$element.off('keydown.tabindex.modal');
			}
		},

		escape: function () {
			var that = this;
			if (this.isShown && this.options.keyboard) {
				if (!this.$element.attr('tabindex')) this.$element.attr('tabindex', -1);

				this.$element.on('keyup.dismiss.modal', function (e) {
					e.which == 27 && that.hide();
				});
			} else if (!this.isShown) {
				this.$element.off('keyup.dismiss.modal')
			}
		},

		hideWithTransition: function () {
			var that = this
				, timeout = setTimeout(function () {
					that.$element.off($.support.transition.end);
					that.hideModal();
				}, 500);

			this.$element.one($.support.transition.end, function () {
				clearTimeout(timeout);
				that.hideModal();
			});
		},

		hideModal: function () {
			var prop = this.options.height ? 'height' : 'max-height';
			var value = this.options.height || this.options.maxHeight;

			if (value){
				this.$element.find('.modal-body')
					.css('overflow', '')
					.css(prop, '');
			}

			this.$element
				.hide()
				.trigger('hidden');
		},

		removeLoading: function () {
			this.$loading.remove();
			this.$loading = null;
			this.isLoading = false;
		},

		loading: function (callback) {
			callback = callback || function () {};

			var animate = this.$element.hasClass('fade') ? 'fade' : '';

			if (!this.isLoading) {
				var doAnimate = $.support.transition && animate;

				this.$loading = $('<div class="loading-mask ' + animate + '">')
					.append(this.options.spinner)
					.appendTo(this.$element);

				if (doAnimate) this.$loading[0].offsetWidth; // force reflow

				this.$loading.addClass('in');

				this.isLoading = true;

				doAnimate ?
					this.$loading.one($.support.transition.end, callback) :
					callback();

			} else if (this.isLoading && this.$loading) {
				this.$loading.removeClass('in');

				var that = this;
				$.support.transition && this.$element.hasClass('fade')?
					this.$loading.one($.support.transition.end, function () { that.removeLoading() }) :
					that.removeLoading();

			} else if (callback) {
				callback(this.isLoading);
			}
		},

		focus: function () {
			var $focusElem = this.$element.find(this.options.focusOn);

			$focusElem = $focusElem.length ? $focusElem : this.$element;

			$focusElem.focus();
		},

		attention: function (){
			// NOTE: transitionEnd with keyframes causes odd behaviour

			if (this.options.attentionAnimation){
				this.$element
					.removeClass('animated')
					.removeClass(this.options.attentionAnimation);

				var that = this;

				setTimeout(function () {
					that.$element
						.addClass('animated')
						.addClass(that.options.attentionAnimation);
				}, 0);
			}


			this.focus();
		},


		destroy: function () {
			var e = $.Event('destroy');

			this.$element.trigger(e);

			if (e.isDefaultPrevented()) return;

			this.$element
				.off('.modal')
				.removeData('modal')
				.removeClass('in')
				.attr('aria-hidden', true);
			
			if (this.$parent !== this.$element.parent()) {
				this.$element.appendTo(this.$parent);
			} else if (!this.$parent.length) {
				// modal is not part of the DOM so remove it.
				this.$element.remove();
				this.$element = null;
			}

			this.$element.trigger('destroyed');
		}
	};


	/* MODAL PLUGIN DEFINITION
	* ======================= */

	$.fn.modal = function (option, args) {
		return this.each(function () {
			var $this = $(this),
				data = $this.data('modal'),
				options = $.extend({}, $.fn.modal.defaults, $this.data(), typeof option == 'object' && option);

			if (!data) $this.data('modal', (data = new Modal(this, options)));
			if (typeof option == 'string') data[option].apply(data, [].concat(args));
			else if (options.show) data.show()
		})
	};

	$.fn.modal.defaults = {
		keyboard: true,
		backdrop: true,
		loading: false,
		show: true,
		width: null,
		height: null,
		maxHeight: null,
		modalOverflow: false,
		consumeTab: true,
		focusOn: null,
		replace: false,
		resize: false,
		//attentionAnimation: 'shake', //commented by Himanshu as per client request to remove shake of modal when clicked outside the modal popup
		manager: 'body',
		spinner: '<div class="loading-spinner" style="width: 200px; margin-left: -100px;"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div>',
		backdropTemplate: '<div class="modal-backdrop" />'
	};

	$.fn.modal.Constructor = Modal;


	/* MODAL DATA-API
	* ============== */

	$(function () {
		$(document).off('click.modal').on('click.modal.data-api', '[data-toggle="modal"]', function ( e ) {
			var $this = $(this),
				href = $this.attr('href'),
				$target = $($this.attr('data-target') || (href && href.replace(/.*(?=#[^\s]+$)/, ''))), //strip for ie7
				option = $target.data('modal') ? 'toggle' : $.extend({ remote: !/#/.test(href) && href }, $target.data(), $this.data());

			e.preventDefault();
			$target
				.modal(option)
				.one('hide', function () {
					$this.focus();
				})
		});
	});

}(window.jQuery);
;
//  This file is part of the jQuery formatCurrency Plugin.
//
//    The jQuery formatCurrency Plugin is free software: you can redistribute it
//    and/or modify it under the terms of the GNU General Public License as published 
//    by the Free Software Foundation, either version 3 of the License, or
//    (at your option) any later version.

//    The jQuery formatCurrency Plugin is distributed in the hope that it will
//    be useful, but WITHOUT ANY WARRANTY; without even the implied warranty 
//    of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License along with 
//    the jQuery formatCurrency Plugin.  If not, see <http://www.gnu.org/licenses/>.

(function($) {

	$.formatCurrency = {};

	$.formatCurrency.regions = [];

	// default Region is en
	$.formatCurrency.regions[''] = {
		symbol: '$',
		positiveFormat: '%s%n',
		negativeFormat: '(%s%n)',
		decimalSymbol: '.',
		digitGroupSymbol: ',',
		groupDigits: true
	};

	$.fn.formatCurrency = function(destination, settings) {

		if (arguments.length == 1 && typeof destination !== "string") {
			settings = destination;
			destination = false;
		}

		// initialize defaults
		var defaults = {
			name: "formatCurrency",
			colorize: false,
			region: '',
			global: true,
			roundToDecimalPlace: 2, // roundToDecimalPlace: -1; for no rounding; 0 to round to the dollar; 1 for one digit cents; 2 for two digit cents; 3 for three digit cents; ...
			eventOnDecimalsEntered: false
		};
		// initialize default region
		defaults = $.extend(defaults, $.formatCurrency.regions['']);
		// override defaults with settings passed in
		settings = $.extend(defaults, settings);

		// check for region setting
		if (settings.region.length > 0) {
			settings = $.extend(settings, getRegionOrCulture(settings.region));
		}
		settings.regex = generateRegex(settings);

		return this.each(function() {
			$this = $(this);

			// get number
			var num = '0';
			num = $this[$this.is('input, select, textarea') ? 'val' : 'html']();

			//identify '(123)' as a negative number
			if (num.search('\\(') >= 0) {
				num = '-' + num;
			}

			if (num === '' || (num === '-' && settings.roundToDecimalPlace === -1)) {
				return;
			}

			// if the number is valid use it, otherwise clean it
			if (isNaN(num)) {
				// clean number
				num = num.replace(settings.regex, '');
				
				if (num === '' || (num === '-' && settings.roundToDecimalPlace === -1)) {
					return;
				}
				
				if (settings.decimalSymbol != '.') {
					num = num.replace(settings.decimalSymbol, '.');  // reset to US decimal for arithmetic
				}
				if (isNaN(num)) {
					num = '0';
				}
			}
			
			// evalutate number input
			var numParts = String(num).split('.');
			var isPositive = (num == Math.abs(num));
			var hasDecimals = (numParts.length > 1);
			var decimals = (hasDecimals ? numParts[1].toString() : '0');
			var originalDecimals = decimals;
			
			// format number
			num = Math.abs(numParts[0]);
			num = isNaN(num) ? 0 : num;
			if (settings.roundToDecimalPlace >= 0) {
				decimals = parseFloat('1.' + decimals); // prepend "0."; (IE does NOT round 0.50.toFixed(0) up, but (1+0.50).toFixed(0)-1
				decimals = decimals.toFixed(settings.roundToDecimalPlace); // round
				if (decimals.substring(0, 1) == '2') {
					num = Number(num) + 1;
				}
				decimals = decimals.substring(2); // remove "0."
			}
			num = String(num);

			if (settings.groupDigits) {
				for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++) {
					num = num.substring(0, num.length - (4 * i + 3)) + settings.digitGroupSymbol + num.substring(num.length - (4 * i + 3));
				}
			}

			if ((hasDecimals && settings.roundToDecimalPlace == -1) || settings.roundToDecimalPlace > 0) {
				num += settings.decimalSymbol + decimals;
			}

			// format symbol/negative
			var format = isPositive ? settings.positiveFormat : settings.negativeFormat;
			var money = format.replace(/%s/g, settings.symbol);
			money = money.replace(/%n/g, num);

			// setup destination
			var $destination = $([]);
			if (!destination) {
				$destination = $this;
			} else {
				$destination = $(destination);
			}
			// set destination
			$destination[$destination.is('input, select, textarea') ? 'val' : 'html'](money);

			if (
				hasDecimals && 
				settings.eventOnDecimalsEntered && 
				originalDecimals.length > settings.roundToDecimalPlace
			) {
				$destination.trigger('decimalsEntered', originalDecimals);
			}

			// colorize
			if (settings.colorize) {
				$destination.css('color', isPositive ? 'black' : 'red');
			}
		});
	};

	// Remove all non numbers from text
	$.fn.toNumber = function(settings) {
		var defaults = $.extend({
			name: "toNumber",
			region: '',
			global: true
		}, $.formatCurrency.regions['']);

		settings = jQuery.extend(defaults, settings);
		if (settings.region.length > 0) {
			settings = $.extend(settings, getRegionOrCulture(settings.region));
		}
		settings.regex = generateRegex(settings);

		return this.each(function() {
			var method = $(this).is('input, select, textarea') ? 'val' : 'html';
			$(this)[method]($(this)[method]().replace('(', '(-').replace(settings.regex, ''));
		});
	};

	// returns the value from the first element as a number
	$.fn.asNumber = function(settings) {
		var defaults = $.extend({
			name: "asNumber",
			region: '',
			parse: true,
			parseType: 'Float',
			global: true
		}, $.formatCurrency.regions['']);
		settings = jQuery.extend(defaults, settings);
		if (settings.region.length > 0) {
			settings = $.extend(settings, getRegionOrCulture(settings.region));
		}
		settings.regex = generateRegex(settings);
		settings.parseType = validateParseType(settings.parseType);

		var method = $(this).is('input, select, textarea') ? 'val' : 'html';
		var num = $(this)[method]();
		num = num ? num : "";
		num = num.replace('(', '(-');
		num = num.replace(settings.regex, '');
		if (!settings.parse) {
			return num;
		}

		if (num.length == 0) {
			num = '0';
		}

		if (settings.decimalSymbol != '.') {
			num = num.replace(settings.decimalSymbol, '.');  // reset to US decimal for arthmetic
		}

		return window['parse' + settings.parseType](num);
	};

	function getRegionOrCulture(region) {
		var regionInfo = $.formatCurrency.regions[region];
		if (regionInfo) {
			return regionInfo;
		}
		else {
			if (/(\w+)-(\w+)/g.test(region)) {
				var culture = region.replace(/(\w+)-(\w+)/g, "$1");
				return $.formatCurrency.regions[culture];
			}
		}
		// fallback to extend(null) (i.e. nothing)
		return null;
	}

	function validateParseType(parseType) {
		switch (parseType.toLowerCase()) {
			case 'int':
				return 'Int';
			case 'float':
				return 'Float';
			default:
				throw 'invalid parseType';
		}
	}
	
	function generateRegex(settings) {
		if (settings.symbol === '') {
			return new RegExp("[^\\d" + settings.decimalSymbol + "-]", "g");
		}
		else {
			var symbol = settings.symbol.replace('$', '\\$').replace('.', '\\.');		
			return new RegExp(symbol + "|[^\\d" + settings.decimalSymbol + "-]", "g");
		}	
	}

})(jQuery);;
/*!
 * jquery.sumoselect - v3.0.2
 * http://hemantnegi.github.io/jquery.sumoselect
 * 2014-04-08
 *
 * Copyright 2015 Hemant Negi
 * Email : hemant.frnz@gmail.com
 * Compressor http://refresh-sf.com/
 */


(function ($) {

    'namespace sumo';
    $.fn.SumoSelect = function (options) {

        // This is the easiest way to have default options.
        var settings = $.extend({
            placeholder: 'Select Here',   // Dont change it here.
            csvDispCount: 2,              // display no. of items in multiselect. 0 to display all.
            captionFormat: '{0} selected', // format of caption text. you can set your locale.
            captionFormatAllSelected: 'All selected ({0})', // format of caption text when all elements are selected. set null to use captionFormat. It will not work if there are disabled elements in select.
            floatWidth: 400,              // Screen width of device at which the list is rendered in floating popup fashion.
            forceCustomRendering: false,  // force the custom modal on all devices below floatWidth resolution.
            nativeOnDevice: ['Android', 'BlackBerry', 'iPhone', 'iPad', 'iPod', 'Opera Mini', 'IEMobile', 'Silk'], //
            outputAsCSV: false,           // true to POST data as csv ( false for Html control array ie. default select )
            csvSepChar: ',',              // separation char in csv mode
            okCancelInMulti: false,       // display ok cancel buttons in desktop mode multiselect also.
            triggerChangeCombined: true,  // im multi select mode wether to trigger change event on individual selection or combined selection.
            selectAll: false,             // to display select all button in multiselect mode.|| also select all will not be available on mobile devices.

            search: false,                // to display input for filtering content. selectAlltext will be input text placeholder
            searchText: 'Search...',      // placeholder for search input
            noMatch: 'No matches for "{0}"',
            prefix: '',                   // some prefix usually the field name. eg. '<b>Hello</b>'
            locale: ['OK', 'Cancel', 'Select all'],  // all text that is used. don't change the index.
            up: false,                     // set true to open upside.
            optWrapperCstmWidthToAuto: false
        }, options);

        var ret = this.each(function () {
            var selObj = this; // the original select object.
            if (this.sumo || !$(this).is('select')) return; //already initialized

            this.sumo = {
                E: $(selObj),   //the jquery object of original select element.
                is_multi: $(selObj).attr('multiple'),  //if its a multiple select
                select: '',
                caption: '',
                placeholder: '',
                optDiv: '',
                CaptionCont: '',
                ul: '',
                is_floating: false,
                is_opened: false,
                //backdrop: '',
                mob: false, // if to open device default select
                Pstate: [],
                ifChanged: false,
                wasOpened: false,

                createElems: function () {
                    var O = this;

                    //added by Himanshu to add disabled-sumo class if select dropdown is disabled.
                    if (O.E.attr('disabled')) {
                        O.E.wrap('<div class="SumoSelect disabled-sumo" tabindex="0" role="button" aria-expanded="false">');
                    }
                    else {
                        O.E.wrap('<div class="SumoSelect" tabindex="0" role="button" aria-expanded="false">');
                    }

                    O.select = O.E.parent();
                    O.caption = $('<span>');
                    O.CaptionCont = $('<p class="CaptionCont yellowBckg"><label><i></i></label></p>').addClass('SelectBox').attr('style', O.E.attr('style')).prepend(O.caption);
                    O.select.append(O.CaptionCont);

                    // default turn off if no multiselect
                    if (!O.is_multi) settings.okCancelInMulti = false

                    if (O.E.attr('disabled'))
                        O.select.addClass('disabled').removeAttr('tabindex');

                    //if output as csv and is a multiselect.
                    if (settings.outputAsCSV && O.is_multi && O.E.attr('name')) {
                        //create a hidden field to store csv value.
                        O.select.append($('<input class="HEMANT123" type="hidden" />').attr('name', O.E.attr('name')).val(O.getSelStr()));

                        // so it can not post the original select.
                        O.E.removeAttr('name');
                    }

                    //break for mobile rendring.. if forceCustomRendering is false
                    if (O.isMobile() && !settings.forceCustomRendering) {
                        O.setNativeMobile();
                        return;
                    }

                    // if there is a name attr in select add a class to container div
                    if (O.E.attr('name')) {
                        if (O.E.attr('name').indexOf('VendorUID') != '-1') {
                            O.select.addClass('vendorSumo');
                        }
                        O.select.addClass('sumo_' + O.E.attr('name').replace(/\[\]/, ''))
                    }

                    //hide original select
                    O.E.addClass('SumoUnder').attr('tabindex', '-1');

                    //## Creating the list...
                    O.optDiv = $('<div class="optWrapper ' + (settings.up ? 'up' : '') + '">');

                    if (settings.optWrapperCstmWidthToAuto) {
                        O.optDiv.css('width', 'auto');//settings.optWrapperCstmWidth + "px");
                    }

                    //branch for floating list in low res devices.
                    O.floatingList();

                    //Creating the markup for the available options
                    O.ul = $('<ul class="options">');
                    O.optDiv.append(O.ul);

                    // Select all functionality
                    if (settings.selectAll) O.SelAll();

                    // search functionality
                    if (settings.search) O.Search();

                    O.ul.append(O.prepItems(O.E.children()));

                    //if multiple then add the class multiple and add OK / CANCEL button
                    if (O.is_multi) O.multiSelelect();

                    O.select.append(O.optDiv);
                    O.basicEvents();
                    O.selAllState();

                    if (O.is_multi && O.ul.find('li.optionAny.selected').length > 0) O.initComplete(O.ul.find('li.optionAny.selected'));
                },

                prepItems: function (opts, d) {
                    var lis = [], O = this;
                    $(opts).each(function (i, opt) {       // parsing options to li
                        opt = $(opt);

                        if (opt.is('optgroup')) {

                            if (opt.attr('data-level') == 2)
                            {
                                var isSelected = opt.nextUntil('[data-level="2"]').children().filter(function () {
                                    if ($(this).is(':selected')) return this;
                                }).get().length == opt.nextUntil('[data-level="2"]').children().length;
                            }
                            else
                            {
                                var isSelected = opt.children().filter(function () {
                                    if ($(this).is(':selected')) return this;
                                }).get().length == opt.children().length;

                            }
                            
                            var currClass = ((opt.attr('data-group') == "entity" || opt.attr('data-group') == "region" || opt.attr('data-group') == "categoryType" || opt.attr('data-group') == "categoryGroup") ? (opt.attr('data-group') + '-li ') : '')

                            var dataClassAttr = '';

                            if (opt.attr('data-class') != undefined) {
                                dataClassAttr = ' ' + opt.attr('data-class');
                            }

                            var optGrp = $('<li class="group ' + currClass + (opt[0].disabled ? 'disabled' : '') + (isSelected ? ' selected' : '') + (dataClassAttr) + '" data-level ="' + (opt.attr('data-group') == "entity" || opt.attr('data-group') == "categoryType" ? 2 : 1)+ '"><label class="grp-label">' + opt.attr('label') + '</label><ul></ul></li>');
                            
                            optGrp.find('ul').append(O.prepItems(opt.children(), opt[0].disabled)).end();

                            optGrp.on('click', function (ev) {
                                
                                if ($(this).attr('data-level') == 2) {
                                    
                                    var og = $(this);
                                    $(og).toggleClass('selected');
                                    
                                    if ($(og).hasClass('selected'))
                                        $(og).nextUntil('[data-level="2"]').find('li').parents('li').addClass('selected');
                                    else
                                        $(og).nextUntil('[data-level="2"]').find('li').parents('li').removeClass('selected');

                                    $(og).nextUntil('[data-level="2"]').find('li.opt').not('.hidden').each(function (ix, e) {
                                        li = $(e);
                                        if ($(og).hasClass('selected')) {
                                            if (!li.hasClass('selected') && !li.hasClass('disabled')) {
                                                li.addClass('selected');
                                                li.data('opt')[0].selected = li.hasClass('selected');
                                            }
                                        }
                                        else {
                                            if (li.hasClass('selected') && !li.hasClass('disabled')) {
                                                li.removeClass('selected');
                                                li.data('opt')[0].selected = li.hasClass('selected');
                                            }
                                        }
                                    });
                                    O.selAllState();
                                    O.setText();
                                    O.callChange();
                                }
 
                                if ($(ev.target).hasClass('grp-label') && !($(ev.target).closest('li').hasClass('disabled') || $(ev.target).closest('li').hasClass('not-selectable'))) {

                                    var og = $(this);

                                    if ($(og).find('li.opt:not(.hidden)').length > 0) {

                                        $(og).toggleClass('selected');

                                        $(og).find('li.opt').not('.hidden').each(function (ix, e) {
                                            li = $(e);
                                            if ($(og).hasClass('selected')) {
                                                if (!li.hasClass('selected') && !li.hasClass('disabled')) {
                                                    li.addClass('selected');
                                                    li.data('opt')[0].selected = li.hasClass('selected');
                                                }
                                            }
                                            else {
                                                if (li.hasClass('selected') && !li.hasClass('disabled')) {
                                                    li.removeClass('selected');
                                                    li.data('opt')[0].selected = li.hasClass('selected');
                                                }
                                            }
                                        });

                                        if ($(og).hasClass('selected') && ($(og).prevAll('[data-level="2"]').eq(0).nextUntil('[data-level="2"]').find('li.selected').length == $(og).prevAll('[data-level="2"]').eq(0).nextUntil('[data-level="2"]').find('li').length))
                                            $(og).prevAll('[data-level="2"]').eq(0).addClass('selected');
                                        else
                                            $(og).prevAll('[data-level="2"]').eq(0).removeClass('selected');

                                        if ($(og).find('li.opt').hasClass('bud-comp'))
                                            O.budCompState($(og));
                                        else {
                                            O.selAllState();
                                            O.setText();
                                            O.callChange();
                                        }
                                        
                                    }
                                }
                            });
                            lis.push(optGrp);
                        }
                        else {
                            lis.push(O.createLi(opt, d));
                        }

                        //lis.push(opt.is('optgroup') ?
                        //    $('<li class="group ' + (opt[0].disabled ? 'disabled' : '') + '"><label>' + opt.attr('label') + '</label><ul></ul><li>')
                        //    .find('ul')
                        //    .append(O.prepItems(opt.children(), opt[0].disabled))
                        //    .end()
                        //    :
                        //    O.createLi(opt, d)
                        //    );                       
                    })
                    return lis;
                },

                //## Creates a LI element from a given option and binds events to it
                //## returns the jquery instance of li (not inserted in dom)
                createLi: function (opt, d) {
                    var O = this;
                    var liClass = (O.E.attr('name') == "displayViewOption" ? opt.val() : "");

                    if (!opt.attr('value')) opt.attr('value', opt.val());
                    // todo: remove this data val 
                    li = $('<li class="opt ' + liClass + '"><label>' + opt.text() + '</label></li>');//.data('val',opt.val());
                    li.data('opt', opt);    // store a direct reference to option.
                    opt.data('li', li);    // store a direct reference to list item.
                    if (O.is_multi) li.prepend('<span><i></i></span>');
                    
                    if (opt[0].disabled || d || (opt.attr('data-notallowed') != undefined && opt.attr('data-notallowed') == "1") || liClass == "Weeks")
                        li = li.addClass('disabled');
                    //commented by Himanshu
                    //if (opt.attr('data-allocated') == "1") //data attribute should be uniquely used- Used in Add/Edit Employee Allocation
                    //    li = li.addClass('allocated-employee');
                    O.onOptClick(li);

                    if (opt[0].selected)// && !opt[0].disabled)
                    {
                        li.addClass('selected');
                    }
                    if (opt.attr('class'))
                        li.addClass(opt.attr('class'));
                    if (opt.attr('data-count'))
                        li.attr("data-count", opt.attr('data-count'));

                    return li;
                },

                //## Called after the initialization is complete
                //## added by Himanshu
                initComplete: function (opt) {
                    var O = this;

                    O.E.find('option:not(.optionAny)').removeAttr('selected').attr('disabled');

                    O.optDiv.find('ul.options li:not(.group):not(.optionAny)').toggleClass('selected', false).toggleClass('disabled', true);

                    O.optDiv.find('ul.options li.group').toggleClass('selected', false).toggleClass('disabled', true);

                    O.setText();
                },

                //## Returns the selected items as string in a Multiselect.
                getSelStr: function () {
                    // get the pre selected items.
                    sopt = [];
                    this.E.find('option:selected').each(function () { sopt.push($(this).val()); });
                    return sopt.join(settings.csvSepChar);
                },

                //## THOSE OK/CANCEL BUTTONS ON MULTIPLE SELECT.
                multiSelelect: function () {
                    var O = this;
                    O.optDiv.addClass('multiple');
                    O.okbtn = $('<p class="btnOk">' + settings.locale[0] + '</p>').click(function () {

                        //if combined change event is set.
                        if (settings.triggerChangeCombined) {

                            //check for a change in the selection.
                            changed = false;
                            if (O.E.find('option:selected').length != O.Pstate.length) {
                                changed = true;
                            }
                            else {
                                O.E.find('option').each(function (i, e) {
                                    if (e.selected && O.Pstate.indexOf(i) < 0) changed = true;
                                });
                            }

                            if (changed) {
                                O.callChange();
                                O.setText();
                            }
                        }
                        O.hideOpts();
                    });
                    O.cancelBtn = $('<p class="btnCancel">' + settings.locale[1] + '</p>').click(function () {
                        O._cnbtn();
                        O.hideOpts();
                    });
                    O.optDiv.append($('<div class="MultiControls">').append(O.okbtn).append(O.cancelBtn));
                },

                _cnbtn: function () {
                    var O = this;
                    //remove all selections
                    O.E.find('option:selected').each(function () { this.selected = false; });
                    O.optDiv.find('li.selected').removeClass('selected')

                    //restore selections from saved state.
                    for (var i = 0; i < O.Pstate.length; i++) {
                        O.E.find('option')[O.Pstate[i]].selected = true;
                        O.ul.find('li.opt').eq(O.Pstate[i]).addClass('selected');
                    }
                    O.selAllState();
                },

                SelAll: function () {
                    
                    var O = this;
                    if (!O.is_multi) return;
                    O.selAll = $('<p class="select-all"><span><i></i></span><label>' + settings.locale[2] + '</label></p>');

                    O.selAll.on('click', function () {

                        if (O.selAll.hasClass('partial')) {
                            O.selAll.removeClass('selected');
                        }

                        //O.toggSelAll(!);
                        O.selAll.toggleClass('selected');

                        //if (O.selAll.hasClass('selected')) {
                        //    O.optDiv.find('li.opt').not('.hidden').not('.selected').trigger('click');
                        //}
                        //else {
                        //    O.optDiv.find('li.opt.selected').not('.hidden').trigger('click');
                        //}

                        O.optDiv.find('li.opt').not('.hidden').each(function (ix, e) {
                            li = $(e);
                            if (O.selAll.hasClass('selected')) {
                                if (!li.hasClass('selected') && !li.hasClass('disabled')) {
                                    li.addClass('selected');
                                    li.data('opt')[0].selected = li.hasClass('selected');
                                }
                            }
                            else {
                                if (li.hasClass('selected') && !li.hasClass('disabled')) {
                                    li.removeClass('selected');
                                    li.data('opt')[0].selected = li.hasClass('selected');
                                }
                            }

                            if ($(li).closest('ul').find('li.opt:not(.disabled)').length == $(li).closest('ul').find('li.opt.selected').length) {
                                $(li).closest('.group').addClass('selected');
                                $(li).closest('.group').prev().addClass('selected');
                            }
                            else {
                                $(li).closest('.group').removeClass('selected');
                                $(li).closest('.group').prev().removeClass('selected');

                            }

                        });
                        O.selAllState();
                        O.setText();
                        O.callChange();
                    });

                    O.optDiv.prepend(O.selAll);
                },

                // search module (can be removed if not required.)
                Search: function () {
                    var O = this,
                        cc = O.CaptionCont.addClass('search'),
                        P = $('<p class="no-match">');

                    O.ftxt = $('<input type="text" class="search-txt sumo-search" value="" placeholder="' + settings.searchText + '">')
                        .on('click', function (e) {
                            e.stopPropagation();
                        });
                    cc.append(O.ftxt);
                    O.optDiv.children('ul').after(P);

                    O.ftxt.on('keyup.sumo', function () {
                        var hid = O.optDiv.find('ul.options li.opt').each(function (ix, e) {
                            e = $(e);
                            if (e.text().toLowerCase().indexOf(O.ftxt.val().toLowerCase()) > -1)
                                e.removeClass('hidden');
                            else
                                e.addClass('hidden');
                        }).not('.hidden');

                        O.optDiv.children('ul').after(P).find('.group').each(function () {
                            if ($(this).attr('data-level') == 2) {
                                if ($(this).nextUntil('[data-level="2"]').find('ul li').not(".hidden").length == 0) {
                                    $(this).addClass('hidden');
                                }
                                else {
                                    $(this).removeClass('hidden');
                                }
                            }
                            else {
                                if ($(this).find('ul li').not(".hidden").length == 0) {
                                    $(this).addClass('hidden');
                                }
                                else {
                                    $(this).removeClass('hidden');
                                }
                            }
                        });

                        P.html(settings.noMatch.replace(/\{0\}/g, O.ftxt.val())).toggle(!hid.length);

                        if (!$(P).is(':visible')) O.selAllState();
                    });
                },

                selAllState: function () {
                    var O = this;
                    if (settings.selectAll) {
                        var sc = 0, vc = 0;
                        O.optDiv.find('li.opt:not(".disabled")').not('.hidden').each(function (ix, e) {
                            if ($(e).hasClass('selected')) sc++;
                            if (!$(e).hasClass('disabled')) vc++;
                        });
                        //select all checkbox state change.
                        if (sc == vc) O.selAll.removeClass('partial').addClass('selected');
                        else if (sc == 0) O.selAll.removeClass('selected partial');
                        else O.selAll.addClass('partial')//.removeClass('selected');
                    }
                },

                showOpts: function () {
                    var O = this;
                    if (O.E.attr('disabled') || O.E.attr('readonly')) return; // if select is disabled then retrun
                    O.E.trigger('sumo:opening', O);
                    O.is_opened = true;
                    O.wasOpened = true;
                    O.select.addClass('open').attr('aria-expanded', 'true');
                    O.E.trigger('sumo:opened', O);

                    if (O.ftxt) O.ftxt.focus();
                    else O.select.focus();

                    // hide options on click outside.
                    $(document).on('click.sumo', function (e) {
                        if (!O.select.is(e.target)                  // if the target of the click isn't the container...
                            && O.select.has(e.target).length === 0) { // ... nor a descendant of the container
                            if (!O.is_opened) return;
                            O.hideOpts();
                            if (settings.okCancelInMulti) O._cnbtn();
                        }
                    });

                    if (O.is_floating) {
                        H = O.optDiv.children('ul').outerHeight() + 2;  // +2 is clear fix
                        if (O.is_multi) H = H + parseInt(O.optDiv.css('padding-bottom'));
                        O.optDiv.css('height', H);
                        $('body').addClass('sumoStopScroll');
                    }

                    O.setPstate();
                },

                //maintain state when ok/cancel buttons are available storing the indexes.
                setPstate: function () {
                    var O = this;
                    if (O.is_multi && (O.is_floating || settings.okCancelInMulti)) {
                        O.Pstate = [];
                        // assuming that find returns elements in tree order
                        O.E.find('option').each(function (i, e) { if (e.selected) O.Pstate.push(i); });
                    }
                },

                callChange: function () {
                    var O = this;
                    O.ifChanged = true;
                    this.E.trigger('change').trigger('click');
                },

                budCompState: function (item) {
                    var O = this;
                    var $li = item

                    if ($li.parents('ul.options').find('li.bud-comp.selected').length <= 1)
                        return

                    if ($li.hasClass('group'))
                        $li = $li.find('li.opt').eq(0);
                    
                    var currCount = parseInt($li.attr('data-count'));
                    var minCount = parseInt($li.parents('ul.options').find('li.opt.selected:first').attr('data-count'));
                    var maxCount = parseInt($li.parents('ul.options').find('li.opt.selected:last').attr('data-count'));

                    if ($li.hasClass('selected')) {
                        
                        $li.parents('ul.options').find('li.opt').filter(function () {
                            return $(this).attr('data-count') > minCount && $(this).attr('data-count') < maxCount
                        }).each(function (x, e) {
                            var li = $(e);
                            if (!li.hasClass('selected')) {
                                 li.addClass('selected');
                                 li.data('opt')[0].selected = li.hasClass('selected');
                            }
                        })
                    }
                    else if (minCount < currCount) {

                        $li.parents('ul.options').find('li.opt').filter(function () {
                            return $(this).attr('data-count') > currCount && $(this).attr('data-count') <= maxCount
                        }).each(function (x, e) {
                            var li = $(e);
                            if (li.hasClass('selected')) {
                                li.removeClass('selected');
                                li.data('opt')[0].selected = li.hasClass('selected');
                            }
                        })
                    }

                    $li.parents('ul.options').find('li.group').each(function (x, e) {
                        var li = $(e);
                        if (li.find('li.opt').length == li.find('li.opt.selected').length) {
                            li.addClass('selected');
                        }
                        else {
                            li.removeClass('selected');
                        }
                    })

                    O.selAllState();
                    O.setText();
                    O.callChange();
                },

                hideOpts: function () {
                    var O = this;
                    if (O.is_opened) {
                        O.E.trigger('sumo:closing', O);
                        O.is_opened = false;
                        O.select.removeClass('open').attr('aria-expanded', 'true').find('ul li.sel').removeClass('sel');
                        O.E.trigger('sumo:closed', O);
                        $(document).off('click.sumo');
                        O.select.focus();
                        $('body').removeClass('sumoStopScroll');

                        // clear the search
                        if (settings.search) {
                            O.ftxt.val('');
                            O.optDiv.find('ul.options li').removeClass('hidden');
                            O.optDiv.find('.no-match').toggle(false);
                        }

                        //commented by Himanshu as the showing SelectAll option selected/unselected was not correctly handled if options are disabled
                        //remove selected from select all if not all are selected
                        //if (O.E.find('option').length != O.E.find('option:selected').length) {
                        //    if (O.selAll) O.selAll.removeClass('selected');
                        //}

                        O.selAllState();
                        O.setText();
                    }
                },
                setOnOpen: function () {
                    var O = this,
                        li = O.optDiv.find('li.opt:not(.hidden)').eq(settings.search ? 0 : O.E[0].selectedIndex);

                    O.optDiv.find('li.sel').removeClass('sel');
                    li.addClass('sel');
                    O.showOpts();
                },
                nav: function (up) {
                    var O = this, c,
                    s = O.ul.find('li.opt:not(.disabled, .hidden)'),
                    sel = O.ul.find('li.opt.sel:not(.hidden)'),
                    idx = s.index(sel);
                    if (O.is_opened && sel.length) {

                        if (up && idx > 0)
                            c = s.eq(idx - 1);
                        else if (!up && idx < s.length - 1 && idx > -1)
                            c = s.eq(idx + 1);
                        else return; // if no items before or after

                        sel.removeClass('sel');
                        sel = c.addClass('sel');

                        // setting sel item to visible view.
                        var ul = O.ul,
                            st = ul.scrollTop(),
                            t = sel.position().top + st;
                        if (t >= st + ul.height() - sel.outerHeight())
                            ul.scrollTop(t - ul.height() + sel.outerHeight());
                        if (t < st)
                            ul.scrollTop(t);

                    }
                    else
                        O.setOnOpen();
                },

                basicEvents: function () {
                    var O = this;
                    O.CaptionCont.click(function (evt) {
                        O.E.trigger('click');
                        if (O.is_opened) O.hideOpts(); else O.showOpts();
                        evt.stopPropagation();
                    });

                    O.select.on('keydown.sumo', function (e) {
                        switch (e.which) {
                            case 38: // up
                                O.nav(true);
                                break;

                            case 40: // down
                                O.nav(false);
                                break;

                            case 32: // space
                                if (settings.search && O.ftxt.is(e.target)) return;
                            case 13: // enter
                                if (O.is_opened)
                                    O.optDiv.find('ul li.sel').trigger('click');
                                else
                                    O.setOnOpen();
                                break;
                            case 9:	 //tab
                            case 27: // esc
                                if (settings.okCancelInMulti) O._cnbtn();
                                O.hideOpts();
                                return;

                            default:
                                return; // exit this handler for other keys
                        }
                        e.preventDefault(); // prevent the default action (scroll / move caret)
                    });

                    $(window).on('resize.sumo', function () {
                        O.floatingList();
                    });
                },

                onOptClick: function (li) {
                    var O = this;
                    li.click(function (ev) {
                        var li = $(this);
                        if (li.hasClass('disabled')) return;

                        if (O.E.hasClass('isWeeklyView')) {
                            $(li).closest('.group').find('.grp-label').trigger('click');
                            return
                        }

                        txt = "";
                        if (O.is_multi) {
                            li.toggleClass('selected');
                            li.data('opt')[0].selected = li.hasClass('selected');
                            O.selAllState();
                        }
                        else {
                            li.parent().find('li.selected').removeClass('selected'); //if not multiselect then remove all selections from this list
                            li.toggleClass('selected');
                            li.data('opt')[0].selected = true;
                        }

                        //branch for combined change event.
                        if (!(O.is_multi && settings.triggerChangeCombined && (O.is_floating || settings.okCancelInMulti))) {
                            O.setText();
                            O.callChange();
                        }

                        if (!O.is_multi) O.hideOpts(); //if its not a multiselect then hide on single select.
                        
                        if ($(li).closest('ul').find('li.opt:not(.disabled)').length == $(li).closest('ul').find('li.opt.selected').length) {
                            $(li).closest('.group').addClass('selected');
                            if (O.E.find('li.group[data-level="2"]').length > 0) {
                                if ($(li).closest('.group').prev('[data-level="2"]').length > 0)
                                    $(li).closest('.group').prev().addClass('selected');
                                else
                                    $(li).closest('.group').prevUntil('[data-level="2"]').prev().addClass('selected');
                            }
                        }
                        else {
                            $(li).closest('.group').removeClass('selected');
                            if (O.E.find('li.group[data-level="2"]').length > 0) {
                                if ($(li).closest('.group').prev('[data-level="2"]').length > 0)
                                    $(li).closest('.group').prev().removeClass('selected');
                                else
                                    $(li).closest('.group').prevUntil('[data-level="2"]').prev().removeClass('selected');
                            }
                        }

                        if (li.hasClass('optionAny')) {                            
                            if (li.hasClass('selected')) {                                
                                O.E.find('option:not(.optionAny)').removeAttr('selected').attr('disabled');

                                O.optDiv.find('ul.options li:not(.group):not(.optionAny)').toggleClass('selected', false).toggleClass('disabled', true);

                                O.optDiv.find('ul.options li.group').toggleClass('selected', false).toggleClass('disabled', true);

                                O.setText();

                                //for (var loopVar = 1; loopVar < O.E.find('option').length; loopVar++) O.toggDis(true, loopVar);                                
                            }
                            else {
                                O.E.find('option:not(.optionAny)').removeAttr('disabled selected');

                                O.optDiv.find('ul.options li:not(.group):not(.optionAny)').toggleClass('selected', false).toggleClass('disabled', false);

                                O.optDiv.find('ul.options li.group').toggleClass('disabled', false);

                                O.setText();

                                //for (var loopVar = 1; loopVar < O.E.find('option').length; loopVar++) O.toggDis(false, loopVar);
                            }
                        }

                        if (li.hasClass('bud-comp'))
                            O.budCompState(li);

                        if (O.E.attr('name') == 'detailPeriodView') {

                            var $selectedLi = li.parents('ul').find('li.selected');

                            if ($selectedLi.length == 1) {
                                $selectedLi.addClass('disabled')
                            }
                            else {
                                $selectedLi.removeClass('disabled')
                            }
                        }

                        if (O.E.attr('name') == 'displayViewOption') {

                            var $selectedLi = li.parents('ul').find('li.selected');
                            li.parents('ul').find('li').removeClass('disabled');

                            if (li.parents('ul').find('li.Periods.selected').length == 1 || li.parents('ul').find('li.Quarters.selected').length == 1) {
                                li.parents('ul').find('li.Weeks').addClass('disabled');
                            }
                            else if (li.parents('ul').find('li.Weeks.selected').length == 1) {
                                li.parents('ul').find('li.Periods').addClass('disabled');
                                li.parents('ul').find('li.Quarters').addClass('disabled');
                            }

                            if ($selectedLi.length == 1)
                                $selectedLi.addClass('disabled')
                        }

                        ev.preventDefault();
                        ev.stopPropagation();
                    });
                },

                setText: function () {
                    var O = this;
                    O.placeholder = "";
                    if (O.is_multi) {
                        sels = O.E.find(':selected').not(':disabled'); //selected options.

                        for (i = 0; i < sels.length; i++) {
                            if (i + 1 >= settings.csvDispCount && settings.csvDispCount) {
                                if (sels.length == O.E.find('option').length && settings.captionFormatAllSelected) {
                                    O.placeholder = settings.captionFormatAllSelected.replace(/\{0\}/g, sels.length) + ',';
                                } else {
                                    O.placeholder = settings.captionFormat.replace(/\{0\}/g, sels.length) + ',';
                                }

                                break;
                            }
                            else O.placeholder += $(sels[i]).text() + ", ";
                        }
                        O.placeholder = O.placeholder.replace(/,([^,]*)$/, '$1'); //remove unexpected "," from last.
                    }
                    else {
                        O.placeholder = O.E.find(':selected').not(':disabled').text();
                    }

                    is_placeholder = false;

                    if (!O.placeholder) {

                        is_placeholder = true;

                        O.placeholder = O.E.attr('placeholder');
                        if (!O.placeholder)                  //if placeholder is there then set it
                            O.placeholder = O.E.find('option:disabled:selected').text();
                    }

                    O.placeholder = O.placeholder ? (settings.prefix + ' ' + O.placeholder) : settings.placeholder

                    //set display text
                    O.caption.html(O.placeholder);

                    if (O.E.find('option:selected').parents('td').hasClass('showVendorInTitle') && O.E.find('option:selected').length > 1) {
                        var title = O.E.find('option:selected').map(function () { return $(this).text() }).get().join()
                        O.CaptionCont.attr('title', title);
                    }
                    else {
                        O.CaptionCont.attr('title', O.placeholder);
                    }

                    //set the hidden field if post as csv is true.
                    csvField = O.select.find('input.HEMANT123');
                    if (csvField.length) csvField.val(O.getSelStr());

                    //add class placeholder if its a placeholder text.
                    if (is_placeholder) O.caption.addClass('placeholder'); else O.caption.removeClass('placeholder');
                    return O.placeholder;
                },

                isMobile: function () {

                    // Adapted from http://www.detectmobilebrowsers.com
                    var ua = navigator.userAgent || navigator.vendor || window.opera;

                    // Checks for iOs, Android, Blackberry, Opera Mini, and Windows mobile devices
                    for (var i = 0; i < settings.nativeOnDevice.length; i++) if (ua.toString().toLowerCase().indexOf(settings.nativeOnDevice[i].toLowerCase()) > 0) return settings.nativeOnDevice[i];
                    return false;
                },

                setNativeMobile: function () {
                    var O = this;
                    O.E.addClass('SelectClass')//.css('height', O.select.outerHeight());
                    O.mob = true;
                    O.E.change(function () {
                        O.setText();
                    });
                },

                floatingList: function () {
                    var O = this;
                    //called on init and also on resize.
                    //O.is_floating = true if window width is < specified float width
                    O.is_floating = $(window).width() <= settings.floatWidth;

                    //set class isFloating
                    O.optDiv.toggleClass('isFloating', O.is_floating);

                    //remove height if not floating
                    if (!O.is_floating) O.optDiv.css('height', '');

                    //toggle class according to okCancelInMulti flag only when it is not floating
                    O.optDiv.toggleClass('okCancelInMulti', settings.okCancelInMulti && !O.is_floating);
                },

                //HELPERS FOR OUTSIDERS
                // validates range of given item operations
                vRange: function (i) {
                    var O = this;
                    opts = O.E.find('option');
                    if (opts.length <= i || i < 0) throw "index out of bounds"
                    return O;
                },

                //toggles selection on c as boolean.
                toggSel: function (c, i) {
                    var O = this;
                    if (typeof (i) === "number") {
                        O.vRange(i);
                        opt = O.E.find('option')[i];
                    }
                    else {
                        opt = O.E.find('option[value="' + i + '"]')[0] || 0;
                    }
                    if (!opt || opt.disabled)
                        return;

                    if (opt.selected != c) {
                        opt.selected = c;
                        if (!O.mob) $(opt).data('li').toggleClass('selected', c);

                        O.callChange();
                        O.setPstate();
                        O.setText();
                        O.selAllState();
                    }
                },

                //toggles disabled on c as boolean.
                toggDis: function (c, i) {
                    var O = this.vRange(i);
                    if ($(O.E.find('option')[i]).data('notallowed') == undefined || $(O.E.find('option')[i]).data('notallowed') != 1) {
                        O.E.find('option')[i].disabled = c;
                        if (c) {
                            O.E.find('option')[i].selected = false;
                            $(O.E.find('option')[i]).data('li').toggleClass('selected', false);
                        }
                    }
                    if (!O.mob) {
                        O.optDiv.find('ul.options li:not(.group)').eq(i).toggleClass('disabled', c);//.removeClass('selected');'
                        if (O.optDiv.find('ul.options li:not(.group)').eq(i).closest('ul').find('li').length == O.optDiv.find('ul.options li:not(.group)').eq(i).closest('ul').find('li.disabled').length) {
                            O.optDiv.find('ul.options li:not(.group)').eq(i).parents('li').eq(0).toggleClass('disabled', c);
                        }
                        else {
                            O.optDiv.find('ul.options li:not(.group)').eq(i).parents('li').eq(0).toggleClass('disabled', false);
                        }
                    }
                    O.setText();
                },

                //toggles disabled on all itens as boolean.
                toggDisAll: function (c) {
                    var O = this;
                    if (c) O.E.find('option').removeAttr('selected').attr('disabled');
                    else O.E.find('option').removeAttr('selected disabled');
                    O.optDiv.find('ul.options li').toggleClass('selected', false).toggleClass('disabled', c);
                    O.setText();
                },

                // toggle disable/enable on complete select control
                toggSumo: function (val) {
                    var O = this;
                    O.enabled = val;
                    O.select.toggleClass('disabled', val);

                    if (val) {
                        O.E.attr('disabled', 'disabled');
                        O.select.removeAttr('tabindex');
                    }
                    else {
                        O.E.removeAttr('disabled');
                        O.select.attr('tabindex', '0');
                    }

                    return O;
                },

                //toggles alloption on c as boolean.
                toggSelAll: function (c) {
                    var O = this;

                    if (O.E.find('optgroup').length > 0) {
                        O.E.find('optgroup').each(function (ix, el) {
                            var $optgrp = $(this);
                            var optgrpIndex = $(this).index();

                            $optgrp.find('option').each(function () {
                                if ($optgrp.find('option')[$(this).index()].disabled) return;

                                $optgrp.find('option')[$(this).index()].selected = c;

                                if (!O.mob)
                                    O.optDiv.find('ul.options li.group').eq(optgrpIndex).find('ul li.opt').eq($(this).index()).toggleClass('selected', c);

                                O.setText();
                            });
                        });
                    }
                    else {
                        O.E.find('option').each(function (ix, el) {
                            if (O.E.find('option')[$(this).index()].disabled) return;
                            O.E.find('option')[$(this).index()].selected = c;
                            if (!O.mob)
                                O.optDiv.find('ul.options li').eq($(this).index()).toggleClass('selected', c);
                            O.setText();
                        });
                    }
                    if (!O.mob && O.selAll) O.selAll.removeClass('partial').toggleClass('selected', c);
                    O.callChange();
                    O.setPstate();
                },

                /* outside accessibility options
                   which can be accessed from the element instance.
                */
                reload: function () {
                    var elm = this.unload();
                    return $(elm).SumoSelect(settings);
                },

                unload: function () {
                    var O = this;
                    O.select.before(O.E);
                    O.E.show();

                    if (settings.outputAsCSV && O.is_multi && O.select.find('input.HEMANT123').length) {
                        O.E.attr('name', O.select.find('input.HEMANT123').attr('name')); // restore the name;
                    }
                    O.select.remove();
                    delete selObj.sumo;
                    return selObj;
                },

                //## add a new option to select at a given index.
                add: function (val, txt, i) {
                    if (typeof val == "undefined") throw "No value to add"

                    var O = this;
                    opts = O.E.find('option')
                    if (typeof txt == "number") { i = txt; txt = val; }
                    if (typeof txt == "undefined") { txt = val; }

                    opt = $("<option></option>").val(val).html(txt);

                    if (opts.length < i) throw "index out of bounds"

                    if (typeof i == "undefined" || opts.length == i) { // add it to the last if given index is last no or no index provides.
                        O.E.append(opt);
                        if (!O.mob) O.ul.append(O.createLi(opt));
                    }
                    else {
                        opts.eq(i).before(opt);
                        if (!O.mob) O.ul.find('li.opt').eq(i).before(O.createLi(opt));
                    }

                    return selObj;
                },

                //## removes an item at a given index.
                remove: function (i) {
                    var O = this.vRange(i);
                    O.E.find('option').eq(i).remove();
                    if (!O.mob) O.optDiv.find('ul.options li').eq(i).remove();
                    O.setText();
                },

                //## Select an item at a given index.
                selectItem: function (i) { this.toggSel(true, i); },

                //## UnSelect an iten at a given index.
                unSelectItem: function (i) { this.toggSel(false, i); },

                //## Select all items  of the select.
                selectAll: function () { this.toggSelAll(true); },

                //## UnSelect all items of the select.
                unSelectAll: function () { this.toggSelAll(false); },

                //## Disable an iten at a given index.
                disableItem: function (i) { this.toggDis(true, i) },

                //## Removes disabled an iten at a given index.
                enableItem: function (i) { this.toggDis(false, i) },

                //## Disable all itens.
                disableAll: function () { this.toggDisAll(true) },

                //## Enable all itens.
                enableAll: function () { this.toggDisAll(false) },

                //## New simple methods as getter and setter are not working fine in ie8-
                //## variable to check state of control if enabled or disabled.
                enabled: true,
                //## Enables the control
                enable: function () { return this.toggSumo(false) },

                //## Disables the control
                disable: function () { return this.toggSumo(true) },


                init: function () {
                    var O = this;
                    O.createElems();
                    O.setText();
                    return O
                }

            };

            selObj.sumo.init();
        });

        return ret.length == 1 ? ret[0] : ret;
    };


}(jQuery));
;
/*!
 * jquery.sumoselect - v3.0.2
 * http://hemantnegi.github.io/jquery.sumoselect
 * 2014-04-08
 *
 * Copyright 2015 Hemant Negi
 * Email : hemant.frnz@gmail.com
 * Compressor http://refresh-sf.com/
 */


(function ($) {

    'namespace sumo';
    $.fn.SumoSelectVendor = function (options) {

        // This is the easiest way to have default options.
        var settings = $.extend({
            placeholder: 'Select Here',   // Dont change it here.
            csvDispCount: 2,              // display no. of items in multiselect. 0 to display all.
            captionFormat: '{0} selected', // format of caption text. you can set your locale.
            captionFormatAllSelected: 'All selected ({0})', // format of caption text when all elements are selected. set null to use captionFormat. It will not work if there are disabled elements in select.
            floatWidth: 400,              // Screen width of device at which the list is rendered in floating popup fashion.
            forceCustomRendering: false,  // force the custom modal on all devices below floatWidth resolution.
            nativeOnDevice: ['Android', 'BlackBerry', 'iPhone', 'iPad', 'iPod', 'Opera Mini', 'IEMobile', 'Silk'], //
            outputAsCSV: false,           // true to POST data as csv ( false for Html control array ie. default select )
            csvSepChar: ',',              // separation char in csv mode
            okCancelInMulti: false,       // display ok cancel buttons in desktop mode multiselect also.
            triggerChangeCombined: true,  // im multi select mode wether to trigger change event on individual selection or combined selection.
            selectAll: false,             // to display select all button in multiselect mode.|| also select all will not be available on mobile devices.
            venList: [],
            search: false,                // to display input for filtering content. selectAlltext will be input text placeholder
            searchText: 'Search...',      // placeholder for search input
            noMatch: 'No matches for "{0}"',
            prefix: '',                   // some prefix usually the field name. eg. '<b>Hello</b>'
            locale: ['OK', 'Cancel', 'Select all'],  // all text that is used. don't change the index.
            up: false,                     // set true to open upside.
            optWrapperCstmWidthToAuto: false
        }, options);

        var ret = this.each(function () {
            var selObj = this; // the original select object.
            if (this.sumo || !$(this).is('select')) return; //already initialized

            this.sumo = {
                E: $(selObj),   //the jquery object of original select element.
                is_multi: $(selObj).attr('multiple'),  //if its a multiple select
                select: '',
                caption: '',
                placeholder: '',
                optDiv: '',
                CaptionCont: '',
                ul: '',
                is_floating: false,
                is_opened: false,
                //backdrop: '',
                mob: false, // if to open device default select
                Pstate: [],
                ifChanged: false,

                createElems: function () {
                    var O = this;

                    //added by Himanshu to add disabled-sumo class if select dropdown is disabled.
                    if (O.E.attr('disabled')) {
                        O.E.wrap('<div class="SumoSelect disabled-sumo" tabindex="0" role="button" aria-expanded="false">');
                    }
                    else {
                        O.E.wrap('<div class="SumoSelect" tabindex="0" role="button" aria-expanded="false">');
                    }

                    O.select = O.E.parent();
                    O.caption = $('<span>');
                    O.CaptionCont = $('<p class="CaptionCont yellowBckg"><label><i></i></label></p>').addClass('SelectBox').attr('style', O.E.attr('style')).prepend(O.caption);
                    O.select.append(O.CaptionCont);

                    // default turn off if no multiselect
                    if (!O.is_multi) settings.okCancelInMulti = false

                    if (O.E.attr('disabled'))
                        O.select.addClass('disabled').removeAttr('tabindex');

                    //if output as csv and is a multiselect.
                    if (settings.outputAsCSV && O.is_multi && O.E.attr('name')) {
                        //create a hidden field to store csv value.
                        O.select.append($('<input class="HEMANT123" type="hidden" />').attr('name', O.E.attr('name')).val(O.getSelStr()));

                        // so it can not post the original select.
                        O.E.removeAttr('name');
                    }

                    //break for mobile rendring.. if forceCustomRendering is false
                    if (O.isMobile() && !settings.forceCustomRendering) {
                        O.setNativeMobile();
                        return;
                    }

                    // if there is a name attr in select add a class to container div
                    if (O.E.attr('name')) O.select.addClass('sumo_' + O.E.attr('name').replace(/\[\]/, ''))

                    //hide original select
                    O.E.addClass('SumoUnder').attr('tabindex', '-1');

                    //## Creating the list...
                    O.optDiv = $('<div class="optWrapper ' + (settings.up ? 'up' : '') + '">');

                    if (settings.optWrapperCstmWidthToAuto) {
                        O.optDiv.css('width', 'auto');//settings.optWrapperCstmWidth + "px");
                    }

                    //branch for floating list in low res devices.
                    O.floatingList();

                    //Creating the markup for the available options
                    O.ul = $('<ul class="options">');
                    O.optDiv.append(O.ul);

                    // Select all functionality
                    if (settings.selectAll) O.SelAll();

                    // search functionality
                    if (settings.search) O.Search();

                    O.ul.append(O.prepItems(O.E.children()));

                    //if multiple then add the class multiple and add OK / CANCEL button
                    if (O.is_multi) O.multiSelelect();

                    O.select.append(O.optDiv);
                    O.basicEvents();
                    O.selAllState();
                   // O.removeUnselectOption();

                    if (O.is_multi && O.ul.find('li.optionAny.selected').length > 0) O.initComplete(O.ul.find('li.optionAny.selected'));

                    if (O.E.find('option:selected').length == 0) {
                        O.optDiv.find('p.select-all').removeClass('selected')
                        O.optDiv.addClass('hide')
                    }
                },

                prepItems: function (opts, d) {
                    var lis = [], O = this;
                    $(opts).each(function (i, opt) {       // parsing options to li
                        opt = $(opt);

                        if (opt.is('optgroup')) {

                            if (opt.attr('data-level') == 2) {
                                var isSelected = opt.nextUntil('[data-level="2"]').children().filter(function () {
                                    if ($(this).is(':selected')) return this;
                                }).get().length == opt.nextUntil('[data-level="2"]').children().length;
                            }
                            else {
                                var isSelected = opt.children().filter(function () {
                                    if ($(this).is(':selected')) return this;
                                }).get().length == opt.children().length;

                            }

                            var currClass = ((opt.attr('data-group') == "entity" || opt.attr('data-group') == "region") ? (opt.attr('data-group') + '-li ') : '')

                            var optGrp = $('<li class="group ' + currClass + (opt[0].disabled ? 'disabled' : '') + (isSelected ? ' selected' : '') + '" data-level ="' + (opt.attr('data-group') == "entity" ? 2 : 1) + '"><label class="grp-label">' + opt.attr('label') + '</label><ul></ul></li>');

                            optGrp.find('ul').append(O.prepItems(opt.children(), opt[0].disabled)).end();

                            optGrp.on('click', function (ev) {

                                if ($(this).attr('data-level') == 2) {

                                    var og = $(this);
                                    $(og).toggleClass('selected');

                                    if ($(og).hasClass('selected'))
                                        $(og).nextUntil('[data-level="2"]').find('li').parents('li').addClass('selected');
                                    else
                                        $(og).nextUntil('[data-level="2"]').find('li').parents('li').removeClass('selected');

                                    $(og).nextUntil('[data-level="2"]').find('li.opt').not('.hidden').each(function (ix, e) {
                                        li = $(e);
                                        if ($(og).hasClass('selected')) {
                                            if (!li.hasClass('selected') && !li.hasClass('disabled')) {
                                                li.addClass('selected');
                                                li.data('opt')[0].selected = li.hasClass('selected');
                                            }
                                        }
                                        else {
                                            if (li.hasClass('selected') && !li.hasClass('disabled')) {
                                                li.removeClass('selected');
                                                li.data('opt')[0].selected = li.hasClass('selected');
                                            }
                                        }
                                    });
                                    O.selAllState();
                                    O.setText();
                                    O.callChange();
                                }

                                if ($(ev.target).hasClass('grp-label') && !$(ev.target).closest('li').hasClass('disabled')) {

                                    var og = $(this);

                                    if ($(og).find('li.opt:not(.hidden)').length > 0) {

                                        $(og).toggleClass('selected');

                                        $(og).find('li.opt').not('.hidden').each(function (ix, e) {
                                            li = $(e);
                                            if ($(og).hasClass('selected')) {
                                                if (!li.hasClass('selected') && !li.hasClass('disabled')) {
                                                    li.addClass('selected');
                                                    li.data('opt')[0].selected = li.hasClass('selected');
                                                }
                                            }
                                            else {
                                                if (li.hasClass('selected') && !li.hasClass('disabled')) {
                                                    li.removeClass('selected');
                                                    li.data('opt')[0].selected = li.hasClass('selected');
                                                }
                                            }
                                        });

                                        if ($(og).hasClass('selected') && ($(og).prevAll('[data-level="2"]').eq(0).nextUntil('[data-level="2"]').find('li.selected').length == $(og).prevAll('[data-level="2"]').eq(0).nextUntil('[data-level="2"]').find('li').length))
                                            $(og).prevAll('[data-level="2"]').eq(0).addClass('selected');
                                        else
                                            $(og).prevAll('[data-level="2"]').eq(0).removeClass('selected');

                                        if ($(og).find('li.opt').hasClass('bud-comp'))
                                            O.budCompState($(og));
                                        else {
                                            O.selAllState();
                                            O.setText();
                                            O.callChange();
                                        }

                                    }
                                }
                            });
                            lis.push(optGrp);
                        }
                        else {
                            lis.push(O.createLi(opt, d));
                        }

                        //lis.push(opt.is('optgroup') ?
                        //    $('<li class="group ' + (opt[0].disabled ? 'disabled' : '') + '"><label>' + opt.attr('label') + '</label><ul></ul><li>')
                        //    .find('ul')
                        //    .append(O.prepItems(opt.children(), opt[0].disabled))
                        //    .end()
                        //    :
                        //    O.createLi(opt, d)
                        //    );                       
                    })
                    return lis;
                },

                //## Creates a LI element from a given option and binds events to it
                //## returns the jquery instance of li (not inserted in dom)
                createLi: function (opt, d) {
                    var O = this;

                    if (!opt.attr('value')) opt.attr('value', opt.val());
                    // todo: remove this data val 
                    li = $('<li class="opt"><label>' + opt.text() + '</label></li>');//.data('val',opt.val());
                    li.data('opt', opt);    // store a direct reference to option.
                    opt.data('li', li);    // store a direct reference to list item.
                    if (O.is_multi) li.prepend('<span><i></i></span>');

                    if (opt[0].disabled || d || (opt.attr('data-notallowed') != undefined && opt.attr('data-notallowed') == "1"))
                        li = li.addClass('disabled');

                    O.onOptClick(li);

                    if (opt[0].selected)// && !opt[0].disabled)
                    {
                        li.addClass('selected');
                    }
                    if (opt.attr('class'))
                        li.addClass(opt.attr('class'));
                    if (opt.attr('data-count'))
                        li.attr("data-count", opt.attr('data-count'));

                    return li;
                },

                //## Called after the initialization is complete
                //## added by Himanshu
                initComplete: function (opt) {
                    var O = this;

                    O.E.find('option:not(.optionAny)').removeAttr('selected').attr('disabled');

                    O.optDiv.find('ul.options li:not(.group):not(.optionAny)').toggleClass('selected', false).toggleClass('disabled', true);

                    O.optDiv.find('ul.options li.group').toggleClass('selected', false).toggleClass('disabled', true);

                    O.setText();
                },

                //## Returns the selected items as string in a Multiselect.
                getSelStr: function () {
                    // get the pre selected items.
                    sopt = [];
                    this.E.find('option:selected').each(function () { sopt.push($(this).val()); });
                    return sopt.join(settings.csvSepChar);
                },

                //## THOSE OK/CANCEL BUTTONS ON MULTIPLE SELECT.
                multiSelelect: function () {
                    var O = this;
                    O.optDiv.addClass('multiple');
                    O.okbtn = $('<p class="btnOk">' + settings.locale[0] + '</p>').click(function () {

                        //if combined change event is set.
                        if (settings.triggerChangeCombined) {

                            //check for a change in the selection.
                            changed = false;
                            if (O.E.find('option:selected').length != O.Pstate.length) {
                                changed = true;
                            }
                            else {
                                O.E.find('option').each(function (i, e) {
                                    if (e.selected && O.Pstate.indexOf(i) < 0) changed = true;
                                });
                            }

                            if (changed) {
                                O.callChange();
                                O.setText();
                            }
                        }
                        O.hideOpts();
                    });
                    O.cancelBtn = $('<p class="btnCancel">' + settings.locale[1] + '</p>').click(function () {
                        O._cnbtn();
                        O.hideOpts();
                    });
                    O.optDiv.append($('<div class="MultiControls">').append(O.okbtn).append(O.cancelBtn));
                },

                _cnbtn: function () {
                    var O = this;
                    //remove all selections
                    O.E.find('option:selected').each(function () { this.selected = false; });
                    O.optDiv.find('li.selected').removeClass('selected')

                    //restore selections from saved state.
                    for (var i = 0; i < O.Pstate.length; i++) {
                        O.E.find('option')[O.Pstate[i]].selected = true;
                        O.ul.find('li.opt').eq(O.Pstate[i]).addClass('selected');
                    }
                    O.selAllState();
                },

                SelAll: function () {

                    var O = this;
                    if (!O.is_multi) return;
                    O.selAll = $('<p class="select-all"><span><i></i></span><label>' + settings.locale[2] + '</label></p>');

                    O.selAll.on('click', function () {

                        if (O.selAll.hasClass('partial')) {
                            O.selAll.removeClass('selected');
                        }

                        //O.toggSelAll(!);
                        O.selAll.toggleClass('selected');

                        //if (O.selAll.hasClass('selected')) {
                        //    O.optDiv.find('li.opt').not('.hidden').not('.selected').trigger('click');
                        //}
                        //else {
                        //    O.optDiv.find('li.opt.selected').not('.hidden').trigger('click');
                        //}

                        O.optDiv.find('li.opt').not('.hidden').each(function (ix, e) {
                            li = $(e);
                            if (O.selAll.hasClass('selected')) {
                                if (!li.hasClass('selected') && !li.hasClass('disabled')) {
                                    li.addClass('selected');
                                    li.data('opt')[0].selected = li.hasClass('selected');
                                }
                            }
                            else {
                                if (li.hasClass('selected') && !li.hasClass('disabled')) {
                                    li.removeClass('selected');
                                    li.data('opt')[0].selected = li.hasClass('selected');
                                }
                            }

                            if ($(li).closest('ul').find('li.opt').length == $(li).closest('ul').find('li.opt.selected').length) {
                                $(li).closest('.group').addClass('selected');
                                $(li).closest('.group').prev().addClass('selected');
                            }
                            else {
                                $(li).closest('.group').removeClass('selected');
                                $(li).closest('.group').prev().removeClass('selected');

                            }

                        });
                        O.selAllState();
                        O.setText();
                        O.callChange();
                    });

                    O.optDiv.prepend(O.selAll);
                },

                // search module (can be removed if not required.)
                Search: function () {
                    var O = this,
                        cc = O.CaptionCont.addClass('search'),
                        P = $('<p class="no-match">');

                    O.ftxt = $('<input type="text" class="search-txt yellowBckg sumo-search" value="" placeholder="' + settings.searchText + '">')
                        .on('click', function (e) {
                            e.stopPropagation();
                        });
                    cc.append(O.ftxt);
                    O.optDiv.children('ul').after(P);

                    O.ftxt.on('keyup.sumo', function () {

                        var list = [];

                        if (O.E.find('option:selected').length > 0) {
                            O.removeUnselectOption();
                        }
                        else {
                            O.E.html('');
                            O.optDiv.find('ul.options').html('');
                            O.optDiv.find('p.select-all').addClass('hide')
                        }

                        if (O.ftxt.val() != '') {
                            list = $.grep(settings.venList, function (v) {
                                return v.ParentVENDescription.toLowerCase().includes(O.ftxt.val().toLowerCase()) || v.VENDescription.toLowerCase().includes(O.ftxt.val().toLowerCase());
                            });
                           //list = settings.venList.filter(function (vendor) {
                           //    return vendor.VENDescription.toLowerCase().includes(O.ftxt.val().toLowerCase())
                           //})


                            for (i = 0; i < list.length; i++) {

                                if (O.E.find('option[value="' + list[i].VendorUID + '"]').length == 0)
                                    O.E[0].sumo.add(list[i].VendorUID, list[i].VENDescription)
                            }

                            if (settings.optWrapperCstmWidthToAuto) {
                                O.optDiv.css('width', 'auto');
                            }

                            if (list.length > 0)
                                O.optDiv.removeClass('hide').find('p.select-all').removeClass('hide')

                            P.html(settings.noMatch.replace(/\{0\}/g, O.ftxt.val())).toggle(!list.length);
                        }
                    });
                },

                selAllState: function () {
                    var O = this;
                    if (settings.selectAll) {
                        var sc = 0, vc = 0;
                        O.optDiv.find('li.opt:not(".disabled")').not('.hidden').each(function (ix, e) {
                            if ($(e).hasClass('selected')) sc++;
                            if (!$(e).hasClass('disabled')) vc++;
                        });
                        //select all checkbox state change.
                        if (sc == vc) O.selAll.removeClass('partial').addClass('selected');
                        else if (sc == 0) O.selAll.removeClass('selected partial');
                        else O.selAll.addClass('partial')//.removeClass('selected');
                    }
                },

                showOpts: function () {
                    var O = this;
                    if (O.E.attr('disabled') || O.E.attr('readonly')) return; // if select is disabled then retrun
                    O.E.trigger('sumo:opening', O);
                    O.is_opened = true;
                    O.select.addClass('open').attr('aria-expanded', 'true');
                    O.E.trigger('sumo:opened', O);

                    if (O.ftxt) O.ftxt.focus();
                    else O.select.focus();

                    // hide options on click outside.
                    $(document).on('click.sumo', function (e) {
                        if (!O.select.is(e.target)                  // if the target of the click isn't the container...
                            && O.select.has(e.target).length === 0) { // ... nor a descendant of the container
                            if (!O.is_opened) return;
                            O.hideOpts();
                            if (settings.okCancelInMulti) O._cnbtn();
                        }
                    });

                    if (O.is_floating) {
                        H = O.optDiv.children('ul').outerHeight() + 2;  // +2 is clear fix
                        if (O.is_multi) H = H + parseInt(O.optDiv.css('padding-bottom'));
                        O.optDiv.css('height', H);
                        $('body').addClass('sumoStopScroll');
                    }

                    O.setPstate();
                },

                //maintain state when ok/cancel buttons are available storing the indexes.
                setPstate: function () {
                    var O = this;
                    if (O.is_multi && (O.is_floating || settings.okCancelInMulti)) {
                        O.Pstate = [];
                        // assuming that find returns elements in tree order
                        O.E.find('option').each(function (i, e) { if (e.selected) O.Pstate.push(i); });
                    }
                },

                callChange: function () {
                    var O = this;
                    O.ifChanged = true;
                    this.E.trigger('change').trigger('click');
                },

                budCompState: function (item) {
                    var O = this;
                    var $li = item

                    if ($li.parents('ul.options').find('li.bud-comp.selected').length <= 1)
                        return

                    if ($li.hasClass('group'))
                        $li = $li.find('li.opt').eq(0);

                    var currCount = parseInt($li.attr('data-count'));
                    var minCount = parseInt($li.parents('ul.options').find('li.opt.selected:first').attr('data-count'));
                    var maxCount = parseInt($li.parents('ul.options').find('li.opt.selected:last').attr('data-count'));

                    if ($li.hasClass('selected')) {

                        $li.parents('ul.options').find('li.opt').filter(function () {
                            return $(this).attr('data-count') > minCount && $(this).attr('data-count') < maxCount
                        }).each(function (x, e) {
                            var li = $(e);
                            if (!li.hasClass('selected')) {
                                li.addClass('selected');
                                li.data('opt')[0].selected = li.hasClass('selected');
                            }
                        })
                    }
                    else if (minCount < currCount) {

                        $li.parents('ul.options').find('li.opt').filter(function () {
                            return $(this).attr('data-count') > currCount && $(this).attr('data-count') <= maxCount
                        }).each(function (x, e) {
                            var li = $(e);
                            if (li.hasClass('selected')) {
                                li.removeClass('selected');
                                li.data('opt')[0].selected = li.hasClass('selected');
                            }
                        })
                    }

                    $li.parents('ul.options').find('li.group').each(function (x, e) {
                        var li = $(e);
                        if (li.find('li.opt').length == li.find('li.opt.selected').length) {
                            li.addClass('selected');
                        }
                        else {
                            li.removeClass('selected');
                        }
                    })

                    O.selAllState();
                    O.setText();
                    O.callChange();
                },

                hideOpts: function () {
                    var O = this;
                    if (O.is_opened) {
                        O.E.trigger('sumo:closing', O);
                        O.is_opened = false;
                        O.select.removeClass('open').attr('aria-expanded', 'true').find('ul li.sel').removeClass('sel');
                        O.E.trigger('sumo:closed', O);
                        $(document).off('click.sumo');
                        O.select.focus();
                        $('body').removeClass('sumoStopScroll');

                        // clear the search
                        if (settings.search) {
                            O.ftxt.val('');
                            O.optDiv.find('ul.options li').removeClass('hidden');
                            O.optDiv.find('.no-match').toggle(false);
                        }

                        //remove selected from select all if not all are selected
                        if (O.E.find('option').length != O.E.find('option:selected').length) {
                            if (O.selAll) O.selAll.removeClass('selected');
                        }

                        if (O.E.find('option:not(:selected)').length > 0) {
                            O.removeUnselectOption();
                        }

                        if (O.E.find('option').length == 0)
                            O.optDiv.addClass('hide')
                    }
                },
                setOnOpen: function () {
                    var O = this,
                        li = O.optDiv.find('li.opt:not(.hidden)').eq(settings.search ? 0 : O.E[0].selectedIndex);

                    O.optDiv.find('li.sel').removeClass('sel');
                    li.addClass('sel');
                    O.showOpts();
                },
                nav: function (up) {
                    var O = this, c,
                        s = O.ul.find('li.opt:not(.disabled, .hidden)'),
                        sel = O.ul.find('li.opt.sel:not(.hidden)'),
                        idx = s.index(sel);
                    if (O.is_opened && sel.length) {

                        if (up && idx > 0)
                            c = s.eq(idx - 1);
                        else if (!up && idx < s.length - 1 && idx > -1)
                            c = s.eq(idx + 1);
                        else return; // if no items before or after

                        sel.removeClass('sel');
                        sel = c.addClass('sel');

                        // setting sel item to visible view.
                        var ul = O.ul,
                            st = ul.scrollTop(),
                            t = sel.position().top + st;
                        if (t >= st + ul.height() - sel.outerHeight())
                            ul.scrollTop(t - ul.height() + sel.outerHeight());
                        if (t < st)
                            ul.scrollTop(t);

                    }
                    else
                        O.setOnOpen();
                },

                basicEvents: function () {
                    var O = this;
                    O.CaptionCont.click(function (evt) {
                        O.E.trigger('click');
                        if (O.is_opened) O.hideOpts(); else O.showOpts();
                        evt.stopPropagation();
                    });

                    O.select.on('keydown.sumo', function (e) {
                        switch (e.which) {
                            case 38: // up
                                O.nav(true);
                                break;

                            case 40: // down
                                O.nav(false);
                                break;

                            case 32: // space
                                if (settings.search && O.ftxt.is(e.target)) return;
                            case 13: // enter
                                if (O.is_opened)
                                    O.optDiv.find('ul li.sel').trigger('click');
                                else
                                    O.setOnOpen();
                                break;
                            case 9:	 //tab
                            case 27: // esc
                                if (settings.okCancelInMulti) O._cnbtn();
                                O.hideOpts();
                                return;

                            default:
                                return; // exit this handler for other keys
                        }
                        e.preventDefault(); // prevent the default action (scroll / move caret)
                    });

                    $(window).on('resize.sumo', function () {
                        O.floatingList();
                    });
                },

                onOptClick: function (li) {
                    var O = this;
                    li.click(function (ev) {
                        var li = $(this);
                        if (li.hasClass('disabled')) return;
                        txt = "";
                        if (O.is_multi) {
                            li.toggleClass('selected');
                            li.data('opt')[0].selected = li.hasClass('selected');
                            O.selAllState();
                        }
                        else {
                            li.parent().find('li.selected').removeClass('selected'); //if not multiselect then remove all selections from this list
                            li.toggleClass('selected');
                            li.data('opt')[0].selected = true;
                        }

                        //branch for combined change event.
                        if (!(O.is_multi && settings.triggerChangeCombined && (O.is_floating || settings.okCancelInMulti))) {
                            O.setText();
                            O.callChange();
                        }

                        if (!O.is_multi) O.hideOpts(); //if its not a multiselect then hide on single select.

                        if ($(li).closest('ul').find('li.opt').length == $(li).closest('ul').find('li.opt.selected').length) {
                            $(li).closest('.group').addClass('selected');
                            if (O.E.find('li.group[data-level="2"]').length > 0) {
                                if ($(li).closest('.group').prev('[data-level="2"]').length > 0)
                                    $(li).closest('.group').prev().addClass('selected');
                                else
                                    $(li).closest('.group').prevUntil('[data-level="2"]').prev().addClass('selected');
                            }
                        }
                        else {
                            $(li).closest('.group').removeClass('selected');
                            if (O.E.find('li.group[data-level="2"]').length > 0) {
                                if ($(li).closest('.group').prev('[data-level="2"]').length > 0)
                                    $(li).closest('.group').prev().removeClass('selected');
                                else
                                    $(li).closest('.group').prevUntil('[data-level="2"]').prev().removeClass('selected');
                            }
                        }

                        if (li.hasClass('optionAny')) {
                            if (li.hasClass('selected')) {
                                O.E.find('option:not(.optionAny)').removeAttr('selected').attr('disabled');

                                O.optDiv.find('ul.options li:not(.group):not(.optionAny)').toggleClass('selected', false).toggleClass('disabled', true);

                                O.optDiv.find('ul.options li.group').toggleClass('selected', false).toggleClass('disabled', true);

                                O.setText();

                                //for (var loopVar = 1; loopVar < O.E.find('option').length; loopVar++) O.toggDis(true, loopVar);                                
                            }
                            else {
                                O.E.find('option:not(.optionAny)').removeAttr('disabled selected');

                                O.optDiv.find('ul.options li:not(.group):not(.optionAny)').toggleClass('selected', false).toggleClass('disabled', false);

                                O.optDiv.find('ul.options li.group').toggleClass('disabled', false);

                                O.setText();

                                //for (var loopVar = 1; loopVar < O.E.find('option').length; loopVar++) O.toggDis(false, loopVar);
                            }
                        }

                        if (li.hasClass('bud-comp'))
                            O.budCompState(li);

                        if (O.E.attr('name') == 'detailPeriodView') {

                            var $selectedLi = li.parents('ul').find('li.selected');

                            if ($selectedLi.length == 1) {
                                $selectedLi.addClass('disabled')
                            }
                            else {
                                $selectedLi.removeClass('disabled')
                            }
                        }

                        ev.preventDefault();
                        ev.stopPropagation();
                    });
                },

                setText: function () {
                    var O = this;
                    O.placeholder = "";
                    if (O.is_multi) {
                        sels = O.E.find(':selected').not(':disabled'); //selected options.

                        for (i = 0; i < sels.length; i++) {
                            if (i + 1 >= settings.csvDispCount && settings.csvDispCount) {
                                //if (sels.length == O.E.find('option').length && settings.captionFormatAllSelected) {
                                //    O.placeholder = settings.captionFormatAllSelected.replace(/\{0\}/g, sels.length) + ',';
                                //} else {
                                //    }
                                O.placeholder = settings.captionFormat.replace(/\{0\}/g, sels.length) + ',';
                                break;
                            }
                            else O.placeholder += $(sels[i]).text() + ", ";
                        }
                        O.placeholder = O.placeholder.replace(/,([^,]*)$/, '$1'); //remove unexpected "," from last.
                    }
                    else {
                        O.placeholder = O.E.find(':selected').not(':disabled').text();
                    }

                    is_placeholder = false;

                    if (!O.placeholder) {

                        is_placeholder = true;

                        O.placeholder = O.E.attr('placeholder');
                        if (!O.placeholder)                  //if placeholder is there then set it
                            O.placeholder = O.E.find('option:disabled:selected').text();
                    }

                    O.placeholder = O.placeholder ? (settings.prefix + ' ' + O.placeholder) : settings.placeholder

                    //set display text
                    O.caption.html(O.placeholder);

                    if (O.E.find('option:selected').parents('td').hasClass('showVendorInTitle') && O.E.find('option:selected').length > 1) {
                        var title = O.E.find('option:selected').map(function () { return $(this).text() }).get().join()
                        O.CaptionCont.attr('title', title);
                    }
                    else {
                        O.CaptionCont.attr('title', O.placeholder);
                    }

                    //set the hidden field if post as csv is true.
                    csvField = O.select.find('input.HEMANT123');
                    if (csvField.length) csvField.val(O.getSelStr());

                    //add class placeholder if its a placeholder text.
                    if (is_placeholder) O.caption.addClass('placeholder'); else O.caption.removeClass('placeholder');
                    return O.placeholder;
                },

                isMobile: function () {

                    // Adapted from http://www.detectmobilebrowsers.com
                    var ua = navigator.userAgent || navigator.vendor || window.opera;

                    // Checks for iOs, Android, Blackberry, Opera Mini, and Windows mobile devices
                    for (var i = 0; i < settings.nativeOnDevice.length; i++) if (ua.toString().toLowerCase().indexOf(settings.nativeOnDevice[i].toLowerCase()) > 0) return settings.nativeOnDevice[i];
                    return false;
                },

                setNativeMobile: function () {
                    var O = this;
                    O.E.addClass('SelectClass')//.css('height', O.select.outerHeight());
                    O.mob = true;
                    O.E.change(function () {
                        O.setText();
                    });
                },

                floatingList: function () {
                    var O = this;
                    //called on init and also on resize.
                    //O.is_floating = true if window width is < specified float width
                    O.is_floating = $(window).width() <= settings.floatWidth;

                    //set class isFloating
                    O.optDiv.toggleClass('isFloating', O.is_floating);

                    //remove height if not floating
                    if (!O.is_floating) O.optDiv.css('height', '');

                    //toggle class according to okCancelInMulti flag only when it is not floating
                    O.optDiv.toggleClass('okCancelInMulti', settings.okCancelInMulti && !O.is_floating);
                },

                removeUnselectOption: function () {
                    var O = this
                    var indexList = O.E.find('option:not(:selected)').map(function () {
                        return $(this).index()
                    });

                    $.each(indexList, function (index) {
                        O.E[0].sumo.remove(indexList[indexList.length - index - 1]);
                    })
                },

                //HELPERS FOR OUTSIDERS
                // validates range of given item operations
                vRange: function (i) {
                    var O = this;
                    opts = O.E.find('option');
                    if (opts.length <= i || i < 0) throw "index out of bounds"
                    return O;
                },

                //toggles selection on c as boolean.
                toggSel: function (c, i) {
                    var O = this;
                    if (typeof (i) === "number") {
                        O.vRange(i);
                        opt = O.E.find('option')[i];
                    }
                    else {
                        opt = O.E.find('option[value="' + i + '"]')[0] || 0;
                    }
                    if (!opt || opt.disabled)
                        return;

                    if (opt.selected != c) {
                        opt.selected = c;
                        if (!O.mob) $(opt).data('li').toggleClass('selected', c);

                        O.callChange();
                        O.setPstate();
                        O.setText();
                        O.selAllState();
                    }
                },

                //toggles disabled on c as boolean.
                toggDis: function (c, i) {
                    var O = this.vRange(i);
                    if ($(O.E.find('option')[i]).data('notallowed') == undefined || $(O.E.find('option')[i]).data('notallowed') != 1) {
                        O.E.find('option')[i].disabled = c;
                        if (c) {
                            O.E.find('option')[i].selected = false;
                            $(O.E.find('option')[i]).data('li').toggleClass('selected', false);
                        }
                    }
                    if (!O.mob) {
                        O.optDiv.find('ul.options li:not(.group)').eq(i).toggleClass('disabled', c);//.removeClass('selected');'
                        if (O.optDiv.find('ul.options li:not(.group)').eq(i).closest('ul').find('li').length == O.optDiv.find('ul.options li:not(.group)').eq(i).closest('ul').find('li.disabled').length) {
                            O.optDiv.find('ul.options li:not(.group)').eq(i).parents('li').eq(0).toggleClass('disabled', c);
                        }
                        else {
                            O.optDiv.find('ul.options li:not(.group)').eq(i).parents('li').eq(0).toggleClass('disabled', false);
                        }
                    }
                    O.setText();
                },

                //toggles disabled on all itens as boolean.
                toggDisAll: function (c) {
                    var O = this;
                    if (c) O.E.find('option').removeAttr('selected').attr('disabled');
                    else O.E.find('option').removeAttr('selected disabled');
                    O.optDiv.find('ul.options li').toggleClass('selected', false).toggleClass('disabled', c);
                    O.setText();
                },

                // toggle disable/enable on complete select control
                toggSumo: function (val) {
                    var O = this;
                    O.enabled = val;
                    O.select.toggleClass('disabled', val);

                    if (val) {
                        O.E.attr('disabled', 'disabled');
                        O.select.removeAttr('tabindex');
                    }
                    else {
                        O.E.removeAttr('disabled');
                        O.select.attr('tabindex', '0');
                    }

                    return O;
                },

                //toggles alloption on c as boolean.
                toggSelAll: function (c) {
                    var O = this;
                    O.E.find('option').each(function (ix, el) {
                        if (O.E.find('option')[$(this).index()].disabled) return;
                        O.E.find('option')[$(this).index()].selected = c;
                        if (!O.mob)
                            O.optDiv.find('ul.options li').eq($(this).index()).toggleClass('selected', c);
                        O.setText();
                    });
                    if (!O.mob && O.selAll) O.selAll.removeClass('partial').toggleClass('selected', c);
                    O.callChange();
                    O.setPstate();
                },

                /* outside accessibility options
                   which can be accessed from the element instance.
                */
                reload: function () {
                    var elm = this.unload();
                    return $(elm).SumoSelectVendor(settings);
                },

                unload: function () {
                    var O = this;
                    O.select.before(O.E);
                    O.E.show();

                    if (settings.outputAsCSV && O.is_multi && O.select.find('input.HEMANT123').length) {
                        O.E.attr('name', O.select.find('input.HEMANT123').attr('name')); // restore the name;
                    }
                    O.select.remove();
                    delete selObj.sumo;
                    return selObj;
                },

                //## add a new option to select at a given index.
                add: function (val, txt, i) {
                    if (typeof val == "undefined") throw "No value to add"

                    var O = this;
                    opts = O.E.find('option')
                    if (typeof txt == "number") { i = txt; txt = val; }
                    if (typeof txt == "undefined") { txt = val; }

                    opt = $("<option></option>").val(val).html(txt);

                    if (opts.length < i) throw "index out of bounds"

                    if (typeof i == "undefined" || opts.length == i) { // add it to the last if given index is last no or no index provides.
                        O.E.append(opt);
                        if (!O.mob) O.ul.append(O.createLi(opt));
                    }
                    else {
                        opts.eq(i).before(opt);
                        if (!O.mob) O.ul.find('li.opt').eq(i).before(O.createLi(opt));
                    }

                    return selObj;
                },

                //## removes an item at a given index.
                remove: function (i) {
                    var O = this.vRange(i);
                    O.E.find('option').eq(i).remove();
                    if (!O.mob) O.optDiv.find('ul.options li').eq(i).remove();
                    O.setText();
                },

                //## Select an item at a given index.
                selectItem: function (i) { this.toggSel(true, i); },

                //## UnSelect an iten at a given index.
                unSelectItem: function (i) { this.toggSel(false, i); },

                //## Select all items  of the select.
                selectAll: function () { this.toggSelAll(true); },

                //## UnSelect all items of the select.
                unSelectAll: function () { this.toggSelAll(false); },

                //## Disable an iten at a given index.
                disableItem: function (i) { this.toggDis(true, i) },

                //## Removes disabled an iten at a given index.
                enableItem: function (i) { this.toggDis(false, i) },

                //## Disable all itens.
                disableAll: function () { this.toggDisAll(true) },

                //## Enable all itens.
                enableAll: function () { this.toggDisAll(false) },

                //## New simple methods as getter and setter are not working fine in ie8-
                //## variable to check state of control if enabled or disabled.
                enabled: true,
                //## Enables the control
                enable: function () { return this.toggSumo(false) },

                //## Disables the control
                disable: function () { return this.toggSumo(true) },


                init: function () {
                    var O = this;
                    O.createElems();
                    O.setText();
                    return O
                }

            };

            selObj.sumo.init();
        });

        return ret.length == 1 ? ret[0] : ret;
    };


}(jQuery));
;
//! moment.js

;(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    global.moment = factory()
}(this, (function () { 'use strict';

    var hookCallback;

    function hooks () {
        return hookCallback.apply(null, arguments);
    }

    // This is done to register the method called with moment()
    // without creating circular dependencies.
    function setHookCallback (callback) {
        hookCallback = callback;
    }

    function isArray(input) {
        return input instanceof Array || Object.prototype.toString.call(input) === '[object Array]';
    }

    function isObject(input) {
        // IE8 will treat undefined and null as object if it wasn't for
        // input != null
        return input != null && Object.prototype.toString.call(input) === '[object Object]';
    }

    function isObjectEmpty(obj) {
        if (Object.getOwnPropertyNames) {
            return (Object.getOwnPropertyNames(obj).length === 0);
        } else {
            var k;
            for (k in obj) {
                if (obj.hasOwnProperty(k)) {
                    return false;
                }
            }
            return true;
        }
    }

    function isUndefined(input) {
        return input === void 0;
    }

    function isNumber(input) {
        return typeof input === 'number' || Object.prototype.toString.call(input) === '[object Number]';
    }

    function isDate(input) {
        return input instanceof Date || Object.prototype.toString.call(input) === '[object Date]';
    }

    function map(arr, fn) {
        var res = [], i;
        for (i = 0; i < arr.length; ++i) {
            res.push(fn(arr[i], i));
        }
        return res;
    }

    function hasOwnProp(a, b) {
        return Object.prototype.hasOwnProperty.call(a, b);
    }

    function extend(a, b) {
        for (var i in b) {
            if (hasOwnProp(b, i)) {
                a[i] = b[i];
            }
        }

        if (hasOwnProp(b, 'toString')) {
            a.toString = b.toString;
        }

        if (hasOwnProp(b, 'valueOf')) {
            a.valueOf = b.valueOf;
        }

        return a;
    }

    function createUTC (input, format, locale, strict) {
        return createLocalOrUTC(input, format, locale, strict, true).utc();
    }

    function defaultParsingFlags() {
        // We need to deep clone this object.
        return {
            empty           : false,
            unusedTokens    : [],
            unusedInput     : [],
            overflow        : -2,
            charsLeftOver   : 0,
            nullInput       : false,
            invalidMonth    : null,
            invalidFormat   : false,
            userInvalidated : false,
            iso             : false,
            parsedDateParts : [],
            meridiem        : null,
            rfc2822         : false,
            weekdayMismatch : false
        };
    }

    function getParsingFlags(m) {
        if (m._pf == null) {
            m._pf = defaultParsingFlags();
        }
        return m._pf;
    }

    var some;
    if (Array.prototype.some) {
        some = Array.prototype.some;
    } else {
        some = function (fun) {
            var t = Object(this);
            var len = t.length >>> 0;

            for (var i = 0; i < len; i++) {
                if (i in t && fun.call(this, t[i], i, t)) {
                    return true;
                }
            }

            return false;
        };
    }

    function isValid(m) {
        if (m._isValid == null) {
            var flags = getParsingFlags(m);
            var parsedParts = some.call(flags.parsedDateParts, function (i) {
                return i != null;
            });
            var isNowValid = !isNaN(m._d.getTime()) &&
                flags.overflow < 0 &&
                !flags.empty &&
                !flags.invalidMonth &&
                !flags.invalidWeekday &&
                !flags.weekdayMismatch &&
                !flags.nullInput &&
                !flags.invalidFormat &&
                !flags.userInvalidated &&
                (!flags.meridiem || (flags.meridiem && parsedParts));

            if (m._strict) {
                isNowValid = isNowValid &&
                    flags.charsLeftOver === 0 &&
                    flags.unusedTokens.length === 0 &&
                    flags.bigHour === undefined;
            }

            if (Object.isFrozen == null || !Object.isFrozen(m)) {
                m._isValid = isNowValid;
            }
            else {
                return isNowValid;
            }
        }
        return m._isValid;
    }

    function createInvalid (flags) {
        var m = createUTC(NaN);
        if (flags != null) {
            extend(getParsingFlags(m), flags);
        }
        else {
            getParsingFlags(m).userInvalidated = true;
        }

        return m;
    }

    // Plugins that add properties should also add the key here (null value),
    // so we can properly clone ourselves.
    var momentProperties = hooks.momentProperties = [];

    function copyConfig(to, from) {
        var i, prop, val;

        if (!isUndefined(from._isAMomentObject)) {
            to._isAMomentObject = from._isAMomentObject;
        }
        if (!isUndefined(from._i)) {
            to._i = from._i;
        }
        if (!isUndefined(from._f)) {
            to._f = from._f;
        }
        if (!isUndefined(from._l)) {
            to._l = from._l;
        }
        if (!isUndefined(from._strict)) {
            to._strict = from._strict;
        }
        if (!isUndefined(from._tzm)) {
            to._tzm = from._tzm;
        }
        if (!isUndefined(from._isUTC)) {
            to._isUTC = from._isUTC;
        }
        if (!isUndefined(from._offset)) {
            to._offset = from._offset;
        }
        if (!isUndefined(from._pf)) {
            to._pf = getParsingFlags(from);
        }
        if (!isUndefined(from._locale)) {
            to._locale = from._locale;
        }

        if (momentProperties.length > 0) {
            for (i = 0; i < momentProperties.length; i++) {
                prop = momentProperties[i];
                val = from[prop];
                if (!isUndefined(val)) {
                    to[prop] = val;
                }
            }
        }

        return to;
    }

    var updateInProgress = false;

    // Moment prototype object
    function Moment(config) {
        copyConfig(this, config);
        this._d = new Date(config._d != null ? config._d.getTime() : NaN);
        if (!this.isValid()) {
            this._d = new Date(NaN);
        }
        // Prevent infinite loop in case updateOffset creates new moment
        // objects.
        if (updateInProgress === false) {
            updateInProgress = true;
            hooks.updateOffset(this);
            updateInProgress = false;
        }
    }

    function isMoment (obj) {
        return obj instanceof Moment || (obj != null && obj._isAMomentObject != null);
    }

    function absFloor (number) {
        if (number < 0) {
            // -0 -> 0
            return Math.ceil(number) || 0;
        } else {
            return Math.floor(number);
        }
    }

    function toInt(argumentForCoercion) {
        var coercedNumber = +argumentForCoercion,
            value = 0;

        if (coercedNumber !== 0 && isFinite(coercedNumber)) {
            value = absFloor(coercedNumber);
        }

        return value;
    }

    // compare two arrays, return the number of differences
    function compareArrays(array1, array2, dontConvert) {
        var len = Math.min(array1.length, array2.length),
            lengthDiff = Math.abs(array1.length - array2.length),
            diffs = 0,
            i;
        for (i = 0; i < len; i++) {
            if ((dontConvert && array1[i] !== array2[i]) ||
                (!dontConvert && toInt(array1[i]) !== toInt(array2[i]))) {
                diffs++;
            }
        }
        return diffs + lengthDiff;
    }

    function warn(msg) {
        if (hooks.suppressDeprecationWarnings === false &&
                (typeof console !==  'undefined') && console.warn) {
            console.warn('Deprecation warning: ' + msg);
        }
    }

    function deprecate(msg, fn) {
        var firstTime = true;

        return extend(function () {
            if (hooks.deprecationHandler != null) {
                hooks.deprecationHandler(null, msg);
            }
            if (firstTime) {
                var args = [];
                var arg;
                for (var i = 0; i < arguments.length; i++) {
                    arg = '';
                    if (typeof arguments[i] === 'object') {
                        arg += '\n[' + i + '] ';
                        for (var key in arguments[0]) {
                            arg += key + ': ' + arguments[0][key] + ', ';
                        }
                        arg = arg.slice(0, -2); // Remove trailing comma and space
                    } else {
                        arg = arguments[i];
                    }
                    args.push(arg);
                }
                warn(msg + '\nArguments: ' + Array.prototype.slice.call(args).join('') + '\n' + (new Error()).stack);
                firstTime = false;
            }
            return fn.apply(this, arguments);
        }, fn);
    }

    var deprecations = {};

    function deprecateSimple(name, msg) {
        if (hooks.deprecationHandler != null) {
            hooks.deprecationHandler(name, msg);
        }
        if (!deprecations[name]) {
            warn(msg);
            deprecations[name] = true;
        }
    }

    hooks.suppressDeprecationWarnings = false;
    hooks.deprecationHandler = null;

    function isFunction(input) {
        return input instanceof Function || Object.prototype.toString.call(input) === '[object Function]';
    }

    function set (config) {
        var prop, i;
        for (i in config) {
            prop = config[i];
            if (isFunction(prop)) {
                this[i] = prop;
            } else {
                this['_' + i] = prop;
            }
        }
        this._config = config;
        // Lenient ordinal parsing accepts just a number in addition to
        // number + (possibly) stuff coming from _dayOfMonthOrdinalParse.
        // TODO: Remove "ordinalParse" fallback in next major release.
        this._dayOfMonthOrdinalParseLenient = new RegExp(
            (this._dayOfMonthOrdinalParse.source || this._ordinalParse.source) +
                '|' + (/\d{1,2}/).source);
    }

    function mergeConfigs(parentConfig, childConfig) {
        var res = extend({}, parentConfig), prop;
        for (prop in childConfig) {
            if (hasOwnProp(childConfig, prop)) {
                if (isObject(parentConfig[prop]) && isObject(childConfig[prop])) {
                    res[prop] = {};
                    extend(res[prop], parentConfig[prop]);
                    extend(res[prop], childConfig[prop]);
                } else if (childConfig[prop] != null) {
                    res[prop] = childConfig[prop];
                } else {
                    delete res[prop];
                }
            }
        }
        for (prop in parentConfig) {
            if (hasOwnProp(parentConfig, prop) &&
                    !hasOwnProp(childConfig, prop) &&
                    isObject(parentConfig[prop])) {
                // make sure changes to properties don't modify parent config
                res[prop] = extend({}, res[prop]);
            }
        }
        return res;
    }

    function Locale(config) {
        if (config != null) {
            this.set(config);
        }
    }

    var keys;

    if (Object.keys) {
        keys = Object.keys;
    } else {
        keys = function (obj) {
            var i, res = [];
            for (i in obj) {
                if (hasOwnProp(obj, i)) {
                    res.push(i);
                }
            }
            return res;
        };
    }

    var defaultCalendar = {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    };

    function calendar (key, mom, now) {
        var output = this._calendar[key] || this._calendar['sameElse'];
        return isFunction(output) ? output.call(mom, now) : output;
    }

    var defaultLongDateFormat = {
        LTS  : 'h:mm:ss A',
        LT   : 'h:mm A',
        L    : 'MM/DD/YYYY',
        LL   : 'MMMM D, YYYY',
        LLL  : 'MMMM D, YYYY h:mm A',
        LLLL : 'dddd, MMMM D, YYYY h:mm A'
    };

    function longDateFormat (key) {
        var format = this._longDateFormat[key],
            formatUpper = this._longDateFormat[key.toUpperCase()];

        if (format || !formatUpper) {
            return format;
        }

        this._longDateFormat[key] = formatUpper.replace(/MMMM|MM|DD|dddd/g, function (val) {
            return val.slice(1);
        });

        return this._longDateFormat[key];
    }

    var defaultInvalidDate = 'Invalid date';

    function invalidDate () {
        return this._invalidDate;
    }

    var defaultOrdinal = '%d';
    var defaultDayOfMonthOrdinalParse = /\d{1,2}/;

    function ordinal (number) {
        return this._ordinal.replace('%d', number);
    }

    var defaultRelativeTime = {
        future : 'in %s',
        past   : '%s ago',
        s  : 'a few seconds',
        ss : '%d seconds',
        m  : 'a minute',
        mm : '%d minutes',
        h  : 'an hour',
        hh : '%d hours',
        d  : 'a day',
        dd : '%d days',
        M  : 'a month',
        MM : '%d months',
        y  : 'a year',
        yy : '%d years'
    };

    function relativeTime (number, withoutSuffix, string, isFuture) {
        var output = this._relativeTime[string];
        return (isFunction(output)) ?
            output(number, withoutSuffix, string, isFuture) :
            output.replace(/%d/i, number);
    }

    function pastFuture (diff, output) {
        var format = this._relativeTime[diff > 0 ? 'future' : 'past'];
        return isFunction(format) ? format(output) : format.replace(/%s/i, output);
    }

    var aliases = {};

    function addUnitAlias (unit, shorthand) {
        var lowerCase = unit.toLowerCase();
        aliases[lowerCase] = aliases[lowerCase + 's'] = aliases[shorthand] = unit;
    }

    function normalizeUnits(units) {
        return typeof units === 'string' ? aliases[units] || aliases[units.toLowerCase()] : undefined;
    }

    function normalizeObjectUnits(inputObject) {
        var normalizedInput = {},
            normalizedProp,
            prop;

        for (prop in inputObject) {
            if (hasOwnProp(inputObject, prop)) {
                normalizedProp = normalizeUnits(prop);
                if (normalizedProp) {
                    normalizedInput[normalizedProp] = inputObject[prop];
                }
            }
        }

        return normalizedInput;
    }

    var priorities = {};

    function addUnitPriority(unit, priority) {
        priorities[unit] = priority;
    }

    function getPrioritizedUnits(unitsObj) {
        var units = [];
        for (var u in unitsObj) {
            units.push({unit: u, priority: priorities[u]});
        }
        units.sort(function (a, b) {
            return a.priority - b.priority;
        });
        return units;
    }

    function zeroFill(number, targetLength, forceSign) {
        var absNumber = '' + Math.abs(number),
            zerosToFill = targetLength - absNumber.length,
            sign = number >= 0;
        return (sign ? (forceSign ? '+' : '') : '-') +
            Math.pow(10, Math.max(0, zerosToFill)).toString().substr(1) + absNumber;
    }

    var formattingTokens = /(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;

    var localFormattingTokens = /(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g;

    var formatFunctions = {};

    var formatTokenFunctions = {};

    // token:    'M'
    // padded:   ['MM', 2]
    // ordinal:  'Mo'
    // callback: function () { this.month() + 1 }
    function addFormatToken (token, padded, ordinal, callback) {
        var func = callback;
        if (typeof callback === 'string') {
            func = function () {
                return this[callback]();
            };
        }
        if (token) {
            formatTokenFunctions[token] = func;
        }
        if (padded) {
            formatTokenFunctions[padded[0]] = function () {
                return zeroFill(func.apply(this, arguments), padded[1], padded[2]);
            };
        }
        if (ordinal) {
            formatTokenFunctions[ordinal] = function () {
                return this.localeData().ordinal(func.apply(this, arguments), token);
            };
        }
    }

    function removeFormattingTokens(input) {
        if (input.match(/\[[\s\S]/)) {
            return input.replace(/^\[|\]$/g, '');
        }
        return input.replace(/\\/g, '');
    }

    function makeFormatFunction(format) {
        var array = format.match(formattingTokens), i, length;

        for (i = 0, length = array.length; i < length; i++) {
            if (formatTokenFunctions[array[i]]) {
                array[i] = formatTokenFunctions[array[i]];
            } else {
                array[i] = removeFormattingTokens(array[i]);
            }
        }

        return function (mom) {
            var output = '', i;
            for (i = 0; i < length; i++) {
                output += isFunction(array[i]) ? array[i].call(mom, format) : array[i];
            }
            return output;
        };
    }

    // format date using native date object
    function formatMoment(m, format) {
        if (!m.isValid()) {
            return m.localeData().invalidDate();
        }

        format = expandFormat(format, m.localeData());
        formatFunctions[format] = formatFunctions[format] || makeFormatFunction(format);

        return formatFunctions[format](m);
    }

    function expandFormat(format, locale) {
        var i = 5;

        function replaceLongDateFormatTokens(input) {
            return locale.longDateFormat(input) || input;
        }

        localFormattingTokens.lastIndex = 0;
        while (i >= 0 && localFormattingTokens.test(format)) {
            format = format.replace(localFormattingTokens, replaceLongDateFormatTokens);
            localFormattingTokens.lastIndex = 0;
            i -= 1;
        }

        return format;
    }

    var match1         = /\d/;            //       0 - 9
    var match2         = /\d\d/;          //      00 - 99
    var match3         = /\d{3}/;         //     000 - 999
    var match4         = /\d{4}/;         //    0000 - 9999
    var match6         = /[+-]?\d{6}/;    // -999999 - 999999
    var match1to2      = /\d\d?/;         //       0 - 99
    var match3to4      = /\d\d\d\d?/;     //     999 - 9999
    var match5to6      = /\d\d\d\d\d\d?/; //   99999 - 999999
    var match1to3      = /\d{1,3}/;       //       0 - 999
    var match1to4      = /\d{1,4}/;       //       0 - 9999
    var match1to6      = /[+-]?\d{1,6}/;  // -999999 - 999999

    var matchUnsigned  = /\d+/;           //       0 - inf
    var matchSigned    = /[+-]?\d+/;      //    -inf - inf

    var matchOffset    = /Z|[+-]\d\d:?\d\d/gi; // +00:00 -00:00 +0000 -0000 or Z
    var matchShortOffset = /Z|[+-]\d\d(?::?\d\d)?/gi; // +00 -00 +00:00 -00:00 +0000 -0000 or Z

    var matchTimestamp = /[+-]?\d+(\.\d{1,3})?/; // 123456789 123456789.123

    // any word (or two) characters or numbers including two/three word month in arabic.
    // includes scottish gaelic two word and hyphenated months
    var matchWord = /[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i;

    var regexes = {};

    function addRegexToken (token, regex, strictRegex) {
        regexes[token] = isFunction(regex) ? regex : function (isStrict, localeData) {
            return (isStrict && strictRegex) ? strictRegex : regex;
        };
    }

    function getParseRegexForToken (token, config) {
        if (!hasOwnProp(regexes, token)) {
            return new RegExp(unescapeFormat(token));
        }

        return regexes[token](config._strict, config._locale);
    }

    // Code from http://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript
    function unescapeFormat(s) {
        return regexEscape(s.replace('\\', '').replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g, function (matched, p1, p2, p3, p4) {
            return p1 || p2 || p3 || p4;
        }));
    }

    function regexEscape(s) {
        return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    }

    var tokens = {};

    function addParseToken (token, callback) {
        var i, func = callback;
        if (typeof token === 'string') {
            token = [token];
        }
        if (isNumber(callback)) {
            func = function (input, array) {
                array[callback] = toInt(input);
            };
        }
        for (i = 0; i < token.length; i++) {
            tokens[token[i]] = func;
        }
    }

    function addWeekParseToken (token, callback) {
        addParseToken(token, function (input, array, config, token) {
            config._w = config._w || {};
            callback(input, config._w, config, token);
        });
    }

    function addTimeToArrayFromToken(token, input, config) {
        if (input != null && hasOwnProp(tokens, token)) {
            tokens[token](input, config._a, config, token);
        }
    }

    var YEAR = 0;
    var MONTH = 1;
    var DATE = 2;
    var HOUR = 3;
    var MINUTE = 4;
    var SECOND = 5;
    var MILLISECOND = 6;
    var WEEK = 7;
    var WEEKDAY = 8;

    // FORMATTING

    addFormatToken('Y', 0, 0, function () {
        var y = this.year();
        return y <= 9999 ? '' + y : '+' + y;
    });

    addFormatToken(0, ['YY', 2], 0, function () {
        return this.year() % 100;
    });

    addFormatToken(0, ['YYYY',   4],       0, 'year');
    addFormatToken(0, ['YYYYY',  5],       0, 'year');
    addFormatToken(0, ['YYYYYY', 6, true], 0, 'year');

    // ALIASES

    addUnitAlias('year', 'y');

    // PRIORITIES

    addUnitPriority('year', 1);

    // PARSING

    addRegexToken('Y',      matchSigned);
    addRegexToken('YY',     match1to2, match2);
    addRegexToken('YYYY',   match1to4, match4);
    addRegexToken('YYYYY',  match1to6, match6);
    addRegexToken('YYYYYY', match1to6, match6);

    addParseToken(['YYYYY', 'YYYYYY'], YEAR);
    addParseToken('YYYY', function (input, array) {
        array[YEAR] = input.length === 2 ? hooks.parseTwoDigitYear(input) : toInt(input);
    });
    addParseToken('YY', function (input, array) {
        array[YEAR] = hooks.parseTwoDigitYear(input);
    });
    addParseToken('Y', function (input, array) {
        array[YEAR] = parseInt(input, 10);
    });

    // HELPERS

    function daysInYear(year) {
        return isLeapYear(year) ? 366 : 365;
    }

    function isLeapYear(year) {
        return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
    }

    // HOOKS

    hooks.parseTwoDigitYear = function (input) {
        return toInt(input) + (toInt(input) > 68 ? 1900 : 2000);
    };

    // MOMENTS

    var getSetYear = makeGetSet('FullYear', true);

    function getIsLeapYear () {
        return isLeapYear(this.year());
    }

    function makeGetSet (unit, keepTime) {
        return function (value) {
            if (value != null) {
                set$1(this, unit, value);
                hooks.updateOffset(this, keepTime);
                return this;
            } else {
                return get(this, unit);
            }
        };
    }

    function get (mom, unit) {
        return mom.isValid() ?
            mom._d['get' + (mom._isUTC ? 'UTC' : '') + unit]() : NaN;
    }

    function set$1 (mom, unit, value) {
        if (mom.isValid() && !isNaN(value)) {
            if (unit === 'FullYear' && isLeapYear(mom.year()) && mom.month() === 1 && mom.date() === 29) {
                mom._d['set' + (mom._isUTC ? 'UTC' : '') + unit](value, mom.month(), daysInMonth(value, mom.month()));
            }
            else {
                mom._d['set' + (mom._isUTC ? 'UTC' : '') + unit](value);
            }
        }
    }

    // MOMENTS

    function stringGet (units) {
        units = normalizeUnits(units);
        if (isFunction(this[units])) {
            return this[units]();
        }
        return this;
    }


    function stringSet (units, value) {
        if (typeof units === 'object') {
            units = normalizeObjectUnits(units);
            var prioritized = getPrioritizedUnits(units);
            for (var i = 0; i < prioritized.length; i++) {
                this[prioritized[i].unit](units[prioritized[i].unit]);
            }
        } else {
            units = normalizeUnits(units);
            if (isFunction(this[units])) {
                return this[units](value);
            }
        }
        return this;
    }

    function mod(n, x) {
        return ((n % x) + x) % x;
    }

    var indexOf;

    if (Array.prototype.indexOf) {
        indexOf = Array.prototype.indexOf;
    } else {
        indexOf = function (o) {
            // I know
            var i;
            for (i = 0; i < this.length; ++i) {
                if (this[i] === o) {
                    return i;
                }
            }
            return -1;
        };
    }

    function daysInMonth(year, month) {
        if (isNaN(year) || isNaN(month)) {
            return NaN;
        }
        var modMonth = mod(month, 12);
        year += (month - modMonth) / 12;
        return modMonth === 1 ? (isLeapYear(year) ? 29 : 28) : (31 - modMonth % 7 % 2);
    }

    // FORMATTING

    addFormatToken('M', ['MM', 2], 'Mo', function () {
        return this.month() + 1;
    });

    addFormatToken('MMM', 0, 0, function (format) {
        return this.localeData().monthsShort(this, format);
    });

    addFormatToken('MMMM', 0, 0, function (format) {
        return this.localeData().months(this, format);
    });

    // ALIASES

    addUnitAlias('month', 'M');

    // PRIORITY

    addUnitPriority('month', 8);

    // PARSING

    addRegexToken('M',    match1to2);
    addRegexToken('MM',   match1to2, match2);
    addRegexToken('MMM',  function (isStrict, locale) {
        return locale.monthsShortRegex(isStrict);
    });
    addRegexToken('MMMM', function (isStrict, locale) {
        return locale.monthsRegex(isStrict);
    });

    addParseToken(['M', 'MM'], function (input, array) {
        array[MONTH] = toInt(input) - 1;
    });

    addParseToken(['MMM', 'MMMM'], function (input, array, config, token) {
        var month = config._locale.monthsParse(input, token, config._strict);
        // if we didn't find a month name, mark the date as invalid.
        if (month != null) {
            array[MONTH] = month;
        } else {
            getParsingFlags(config).invalidMonth = input;
        }
    });

    // LOCALES

    var MONTHS_IN_FORMAT = /D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/;
    var defaultLocaleMonths = 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_');
    function localeMonths (m, format) {
        if (!m) {
            return isArray(this._months) ? this._months :
                this._months['standalone'];
        }
        return isArray(this._months) ? this._months[m.month()] :
            this._months[(this._months.isFormat || MONTHS_IN_FORMAT).test(format) ? 'format' : 'standalone'][m.month()];
    }

    var defaultLocaleMonthsShort = 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_');
    function localeMonthsShort (m, format) {
        if (!m) {
            return isArray(this._monthsShort) ? this._monthsShort :
                this._monthsShort['standalone'];
        }
        return isArray(this._monthsShort) ? this._monthsShort[m.month()] :
            this._monthsShort[MONTHS_IN_FORMAT.test(format) ? 'format' : 'standalone'][m.month()];
    }

    function handleStrictParse(monthName, format, strict) {
        var i, ii, mom, llc = monthName.toLocaleLowerCase();
        if (!this._monthsParse) {
            // this is not used
            this._monthsParse = [];
            this._longMonthsParse = [];
            this._shortMonthsParse = [];
            for (i = 0; i < 12; ++i) {
                mom = createUTC([2000, i]);
                this._shortMonthsParse[i] = this.monthsShort(mom, '').toLocaleLowerCase();
                this._longMonthsParse[i] = this.months(mom, '').toLocaleLowerCase();
            }
        }

        if (strict) {
            if (format === 'MMM') {
                ii = indexOf.call(this._shortMonthsParse, llc);
                return ii !== -1 ? ii : null;
            } else {
                ii = indexOf.call(this._longMonthsParse, llc);
                return ii !== -1 ? ii : null;
            }
        } else {
            if (format === 'MMM') {
                ii = indexOf.call(this._shortMonthsParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._longMonthsParse, llc);
                return ii !== -1 ? ii : null;
            } else {
                ii = indexOf.call(this._longMonthsParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._shortMonthsParse, llc);
                return ii !== -1 ? ii : null;
            }
        }
    }

    function localeMonthsParse (monthName, format, strict) {
        var i, mom, regex;

        if (this._monthsParseExact) {
            return handleStrictParse.call(this, monthName, format, strict);
        }

        if (!this._monthsParse) {
            this._monthsParse = [];
            this._longMonthsParse = [];
            this._shortMonthsParse = [];
        }

        // TODO: add sorting
        // Sorting makes sure if one month (or abbr) is a prefix of another
        // see sorting in computeMonthsParse
        for (i = 0; i < 12; i++) {
            // make the regex if we don't have it already
            mom = createUTC([2000, i]);
            if (strict && !this._longMonthsParse[i]) {
                this._longMonthsParse[i] = new RegExp('^' + this.months(mom, '').replace('.', '') + '$', 'i');
                this._shortMonthsParse[i] = new RegExp('^' + this.monthsShort(mom, '').replace('.', '') + '$', 'i');
            }
            if (!strict && !this._monthsParse[i]) {
                regex = '^' + this.months(mom, '') + '|^' + this.monthsShort(mom, '');
                this._monthsParse[i] = new RegExp(regex.replace('.', ''), 'i');
            }
            // test the regex
            if (strict && format === 'MMMM' && this._longMonthsParse[i].test(monthName)) {
                return i;
            } else if (strict && format === 'MMM' && this._shortMonthsParse[i].test(monthName)) {
                return i;
            } else if (!strict && this._monthsParse[i].test(monthName)) {
                return i;
            }
        }
    }

    // MOMENTS

    function setMonth (mom, value) {
        var dayOfMonth;

        if (!mom.isValid()) {
            // No op
            return mom;
        }

        if (typeof value === 'string') {
            if (/^\d+$/.test(value)) {
                value = toInt(value);
            } else {
                value = mom.localeData().monthsParse(value);
                // TODO: Another silent failure?
                if (!isNumber(value)) {
                    return mom;
                }
            }
        }

        dayOfMonth = Math.min(mom.date(), daysInMonth(mom.year(), value));
        mom._d['set' + (mom._isUTC ? 'UTC' : '') + 'Month'](value, dayOfMonth);
        return mom;
    }

    function getSetMonth (value) {
        if (value != null) {
            setMonth(this, value);
            hooks.updateOffset(this, true);
            return this;
        } else {
            return get(this, 'Month');
        }
    }

    function getDaysInMonth () {
        return daysInMonth(this.year(), this.month());
    }

    var defaultMonthsShortRegex = matchWord;
    function monthsShortRegex (isStrict) {
        if (this._monthsParseExact) {
            if (!hasOwnProp(this, '_monthsRegex')) {
                computeMonthsParse.call(this);
            }
            if (isStrict) {
                return this._monthsShortStrictRegex;
            } else {
                return this._monthsShortRegex;
            }
        } else {
            if (!hasOwnProp(this, '_monthsShortRegex')) {
                this._monthsShortRegex = defaultMonthsShortRegex;
            }
            return this._monthsShortStrictRegex && isStrict ?
                this._monthsShortStrictRegex : this._monthsShortRegex;
        }
    }

    var defaultMonthsRegex = matchWord;
    function monthsRegex (isStrict) {
        if (this._monthsParseExact) {
            if (!hasOwnProp(this, '_monthsRegex')) {
                computeMonthsParse.call(this);
            }
            if (isStrict) {
                return this._monthsStrictRegex;
            } else {
                return this._monthsRegex;
            }
        } else {
            if (!hasOwnProp(this, '_monthsRegex')) {
                this._monthsRegex = defaultMonthsRegex;
            }
            return this._monthsStrictRegex && isStrict ?
                this._monthsStrictRegex : this._monthsRegex;
        }
    }

    function computeMonthsParse () {
        function cmpLenRev(a, b) {
            return b.length - a.length;
        }

        var shortPieces = [], longPieces = [], mixedPieces = [],
            i, mom;
        for (i = 0; i < 12; i++) {
            // make the regex if we don't have it already
            mom = createUTC([2000, i]);
            shortPieces.push(this.monthsShort(mom, ''));
            longPieces.push(this.months(mom, ''));
            mixedPieces.push(this.months(mom, ''));
            mixedPieces.push(this.monthsShort(mom, ''));
        }
        // Sorting makes sure if one month (or abbr) is a prefix of another it
        // will match the longer piece.
        shortPieces.sort(cmpLenRev);
        longPieces.sort(cmpLenRev);
        mixedPieces.sort(cmpLenRev);
        for (i = 0; i < 12; i++) {
            shortPieces[i] = regexEscape(shortPieces[i]);
            longPieces[i] = regexEscape(longPieces[i]);
        }
        for (i = 0; i < 24; i++) {
            mixedPieces[i] = regexEscape(mixedPieces[i]);
        }

        this._monthsRegex = new RegExp('^(' + mixedPieces.join('|') + ')', 'i');
        this._monthsShortRegex = this._monthsRegex;
        this._monthsStrictRegex = new RegExp('^(' + longPieces.join('|') + ')', 'i');
        this._monthsShortStrictRegex = new RegExp('^(' + shortPieces.join('|') + ')', 'i');
    }

    function createDate (y, m, d, h, M, s, ms) {
        // can't just apply() to create a date:
        // https://stackoverflow.com/q/181348
        var date;
        // the date constructor remaps years 0-99 to 1900-1999
        if (y < 100 && y >= 0) {
            // preserve leap years using a full 400 year cycle, then reset
            date = new Date(y + 400, m, d, h, M, s, ms);
            if (isFinite(date.getFullYear())) {
                date.setFullYear(y);
            }
        } else {
            date = new Date(y, m, d, h, M, s, ms);
        }

        return date;
    }

    function createUTCDate (y) {
        var date;
        // the Date.UTC function remaps years 0-99 to 1900-1999
        if (y < 100 && y >= 0) {
            var args = Array.prototype.slice.call(arguments);
            // preserve leap years using a full 400 year cycle, then reset
            args[0] = y + 400;
            date = new Date(Date.UTC.apply(null, args));
            if (isFinite(date.getUTCFullYear())) {
                date.setUTCFullYear(y);
            }
        } else {
            date = new Date(Date.UTC.apply(null, arguments));
        }

        return date;
    }

    // start-of-first-week - start-of-year
    function firstWeekOffset(year, dow, doy) {
        var // first-week day -- which january is always in the first week (4 for iso, 1 for other)
            fwd = 7 + dow - doy,
            // first-week day local weekday -- which local weekday is fwd
            fwdlw = (7 + createUTCDate(year, 0, fwd).getUTCDay() - dow) % 7;

        return -fwdlw + fwd - 1;
    }

    // https://en.wikipedia.org/wiki/ISO_week_date#Calculating_a_date_given_the_year.2C_week_number_and_weekday
    function dayOfYearFromWeeks(year, week, weekday, dow, doy) {
        var localWeekday = (7 + weekday - dow) % 7,
            weekOffset = firstWeekOffset(year, dow, doy),
            dayOfYear = 1 + 7 * (week - 1) + localWeekday + weekOffset,
            resYear, resDayOfYear;

        if (dayOfYear <= 0) {
            resYear = year - 1;
            resDayOfYear = daysInYear(resYear) + dayOfYear;
        } else if (dayOfYear > daysInYear(year)) {
            resYear = year + 1;
            resDayOfYear = dayOfYear - daysInYear(year);
        } else {
            resYear = year;
            resDayOfYear = dayOfYear;
        }

        return {
            year: resYear,
            dayOfYear: resDayOfYear
        };
    }

    function weekOfYear(mom, dow, doy) {
        var weekOffset = firstWeekOffset(mom.year(), dow, doy),
            week = Math.floor((mom.dayOfYear() - weekOffset - 1) / 7) + 1,
            resWeek, resYear;

        if (week < 1) {
            resYear = mom.year() - 1;
            resWeek = week + weeksInYear(resYear, dow, doy);
        } else if (week > weeksInYear(mom.year(), dow, doy)) {
            resWeek = week - weeksInYear(mom.year(), dow, doy);
            resYear = mom.year() + 1;
        } else {
            resYear = mom.year();
            resWeek = week;
        }

        return {
            week: resWeek,
            year: resYear
        };
    }

    function weeksInYear(year, dow, doy) {
        var weekOffset = firstWeekOffset(year, dow, doy),
            weekOffsetNext = firstWeekOffset(year + 1, dow, doy);
        return (daysInYear(year) - weekOffset + weekOffsetNext) / 7;
    }

    // FORMATTING

    addFormatToken('w', ['ww', 2], 'wo', 'week');
    addFormatToken('W', ['WW', 2], 'Wo', 'isoWeek');

    // ALIASES

    addUnitAlias('week', 'w');
    addUnitAlias('isoWeek', 'W');

    // PRIORITIES

    addUnitPriority('week', 5);
    addUnitPriority('isoWeek', 5);

    // PARSING

    addRegexToken('w',  match1to2);
    addRegexToken('ww', match1to2, match2);
    addRegexToken('W',  match1to2);
    addRegexToken('WW', match1to2, match2);

    addWeekParseToken(['w', 'ww', 'W', 'WW'], function (input, week, config, token) {
        week[token.substr(0, 1)] = toInt(input);
    });

    // HELPERS

    // LOCALES

    function localeWeek (mom) {
        return weekOfYear(mom, this._week.dow, this._week.doy).week;
    }

    var defaultLocaleWeek = {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 6th is the first week of the year.
    };

    function localeFirstDayOfWeek () {
        return this._week.dow;
    }

    function localeFirstDayOfYear () {
        return this._week.doy;
    }

    // MOMENTS

    function getSetWeek (input) {
        var week = this.localeData().week(this);
        return input == null ? week : this.add((input - week) * 7, 'd');
    }

    function getSetISOWeek (input) {
        var week = weekOfYear(this, 1, 4).week;
        return input == null ? week : this.add((input - week) * 7, 'd');
    }

    // FORMATTING

    addFormatToken('d', 0, 'do', 'day');

    addFormatToken('dd', 0, 0, function (format) {
        return this.localeData().weekdaysMin(this, format);
    });

    addFormatToken('ddd', 0, 0, function (format) {
        return this.localeData().weekdaysShort(this, format);
    });

    addFormatToken('dddd', 0, 0, function (format) {
        return this.localeData().weekdays(this, format);
    });

    addFormatToken('e', 0, 0, 'weekday');
    addFormatToken('E', 0, 0, 'isoWeekday');

    // ALIASES

    addUnitAlias('day', 'd');
    addUnitAlias('weekday', 'e');
    addUnitAlias('isoWeekday', 'E');

    // PRIORITY
    addUnitPriority('day', 11);
    addUnitPriority('weekday', 11);
    addUnitPriority('isoWeekday', 11);

    // PARSING

    addRegexToken('d',    match1to2);
    addRegexToken('e',    match1to2);
    addRegexToken('E',    match1to2);
    addRegexToken('dd',   function (isStrict, locale) {
        return locale.weekdaysMinRegex(isStrict);
    });
    addRegexToken('ddd',   function (isStrict, locale) {
        return locale.weekdaysShortRegex(isStrict);
    });
    addRegexToken('dddd',   function (isStrict, locale) {
        return locale.weekdaysRegex(isStrict);
    });

    addWeekParseToken(['dd', 'ddd', 'dddd'], function (input, week, config, token) {
        var weekday = config._locale.weekdaysParse(input, token, config._strict);
        // if we didn't get a weekday name, mark the date as invalid
        if (weekday != null) {
            week.d = weekday;
        } else {
            getParsingFlags(config).invalidWeekday = input;
        }
    });

    addWeekParseToken(['d', 'e', 'E'], function (input, week, config, token) {
        week[token] = toInt(input);
    });

    // HELPERS

    function parseWeekday(input, locale) {
        if (typeof input !== 'string') {
            return input;
        }

        if (!isNaN(input)) {
            return parseInt(input, 10);
        }

        input = locale.weekdaysParse(input);
        if (typeof input === 'number') {
            return input;
        }

        return null;
    }

    function parseIsoWeekday(input, locale) {
        if (typeof input === 'string') {
            return locale.weekdaysParse(input) % 7 || 7;
        }
        return isNaN(input) ? null : input;
    }

    // LOCALES
    function shiftWeekdays (ws, n) {
        return ws.slice(n, 7).concat(ws.slice(0, n));
    }

    var defaultLocaleWeekdays = 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_');
    function localeWeekdays (m, format) {
        var weekdays = isArray(this._weekdays) ? this._weekdays :
            this._weekdays[(m && m !== true && this._weekdays.isFormat.test(format)) ? 'format' : 'standalone'];
        return (m === true) ? shiftWeekdays(weekdays, this._week.dow)
            : (m) ? weekdays[m.day()] : weekdays;
    }

    var defaultLocaleWeekdaysShort = 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_');
    function localeWeekdaysShort (m) {
        return (m === true) ? shiftWeekdays(this._weekdaysShort, this._week.dow)
            : (m) ? this._weekdaysShort[m.day()] : this._weekdaysShort;
    }

    var defaultLocaleWeekdaysMin = 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_');
    function localeWeekdaysMin (m) {
        return (m === true) ? shiftWeekdays(this._weekdaysMin, this._week.dow)
            : (m) ? this._weekdaysMin[m.day()] : this._weekdaysMin;
    }

    function handleStrictParse$1(weekdayName, format, strict) {
        var i, ii, mom, llc = weekdayName.toLocaleLowerCase();
        if (!this._weekdaysParse) {
            this._weekdaysParse = [];
            this._shortWeekdaysParse = [];
            this._minWeekdaysParse = [];

            for (i = 0; i < 7; ++i) {
                mom = createUTC([2000, 1]).day(i);
                this._minWeekdaysParse[i] = this.weekdaysMin(mom, '').toLocaleLowerCase();
                this._shortWeekdaysParse[i] = this.weekdaysShort(mom, '').toLocaleLowerCase();
                this._weekdaysParse[i] = this.weekdays(mom, '').toLocaleLowerCase();
            }
        }

        if (strict) {
            if (format === 'dddd') {
                ii = indexOf.call(this._weekdaysParse, llc);
                return ii !== -1 ? ii : null;
            } else if (format === 'ddd') {
                ii = indexOf.call(this._shortWeekdaysParse, llc);
                return ii !== -1 ? ii : null;
            } else {
                ii = indexOf.call(this._minWeekdaysParse, llc);
                return ii !== -1 ? ii : null;
            }
        } else {
            if (format === 'dddd') {
                ii = indexOf.call(this._weekdaysParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._shortWeekdaysParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._minWeekdaysParse, llc);
                return ii !== -1 ? ii : null;
            } else if (format === 'ddd') {
                ii = indexOf.call(this._shortWeekdaysParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._weekdaysParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._minWeekdaysParse, llc);
                return ii !== -1 ? ii : null;
            } else {
                ii = indexOf.call(this._minWeekdaysParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._weekdaysParse, llc);
                if (ii !== -1) {
                    return ii;
                }
                ii = indexOf.call(this._shortWeekdaysParse, llc);
                return ii !== -1 ? ii : null;
            }
        }
    }

    function localeWeekdaysParse (weekdayName, format, strict) {
        var i, mom, regex;

        if (this._weekdaysParseExact) {
            return handleStrictParse$1.call(this, weekdayName, format, strict);
        }

        if (!this._weekdaysParse) {
            this._weekdaysParse = [];
            this._minWeekdaysParse = [];
            this._shortWeekdaysParse = [];
            this._fullWeekdaysParse = [];
        }

        for (i = 0; i < 7; i++) {
            // make the regex if we don't have it already

            mom = createUTC([2000, 1]).day(i);
            if (strict && !this._fullWeekdaysParse[i]) {
                this._fullWeekdaysParse[i] = new RegExp('^' + this.weekdays(mom, '').replace('.', '\\.?') + '$', 'i');
                this._shortWeekdaysParse[i] = new RegExp('^' + this.weekdaysShort(mom, '').replace('.', '\\.?') + '$', 'i');
                this._minWeekdaysParse[i] = new RegExp('^' + this.weekdaysMin(mom, '').replace('.', '\\.?') + '$', 'i');
            }
            if (!this._weekdaysParse[i]) {
                regex = '^' + this.weekdays(mom, '') + '|^' + this.weekdaysShort(mom, '') + '|^' + this.weekdaysMin(mom, '');
                this._weekdaysParse[i] = new RegExp(regex.replace('.', ''), 'i');
            }
            // test the regex
            if (strict && format === 'dddd' && this._fullWeekdaysParse[i].test(weekdayName)) {
                return i;
            } else if (strict && format === 'ddd' && this._shortWeekdaysParse[i].test(weekdayName)) {
                return i;
            } else if (strict && format === 'dd' && this._minWeekdaysParse[i].test(weekdayName)) {
                return i;
            } else if (!strict && this._weekdaysParse[i].test(weekdayName)) {
                return i;
            }
        }
    }

    // MOMENTS

    function getSetDayOfWeek (input) {
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        var day = this._isUTC ? this._d.getUTCDay() : this._d.getDay();
        if (input != null) {
            input = parseWeekday(input, this.localeData());
            return this.add(input - day, 'd');
        } else {
            return day;
        }
    }

    function getSetLocaleDayOfWeek (input) {
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        var weekday = (this.day() + 7 - this.localeData()._week.dow) % 7;
        return input == null ? weekday : this.add(input - weekday, 'd');
    }

    function getSetISODayOfWeek (input) {
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }

        // behaves the same as moment#day except
        // as a getter, returns 7 instead of 0 (1-7 range instead of 0-6)
        // as a setter, sunday should belong to the previous week.

        if (input != null) {
            var weekday = parseIsoWeekday(input, this.localeData());
            return this.day(this.day() % 7 ? weekday : weekday - 7);
        } else {
            return this.day() || 7;
        }
    }

    var defaultWeekdaysRegex = matchWord;
    function weekdaysRegex (isStrict) {
        if (this._weekdaysParseExact) {
            if (!hasOwnProp(this, '_weekdaysRegex')) {
                computeWeekdaysParse.call(this);
            }
            if (isStrict) {
                return this._weekdaysStrictRegex;
            } else {
                return this._weekdaysRegex;
            }
        } else {
            if (!hasOwnProp(this, '_weekdaysRegex')) {
                this._weekdaysRegex = defaultWeekdaysRegex;
            }
            return this._weekdaysStrictRegex && isStrict ?
                this._weekdaysStrictRegex : this._weekdaysRegex;
        }
    }

    var defaultWeekdaysShortRegex = matchWord;
    function weekdaysShortRegex (isStrict) {
        if (this._weekdaysParseExact) {
            if (!hasOwnProp(this, '_weekdaysRegex')) {
                computeWeekdaysParse.call(this);
            }
            if (isStrict) {
                return this._weekdaysShortStrictRegex;
            } else {
                return this._weekdaysShortRegex;
            }
        } else {
            if (!hasOwnProp(this, '_weekdaysShortRegex')) {
                this._weekdaysShortRegex = defaultWeekdaysShortRegex;
            }
            return this._weekdaysShortStrictRegex && isStrict ?
                this._weekdaysShortStrictRegex : this._weekdaysShortRegex;
        }
    }

    var defaultWeekdaysMinRegex = matchWord;
    function weekdaysMinRegex (isStrict) {
        if (this._weekdaysParseExact) {
            if (!hasOwnProp(this, '_weekdaysRegex')) {
                computeWeekdaysParse.call(this);
            }
            if (isStrict) {
                return this._weekdaysMinStrictRegex;
            } else {
                return this._weekdaysMinRegex;
            }
        } else {
            if (!hasOwnProp(this, '_weekdaysMinRegex')) {
                this._weekdaysMinRegex = defaultWeekdaysMinRegex;
            }
            return this._weekdaysMinStrictRegex && isStrict ?
                this._weekdaysMinStrictRegex : this._weekdaysMinRegex;
        }
    }


    function computeWeekdaysParse () {
        function cmpLenRev(a, b) {
            return b.length - a.length;
        }

        var minPieces = [], shortPieces = [], longPieces = [], mixedPieces = [],
            i, mom, minp, shortp, longp;
        for (i = 0; i < 7; i++) {
            // make the regex if we don't have it already
            mom = createUTC([2000, 1]).day(i);
            minp = this.weekdaysMin(mom, '');
            shortp = this.weekdaysShort(mom, '');
            longp = this.weekdays(mom, '');
            minPieces.push(minp);
            shortPieces.push(shortp);
            longPieces.push(longp);
            mixedPieces.push(minp);
            mixedPieces.push(shortp);
            mixedPieces.push(longp);
        }
        // Sorting makes sure if one weekday (or abbr) is a prefix of another it
        // will match the longer piece.
        minPieces.sort(cmpLenRev);
        shortPieces.sort(cmpLenRev);
        longPieces.sort(cmpLenRev);
        mixedPieces.sort(cmpLenRev);
        for (i = 0; i < 7; i++) {
            shortPieces[i] = regexEscape(shortPieces[i]);
            longPieces[i] = regexEscape(longPieces[i]);
            mixedPieces[i] = regexEscape(mixedPieces[i]);
        }

        this._weekdaysRegex = new RegExp('^(' + mixedPieces.join('|') + ')', 'i');
        this._weekdaysShortRegex = this._weekdaysRegex;
        this._weekdaysMinRegex = this._weekdaysRegex;

        this._weekdaysStrictRegex = new RegExp('^(' + longPieces.join('|') + ')', 'i');
        this._weekdaysShortStrictRegex = new RegExp('^(' + shortPieces.join('|') + ')', 'i');
        this._weekdaysMinStrictRegex = new RegExp('^(' + minPieces.join('|') + ')', 'i');
    }

    // FORMATTING

    function hFormat() {
        return this.hours() % 12 || 12;
    }

    function kFormat() {
        return this.hours() || 24;
    }

    addFormatToken('H', ['HH', 2], 0, 'hour');
    addFormatToken('h', ['hh', 2], 0, hFormat);
    addFormatToken('k', ['kk', 2], 0, kFormat);

    addFormatToken('hmm', 0, 0, function () {
        return '' + hFormat.apply(this) + zeroFill(this.minutes(), 2);
    });

    addFormatToken('hmmss', 0, 0, function () {
        return '' + hFormat.apply(this) + zeroFill(this.minutes(), 2) +
            zeroFill(this.seconds(), 2);
    });

    addFormatToken('Hmm', 0, 0, function () {
        return '' + this.hours() + zeroFill(this.minutes(), 2);
    });

    addFormatToken('Hmmss', 0, 0, function () {
        return '' + this.hours() + zeroFill(this.minutes(), 2) +
            zeroFill(this.seconds(), 2);
    });

    function meridiem (token, lowercase) {
        addFormatToken(token, 0, 0, function () {
            return this.localeData().meridiem(this.hours(), this.minutes(), lowercase);
        });
    }

    meridiem('a', true);
    meridiem('A', false);

    // ALIASES

    addUnitAlias('hour', 'h');

    // PRIORITY
    addUnitPriority('hour', 13);

    // PARSING

    function matchMeridiem (isStrict, locale) {
        return locale._meridiemParse;
    }

    addRegexToken('a',  matchMeridiem);
    addRegexToken('A',  matchMeridiem);
    addRegexToken('H',  match1to2);
    addRegexToken('h',  match1to2);
    addRegexToken('k',  match1to2);
    addRegexToken('HH', match1to2, match2);
    addRegexToken('hh', match1to2, match2);
    addRegexToken('kk', match1to2, match2);

    addRegexToken('hmm', match3to4);
    addRegexToken('hmmss', match5to6);
    addRegexToken('Hmm', match3to4);
    addRegexToken('Hmmss', match5to6);

    addParseToken(['H', 'HH'], HOUR);
    addParseToken(['k', 'kk'], function (input, array, config) {
        var kInput = toInt(input);
        array[HOUR] = kInput === 24 ? 0 : kInput;
    });
    addParseToken(['a', 'A'], function (input, array, config) {
        config._isPm = config._locale.isPM(input);
        config._meridiem = input;
    });
    addParseToken(['h', 'hh'], function (input, array, config) {
        array[HOUR] = toInt(input);
        getParsingFlags(config).bigHour = true;
    });
    addParseToken('hmm', function (input, array, config) {
        var pos = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos));
        array[MINUTE] = toInt(input.substr(pos));
        getParsingFlags(config).bigHour = true;
    });
    addParseToken('hmmss', function (input, array, config) {
        var pos1 = input.length - 4;
        var pos2 = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos1));
        array[MINUTE] = toInt(input.substr(pos1, 2));
        array[SECOND] = toInt(input.substr(pos2));
        getParsingFlags(config).bigHour = true;
    });
    addParseToken('Hmm', function (input, array, config) {
        var pos = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos));
        array[MINUTE] = toInt(input.substr(pos));
    });
    addParseToken('Hmmss', function (input, array, config) {
        var pos1 = input.length - 4;
        var pos2 = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos1));
        array[MINUTE] = toInt(input.substr(pos1, 2));
        array[SECOND] = toInt(input.substr(pos2));
    });

    // LOCALES

    function localeIsPM (input) {
        // IE8 Quirks Mode & IE7 Standards Mode do not allow accessing strings like arrays
        // Using charAt should be more compatible.
        return ((input + '').toLowerCase().charAt(0) === 'p');
    }

    var defaultLocaleMeridiemParse = /[ap]\.?m?\.?/i;
    function localeMeridiem (hours, minutes, isLower) {
        if (hours > 11) {
            return isLower ? 'pm' : 'PM';
        } else {
            return isLower ? 'am' : 'AM';
        }
    }


    // MOMENTS

    // Setting the hour should keep the time, because the user explicitly
    // specified which hour they want. So trying to maintain the same hour (in
    // a new timezone) makes sense. Adding/subtracting hours does not follow
    // this rule.
    var getSetHour = makeGetSet('Hours', true);

    var baseConfig = {
        calendar: defaultCalendar,
        longDateFormat: defaultLongDateFormat,
        invalidDate: defaultInvalidDate,
        ordinal: defaultOrdinal,
        dayOfMonthOrdinalParse: defaultDayOfMonthOrdinalParse,
        relativeTime: defaultRelativeTime,

        months: defaultLocaleMonths,
        monthsShort: defaultLocaleMonthsShort,

        week: defaultLocaleWeek,

        weekdays: defaultLocaleWeekdays,
        weekdaysMin: defaultLocaleWeekdaysMin,
        weekdaysShort: defaultLocaleWeekdaysShort,

        meridiemParse: defaultLocaleMeridiemParse
    };

    // internal storage for locale config files
    var locales = {};
    var localeFamilies = {};
    var globalLocale;

    function normalizeLocale(key) {
        return key ? key.toLowerCase().replace('_', '-') : key;
    }

    // pick the locale from the array
    // try ['en-au', 'en-gb'] as 'en-au', 'en-gb', 'en', as in move through the list trying each
    // substring from most specific to least, but move to the next array item if it's a more specific variant than the current root
    function chooseLocale(names) {
        var i = 0, j, next, locale, split;

        while (i < names.length) {
            split = normalizeLocale(names[i]).split('-');
            j = split.length;
            next = normalizeLocale(names[i + 1]);
            next = next ? next.split('-') : null;
            while (j > 0) {
                locale = loadLocale(split.slice(0, j).join('-'));
                if (locale) {
                    return locale;
                }
                if (next && next.length >= j && compareArrays(split, next, true) >= j - 1) {
                    //the next array item is better than a shallower substring of this one
                    break;
                }
                j--;
            }
            i++;
        }
        return globalLocale;
    }

    function loadLocale(name) {
        var oldLocale = null;
        // TODO: Find a better way to register and load all the locales in Node
        if (!locales[name] && (typeof module !== 'undefined') &&
                module && module.exports) {
            try {
                oldLocale = globalLocale._abbr;
                var aliasedRequire = require;
                aliasedRequire('./locale/' + name);
                getSetGlobalLocale(oldLocale);
            } catch (e) {}
        }
        return locales[name];
    }

    // This function will load locale and then set the global locale.  If
    // no arguments are passed in, it will simply return the current global
    // locale key.
    function getSetGlobalLocale (key, values) {
        var data;
        if (key) {
            if (isUndefined(values)) {
                data = getLocale(key);
            }
            else {
                data = defineLocale(key, values);
            }

            if (data) {
                // moment.duration._locale = moment._locale = data;
                globalLocale = data;
            }
            else {
                if ((typeof console !==  'undefined') && console.warn) {
                    //warn user if arguments are passed but the locale could not be set
                    console.warn('Locale ' + key +  ' not found. Did you forget to load it?');
                }
            }
        }

        return globalLocale._abbr;
    }

    function defineLocale (name, config) {
        if (config !== null) {
            var locale, parentConfig = baseConfig;
            config.abbr = name;
            if (locales[name] != null) {
                deprecateSimple('defineLocaleOverride',
                        'use moment.updateLocale(localeName, config) to change ' +
                        'an existing locale. moment.defineLocale(localeName, ' +
                        'config) should only be used for creating a new locale ' +
                        'See http://momentjs.com/guides/#/warnings/define-locale/ for more info.');
                parentConfig = locales[name]._config;
            } else if (config.parentLocale != null) {
                if (locales[config.parentLocale] != null) {
                    parentConfig = locales[config.parentLocale]._config;
                } else {
                    locale = loadLocale(config.parentLocale);
                    if (locale != null) {
                        parentConfig = locale._config;
                    } else {
                        if (!localeFamilies[config.parentLocale]) {
                            localeFamilies[config.parentLocale] = [];
                        }
                        localeFamilies[config.parentLocale].push({
                            name: name,
                            config: config
                        });
                        return null;
                    }
                }
            }
            locales[name] = new Locale(mergeConfigs(parentConfig, config));

            if (localeFamilies[name]) {
                localeFamilies[name].forEach(function (x) {
                    defineLocale(x.name, x.config);
                });
            }

            // backwards compat for now: also set the locale
            // make sure we set the locale AFTER all child locales have been
            // created, so we won't end up with the child locale set.
            getSetGlobalLocale(name);


            return locales[name];
        } else {
            // useful for testing
            delete locales[name];
            return null;
        }
    }

    function updateLocale(name, config) {
        if (config != null) {
            var locale, tmpLocale, parentConfig = baseConfig;
            // MERGE
            tmpLocale = loadLocale(name);
            if (tmpLocale != null) {
                parentConfig = tmpLocale._config;
            }
            config = mergeConfigs(parentConfig, config);
            locale = new Locale(config);
            locale.parentLocale = locales[name];
            locales[name] = locale;

            // backwards compat for now: also set the locale
            getSetGlobalLocale(name);
        } else {
            // pass null for config to unupdate, useful for tests
            if (locales[name] != null) {
                if (locales[name].parentLocale != null) {
                    locales[name] = locales[name].parentLocale;
                } else if (locales[name] != null) {
                    delete locales[name];
                }
            }
        }
        return locales[name];
    }

    // returns locale data
    function getLocale (key) {
        var locale;

        if (key && key._locale && key._locale._abbr) {
            key = key._locale._abbr;
        }

        if (!key) {
            return globalLocale;
        }

        if (!isArray(key)) {
            //short-circuit everything else
            locale = loadLocale(key);
            if (locale) {
                return locale;
            }
            key = [key];
        }

        return chooseLocale(key);
    }

    function listLocales() {
        return keys(locales);
    }

    function checkOverflow (m) {
        var overflow;
        var a = m._a;

        if (a && getParsingFlags(m).overflow === -2) {
            overflow =
                a[MONTH]       < 0 || a[MONTH]       > 11  ? MONTH :
                a[DATE]        < 1 || a[DATE]        > daysInMonth(a[YEAR], a[MONTH]) ? DATE :
                a[HOUR]        < 0 || a[HOUR]        > 24 || (a[HOUR] === 24 && (a[MINUTE] !== 0 || a[SECOND] !== 0 || a[MILLISECOND] !== 0)) ? HOUR :
                a[MINUTE]      < 0 || a[MINUTE]      > 59  ? MINUTE :
                a[SECOND]      < 0 || a[SECOND]      > 59  ? SECOND :
                a[MILLISECOND] < 0 || a[MILLISECOND] > 999 ? MILLISECOND :
                -1;

            if (getParsingFlags(m)._overflowDayOfYear && (overflow < YEAR || overflow > DATE)) {
                overflow = DATE;
            }
            if (getParsingFlags(m)._overflowWeeks && overflow === -1) {
                overflow = WEEK;
            }
            if (getParsingFlags(m)._overflowWeekday && overflow === -1) {
                overflow = WEEKDAY;
            }

            getParsingFlags(m).overflow = overflow;
        }

        return m;
    }

    // Pick the first defined of two or three arguments.
    function defaults(a, b, c) {
        if (a != null) {
            return a;
        }
        if (b != null) {
            return b;
        }
        return c;
    }

    function currentDateArray(config) {
        // hooks is actually the exported moment object
        var nowValue = new Date(hooks.now());
        if (config._useUTC) {
            return [nowValue.getUTCFullYear(), nowValue.getUTCMonth(), nowValue.getUTCDate()];
        }
        return [nowValue.getFullYear(), nowValue.getMonth(), nowValue.getDate()];
    }

    // convert an array to a date.
    // the array should mirror the parameters below
    // note: all values past the year are optional and will default to the lowest possible value.
    // [year, month, day , hour, minute, second, millisecond]
    function configFromArray (config) {
        var i, date, input = [], currentDate, expectedWeekday, yearToUse;

        if (config._d) {
            return;
        }

        currentDate = currentDateArray(config);

        //compute day of the year from weeks and weekdays
        if (config._w && config._a[DATE] == null && config._a[MONTH] == null) {
            dayOfYearFromWeekInfo(config);
        }

        //if the day of the year is set, figure out what it is
        if (config._dayOfYear != null) {
            yearToUse = defaults(config._a[YEAR], currentDate[YEAR]);

            if (config._dayOfYear > daysInYear(yearToUse) || config._dayOfYear === 0) {
                getParsingFlags(config)._overflowDayOfYear = true;
            }

            date = createUTCDate(yearToUse, 0, config._dayOfYear);
            config._a[MONTH] = date.getUTCMonth();
            config._a[DATE] = date.getUTCDate();
        }

        // Default to current date.
        // * if no year, month, day of month are given, default to today
        // * if day of month is given, default month and year
        // * if month is given, default only year
        // * if year is given, don't default anything
        for (i = 0; i < 3 && config._a[i] == null; ++i) {
            config._a[i] = input[i] = currentDate[i];
        }

        // Zero out whatever was not defaulted, including time
        for (; i < 7; i++) {
            config._a[i] = input[i] = (config._a[i] == null) ? (i === 2 ? 1 : 0) : config._a[i];
        }

        // Check for 24:00:00.000
        if (config._a[HOUR] === 24 &&
                config._a[MINUTE] === 0 &&
                config._a[SECOND] === 0 &&
                config._a[MILLISECOND] === 0) {
            config._nextDay = true;
            config._a[HOUR] = 0;
        }

        config._d = (config._useUTC ? createUTCDate : createDate).apply(null, input);
        expectedWeekday = config._useUTC ? config._d.getUTCDay() : config._d.getDay();

        // Apply timezone offset from input. The actual utcOffset can be changed
        // with parseZone.
        if (config._tzm != null) {
            config._d.setUTCMinutes(config._d.getUTCMinutes() - config._tzm);
        }

        if (config._nextDay) {
            config._a[HOUR] = 24;
        }

        // check for mismatching day of week
        if (config._w && typeof config._w.d !== 'undefined' && config._w.d !== expectedWeekday) {
            getParsingFlags(config).weekdayMismatch = true;
        }
    }

    function dayOfYearFromWeekInfo(config) {
        var w, weekYear, week, weekday, dow, doy, temp, weekdayOverflow;

        w = config._w;
        if (w.GG != null || w.W != null || w.E != null) {
            dow = 1;
            doy = 4;

            // TODO: We need to take the current isoWeekYear, but that depends on
            // how we interpret now (local, utc, fixed offset). So create
            // a now version of current config (take local/utc/offset flags, and
            // create now).
            weekYear = defaults(w.GG, config._a[YEAR], weekOfYear(createLocal(), 1, 4).year);
            week = defaults(w.W, 1);
            weekday = defaults(w.E, 1);
            if (weekday < 1 || weekday > 7) {
                weekdayOverflow = true;
            }
        } else {
            dow = config._locale._week.dow;
            doy = config._locale._week.doy;

            var curWeek = weekOfYear(createLocal(), dow, doy);

            weekYear = defaults(w.gg, config._a[YEAR], curWeek.year);

            // Default to current week.
            week = defaults(w.w, curWeek.week);

            if (w.d != null) {
                // weekday -- low day numbers are considered next week
                weekday = w.d;
                if (weekday < 0 || weekday > 6) {
                    weekdayOverflow = true;
                }
            } else if (w.e != null) {
                // local weekday -- counting starts from beginning of week
                weekday = w.e + dow;
                if (w.e < 0 || w.e > 6) {
                    weekdayOverflow = true;
                }
            } else {
                // default to beginning of week
                weekday = dow;
            }
        }
        if (week < 1 || week > weeksInYear(weekYear, dow, doy)) {
            getParsingFlags(config)._overflowWeeks = true;
        } else if (weekdayOverflow != null) {
            getParsingFlags(config)._overflowWeekday = true;
        } else {
            temp = dayOfYearFromWeeks(weekYear, week, weekday, dow, doy);
            config._a[YEAR] = temp.year;
            config._dayOfYear = temp.dayOfYear;
        }
    }

    // iso 8601 regex
    // 0000-00-00 0000-W00 or 0000-W00-0 + T + 00 or 00:00 or 00:00:00 or 00:00:00.000 + +00:00 or +0000 or +00)
    var extendedIsoRegex = /^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/;
    var basicIsoRegex = /^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/;

    var tzRegex = /Z|[+-]\d\d(?::?\d\d)?/;

    var isoDates = [
        ['YYYYYY-MM-DD', /[+-]\d{6}-\d\d-\d\d/],
        ['YYYY-MM-DD', /\d{4}-\d\d-\d\d/],
        ['GGGG-[W]WW-E', /\d{4}-W\d\d-\d/],
        ['GGGG-[W]WW', /\d{4}-W\d\d/, false],
        ['YYYY-DDD', /\d{4}-\d{3}/],
        ['YYYY-MM', /\d{4}-\d\d/, false],
        ['YYYYYYMMDD', /[+-]\d{10}/],
        ['YYYYMMDD', /\d{8}/],
        // YYYYMM is NOT allowed by the standard
        ['GGGG[W]WWE', /\d{4}W\d{3}/],
        ['GGGG[W]WW', /\d{4}W\d{2}/, false],
        ['YYYYDDD', /\d{7}/]
    ];

    // iso time formats and regexes
    var isoTimes = [
        ['HH:mm:ss.SSSS', /\d\d:\d\d:\d\d\.\d+/],
        ['HH:mm:ss,SSSS', /\d\d:\d\d:\d\d,\d+/],
        ['HH:mm:ss', /\d\d:\d\d:\d\d/],
        ['HH:mm', /\d\d:\d\d/],
        ['HHmmss.SSSS', /\d\d\d\d\d\d\.\d+/],
        ['HHmmss,SSSS', /\d\d\d\d\d\d,\d+/],
        ['HHmmss', /\d\d\d\d\d\d/],
        ['HHmm', /\d\d\d\d/],
        ['HH', /\d\d/]
    ];

    var aspNetJsonRegex = /^\/?Date\((\-?\d+)/i;

    // date from iso format
    function configFromISO(config) {
        var i, l,
            string = config._i,
            match = extendedIsoRegex.exec(string) || basicIsoRegex.exec(string),
            allowTime, dateFormat, timeFormat, tzFormat;

        if (match) {
            getParsingFlags(config).iso = true;

            for (i = 0, l = isoDates.length; i < l; i++) {
                if (isoDates[i][1].exec(match[1])) {
                    dateFormat = isoDates[i][0];
                    allowTime = isoDates[i][2] !== false;
                    break;
                }
            }
            if (dateFormat == null) {
                config._isValid = false;
                return;
            }
            if (match[3]) {
                for (i = 0, l = isoTimes.length; i < l; i++) {
                    if (isoTimes[i][1].exec(match[3])) {
                        // match[2] should be 'T' or space
                        timeFormat = (match[2] || ' ') + isoTimes[i][0];
                        break;
                    }
                }
                if (timeFormat == null) {
                    config._isValid = false;
                    return;
                }
            }
            if (!allowTime && timeFormat != null) {
                config._isValid = false;
                return;
            }
            if (match[4]) {
                if (tzRegex.exec(match[4])) {
                    tzFormat = 'Z';
                } else {
                    config._isValid = false;
                    return;
                }
            }
            config._f = dateFormat + (timeFormat || '') + (tzFormat || '');
            configFromStringAndFormat(config);
        } else {
            config._isValid = false;
        }
    }

    // RFC 2822 regex: For details see https://tools.ietf.org/html/rfc2822#section-3.3
    var rfc2822 = /^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/;

    function extractFromRFC2822Strings(yearStr, monthStr, dayStr, hourStr, minuteStr, secondStr) {
        var result = [
            untruncateYear(yearStr),
            defaultLocaleMonthsShort.indexOf(monthStr),
            parseInt(dayStr, 10),
            parseInt(hourStr, 10),
            parseInt(minuteStr, 10)
        ];

        if (secondStr) {
            result.push(parseInt(secondStr, 10));
        }

        return result;
    }

    function untruncateYear(yearStr) {
        var year = parseInt(yearStr, 10);
        if (year <= 49) {
            return 2000 + year;
        } else if (year <= 999) {
            return 1900 + year;
        }
        return year;
    }

    function preprocessRFC2822(s) {
        // Remove comments and folding whitespace and replace multiple-spaces with a single space
        return s.replace(/\([^)]*\)|[\n\t]/g, ' ').replace(/(\s\s+)/g, ' ').replace(/^\s\s*/, '').replace(/\s\s*$/, '');
    }

    function checkWeekday(weekdayStr, parsedInput, config) {
        if (weekdayStr) {
            // TODO: Replace the vanilla JS Date object with an indepentent day-of-week check.
            var weekdayProvided = defaultLocaleWeekdaysShort.indexOf(weekdayStr),
                weekdayActual = new Date(parsedInput[0], parsedInput[1], parsedInput[2]).getDay();
            if (weekdayProvided !== weekdayActual) {
                getParsingFlags(config).weekdayMismatch = true;
                config._isValid = false;
                return false;
            }
        }
        return true;
    }

    var obsOffsets = {
        UT: 0,
        GMT: 0,
        EDT: -4 * 60,
        EST: -5 * 60,
        CDT: -5 * 60,
        CST: -6 * 60,
        MDT: -6 * 60,
        MST: -7 * 60,
        PDT: -7 * 60,
        PST: -8 * 60
    };

    function calculateOffset(obsOffset, militaryOffset, numOffset) {
        if (obsOffset) {
            return obsOffsets[obsOffset];
        } else if (militaryOffset) {
            // the only allowed military tz is Z
            return 0;
        } else {
            var hm = parseInt(numOffset, 10);
            var m = hm % 100, h = (hm - m) / 100;
            return h * 60 + m;
        }
    }

    // date and time from ref 2822 format
    function configFromRFC2822(config) {
        var match = rfc2822.exec(preprocessRFC2822(config._i));
        if (match) {
            var parsedArray = extractFromRFC2822Strings(match[4], match[3], match[2], match[5], match[6], match[7]);
            if (!checkWeekday(match[1], parsedArray, config)) {
                return;
            }

            config._a = parsedArray;
            config._tzm = calculateOffset(match[8], match[9], match[10]);

            config._d = createUTCDate.apply(null, config._a);
            config._d.setUTCMinutes(config._d.getUTCMinutes() - config._tzm);

            getParsingFlags(config).rfc2822 = true;
        } else {
            config._isValid = false;
        }
    }

    // date from iso format or fallback
    function configFromString(config) {
        var matched = aspNetJsonRegex.exec(config._i);

        if (matched !== null) {
            config._d = new Date(+matched[1]);
            return;
        }

        configFromISO(config);
        if (config._isValid === false) {
            delete config._isValid;
        } else {
            return;
        }

        configFromRFC2822(config);
        if (config._isValid === false) {
            delete config._isValid;
        } else {
            return;
        }

        // Final attempt, use Input Fallback
        hooks.createFromInputFallback(config);
    }

    hooks.createFromInputFallback = deprecate(
        'value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), ' +
        'which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are ' +
        'discouraged and will be removed in an upcoming major release. Please refer to ' +
        'http://momentjs.com/guides/#/warnings/js-date/ for more info.',
        function (config) {
            config._d = new Date(config._i + (config._useUTC ? ' UTC' : ''));
        }
    );

    // constant that refers to the ISO standard
    hooks.ISO_8601 = function () {};

    // constant that refers to the RFC 2822 form
    hooks.RFC_2822 = function () {};

    // date from string and format string
    function configFromStringAndFormat(config) {
        // TODO: Move this to another part of the creation flow to prevent circular deps
        if (config._f === hooks.ISO_8601) {
            configFromISO(config);
            return;
        }
        if (config._f === hooks.RFC_2822) {
            configFromRFC2822(config);
            return;
        }
        config._a = [];
        getParsingFlags(config).empty = true;

        // This array is used to make a Date, either with `new Date` or `Date.UTC`
        var string = '' + config._i,
            i, parsedInput, tokens, token, skipped,
            stringLength = string.length,
            totalParsedInputLength = 0;

        tokens = expandFormat(config._f, config._locale).match(formattingTokens) || [];

        for (i = 0; i < tokens.length; i++) {
            token = tokens[i];
            parsedInput = (string.match(getParseRegexForToken(token, config)) || [])[0];
            // console.log('token', token, 'parsedInput', parsedInput,
            //         'regex', getParseRegexForToken(token, config));
            if (parsedInput) {
                skipped = string.substr(0, string.indexOf(parsedInput));
                if (skipped.length > 0) {
                    getParsingFlags(config).unusedInput.push(skipped);
                }
                string = string.slice(string.indexOf(parsedInput) + parsedInput.length);
                totalParsedInputLength += parsedInput.length;
            }
            // don't parse if it's not a known token
            if (formatTokenFunctions[token]) {
                if (parsedInput) {
                    getParsingFlags(config).empty = false;
                }
                else {
                    getParsingFlags(config).unusedTokens.push(token);
                }
                addTimeToArrayFromToken(token, parsedInput, config);
            }
            else if (config._strict && !parsedInput) {
                getParsingFlags(config).unusedTokens.push(token);
            }
        }

        // add remaining unparsed input length to the string
        getParsingFlags(config).charsLeftOver = stringLength - totalParsedInputLength;
        if (string.length > 0) {
            getParsingFlags(config).unusedInput.push(string);
        }

        // clear _12h flag if hour is <= 12
        if (config._a[HOUR] <= 12 &&
            getParsingFlags(config).bigHour === true &&
            config._a[HOUR] > 0) {
            getParsingFlags(config).bigHour = undefined;
        }

        getParsingFlags(config).parsedDateParts = config._a.slice(0);
        getParsingFlags(config).meridiem = config._meridiem;
        // handle meridiem
        config._a[HOUR] = meridiemFixWrap(config._locale, config._a[HOUR], config._meridiem);

        configFromArray(config);
        checkOverflow(config);
    }


    function meridiemFixWrap (locale, hour, meridiem) {
        var isPm;

        if (meridiem == null) {
            // nothing to do
            return hour;
        }
        if (locale.meridiemHour != null) {
            return locale.meridiemHour(hour, meridiem);
        } else if (locale.isPM != null) {
            // Fallback
            isPm = locale.isPM(meridiem);
            if (isPm && hour < 12) {
                hour += 12;
            }
            if (!isPm && hour === 12) {
                hour = 0;
            }
            return hour;
        } else {
            // this is not supposed to happen
            return hour;
        }
    }

    // date from string and array of format strings
    function configFromStringAndArray(config) {
        var tempConfig,
            bestMoment,

            scoreToBeat,
            i,
            currentScore;

        if (config._f.length === 0) {
            getParsingFlags(config).invalidFormat = true;
            config._d = new Date(NaN);
            return;
        }

        for (i = 0; i < config._f.length; i++) {
            currentScore = 0;
            tempConfig = copyConfig({}, config);
            if (config._useUTC != null) {
                tempConfig._useUTC = config._useUTC;
            }
            tempConfig._f = config._f[i];
            configFromStringAndFormat(tempConfig);

            if (!isValid(tempConfig)) {
                continue;
            }

            // if there is any input that was not parsed add a penalty for that format
            currentScore += getParsingFlags(tempConfig).charsLeftOver;

            //or tokens
            currentScore += getParsingFlags(tempConfig).unusedTokens.length * 10;

            getParsingFlags(tempConfig).score = currentScore;

            if (scoreToBeat == null || currentScore < scoreToBeat) {
                scoreToBeat = currentScore;
                bestMoment = tempConfig;
            }
        }

        extend(config, bestMoment || tempConfig);
    }

    function configFromObject(config) {
        if (config._d) {
            return;
        }

        var i = normalizeObjectUnits(config._i);
        config._a = map([i.year, i.month, i.day || i.date, i.hour, i.minute, i.second, i.millisecond], function (obj) {
            return obj && parseInt(obj, 10);
        });

        configFromArray(config);
    }

    function createFromConfig (config) {
        var res = new Moment(checkOverflow(prepareConfig(config)));
        if (res._nextDay) {
            // Adding is smart enough around DST
            res.add(1, 'd');
            res._nextDay = undefined;
        }

        return res;
    }

    function prepareConfig (config) {
        var input = config._i,
            format = config._f;

        config._locale = config._locale || getLocale(config._l);

        if (input === null || (format === undefined && input === '')) {
            return createInvalid({nullInput: true});
        }

        if (typeof input === 'string') {
            config._i = input = config._locale.preparse(input);
        }

        if (isMoment(input)) {
            return new Moment(checkOverflow(input));
        } else if (isDate(input)) {
            config._d = input;
        } else if (isArray(format)) {
            configFromStringAndArray(config);
        } else if (format) {
            configFromStringAndFormat(config);
        }  else {
            configFromInput(config);
        }

        if (!isValid(config)) {
            config._d = null;
        }

        return config;
    }

    function configFromInput(config) {
        var input = config._i;
        if (isUndefined(input)) {
            config._d = new Date(hooks.now());
        } else if (isDate(input)) {
            config._d = new Date(input.valueOf());
        } else if (typeof input === 'string') {
            configFromString(config);
        } else if (isArray(input)) {
            config._a = map(input.slice(0), function (obj) {
                return parseInt(obj, 10);
            });
            configFromArray(config);
        } else if (isObject(input)) {
            configFromObject(config);
        } else if (isNumber(input)) {
            // from milliseconds
            config._d = new Date(input);
        } else {
            hooks.createFromInputFallback(config);
        }
    }

    function createLocalOrUTC (input, format, locale, strict, isUTC) {
        var c = {};

        if (locale === true || locale === false) {
            strict = locale;
            locale = undefined;
        }

        if ((isObject(input) && isObjectEmpty(input)) ||
                (isArray(input) && input.length === 0)) {
            input = undefined;
        }
        // object construction must be done this way.
        // https://github.com/moment/moment/issues/1423
        c._isAMomentObject = true;
        c._useUTC = c._isUTC = isUTC;
        c._l = locale;
        c._i = input;
        c._f = format;
        c._strict = strict;

        return createFromConfig(c);
    }

    function createLocal (input, format, locale, strict) {
        return createLocalOrUTC(input, format, locale, strict, false);
    }

    var prototypeMin = deprecate(
        'moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/',
        function () {
            var other = createLocal.apply(null, arguments);
            if (this.isValid() && other.isValid()) {
                return other < this ? this : other;
            } else {
                return createInvalid();
            }
        }
    );

    var prototypeMax = deprecate(
        'moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/',
        function () {
            var other = createLocal.apply(null, arguments);
            if (this.isValid() && other.isValid()) {
                return other > this ? this : other;
            } else {
                return createInvalid();
            }
        }
    );

    // Pick a moment m from moments so that m[fn](other) is true for all
    // other. This relies on the function fn to be transitive.
    //
    // moments should either be an array of moment objects or an array, whose
    // first element is an array of moment objects.
    function pickBy(fn, moments) {
        var res, i;
        if (moments.length === 1 && isArray(moments[0])) {
            moments = moments[0];
        }
        if (!moments.length) {
            return createLocal();
        }
        res = moments[0];
        for (i = 1; i < moments.length; ++i) {
            if (!moments[i].isValid() || moments[i][fn](res)) {
                res = moments[i];
            }
        }
        return res;
    }

    // TODO: Use [].sort instead?
    function min () {
        var args = [].slice.call(arguments, 0);

        return pickBy('isBefore', args);
    }

    function max () {
        var args = [].slice.call(arguments, 0);

        return pickBy('isAfter', args);
    }

    var now = function () {
        return Date.now ? Date.now() : +(new Date());
    };

    var ordering = ['year', 'quarter', 'month', 'week', 'day', 'hour', 'minute', 'second', 'millisecond'];

    function isDurationValid(m) {
        for (var key in m) {
            if (!(indexOf.call(ordering, key) !== -1 && (m[key] == null || !isNaN(m[key])))) {
                return false;
            }
        }

        var unitHasDecimal = false;
        for (var i = 0; i < ordering.length; ++i) {
            if (m[ordering[i]]) {
                if (unitHasDecimal) {
                    return false; // only allow non-integers for smallest unit
                }
                if (parseFloat(m[ordering[i]]) !== toInt(m[ordering[i]])) {
                    unitHasDecimal = true;
                }
            }
        }

        return true;
    }

    function isValid$1() {
        return this._isValid;
    }

    function createInvalid$1() {
        return createDuration(NaN);
    }

    function Duration (duration) {
        var normalizedInput = normalizeObjectUnits(duration),
            years = normalizedInput.year || 0,
            quarters = normalizedInput.quarter || 0,
            months = normalizedInput.month || 0,
            weeks = normalizedInput.week || normalizedInput.isoWeek || 0,
            days = normalizedInput.day || 0,
            hours = normalizedInput.hour || 0,
            minutes = normalizedInput.minute || 0,
            seconds = normalizedInput.second || 0,
            milliseconds = normalizedInput.millisecond || 0;

        this._isValid = isDurationValid(normalizedInput);

        // representation for dateAddRemove
        this._milliseconds = +milliseconds +
            seconds * 1e3 + // 1000
            minutes * 6e4 + // 1000 * 60
            hours * 1000 * 60 * 60; //using 1000 * 60 * 60 instead of 36e5 to avoid floating point rounding errors https://github.com/moment/moment/issues/2978
        // Because of dateAddRemove treats 24 hours as different from a
        // day when working around DST, we need to store them separately
        this._days = +days +
            weeks * 7;
        // It is impossible to translate months into days without knowing
        // which months you are are talking about, so we have to store
        // it separately.
        this._months = +months +
            quarters * 3 +
            years * 12;

        this._data = {};

        this._locale = getLocale();

        this._bubble();
    }

    function isDuration (obj) {
        return obj instanceof Duration;
    }

    function absRound (number) {
        if (number < 0) {
            return Math.round(-1 * number) * -1;
        } else {
            return Math.round(number);
        }
    }

    // FORMATTING

    function offset (token, separator) {
        addFormatToken(token, 0, 0, function () {
            var offset = this.utcOffset();
            var sign = '+';
            if (offset < 0) {
                offset = -offset;
                sign = '-';
            }
            return sign + zeroFill(~~(offset / 60), 2) + separator + zeroFill(~~(offset) % 60, 2);
        });
    }

    offset('Z', ':');
    offset('ZZ', '');

    // PARSING

    addRegexToken('Z',  matchShortOffset);
    addRegexToken('ZZ', matchShortOffset);
    addParseToken(['Z', 'ZZ'], function (input, array, config) {
        config._useUTC = true;
        config._tzm = offsetFromString(matchShortOffset, input);
    });

    // HELPERS

    // timezone chunker
    // '+10:00' > ['10',  '00']
    // '-1530'  > ['-15', '30']
    var chunkOffset = /([\+\-]|\d\d)/gi;

    function offsetFromString(matcher, string) {
        var matches = (string || '').match(matcher);

        if (matches === null) {
            return null;
        }

        var chunk   = matches[matches.length - 1] || [];
        var parts   = (chunk + '').match(chunkOffset) || ['-', 0, 0];
        var minutes = +(parts[1] * 60) + toInt(parts[2]);

        return minutes === 0 ?
          0 :
          parts[0] === '+' ? minutes : -minutes;
    }

    // Return a moment from input, that is local/utc/zone equivalent to model.
    function cloneWithOffset(input, model) {
        var res, diff;
        if (model._isUTC) {
            res = model.clone();
            diff = (isMoment(input) || isDate(input) ? input.valueOf() : createLocal(input).valueOf()) - res.valueOf();
            // Use low-level api, because this fn is low-level api.
            res._d.setTime(res._d.valueOf() + diff);
            hooks.updateOffset(res, false);
            return res;
        } else {
            return createLocal(input).local();
        }
    }

    function getDateOffset (m) {
        // On Firefox.24 Date#getTimezoneOffset returns a floating point.
        // https://github.com/moment/moment/pull/1871
        return -Math.round(m._d.getTimezoneOffset() / 15) * 15;
    }

    // HOOKS

    // This function will be called whenever a moment is mutated.
    // It is intended to keep the offset in sync with the timezone.
    hooks.updateOffset = function () {};

    // MOMENTS

    // keepLocalTime = true means only change the timezone, without
    // affecting the local hour. So 5:31:26 +0300 --[utcOffset(2, true)]-->
    // 5:31:26 +0200 It is possible that 5:31:26 doesn't exist with offset
    // +0200, so we adjust the time as needed, to be valid.
    //
    // Keeping the time actually adds/subtracts (one hour)
    // from the actual represented time. That is why we call updateOffset
    // a second time. In case it wants us to change the offset again
    // _changeInProgress == true case, then we have to adjust, because
    // there is no such time in the given timezone.
    function getSetOffset (input, keepLocalTime, keepMinutes) {
        var offset = this._offset || 0,
            localAdjust;
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        if (input != null) {
            if (typeof input === 'string') {
                input = offsetFromString(matchShortOffset, input);
                if (input === null) {
                    return this;
                }
            } else if (Math.abs(input) < 16 && !keepMinutes) {
                input = input * 60;
            }
            if (!this._isUTC && keepLocalTime) {
                localAdjust = getDateOffset(this);
            }
            this._offset = input;
            this._isUTC = true;
            if (localAdjust != null) {
                this.add(localAdjust, 'm');
            }
            if (offset !== input) {
                if (!keepLocalTime || this._changeInProgress) {
                    addSubtract(this, createDuration(input - offset, 'm'), 1, false);
                } else if (!this._changeInProgress) {
                    this._changeInProgress = true;
                    hooks.updateOffset(this, true);
                    this._changeInProgress = null;
                }
            }
            return this;
        } else {
            return this._isUTC ? offset : getDateOffset(this);
        }
    }

    function getSetZone (input, keepLocalTime) {
        if (input != null) {
            if (typeof input !== 'string') {
                input = -input;
            }

            this.utcOffset(input, keepLocalTime);

            return this;
        } else {
            return -this.utcOffset();
        }
    }

    function setOffsetToUTC (keepLocalTime) {
        return this.utcOffset(0, keepLocalTime);
    }

    function setOffsetToLocal (keepLocalTime) {
        if (this._isUTC) {
            this.utcOffset(0, keepLocalTime);
            this._isUTC = false;

            if (keepLocalTime) {
                this.subtract(getDateOffset(this), 'm');
            }
        }
        return this;
    }

    function setOffsetToParsedOffset () {
        if (this._tzm != null) {
            this.utcOffset(this._tzm, false, true);
        } else if (typeof this._i === 'string') {
            var tZone = offsetFromString(matchOffset, this._i);
            if (tZone != null) {
                this.utcOffset(tZone);
            }
            else {
                this.utcOffset(0, true);
            }
        }
        return this;
    }

    function hasAlignedHourOffset (input) {
        if (!this.isValid()) {
            return false;
        }
        input = input ? createLocal(input).utcOffset() : 0;

        return (this.utcOffset() - input) % 60 === 0;
    }

    function isDaylightSavingTime () {
        return (
            this.utcOffset() > this.clone().month(0).utcOffset() ||
            this.utcOffset() > this.clone().month(5).utcOffset()
        );
    }

    function isDaylightSavingTimeShifted () {
        if (!isUndefined(this._isDSTShifted)) {
            return this._isDSTShifted;
        }

        var c = {};

        copyConfig(c, this);
        c = prepareConfig(c);

        if (c._a) {
            var other = c._isUTC ? createUTC(c._a) : createLocal(c._a);
            this._isDSTShifted = this.isValid() &&
                compareArrays(c._a, other.toArray()) > 0;
        } else {
            this._isDSTShifted = false;
        }

        return this._isDSTShifted;
    }

    function isLocal () {
        return this.isValid() ? !this._isUTC : false;
    }

    function isUtcOffset () {
        return this.isValid() ? this._isUTC : false;
    }

    function isUtc () {
        return this.isValid() ? this._isUTC && this._offset === 0 : false;
    }

    // ASP.NET json date format regex
    var aspNetRegex = /^(\-|\+)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/;

    // from http://docs.closure-library.googlecode.com/git/closure_goog_date_date.js.source.html
    // somewhat more in line with 4.4.3.2 2004 spec, but allows decimal anywhere
    // and further modified to allow for strings containing both week and day
    var isoRegex = /^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;

    function createDuration (input, key) {
        var duration = input,
            // matching against regexp is expensive, do it on demand
            match = null,
            sign,
            ret,
            diffRes;

        if (isDuration(input)) {
            duration = {
                ms : input._milliseconds,
                d  : input._days,
                M  : input._months
            };
        } else if (isNumber(input)) {
            duration = {};
            if (key) {
                duration[key] = input;
            } else {
                duration.milliseconds = input;
            }
        } else if (!!(match = aspNetRegex.exec(input))) {
            sign = (match[1] === '-') ? -1 : 1;
            duration = {
                y  : 0,
                d  : toInt(match[DATE])                         * sign,
                h  : toInt(match[HOUR])                         * sign,
                m  : toInt(match[MINUTE])                       * sign,
                s  : toInt(match[SECOND])                       * sign,
                ms : toInt(absRound(match[MILLISECOND] * 1000)) * sign // the millisecond decimal point is included in the match
            };
        } else if (!!(match = isoRegex.exec(input))) {
            sign = (match[1] === '-') ? -1 : 1;
            duration = {
                y : parseIso(match[2], sign),
                M : parseIso(match[3], sign),
                w : parseIso(match[4], sign),
                d : parseIso(match[5], sign),
                h : parseIso(match[6], sign),
                m : parseIso(match[7], sign),
                s : parseIso(match[8], sign)
            };
        } else if (duration == null) {// checks for null or undefined
            duration = {};
        } else if (typeof duration === 'object' && ('from' in duration || 'to' in duration)) {
            diffRes = momentsDifference(createLocal(duration.from), createLocal(duration.to));

            duration = {};
            duration.ms = diffRes.milliseconds;
            duration.M = diffRes.months;
        }

        ret = new Duration(duration);

        if (isDuration(input) && hasOwnProp(input, '_locale')) {
            ret._locale = input._locale;
        }

        return ret;
    }

    createDuration.fn = Duration.prototype;
    createDuration.invalid = createInvalid$1;

    function parseIso (inp, sign) {
        // We'd normally use ~~inp for this, but unfortunately it also
        // converts floats to ints.
        // inp may be undefined, so careful calling replace on it.
        var res = inp && parseFloat(inp.replace(',', '.'));
        // apply sign while we're at it
        return (isNaN(res) ? 0 : res) * sign;
    }

    function positiveMomentsDifference(base, other) {
        var res = {};

        res.months = other.month() - base.month() +
            (other.year() - base.year()) * 12;
        if (base.clone().add(res.months, 'M').isAfter(other)) {
            --res.months;
        }

        res.milliseconds = +other - +(base.clone().add(res.months, 'M'));

        return res;
    }

    function momentsDifference(base, other) {
        var res;
        if (!(base.isValid() && other.isValid())) {
            return {milliseconds: 0, months: 0};
        }

        other = cloneWithOffset(other, base);
        if (base.isBefore(other)) {
            res = positiveMomentsDifference(base, other);
        } else {
            res = positiveMomentsDifference(other, base);
            res.milliseconds = -res.milliseconds;
            res.months = -res.months;
        }

        return res;
    }

    // TODO: remove 'name' arg after deprecation is removed
    function createAdder(direction, name) {
        return function (val, period) {
            var dur, tmp;
            //invert the arguments, but complain about it
            if (period !== null && !isNaN(+period)) {
                deprecateSimple(name, 'moment().' + name  + '(period, number) is deprecated. Please use moment().' + name + '(number, period). ' +
                'See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info.');
                tmp = val; val = period; period = tmp;
            }

            val = typeof val === 'string' ? +val : val;
            dur = createDuration(val, period);
            addSubtract(this, dur, direction);
            return this;
        };
    }

    function addSubtract (mom, duration, isAdding, updateOffset) {
        var milliseconds = duration._milliseconds,
            days = absRound(duration._days),
            months = absRound(duration._months);

        if (!mom.isValid()) {
            // No op
            return;
        }

        updateOffset = updateOffset == null ? true : updateOffset;

        if (months) {
            setMonth(mom, get(mom, 'Month') + months * isAdding);
        }
        if (days) {
            set$1(mom, 'Date', get(mom, 'Date') + days * isAdding);
        }
        if (milliseconds) {
            mom._d.setTime(mom._d.valueOf() + milliseconds * isAdding);
        }
        if (updateOffset) {
            hooks.updateOffset(mom, days || months);
        }
    }

    var add      = createAdder(1, 'add');
    var subtract = createAdder(-1, 'subtract');

    function getCalendarFormat(myMoment, now) {
        var diff = myMoment.diff(now, 'days', true);
        return diff < -6 ? 'sameElse' :
                diff < -1 ? 'lastWeek' :
                diff < 0 ? 'lastDay' :
                diff < 1 ? 'sameDay' :
                diff < 2 ? 'nextDay' :
                diff < 7 ? 'nextWeek' : 'sameElse';
    }

    function calendar$1 (time, formats) {
        // We want to compare the start of today, vs this.
        // Getting start-of-today depends on whether we're local/utc/offset or not.
        var now = time || createLocal(),
            sod = cloneWithOffset(now, this).startOf('day'),
            format = hooks.calendarFormat(this, sod) || 'sameElse';

        var output = formats && (isFunction(formats[format]) ? formats[format].call(this, now) : formats[format]);

        return this.format(output || this.localeData().calendar(format, this, createLocal(now)));
    }

    function clone () {
        return new Moment(this);
    }

    function isAfter (input, units) {
        var localInput = isMoment(input) ? input : createLocal(input);
        if (!(this.isValid() && localInput.isValid())) {
            return false;
        }
        units = normalizeUnits(units) || 'millisecond';
        if (units === 'millisecond') {
            return this.valueOf() > localInput.valueOf();
        } else {
            return localInput.valueOf() < this.clone().startOf(units).valueOf();
        }
    }

    function isBefore (input, units) {
        var localInput = isMoment(input) ? input : createLocal(input);
        if (!(this.isValid() && localInput.isValid())) {
            return false;
        }
        units = normalizeUnits(units) || 'millisecond';
        if (units === 'millisecond') {
            return this.valueOf() < localInput.valueOf();
        } else {
            return this.clone().endOf(units).valueOf() < localInput.valueOf();
        }
    }

    function isBetween (from, to, units, inclusivity) {
        var localFrom = isMoment(from) ? from : createLocal(from),
            localTo = isMoment(to) ? to : createLocal(to);
        if (!(this.isValid() && localFrom.isValid() && localTo.isValid())) {
            return false;
        }
        inclusivity = inclusivity || '()';
        return (inclusivity[0] === '(' ? this.isAfter(localFrom, units) : !this.isBefore(localFrom, units)) &&
            (inclusivity[1] === ')' ? this.isBefore(localTo, units) : !this.isAfter(localTo, units));
    }

    function isSame (input, units) {
        var localInput = isMoment(input) ? input : createLocal(input),
            inputMs;
        if (!(this.isValid() && localInput.isValid())) {
            return false;
        }
        units = normalizeUnits(units) || 'millisecond';
        if (units === 'millisecond') {
            return this.valueOf() === localInput.valueOf();
        } else {
            inputMs = localInput.valueOf();
            return this.clone().startOf(units).valueOf() <= inputMs && inputMs <= this.clone().endOf(units).valueOf();
        }
    }

    function isSameOrAfter (input, units) {
        return this.isSame(input, units) || this.isAfter(input, units);
    }

    function isSameOrBefore (input, units) {
        return this.isSame(input, units) || this.isBefore(input, units);
    }

    function diff (input, units, asFloat) {
        var that,
            zoneDelta,
            output;

        if (!this.isValid()) {
            return NaN;
        }

        that = cloneWithOffset(input, this);

        if (!that.isValid()) {
            return NaN;
        }

        zoneDelta = (that.utcOffset() - this.utcOffset()) * 6e4;

        units = normalizeUnits(units);

        switch (units) {
            case 'year': output = monthDiff(this, that) / 12; break;
            case 'month': output = monthDiff(this, that); break;
            case 'quarter': output = monthDiff(this, that) / 3; break;
            case 'second': output = (this - that) / 1e3; break; // 1000
            case 'minute': output = (this - that) / 6e4; break; // 1000 * 60
            case 'hour': output = (this - that) / 36e5; break; // 1000 * 60 * 60
            case 'day': output = (this - that - zoneDelta) / 864e5; break; // 1000 * 60 * 60 * 24, negate dst
            case 'week': output = (this - that - zoneDelta) / 6048e5; break; // 1000 * 60 * 60 * 24 * 7, negate dst
            default: output = this - that;
        }

        return asFloat ? output : absFloor(output);
    }

    function monthDiff (a, b) {
        // difference in months
        var wholeMonthDiff = ((b.year() - a.year()) * 12) + (b.month() - a.month()),
            // b is in (anchor - 1 month, anchor + 1 month)
            anchor = a.clone().add(wholeMonthDiff, 'months'),
            anchor2, adjust;

        if (b - anchor < 0) {
            anchor2 = a.clone().add(wholeMonthDiff - 1, 'months');
            // linear across the month
            adjust = (b - anchor) / (anchor - anchor2);
        } else {
            anchor2 = a.clone().add(wholeMonthDiff + 1, 'months');
            // linear across the month
            adjust = (b - anchor) / (anchor2 - anchor);
        }

        //check for negative zero, return zero if negative zero
        return -(wholeMonthDiff + adjust) || 0;
    }

    hooks.defaultFormat = 'YYYY-MM-DDTHH:mm:ssZ';
    hooks.defaultFormatUtc = 'YYYY-MM-DDTHH:mm:ss[Z]';

    function toString () {
        return this.clone().locale('en').format('ddd MMM DD YYYY HH:mm:ss [GMT]ZZ');
    }

    function toISOString(keepOffset) {
        if (!this.isValid()) {
            return null;
        }
        var utc = keepOffset !== true;
        var m = utc ? this.clone().utc() : this;
        if (m.year() < 0 || m.year() > 9999) {
            return formatMoment(m, utc ? 'YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]' : 'YYYYYY-MM-DD[T]HH:mm:ss.SSSZ');
        }
        if (isFunction(Date.prototype.toISOString)) {
            // native implementation is ~50x faster, use it when we can
            if (utc) {
                return this.toDate().toISOString();
            } else {
                return new Date(this.valueOf() + this.utcOffset() * 60 * 1000).toISOString().replace('Z', formatMoment(m, 'Z'));
            }
        }
        return formatMoment(m, utc ? 'YYYY-MM-DD[T]HH:mm:ss.SSS[Z]' : 'YYYY-MM-DD[T]HH:mm:ss.SSSZ');
    }

    /**
     * Return a human readable representation of a moment that can
     * also be evaluated to get a new moment which is the same
     *
     * @link https://nodejs.org/dist/latest/docs/api/util.html#util_custom_inspect_function_on_objects
     */
    function inspect () {
        if (!this.isValid()) {
            return 'moment.invalid(/* ' + this._i + ' */)';
        }
        var func = 'moment';
        var zone = '';
        if (!this.isLocal()) {
            func = this.utcOffset() === 0 ? 'moment.utc' : 'moment.parseZone';
            zone = 'Z';
        }
        var prefix = '[' + func + '("]';
        var year = (0 <= this.year() && this.year() <= 9999) ? 'YYYY' : 'YYYYYY';
        var datetime = '-MM-DD[T]HH:mm:ss.SSS';
        var suffix = zone + '[")]';

        return this.format(prefix + year + datetime + suffix);
    }

    function format (inputString) {
        if (!inputString) {
            inputString = this.isUtc() ? hooks.defaultFormatUtc : hooks.defaultFormat;
        }
        var output = formatMoment(this, inputString);
        return this.localeData().postformat(output);
    }

    function from (time, withoutSuffix) {
        if (this.isValid() &&
                ((isMoment(time) && time.isValid()) ||
                 createLocal(time).isValid())) {
            return createDuration({to: this, from: time}).locale(this.locale()).humanize(!withoutSuffix);
        } else {
            return this.localeData().invalidDate();
        }
    }

    function fromNow (withoutSuffix) {
        return this.from(createLocal(), withoutSuffix);
    }

    function to (time, withoutSuffix) {
        if (this.isValid() &&
                ((isMoment(time) && time.isValid()) ||
                 createLocal(time).isValid())) {
            return createDuration({from: this, to: time}).locale(this.locale()).humanize(!withoutSuffix);
        } else {
            return this.localeData().invalidDate();
        }
    }

    function toNow (withoutSuffix) {
        return this.to(createLocal(), withoutSuffix);
    }

    // If passed a locale key, it will set the locale for this
    // instance.  Otherwise, it will return the locale configuration
    // variables for this instance.
    function locale (key) {
        var newLocaleData;

        if (key === undefined) {
            return this._locale._abbr;
        } else {
            newLocaleData = getLocale(key);
            if (newLocaleData != null) {
                this._locale = newLocaleData;
            }
            return this;
        }
    }

    var lang = deprecate(
        'moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.',
        function (key) {
            if (key === undefined) {
                return this.localeData();
            } else {
                return this.locale(key);
            }
        }
    );

    function localeData () {
        return this._locale;
    }

    var MS_PER_SECOND = 1000;
    var MS_PER_MINUTE = 60 * MS_PER_SECOND;
    var MS_PER_HOUR = 60 * MS_PER_MINUTE;
    var MS_PER_400_YEARS = (365 * 400 + 97) * 24 * MS_PER_HOUR;

    // actual modulo - handles negative numbers (for dates before 1970):
    function mod$1(dividend, divisor) {
        return (dividend % divisor + divisor) % divisor;
    }

    function localStartOfDate(y, m, d) {
        // the date constructor remaps years 0-99 to 1900-1999
        if (y < 100 && y >= 0) {
            // preserve leap years using a full 400 year cycle, then reset
            return new Date(y + 400, m, d) - MS_PER_400_YEARS;
        } else {
            return new Date(y, m, d).valueOf();
        }
    }

    function utcStartOfDate(y, m, d) {
        // Date.UTC remaps years 0-99 to 1900-1999
        if (y < 100 && y >= 0) {
            // preserve leap years using a full 400 year cycle, then reset
            return Date.UTC(y + 400, m, d) - MS_PER_400_YEARS;
        } else {
            return Date.UTC(y, m, d);
        }
    }

    function startOf (units) {
        var time;
        units = normalizeUnits(units);
        if (units === undefined || units === 'millisecond' || !this.isValid()) {
            return this;
        }

        var startOfDate = this._isUTC ? utcStartOfDate : localStartOfDate;

        switch (units) {
            case 'year':
                time = startOfDate(this.year(), 0, 1);
                break;
            case 'quarter':
                time = startOfDate(this.year(), this.month() - this.month() % 3, 1);
                break;
            case 'month':
                time = startOfDate(this.year(), this.month(), 1);
                break;
            case 'week':
                time = startOfDate(this.year(), this.month(), this.date() - this.weekday());
                break;
            case 'isoWeek':
                time = startOfDate(this.year(), this.month(), this.date() - (this.isoWeekday() - 1));
                break;
            case 'day':
            case 'date':
                time = startOfDate(this.year(), this.month(), this.date());
                break;
            case 'hour':
                time = this._d.valueOf();
                time -= mod$1(time + (this._isUTC ? 0 : this.utcOffset() * MS_PER_MINUTE), MS_PER_HOUR);
                break;
            case 'minute':
                time = this._d.valueOf();
                time -= mod$1(time, MS_PER_MINUTE);
                break;
            case 'second':
                time = this._d.valueOf();
                time -= mod$1(time, MS_PER_SECOND);
                break;
        }

        this._d.setTime(time);
        hooks.updateOffset(this, true);
        return this;
    }

    function endOf (units) {
        var time;
        units = normalizeUnits(units);
        if (units === undefined || units === 'millisecond' || !this.isValid()) {
            return this;
        }

        var startOfDate = this._isUTC ? utcStartOfDate : localStartOfDate;

        switch (units) {
            case 'year':
                time = startOfDate(this.year() + 1, 0, 1) - 1;
                break;
            case 'quarter':
                time = startOfDate(this.year(), this.month() - this.month() % 3 + 3, 1) - 1;
                break;
            case 'month':
                time = startOfDate(this.year(), this.month() + 1, 1) - 1;
                break;
            case 'week':
                time = startOfDate(this.year(), this.month(), this.date() - this.weekday() + 7) - 1;
                break;
            case 'isoWeek':
                time = startOfDate(this.year(), this.month(), this.date() - (this.isoWeekday() - 1) + 7) - 1;
                break;
            case 'day':
            case 'date':
                time = startOfDate(this.year(), this.month(), this.date() + 1) - 1;
                break;
            case 'hour':
                time = this._d.valueOf();
                time += MS_PER_HOUR - mod$1(time + (this._isUTC ? 0 : this.utcOffset() * MS_PER_MINUTE), MS_PER_HOUR) - 1;
                break;
            case 'minute':
                time = this._d.valueOf();
                time += MS_PER_MINUTE - mod$1(time, MS_PER_MINUTE) - 1;
                break;
            case 'second':
                time = this._d.valueOf();
                time += MS_PER_SECOND - mod$1(time, MS_PER_SECOND) - 1;
                break;
        }

        this._d.setTime(time);
        hooks.updateOffset(this, true);
        return this;
    }

    function valueOf () {
        return this._d.valueOf() - ((this._offset || 0) * 60000);
    }

    function unix () {
        return Math.floor(this.valueOf() / 1000);
    }

    function toDate () {
        return new Date(this.valueOf());
    }

    function toArray () {
        var m = this;
        return [m.year(), m.month(), m.date(), m.hour(), m.minute(), m.second(), m.millisecond()];
    }

    function toObject () {
        var m = this;
        return {
            years: m.year(),
            months: m.month(),
            date: m.date(),
            hours: m.hours(),
            minutes: m.minutes(),
            seconds: m.seconds(),
            milliseconds: m.milliseconds()
        };
    }

    function toJSON () {
        // new Date(NaN).toJSON() === null
        return this.isValid() ? this.toISOString() : null;
    }

    function isValid$2 () {
        return isValid(this);
    }

    function parsingFlags () {
        return extend({}, getParsingFlags(this));
    }

    function invalidAt () {
        return getParsingFlags(this).overflow;
    }

    function creationData() {
        return {
            input: this._i,
            format: this._f,
            locale: this._locale,
            isUTC: this._isUTC,
            strict: this._strict
        };
    }

    // FORMATTING

    addFormatToken(0, ['gg', 2], 0, function () {
        return this.weekYear() % 100;
    });

    addFormatToken(0, ['GG', 2], 0, function () {
        return this.isoWeekYear() % 100;
    });

    function addWeekYearFormatToken (token, getter) {
        addFormatToken(0, [token, token.length], 0, getter);
    }

    addWeekYearFormatToken('gggg',     'weekYear');
    addWeekYearFormatToken('ggggg',    'weekYear');
    addWeekYearFormatToken('GGGG',  'isoWeekYear');
    addWeekYearFormatToken('GGGGG', 'isoWeekYear');

    // ALIASES

    addUnitAlias('weekYear', 'gg');
    addUnitAlias('isoWeekYear', 'GG');

    // PRIORITY

    addUnitPriority('weekYear', 1);
    addUnitPriority('isoWeekYear', 1);


    // PARSING

    addRegexToken('G',      matchSigned);
    addRegexToken('g',      matchSigned);
    addRegexToken('GG',     match1to2, match2);
    addRegexToken('gg',     match1to2, match2);
    addRegexToken('GGGG',   match1to4, match4);
    addRegexToken('gggg',   match1to4, match4);
    addRegexToken('GGGGG',  match1to6, match6);
    addRegexToken('ggggg',  match1to6, match6);

    addWeekParseToken(['gggg', 'ggggg', 'GGGG', 'GGGGG'], function (input, week, config, token) {
        week[token.substr(0, 2)] = toInt(input);
    });

    addWeekParseToken(['gg', 'GG'], function (input, week, config, token) {
        week[token] = hooks.parseTwoDigitYear(input);
    });

    // MOMENTS

    function getSetWeekYear (input) {
        return getSetWeekYearHelper.call(this,
                input,
                this.week(),
                this.weekday(),
                this.localeData()._week.dow,
                this.localeData()._week.doy);
    }

    function getSetISOWeekYear (input) {
        return getSetWeekYearHelper.call(this,
                input, this.isoWeek(), this.isoWeekday(), 1, 4);
    }

    function getISOWeeksInYear () {
        return weeksInYear(this.year(), 1, 4);
    }

    function getWeeksInYear () {
        var weekInfo = this.localeData()._week;
        return weeksInYear(this.year(), weekInfo.dow, weekInfo.doy);
    }

    function getSetWeekYearHelper(input, week, weekday, dow, doy) {
        var weeksTarget;
        if (input == null) {
            return weekOfYear(this, dow, doy).year;
        } else {
            weeksTarget = weeksInYear(input, dow, doy);
            if (week > weeksTarget) {
                week = weeksTarget;
            }
            return setWeekAll.call(this, input, week, weekday, dow, doy);
        }
    }

    function setWeekAll(weekYear, week, weekday, dow, doy) {
        var dayOfYearData = dayOfYearFromWeeks(weekYear, week, weekday, dow, doy),
            date = createUTCDate(dayOfYearData.year, 0, dayOfYearData.dayOfYear);

        this.year(date.getUTCFullYear());
        this.month(date.getUTCMonth());
        this.date(date.getUTCDate());
        return this;
    }

    // FORMATTING

    addFormatToken('Q', 0, 'Qo', 'quarter');

    // ALIASES

    addUnitAlias('quarter', 'Q');

    // PRIORITY

    addUnitPriority('quarter', 7);

    // PARSING

    addRegexToken('Q', match1);
    addParseToken('Q', function (input, array) {
        array[MONTH] = (toInt(input) - 1) * 3;
    });

    // MOMENTS

    function getSetQuarter (input) {
        return input == null ? Math.ceil((this.month() + 1) / 3) : this.month((input - 1) * 3 + this.month() % 3);
    }

    // FORMATTING

    addFormatToken('D', ['DD', 2], 'Do', 'date');

    // ALIASES

    addUnitAlias('date', 'D');

    // PRIORITY
    addUnitPriority('date', 9);

    // PARSING

    addRegexToken('D',  match1to2);
    addRegexToken('DD', match1to2, match2);
    addRegexToken('Do', function (isStrict, locale) {
        // TODO: Remove "ordinalParse" fallback in next major release.
        return isStrict ?
          (locale._dayOfMonthOrdinalParse || locale._ordinalParse) :
          locale._dayOfMonthOrdinalParseLenient;
    });

    addParseToken(['D', 'DD'], DATE);
    addParseToken('Do', function (input, array) {
        array[DATE] = toInt(input.match(match1to2)[0]);
    });

    // MOMENTS

    var getSetDayOfMonth = makeGetSet('Date', true);

    // FORMATTING

    addFormatToken('DDD', ['DDDD', 3], 'DDDo', 'dayOfYear');

    // ALIASES

    addUnitAlias('dayOfYear', 'DDD');

    // PRIORITY
    addUnitPriority('dayOfYear', 4);

    // PARSING

    addRegexToken('DDD',  match1to3);
    addRegexToken('DDDD', match3);
    addParseToken(['DDD', 'DDDD'], function (input, array, config) {
        config._dayOfYear = toInt(input);
    });

    // HELPERS

    // MOMENTS

    function getSetDayOfYear (input) {
        var dayOfYear = Math.round((this.clone().startOf('day') - this.clone().startOf('year')) / 864e5) + 1;
        return input == null ? dayOfYear : this.add((input - dayOfYear), 'd');
    }

    // FORMATTING

    addFormatToken('m', ['mm', 2], 0, 'minute');

    // ALIASES

    addUnitAlias('minute', 'm');

    // PRIORITY

    addUnitPriority('minute', 14);

    // PARSING

    addRegexToken('m',  match1to2);
    addRegexToken('mm', match1to2, match2);
    addParseToken(['m', 'mm'], MINUTE);

    // MOMENTS

    var getSetMinute = makeGetSet('Minutes', false);

    // FORMATTING

    addFormatToken('s', ['ss', 2], 0, 'second');

    // ALIASES

    addUnitAlias('second', 's');

    // PRIORITY

    addUnitPriority('second', 15);

    // PARSING

    addRegexToken('s',  match1to2);
    addRegexToken('ss', match1to2, match2);
    addParseToken(['s', 'ss'], SECOND);

    // MOMENTS

    var getSetSecond = makeGetSet('Seconds', false);

    // FORMATTING

    addFormatToken('S', 0, 0, function () {
        return ~~(this.millisecond() / 100);
    });

    addFormatToken(0, ['SS', 2], 0, function () {
        return ~~(this.millisecond() / 10);
    });

    addFormatToken(0, ['SSS', 3], 0, 'millisecond');
    addFormatToken(0, ['SSSS', 4], 0, function () {
        return this.millisecond() * 10;
    });
    addFormatToken(0, ['SSSSS', 5], 0, function () {
        return this.millisecond() * 100;
    });
    addFormatToken(0, ['SSSSSS', 6], 0, function () {
        return this.millisecond() * 1000;
    });
    addFormatToken(0, ['SSSSSSS', 7], 0, function () {
        return this.millisecond() * 10000;
    });
    addFormatToken(0, ['SSSSSSSS', 8], 0, function () {
        return this.millisecond() * 100000;
    });
    addFormatToken(0, ['SSSSSSSSS', 9], 0, function () {
        return this.millisecond() * 1000000;
    });


    // ALIASES

    addUnitAlias('millisecond', 'ms');

    // PRIORITY

    addUnitPriority('millisecond', 16);

    // PARSING

    addRegexToken('S',    match1to3, match1);
    addRegexToken('SS',   match1to3, match2);
    addRegexToken('SSS',  match1to3, match3);

    var token;
    for (token = 'SSSS'; token.length <= 9; token += 'S') {
        addRegexToken(token, matchUnsigned);
    }

    function parseMs(input, array) {
        array[MILLISECOND] = toInt(('0.' + input) * 1000);
    }

    for (token = 'S'; token.length <= 9; token += 'S') {
        addParseToken(token, parseMs);
    }
    // MOMENTS

    var getSetMillisecond = makeGetSet('Milliseconds', false);

    // FORMATTING

    addFormatToken('z',  0, 0, 'zoneAbbr');
    addFormatToken('zz', 0, 0, 'zoneName');

    // MOMENTS

    function getZoneAbbr () {
        return this._isUTC ? 'UTC' : '';
    }

    function getZoneName () {
        return this._isUTC ? 'Coordinated Universal Time' : '';
    }

    var proto = Moment.prototype;

    proto.add               = add;
    proto.calendar          = calendar$1;
    proto.clone             = clone;
    proto.diff              = diff;
    proto.endOf             = endOf;
    proto.format            = format;
    proto.from              = from;
    proto.fromNow           = fromNow;
    proto.to                = to;
    proto.toNow             = toNow;
    proto.get               = stringGet;
    proto.invalidAt         = invalidAt;
    proto.isAfter           = isAfter;
    proto.isBefore          = isBefore;
    proto.isBetween         = isBetween;
    proto.isSame            = isSame;
    proto.isSameOrAfter     = isSameOrAfter;
    proto.isSameOrBefore    = isSameOrBefore;
    proto.isValid           = isValid$2;
    proto.lang              = lang;
    proto.locale            = locale;
    proto.localeData        = localeData;
    proto.max               = prototypeMax;
    proto.min               = prototypeMin;
    proto.parsingFlags      = parsingFlags;
    proto.set               = stringSet;
    proto.startOf           = startOf;
    proto.subtract          = subtract;
    proto.toArray           = toArray;
    proto.toObject          = toObject;
    proto.toDate            = toDate;
    proto.toISOString       = toISOString;
    proto.inspect           = inspect;
    proto.toJSON            = toJSON;
    proto.toString          = toString;
    proto.unix              = unix;
    proto.valueOf           = valueOf;
    proto.creationData      = creationData;
    proto.year       = getSetYear;
    proto.isLeapYear = getIsLeapYear;
    proto.weekYear    = getSetWeekYear;
    proto.isoWeekYear = getSetISOWeekYear;
    proto.quarter = proto.quarters = getSetQuarter;
    proto.month       = getSetMonth;
    proto.daysInMonth = getDaysInMonth;
    proto.week           = proto.weeks        = getSetWeek;
    proto.isoWeek        = proto.isoWeeks     = getSetISOWeek;
    proto.weeksInYear    = getWeeksInYear;
    proto.isoWeeksInYear = getISOWeeksInYear;
    proto.date       = getSetDayOfMonth;
    proto.day        = proto.days             = getSetDayOfWeek;
    proto.weekday    = getSetLocaleDayOfWeek;
    proto.isoWeekday = getSetISODayOfWeek;
    proto.dayOfYear  = getSetDayOfYear;
    proto.hour = proto.hours = getSetHour;
    proto.minute = proto.minutes = getSetMinute;
    proto.second = proto.seconds = getSetSecond;
    proto.millisecond = proto.milliseconds = getSetMillisecond;
    proto.utcOffset            = getSetOffset;
    proto.utc                  = setOffsetToUTC;
    proto.local                = setOffsetToLocal;
    proto.parseZone            = setOffsetToParsedOffset;
    proto.hasAlignedHourOffset = hasAlignedHourOffset;
    proto.isDST                = isDaylightSavingTime;
    proto.isLocal              = isLocal;
    proto.isUtcOffset          = isUtcOffset;
    proto.isUtc                = isUtc;
    proto.isUTC                = isUtc;
    proto.zoneAbbr = getZoneAbbr;
    proto.zoneName = getZoneName;
    proto.dates  = deprecate('dates accessor is deprecated. Use date instead.', getSetDayOfMonth);
    proto.months = deprecate('months accessor is deprecated. Use month instead', getSetMonth);
    proto.years  = deprecate('years accessor is deprecated. Use year instead', getSetYear);
    proto.zone   = deprecate('moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/', getSetZone);
    proto.isDSTShifted = deprecate('isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information', isDaylightSavingTimeShifted);

    function createUnix (input) {
        return createLocal(input * 1000);
    }

    function createInZone () {
        return createLocal.apply(null, arguments).parseZone();
    }

    function preParsePostFormat (string) {
        return string;
    }

    var proto$1 = Locale.prototype;

    proto$1.calendar        = calendar;
    proto$1.longDateFormat  = longDateFormat;
    proto$1.invalidDate     = invalidDate;
    proto$1.ordinal         = ordinal;
    proto$1.preparse        = preParsePostFormat;
    proto$1.postformat      = preParsePostFormat;
    proto$1.relativeTime    = relativeTime;
    proto$1.pastFuture      = pastFuture;
    proto$1.set             = set;

    proto$1.months            =        localeMonths;
    proto$1.monthsShort       =        localeMonthsShort;
    proto$1.monthsParse       =        localeMonthsParse;
    proto$1.monthsRegex       = monthsRegex;
    proto$1.monthsShortRegex  = monthsShortRegex;
    proto$1.week = localeWeek;
    proto$1.firstDayOfYear = localeFirstDayOfYear;
    proto$1.firstDayOfWeek = localeFirstDayOfWeek;

    proto$1.weekdays       =        localeWeekdays;
    proto$1.weekdaysMin    =        localeWeekdaysMin;
    proto$1.weekdaysShort  =        localeWeekdaysShort;
    proto$1.weekdaysParse  =        localeWeekdaysParse;

    proto$1.weekdaysRegex       =        weekdaysRegex;
    proto$1.weekdaysShortRegex  =        weekdaysShortRegex;
    proto$1.weekdaysMinRegex    =        weekdaysMinRegex;

    proto$1.isPM = localeIsPM;
    proto$1.meridiem = localeMeridiem;

    function get$1 (format, index, field, setter) {
        var locale = getLocale();
        var utc = createUTC().set(setter, index);
        return locale[field](utc, format);
    }

    function listMonthsImpl (format, index, field) {
        if (isNumber(format)) {
            index = format;
            format = undefined;
        }

        format = format || '';

        if (index != null) {
            return get$1(format, index, field, 'month');
        }

        var i;
        var out = [];
        for (i = 0; i < 12; i++) {
            out[i] = get$1(format, i, field, 'month');
        }
        return out;
    }

    // ()
    // (5)
    // (fmt, 5)
    // (fmt)
    // (true)
    // (true, 5)
    // (true, fmt, 5)
    // (true, fmt)
    function listWeekdaysImpl (localeSorted, format, index, field) {
        if (typeof localeSorted === 'boolean') {
            if (isNumber(format)) {
                index = format;
                format = undefined;
            }

            format = format || '';
        } else {
            format = localeSorted;
            index = format;
            localeSorted = false;

            if (isNumber(format)) {
                index = format;
                format = undefined;
            }

            format = format || '';
        }

        var locale = getLocale(),
            shift = localeSorted ? locale._week.dow : 0;

        if (index != null) {
            return get$1(format, (index + shift) % 7, field, 'day');
        }

        var i;
        var out = [];
        for (i = 0; i < 7; i++) {
            out[i] = get$1(format, (i + shift) % 7, field, 'day');
        }
        return out;
    }

    function listMonths (format, index) {
        return listMonthsImpl(format, index, 'months');
    }

    function listMonthsShort (format, index) {
        return listMonthsImpl(format, index, 'monthsShort');
    }

    function listWeekdays (localeSorted, format, index) {
        return listWeekdaysImpl(localeSorted, format, index, 'weekdays');
    }

    function listWeekdaysShort (localeSorted, format, index) {
        return listWeekdaysImpl(localeSorted, format, index, 'weekdaysShort');
    }

    function listWeekdaysMin (localeSorted, format, index) {
        return listWeekdaysImpl(localeSorted, format, index, 'weekdaysMin');
    }

    getSetGlobalLocale('en', {
        dayOfMonthOrdinalParse: /\d{1,2}(th|st|nd|rd)/,
        ordinal : function (number) {
            var b = number % 10,
                output = (toInt(number % 100 / 10) === 1) ? 'th' :
                (b === 1) ? 'st' :
                (b === 2) ? 'nd' :
                (b === 3) ? 'rd' : 'th';
            return number + output;
        }
    });

    // Side effect imports

    hooks.lang = deprecate('moment.lang is deprecated. Use moment.locale instead.', getSetGlobalLocale);
    hooks.langData = deprecate('moment.langData is deprecated. Use moment.localeData instead.', getLocale);

    var mathAbs = Math.abs;

    function abs () {
        var data           = this._data;

        this._milliseconds = mathAbs(this._milliseconds);
        this._days         = mathAbs(this._days);
        this._months       = mathAbs(this._months);

        data.milliseconds  = mathAbs(data.milliseconds);
        data.seconds       = mathAbs(data.seconds);
        data.minutes       = mathAbs(data.minutes);
        data.hours         = mathAbs(data.hours);
        data.months        = mathAbs(data.months);
        data.years         = mathAbs(data.years);

        return this;
    }

    function addSubtract$1 (duration, input, value, direction) {
        var other = createDuration(input, value);

        duration._milliseconds += direction * other._milliseconds;
        duration._days         += direction * other._days;
        duration._months       += direction * other._months;

        return duration._bubble();
    }

    // supports only 2.0-style add(1, 's') or add(duration)
    function add$1 (input, value) {
        return addSubtract$1(this, input, value, 1);
    }

    // supports only 2.0-style subtract(1, 's') or subtract(duration)
    function subtract$1 (input, value) {
        return addSubtract$1(this, input, value, -1);
    }

    function absCeil (number) {
        if (number < 0) {
            return Math.floor(number);
        } else {
            return Math.ceil(number);
        }
    }

    function bubble () {
        var milliseconds = this._milliseconds;
        var days         = this._days;
        var months       = this._months;
        var data         = this._data;
        var seconds, minutes, hours, years, monthsFromDays;

        // if we have a mix of positive and negative values, bubble down first
        // check: https://github.com/moment/moment/issues/2166
        if (!((milliseconds >= 0 && days >= 0 && months >= 0) ||
                (milliseconds <= 0 && days <= 0 && months <= 0))) {
            milliseconds += absCeil(monthsToDays(months) + days) * 864e5;
            days = 0;
            months = 0;
        }

        // The following code bubbles up values, see the tests for
        // examples of what that means.
        data.milliseconds = milliseconds % 1000;

        seconds           = absFloor(milliseconds / 1000);
        data.seconds      = seconds % 60;

        minutes           = absFloor(seconds / 60);
        data.minutes      = minutes % 60;

        hours             = absFloor(minutes / 60);
        data.hours        = hours % 24;

        days += absFloor(hours / 24);

        // convert days to months
        monthsFromDays = absFloor(daysToMonths(days));
        months += monthsFromDays;
        days -= absCeil(monthsToDays(monthsFromDays));

        // 12 months -> 1 year
        years = absFloor(months / 12);
        months %= 12;

        data.days   = days;
        data.months = months;
        data.years  = years;

        return this;
    }

    function daysToMonths (days) {
        // 400 years have 146097 days (taking into account leap year rules)
        // 400 years have 12 months === 4800
        return days * 4800 / 146097;
    }

    function monthsToDays (months) {
        // the reverse of daysToMonths
        return months * 146097 / 4800;
    }

    function as (units) {
        if (!this.isValid()) {
            return NaN;
        }
        var days;
        var months;
        var milliseconds = this._milliseconds;

        units = normalizeUnits(units);

        if (units === 'month' || units === 'quarter' || units === 'year') {
            days = this._days + milliseconds / 864e5;
            months = this._months + daysToMonths(days);
            switch (units) {
                case 'month':   return months;
                case 'quarter': return months / 3;
                case 'year':    return months / 12;
            }
        } else {
            // handle milliseconds separately because of floating point math errors (issue #1867)
            days = this._days + Math.round(monthsToDays(this._months));
            switch (units) {
                case 'week'   : return days / 7     + milliseconds / 6048e5;
                case 'day'    : return days         + milliseconds / 864e5;
                case 'hour'   : return days * 24    + milliseconds / 36e5;
                case 'minute' : return days * 1440  + milliseconds / 6e4;
                case 'second' : return days * 86400 + milliseconds / 1000;
                // Math.floor prevents floating point math errors here
                case 'millisecond': return Math.floor(days * 864e5) + milliseconds;
                default: throw new Error('Unknown unit ' + units);
            }
        }
    }

    // TODO: Use this.as('ms')?
    function valueOf$1 () {
        if (!this.isValid()) {
            return NaN;
        }
        return (
            this._milliseconds +
            this._days * 864e5 +
            (this._months % 12) * 2592e6 +
            toInt(this._months / 12) * 31536e6
        );
    }

    function makeAs (alias) {
        return function () {
            return this.as(alias);
        };
    }

    var asMilliseconds = makeAs('ms');
    var asSeconds      = makeAs('s');
    var asMinutes      = makeAs('m');
    var asHours        = makeAs('h');
    var asDays         = makeAs('d');
    var asWeeks        = makeAs('w');
    var asMonths       = makeAs('M');
    var asQuarters     = makeAs('Q');
    var asYears        = makeAs('y');

    function clone$1 () {
        return createDuration(this);
    }

    function get$2 (units) {
        units = normalizeUnits(units);
        return this.isValid() ? this[units + 's']() : NaN;
    }

    function makeGetter(name) {
        return function () {
            return this.isValid() ? this._data[name] : NaN;
        };
    }

    var milliseconds = makeGetter('milliseconds');
    var seconds      = makeGetter('seconds');
    var minutes      = makeGetter('minutes');
    var hours        = makeGetter('hours');
    var days         = makeGetter('days');
    var months       = makeGetter('months');
    var years        = makeGetter('years');

    function weeks () {
        return absFloor(this.days() / 7);
    }

    var round = Math.round;
    var thresholds = {
        ss: 44,         // a few seconds to seconds
        s : 45,         // seconds to minute
        m : 45,         // minutes to hour
        h : 22,         // hours to day
        d : 26,         // days to month
        M : 11          // months to year
    };

    // helper function for moment.fn.from, moment.fn.fromNow, and moment.duration.fn.humanize
    function substituteTimeAgo(string, number, withoutSuffix, isFuture, locale) {
        return locale.relativeTime(number || 1, !!withoutSuffix, string, isFuture);
    }

    function relativeTime$1 (posNegDuration, withoutSuffix, locale) {
        var duration = createDuration(posNegDuration).abs();
        var seconds  = round(duration.as('s'));
        var minutes  = round(duration.as('m'));
        var hours    = round(duration.as('h'));
        var days     = round(duration.as('d'));
        var months   = round(duration.as('M'));
        var years    = round(duration.as('y'));

        var a = seconds <= thresholds.ss && ['s', seconds]  ||
                seconds < thresholds.s   && ['ss', seconds] ||
                minutes <= 1             && ['m']           ||
                minutes < thresholds.m   && ['mm', minutes] ||
                hours   <= 1             && ['h']           ||
                hours   < thresholds.h   && ['hh', hours]   ||
                days    <= 1             && ['d']           ||
                days    < thresholds.d   && ['dd', days]    ||
                months  <= 1             && ['M']           ||
                months  < thresholds.M   && ['MM', months]  ||
                years   <= 1             && ['y']           || ['yy', years];

        a[2] = withoutSuffix;
        a[3] = +posNegDuration > 0;
        a[4] = locale;
        return substituteTimeAgo.apply(null, a);
    }

    // This function allows you to set the rounding function for relative time strings
    function getSetRelativeTimeRounding (roundingFunction) {
        if (roundingFunction === undefined) {
            return round;
        }
        if (typeof(roundingFunction) === 'function') {
            round = roundingFunction;
            return true;
        }
        return false;
    }

    // This function allows you to set a threshold for relative time strings
    function getSetRelativeTimeThreshold (threshold, limit) {
        if (thresholds[threshold] === undefined) {
            return false;
        }
        if (limit === undefined) {
            return thresholds[threshold];
        }
        thresholds[threshold] = limit;
        if (threshold === 's') {
            thresholds.ss = limit - 1;
        }
        return true;
    }

    function humanize (withSuffix) {
        if (!this.isValid()) {
            return this.localeData().invalidDate();
        }

        var locale = this.localeData();
        var output = relativeTime$1(this, !withSuffix, locale);

        if (withSuffix) {
            output = locale.pastFuture(+this, output);
        }

        return locale.postformat(output);
    }

    var abs$1 = Math.abs;

    function sign(x) {
        return ((x > 0) - (x < 0)) || +x;
    }

    function toISOString$1() {
        // for ISO strings we do not use the normal bubbling rules:
        //  * milliseconds bubble up until they become hours
        //  * days do not bubble at all
        //  * months bubble up until they become years
        // This is because there is no context-free conversion between hours and days
        // (think of clock changes)
        // and also not between days and months (28-31 days per month)
        if (!this.isValid()) {
            return this.localeData().invalidDate();
        }

        var seconds = abs$1(this._milliseconds) / 1000;
        var days         = abs$1(this._days);
        var months       = abs$1(this._months);
        var minutes, hours, years;

        // 3600 seconds -> 60 minutes -> 1 hour
        minutes           = absFloor(seconds / 60);
        hours             = absFloor(minutes / 60);
        seconds %= 60;
        minutes %= 60;

        // 12 months -> 1 year
        years  = absFloor(months / 12);
        months %= 12;


        // inspired by https://github.com/dordille/moment-isoduration/blob/master/moment.isoduration.js
        var Y = years;
        var M = months;
        var D = days;
        var h = hours;
        var m = minutes;
        var s = seconds ? seconds.toFixed(3).replace(/\.?0+$/, '') : '';
        var total = this.asSeconds();

        if (!total) {
            // this is the same as C#'s (Noda) and python (isodate)...
            // but not other JS (goog.date)
            return 'P0D';
        }

        var totalSign = total < 0 ? '-' : '';
        var ymSign = sign(this._months) !== sign(total) ? '-' : '';
        var daysSign = sign(this._days) !== sign(total) ? '-' : '';
        var hmsSign = sign(this._milliseconds) !== sign(total) ? '-' : '';

        return totalSign + 'P' +
            (Y ? ymSign + Y + 'Y' : '') +
            (M ? ymSign + M + 'M' : '') +
            (D ? daysSign + D + 'D' : '') +
            ((h || m || s) ? 'T' : '') +
            (h ? hmsSign + h + 'H' : '') +
            (m ? hmsSign + m + 'M' : '') +
            (s ? hmsSign + s + 'S' : '');
    }

    var proto$2 = Duration.prototype;

    proto$2.isValid        = isValid$1;
    proto$2.abs            = abs;
    proto$2.add            = add$1;
    proto$2.subtract       = subtract$1;
    proto$2.as             = as;
    proto$2.asMilliseconds = asMilliseconds;
    proto$2.asSeconds      = asSeconds;
    proto$2.asMinutes      = asMinutes;
    proto$2.asHours        = asHours;
    proto$2.asDays         = asDays;
    proto$2.asWeeks        = asWeeks;
    proto$2.asMonths       = asMonths;
    proto$2.asQuarters     = asQuarters;
    proto$2.asYears        = asYears;
    proto$2.valueOf        = valueOf$1;
    proto$2._bubble        = bubble;
    proto$2.clone          = clone$1;
    proto$2.get            = get$2;
    proto$2.milliseconds   = milliseconds;
    proto$2.seconds        = seconds;
    proto$2.minutes        = minutes;
    proto$2.hours          = hours;
    proto$2.days           = days;
    proto$2.weeks          = weeks;
    proto$2.months         = months;
    proto$2.years          = years;
    proto$2.humanize       = humanize;
    proto$2.toISOString    = toISOString$1;
    proto$2.toString       = toISOString$1;
    proto$2.toJSON         = toISOString$1;
    proto$2.locale         = locale;
    proto$2.localeData     = localeData;

    proto$2.toIsoString = deprecate('toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)', toISOString$1);
    proto$2.lang = lang;

    // Side effect imports

    // FORMATTING

    addFormatToken('X', 0, 0, 'unix');
    addFormatToken('x', 0, 0, 'valueOf');

    // PARSING

    addRegexToken('x', matchSigned);
    addRegexToken('X', matchTimestamp);
    addParseToken('X', function (input, array, config) {
        config._d = new Date(parseFloat(input, 10) * 1000);
    });
    addParseToken('x', function (input, array, config) {
        config._d = new Date(toInt(input));
    });

    // Side effect imports


    hooks.version = '2.24.0';

    setHookCallback(createLocal);

    hooks.fn                    = proto;
    hooks.min                   = min;
    hooks.max                   = max;
    hooks.now                   = now;
    hooks.utc                   = createUTC;
    hooks.unix                  = createUnix;
    hooks.months                = listMonths;
    hooks.isDate                = isDate;
    hooks.locale                = getSetGlobalLocale;
    hooks.invalid               = createInvalid;
    hooks.duration              = createDuration;
    hooks.isMoment              = isMoment;
    hooks.weekdays              = listWeekdays;
    hooks.parseZone             = createInZone;
    hooks.localeData            = getLocale;
    hooks.isDuration            = isDuration;
    hooks.monthsShort           = listMonthsShort;
    hooks.weekdaysMin           = listWeekdaysMin;
    hooks.defineLocale          = defineLocale;
    hooks.updateLocale          = updateLocale;
    hooks.locales               = listLocales;
    hooks.weekdaysShort         = listWeekdaysShort;
    hooks.normalizeUnits        = normalizeUnits;
    hooks.relativeTimeRounding  = getSetRelativeTimeRounding;
    hooks.relativeTimeThreshold = getSetRelativeTimeThreshold;
    hooks.calendarFormat        = getCalendarFormat;
    hooks.prototype             = proto;

    // currently HTML5 input type only supports 24-hour formats
    hooks.HTML5_FMT = {
        DATETIME_LOCAL: 'YYYY-MM-DDTHH:mm',             // <input type="datetime-local" />
        DATETIME_LOCAL_SECONDS: 'YYYY-MM-DDTHH:mm:ss',  // <input type="datetime-local" step="1" />
        DATETIME_LOCAL_MS: 'YYYY-MM-DDTHH:mm:ss.SSS',   // <input type="datetime-local" step="0.001" />
        DATE: 'YYYY-MM-DD',                             // <input type="date" />
        TIME: 'HH:mm',                                  // <input type="time" />
        TIME_SECONDS: 'HH:mm:ss',                       // <input type="time" step="1" />
        TIME_MS: 'HH:mm:ss.SSS',                        // <input type="time" step="0.001" />
        WEEK: 'GGGG-[W]WW',                             // <input type="week" />
        MONTH: 'YYYY-MM'                                // <input type="month" />
    };

    return hooks;

})));
;
function fixTable(container, dataPercentageFilter) {
    // Store references to table elements
    var thead = container.querySelector('thead');
    var tbody = container.querySelector('tbody');

    // Style container
    container.style.overflow = 'auto';
    container.style.position = 'relative';

    container.style.maxHeight = 'calc(100vh)';

    // Add inline styles to fix the header row and leftmost column
    function relayout() {
        var ths = [].slice.call(thead.querySelectorAll('th'));
        var tbodyTrs = [].slice.call(tbody.querySelectorAll('tr'));

        /**
         * Remove inline styles so we resort to the default table layout algorithm
         * For thead, th, and td elements, don't remove the 'transform' styles applied
         * by the scroll event listener
         */
        tbody.setAttribute('style', '');
        thead.style.width = '';
        thead.style.position = '';
        thead.style.top = '';
        thead.style.left = '';
        thead.style.zIndex = '';
        ths.forEach(function (th) {
            th.style.display = '';
            th.style.width = '';
            th.style.position = '';
            th.style.top = '';
            th.style.left = '';
        });
        tbodyTrs.forEach(function (tr) {
            tr.setAttribute('style', '');
        });
        [].slice.call(tbody.querySelectorAll('td'))
          .forEach(function (td) {
              td.style.width = '';
              td.style.position = '';
              td.style.left = '';
          });

        /**
         * Store width and height of each th
         * getBoundingClientRect()'s dimensions include paddings and borders
         */
        var thStyles = ths.map(function (th) {
            
            var rect = th.getBoundingClientRect();
            var style = document.defaultView.getComputedStyle(th, '');

            var obj = {
                boundingWidth: rect.width,
                boundingHeight: rect.height,
                width: parseInt(rect.width, 10),
                paddingLeft: parseInt(style.paddingLeft, 10),
                styleWidth: parseInt(style.width, 10)
            };

            return obj;
        });

        tbody.style.display = 'block';
        tbody.style.width = '100%';

        // Position thead
        thead.style.position = 'absolute';
        thead.style.top = '0';
        thead.style.left = (thStyles[0].boundingWidth - 1) + 'px';
        thead.style.zIndex = 10;

        // Set widths of the th elements in thead. For the fixed th, set its position
        ths.forEach(function (th, i) {

            if (th.classList.contains('modifyPeriodWidth')) {
                th.style.width = (thStyles[i].width + 7) + 'px';
                th.style.minWidth = (thStyles[i].width + 7) + 'px';
                th.style.maxWidth = (thStyles[i].width + 7) + 'px';
            }
            else {
                th.style.width = (thStyles[i].width) + 'px';
                th.style.minWidth = (thStyles[i].width) + 'px';
                th.style.maxWidth = (thStyles[i].width) + 'px';
            }
            
            th.style.height = (thStyles[0].boundingHeight) + 'px';
            th.style.verticalAlign = 'middle';
            th.style.textAlign = 'center';

            if (th.parentElement.firstElementChild == th) { //(i == 0)
                th.style.position = 'absolute';
                th.style.top = i == 0 ? '0' : (thStyles[0].boundingHeight) + 'px';;
                th.style.left = -(thStyles[0].boundingWidth - 1) + 'px';
                th.style.zIndex = 10;
            }
        });

        // Set margin-top for tbody - the fixed header is displayed in this margin
        tbody.style.marginTop = (thStyles[0].boundingHeight - 1) + 'px';

        // Set widths of the td elements in tbody. For the fixed td, set its position
        tbodyTrs.forEach(function (tr, i) {
            var ht = thStyles[0].boundingHeight;

            tr.style.zIndex = 1;
            tr.style.display = 'block';
            tr.style.paddingLeft = (thStyles[0].boundingWidth - 2) + 'px';
            
            [].slice.call(tr.querySelectorAll('td'))
              .forEach(function (td, j) {
                  if (j == 0) {
                      var sp = [].slice.call(td.querySelectorAll('span.desc-field'))[0];
                      if (sp != undefined) {
                          var styleSp = sp.getBoundingClientRect();
                          if (styleSp != undefined && styleSp.height > 14) {
                              ht = styleSp.height + 10;
                          }
                      }
                  }

                  if (!td.id.match('^hdn') && !td.id.match('^STCComp')) {
                      if (td.classList.contains("not-found")) {
                          td.style.position = 'relative';
                          td.style.display = 'block';
                          td.style.textAlign = 'center';
                          td.style.width = '100%';
                      }
                      else {
                          if (td.classList.contains('modifyPeriodWidth')) {
                              td.style.width = (thStyles[j].width + 7) + 'px';
                              td.style.minWidth = (thStyles[j].width + 7) + 'px';
                              td.style.maxWidth = (thStyles[j].width + 7) + 'px';
                          }
                          else {
                              td.style.width = (thStyles[j].width) + 'px';
                              td.style.minWidth = (thStyles[j].width) + 'px';
                              td.style.maxWidth = (thStyles[j].width) + 'px';
                          }
                          if (j === 0) {
                              td.style.zIndex = 1;
                              td.style.position = 'absolute';
                              td.style.left = '0';

                          }
                      }
                      td.style.height = ht - 3 + 'px';
                  }
              });

            tr.style.height = ht - 3 + 'px';
        });
    }

    // Initialize table styles
    relayout();

    // Fix thead and first column on scroll
    container.addEventListener('scroll', function () {
        
        thead.style.transform = 'translate3d(0,' + this.scrollTop + 'px,0)';

        var hTransform = 'translate3d(' + this.scrollLeft + 'px,0,0)';

        thead.querySelectorAll('tr > th:first-child').forEach(function (th, i) {
            th.style.transform = hTransform;
        });

        [].slice.call(tbody.querySelectorAll('tr > td:first-child'))
          .forEach(function (td, i) {
              td.style.transform = hTransform;
          });
    });

    /**
     * Return an object that exposes the relayout function so that we can
     * update the table when the number of columns or the content inside columns changes
     */
    return {
        relayout: relayout
    };
}
;
